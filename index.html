<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>متابعة السكر — تسجيل / دخول</title>
<meta name="color-scheme" content="light">
<style>
  :root{
    --bg1:#0ea5e9; --bg2:#6ee7b7; --card:#fff; --ink:#0f172a; --muted:#64748b;
    --line:#e5e7eb; --brand:#0ea5e9; --danger:#ef4444; --ok:#22c55e;
  }
  *{box-sizing:border-box}
  body{
    margin:0; min-height:100vh; display:grid; place-items:center;
    font:15px/1.6 system-ui,"Tajawal","Noto Sans Arabic",sans-serif;
    color:var(--ink); background:linear-gradient(135deg,var(--bg1),var(--bg2)) fixed;
  }
  .wrap{width:min(980px,94vw)}
  header{color:#f0fbff;text-align:center;margin-bottom:14px}
  header h1{margin:0 0 6px;font-size:22px}
  .card{
    background:var(--card); border:1px solid #e6eef6; border-radius:18px;
    box-shadow:0 20px 60px rgba(0,0,0,.08); padding:18px;
  }
  .tabs{display:flex; gap:8px; justify-content:center; margin-bottom:8px}
  .tab-btn{
    border:none; background:#eef6ff; color:#0369a1; padding:10px 14px;
    border-radius:999px; cursor:pointer; font-weight:700
  }
  .tab-btn.active{background:#0369a1;color:#fff}
  .grid{display:grid; gap:12px; grid-template-columns:repeat(2,minmax(0,1fr))}
  @media (max-width:720px){ .grid{grid-template-columns:1fr} }
  label{display:block; font-size:13px; color:var(--muted); margin:0 0 6px}
  input{
    width:100%; padding:12px; border:1px solid var(--line); border-radius:12px; background:#fff
  }
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .btn{
    border:none; border-radius:12px; padding:12px 16px; cursor:pointer; font-weight:800
  }
  .btn.primary{background:var(--brand); color:#fff}
  .btn.gray{background:#eef2f7}
  .note{color:var(--muted); font-size:13px}
  .alert{display:none; padding:10px; border-radius:10px; margin:8px 0}
  .alert.err{background:#fff1f2; color:#991b1b}
  .alert.ok{background:#ecfdf5; color:#065f46}
  footer{color:#eaf9ff; text-align:center; margin-top:12px}
  .sep{height:1px;background:var(--line);margin:12px 0}
  .small{font-size:12px;color:var(--muted)}
  .hide{display:none !important}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>منصة متابعة سكر الأطفال</h1>
    <div class="small">سجّل دخولك أو أنشئ حساب وليّ أمر للبدء</div>
  </header>

  <div class="card">
    <!-- حالة الاتصال وحالة المستخدم -->
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
      <div class="row" id="userInfo" style="gap:6px"></div>
      <button id="btnLogout" class="btn gray hide">خروج</button>
    </div>
    <div class="sep"></div>

    <!-- أزرار التبويب -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="login">تسجيل الدخول</button>
      <button class="tab-btn" data-tab="register">إنشاء حساب جديد</button>
    </div>

    <!-- رسائل عامة -->
    <div id="msgErr" class="alert err"></div>
    <div id="msgOk"  class="alert ok"></div>

    <!-- تبويب الدخول -->
    <form id="formLogin" class="tab" data-name="login">
      <div class="grid">
        <div>
          <label>البريد الإلكتروني</label>
          <input id="login_email" type="email" placeholder="you@example.com" required>
        </div>
        <div>
          <label>كلمة السر</label>
          <input id="login_pass" type="password" placeholder="••••••••" required>
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn primary" type="submit">دخول</button>
        <span class="note">إن لم يكن لديك حساب يمكنك إنشاء حساب من التبويب الآخر.</span>
      </div>
    </form>

    <!-- تبويب التسجيل -->
    <form id="formRegister" class="tab hide" data-name="register">
      <div class="grid">
        <div><label>اسم وليّ الأمر</label><input id="reg_guardian" placeholder="مثال: أحمد محمد" required></div>
        <div><label>الاسم (اختياري)</label><input id="reg_fullname" placeholder="الاسم الكامل (اختياري)"></div>
        <div><label>الرقم المدني</label><input id="reg_civil" placeholder="123456789012" required></div>
        <div><label>رقم الهاتف</label><input id="reg_phone" placeholder="5xxxxxxxx" required></div>
        <div><label>البريد الإلكتروني</label><input id="reg_email" type="email" placeholder="you@example.com" required></div>
        <div><label>كلمة السر</label><input id="reg_pass" type="password" placeholder="••••••••" required></div>
        <div><label>تأكيد كلمة السر</label><input id="reg_confirm" type="password" placeholder="أعد الإدخال" required></div>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn primary" type="submit">إنشاء الحساب</button>
        <span class="note">سيتم إنشاء ملفك في قاعدة البيانات وربط الحساب.</span>
      </div>
    </form>
  </div>

  <footer>© متابعة السكر للأطفال — كل الحقوق محفوظة</footer>
</div>

<script type="module">
/* =========================== Firebase =========================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut,
         signInWithEmailAndPassword, createUserWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCOdrwdbw8b7YdWLPZ4TDdG2iS9kvvxQ7M",
  authDomain: "child-glucose-tracker.firebaseapp.com",
  projectId: "child-glucose-tracker",
  storageBucket: "child-glucose-tracker.firebasestorage.app",
  messagingSenderId: "294563325904",
  appId: "1:294563325904:web:39562550bf305fc01abbd5",
  measurementId: "G-TWC063TD6X"
};
const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* =========================== UI helpers =========================== */
const $ = s=>document.querySelector(s);
const show=(el,msg)=>{ el.textContent=msg; el.style.display='block'; };
const hide=(...els)=>els.forEach(e=>e.style.display='none');
function switchTab(name){
  document.querySelectorAll('.tab-btn').forEach(b=>{
    b.classList.toggle('active', b.dataset.tab===name);
  });
  document.querySelectorAll('.tab').forEach(t=>{
    t.classList.toggle('hide', t.dataset.name!==name);
  });
}
document.querySelectorAll('.tab-btn').forEach(b=>b.addEventListener('click',()=>switchTab(b.dataset.tab)));

/* =========================== Auth state =========================== */
const msgErr = $('#msgErr'), msgOk = $('#msgOk');
const userInfo = $('#userInfo'); const btnLogout = $('#btnLogout');

onAuthStateChanged(auth, async (u)=>{
  if(u){
    // عرض ملخص سريع + زر خروج
    userInfo.innerHTML = `<span class="note">مسجّل دخول: <b>${u.displayName || '—'}</b> • ${u.email}</span>`;
    btnLogout.classList.remove('hide');

    // تأكيد وجود مستند المستخدم (لو دخل بحساب قديم)
    const ref = doc(db,'users',u.uid);
    const snap = await getDoc(ref);
    if(!snap.exists()){
      await setDoc(ref, { parentInfo:{ guardianName: u.displayName || '', name: u.displayName || '', civilId:'', email:u.email, phone:'' }, createdAt: serverTimestamp() }, { merge:true });
    }

    // تحويل تلقائي للداشبورد بعد ثانية (تقدري تقلليها/تلغيها)
    setTimeout(()=>{ window.location.href = 'dashboard.html'; }, 800);
  }else{
    userInfo.innerHTML = `<span class="note">غير مسجّل دخول حاليًا — اختَر "تسجيل الدخول" أو "إنشاء حساب".</span>`;
    btnLogout.classList.add('hide');
  }
});

btnLogout.addEventListener('click', ()=>signOut(auth));

/* =========================== Login submit =========================== */
$('#formLogin').addEventListener('submit', async (e)=>{
  e.preventDefault(); hide(msgErr,msgOk);
  const email = $('#login_email').value.trim();
  const pass  = $('#login_pass').value;
  if(!email || !pass) return show(msgErr,'من فضلك أدخل البريد وكلمة السر');
  try{
    await signInWithEmailAndPassword(auth,email,pass);
    show(msgOk,'تم تسجيل الدخول — جارٍ التحويل...');
  }catch(err){
    const map={'auth/invalid-credential':'البريد أو كلمة السر غير صحيحة','auth/user-not-found':'لا يوجد حساب بهذا البريد','auth/wrong-password':'كلمة السر غير صحيحة'};
    show(msgErr, map[err.code] || ('حدث خطأ: '+err.message));
  }
});

/* =========================== Register submit =========================== */
$('#formRegister').addEventListener('submit', async (e)=>{
  e.preventDefault(); hide(msgErr,msgOk);
  const guardian = $('#reg_guardian').value.trim();
  const name     = $('#reg_fullname').value.trim();
  const civilId  = $('#reg_civil').value.trim();
  const phone    = $('#reg_phone').value.trim();
  const email    = $('#reg_email').value.trim();
  const pass     = $('#reg_pass').value;
  const confirm  = $('#reg_confirm').value;

  if(!guardian || !civilId || !phone || !email || !pass) return show(msgErr,'من فضلك املئي كل الحقول المطلوبة');
  if(pass.length < 6) return show(msgErr,'كلمة السر يجب أن تكون 6 أحرف على الأقل');
  if(pass !== confirm) return show(msgErr,'تأكيد كلمة السر غير مطابق');

  try{
    const cred = await createUserWithEmailAndPassword(auth,email,pass);
    await updateProfile(cred.user, { displayName: guardian });
    await setDoc(doc(db,'users',cred.user.uid),{
      createdAt: serverTimestamp(),
      parentInfo:{
        guardianName: guardian,
        name: name || guardian,
        civilId, email, phone
      }
    }, { merge:true });
    show(msgOk,'تم إنشاء الحساب بنجاح — جارٍ التحويل…');
  }catch(err){
    const map={'auth/email-already-in-use':'هذا البريد مستخدم بالفعل','auth/invalid-email':'بريد إلكتروني غير صالح','auth/weak-password':'كلمة السر ضعيفة'};
    show(msgErr, map[err.code] || ('حدث خطأ: '+err.message));
  }
});
</script>
</body>
</html>
