<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>الزيارات الطبية</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="topbar">
  <div>📅 الزيارات الطبية</div>
  <div class="row">
    <a id="lnkDash" class="btn gray">لوحة الطفل</a>
  </div>
</div>

<main class="container">
  <section class="card">
    <div class="row" style="gap:12px;align-items:center">
      <img id="avatar" class="avatar" style="width:64px;height:64px" src="images/avatar-default.png" alt="">
      <div>
        <div id="kidName" style="font-weight:800">—</div>
        <div id="kidMeta" class="note">—</div>
      </div>
      <button id="btnNew" class="btn">➕ زيارة جديدة</button>
    </div>
  </section>

  <section class="card" id="formBox" style="display:none">
    <h3 style="margin:0 0 8px">إضافة / تعديل زيارة</h3>
    <div class="grid g3">
      <div><label>التاريخ</label><input id="vDate" type="date"></div>
      <div><label>الطبيب</label><input id="vDoctor"></div>
      <div><label>العيادة</label><input id="vClinic"></div>
      <div style="grid-column:1/-1"><label>السبب</label><input id="vReason"></div>
      <div style="grid-column:1/-1"><label>ملاحظات</label><textarea id="vNotes" rows="2"></textarea></div>
      <div style="grid-column:1/-1"><label>روابط مرفقات (اختياري — سطر لكل رابط)</label><textarea id="vFiles" rows="2" placeholder="https://…\nhttps://…"></textarea></div>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button id="btnSave" class="btn primary">💾 حفظ</button>
      <button id="btnCancel" class="btn gray">إلغاء</button>
    </div>
  </section>

  <section class="card">
    <table class="table">
      <thead><tr><th>التاريخ</th><th>الطبيب</th><th>العيادة</th><th>السبب</th><th>مرفقات</th><th>إجراءات</th></tr></thead>
      <tbody id="rows"><tr><td colspan="6" class="note">—</td></tr></tbody>
    </table>
  </section>
</main>

<script type="module">
import { auth, db, ensureAuth, requireChildIdFromQuery, loadChildProfile, setChildAvatar, todayISO } from './firebase-init.js';
import { collection, addDoc, query, orderBy, getDocs, doc, getDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const $=s=>document.querySelector(s);
let uid=null, childId=null, child=null, editId=null;

(async function boot(){
  ({uid}=await ensureAuth());
  childId=requireChildIdFromQuery();
  $('#lnkDash').href=`child-dashboard.html?child=${encodeURIComponent(childId)}`;

  child=await loadChildProfile(uid, childId);
  setChildAvatar($('#avatar'), child.name, child.photoURL);
  $('#kidName').textContent=child.name||'—';
  $('#kidMeta').textContent=`${child.gender||'—'} • ${child.weight??'—'} كجم • ${child.height??'—'} سم`;

  $('#btnNew').addEventListener('click', ()=>{ editId=null; showForm(true); $('#vDate').value=todayISO(); });
  $('#btnCancel').addEventListener('click', ()=>showForm(false));
  $('#btnSave').addEventListener('click', saveVisit);

  await loadVisits();
})();

function showForm(on){ $('#formBox').style.display = on? 'block':'none'; }
function linksFromTextarea(v){ return String(v||'').split('\n').map(s=>s.trim()).filter(Boolean).map(url=>({url,name:url})); }

async function loadVisits(){
  const tbody=$('#rows'); tbody.innerHTML='';
  const qs = await getDocs(query(collection(db,'users',uid,'children',childId,'visits'), orderBy('date','desc')));
  if(qs.empty){ tbody.innerHTML='<tr><td colspan="6" class="note">لا توجد زيارات.</td></tr>'; return; }
  const html=[];
  qs.forEach(s=>{
    const v=s.data();
    const files=Array.isArray(v.files)? v.files : [];
    html.push(`<tr>
      <td><b>${escapeHTML(v.date||'—')}</b></td>
      <td>${escapeHTML(v.doctor||'—')}</td>
      <td>${escapeHTML(v.clinic||'—')}</td>
      <td>${escapeHTML(v.reason||'—')}</td>
      <td>${files.length? files.map(f=>`<a href="${f.url}" target="_blank">رابط</a>`).join(' • ') : '—'}</td>
      <td>
        <button class="btn gray" onclick="viewVisit('${s.id}')">👁️</button>
        <button class="btn gray" onclick="editVisit('${s.id}')">✏️</button>
        <button class="btn gray" onclick="delVisit('${s.id}')">🗑️</button>
      </td>
    </tr>`);
  });
  tbody.innerHTML=html.join('');
}

window.viewVisit = async function(id){
  const ref=doc(db,'users',uid,'children',childId,'visits',id);
  const s=await getDoc(ref); if(!s.exists()) return alert('غير موجود');
  const v=s.data();
  const files=Array.isArray(v.files)?v.files:[];
  const meta = `
    التاريخ: ${escapeHTML(v.date||'—')}\nالطبيب: ${escapeHTML(v.doctor||'—')}\nالعيادة: ${escapeHTML(v.clinic||'—')}
    \nالسبب: ${escapeHTML(v.reason||'—')}\nملاحظات: ${escapeHTML(v.notes||'—')}
    \nمرفقات: ${files.length? files.map(f=>f.url).join('\n'):'—'}
  `;
  alert(meta);
}

window.editVisit = async function(id){
  const ref=doc(db,'users',uid,'children',childId,'visits',id);
  const s=await getDoc(ref); if(!s.exists()) return alert('غير موجود');
  const v=s.data(); editId=id; showForm(true);
  $('#vDate').value=v.date||''; $('#vDoctor').value=v.doctor||''; $('#vClinic').value=v.clinic||'';
  $('#vReason').value=v.reason||''; $('#vNotes').value=v.notes||'';
  $('#vFiles').value=(Array.isArray(v.files)? v.files.map(f=>f.url).join('\n') : '');
}

window.delVisit = async function(id){
  if(!confirm('حذف الزيارة؟')) return;
  await deleteDoc(doc(db,'users',uid,'children',childId,'visits',id));
  await loadVisits();
}

async function saveVisit(){
  const date=$('#vDate').value; if(!date) return alert('أدخلي التاريخ');
  const payload={
    date,
    doctor: $('#vDoctor').value||null,
    clinic: $('#vClinic').value||null,
    reason: $('#vReason').value||null,
    notes: $('#vNotes').value||null,
    files: linksFromTextarea($('#vFiles').value),
    updatedAt: serverTimestamp()
  };
  if(editId){
    await updateDoc(doc(db,'users',uid,'children',childId,'visits',editId), payload);
  }else{
    payload.createdAt=serverTimestamp();
    await addDoc(collection(db,'users',uid,'children',childId,'visits'), payload);
  }
  showForm(false); editId=null; await loadVisits();
}

function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
</script>
</body>
</html>
