<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .table{width:100%;border-collapse:separate;border-spacing:0}
    .table th,.table td{border:1px solid #e5e7eb;padding:8px;text-align:right;vertical-align:top}
    .table thead th{background:#f0f9ff}
    .chip{display:inline-flex;align-items:center;gap:6px;background:#eef6ff;color:#0369a1;border-radius:999px;padding:4px 8px;font-weight:800;font-size:12px}
    .print-visit{display:none;background:#fff;color:#000;padding:12px;border:1px dashed #e5e7eb;margin-top:10px}
    @media print{
      header,.no-print,.topbar,.btn{display:none!important}
      .print-visit{display:block!important}
    }
  </style>
</head>
<body>
  <!-- Ø¨Ù†Ø± Ø§Ù„Ø·ÙÙ„ -->
  <div id="childBanner" style="text-align:center; padding:12px 8px; display:none">
    <img id="bannerAvatar" class="avatar" style="width:84px;height:84px" src="images/avatar-default.png" alt="ØµÙˆØ±Ø© Ø§Ù„Ø·ÙÙ„">
    <div style="margin-top:6px;font-weight:800" id="bannerName">â€”</div>
    <div class="note" id="bannerMeta">â€”</div>
  </div>

  <div class="topbar">
    <div>ğŸ“… Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©</div>
    <div class="row">
      <a id="lnkHome" class="btn gray">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <button id="btnNew" class="btn">â• Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
      <button id="btnLogout" class="btn">Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <main class="container">
    <div class="card"><div class="row" id="childNav"></div></div>

    <!-- Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ -->
    <section id="visitFormBox" class="card" style="display:none">
      <h3 style="margin:0 0 6px">Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø²ÙŠØ§Ø±Ø©</h3>
      <div class="grid g3">
        <div><label>ØªØ§Ø±ÙŠØ®</label><input id="vDate" type="date"></div>
        <div><label>Ø§Ù„Ø·Ø¨ÙŠØ¨</label><input id="vDoctor" placeholder="Ù…Ø«Ø§Ù„: Ø¯. Ø£Ø­Ù…Ø¯"></div>
        <div><label>Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</label><input id="vClinic" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø£Ø·ÙØ§Ù„"></div>
        <div style="grid-column:1/-1"><label>Ø§Ù„Ø³Ø¨Ø¨ / Ø§Ù„Ø´ÙƒÙˆÙ‰</label><input id="vReason" placeholder="Ù…ØªØ§Ø¨Ø¹Ø©/Ø¶Ø¨Ø· Ø¬Ø±Ø¹Ø§Øªâ€¦"></div>
        <div style="grid-column:1/-1"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="vNotes" rows="2"></textarea></div>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:8px">
        <button id="btnVisitSave" class="btn primary">ğŸ’¾ Ø­ÙØ¸</button>
        <button id="btnVisitCancel" class="btn gray">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </section>

    <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© -->
    <section class="card">
      <h3 style="margin:0 0 6px">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</h3>
      <table class="table">
        <thead>
          <tr>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„Ø·Ø¨ÙŠØ¨</th>
            <th>Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</th>
            <th>Ø§Ù„Ø³Ø¨Ø¨</th>
            <th class="no-print">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="visitsRows">
          <tr><td colspan="5" class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ø¨Ø¹Ø¯.</td></tr>
        </tbody>
      </table>
    </section>

    <div id="visitPrintArea" class="print-visit">
      <h4>ğŸ§‘â€âš•ï¸ Ù…Ù„Ø®Øµ Ø²ÙŠØ§Ø±Ø© Ø·Ø¨ÙŠØ©</h4>
      <div id="printBody"></div>
    </div>
  </main>

  <div id="toast" class="toast"></div>

  <script type="module">
    import { auth, db, ensureAuth, requireChildIdFromQuery, setChildAvatar } from './firebase-init.js';
    import { signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { collection, addDoc, getDocs, doc, getDoc, updateDoc, deleteDoc, orderBy, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const $=s=>document.querySelector(s);
    const toast=(m)=>{const t=$("#toast");t.textContent=m;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),2000)}

    let uid=null, childId=null, child=null, editId=null;

    (async function(){
      const u=await ensureAuth(); uid=u.uid; childId=requireChildIdFromQuery();

      // nav
      const nav=$("#childNav"); nav.innerHTML='';
      [['child-dashboard.html','Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'],['measures.html','Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ±'],['meals.html','Ø§Ù„ÙˆØ¬Ø¨Ø§Øª'],['reports.html','Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±'],['visits.html','Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©'],['doctor-report.html','ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¯ÙƒØªÙˆØ±']]
      .forEach(([h,t])=>{ const a=document.createElement('a'); a.className='btn gray'; a.href=`${h}?child=${encodeURIComponent(childId)}`; a.textContent=t; nav.appendChild(a);});
      $("#lnkHome").href=`child-dashboard.html?child=${encodeURIComponent(childId)}`;

      await loadChild();
      await loadVisits();

      $("#btnNew").addEventListener('click', ()=>{ editId=null; clearForm(); $("#vDate").value=new Date().toISOString().slice(0,10); $("#visitFormBox").style.display='block'; });
      $("#btnVisitCancel").addEventListener('click', ()=> $("#visitFormBox").style.display='none');
      $("#btnVisitSave").addEventListener('click', saveVisit);
      $("#btnLogout").addEventListener('click', ()=>signOut(auth).then(()=>location.href='index.html'));
    })();

    async function loadChild(){
      const s=await getDoc(doc(db,'users',uid,'children',childId));
      child=s.data()||{};
      setChildAvatar($("#bannerAvatar"), child.name, child.photoURL);
      $("#bannerName").textContent=child.name||'â€”';
      $("#bannerMeta").textContent=[child.gender||'', (child.weight!=null?child.weight+' ÙƒØ¬Ù…':'â€”'), (child.height!=null?child.height+' Ø³Ù…':'â€”')].filter(Boolean).join(' â€¢ ');
      $("#childBanner").style.display='block';
    }

    function clearForm(){ ['vDate','vDoctor','vClinic','vReason','vNotes'].forEach(id=>$("#"+id).value=''); }

    async function loadVisits(){
      const tbody=$("#visitsRows");
      const qy=query(collection(db,'users',uid,'children',childId,'visits'), orderBy('date','desc'));
      const qs=await getDocs(qy);
      if(qs.empty){ tbody.innerHTML='<tr><td colspan="5" class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ø¨Ø¹Ø¯.</td></tr>'; return; }
      const rows=[];
      qs.forEach(s=>{
        const v=s.data();
        rows.push(`
          <tr>
            <td><b>${escapeHTML(v.date||'â€”')}</b></td>
            <td>${escapeHTML(v.doctor||'â€”')}</td>
            <td>${escapeHTML(v.clinic||'â€”')}</td>
            <td>${escapeHTML(v.reason||'â€”')}</td>
            <td class="no-print">
              <button class="btn" data-act="view" data-id="${s.id}">ğŸ‘ï¸</button>
              <button class="btn" data-act="edit" data-id="${s.id}">âœï¸</button>
              <button class="btn" data-act="del"  data-id="${s.id}">ğŸ—‘ï¸</button>
            </td>
          </tr>`);
      });
      tbody.innerHTML=rows.join('');
      tbody.querySelectorAll('button[data-act]').forEach(btn=>{
        const id=btn.dataset.id, act=btn.dataset.act;
        btn.addEventListener('click', ()=> {
          if(act==='view') viewVisit(id);
          else if(act==='edit') editVisit(id);
          else if(act==='del') delVisit(id);
        });
      });
    }

    async function saveVisit(){
      const v={ date:$("#vDate").value, doctor:$("#vDoctor").value.trim()||null, clinic:$("#vClinic").value.trim()||null, reason:$("#vReason").value.trim()||null, notes:$("#vNotes").value.trim()||null, updatedAt:serverTimestamp() };
      if(!v.date) return toast('Ø£Ø¯Ø®Ù„ÙŠ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø©');

      if(editId){
        await updateDoc(doc(db,'users',uid,'children',childId,'visits',editId), v);
      }else{
        v.createdAt=serverTimestamp();
        await addDoc(collection(db,'users',uid,'children',childId,'visits'), v);
      }
      toast('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸'); $("#visitFormBox").style.display='none'; clearForm(); editId=null; await loadVisits();
    }

    async function viewVisit(id){
      const s=await getDoc(doc(db,'users',uid,'children',childId,'visits',id));
      if(!s.exists()){ toast('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'); return; }
      const v=s.data();
      $("#printBody").innerHTML=`
        <div><b>Ø§Ù„Ø·ÙÙ„:</b> ${escapeHTML(child?.name||'â€”')}</div>
        <div><b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> ${escapeHTML(v.date||'â€”')}</div>
        <div><b>Ø§Ù„Ø·Ø¨ÙŠØ¨:</b> ${escapeHTML(v.doctor||'â€”')}</div>
        <div><b>Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©:</b> ${escapeHTML(v.clinic||'â€”')}</div>
        <div><b>Ø§Ù„Ø³Ø¨Ø¨:</b> ${escapeHTML(v.reason||'â€”')}</div>
        <div><b>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</b> ${escapeHTML(v.notes||'â€”')}</div>`;
      window.print();
    }

    async function editVisit(id){
      const s=await getDoc(doc(db,'users',uid,'children',childId,'visits',id));
      if(!s.exists()){ toast('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'); return; }
      const v=s.data(); editId=id;
      $("#vDate").value=v.date||''; $("#vDoctor").value=v.doctor||''; $("#vClinic").value=v.clinic||''; $("#vReason").value=v.reason||''; $("#vNotes").value=v.notes||'';
      $("#visitFormBox").style.display='block';
    }
    async function delVisit(id){
      if(!confirm('Ø­Ø°Ù Ø§Ù„Ø²ÙŠØ§Ø±Ø©ØŸ')) return;
      await deleteDoc(doc(db,'users',uid,'children',childId,'visits',id));
      await loadVisits();
    }
    function escapeHTML(s){return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]))}
  </script>
</body>
</html>
