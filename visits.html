<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="topbar">
  <div>ğŸ“… Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©</div>
  <div class="row">
    <a id="lnkDash" class="btn gray">Ù„ÙˆØ­Ø© Ø§Ù„Ø·ÙÙ„</a>
  </div>
</div>

<main class="container">
  <section class="card">
    <div class="row" style="gap:12px;align-items:center">
      <img id="avatar" class="avatar" style="width:64px;height:64px" src="images/avatar-default.png" alt="">
      <div>
        <div id="kidName" style="font-weight:800">â€”</div>
        <div id="kidMeta" class="note">â€”</div>
      </div>
      <button id="btnNew" class="btn">â• Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
    </div>
  </section>

  <section class="card" id="formBox" style="display:none">
    <h3 style="margin:0 0 8px">Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø²ÙŠØ§Ø±Ø©</h3>
    <div class="grid g3">
      <div><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="vDate" type="date"></div>
      <div><label>Ø§Ù„Ø·Ø¨ÙŠØ¨</label><input id="vDoctor"></div>
      <div><label>Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</label><input id="vClinic"></div>
      <div style="grid-column:1/-1"><label>Ø§Ù„Ø³Ø¨Ø¨</label><input id="vReason"></div>
      <div style="grid-column:1/-1"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="vNotes" rows="2"></textarea></div>
      <div style="grid-column:1/-1"><label>Ø±ÙˆØ§Ø¨Ø· Ù…Ø±ÙÙ‚Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ â€” Ø³Ø·Ø± Ù„ÙƒÙ„ Ø±Ø§Ø¨Ø·)</label><textarea id="vFiles" rows="2" placeholder="https://â€¦\nhttps://â€¦"></textarea></div>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button id="btnSave" class="btn primary">ğŸ’¾ Ø­ÙØ¸</button>
      <button id="btnCancel" class="btn gray">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </section>

  <section class="card">
    <table class="table">
      <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø·Ø¨ÙŠØ¨</th><th>Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</th><th>Ø§Ù„Ø³Ø¨Ø¨</th><th>Ù…Ø±ÙÙ‚Ø§Øª</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
      <tbody id="rows"><tr><td colspan="6" class="note">â€”</td></tr></tbody>
    </table>
  </section>
</main>

<script type="module">
import { auth, db, ensureAuth, requireChildIdFromQuery, loadChildProfile, setChildAvatar, todayISO } from './firebase-init.js';
import { collection, addDoc, query, orderBy, getDocs, doc, getDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const $=s=>document.querySelector(s);
let uid=null, childId=null, child=null, editId=null;

(async function boot(){
  ({uid}=await ensureAuth());
  childId=requireChildIdFromQuery();
  $('#lnkDash').href=`child-dashboard.html?child=${encodeURIComponent(childId)}`;

  child=await loadChildProfile(uid, childId);
  setChildAvatar($('#avatar'), child.name, child.photoURL);
  $('#kidName').textContent=child.name||'â€”';
  $('#kidMeta').textContent=`${child.gender||'â€”'} â€¢ ${child.weight??'â€”'} ÙƒØ¬Ù… â€¢ ${child.height??'â€”'} Ø³Ù…`;

  $('#btnNew').addEventListener('click', ()=>{ editId=null; showForm(true); $('#vDate').value=todayISO(); });
  $('#btnCancel').addEventListener('click', ()=>showForm(false));
  $('#btnSave').addEventListener('click', saveVisit);

  await loadVisits();
})();

function showForm(on){ $('#formBox').style.display = on? 'block':'none'; }
function linksFromTextarea(v){ return String(v||'').split('\n').map(s=>s.trim()).filter(Boolean).map(url=>({url,name:url})); }

async function loadVisits(){
  const tbody=$('#rows'); tbody.innerHTML='';
  const qs = await getDocs(query(collection(db,'users',uid,'children',childId,'visits'), orderBy('date','desc')));
  if(qs.empty){ tbody.innerHTML='<tr><td colspan="6" class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª.</td></tr>'; return; }
  const html=[];
  qs.forEach(s=>{
    const v=s.data();
    const files=Array.isArray(v.files)? v.files : [];
    html.push(`<tr>
      <td><b>${escapeHTML(v.date||'â€”')}</b></td>
      <td>${escapeHTML(v.doctor||'â€”')}</td>
      <td>${escapeHTML(v.clinic||'â€”')}</td>
      <td>${escapeHTML(v.reason||'â€”')}</td>
      <td>${files.length? files.map(f=>`<a href="${f.url}" target="_blank">Ø±Ø§Ø¨Ø·</a>`).join(' â€¢ ') : 'â€”'}</td>
      <td>
        <button class="btn gray" onclick="viewVisit('${s.id}')">ğŸ‘ï¸</button>
        <button class="btn gray" onclick="editVisit('${s.id}')">âœï¸</button>
        <button class="btn gray" onclick="delVisit('${s.id}')">ğŸ—‘ï¸</button>
      </td>
    </tr>`);
  });
  tbody.innerHTML=html.join('');
}

window.viewVisit = async function(id){
  const ref=doc(db,'users',uid,'children',childId,'visits',id);
  const s=await getDoc(ref); if(!s.exists()) return alert('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
  const v=s.data();
  const files=Array.isArray(v.files)?v.files:[];
  const meta = `
    Ø§Ù„ØªØ§Ø±ÙŠØ®: ${escapeHTML(v.date||'â€”')}\nØ§Ù„Ø·Ø¨ÙŠØ¨: ${escapeHTML(v.doctor||'â€”')}\nØ§Ù„Ø¹ÙŠØ§Ø¯Ø©: ${escapeHTML(v.clinic||'â€”')}
    \nØ§Ù„Ø³Ø¨Ø¨: ${escapeHTML(v.reason||'â€”')}\nÙ…Ù„Ø§Ø­Ø¸Ø§Øª: ${escapeHTML(v.notes||'â€”')}
    \nÙ…Ø±ÙÙ‚Ø§Øª: ${files.length? files.map(f=>f.url).join('\n'):'â€”'}
  `;
  alert(meta);
}

window.editVisit = async function(id){
  const ref=doc(db,'users',uid,'children',childId,'visits',id);
  const s=await getDoc(ref); if(!s.exists()) return alert('ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
  const v=s.data(); editId=id; showForm(true);
  $('#vDate').value=v.date||''; $('#vDoctor').value=v.doctor||''; $('#vClinic').value=v.clinic||'';
  $('#vReason').value=v.reason||''; $('#vNotes').value=v.notes||'';
  $('#vFiles').value=(Array.isArray(v.files)? v.files.map(f=>f.url).join('\n') : '');
}

window.delVisit = async function(id){
  if(!confirm('Ø­Ø°Ù Ø§Ù„Ø²ÙŠØ§Ø±Ø©ØŸ')) return;
  await deleteDoc(doc(db,'users',uid,'children',childId,'visits',id));
  await loadVisits();
}

async function saveVisit(){
  const date=$('#vDate').value; if(!date) return alert('Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®');
  const payload={
    date,
    doctor: $('#vDoctor').value||null,
    clinic: $('#vClinic').value||null,
    reason: $('#vReason').value||null,
    notes: $('#vNotes').value||null,
    files: linksFromTextarea($('#vFiles').value),
    updatedAt: serverTimestamp()
  };
  if(editId){
    await updateDoc(doc(db,'users',uid,'children',childId,'visits',editId), payload);
  }else{
    payload.createdAt=serverTimestamp();
    await addDoc(collection(db,'users',uid,'children',childId,'visits'), payload);
  }
  showForm(false); editId=null; await loadVisits();
}

function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
</script>
</body>
</html>
