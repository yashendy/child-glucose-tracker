<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©</title>
  <link rel="stylesheet" href="styles.css">
  <style>@media print{ .no-print{display:none!important} }</style>
</head>
<body>

  <!-- âœ… Ø¨Ù†Ø± Ø§Ù„Ø·ÙÙ„ -->
  <div id="childBanner" style="text-align:center; padding:12px 8px; display:none">
    <img id="bannerAvatar" class="avatar" style="width:84px;height:84px" src="images/avatar-default.png" alt="ØµÙˆØ±Ø© Ø§Ù„Ø·ÙÙ„">
    <div style="margin-top:6px;font-weight:800" id="bannerName">â€”</div>
    <div class="note" id="bannerMeta">â€”</div>
  </div>

  <!-- âœ… Topbar -->
  <div class="topbar">
    <div>ğŸ§‘â€âš•ï¸ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©</div>
    <div class="row">
      <a id="lnkHome" class="btn gray">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <button id="btnLogout" class="btn">Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <main class="container">
    <!-- âœ… Nav -->
    <div class="card"><div class="row" id="childNav"></div></div>

    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 class="section-title">Ø³Ø¬Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</h3>
        <button id="btnVisitNew" class="btn no-print">â• Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
      </div>

      <!-- ÙÙˆØ±Ù… -->
      <div id="visitFormBox" class="card no-print" style="display:none; margin-top:8px">
        <h4 style="margin:0 0 6px">Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø²ÙŠØ§Ø±Ø©</h4>
        <div class="grid g3">
          <div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø©</label><input id="vDate" type="date"></div>
          <div><label>Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨</label><input id="vDoctor" placeholder="Ù…Ø«Ø§Ù„: Ø¯. Ø£Ø­Ù…Ø¯"></div>
          <div><label>Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© / Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰</label><input id="vClinic" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø£Ø·ÙØ§Ù„"></div>
          <div style="grid-column:1/-1"><label>Ø§Ù„Ø³Ø¨Ø¨ / Ø§Ù„Ø´ÙƒÙˆÙ‰</label><input id="vReason" placeholder="ØµØ¯Ø§Ø¹ / Ø¶Ø¨Ø· Ø¬Ø±Ø¹Ø§Øª / Ù…ØªØ§Ø¨Ø¹Ø© Ø¯ÙˆØ±ÙŠØ© ..."></div>
          <div style="grid-column:1/-1"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="vNotes" rows="2"></textarea></div>
          <div style="grid-column:1/-1">
            <label>Ù…Ø±ÙÙ‚Ø§Øª (ØµÙˆØ± Ø£Ùˆ PDF)</label>
            <input id="vFiles" type="file" accept="image/*,application/pdf" multiple>
          </div>
        </div>
        <div class="row" style="justify-content:flex-end; margin-top:8px">
          <button id="btnVisitSave" class="btn primary">ğŸ’¾ Ø­ÙØ¸</button>
          <button id="btnVisitCancel" class="btn gray">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>

      <!-- Ø¬Ø¯ÙˆÙ„ -->
      <div style="margin-top:10px">
        <table class="table">
          <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø·Ø¨ÙŠØ¨</th><th>Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</th><th>Ø§Ù„Ø³Ø¨Ø¨</th><th>Ù…Ø±ÙÙ‚Ø§Øª</th><th class="no-print">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
        <tbody id="visitsRows"><tr><td colspan="6" class="center note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª.</td></tr></tbody>
        </table>
      </div>

      <!-- Ø·Ø¨Ø§Ø¹Ø© Ø²ÙŠØ§Ø±Ø© -->
      <div id="visitPrintArea" class="card" style="display:none; margin-top:10px">
        <h4 style="margin:0 0 6px">Ù…Ù„Ø®Øµ Ø²ÙŠØ§Ø±Ø©</h4>
        <div id="printBody"></div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>
  <div id="loader" class="loader"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>

  <script type="module">
    import { auth, db, storage, ensureAuth, requireChildIdFromQuery, setChildAvatar } from './firebase-init.js';
    import { signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { collection, addDoc, getDocs, doc, getDoc, updateDoc, deleteDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    import { ref as sRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

    const toast=(m)=>{const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000)}
    const showLoader=(on)=>{document.getElementById('loader').style.display=on?'flex':'none'}

    let uid=null, childId=null, child=null, editVisitId=null;

    function buildNav(){
      const row=document.getElementById('childNav'); row.innerHTML='';
      [['child-dashboard.html','Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'],['measures.html','Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ±'],['meals.html','Ø§Ù„ÙˆØ¬Ø¨Ø§Øª'],['reports.html','Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±'],['visits.html','Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©']]
      .forEach(([h,t])=>{ const a=document.createElement('a'); a.className='btn gray'; a.href=`${h}?child=${encodeURIComponent(childId)}`; a.textContent=t; row.appendChild(a);});
      document.getElementById('lnkHome').href=`child-dashboard.html?child=${encodeURIComponent(childId)}`;
    }

    async function loadChild(){
      const s=await getDoc(doc(db,'users',uid,'children',childId));
      child=s.data()||{};
      setChildAvatar(document.getElementById('bannerAvatar'), child.name, child.photoURL);
      bannerName.textContent=child.name||'â€”';
      bannerMeta.textContent=`${child.gender||'â€”'} â€¢ ${child.weight||'â€”'} ÙƒØ¬Ù… â€¢ ${child.height||'â€”'} Ø³Ù…`;
      childBanner.style.display='block';
    }

    function clearVisitForm(){ ['vDate','vDoctor','vClinic','vReason','vNotes'].forEach(id=>document.getElementById(id).value=''); vFiles.value=''; }

    function bindForm(){
      btnVisitCancel.addEventListener('click', ()=>{ visitFormBox.style.display='none'; clearVisitForm(); editVisitId=null; });
      btnVisitNew.addEventListener('click', ()=>{ clearVisitForm(); editVisitId=null; vDate.value=new Date().toISOString().slice(0,10); visitFormBox.style.display='block'; });
      btnVisitSave.addEventListener('click', saveVisit);
    }

    async function saveVisit(){
      const date=vDate.value, doctor=vDoctor.value.trim(), clinic=vClinic.value.trim(), reason=vReason.value.trim(), notes=vNotes.value.trim();
      if(!date){ return toast('Ø£Ø¯Ø®Ù„ÙŠ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø©'); }
      showLoader(true);
      if(!editVisitId){
        const ref = await addDoc(collection(db,'users',uid,'children',childId,'visits'), { date, doctor:doctor||null, clinic:clinic||null, reason:reason||null, notes:notes||null, files:[], createdAt:serverTimestamp(), updatedAt:serverTimestamp() });
        editVisitId = ref.id;
      }else{
        await updateDoc(doc(db,'users',uid,'children',childId,'visits',editVisitId), { date, doctor:doctor||null, clinic:clinic||null, reason:reason||null, notes:notes||null, updatedAt:serverTimestamp() });
      }
      // Ø±ÙØ¹ Ù…Ù„ÙØ§Øª
      const files = Array.from(vFiles.files||[]);
      if(files.length){
        const uploaded=[];
        for(const f of files){
          const path=`users/${uid}/children/${childId}/visits/${editVisitId}/files/${Date.now()}_${f.name.replace(/[^\w.\-]+/g,'_')}`;
          const task = uploadBytesResumable(sRef(storage, path), f, {contentType:f.type});
          await new Promise((res,rej)=> task.on('state_changed', ()=>{}, rej, res));
          const url = await getDownloadURL(task.snapshot.ref);
          uploaded.push({name:f.name, url, type:f.type, size:f.size});
        }
        const vRef=doc(db,'users',uid,'children',childId,'visits',editVisitId);
        const cur=(await getDoc(vRef)).data()||{};
        const curFiles=Array.isArray(cur.files)?cur.files:[];
        await updateDoc(vRef, { files: curFiles.concat(uploaded) });
      }
      toast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø²ÙŠØ§Ø±Ø©'); visitFormBox.style.display='none'; clearVisitForm(); editVisitId=null; await loadVisits();
      showLoader(false);
    }

    async function loadVisits(){
      const tb=document.getElementById('visitsRows');
      const qs=await getDocs(query(collection(db,'users',uid,'children',childId,'visits'), orderBy('date','desc')));
      if(qs.empty){ tb.innerHTML='<tr><td colspan="6" class="center note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª.</td></tr>'; return; }
      const rows=[];
      qs.forEach(s=>{
        const v=s.data(), files=Array.isArray(v.files)? v.files : [];
        rows.push(`<tr>
          <td><b>${escapeHTML(v.date||'â€”')}</b></td>
          <td>${escapeHTML(v.doctor||'â€”')}</td>
          <td>${escapeHTML(v.clinic||'â€”')}</td>
          <td>${escapeHTML(v.reason||'â€”')}</td>
          <td>${ files.length? files.map(f=>`<span class="badge-soft" title="${escapeHTML(f.name)}">${f.type.startsWith('image/')?'ğŸ–¼ï¸':'ğŸ“„'} ${short(f.name)}</span>`).join(' ') : 'â€”' }</td>
          <td class="no-print">
            <button class="btn gray" data-act="view" data-id="${s.id}">ğŸ‘ï¸ Ø¹Ø±Ø¶/Ø·Ø¨Ø§Ø¹Ø©</button>
            <button class="btn gray" data-act="edit" data-id="${s.id}">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="btn red"  data-act="del"  data-id="${s.id}">ğŸ—‘ï¸ Ø­Ø°Ù</button>
          </td>
        </tr>`);
      });
      tb.innerHTML=rows.join('');
      tb.querySelectorAll('button[data-act]').forEach(btn=>{
        const id=btn.dataset.id, act=btn.dataset.act;
        btn.addEventListener('click',()=> act==='view'? viewVisit(id) : act==='edit'? editVisit(id) : delVisit(id));
      });
    }

    function escapeHTML(s){return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]))}
    function short(n){ return (n&&n.length>18)? (n.slice(0,16)+'â€¦') : (n||'Ù…Ù„Ù'); }

    async function viewVisit(id){
      const ref=doc(db,'users',uid,'children',childId,'visits',id);
      const snap=await getDoc(ref); if(!snap.exists()) return;
      const v=snap.data(); const files=Array.isArray(v.files)?v.files:[];
      printBody.innerHTML = `
        <div><b>Ø§Ù„Ø·ÙÙ„:</b> ${escapeHTML(child?.name||'â€”')}</div>
        <div><b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> ${escapeHTML(v.date||'â€”')}</div>
        <div><b>Ø§Ù„Ø·Ø¨ÙŠØ¨:</b> ${escapeHTML(v.doctor||'â€”')}</div>
        <div><b>Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©:</b> ${escapeHTML(v.clinic||'â€”')}</div>
        <div><b>Ø§Ù„Ø³Ø¨Ø¨:</b> ${escapeHTML(v.reason||'â€”')}</div>
        <div><b>Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</b> ${escapeHTML(v.notes||'â€”')}</div>
        <div><b>Ù…Ø±ÙÙ‚Ø§Øª:</b> ${ files.length? files.map(f=>`<div>â€¢ ${f.type.startsWith('image/')?'ğŸ–¼ï¸':'ğŸ“„'} <a href="${f.url}" target="_blank">${escapeHTML(f.name)}</a></div>`).join('') : 'â€”' }</div>
      `;
      visitPrintArea.style.display='block';
      window.print();
    }
    async function editVisit(id){
      const ref=doc(db,'users',uid,'children',childId,'visits',id);
      const s=await getDoc(ref); if(!s.exists()) return;
      const v=s.data();
      editVisitId=id;
      vDate.value=v.date||''; vDoctor.value=v.doctor||''; vClinic.value=v.clinic||''; vReason.value=v.reason||''; vNotes.value=v.notes||'';
      visitFormBox.style.display='block';
    }
    async function delVisit(id){
      if(!confirm('Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø²ÙŠØ§Ø±Ø©ØŸ')) return;
      await deleteDoc(doc(db,'users',uid,'children',childId,'visits',id));
      toast('ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù'); await loadVisits();
    }

    // Boot
    (async function(){
      const {uid:U}=await ensureAuth(); uid=U; childId=requireChildIdFromQuery();
      // nav
      const nav=document.getElementById('childNav'); nav.innerHTML='';
      [['child-dashboard.html','Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'],['measures.html','Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ±'],['meals.html','Ø§Ù„ÙˆØ¬Ø¨Ø§Øª'],['reports.html','Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±'],['visits.html','Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©']]
      .forEach(([h,t])=>{ const a=document.createElement('a'); a.className='btn gray'; a.href=`${h}?child=${encodeURIComponent(childId)}`; a.textContent=t; nav.appendChild(a);});
      document.getElementById('lnkHome').href=`child-dashboard.html?child=${encodeURIComponent(childId)}`;

      await loadChild();
      bindForm();
      await loadVisits();

      btnLogout.addEventListener('click', ()=> signOut(auth).then(()=>location.href='index.html'));
    })();
  </script>
</body>
</html>
