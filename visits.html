<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©</title>
  <!-- ÙŠÙØªØ±Ø¶ ÙˆØ¬ÙˆØ¯ styles.css Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø¨Ù‚ÙŠØ© Ø§Ù„ØµÙØ­Ø§Øª -->
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* Ø¥Ø¶Ø§ÙØ§Øª Ø®ÙÙŠÙØ© ÙÙˆÙ‚ styles.css */
    .tabs{display:flex;gap:6px;flex-wrap:wrap;margin:8px 0}
    .tab{border:1px solid var(--line,#e5e7eb);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    .tab.active{background:#e6f7ff;border-color:#b3e5ff}
    .tab-pane{display:none}
    .tab-pane.show{display:block}
    .chips{display:flex;gap:6px;flex-wrap:wrap}
    .chip{background:#eef6ff;color:#0369a1;border-radius:999px;padding:4px 8px;font-weight:700;font-size:12px}
    .actions .btn{padding:6px 10px}
    .print-visit{display:none;background:#fff;color:#000;padding:12px;border:1px dashed var(--line,#e5e7eb);margin-top:10px}
    .print-visit h4{margin:0 0 6px}
    .badge-soft{display:inline-block;background:#eef6ff;color:#0369a1;border-radius:999px;padding:4px 8px;font-weight:800;font-size:12px}
    .kpi-mini{display:flex;gap:8px;flex-wrap:wrap}
    .kpi-mini .box{background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:8px 10px;font-size:12px}
    .side-link.active{background:#e6f7ff;border-color:#b3e5ff}
    .side-link{display:block;padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;margin-bottom:6px;background:#fff}
    .grid.g4{grid-template-columns:repeat(4,minmax(0,1fr))}
    .grid.g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .vital-row{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:10px}
    .table-visits{width:100%;border-collapse:separate;border-spacing:0}
    .table-visits th,.table-visits td{border:1px solid #e5e7eb;padding:8px;text-align:right;vertical-align:top}
    .table-visits thead th{background:#f0f9ff;font-weight:800}
    @media print{
      @page{ size: A4; margin: 10mm }
      .topbar,.no-print{display:none!important}
      body{background:#fff}
      .print-visit{display:block!important}
    }
  </style>
</head>
<body>

  <!-- Ø¨Ù†Ø± Ø§Ù„Ø·ÙÙ„ -->
  <div id="childBanner" style="text-align:center; padding:12px 8px; display:none">
    <img id="bannerAvatar" class="avatar" style="width:84px;height:84px" src="images/avatar-default.png" alt="ØµÙˆØ±Ø© Ø§Ù„Ø·ÙÙ„">
    <div style="margin-top:6px;font-weight:800" id="bannerName">â€”</div>
    <div class="note" id="bannerMeta">â€”</div>
  </div>

  <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
  <div class="topbar">
    <div>ğŸ©º Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©</div>
    <div class="row">
      <a id="lnkHome" class="btn gray">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <button id="btnPrintVisit" class="btn gray no-print" title="Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ù…ÙØªÙˆØ­Ø©">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø²ÙŠØ§Ø±Ø©</button>
      <button id="btnLogout" class="btn">Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <main class="container">
    <!-- ØªÙ†Ù‚Ù„ Ø§Ù„Ø·ÙÙ„ -->
    <div class="card"><div class="row" id="childNav"></div></div>

    <!-- ÙÙ„Ø§ØªØ± ÙˆØ®ÙŠØ§Ø±Ø§Øª -->
    <section class="card">
      <div class="grid g4">
        <div>
          <label>Ø¨Ø­Ø« Ù†ØµÙŠ</label>
          <input id="qText" placeholder="Ø·Ø¨ÙŠØ¨ØŒ Ø¹ÙŠØ§Ø¯Ø©ØŒ Ø³Ø¨Ø¨ØŒ Ù…Ù„Ø§Ø­Ø¸Ø§Øªâ€¦" />
        </div>
        <div>
          <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
          <input id="from" type="date" />
        </div>
        <div>
          <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
          <input id="to" type="date" />
        </div>
        <div class="row" style="align-items:end">
          <button id="btnRun" class="btn primary" style="width:100%">Ø¹Ø±Ø¶</button>
        </div>
      </div>

      <div class="row no-print" style="margin-top:8px; justify-content:space-between">
        <div class="kpi-mini">
          <div class="box">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª: <b id="k_total">â€”</b></div>
          <div class="box">Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©: <b id="k_last">â€”</b></div>
        </div>
        <div class="row">
          <button id="btnNew" class="btn">â• Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
          <button id="btnExport" class="btn gray">â¬‡ï¸ ØªØµØ¯ÙŠØ± CSV</button>
        </div>
      </div>
    </section>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø²ÙŠØ§Ø±Ø© (ØªØ¨ÙˆÙŠØ¨Ø§Øª) -->
    <section id="visitFormCard" class="card no-print" style="display:none">
      <h3 style="margin:0 0 6px">Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ø²ÙŠØ§Ø±Ø©</h3>
      <div class="tabs" role="tablist">
        <button class="tab active" data-tab="basic">Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª</button>
        <button class="tab" data-tab="vitals">Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ©</button>
        <button class="tab" data-tab="doses">Ù„Ù‚Ø·Ø© Ø§Ù„Ø¬Ø±Ø¹Ø§Øª</button>
        <button class="tab" data-tab="files">Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª</button>
        <button class="tab" data-tab="tasks">Ø§Ù„Ù…Ù‡Ø§Ù…</button>
      </div>

      <!-- Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª -->
      <div id="tab-basic" class="tab-pane show">
        <div class="grid g3">
          <div>
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø©</label>
            <input id="vDate" type="date">
          </div>
          <div>
            <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨</label>
            <input id="vDoctor" placeholder="Ù…Ø«Ø§Ù„: Ø¯. Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ">
          </div>
          <div>
            <label>Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© / Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰</label>
            <input id="vClinic" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø£Ø·ÙØ§Ù„">
          </div>
          <div style="grid-column:1/-1">
            <label>Ø§Ù„Ø³Ø¨Ø¨ / Ø§Ù„Ø´ÙƒÙˆÙ‰</label>
            <input id="vReason" placeholder="Ù…ØªØ§Ø¨Ø¹Ø© / Ø¶Ø¨Ø· Ø¬Ø±Ø¹Ø§Øª / ØµØ¯Ø§Ø¹â€¦">
          </div>
          <div style="grid-column:1/-1">
            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨</label>
            <textarea id="vNotesDoctor" rows="2" placeholder="ØªÙˆØµÙŠØ§Øª ÙˆØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨"></textarea>
          </div>
          <div style="grid-column:1/-1">
            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±</label>
            <textarea id="vNotesParent" rows="2" placeholder="Ø£Ø¹Ø±Ø§Ø¶ Ø¸Ù‡Ø±Øª / Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª"></textarea>
          </div>
          <div style="grid-column:1/-1">
            <label>ÙˆØ³ÙˆÙ… (Ø§ÙØµÙ„ÙŠ Ø¨Ø¹Ù„Ø§Ù…Ø© # Ø£Ùˆ ÙØ§ØµÙ„Ø©)</label>
            <input id="vTags" placeholder="#ØªØ­Ø§Ù„ÙŠÙ„, #ÙˆØµÙØ©">
          </div>
        </div>
      </div>

      <!-- Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ© -->
      <div id="tab-vitals" class="tab-pane">
        <div class="vital-row">
          <div><label>Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)</label><input id="vWt" type="number" step="0.1"></div>
          <div><label>Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)</label><input id="vHt" type="number" step="0.1"></div>
          <div><label>Ø§Ù„Ø­Ø±Ø§Ø±Ø© (Â°C)</label><input id="vTemp" type="number" step="0.1"></div>
          <div><label>Ø¶ØºØ· (Ø§Ù†Ù‚Ø¨Ø§Ø¶ÙŠ)</label><input id="vSys" type="number"></div>
          <div><label>Ø¶ØºØ· (Ø§Ù†Ø¨Ø³Ø§Ø·ÙŠ)</label><input id="vDia" type="number"></div>
          <div><label>Ø§Ù„Ù†Ø¨Ø¶ (bpm)</label><input id="vHR" type="number"></div>
        </div>
        <div class="note" style="margin-top:6px">ÙŠÙØ­Ø³Ø¨ BMI ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØ²Ù† ÙˆØ§Ù„Ø·ÙˆÙ„.</div>
      </div>

      <!-- Ù„Ù‚Ø·Ø© Ø§Ù„Ø¬Ø±Ø¹Ø§Øª -->
      <div id="tab-doses" class="tab-pane">
        <div class="grid g3">
          <div><label>Ø¬Ø±Ø¹Ø© Ø§Ù„ØªØ±Ø³ÙŠØ¨Ø§ (U)</label><input id="vTresiba" type="number" step="0.1"></div>
          <div><label>ICR (Ø¬Ù…/ÙˆØ­Ø¯Ø©)</label><input id="vICR" type="number" step="0.1"></div>
          <div><label>Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„ØªØµØ­ÙŠØ­ (mmol/L Ù„ÙƒÙ„ 1U)</label><input id="vCorr" type="number" step="0.1"></div>
        </div>
        <div class="note" style="margin-top:6px">Ù‡Ø°Ù‡ Ù„Ù‚Ø·Ø© Ù„Ù„Ù…Ø±Ø¬Ø¹ ÙˆØ§Ù„ØªØºÙŠÙŠØ±â€”Ù„Ù† ØªØºÙŠÙ‘Ø± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø·ÙÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ø­Ø¯Ù‘Ø¯ØªÙŠ Ø°Ù„Ùƒ Ù„Ø§Ø­Ù‚Ù‹Ø§.</div>
      </div>

      <!-- Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª -->
      <div id="tab-files" class="tab-pane">
        <label>Ù…Ø±ÙÙ‚Ø§Øª (ØµÙˆØ± Ø£Ùˆ PDF)</label>
        <input id="vFiles" type="file" accept="image/*,application/pdf" multiple />
        <div id="filesPreview" class="chips" style="margin-top:6px"></div>
        <div class="note" style="margin-top:6px">ÙŠØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ù…Ø¨Ø§Ø´Ø±Ø©.</div>
      </div>

      <!-- Ø§Ù„Ù…Ù‡Ø§Ù… -->
      <div id="tab-tasks" class="tab-pane">
        <div class="row" style="align-items:flex-end">
          <div style="flex:1">
            <label>Ù…Ù‡Ù…Ø©</label>
            <input id="taskTitle" placeholder="Ø¹Ù…Ù„ HbA1c / Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¨Ø¹Ø¯ Ø£Ø³Ø¨ÙˆØ¹" />
          </div>
          <div>
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label>
            <input id="taskDue" type="date" />
          </div>
          <div><button id="btnAddTask" class="btn gray">â• Ø¥Ø¶Ø§ÙØ©</button></div>
        </div>
        <div id="tasksList" class="chips" style="margin-top:8px"></div>
      </div>

      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button id="btnSaveVisit" class="btn primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</button>
        <button id="btnCancelVisit" class="btn gray">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </section>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª -->
    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 class="section-title">Ø³Ø¬Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</h3>
        <span class="badge-soft">ÙØ±Ø² Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® ØªÙ†Ø§Ø²Ù„ÙŠÙ‹Ø§</span>
      </div>
      <table class="table-visits">
        <thead>
          <tr>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„Ø·Ø¨ÙŠØ¨</th>
            <th>Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</th>
            <th>Ø§Ù„Ø³Ø¨Ø¨</th>
            <th>ÙˆØ³ÙˆÙ…</th>
            <th>Ù…Ø±ÙÙ‚Ø§Øª</th>
            <th class="no-print">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="visitsRows">
          <tr><td colspan="7" class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ø¨Ø¹Ø¯.</td></tr>
        </tbody>
      </table>
    </section>

    <!-- Ù…Ø³Ø§Ø­Ø© Ø·Ø¨Ø§Ø¹Ø© Ø²ÙŠØ§Ø±Ø© ÙˆØ§Ø­Ø¯Ø© -->
    <section id="visitPrintArea" class="print-visit">
      <h4>ğŸ§‘â€âš•ï¸ Ù…Ù„Ø®Øµ Ø²ÙŠØ§Ø±Ø© Ø·Ø¨ÙŠØ©</h4>
      <div id="printBody"></div>
    </section>
  </main>

  <div id="toast" class="toast"></div>
  <div id="loader" class="loader"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>

  <!-- Ù…Ù†Ø·Ù‚ Ø§Ù„ØµÙØ­Ø© -->
  <script type="module">
    import { auth, db, storage, ensureAuth, requireChildIdFromQuery, setChildAvatar, toLocalDatetimeValue } from './firebase-init.js';
    import { signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      collection, addDoc, getDocs, doc, getDoc, setDoc, updateDoc, deleteDoc,
      query, orderBy, where, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    import {
      ref as sRef, uploadBytesResumable, getDownloadURL
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

    // Helpers UI
    const $=s=>document.querySelector(s);
    const toast=(m)=>{const t=$("#toast");t.textContent=m;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),2000);}
    const showLoader=(on)=>{$("#loader").style.display=on?'flex':'none'}
    const z2=n=>String(n).padStart(2,'0');
    const todayISO=()=>{const d=new Date();return `${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())}`}

    let uid=null, childId=null, child=null, editId=null;
    let filesQueue=[];   // Ù…Ù„ÙØ§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø±ÙØ¹
    let tasks=[];       // {title, dueDate, done}

    // ØªÙ†Ù‚Ù„ Ø§Ù„ØµÙØ­Ø©
    function buildNav(){
      const row=$("#childNav"); row.innerHTML='';
      const items=[
        ['child-dashboard.html','Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'],
        ['measures.html','Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ±'],
        ['meals.html','Ø§Ù„ÙˆØ¬Ø¨Ø§Øª'],
        ['reports.html','Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±'],
        ['visits.html','Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©']
      ];
      items.forEach(([h,t])=>{
        const a=document.createElement('a');
        a.className='btn gray';
        a.href=`${h}?child=${encodeURIComponent(childId)}`;
        a.textContent=t;
        row.appendChild(a);
      });
      $("#lnkHome").href=`child-dashboard.html?child=${encodeURIComponent(childId)}`;
    }

    async function loadChild(){
      const s=await getDoc(doc(db,'users',uid,'children',childId));
      if(!s.exists()){ alert('Ø§Ù„Ø·ÙÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }
      child=s.data()||{};
      setChildAvatar($("#bannerAvatar"), child.name, child.photoURL);
      bannerName.textContent=child.name||'â€”';
      bannerMeta.textContent=`${child.gender||'â€”'} â€¢ ${child.weight||'â€”'} ÙƒØ¬Ù… â€¢ ${child.height||'â€”'} Ø³Ù…`;
      childBanner.style.display='block';
    }

    // Tabs
    const tabs=Array.from(document.querySelectorAll('.tab'));
    tabs.forEach(b=>b.addEventListener('click', ()=>{
      tabs.forEach(x=>x.classList.remove('active')); b.classList.add('active');
      const id=b.dataset.tab;
      document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('show'));
      document.getElementById('tab-'+id).classList.add('show');
    }));

    function clearForm(){
      editId=null; filesQueue=[]; tasks=[];
      vDate.value=todayISO();
      ['vDoctor','vClinic','vReason','vNotesDoctor','vNotesParent','vTags',
       'vWt','vHt','vTemp','vSys','vDia','vHR','vTresiba','vICR','vCorr'].forEach(id=>document.getElementById(id).value='');
      vFiles.value='';
      filesPreview.innerHTML='';
      renderTasks();
    }

    // Ù…Ù‡Ø§Ù…
    function renderTasks(){
      const box=$("#tasksList"); box.innerHTML='';
      if(!tasks.length){ box.innerHTML='<span class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù….</span>'; return; }
      tasks.forEach((t,i)=>{
        const el=document.createElement('div'); el.className='chip';
        el.innerHTML = `<input type="checkbox" ${t.done?'checked':''} style="vertical-align:middle"> ${escapeHTML(t.title)} ${t.dueDate?`â€” <small>${t.dueDate}</small>`:''} <a href="#" data-i="${i}" style="margin-right:8px">âœ–</a>`;
        el.querySelector('input').addEventListener('change',e=>{ t.done = e.target.checked; });
        el.querySelector('a').addEventListener('click',e=>{e.preventDefault(); tasks.splice(i,1); renderTasks();});
        box.appendChild(el);
      });
    }
    function escapeHTML(s){return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]))}

    // Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ø²ÙŠØ§Ø±Ø©
    async function uploadVisitFiles(visitId){
      if(!filesQueue.length) return [];
      const out=[];
      for(const f of filesQueue){
        const path=`users/${uid}/children/${childId}/visits/${visitId}/files/${Date.now()}_${sanitizeName(f.name)}`;
        const ref=sRef(storage, path);
        const task=uploadBytesResumable(ref, f, {contentType:f.type});
        await new Promise((res,rej)=>task.on('state_changed',()=>{},rej,res));
        const url=await getDownloadURL(task.snapshot.ref);
        out.push({name:f.name,url,type:f.type,size:f.size});
      }
      return out;
    }
    function sanitizeName(n){ return (n||'file').replace(/[^\w.\-]+/g,'_'); }

    // Ø­ÙØ¸ Ø§Ù„Ø²ÙŠØ§Ø±Ø©
    async function saveVisit(){
      const base={
        date: vDate.value,
        doctor: vDoctor.value.trim()||null,
        clinic: vClinic.value.trim()||null,
        reason: vReason.value.trim()||null,
        notesDoctor: vNotesDoctor.value.trim()||null,
        notesParent: vNotesParent.value.trim()||null,
        tags: parseTags(vTags.value),
        vitals:{
          weight: numOrNull(vWt), height: numOrNull(vHt), temp: numOrNull(vTemp),
          bpSys: numOrNull(vSys), bpDia: numOrNull(vDia), hr: numOrNull(vHR),
          bmi: computeBMI(numOrNull(vWt), numOrNull(vHt))
        },
        doseSnapshot:{
          tresiba: numOrNull(vTresiba),
          icr: numOrNull(vICR),
          correctionFactor: numOrNull(vCorr)
        },
        tasks: tasks,
        updatedAt: serverTimestamp()
      };
      if(!base.date){ toast('Ø£Ø¯Ø®Ù„ÙŠ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø©'); return; }

      showLoader(true);
      try{
        let vid=editId;
        if(!vid){
          const ref=await addDoc(collection(db,'users',uid,'children',childId,'visits'),{
            ...base, createdAt: serverTimestamp(), files:[]
          });
          vid=ref.id;
        }else{
          await updateDoc(doc(db,'users',uid,'children',childId,'visits',vid), base);
        }

        const uploaded = await uploadVisitFiles(vid);
        if(uploaded.length){
          const ref=doc(db,'users',uid,'children',childId,'visits',vid);
          const snap=await getDoc(ref);
          const cur=snap.data()||{};
          const curFiles=Array.isArray(cur.files)?cur.files:[];
          await updateDoc(ref,{files: curFiles.concat(uploaded)});
        }

        toast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø²ÙŠØ§Ø±Ø©');
        visitFormCard.style.display='none';
        clearForm();
        await loadVisits();
      }catch(err){
        console.error(err);
        alert('ØªØ¹Ø°Ù‘Ø± Ø­ÙØ¸ Ø§Ù„Ø²ÙŠØ§Ø±Ø©: '+(err?.message||err));
      }finally{ showLoader(false); }
    }

    function numOrNull(inp){ const v=Number(inp?.value); return Number.isFinite(v)? v : null; }
    function computeBMI(wt, htCm){ if(!(wt>0 && htCm>0)) return null; const h=htCm/100; const bmi=wt/(h*h); return Math.round(bmi*10)/10; }
    function parseTags(s){ if(!s) return []; return s.split(/[#,ØŒ,]/).map(x=>x.trim()).filter(Boolean); }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª
    async function loadVisits(){
      const from=$("#from").value, to=$("#to").value, txt=($("#qText").value||'').toLowerCase();
      const qy=query(collection(db,'users',uid,'children',childId,'visits'), orderBy('date','desc'));
      const qs=await getDocs(qy);

      let rows=[];
      let lastDate='â€”';
      qs.forEach(s=>{
        const v=s.data()||{};
        // ÙÙ„ØªØ±Ø© Ø²Ù…Ù†ÙŠØ© Ø¨Ø³ÙŠØ·Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© (Ø£Ø¨Ø³Ø· Ù…Ù† where Ù…ØªØ¹Ø¯Ø¯)
        if(from && v.date<from) return;
        if(to   && v.date>to)   return;
        // Ø¨Ø­Ø« Ù†ØµÙ‘ÙŠ
        const blob=(v.doctor||'')+' '+(v.clinic||'')+' '+(v.reason||'')+' '+(v.notesDoctor||'')+' '+(v.notesParent||'')+' '+(Array.isArray(v.tags)?v.tags.join(' '):'');
        if(txt && !blob.toLowerCase().includes(txt)) return;

        rows.push({id:s.id, ...v});
        if(lastDate==='â€”') lastDate=v.date||'â€”';
      });

      k_total.textContent=rows.length||0;
      k_last.textContent=lastDate;

      if(!rows.length){
        visitsRows.innerHTML='<tr><td colspan="7" class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©.</td></tr>';
        return;
      }

      visitsRows.innerHTML = rows.map(v=>{
        const files = Array.isArray(v.files)? v.files : [];
        const tags  = Array.isArray(v.tags)? v.tags : [];
        return `
          <tr>
            <td><b>${escapeHTML(v.date||'â€”')}</b></td>
            <td>${escapeHTML(v.doctor||'â€”')}</td>
            <td>${escapeHTML(v.clinic||'â€”')}</td>
            <td>${escapeHTML(v.reason||'â€”')}</td>
            <td>${tags.map(t=>`<span class="chip">${escapeHTML(t)}</span>`).join(' ')||'â€”'}</td>
            <td>${files.length? files.map(f=>`<span class="chip" title="${escapeHTML(f.name)}">${f.type?.startsWith('image/')?'ğŸ–¼ï¸':'ğŸ“„'} ${short(f.name)}</span>`).join(' ') : 'â€”'}</td>
            <td class="actions no-print">
              <button class="btn gray" data-act="view" data-id="${v.id}">ğŸ‘ï¸ Ø¹Ø±Ø¶/Ø·Ø¨Ø§Ø¹Ø©</button>
              <button class="btn gray" data-act="edit" data-id="${v.id}">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="btn red"  data-act="del"  data-id="${v.id}">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            </td>
          </tr>
        `;
      }).join('');

      // Ø±Ø¨Ø· Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
      visitsRows.querySelectorAll('button[data-act]').forEach(btn=>{
        const id=btn.dataset.id, act=btn.dataset.act;
        btn.addEventListener('click',()=>{
          if(act==='view') viewVisit(id);
          else if(act==='edit') editVisit(id);
          else if(act==='del')  delVisit(id);
        });
      });
    }

    function short(n){ return (n&&n.length>18)? (n.slice(0,16)+'â€¦') : (n||'Ù…Ù„Ù'); }

    async function viewVisit(id){
      const ref=doc(db,'users',uid,'children',childId,'visits',id);
      const snap=await getDoc(ref);
      if(!snap.exists()){ alert('Ø§Ù„Ø²ÙŠØ§Ø±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'); return; }
      const v=snap.data()||{};
      const files=Array.isArray(v.files)? v.files : [];
      const tags =Array.isArray(v.tags)? v.tags : [];

      const meta=`
        <div class="row" style="justify-content:space-between">
          <div><b>Ø§Ù„Ø·ÙÙ„:</b> ${escapeHTML(child?.name||'â€”')}</div>
          <div><b>Ø§Ù„ØªØ§Ø±ÙŠØ®:</b> ${escapeHTML(v.date||'â€”')}</div>
        </div>
        <div><b>Ø§Ù„Ø·Ø¨ÙŠØ¨:</b> ${escapeHTML(v.doctor||'â€”')} â€¢ <b>Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©:</b> ${escapeHTML(v.clinic||'â€”')}</div>
        <div><b>Ø§Ù„Ø³Ø¨Ø¨:</b> ${escapeHTML(v.reason||'â€”')}</div>
        <div><b>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨:</b> ${escapeHTML(v.notesDoctor||'â€”')}</div>
        <div><b>Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±:</b> ${escapeHTML(v.notesParent||'â€”')}</div>
        <div style="margin:6px 0"><b>Ø§Ù„ÙˆØ³ÙˆÙ…:</b> ${tags.map(t=>`<span class="chip">${escapeHTML(t)}</span>`).join(' ')||'â€”'}</div>
        <hr>
        <div><b>Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠÙ‘Ø©:</b> ÙˆØ²Ù† ${v.vitals?.weight??'â€”'} ÙƒØ¬Ù… â€¢ Ø·ÙˆÙ„ ${v.vitals?.height??'â€”'} Ø³Ù… â€¢ BMI ${v.vitals?.bmi??'â€”'} â€¢ Ø­Ø± ${v.vitals?.temp??'â€”'}Â°C â€¢ Ø¶ØºØ· ${v.vitals?.bpSys??'â€”'}/${v.vitals?.bpDia??'â€”'} â€¢ Ù†Ø¨Ø¶ ${v.vitals?.hr??'â€”'}</div>
        <div><b>Ù„Ù‚Ø·Ø© Ø§Ù„Ø¬Ø±Ø¹Ø§Øª:</b> ØªØ±Ø³ÙŠØ¨Ø§ ${v.doseSnapshot?.tresiba??'â€”'} U â€¢ ICR ${v.doseSnapshot?.icr??'â€”'} g/U â€¢ ØªØµØ­ÙŠØ­ ${v.doseSnapshot?.correctionFactor??'â€”'} mmol/L/U</div>
        <div style="margin:6px 0"><b>Ø§Ù„Ù…Ù‡Ø§Ù…:</b> ${
          (Array.isArray(v.tasks)&&v.tasks.length)?
            v.tasks.map(t=>`<div>â€¢ ${escapeHTML(t.title)} ${t.dueDate?`<small>(${t.dueDate})</small>`:''} â€” ${t.done?'ØªÙ…':'Ù‚ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©'}</div>`).join('') : 'â€”'
        }</div>
        <div><b>Ù…Ø±ÙÙ‚Ø§Øª:</b> ${
          files.length? files.map(f=>`<div>â€¢ ${f.type?.startsWith('image/')?'ğŸ–¼ï¸':'ğŸ“„'} <a href="${f.url}" target="_blank">${escapeHTML(f.name)}</a></div>`).join('') : 'â€”'
        }</div>
      `;
      $("#printBody").innerHTML=meta;
      // Ø¥Ø¸Ù‡Ø§Ø± ÙƒØªÙ„Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø© (Ø³ØªØ®ØªÙÙŠ ÙÙŠ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ)
      $("#visitPrintArea").style.display='block';
      // Ø§Ø®ØªÙŠØ§Ø±ÙŠ: ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø·Ø¨Ø§Ø¹Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø²Ø±Ù‘ Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
      $("#btnPrintVisit").onclick = ()=> window.print();
      toast('âœ… ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© â€” Ø§Ø³ØªØ®Ø¯Ù…ÙŠ Ø²Ø± Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø²ÙŠØ§Ø±Ø©');
    }

    async function editVisit(id){
      const ref=doc(db,'users',uid,'children',childId,'visits',id);
      const snap=await getDoc(ref);
      if(!snap.exists()){ alert('Ø§Ù„Ø²ÙŠØ§Ø±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'); return; }
      const v=snap.data()||{};
      editId=id;
      visitFormCard.style.display='block';
      // ØªØ¨ÙˆÙŠØ¨ Ø£ÙˆÙ„
      tabs.forEach(x=>x.classList.remove('active')); tabs[0].classList.add('active');
      document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('show'));
      document.getElementById('tab-basic').classList.add('show');

      vDate.value = v.date || todayISO();
      vDoctor.value = v.doctor || '';
      vClinic.value = v.clinic || '';
      vReason.value = v.reason || '';
      vNotesDoctor.value = v.notesDoctor || '';
      vNotesParent.value = v.notesParent || '';
      vTags.value = (Array.isArray(v.tags)? v.tags.map(t=>`#${t}`).join(' ') : '');

      vWt.value = v.vitals?.weight ?? '';
      vHt.value = v.vitals?.height ?? '';
      vTemp.value = v.vitals?.temp ?? '';
      vSys.value = v.vitals?.bpSys ?? '';
      vDia.value = v.vitals?.bpDia ?? '';
      vHR.value  = v.vitals?.hr ?? '';

      vTresiba.value = v.doseSnapshot?.tresiba ?? '';
      vICR.value     = v.doseSnapshot?.icr ?? '';
      vCorr.value    = v.doseSnapshot?.correctionFactor ?? '';

      tasks = Array.isArray(v.tasks) ? JSON.parse(JSON.stringify(v.tasks)) : [];
      renderTasks();

      filesQueue=[]; // Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
      filesPreview.innerHTML = (Array.isArray(v.files)&&v.files.length)
        ? v.files.map(f=>`<span class="chip" title="${escapeHTML(f.name)}">${f.type?.startsWith('image/')?'ğŸ–¼ï¸':'ğŸ“„'} ${short(f.name)}</span>`).join(' ')
        : '<span class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±ÙÙ‚Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©.</span>';
      toast('âœï¸ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…ÙØ¹Ù‘Ù„');
    }

    async function delVisit(id){
      if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ÙŠÙ† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø²ÙŠØ§Ø±Ø©ØŸ')) return;
      await deleteDoc(doc(db,'users',uid,'children',childId,'visits',id));
      toast('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø²ÙŠØ§Ø±Ø©');
      await loadVisits();
    }

    // CSV Ø¨Ø³ÙŠØ·
    function exportCSV(rows){
      const head=['date','doctor','clinic','reason','tags','notesDoctor','notesParent','weight','height','bmi','tresiba','icr','corr'];
      const lines=[head.join(',')];
      rows.forEach(v=>{
        const line=[
          v.date||'',
          qcsv(v.doctor), qcsv(v.clinic), qcsv(v.reason),
          qcsv((Array.isArray(v.tags)?v.tags.join('|'):'')),
          qcsv(v.notesDoctor), qcsv(v.notesParent),
          v.vitals?.weight??'', v.vitals?.height??'', v.vitals?.bmi??'',
          v.doseSnapshot?.tresiba??'', v.doseSnapshot?.icr??'', v.doseSnapshot?.correctionFactor??''
        ].join(',');
        lines.push(line);
      });
      const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download=`visits_${child?.name||'child'}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    }
    function qcsv(s){ const v=String(s||'').replace(/"/g,'""'); return `"${v}"`; }

    // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    btnNew.addEventListener('click', ()=>{
      clearForm();
      visitFormCard.style.display='block';
      tabs.forEach(x=>x.classList.remove('active')); tabs[0].classList.add('active');
      document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('show'));
      document.getElementById('tab-basic').classList.add('show');
    });
    btnCancelVisit.addEventListener('click', ()=>{
      visitFormCard.style.display='none';
      clearForm();
    });
    btnSaveVisit.addEventListener('click', saveVisit);

    btnAddTask.addEventListener('click', ()=>{
      const title=(taskTitle.value||'').trim(); if(!title) return toast('Ø§ÙƒØªØ¨ÙŠ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©');
      tasks.push({title, dueDate: taskDue.value||null, done:false});
      taskTitle.value=''; taskDue.value=''; renderTasks();
    });

    vFiles.addEventListener('change', ()=>{
      filesQueue = Array.from(vFiles.files||[]);
      if(!filesQueue.length){ filesPreview.innerHTML=''; return; }
      filesPreview.innerHTML = filesQueue.map(f=>`<span class="chip">${f.type.startsWith('image/')?'ğŸ–¼ï¸':'ğŸ“„'} ${escapeHTML(f.name)}</span>`).join(' ');
    });

    btnRun.addEventListener('click', loadVisits);
    btnExport.addEventListener('click', async ()=>{
      // Ù†Ø¨Ù†ÙŠ Ù†ÙØ³ Ù‚Ø§Ø¦Ù…Ø© loadVisits Ø«Ù… Ù†ØµØ¯Ø±
      const from=$("#from").value, to=$("#to").value, txt=($("#qText").value||'').toLowerCase();
      const qy=query(collection(db,'users',uid,'children',childId,'visits'), orderBy('date','desc'));
      const qs=await getDocs(qy);
      let rows=[];
      qs.forEach(s=>{
        const v=s.data()||{};
        if(from && v.date<from) return;
        if(to   && v.date>to)   return;
        const blob=(v.doctor||'')+' '+(v.clinic||'')+' '+(v.reason||'')+' '+(v.notesDoctor||'')+' '+(v.notesParent||'')+' '+(Array.isArray(v.tags)?v.tags.join(' '):'');
        if(txt && !blob.toLowerCase().includes(txt)) return;
        rows.push({id:s.id, ...v});
      });
      exportCSV(rows);
    });

    btnLogout.addEventListener('click', ()=>signOut(auth).then(()=>location.href='index.html'));

    // Boot
    (async function(){
      const {uid:U}=await ensureAuth(); uid=U;
      childId=requireChildIdFromQuery();
      buildNav();
      await loadChild();
      // Ø§ÙØªØ±Ø§Ø¶ ÙØªØ±Ø© Ø¢Ø®Ø± 30 ÙŠÙˆÙ…
      const to=todayISO(); const d=new Date(); d.setDate(d.getDate()-29);
      const from=`${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())}`;
      $("#from").value=from; $("#to").value=to;
      await loadVisits();
    })();
  </script>
</body>
</html>
