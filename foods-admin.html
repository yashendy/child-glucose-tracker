<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ©</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800&display=swap">
<style>
:root{
  --brand:#0ea5e9; --brand2:#6ee7b7; --line:#e5e7eb; --ink:#0f172a; --muted:#6b7280;
  --bg:#f6fbff; --card:#fff; --ok:#16a34a; --warn:#b45309; --err:#dc2626;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.6 "Tajawal",system-ui,sans-serif}
a{text-decoration:none;color:inherit}
.row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.btn{border:none;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
.btn.primary{background:var(--brand);color:#fff}
.btn.gray{background:#eef2f7}
.btn.green{background:#10b981;color:#fff}
.btn.orange{background:#f97316;color:#fff}
.btn.red{background:#ef4444;color:#fff}
.btn.blue{background:#3b82f6;color:#fff}
.note{color:var(--muted);font-size:13px}

.topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;
  padding:10px 14px;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;position:sticky;top:0;z-index:10}
.topbar .btn{background:#ffffff22;border:1px solid #ffffff66;color:#fff}

.container{max-width:1200px;margin:auto;padding:14px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 6px 24px rgba(0,0,0,.04);margin-bottom:12px}

.layout{display:grid;grid-template-columns:260px 1fr;gap:14px}
@media(max-width:980px){.layout{grid-template-columns:1fr}}

.sidebar{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px}
.cat-btn{width:100%;text-align:right;border:1px solid var(--line);background:#fff;padding:10px;border-radius:10px;margin:6px 0;cursor:pointer;font-weight:800}
.cat-btn.active,.cat-btn:hover{background:#e6f7ff;border-color:#b3e5ff}
.badge{display:inline-block;background:#eef6ff;color:#0369a1;border-radius:999px;padding:4px 8px;font-weight:800;font-size:12px}
.badge.ok{background:#ecfdf5;color:#16a34a}
.badge.warn{background:#fff7ed;color:#b45309}
.badge.err{background:#fee2e2;color:#dc2626}

.searchbar{display:flex;gap:8px}
.searchbar input{flex:1;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}

.table{width:100%;border-collapse:separate;border-spacing:0}
.table th,.table td{border:1px solid var(--line);padding:8px;text-align:right;vertical-align:top}
.table thead th{background:#f0f9ff;font-weight:800}
.center{text-align:center}

.form-grid{display:grid;gap:10px;grid-template-columns:repeat(3,minmax(0,1fr))}
@media(max-width:900px){.form-grid{grid-template-columns:1fr}}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
textarea{resize:vertical}

.units{display:flex;flex-direction:column;gap:8px}
.unit-row{display:grid;grid-template-columns:1.5fr 1fr auto;gap:8px}
.unit-row input{width:100%}
.unit-row .rm{background:#f1f5f9;border:1px solid var(--line);border-radius:10px;padding:0 10px;cursor:pointer}

.preview{max-height:360px;overflow:auto;border:1px dashed var(--line);border-radius:10px;padding:8px;background:#fcfeff}

.loader{display:none;position:fixed;inset:0;background:rgba(255,255,255,.6);z-index:9999;align-items:center;justify-content:center}
.loader .dot{width:10px;height:10px;border-radius:50%;margin:0 4px;background:#0ea5e9;animation:b .9s infinite alternate}
.loader .dot:nth-child(2){animation-delay:.15s}.loader .dot:nth-child(3){animation-delay:.3s}
@keyframes b{to{transform:translateY(-6px);background:#06b6d4}}
.toast{position:fixed;bottom:16px;left:16px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transform:translateY(8px);transition:.3s;z-index:99999}
.toast.show{opacity:1;transform:none}

.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<header class="topbar">
  <div class="row">
    <a class="btn" href="dashboard.html">Ù„ÙˆØ­Ø© ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±</a>
    <a class="btn" href="child-meals.html">Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ¬Ø¨Ø§Øª</a>
  </div>
  <div class="row">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„ØºØ°Ø§Ø¦ÙŠØ©</div>
</header>

<main class="container">
  <div class="row searchbar card">
    <input id="q" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ØªØµÙ†ÙŠÙ Ø£Ùˆ Ù†ÙˆØ¹ Ø§Ù„ÙˆØ­Ø¯Ø©â€¦">
    <button id="btnAdd" class="btn green">â• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
    <input id="fileXLSX" type="file" accept=".xlsx,.xls" hidden>
    <button id="btnImport" class="btn orange">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel</button>
    <span id="resultCount" class="badge">â€” Ù†ØªØ§Ø¦Ø¬</span>
  </div>

  <div class="layout">
    <!-- Sidebar: Categories -->
    <aside class="sidebar">
      <div class="row" style="justify-content:space-between;align-items:center">
        <b>Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</b>
        <span id="catTotal" class="badge">â€”</span>
      </div>
      <div id="cats"></div>
    </aside>

    <!-- Main -->
    <section>
      <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ø­Ø§Ù„ÙŠØ© -->
      <section class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h3 style="margin:0">ğŸ“‹ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
          <div class="small">ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ù…Ù† Firestore: <b>foods</b></div>
        </div>
        <div style="overflow:auto">
          <table class="table" id="tblFoods">
            <thead>
              <tr>
                <th style="min-width:180px">Ø§Ù„Ø§Ø³Ù…</th>
                <th>Ø§Ù„ØªØµÙ†ÙŠÙ</th>
                <th>ÙƒØ§Ø±Ø¨/100Ø¬Ù…</th>
                <th style="min-width:180px">Ø§Ù„ÙˆØ­Ø¯Ø§Øª</th>
                <th>ØµÙˆØ±Ø©</th>
                <th>Ø­Ø§Ù„Ø©</th>
              </tr>
            </thead>
            <tbody id="foodsBody"><tr><td colspan="6" class="center note">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</td></tr></tbody>
          </table>
        </div>
      </section>

      <!-- Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ ØµÙ†Ù ÙŠØ¯ÙˆÙŠ -->
      <section class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h3 style="margin:0">â• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù ÙŠØ¯ÙˆÙŠÙ‹Ø§</h3>
          <div class="small">Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ©: Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„ØªØµÙ†ÙŠÙØŒ ÙƒØ§Ø±Ø¨/100Ø¬Ù…</div>
        </div>

        <div class="form-grid">
          <div>
            <label>Ø§Ù„Ø§Ø³Ù… *</label>
            <input id="fName" placeholder="Ù…Ø«Ø§Ù„: Ø²Ø¨Ø§Ø¯ÙŠ Ù‚Ù„ÙŠÙ„ Ø§Ù„Ø¯Ø³Ù…">
          </div>
          <div>
            <label>Ø§Ù„ØªØµÙ†ÙŠÙ *</label>
            <input id="fCategory" list="catsList" placeholder="Ø£Ù„Ø¨Ø§Ù† / Ø¨Ù‚ÙˆÙ„ÙŠØ§Øª / ÙÙˆØ§ÙƒÙ‡â€¦">
            <datalist id="catsList"></datalist>
          </div>
          <div>
            <label>ÙƒØ§Ø±Ø¨/100Ø¬Ù… *</label>
            <input id="fCarbs" type="number" min="0" step="0.1" placeholder="Ù…Ø«Ø§Ù„: 4.7">
          </div>

          <div>
            <label>ØµÙˆØ±Ø© (Ø±Ø§Ø¨Ø· Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="fImg" placeholder="https://â€¦">
          </div>
          <div>
            <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="fNotes" placeholder="â€”">
          </div>
          <div class="row" style="align-items:flex-end">
            <button id="btnQuickUnits" class="btn gray" type="button">âš¡ Ù‚ÙˆØ§Ù„Ø¨ ÙˆØ­Ø¯Ø§Øª Ø´Ø§Ø¦Ø¹Ø©</button>
          </div>
        </div>

        <div class="units" id="unitsBox" style="margin-top:10px">
          <div class="row" style="justify-content:space-between;align-items:center">
            <b>ÙˆØ­Ø¯Ø§Øª Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…</b>
            <button id="btnAddUnit" class="btn gray" type="button">â• Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø¯Ø©</button>
          </div>
          <!-- ØµÙ Ø§ÙØªØ±Ø§Ø¶ÙŠ -->
          <div class="unit-row">
            <input class="uName" placeholder="Ù…Ø«Ø§Ù„: Ø¬Ø±Ø§Ù… / ÙƒÙˆØ¨ / Ù…Ù„Ø¹Ù‚Ø© / Ø­Ø¨Ø©">
            <input class="uGrams" type="number" min="0" step="0.1" placeholder="Ø¬Ø±Ø§Ù…">
            <button class="rm">ğŸ—‘ï¸</button>
          </div>
        </div>

        <div class="row" style="justify-content:flex-end;margin-top:10px">
          <button id="btnSaveFood" class="btn primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù</button>
        </div>
      </section>

      <!-- Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ -->
      <section class="card" id="importBox" style="display:none">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h3 style="margin:0">ğŸ“¥ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Excel</h3>
          <div class="row">
            <button id="btnCommitImport" class="btn blue">âœ… Ø­ÙØ¸ Ø§Ù„ØµØ§Ù„Ø­ ÙÙ‚Ø·</button>
            <button id="btnCancelImport" class="btn gray">Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>
        <div class="note" style="margin-bottom:8px">
          Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨: <b>name*</b>, <b>category*</b>, <b>carbsPer100g*</b>, unit1, grams1, unit2, grams2, unit3, grams3, imageUrl, isActive, notes
        </div>
        <div class="row" style="gap:12px;margin-bottom:6px">
          <span class="badge ok"   id="impOk">ØµØ§Ù„Ø­: 0</span>
          <span class="badge warn" id="impWarn">ØªØ­Ø°ÙŠØ±: 0</span>
          <span class="badge err"  id="impErr">Ø£Ø®Ø·Ø§Ø¡: 0</span>
          <span class="badge"      id="impTotal">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0</span>
        </div>
        <div class="preview">
          <table class="table" id="tblImport">
            <thead>
              <tr>
                <th>#</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ØªØµÙ†ÙŠÙ</th><th>ÙƒØ§Ø±Ø¨/100Ø¬Ù…</th>
                <th>Ø§Ù„ÙˆØ­Ø¯Ø§Øª</th><th>ØµÙˆØ±Ø©</th><th>Active</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="impBody"><tr><td colspan="9" class="center note">Ø§Ø±ÙØ¹ÙŠ Ù…Ù„Ù Excel Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©.</td></tr></tbody>
          </table>
        </div>
      </section>
    </section>
  </div>
</main>

<!-- Overlays -->
<div id="loader" class="loader" aria-hidden="true"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
<div id="toast" class="toast"></div>

<!-- XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" integrity="sha512-VQqX2JH0Qm8O1G3ZxB9v3rEJmW7i3o3wqz5kSo7x2qXrWvQbI2nqJpHkAOlzqOuqLhVqLkC5q7hF9r0Xxw0jTQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script type="module">
/* ===== Firebase init ===== */
import { app, db, auth } from './firebase-init.js';
import {
  collection, getDocs, addDoc, writeBatch, doc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

/* ===== Helpers (UI) ===== */
const $=s=>document.querySelector(s);
function toast(msg, ms=2200){ const t=$("#toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),ms); }
function loading(on=true){ const l=$("#loader"); l.style.display=on?'flex':'none'; l.setAttribute('aria-hidden', on?'false':'true'); }
function toFixed1(n){ const v=Math.round(Number(n)*10)/10; return Number.isFinite(v)? v.toFixed(1):''; }

/* ØªØ·Ø¨ÙŠØ¹ Ø¹Ø±Ø¨ÙŠ Ù„Ù„Ø¨Ø­Ø« (ÙŠØ²ÙŠÙ„ Ø§Ù„ØªØ´ÙƒÙŠÙ„ ÙˆÙŠÙØ±Ù‘Øº Ø§Ù„Ù‡Ù…Ø²Ø§Øª) */
function normalizeArabic(s){
  if(!s) return '';
  return s.toString().toLowerCase()
   .normalize("NFKD")
   .replace(/[ÙÙ‹ÙÙŒÙÙÙ’Ù‘Ù€]/g,'')       // ØªØ´ÙƒÙŠÙ„
   .replace(/[Ø¥Ø£Ø¢]/g,'Ø§')            // Ù‡Ù…Ø²Ø§Øª
   .replace(/Ù‰/g,'ÙŠ').replace(/Ø¤/g,'Ùˆ').replace(/Ø¦/g,'ÙŠ')
   .replace(/\s+/g,' ').trim();
}

/* ===== State ===== */
let UID=null;
let foodsAll=[];     // ÙƒØ§ÙØ© Ø§Ù„Ø£ØµÙ†Ø§Ù Ù…Ù† Firestore
let filtered=[];     // Ù†Ø§ØªØ¬ Ø§Ù„Ø¨Ø­Ø«/Ø§Ù„ØªØµÙ†ÙŠÙ
let currentCat='*';  // Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ø®ØªØ§Ø± ÙÙŠ Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
let importRows=[];   // Ù†ØªØ§Ø¦Ø¬ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥ÙƒØ³Ù„ (Ù…Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚)

/* ===== Auth ===== */
onAuthStateChanged(auth, (u)=>{
  if(!u){ location.href='index.html'; return; }
  UID=u.uid;
  initPage();
});

/* ===== Init ===== */
async function initPage(){
  bindUI();
  await loadFoods();
  buildCats();
  renderFoods();
  fillCatsDatalist();
}

/* ===== Bind UI ===== */
function bindUI(){
  $("#btnAdd").addEventListener("click", ()=>{ document.getElementById('fName').focus(); window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'}); });
  $("#btnImport").addEventListener("click", ()=>$("#fileXLSX").click());
  $("#fileXLSX").addEventListener("change", onPickExcel);
  $("#q").addEventListener("input", debounce(renderFoods, 250));
  $("#btnSaveFood").addEventListener("click", saveFood);
  $("#btnAddUnit").addEventListener("click", addUnitRow);
  $("#btnQuickUnits").addEventListener("click", quickUnits);

  $("#btnCommitImport").addEventListener("click", commitImport);
  $("#btnCancelImport").addEventListener("click", ()=>{
    importRows=[]; $("#impBody").innerHTML='<tr><td colspan="9" class="center note">ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©.</td></tr>';
    $("#importBox").style.display='none';
  });

  // Ø¥Ø²Ø§Ù„Ø© ØµÙ ÙˆØ­Ø¯Ø©
  $("#unitsBox").addEventListener("click",(e)=>{
    if(e.target.classList.contains('rm')){
      const rows=[...document.querySelectorAll('.unit-row')];
      if(rows.length<=1){ // Ø§ØªØ±Ùƒ ØµÙ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„
        rows[0].querySelector('.uName').value='';
        rows[0].querySelector('.uGrams').value='';
      }else{
        e.target.closest('.unit-row').remove();
      }
    }
  });
}

/* ===== Load + Render foods ===== */
async function loadFoods(){
  loading(true);
  foodsAll=[];
  const qs=await getDocs(collection(db,'foods'));
  qs.forEach(s=>{
    const d=s.data();
    foodsAll.push({
      id:s.id,
      name:d.name||'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…',
      category:d.category||'Ø£Ø®Ø±Ù‰',
      carbsPer100g:Number(d.carbsPer100g)||0,
      imageUrl:d.imageUrl||'',
      servingUnits:Array.isArray(d.servingUnits)? d.servingUnits:[],
      isActive:(d.isActive===false? false:true),
      _norm: normalizeArabic((d.name||'')+' '+(d.category||'')+' '+(d.servingUnits||[]).map(u=>u.unit).join(' '))
    });
  });
  loading(false);
}

function buildCats(){
  const set=new Set(['*']);
  foodsAll.forEach(f=>set.add(f.category||'Ø£Ø®Ø±Ù‰'));
  $("#catTotal").textContent = foodsAll.length+' Ø¹Ù†ØµØ±';
  const C=$("#cats"); C.innerHTML='';
  [...set].forEach(cat=>{
    const b=document.createElement('button');
    b.className='cat-btn'+(cat===currentCat?' active':'');
    b.textContent=(cat==='*'?'ÙƒÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù':cat);
    b.addEventListener('click',()=>{
      currentCat=cat;
      [...C.querySelectorAll('.cat-btn')].forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      renderFoods();
    });
    C.appendChild(b);
  });
}

function renderFoods(){
  const q=normalizeArabic($("#q").value);
  filtered=foodsAll.filter(f=>{
    const byCat=(currentCat==='*' || f.category===currentCat);
    const byText= !q || f._norm.includes(q);
    return byCat && byText;
  });
  $("#resultCount").textContent = filtered.length+' Ù†ØªØ§Ø¦Ø¬';

  const TB=$("#foodsBody");
  if(!filtered.length){
    TB.innerHTML='<tr><td colspan="6" class="center note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù Ù…Ø·Ø§Ø¨Ù‚Ø©.</td></tr>';
    return;
  }
  TB.innerHTML = filtered.map(f=>{
    const units = (f.servingUnits||[]).map(u=>`${u.unit} (${toFixed1(u.grams||0)}Ø¬Ù…)`).join(' â€¢ ') || 'â€”';
    const img = f.imageUrl ? `<img src="${escapeHtml(f.imageUrl)}" alt="" style="width:36px;height:36px;object-fit:cover;border-radius:8px;border:1px solid var(--line)">` : 'â€”';
    const st  = f.isActive ? '<span class="badge ok">Ù†Ø´Ø·</span>' : '<span class="badge warn">Ù…Ø¹Ù„Ù‚</span>';
    return `<tr>
      <td><b>${escapeHtml(f.name)}</b></td>
      <td>${escapeHtml(f.category||'â€”')}</td>
      <td>${toFixed1(f.carbsPer100g)}</td>
      <td>${units}</td>
      <td>${img}</td>
      <td>${st}</td>
    </tr>`;
  }).join('');
}

function fillCatsDatalist(){
  const D=$("#catsList"); D.innerHTML='';
  const uniq=Array.from(new Set(foodsAll.map(f=>f.category||'Ø£Ø®Ø±Ù‰'))).sort();
  uniq.forEach(c=>{
    const o=document.createElement('option'); o.value=c; D.appendChild(o);
  });
}

/* ===== Add Food manually ===== */
function addUnitRow(){
  const row=document.createElement('div');
  row.className='unit-row';
  row.innerHTML=`
    <input class="uName" placeholder="Ù…Ø«Ø§Ù„: ÙƒÙˆØ¨ / Ù…Ù„Ø¹Ù‚Ø© ÙƒØ¨ÙŠØ±Ø© / Ø­Ø¨Ø©">
    <input class="uGrams" type="number" min="0" step="0.1" placeholder="Ø¬Ø±Ø§Ù…">
    <button class="rm">ğŸ—‘ï¸</button>`;
  $("#unitsBox").appendChild(row);
}
function quickUnits(){
  const box=$("#unitsBox");
  box.innerHTML='';
  [
    {unit:'Ø¬Ø±Ø§Ù…', grams:100},
    {unit:'ÙƒÙˆØ¨', grams:240},
    {unit:'Ù…Ù„Ø¹Ù‚Ø© ÙƒØ¨ÙŠØ±Ø©', grams:15}
  ].forEach(u=>{
    const row=document.createElement('div');
    row.className='unit-row';
    row.innerHTML=`
      <input class="uName" value="${u.unit}">
      <input class="uGrams" type="number" min="0" step="0.1" value="${u.grams}">
      <button class="rm">ğŸ—‘ï¸</button>`;
    box.appendChild(row);
  });
}
function collectUnits(){
  const rows=[...document.querySelectorAll('.unit-row')];
  const arr=[];
  rows.forEach(r=>{
    const name=r.querySelector('.uName').value.trim();
    const grams=Number(r.querySelector('.uGrams').value);
    if(name==='' && !Number.isFinite(grams)) return;
    if(name!=='' && Number.isFinite(grams) && grams>=0){
      arr.push({unit:name, grams:+(Math.round(grams*10)/10)});
    }
  });
  return arr;
}
async function saveFood(){
  const name=$("#fName").value.trim();
  const category=$("#fCategory").value.trim();
  const carbs=Number($("#fCarbs").value);
  const imageUrl=$("#fImg").value.trim();
  const notes=$("#fNotes").value.trim() || null;
  const units=collectUnits();

  if(!name || !category || !Number.isFinite(carbs) || carbs<0){
    toast('âš ï¸ ØªØ£ÙƒØ¯ÙŠ Ù…Ù†: Ø§Ù„Ø§Ø³Ù… + Ø§Ù„ØªØµÙ†ÙŠÙ + ÙƒØ§Ø±Ø¨/100Ø¬Ù…'); return;
  }
  if(!units.length){
    // Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ ÙˆØ­Ø¯Ø© ÙˆØ§Ø­Ø¯Ø© (Ù†Ø¶ÙŠÙ Ø¬Ø±Ø§Ù… 100 ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§)
    units.push({unit:'Ø¬Ø±Ø§Ù…', grams:100});
  }

  loading(true);
  try{
    await addDoc(collection(db,'foods'),{
      name, category, carbsPer100g:+(Math.round(carbs*10)/10),
      imageUrl: imageUrl || null,
      servingUnits: units,
      isActive: true,
      createdBy: UID,
      createdAt: serverTimestamp(),
      notes
    });
    toast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù');
    // reset
    $("#fName").value=''; $("#fCategory").value=''; $("#fCarbs").value='';
    $("#fImg").value=''; $("#fNotes").value='';
    $("#unitsBox").innerHTML=`
      <div class="unit-row">
        <input class="uName" placeholder="Ù…Ø«Ø§Ù„: Ø¬Ø±Ø§Ù… / ÙƒÙˆØ¨ / Ù…Ù„Ø¹Ù‚Ø© / Ø­Ø¨Ø©">
        <input class="uGrams" type="number" min="0" step="0.1" placeholder="Ø¬Ø±Ø§Ù…">
        <button class="rm">ğŸ—‘ï¸</button>
      </div>`;
    await loadFoods(); buildCats(); renderFoods(); fillCatsDatalist();
  }catch(e){
    console.error(e);
    toast('âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: '+(e.message||e));
  }finally{
    loading(false);
  }
}

/* ===== Import Excel ===== */
async function onPickExcel(e){
  const file=e.target.files && e.target.files[0];
  if(!file){ return; }
  loading(true);
  try{
    const buf=await file.arrayBuffer();
    const wb=XLSX.read(buf,{type:'array'});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(ws, {header:1, defval:''}); // Ù…ØµÙÙˆÙØ© ØµÙÙˆÙ

    // ØªÙˆÙ‚Ø¹ Ø±Ø¤ÙˆØ³ Ø£Ø¹Ù…Ø¯Ø©
    // name, category, carbsPer100g, unit1, grams1, unit2, grams2, unit3, grams3, imageUrl, isActive, notes
    importRows=parseExcel(rows);
    renderImportPreview();
    $("#importBox").style.display='block';
    toast('ğŸ“¥ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù â€” Ø±Ø§Ø¬Ø¹ÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©');
  }catch(err){
    console.error(err);
    toast('âŒ Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ ØµÙŠØºØ© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø©');
  }finally{
    loading(false);
    // reset input Ù„ÙŠØ³Ù…Ø­ Ø¨Ø§Ø®ØªÙŠØ§Ø± Ù†ÙØ³ Ø§Ù„Ù…Ù„Ù Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
    e.target.value='';
  }
}

function parseExcel(rows){
  if(!rows.length) return [];
  // Ø§Ø´Ø·ÙÙŠ ØµÙÙˆÙ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„ÙØ§Ø±ØºØ© Ø¨Ø§Ù„Ø£ÙˆÙ„
  while(rows.length && rows[0].every(c=>String(c).trim()==='')) rows.shift();

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
  const head = rows[0].map(x=>String(x).trim());
  const need = ['name','category','carbsPer100g','unit1','grams1','unit2','grams2','unit3','grams3','imageUrl','isActive','notes'];
  const mapIndex = (name)=> head.findIndex(h=>normalizeArabic(h)===normalizeArabic(name));
  const idx = Object.fromEntries(need.map(n=>[n, mapIndex(n)]));
  if(idx.name<0 || idx.category<0 || idx.carbsPer100g<0){
    // Ù„Ùˆ Ø§Ù„Ø±Ø¤ÙˆØ³ Ù…Ø®ØªÙ„ÙØ©ØŒ Ù‡Ù†Ø¹ØªØ¨Ø± Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø£ÙˆÙ„ Ù‡Ùˆ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ†Ø³ØªØ®Ø¯Ù… ØªØ±ØªÙŠØ¨ Ø£Ø¹Ù…Ø¯Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠ
    // Ù„ÙƒÙ† Ø§Ù„Ø£ÙØ¶Ù„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ù‚Ø§Ù„Ø¨
  }

  const out=[];
  for(let i=1;i<rows.length;i++){
    const r=rows[i]; if(!r || r.length===0) continue;
    // Ø³Ø­Ø¨ Ø§Ù„Ù‚ÙŠÙ… Ø¨Ø£Ù…Ø§Ù†
    const val=(key)=> idx[key]>=0 ? r[idx[key]] : '';
    const name = String(val('name')||'').trim();
    const category = String(val('category')||'').trim();
    const carbs = Number(String(val('carbsPer100g')).toString().replace(',','.'));
    const imageUrl = String(val('imageUrl')||'').trim();
    const activeRaw = String(val('isActive')||'').toLowerCase();
    const isActive = (activeRaw===''? true : ['true','1','yes','y','ØµØ­','ØµØ­ÙŠØ­'].includes(activeRaw));

    // ÙˆØ­Ø¯Ø§Øª
    const units=[];
    for(let k=1;k<=3;k++){
      const u = String(val('unit'+k)||'').trim();
      const g = Number(String(val('grams'+k)||'').toString().replace(',','.'));
      if(u!=='' && Number.isFinite(g) && g>=0){ units.push({unit:u, grams: +(Math.round(g*10)/10)}); }
      else if(u==='' && !Number.isFinite(g)){ /* ØªØ¬Ø§Ù‡Ù„ */ }
      else if(u!=='' || String(val('grams'+k)).trim()!==''){ /*ç‰‡*/ }
    }
    if(!units.length){ units.push({unit:'Ø¬Ø±Ø§Ù…', grams:100}); }

    // Ø§Ù„ØªØ­Ù‚Ù‚
    const errs=[];
    if(!name) errs.push('Ø§Ù„Ø§Ø³Ù… Ù…ÙÙ‚ÙˆØ¯');
    if(!category) errs.push('Ø§Ù„ØªØµÙ†ÙŠÙ Ù…ÙÙ‚ÙˆØ¯');
    if(!Number.isFinite(carbs) || carbs<0) errs.push('Ù‚ÙŠÙ…Ø© ÙƒØ§Ø±Ø¨/100Ø¬Ù… ØºÙŠØ± ØµØ§Ù„Ø­Ø©');
    if(carbs>100) errs.push('Ù‚ÙŠÙ…Ø© ÙƒØ§Ø±Ø¨/100Ø¬Ù… Ù…Ø±ØªÙØ¹Ø© Ø¬Ø¯Ù‹Ø§');

    const warn=[];
    if(imageUrl && !/^https?:\/\//i.test(imageUrl)) warn.push('Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© ØºÙŠØ± ÙˆØ§Ø¶Ø­');

    out.push({
      i:i, name, category, carbsPer100g: +(Math.round((carbs||0)*10)/10),
      servingUnits: units, imageUrl: imageUrl||null,
      isActive, notes: String(val('notes')||'').trim()||null,
      _errs:errs, _warn:warn, _status: errs.length? 'err' : (warn.length? 'warn':'ok')
    });
  }
  return out;
}

function renderImportPreview(){
  const TB=$("#impBody");
  if(!importRows.length){ TB.innerHTML='<tr><td colspan="9" class="center note">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶.</td></tr>'; return; }

  let cOk=0,cWarn=0,cErr=0;
  TB.innerHTML = importRows.map((r,idx)=>{
    if(r._status==='ok') cOk++; else if(r._status==='warn') cWarn++; else cErr++;
    const badge = r._status==='ok' ? '<span class="badge ok">ØµØ§Ù„Ø­</span>'
                 : r._status==='warn' ? '<span class="badge warn">ØªØ­Ø°ÙŠØ±</span>'
                 : '<span class="badge err">Ø®Ø·Ø£</span>';
    const units = r.servingUnits.map(u=>`${escapeHtml(u.unit)} (${toFixed1(u.grams)}Ø¬Ù…)`).join(' â€¢ ');
    return `<tr>
      <td>${idx+1}</td>
      <td>${badge}${r._errs.length?'<div class="small">'+escapeHtml(r._errs.join(' â€¢ '))+'</div>':''}${r._warn.length?'<div class="small">'+escapeHtml(r._warn.join(' â€¢ '))+'</div>':''}</td>
      <td>${escapeHtml(r.name)}</td>
      <td>${escapeHtml(r.category)}</td>
      <td>${toFixed1(r.carbsPer100g)}</td>
      <td>${units || 'â€”'}</td>
      <td>${r.imageUrl? `<a href="${escapeAttr(r.imageUrl)}" target="_blank">Ø±Ø§Ø¨Ø·</a>`:'â€”'}</td>
      <td>${r.isActive? 'âœ“' : 'âœ—'}</td>
      <td>${escapeHtml(r.notes||'â€”')}</td>
    </tr>`;
  }).join('');
  $("#impOk").textContent   = 'ØµØ§Ù„Ø­: '+cOk;
  $("#impWarn").textContent = 'ØªØ­Ø°ÙŠØ±: '+cWarn;
  $("#impErr").textContent  = 'Ø£Ø®Ø·Ø§Ø¡: '+cErr;
  $("#impTotal").textContent= 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: '+importRows.length;
}

async function commitImport(){
  const rows = importRows.filter(r=>r._status!=='err');
  if(!rows.length){ toast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØµÙÙˆÙ ØµØ§Ù„Ø­Ø© Ù„Ù„Ø­ÙØ¸'); return; }

  loading(true);
  try{
    const CHUNK=400; // Ø£Ù‚Ù„ Ù…Ù† Ø­Ø¯ 500
    let saved=0;
    for(let i=0;i<rows.length;i+=CHUNK){
      const part=rows.slice(i,i+CHUNK);
      const batch = writeBatchSafe();
      part.forEach(r=>{
        const ref = doc(collection(db,'foods'));
        batch.set(ref,{
          name:r.name, category:r.category, carbsPer100g:r.carbsPer100g,
          imageUrl:r.imageUrl||null, servingUnits:r.servingUnits,
          isActive: r.isActive, notes:r.notes||null,
          createdBy: UID, createdAt: serverTimestamp()
        });
      });
      await batch.commit();
      saved += part.length;
    }
    toast('âœ… ØªÙ… Ø­ÙØ¸ '+saved+' ØµÙ†Ù');
    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© + Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    importRows=[]; $("#importBox").style.display='none';
    await loadFoods(); buildCats(); renderFoods(); fillCatsDatalist();
  }catch(e){
    console.error(e);
    toast('âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: '+(e.message||e));
  }finally{
    loading(false);
  }
}
function writeBatchSafe(){
  // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ Ù„ØªÙØ§Ø¯ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰
  return new (await import("https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js")).writeBatch(db);
}

/* ===== Utils ===== */
function debounce(fn,ms){ let t=null; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,a),ms); }; }
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
function escapeAttr(s){ return String(s||'').replace(/"/g,'&quot;'); }

</script>
</body>
</html>
