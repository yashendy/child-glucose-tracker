<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</title>
<link rel="stylesheet" href="styles.css">
<style>
.table-foods{width:100%;border-collapse:separate;border-spacing:0}
.table-foods th,.table-foods td{border:1px solid var(--line);padding:8px;text-align:right;vertical-align:top}
.table-foods thead th{background:#f0f9ff;font-weight:800}
.unit-chip{display:inline-block;background:#eef6ff;color:#0369a1;padding:3px 8px;border-radius:999px;margin:2px 4px}
</style>
</head>
<body>
<header class="topbar">
  <a class="btn" href="dashboard.html">Ù„ÙˆØ­Ø© ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±</a>
  <div>ğŸ—‚ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</div>
</header>

<main class="container">
  <section class="card">
    <div class="grid g3">
      <div><label>Ø¨Ø­Ø«</label><input id="q" placeholder="Ø§Ø³Ù…/ØªØµÙ†ÙŠÙâ€¦"></div>
      <div><label>ØªØµÙ†ÙŠÙ</label><input id="cat" placeholder="(Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©)"></div>
      <div class="row" style="align-items:end;justify-content:flex-end">
        <button id="btnNew" class="btn gray">â• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
        <input id="xlsx" type="file" accept=".xlsx,.xls" style="display:none">
        <button id="btnImport" class="btn">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Excel</button>
      </div>
    </div>
  </section>

  <section class="card">
    <table class="table-foods">
      <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ØªØµÙ†ÙŠÙ</th><th>ÙƒØ§Ø±Ø¨/100Ø¬Ù…</th><th>Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
      <tbody id="rows"><tr><td colspan="5" class="note">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</td></tr></tbody>
    </table>
  </section>

  <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ -->
  <section class="card" id="formBox" style="display:none">
    <h4 style="margin:0 0 8px">ØµÙ†Ù</h4>
    <div class="grid g3">
      <div><label>Ø§Ù„Ø§Ø³Ù…</label><input id="fName"></div>
      <div><label>Ø§Ù„ØªØµÙ†ÙŠÙ</label><input id="fCat"></div>
      <div><label>ÙƒØ§Ø±Ø¨/100Ø¬Ù…</label><input id="fCarb" type="number" step="0.1" min="0"></div>
      <div style="grid-column:1/-1">
        <label>Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ© (Ù‚Ø§Ø¦Ù…Ø© JSON)</label>
        <textarea id="fUnits" rows="3" placeholder='[{"unit":"ÙƒÙˆØ¨","grams":240},{"unit":"Ù…Ù„Ø¹Ù‚Ø© ÙƒØ¨ÙŠØ±Ø©","grams":15}]'></textarea>
        <div class="note">Ø§ØªØ±ÙƒÙŠÙ‡Ø§ ÙØ§Ø±ØºØ© Ù„Ùˆ ØºÙŠØ± Ù…ØªØ§Ø­ â€” Ø³ÙŠØªÙ… Ø§ÙØªØ±Ø§Ø¶ (Ø¬Ø±Ø§Ù… 100).</div>
      </div>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button id="btnSave" class="btn primary">ğŸ’¾ Ø­ÙØ¸</button>
      <button id="btnCancel" class="btn gray">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </section>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script type="module">
import { auth, db, ensureAuth } from './firebase-init.js';
import { collection, getDocs, addDoc, doc, getDoc, updateDoc, deleteDoc, orderBy, query } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

await ensureAuth();

const $=s=>document.querySelector(s);
let foods=[], editing=null;

$("#btnNew").addEventListener('click',()=>{ editing=null; showForm(); });
$("#btnCancel").addEventListener('click',()=> $("#formBox").style.display='none');
$("#btnSave").addEventListener('click', saveFood);
$("#q").addEventListener('input', render);
$("#btnImport").addEventListener('click', ()=>$("#xlsx").click());
$("#xlsx").addEventListener('change', importXLSX);

await loadFoods(); render();

async function loadFoods(){
  const qy=query(collection(db,'foods'), orderBy('name','asc'));
  const qs=await getDocs(qy);
  foods=[]; qs.forEach(s=>{
    const d=s.data();
    foods.push({
      id:s.id,
      name:d.name||'',
      category:d.category||'Ø£Ø®Ø±Ù‰',
      carbsPer100g:Number(d.carbsPer100g)||0,
      servingUnits:Array.isArray(d.servingUnits)&&d.servingUnits.length?d.servingUnits:[{unit:'Ø¬Ø±Ø§Ù…',grams:100}],
      isActive: d.isActive!==false
    });
  });
}

function render(){
  const tb=$("#rows"); tb.innerHTML='';
  const q=($("#q").value||'').toLowerCase();
  const filtered=foods.filter(f=>{
    return (!q || f.name.toLowerCase().includes(q) || (f.category||'').toLowerCase().includes(q));
  });
  if(!filtered.length){ tb.innerHTML='<tr><td colspan="5" class="note">Ù„Ø§ Ù†ØªØ§Ø¦Ø¬.</td></tr>'; return; }
  filtered.forEach(f=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${esc(f.name)}</td>
      <td>${esc(f.category)}</td>
      <td>${f.carbsPer100g}</td>
      <td>${f.servingUnits.map(u=>`<span class="unit-chip">${esc(u.unit)} (${u.grams}Ø¬Ù…)</span>`).join('')}</td>
      <td>
        <button class="btn gray" data-act="edit" data-id="${f.id}">âœï¸</button>
        <button class="btn danger" data-act="del" data-id="${f.id}">ğŸ—‘ï¸</button>
      </td>
    `;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button[data-act]').forEach(b=>{
    const id=b.dataset.id, act=b.dataset.act;
    b.addEventListener('click',()=>{ if(act==='edit') editFood(id); else delFood(id); });
  });
}

function showForm(f){
  $("#formBox").style.display='block';
  $("#fName").value=f?.name||'';
  $("#fCat").value=f?.category||($("#cat").value||'');
  $("#fCarb").value=f?.carbsPer100g??'';
  $("#fUnits").value=f?.servingUnits? JSON.stringify(f.servingUnits) : '';
}

async function saveFood(){
  const name=$("#fName").value.trim(); if(!name) return alert('Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù');
  const cat=$("#fCat").value.trim()||'Ø£Ø®Ø±Ù‰';
  const carb=Number($("#fCarb").value)||0;
  let units=[]; const raw=$("#fUnits").value.trim();
  if(raw){ try{ units=JSON.parse(raw); }catch{ return alert('ØµÙŠØºØ© Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©'); } }
  if(!Array.isArray(units) || !units.every(u=>u.unit && Number(u.grams)>0)) return alert('Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† [{unit,grams}]');

  const base={name, category:cat, carbsPer100g:carb, servingUnits:units, isActive:true};
  if(!editing){
    await addDoc(collection(db,'foods'), base);
  }else{
    await updateDoc(doc(db,'foods',editing), base);
  }
  $("#formBox").style.display='none';
  await loadFoods(); render();
  alert('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸');
}

async function editFood(id){
  editing=id;
  const s=await getDoc(doc(db,'foods',id));
  const f=s.data();
  showForm(f);
}

async function delFood(id){
  if(!confirm('Ø­Ø°Ù Ø§Ù„ØµÙ†ÙØŸ')) return;
  await deleteDoc(doc(db,'foods',id));
  await loadFoods(); render();
}

async function importXLSX(e){
  const file=e.target.files?.[0]; if(!file) return;
  const wb=await file.arrayBuffer().then(buf=>window.XLSX.read(buf,{type:'array'}));
  const ws=wb.Sheets[wb.SheetNames[0]];
  const rows=window.XLSX.utils.sheet_to_json(ws,{defval:''});
  // Ø£Ø¹Ù…Ø¯Ø© Ù…ØªÙˆÙ‚Ø¹Ø©: name, category, carbsPer100g, units_json
  // Ù…Ø«Ø§Ù„ units_json: [{"unit":"ÙƒÙˆØ¨","grams":240},{"unit":"Ù…Ù„Ø¹Ù‚Ø© ÙƒØ¨ÙŠØ±Ø©","grams":15}]
  let added=0;
  for(const r of rows){
    if(!r.name) continue;
    let units=[];
    if(r.units_json){ try{ units=JSON.parse(r.units_json); }catch{ units=[]; } }
    if(!Array.isArray(units) || !units.length) units=[{unit:'Ø¬Ø±Ø§Ù…',grams:100}];
    await addDoc(collection(db,'foods'), {
      name:String(r.name), category: r.category||'Ø£Ø®Ø±Ù‰',
      carbsPer100g:Number(r.carbsPer100g)||0,
      servingUnits:units, isActive:true
    });
    added++;
  }
  await loadFoods(); render();
  alert('âœ… ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ '+added+' ØµÙ†Ù/Ø£ØµÙ†Ø§Ù');
}

function esc(s){return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));}
</script>
</body>
</html>
