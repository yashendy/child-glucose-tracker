<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>إدارة الأصناف</title>
  <!-- نفترض أنكِ تستعملين styles.css العامة في المشروع -->
  <link rel="stylesheet" href="styles.css">
  <style>
    /* تحسينات خفيفة إن لم تكن موجودة في styles.css */
    .topbar{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;background:linear-gradient(90deg,#0ea5e9,#6ee7b7);color:#fff}
    .btn{border:none;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
    .btn.gray{background:#eef2f7}
    .btn.primary{background:#0ea5e9;color:#fff}
    .btn.red{background:#fee2e2;color:#b91c1c}
    .container{max-width:1100px;margin:auto;padding:14px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:12px;box-shadow:0 6px 24px rgba(0,0,0,.04);margin-bottom:12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .grid{display:grid;gap:10px}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media(max-width:900px){.g3{grid-template-columns:1fr}.g2{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:#64748b;margin-bottom:4px}
    input,select,textarea{width:100%;padding:9px 10px;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
    .note{color:#64748b;font-size:13px}
    .table{width:100%;border-collapse:separate;border-spacing:0}
    .table th,.table td{border:1px solid #e5e7eb;padding:8px;text-align:right;vertical-align:top}
    .table thead th{background:#f1f5f9;font-weight:800}
    .badge-soft{display:inline-block;background:#eef6ff;color:#0369a1;border-radius:999px;padding:4px 8px;font-weight:800;font-size:12px}
    .chip{display:inline-flex;gap:6px;align-items:center;background:#f1f5f9;border:1px solid #e2e8f0;color:#334155;border-radius:999px;padding:4px 8px;font-weight:700;font-size:12px}
    .mini{width:92px}
    .avatar{width:84px;height:84px;border-radius:50%;object-fit:cover;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.12)}
    .tools .btn{padding:8px 10px}
    .sep{height:1px;background:#e5e7eb;margin:10px 0}
    .tag{display:inline-block;margin:0 4px 4px 0;background:#fff0f0;color:#c2410c;border:1px solid #fecaca;border-radius:999px;padding:2px 8px;font-size:12px}
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .toolbar .row{gap:6px}
  </style>
</head>
<body>

  <!-- بنر الطفل (اختياري) -->
  <div id="childBanner" style="text-align:center; padding:12px 8px; display:none">
    <img id="bannerAvatar" class="avatar" src="images/avatar-default.png" alt="صورة الطفل">
    <div style="margin-top:6px;font-weight:800" id="bannerName">—</div>
    <div class="note" id="bannerMeta">—</div>
  </div>

  <!-- Topbar -->
  <div class="topbar">
    <div>🗂️ إدارة الأصناف</div>
    <div class="row">
      <a id="lnkHome" class="btn gray">الرئيسية</a>
      <button id="btnLogout" class="btn">خروج</button>
    </div>
  </div>

  <main class="container">
    <!-- Nav طفل -->
    <div class="card"><div class="row" id="childNav"></div></div>

    <!-- أدوات أعلى الصفحة -->
    <section class="card">
      <div class="toolbar">
        <div class="row">
          <input id="qText" placeholder="ابحث بالاسم أو #وسم" style="min-width:260px">
          <select id="fltCat">
            <option value="*">جميع التصنيفات</option>
          </select>
          <select id="fltActive" class="mini">
            <option value="all">الكل</option>
            <option value="true">نشط</option>
            <option value="false">غير نشط</option>
          </select>
        </div>
        <div class="row">
          <button id="btnNew" class="btn primary">➕ صنف جديد</button>
          <button id="btnReload" class="btn gray">🔄 تحديث</button>
        </div>
      </div>
    </section>

    <!-- الفورم -->
    <section class="card" id="formBox" style="display:none">
      <h3 style="margin:0 0 8px">بيانات الصنف</h3>
      <div class="grid g3">
        <div>
          <label>الاسم</label>
          <input id="fName">
        </div>
        <div>
          <label>التصنيف</label>
          <input id="fCategory" placeholder="مثلًا: ألبان، بقوليات، فواكه ...">
        </div>
        <div>
          <label>الكارب لكل 100 جم</label>
          <input id="fCarbs100" type="number" step="0.1" min="0">
        </div>

        <div>
          <label>صورة (رابط)</label>
          <input id="fImageUrl" placeholder="https://...">
        </div>
        <div>
          <label>وسوم (افصلي بفاصلة أو مسافة، يمكن استخدام #)</label>
          <input id="fTags" placeholder="#فطور فواكه ، سريع">
        </div>
        <div>
          <label>نشط؟</label>
          <select id="fActive" class="mini">
            <option value="true">نشط</option>
            <option value="false">غير نشط</option>
          </select>
        </div>
      </div>

      <div class="sep"></div>

      <h4 style="margin:0 0 6px">الوحدات المنزلية</h4>
      <div class="note">أضيفي سطور (الوحدة + مكافئها بالجرام). مثال: كوب = 240 جم، ملعقة = 15 جم، حبة = 100 جم…</div>
      <table class="table" style="margin-top:8px">
        <thead><tr><th>الوحدة</th><th>الجرامات</th><th>إجراء</th></tr></thead>
        <tbody id="unitsBody">
          <!-- صفوف ديناميكية -->
        </tbody>
      </table>
      <div class="row" style="justify-content:flex-end;margin-top:8px">
        <button id="btnAddUnit" class="btn gray">➕ إضافة وحدة</button>
      </div>

      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button id="btnSave" class="btn primary">💾 حفظ</button>
        <button id="btnCancel" class="btn gray">إلغاء</button>
      </div>
    </section>

    <!-- الجدول -->
    <section class="card">
      <h3 style="margin:0 0 8px">قائمة أصنافي</h3>
      <table class="table">
        <thead>
          <tr>
            <th>الاسم</th>
            <th>التصنيف</th>
            <th>الكارب/100جم</th>
            <th>الوحدات</th>
            <th>وسوم</th>
            <th>نشط</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="7" class="note">لا توجد بيانات بعد.</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <div id="toast" class="toast"></div>
  <div id="loader" class="loader"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>

  <script type="module">
    import { auth, db, ensureAuth, requireChildIdFromQuery, setChildAvatar } from './firebase-init.js';
    import { signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      collection, getDocs, doc, getDoc, setDoc, addDoc, deleteDoc, serverTimestamp, query, orderBy
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const $=s=>document.querySelector(s);
    const toast=m=>{const t=$("#toast"); t.textContent=m; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),2000);}
    const showLoader=on=>{$("#loader").style.display=on?'flex':'none'}

    let uid=null, childId=null, child=null;
    let editId=null; // null = إضافة
    let allFoods=[]; // customFoods للمستخدم الحالي

    // بناء الـ Nav
    function buildNav(){
      const row=$("#childNav"); row.innerHTML='';
      const pages=[
        ['child-dashboard.html','الرئيسية'],
        ['measures.html','قياسات السكر'],
        ['meals.html','الوجبات'],
        ['doctor-report.html','تقرير الطبيب'],
        ['visits.html','الزيارات الطبية'],
        ['foods-admin.html','إدارة الأصناف']
      ];
      pages.forEach(([h,t])=>{
        const a=document.createElement('a');
        a.className='btn gray';
        a.href=`${h}?child=${encodeURIComponent(childId)}`;
        a.textContent=t;
        row.appendChild(a);
      });
      $("#lnkHome").href=`child-dashboard.html?child=${encodeURIComponent(childId)}`;
    }

    async function loadChild(){
      const s=await getDoc(doc(db,'users',uid,'children',childId));
      child=s.data()||{};
      setChildAvatar($("#bannerAvatar"), child?.name, child?.photoURL);
      $("#bannerName").textContent=child?.name||'—';
      $("#bannerMeta").textContent=`${child?.gender||'—'} • ${child?.weight??'—'} كجم • ${child?.height??'—'} سم`;
      $("#childBanner").style.display='block';
    }

    function clearForm(){
      editId=null;
      $("#fName").value='';
      $("#fCategory").value='';
      $("#fCarbs100").value='';
      $("#fImageUrl").value='';
      $("#fTags").value='';
      $("#fActive").value='true';
      $("#unitsBody").innerHTML='';
      addUnitRow('جرام', 100);
    }

    function addUnitRow(unit='', grams=''){
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td><input class="uName" placeholder="كوب / ملعقة / حبة / جرام" value="${unit}"></td>
        <td><input class="uGrams" type="number" step="0.1" min="0" value="${grams}"></td>
        <td><button class="btn red btnDel">🗑️</button></td>
      `;
      tr.querySelector('.btnDel').addEventListener('click', ()=> tr.remove());
      $("#unitsBody").appendChild(tr);
    }

    function unitsFromTable(){
      const rows=[...document.querySelectorAll('#unitsBody tr')];
      return rows.map(r=>{
        const unit=r.querySelector('.uName').value.trim();
        const grams=parseFloat(r.querySelector('.uGrams').value);
        return unit && grams>0 ? {unit, grams} : null;
      }).filter(Boolean);
    }

    function parseTags(raw){
      // تقبّل #tag أو tag عادي؛ نفصل بمسافة/فاصلة
      const arr = (raw||'').split(/[\s,،]+/).map(t=>t.trim()).filter(Boolean);
      return Array.from(new Set(arr.map(t=>t.startsWith('#')? t.toLowerCase() : ('#'+t.toLowerCase()))));
    }

    function foodMatches(f, qText, cat, activeVal){
      const name=(f.name||'').toLowerCase();
      const tags=Array.isArray(f.tags)? f.tags : [];
      const catOk = cat==='*' || f.category===cat;
      const actOk = activeVal==='all' || String(Boolean(f.isActive))===activeVal;

      if(!qText) return catOk && actOk;
      const q=qText.toLowerCase();
      if(q.startsWith('#')){
        return catOk && actOk && tags.some(t=>t.toLowerCase()===q);
      }
      return catOk && actOk && (name.includes(q) || tags.some(t=>t.includes(q)));
    }

    function fillCategoryFilter(){
      const set=new Set();
      allFoods.forEach(f=>{ if(f.category) set.add(f.category); });
      const sel=$("#fltCat"); sel.innerHTML='<option value="*">جميع التصنيفات</option>';
      [...set].sort().forEach(c=>{
        const o=document.createElement('option');
        o.value=c; o.textContent=c;
        sel.appendChild(o);
      });
    }

    function summarizeUnits(units){
      if(!Array.isArray(units)||!units.length) return '—';
      return units.map(u=>`${u.unit} (${u.grams}جم)`).join('، ');
    }

    function renderList(){
      const tbody=$("#rows");
      const q=$("#qText").value.trim();
      const cat=$("#fltCat").value;
      const act=$("#fltActive").value;
      const list=allFoods.filter(f=>foodMatches(f,q,cat,act));

      if(!list.length){ tbody.innerHTML='<tr><td colspan="7" class="note">لا توجد أصناف مطابقة.</td></tr>'; return; }

      tbody.innerHTML='';
      list.forEach(f=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td><b>${escapeHTML(f.name||'—')}</b></td>
          <td>${escapeHTML(f.category||'—')}</td>
          <td>${Number(f.carbsPer100g||0).toFixed(1)}</td>
          <td>${escapeHTML(summarizeUnits(f.servingUnits))}</td>
          <td>${Array.isArray(f.tags)&&f.tags.length? f.tags.map(t=>`<span class="tag">${escapeHTML(t)}</span>`).join(' ') : '—'}</td>
          <td>${f.isActive? '✅' : '⛔'}</td>
          <td class="tools">
            <button class="btn gray" data-act="edit">✏️ تعديل</button>
            <button class="btn red"  data-act="del">🗑️ حذف</button>
          </td>
        `;
        // handlers
        tr.querySelector('[data-act="edit"]').addEventListener('click', ()=>loadIntoForm(f));
        tr.querySelector('[data-act="del"]').addEventListener('click', async()=>{
          if(!confirm('حذف الصنف؟')) return;
          await deleteDoc(doc(db,'users',uid,'customFoods',f.id));
          toast('تم الحذف ✅'); await fetchAll();
        });
        tbody.appendChild(tr);
      });
    }

    function loadIntoForm(f){
      editId = f.id;
      $("#formBox").style.display='block';
      $("#fName").value=f.name||'';
      $("#fCategory").value=f.category||'';
      $("#fCarbs100").value=f.carbsPer100g!=null? f.carbsPer100g : '';
      $("#fImageUrl").value=f.imageUrl||'';
      $("#fTags").value = Array.isArray(f.tags)? f.tags.join(' ') : '';
      $("#fActive").value = String(Boolean(f.isActive));
      $("#unitsBody").innerHTML='';
      const units = Array.isArray(f.servingUnits)&&f.servingUnits.length? f.servingUnits : [{unit:'جرام',grams:100}];
      units.forEach(u=> addUnitRow(u.unit, u.grams));
      window.scrollTo({top:0,behavior:'smooth'});
    }

    async function fetchAll(){
      showLoader(true);
      const qs = await getDocs(query(collection(db,'users',uid,'customFoods'), orderBy('name')));
      allFoods = [];
      qs.forEach(s=>{
        const d=s.data()||{};
        allFoods.push({
          id:s.id,
          name:d.name||'',
          category:d.category||'',
          carbsPer100g: Number(d.carbsPer100g)||0,
          imageUrl:d.imageUrl||'',
          tags: Array.isArray(d.tags)? d.tags : [],
          servingUnits: Array.isArray(d.servingUnits)? d.servingUnits : [],
          isActive: (d.isActive!==false)
        });
      });
      fillCategoryFilter();
      renderList();
      showLoader(false);
    }

    function escapeHTML(str){return String(str||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]))}

    // حفظ الصنف
    async function saveFood(){
      const item={
        name: $("#fName").value.trim(),
        category: $("#fCategory").value.trim() || 'أخرى',
        carbsPer100g: parseFloat($("#fCarbs100").value)||0,
        imageUrl: $("#fImageUrl").value.trim()||'',
        tags: parseTags($("#fTags").value),
        servingUnits: unitsFromTable(),
        isActive: $("#fActive").value==='true',
        updatedAt: serverTimestamp()
      };
      if(!item.name){ toast('أدخلي اسم الصنف'); return; }
      if(!item.servingUnits.length){ toast('أضيفي وحدة منزلية واحدة على الأقل'); return; }

      if(editId){
        await setDoc(doc(db,'users',uid,'customFoods',editId), item, {merge:true});
        toast('تم التحديث ✅');
      }else{
        await addDoc(collection(db,'users',uid,'customFoods'), {
          ...item, createdAt: serverTimestamp()
        });
        toast('تمت الإضافة ✅');
      }
      $("#formBox").style.display='none';
      await fetchAll();
    }

    // أحداث UI
    $("#btnNew").addEventListener('click', ()=>{ $("#formBox").style.display='block'; clearForm(); });
    $("#btnCancel").addEventListener('click', ()=>{ $("#formBox").style.display='none'; clearForm(); });
    $("#btnAddUnit").addEventListener('click', ()=> addUnitRow('', ''));
    $("#btnSave").addEventListener('click', saveFood);
    $("#btnReload").addEventListener('click', fetchAll);
    $("#qText").addEventListener('input', renderList);
    $("#fltCat").addEventListener('change', renderList);
    $("#fltActive").addEventListener('change', renderList);

    // Boot
    (async function(){
      const {uid:U}=await ensureAuth(); uid=U;
      childId = requireChildIdFromQuery();   // موجودة في firebase-init.js
      buildNav();
      await loadChild();
      await fetchAll();
      $("#btnLogout").addEventListener('click', ()=>signOut(auth).then(()=>location.href='index.html'));
    })();
  </script>
</body>
</html>
