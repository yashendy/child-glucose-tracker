<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</title>
<style>
:root{--brand:#0ea5e9;--line:#e5e7eb;--ink:#0f172a;--muted:#64748b;--bg:#f6fbff;--card:#fff}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.6 system-ui,"Tajawal","Noto Sans Arabic",sans-serif}
.container{max-width:1100px;margin:auto;padding:14px}
.topbar{position:sticky;top:0;background:linear-gradient(90deg,#0ea5e9,#6ee7b7);color:#fff;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;z-index:5}
.btn{border:none;border-radius:10px;padding:9px 12px;font-weight:800;cursor:pointer}
.btn.primary{background:var(--brand);color:#fff} .btn.gray{background:#eef2f7}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:0 6px 24px rgba(0,0,0,.04);margin-bottom:12px}
.grid{display:grid;gap:10px}.g3{grid-template-columns:repeat(3,minmax(0,1fr))}.g2{grid-template-columns:repeat(2,minmax(0,1fr))}
@media(max-width:900px){.g3,.g2{grid-template-columns:1fr}}
input,select,textarea{width:100%;padding:9px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}
.small{color:#64748b;font-size:12px}
.table{width:100%;border-collapse:separate;border-spacing:0}
.table th,.table td{border:1px solid var(--line);padding:8px;text-align:right}
.table thead th{background:#f1f5f9;font-weight:800}
.badge{display:inline-block;background:#eef6ff;color:#0369a1;border-radius:999px;padding:4px 8px;font-weight:800;font-size:12px}
</style>
</head>
<body>

<div class="topbar">
  <div>ğŸ—‚ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</div>
  <div>
    <a id="backMeals" class="btn gray">Ø§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ¬Ø¨Ø§Øª</a>
  </div>
</div>

<main class="container">
  <section class="card">
    <h3 style="margin:0 0 8px">â• Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ ØµÙ†Ù</h3>
    <div class="grid g3">
      <div><label>Ø§Ù„Ø§Ø³Ù…</label><input id="fName"></div>
      <div><label>Ø§Ù„ØªØµÙ†ÙŠÙ</label><input id="fCat" placeholder="Ù…Ø«Ø§Ù„: ÙØ§ÙƒÙ‡Ø© / Ø­Ø¨ÙˆØ¨"></div>
      <div><label>Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (ØµØºÙŠØ±)</label><input id="fImg" placeholder="https://...png"></div>

      <div><label>ÙƒØ§Ø±Ø¨/100Ø¬Ù…</label><input id="fCarb" type="number" step="0.1"></div>
      <div><label>Ø¨Ø±ÙˆØªÙŠÙ†/100Ø¬Ù…</label><input id="fProt" type="number" step="0.1"></div>
      <div><label>Ø¯Ù‡ÙˆÙ†/100Ø¬Ù…</label><input id="fFat" type="number" step="0.1"></div>

      <div><label>Ø³Ø¹Ø±Ø§Øª/100Ø¬Ù…</label><input id="fKcal" type="number" step="1"></div>
      <div><label>ÙˆØ³ÙˆÙ… (Ù‡Ø§Ø´ØªØ§Ø¬ Ø£Ùˆ ÙØ§ØµÙ„Ø©)</label><input id="fTags" placeholder="#ÙØ·ÙˆØ±, #Ø­Ù„Ùˆ"></div>
      <div><label>Ù†Ø´Ø·ØŸ</label>
        <select id="fActive"><option value="1">Ù†Ø¹Ù…</option><option value="0">Ù„Ø§</option></select>
      </div>
    </div>

    <div class="small" style="margin:6px 0">
      ğŸ’¡ Ø§Ù„Ø³Ø¹Ø±Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠØ© = (ÙƒØ§Ø±Ø¨Ã—4) + (Ø¨Ø±ÙˆØªÙŠÙ†Ã—4) + (Ø¯Ù‡ÙˆÙ†Ã—9). 
      <button id="btnCalcKcal" class="btn gray" type="button">Ø­Ø³Ø§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
    </div>

    <h4 style="margin:8px 0 6px">ğŸ“ ÙˆØ­Ø¯Ø§Øª Ù…Ù†Ø²Ù„ÙŠØ©</h4>
    <div id="unitsBox" class="grid g2"></div>
    <div><button id="btnAddUnit" class="btn gray" type="button">â• Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø¯Ø©</button></div>

    <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
      <button id="btnSave" class="btn primary">ğŸ’¾ Ø­ÙØ¸</button>
      <button id="btnReset" class="btn gray" type="button">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
    </div>
  </section>

  <section class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">ğŸ“‹ Ø§Ù„Ø£ØµÙ†Ø§Ù</h3>
      <input id="q" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…/Ø§Ù„ÙˆØ³Ù…" style="width:260px">
    </div>
    <table class="table" style="margin-top:8px">
      <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>ØªØµÙ†ÙŠÙ</th><th>Ùƒ/Ø¨/Ø¯</th><th>Ø³Ø¹Ø±Ø§Øª</th><th>ÙˆØ­Ø¯Ø§Øª</th><th>ÙˆØ³ÙˆÙ…</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
      <tbody id="rows"><tr><td colspan="7" class="small">ØªØ­Ù…ÙŠÙ„...</td></tr></tbody>
    </table>
  </section>
</main>

<script type="module">
import { db } from './firebase-init.js';
import { collection, getDocs, doc, setDoc, updateDoc, deleteDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const $=s=>document.querySelector(s);
const childId = new URL(location.href).searchParams.get('child');
$('#backMeals').href = `meals.html?child=${encodeURIComponent(childId||'')}`;

let editId=null, foods=[];

function addUnitRow(name='', grams=''){
  const wrap=document.createElement('div');
  wrap.innerHTML = `
    <div class="row" style="align-items:center">
      <input class="uName" placeholder="Ø§Ù„ÙˆØ­Ø¯Ø© (ÙƒÙˆØ¨/Ù…Ù„Ø¹Ù‚Ø©/Ø­Ø¨Ø©â€¦)" value="${name}">
      <input class="uGrams" type="number" step="0.1" placeholder="Ø¬Ø±Ø§Ù…" value="${grams}">
      <button class="btn gray rm" type="button">ğŸ—‘ï¸</button>
    </div>`;
  wrap.querySelector('.rm').onclick=()=>wrap.remove();
  $('#unitsBox').appendChild(wrap);
}
$('#btnAddUnit').onclick=()=>addUnitRow();

$('#btnCalcKcal').onclick=()=>{
  const c=+($('#fCarb').value||0), p=+($('#fProt').value||0), f=+($('#fFat').value||0);
  $('#fKcal').value = Math.round(c*4 + p*4 + f*9);
};
$('#btnReset').onclick=()=>{ editId=null; document.querySelectorAll('input').forEach(i=>{ if(i.id!=='q') i.value='';}); $('#unitsBox').innerHTML=''; addUnitRow(); };

$('#btnSave').onclick = async ()=>{
  const name=$('#fName').value.trim(); if(!name) return alert('Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„Ø§Ø³Ù…');
  const item={
    name,
    category: $('#fCat').value.trim() || 'Ø£Ø®Ø±Ù‰',
    imageUrl: $('#fImg').value.trim() || '',
    carbsPer100g: +($('#fCarb').value||0),
    proteinPer100g: +($('#fProt').value||0),
    fatPer100g: +($('#fFat').value||0),
    kcalPer100g: +($('#fKcal').value||0),
    tags: parseTags($('#fTags').value||''),
    isActive: $('#fActive').value==='1',
    servingUnits: collectUnits(),
    updatedAt: serverTimestamp()
  };
  if(!item.servingUnits.length) item.servingUnits=[{unit:'Ø¬Ø±Ø§Ù…',grams:1}];

  if(editId){
    await updateDoc(doc(db,'foods',editId), item);
  }else{
    const id = String(Date.now());
    await setDoc(doc(db,'foods',id), { ...item, createdAt: serverTimestamp() });
  }
  alert('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸');
  await loadFoods();
  $('#btnReset').click();
};

function parseTags(txt){
  return txt.split(/[,#\s]+/).map(s=>s.trim()).filter(Boolean);
}
function collectUnits(){
  const arr=[];
  $('#unitsBox').querySelectorAll('.row').forEach(r=>{
    const n=r.querySelector('.uName').value.trim();
    const g=+(r.querySelector('.uGrams').value||0);
    if(n && g>0) arr.push({unit:n, grams:g});
  });
  return arr;
}

async function loadFoods(){
  foods=[]; const qs=await getDocs(collection(db,'foods'));
  qs.forEach(s=>foods.push({id:s.id,...(s.data()||{})}));
  renderRows();
}
function renderRows(){
  const tbody=$('#rows'); const q=($('#q').value||'').toLowerCase().trim();
  const list=foods.filter(f=> !q || (f.name||'').toLowerCase().includes(q) || (Array.isArray(f.tags)&&f.tags.some(t=>String(t).toLowerCase().includes(q))));
  if(!list.length){ tbody.innerHTML='<tr><td colspan="7" class="small">Ù„Ø§ Ù†ØªØ§Ø¦Ø¬.</td></tr>'; return; }
  tbody.innerHTML = list.map(f=>{
    const units=(f.servingUnits||[]).map(u=>`${u.unit}(${u.grams}Ø¬Ù…)`).join('ØŒ ');
    const kbd=`${+f.carbsPer100g||0}/${+f.proteinPer100g||0}/${+f.fatPer100g||0}`;
    const tags=(Array.isArray(f.tags)?f.tags:[]).map(t=>`<span class="badge">#${t}</span>`).join(' ');
    return `<tr>
      <td>${escapeHTML(f.name)}</td>
      <td>${escapeHTML(f.category||'â€”')}</td>
      <td>${kbd}</td>
      <td>${+f.kcalPer100g||0}</td>
      <td>${units||'â€”'}</td>
      <td>${tags||'â€”'}</td>
      <td>
        <button class="btn gray" data-act="edit" data-id="${f.id}">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn gray" data-act="del" data-id="${f.id}">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      </td>
    </tr>`;
  }).join('');

  tbody.querySelectorAll('button[data-act]').forEach(btn=>{
    const id=btn.dataset.id, act=btn.dataset.act;
    btn.onclick = async ()=>{
      if(act==='edit'){
        editId=id;
        const f=foods.find(x=>x.id===id); if(!f) return;
        $('#fName').value=f.name||''; $('#fCat').value=f.category||''; $('#fImg').value=f.imageUrl||'';
        $('#fCarb').value=f.carbsPer100g||''; $('#fProt').value=f.proteinPer100g||''; $('#fFat').value=f.fatPer100g||'';
        $('#fKcal').value=f.kcalPer100g||''; $('#fTags').value=(Array.isArray(f.tags)?f.tags.join(', '):'');
        $('#fActive').value=f.isActive===false?'0':'1';
        $('#unitsBox').innerHTML=''; (f.servingUnits||[]).forEach(u=>addUnitRow(u.unit,u.grams));
        if(!(f.servingUnits||[]).length) addUnitRow();
        window.scrollTo({top:0,behavior:'smooth'});
      }else if(act==='del'){
        if(confirm('Ø­Ø°Ù Ø§Ù„ØµÙ†ÙØŸ')){ await deleteDoc(doc(db,'foods',id)); await loadFoods(); }
      }
    };
  });
}
const escapeHTML=s=>String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));

$('#q').addEventListener('input', renderRows);
await loadFoods();
</script>
</body>
</html>
