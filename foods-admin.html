<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>إدارة الأصناف</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .units{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .unit{display:flex;gap:6px;align-items:center;border:1px dashed #cbd5e1;padding:6px;border-radius:8px}
    .list{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
    .item{border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff}
    .item h4{margin:0 0 6px}
    .small{font-size:12px;color:#6b7280}
    .tag{display:inline-block;background:#eef6ff;color:#0369a1;border-radius:999px;padding:3px 8px;margin:2px;font-size:12px}
  </style>
</head>
<body>
  <div class="topbar">
    <div>🗂️ إدارة الأصناف</div>
    <div class="row">
      <a href="dashboard.html" class="btn gray">لوحة ولي الأمر</a>
      <button id="btnLogout" class="btn">خروج</button>
    </div>
  </div>

  <main class="container">
    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">إضافة/تعديل صنف</h3>
        <div class="row">
          <input id="search" placeholder="ابحث… أو #وسم" />
          <button id="btnReload" class="btn">تحديث</button>
        </div>
      </div>

      <div class="grid g3" style="margin-top:8px">
        <div><label>الاسم</label><input id="fName"></div>
        <div><label>التصنيف</label><input id="fCat" placeholder="ألبان/بقوليات…"></div>
        <div><label>صورة (رابط)</label><input id="fImg" placeholder="https://..."></div>

        <div><label>كارب/100جم</label><input id="fCarb" type="number" step="0.1" min="0" max="100"></div>
        <div><label>سعرات/100جم</label><input id="fCal" type="number" step="1" min="0"></div>
        <div><label>دهون/100جم</label><input id="fFat" type="number" step="0.1" min="0"></div>
        <div><label>بروتين/100جم</label><input id="fProt" type="number" step="0.1" min="0"></div>

        <div style="grid-column:1/-1">
          <label>وحدات التقديم</label>
          <div id="units" class="units"></div>
          <div class="row">
            <input id="uTitle" placeholder="كوب/ملعقة/حبة" style="width:200px">
            <input id="uGrams" type="number" step="1" min="1" placeholder="جرام" style="width:120px">
            <button id="uAdd" class="btn">➕ إضافة وحدة</button>
          </div>
        </div>

        <div style="grid-column:1/-1">
          <label>وسوم (افصليها بمسافة - ستُستخدم في البحث مع #)</label>
          <input id="fTags" placeholder="لبن #خالي_اللاكتوز #عضوي …">
        </div>

        <div class="row" style="grid-column:1/-1;justify-content:flex-end">
          <button id="btnNew" class="btn gray">جديد</button>
          <button id="btnSave" class="btn primary">💾 حفظ</button>
        </div>
      </div>
    </section>

    <section class="card">
      <h3 style="margin:0 0 6px">الأصناف</h3>
      <div id="list" class="list"><div class="note">جاري التحميل…</div></div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <script type="module">
    import { auth, db, ensureAuth } from './firebase-init.js';
    import { signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { collection, getDocs, addDoc, doc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const $=s=>document.querySelector(s);
    const toast=(m)=>{const t=$("#toast");t.textContent=m;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),2000)}

    let uid=null, items=[], editId=null, units=[];

    (async function(){
      await ensureAuth().then(u=>uid=u.uid);
      await load();
      $("#btnLogout").addEventListener('click', ()=>signOut(auth).then(()=>location.href='index.html'));
      $("#btnReload").addEventListener('click', load);
      $("#btnNew").addEventListener('click', ()=>{ editId=null; fillForm(); });
      $("#btnSave").addEventListener('click', save);
      $("#uAdd").addEventListener('click', addUnit);
      $("#search").addEventListener('input', render);
    })();

    async function load(){
      const qs=await getDocs(collection(db,'foods'));
      items=[];
      qs.forEach(s=>{
        const d=s.data()||{};
        items.push({
          id:s.id, name:d.name||'', category:d.category||'',
          carbsPer100g:Number(d.carbsPer100g)||0,
          calories:Number(d.calories)||0, fat:Number(d.fat)||0, protein:Number(d.protein)||0,
          imageUrl:d.imageUrl||'', servingUnits:Array.isArray(d.servingUnits)?d.servingUnits:[],
          tags:Array.isArray(d.tags)? d.tags.map(x=>String(x)):[],
          isActive: d.isActive!==false
        })
      });
      render();
    }

    function render(){
      const q=$("#search").value.trim();
      const parts=q.split(/\s+/).filter(Boolean);
      const tags=parts.filter(w=>w.startsWith('#')).map(w=>w.slice(1).toLowerCase());
      const text=parts.filter(w=>!w.startsWith('#')).join(' ').toLowerCase();

      const list=$("#list"); list.innerHTML='';
      const filtered=items.filter(f=>{
        const byText = !text || f.name.toLowerCase().includes(text) || f.category.toLowerCase().includes(text);
        const byTags = !tags.length || tags.every(t=> (f.tags||[]).map(x=>x.toLowerCase()).includes(t));
        return byText && byTags;
      });

      if(!filtered.length){ list.innerHTML='<div class="note">لا شيء</div>'; return; }

      filtered.forEach(it=>{
        const div=document.createElement('div'); div.className='item';
        div.innerHTML=`
          <h4>${escapeHTML(it.name)}</h4>
          <div class="small">${escapeHTML(it.category)} • ك:${it.carbsPer100g} • د:${it.fat} • ب:${it.protein}</div>
          <div class="small">${(it.tags||[]).map(t=>`<span class="tag">#${escapeHTML(t)}</span>`).join(' ')||''}</div>
          <div class="row" style="margin-top:6px;justify-content:space-between">
            <div class="small">${it.servingUnits?.map(u=>`${escapeHTML(u.unit)}(${u.grams}جم)`).join('، ')||'—'}</div>
            <div>
              <button class="btn" data-id="${it.id}">تعديل</button>
            </div>
          </div>
        `;
        div.querySelector('button').addEventListener('click', ()=>{ editId=it.id; fillForm(it); });
        list.appendChild(div);
      });
    }

    function fillForm(it={}){
      $("#fName").value=it.name||'';
      $("#fCat").value=it.category||'';
      $("#fImg").value=it.imageUrl||'';
      $("#fCarb").value=it.carbsPer100g??'';
      $("#fCal").value=it.calories??'';
      $("#fFat").value=it.fat??'';
      $("#fProt").value=it.protein??'';
      $("#fTags").value=(it.tags||[]).join(' ');
      units = (it.servingUnits||[]).map(u=>({unit:u.unit, grams:Number(u.grams)}));
      renderUnits();
    }

    function renderUnits(){
      const box=$("#units"); box.innerHTML='';
      if(!units.length){ box.innerHTML='<div class="small">لا توجد وحدات</div>'; return; }
      units.forEach((u,i)=>{
        const chip=document.createElement('div'); chip.className='unit';
        chip.innerHTML=`<span>${escapeHTML(u.unit)} (${u.grams}جم)</span> <button class="btn">✖</button>`;
        chip.querySelector('button').addEventListener('click', ()=>{ units.splice(i,1); renderUnits(); });
        box.appendChild(chip);
      });
    }
    function addUnit(){
      const t=$("#uTitle").value.trim(); const g=Number($("#uGrams").value)||0;
      if(!t || !(g>0)) return toast('أدخلي وحدة صحيحة');
      units.push({unit:t, grams:g}); $("#uTitle").value=''; $("#uGrams").value=''; renderUnits();
    }

    async function save(){
      const payload={
        name: $("#fName").value.trim(),
        category: $("#fCat").value.trim(),
        imageUrl: $("#fImg").value.trim()||null,
        carbsPer100g: Number($("#fCarb").value)||0,
        calories: Number($("#fCal").value)||0,
        fat: Number($("#fFat").value)||0,
        protein: Number($("#fProt").value)||0,
        servingUnits: units,
        tags: ($("#fTags").value||'').split(/\s+/).filter(Boolean),
        isActive:true,
        updatedAt: new Date().toISOString()
      };
      if(!payload.name) return toast('الاسم مطلوب');
      if(editId){
        await setDoc(doc(db,'foods',editId), payload, {merge:true});
      }else{
        payload.createdAt = new Date().toISOString();
        await addDoc(collection(db,'foods'), payload);
      }
      toast('✅ تم الحفظ'); editId=null; await load(); fillForm();
    }

    function escapeHTML(s){return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]))}
  </script>
</body>
</html>
