<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>إدارة الأصناف</title>
<link rel="stylesheet" href="styles.css">
<style>
.table-foods{width:100%;border-collapse:separate;border-spacing:0}
.table-foods th,.table-foods td{border:1px solid var(--line);padding:8px;text-align:right;vertical-align:top}
.table-foods thead th{background:#f0f9ff;font-weight:800}
.unit-chip{display:inline-block;background:#eef6ff;color:#0369a1;padding:3px 8px;border-radius:999px;margin:2px 4px}
</style>
</head>
<body>
<header class="topbar">
  <a class="btn" href="dashboard.html">لوحة وليّ الأمر</a>
  <div>🗂️ إدارة الأصناف</div>
</header>

<main class="container">
  <section class="card">
    <div class="grid g3">
      <div><label>بحث</label><input id="q" placeholder="اسم/تصنيف…"></div>
      <div><label>تصنيف</label><input id="cat" placeholder="(اختياري عند الإضافة)"></div>
      <div class="row" style="align-items:end;justify-content:flex-end">
        <button id="btnNew" class="btn gray">➕ إضافة صنف</button>
        <input id="xlsx" type="file" accept=".xlsx,.xls" style="display:none">
        <button id="btnImport" class="btn">⬆️ استيراد Excel</button>
      </div>
    </div>
  </section>

  <section class="card">
    <table class="table-foods">
      <thead><tr><th>الاسم</th><th>التصنيف</th><th>كارب/100جم</th><th>الوحدات المنزلية</th><th>إجراء</th></tr></thead>
      <tbody id="rows"><tr><td colspan="5" class="note">جاري التحميل…</td></tr></tbody>
    </table>
  </section>

  <!-- نموذج إضافة/تعديل -->
  <section class="card" id="formBox" style="display:none">
    <h4 style="margin:0 0 8px">صنف</h4>
    <div class="grid g3">
      <div><label>الاسم</label><input id="fName"></div>
      <div><label>التصنيف</label><input id="fCat"></div>
      <div><label>كارب/100جم</label><input id="fCarb" type="number" step="0.1" min="0"></div>
      <div style="grid-column:1/-1">
        <label>الوحدات المنزلية (قائمة JSON)</label>
        <textarea id="fUnits" rows="3" placeholder='[{"unit":"كوب","grams":240},{"unit":"ملعقة كبيرة","grams":15}]'></textarea>
        <div class="note">اتركيها فارغة لو غير متاح — سيتم افتراض (جرام 100).</div>
      </div>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button id="btnSave" class="btn primary">💾 حفظ</button>
      <button id="btnCancel" class="btn gray">إلغاء</button>
    </div>
  </section>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script type="module">
import { auth, db, ensureAuth } from './firebase-init.js';
import { collection, getDocs, addDoc, doc, getDoc, updateDoc, deleteDoc, orderBy, query } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

await ensureAuth();

const $=s=>document.querySelector(s);
let foods=[], editing=null;

$("#btnNew").addEventListener('click',()=>{ editing=null; showForm(); });
$("#btnCancel").addEventListener('click',()=> $("#formBox").style.display='none');
$("#btnSave").addEventListener('click', saveFood);
$("#q").addEventListener('input', render);
$("#btnImport").addEventListener('click', ()=>$("#xlsx").click());
$("#xlsx").addEventListener('change', importXLSX);

await loadFoods(); render();

async function loadFoods(){
  const qy=query(collection(db,'foods'), orderBy('name','asc'));
  const qs=await getDocs(qy);
  foods=[]; qs.forEach(s=>{
    const d=s.data();
    foods.push({
      id:s.id,
      name:d.name||'',
      category:d.category||'أخرى',
      carbsPer100g:Number(d.carbsPer100g)||0,
      servingUnits:Array.isArray(d.servingUnits)&&d.servingUnits.length?d.servingUnits:[{unit:'جرام',grams:100}],
      isActive: d.isActive!==false
    });
  });
}

function render(){
  const tb=$("#rows"); tb.innerHTML='';
  const q=($("#q").value||'').toLowerCase();
  const filtered=foods.filter(f=>{
    return (!q || f.name.toLowerCase().includes(q) || (f.category||'').toLowerCase().includes(q));
  });
  if(!filtered.length){ tb.innerHTML='<tr><td colspan="5" class="note">لا نتائج.</td></tr>'; return; }
  filtered.forEach(f=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${esc(f.name)}</td>
      <td>${esc(f.category)}</td>
      <td>${f.carbsPer100g}</td>
      <td>${f.servingUnits.map(u=>`<span class="unit-chip">${esc(u.unit)} (${u.grams}جم)</span>`).join('')}</td>
      <td>
        <button class="btn gray" data-act="edit" data-id="${f.id}">✏️</button>
        <button class="btn danger" data-act="del" data-id="${f.id}">🗑️</button>
      </td>
    `;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button[data-act]').forEach(b=>{
    const id=b.dataset.id, act=b.dataset.act;
    b.addEventListener('click',()=>{ if(act==='edit') editFood(id); else delFood(id); });
  });
}

function showForm(f){
  $("#formBox").style.display='block';
  $("#fName").value=f?.name||'';
  $("#fCat").value=f?.category||($("#cat").value||'');
  $("#fCarb").value=f?.carbsPer100g??'';
  $("#fUnits").value=f?.servingUnits? JSON.stringify(f.servingUnits) : '';
}

async function saveFood(){
  const name=$("#fName").value.trim(); if(!name) return alert('اكتبي اسم الصنف');
  const cat=$("#fCat").value.trim()||'أخرى';
  const carb=Number($("#fCarb").value)||0;
  let units=[]; const raw=$("#fUnits").value.trim();
  if(raw){ try{ units=JSON.parse(raw); }catch{ return alert('صيغة الوحدات المنزلية غير صحيحة'); } }
  if(!Array.isArray(units) || !units.every(u=>u.unit && Number(u.grams)>0)) return alert('الوحدات يجب أن تكون [{unit,grams}]');

  const base={name, category:cat, carbsPer100g:carb, servingUnits:units, isActive:true};
  if(!editing){
    await addDoc(collection(db,'foods'), base);
  }else{
    await updateDoc(doc(db,'foods',editing), base);
  }
  $("#formBox").style.display='none';
  await loadFoods(); render();
  alert('✅ تم الحفظ');
}

async function editFood(id){
  editing=id;
  const s=await getDoc(doc(db,'foods',id));
  const f=s.data();
  showForm(f);
}

async function delFood(id){
  if(!confirm('حذف الصنف؟')) return;
  await deleteDoc(doc(db,'foods',id));
  await loadFoods(); render();
}

async function importXLSX(e){
  const file=e.target.files?.[0]; if(!file) return;
  const wb=await file.arrayBuffer().then(buf=>window.XLSX.read(buf,{type:'array'}));
  const ws=wb.Sheets[wb.SheetNames[0]];
  const rows=window.XLSX.utils.sheet_to_json(ws,{defval:''});
  // أعمدة متوقعة: name, category, carbsPer100g, units_json
  // مثال units_json: [{"unit":"كوب","grams":240},{"unit":"ملعقة كبيرة","grams":15}]
  let added=0;
  for(const r of rows){
    if(!r.name) continue;
    let units=[];
    if(r.units_json){ try{ units=JSON.parse(r.units_json); }catch{ units=[]; } }
    if(!Array.isArray(units) || !units.length) units=[{unit:'جرام',grams:100}];
    await addDoc(collection(db,'foods'), {
      name:String(r.name), category: r.category||'أخرى',
      carbsPer100g:Number(r.carbsPer100g)||0,
      servingUnits:units, isActive:true
    });
    added++;
  }
  await loadFoods(); render();
  alert('✅ تم استيراد '+added+' صنف/أصناف');
}

function esc(s){return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));}
</script>
</body>
</html>
