<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>طباعة — جدول القراءات</title>
<style>
:root{
  --ink:#0f172a; --muted:#65748b; --line:#e5e7eb; --ok:#22c55e; --low:#b45309; --high:#dc2626;
  --okbg:#ecfdf5; --lowbg:#fff7ed; --highbg:#fee2e2;
}
*{box-sizing:border-box}
body{margin:0;color:var(--ink);font:14px/1.55 system-ui,"Tajawal","Noto Sans Arabic",sans-serif;background:#fff}
header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--line)}
.h-meta{font-size:13px;color:#0f172ab3}
.btn{border:1px solid var(--line);background:#f3f4f6;padding:8px 12px;border-radius:10px;cursor:pointer}
main{padding:14px;max-width:1200px;margin:auto}
h2{margin:10px 0}
.table{width:100%;border-collapse:separate;border-spacing:0}
th,td{border:1px solid var(--line);padding:6px 8px;vertical-align:top;text-align:right}
thead th{background:#f8fafc}
td.low{background:var(--lowbg);color:var(--low)}
td.high{background:var(--highbg);color:var(--high)}
td.ok{background:var(--okbg);color:var(--ok)}
.small{font-size:12px;color:var(--muted)}
@media print{
  @page{size:A4 landscape;margin:8mm}
  header,.btn{display:none!important}
  body{font-size:11px}
  th,td{padding:4px 6px}
}
</style>
</head>
<body>
<header>
  <div>
    <div style="font-weight:800">جدول القراءات (mmol/L)</div>
    <div id="meta" class="h-meta">تحميل...</div>
  </div>
  <div>
    <button class="btn" onclick="window.print()">طباعة</button>
  </div>
</header>

<main>
  <h2 id="title">الطفل: —</h2>
  <table class="table">
    <thead>
      <tr id="head-row">
        <th>التاريخ</th>
        <th>قبل الإفطار</th><th>بعد الإفطار</th>
        <th>قبل الغداء</th><th>بعد الغداء</th>
        <th>قبل العشاء</th><th>بعد العشاء</th>
        <th>قبل النوم</th><th>أثناء النوم</th><th>عند الاستيقاظ</th>
      </tr>
    </thead>
    <tbody id="rows">
      <tr><td colspan="10" class="small">جارٍ التحميل...</td></tr>
    </tbody>
  </table>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, doc, getDoc, collection, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig={apiKey:"AIzaSyCOdrwdbw8b7YdWLPZ4TDdG2iS9kvvxQ7M",authDomain:"child-glucose-tracker.firebaseapp.com",projectId:"child-glucose-tracker",storageBucket:"child-glucose-tracker.firebasestorage.app",messagingSenderId:"294563325904",appId:"1:294563325904:web:39562550bf305fc01abbd5"};
const app=initializeApp(firebaseConfig); const auth=getAuth(app); const db=getFirestore(app);

const labels={preBreakfast:'قبل الإفطار',postBreakfast:'بعد الإفطار',preLunch:'قبل الغداء',postLunch:'بعد الغداء',preDinner:'قبل العشاء',postDinner:'بعد العشاء',beforeSleep:'قبل النوم',duringSleep:'أثناء النوم',uponWake:'عند الاستيقاظ'};
const order=['preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep','uponWake'];

function $(s){return document.querySelector(s);}
const params=new URL(location.href).searchParams;
const childId=params.get('child'); const from=params.get('from'); const to=params.get('to');

onAuthStateChanged(auth, async u=>{
  if(!u){ location.href='index.html'; return; }
  if(!childId||!from||!to){ $('#rows').innerHTML='<tr><td colspan="10" class="small">ينبغي تمرير child & from & to بالرابط.</td></tr>'; return; }

  const cs=await getDoc(doc(db,'users',u.uid,'children',childId)); const c=cs.data()||{};
  $('#title').textContent='الطفل: '+(c.name||'—');
  $('#meta').innerHTML='الاسم: '+(c.name||'—')+' • الرقم المدني: '+(c.childCivilId||'—')+' • الطول: '+(c.height??'—')+' سم • الوزن: '+(c.weight??'—')+' كجم • الفترة: '+from+' -> '+to+' • الوحدة: mmol/L';

  const qy=query(collection(db,'users',u.uid,'children',childId,'measurements'),
    where('date','>=',from), where('date','<=',to), orderBy('date','asc'));
  const qs=await getDocs(qy);

  const tbody=$('#rows'); tbody.innerHTML='';
  if(qs.empty){ tbody.innerHTML='<tr><td colspan="10" class="small">لا توجد قراءات في هذه الفترة.</td></tr>'; return; }

  qs.forEach(s=>{
    const d=s.data(); const readings=d.readings||{};
    const tr=document.createElement('tr');
    const tdDate=document.createElement('td'); tdDate.textContent=d.date; tdDate.style.whiteSpace='nowrap'; tr.appendChild(tdDate);

    order.forEach(slot=>{
      const r=readings[slot]; const td=document.createElement('td');
      if(!r||r.value==null){ td.textContent='—'; }
      else{
        const mmol=Number(r.value)||0;
        const cls = r.status==='low'?'low':(r.status==='high'?'high':'ok');
        td.className=cls;
        let parts=[''+mmol.toFixed(1)];
        if(r.mealDose!=null) parts.push('وجبة: '+r.mealDose+'U');
        if(r.correctionGiven!=null) parts.push('تصحيحي: '+r.correctionGiven+'U');
        if(r.note||r.raisedWith) parts.push('ملاحظة: '+(r.note||r.raisedWith));
        td.innerHTML = parts.join('<br>');
      }
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
});
</script>
</body>
</html>
