<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>جدول القراءات — للطباعة</title>
<style>
*{box-sizing:border-box}body{margin:0;font:14px/1.6 system-ui,"Tajawal","Noto Sans Arabic"}
header{padding:12px 14px;border-bottom:1px solid #e5e7eb}
main{max-width:1100px;margin:auto;padding:16px}
.table{width:100%;border-collapse:collapse}
th,td{border:1px solid #e5e7eb;padding:8px;text-align:right}
th{background:#f8fafc}
@media print{@page{size:A4;margin:10mm} .no-print{display:none}}
</style>
</head>
<body>
<header>
  <button class="no-print" onclick="window.print()">طباعة</button>
</header>
<main>
  <div id="meta" style="margin:6px 0 12px;color:#374151"></div>
  <table class="table">
    <thead>
      <tr>
        <th>التاريخ</th>
        <th>قبل الإفطار</th><th>بعد الإفطار</th>
        <th>قبل الغداء</th><th>بعد الغداء</th>
        <th>قبل العشاء</th><th>بعد العشاء</th>
        <th>قبل النوم</th><th>أثناء النوم</th><th>عند الاستيقاظ</th>
      </tr>
    </thead>
    <tbody id="rows"><tr><td colspan="10">تحميل...</td></tr></tbody>
  </table>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, getDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
const firebaseConfig={apiKey:"AIzaSyCOdrwdbw8b7YdWLPZ4TDdG2iS9kvvxQ7M",authDomain:"child-glucose-tracker.firebaseapp.com",projectId:"child-glucose-tracker",storageBucket:"child-glucose-tracker.firebasestorage.app",messagingSenderId:"294563325904",appId:"1:294563325904:web:39562550bf305fc01abbd5"};
const app=initializeApp(firebaseConfig); const auth=getAuth(app); const db=getFirestore(app);

const params=new URLSearchParams(location.search);
const childId=params.get('child'); const from=params.get('from'); const to=params.get('to');

const order=['preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep','uponWake'];
const labels={preBreakfast:'قبل الإفطار',postBreakfast:'بعد الإفطار',preLunch:'قبل الغداء',postLunch:'بعد الغداء',preDinner:'قبل العشاء',postDinner:'بعد العشاء',beforeSleep:'قبل النوم',duringSleep:'أثناء النوم',uponWake:'عند الاستيقاظ'};
const $=s=>document.querySelector(s);

onAuthStateChanged(auth, async (u)=>{
  if(!u){ document.body.innerHTML='<main>يجب تسجيل الدخول</main>'; return; }
  const uid=u.uid;
  const cs=await getDoc(doc(db,'users',uid,'children',childId));
  const c=cs.data()||{};
  $('#meta').innerHTML = 'الاسم: '+(c.name||'—')+' • الرقم المدني: '+(c.childCivilId||'—')+' • الفترة: '+from+' → '+to+' • الوحدة: mmol/L';

  const col=collection(db,'users',uid,'children',childId,'measurements');
  const qy=query(col, where('date','>=',from), where('date','<=',to), orderBy('date','asc'));
  const qs=await getDocs(qy);
  const tbody=$('#rows'); tbody.innerHTML='';

  if(qs.empty){ tbody.innerHTML='<tr><td colspan="10">لا توجد قراءات.</td></tr>'; }
  else{
    qs.forEach(s=>{
      const d=s.data(); const tr=document.createElement('tr');
      tr.innerHTML='<td>'+d.date+'</td>'+order.map(k=>{
        const r=(d.readings||{})[k];
        return '<td>'+(r&&r.value!=null? (Number(r.value).toFixed(1)+' mmol/L'): '—')+'</td>';
      }).join('');
      tbody.appendChild(tr);
    });
  }
  setTimeout(()=>window.print(),200);
});
</script>
</body>
</html>
