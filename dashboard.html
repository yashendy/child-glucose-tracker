<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” Ù…ØªØ§Ø¨Ø¹Ø© Ø³ÙƒØ± Ø§Ù„Ø£Ø·ÙØ§Ù„</title>
  
  <!-- âœ… Ø§Ù„Ø¬Ø²Ø¡ (1): ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¹ØµØ±ÙŠØ© Ù„Ù„ØµÙØ­Ø© -->
  <style>
    :root {
      --brand:#0ea5e9; --brand2:#6ee7b7; --line:#e5e7eb;
      --ink:#0f172a; --muted:#6b7280; --bg:#f6fbff;
      --card:#fff; --chip:#eef6ff;
    }

    * { box-sizing: border-box }
    body {
      margin: 0;
      font: 15px/1.6 system-ui, "Tajawal", "Noto Sans Arabic", sans-serif;
      background: var(--bg);
      color: var(--ink);
    }

    header {
      position: sticky;
      top: 0;
      background: linear-gradient(90deg, var(--brand), var(--brand2));
      color: #fff;
      padding: 14px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    header .title { font-weight: 800 }

    main { max-width: 1200px; margin: auto; padding: 18px }

    /* âœ… ØªÙ†Ø³ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯ Ù„Ø¨Ø·Ø§Ù‚Ø© ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± */
    .card-parent {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 30px;
      border: 1px solid #cce7f6;
    }

    .card-parent h2 {
      margin-bottom: 20px;
      font-size: 22px;
      color: #0c4a6e;
      text-align: center;
    }

    .parent-fields {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
    }

    .parent-fields input {
      padding: 10px 14px;
      border: 1px solid #bae6fd;
      border-radius: 10px;
      background-color: #fff;
      transition: 0.3s ease;
    }

    .parent-fields input:focus {
      border-color: #38bdf8;
      outline: none;
      background: #f0f9ff;
    }

    .save-btn {
      background: #0284c7;
      color: white;
      padding: 12px 18px;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s ease;
      display: block;
      margin: 20px auto 0;
    }

    .save-btn:hover {
      background: #0369a1;
    }

    .note {
      color: var(--muted);
      font-size: 13px;
    }

    .toast {
      position: fixed;
      bottom: 16px;
      left: 16px;
      background: #111;
      color: #fff;
      padding: 10px 14px;
      border-radius: 12px;
      opacity: 0;
      transform: translateY(8px);
      transition: .3s;
    }

    .toast.show {
      opacity: 1;
      transform: none;
    }
  </style>
</head>
  //Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù†ÙŠ
<body>
  <!-- âœ… Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø© -->
  <header>
    <div class="title">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
    <div class="row">
      <a class="btn gray" href="index.html">Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <button id="btnLogout" class="btn gray">Ø®Ø±ÙˆØ¬</button>
    </div>
  </header>

  <!-- âœ… Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
  <main>

    <!-- âœ… Ø¨Ø·Ø§Ù‚Ø© ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø± (Ù…ÙÙ†Ø³Ù‚Ø© Ø¨Ø¹Ù†Ø§ÙŠØ©) -->
    <section class="card-parent">
      <h2>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±</h2>
      <div id="hello" class="note" style="text-align:center; margin-bottom: 10px;">ØªØ­Ù…ÙŠÙ„...</div>
      <div class="parent-fields">
        <div>
          <label>Ø§Ø³Ù… ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±</label>
          <input id="guardianName" placeholder="Ù…Ø«Ø§Ù„: ÙŠØ§Ø³Ø± Ø­Ù…Ø¯ÙŠ">
        </div>
        <div>
          <label>Ø§Ù„Ø§Ø³Ù… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="fullName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
        </div>
        <div>
          <label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ</label>
          <input id="civilId" placeholder="Ù…Ø«Ø§Ù„: 281042603532">
        </div>
        <div>
          <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
          <input id="phone" placeholder="Ù…Ø«Ø§Ù„: 50534441">
        </div>
        <div>
          <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
          <input id="email" disabled>
        </div>
      </div>
      <button id="saveParent" class="save-btn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
    </section>
    //Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù„Ø«
    <!-- âœ… ÙƒØ±ÙˆØª Ø§Ù„Ø£Ø·ÙØ§Ù„ -->
    <section class="card">
      <h2 style="text-align:center; color:#0ea5e9;">ğŸ§’ Ø£Ø·ÙØ§Ù„ÙŠ</h2>
      <div id="kids" class="kids">
        <div class="note">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø·ÙØ§Ù„...</div>
      </div>
    </section>

  </main>

  <!-- âœ… Ø¥Ø´Ø¹Ø§Ø± Ù…Ø¤Ù‚Øª -->
  <div id="toast" class="toast"></div>
  //Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø±Ø§Ø¨Ø¹
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, updateDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  // âœ… Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCOdrwdbw8b7YdWLPZ4TDdG2iS9kvvxQ7M",
    authDomain: "child-glucose-tracker.firebaseapp.com",
    projectId: "child-glucose-tracker",
    storageBucket: "child-glucose-tracker.firebasestorage.app",
    messagingSenderId: "294563325904",
    appId: "1:294563325904:web:39562550bf305fc01abbd5"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // âœ… Ù…Ø³Ø§Ø¹Ø¯ÙŠÙ†
  const $ = selector => document.querySelector(selector);
  const toast = (msg) => {
    const t = $("#toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 2000);
  };

  let uid = null;

  // âœ… Ø¹Ù†Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„
  onAuthStateChanged(auth, async (user) => {
    if (!user) return location.href = "index.html";
    uid = user.uid;
    $("#hello").textContent = `Ù…Ø±Ø­Ø¨Ù‹Ø§ ${user.displayName || ""} â€” UID: ${user.uid}`;
    await loadParent();
    await loadKids();
  });

  // âœ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±
  async function loadParent() {
    const ref = doc(db, "users", uid);
    const snap = await getDoc(ref);
    const data = (snap.data() || {}).parentInfo || {};
    $("#guardianName").value = data.guardianName || "";
    $("#fullName").value = data.name || "";
    $("#civilId").value = data.civilId || "";
    $("#phone").value = data.phone || "";
    $("#email").value = data.email || "";
  }

  // âœ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
  $("#saveParent").addEventListener("click", async () => {
    const ref = doc(db, "users", uid);
    const snap = await getDoc(ref);
    const root = snap.data() || {};
    root.parentInfo = {
      guardianName: $("#guardianName").value.trim(),
      name: $("#fullName").value.trim(),
      civilId: $("#civilId").value.trim(),
      phone: $("#phone").value.trim(),
      email: $("#email").value.trim()
    };
    await updateDoc(ref, root);
    toast("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª");
  });

  // âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø·ÙØ§Ù„
  async function loadKids() {
    const container = $("#kids");
    container.innerHTML = "";
    const query = await getDocs(collection(db, "users", uid, "children"));
    if (query.empty) {
      container.innerHTML = '<div class="note">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø·ÙØ§Ù„ Ø¨Ø¹Ø¯ â€” Ø§Ø¶ØºØ·ÙŠ â€œğŸ‘§ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø·ÙØ§Ù„â€.</div>';
      return;
    }

    query.forEach(docSnap => {
      const c = docSnap.data();
      const id = docSnap.id;
      const unit = c.preferredUnit === "mgdl" ? "mg/dL" : "mmol/L";

      const card = document.createElement("div");
      card.className = "kid";
      card.innerHTML = `
        <h3 style="color:#0ea5e9; margin: 0 0 6px;">ğŸ‘§ ${c.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"}</h3>
        <div class="note">
          ğŸ“ Ø§Ù„Ø·ÙˆÙ„: ${c.height ?? "â€”"} Ø³Ù…<br>
          âš–ï¸ Ø§Ù„ÙˆØ²Ù†: ${c.weight ?? "â€”"} ÙƒØ¬Ù…<br>
          ğŸ’‰ ØªØ±ÙŠØ³ÙŠØ¨Ø§: ${c.tresiba ?? "â€”"} - Ù†ÙˆÙÙˆ: ${c.novo ?? "â€”"}<br>
          ğŸ§¾ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ: ${c.childCivilId ?? "â€”"}
        </div>
        <div class="chips" style="margin:8px 0;">
          <span class="chip">Ø§Ù„ÙˆØ­Ø¯Ø©: ${unit}</span>
          <span class="chip">Ù…Ù†Ø®ÙØ¶ &lt; ${c.lowThreshold ?? "â€”"}</span>
          <span class="chip">Ù…Ø±ØªÙØ¹ &gt; ${c.highThreshold ?? "â€”"}</span>
        </div>
        <div class="kid-actions">
          <a class="btn secondary" href="measure.html?child=${id}">ğŸ©º ØªØ³Ø¬ÙŠÙ„ Ù‚ÙŠØ§Ø³Ø§Øª</a>
          <a class="btn primary" href="report.html?child=${id}">ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a>
          <a class="btn purple"  href="doctor.html?child=${id}">ğŸ§‘â€âš•ï¸ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨</a>
          <a class="btn gray"     href="child.html?child=${id}">ğŸ› ï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„</a>
          <button class="btn orange" onclick="goToMealPlanner('${id}')">ğŸ” Ø§Ø®ØªÙŠØ§Ø± ÙˆØ¬Ø¨Ø©</button>
        </div>
      `;
      container.appendChild(card);
    });
  }

  // âœ… Ø±Ø¨Ø· Ø²Ø± Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ¬Ø¨Ø©
  window.goToMealPlanner = function(childId) {
    localStorage.setItem("selectedChildId", childId);
    window.location.href = "meal-planner.html";
  }

  // âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
  $("#btnLogout").addEventListener("click", () => {
    signOut(auth).then(() => location.href = "index.html");
  });
</script>
</body>
</html>
