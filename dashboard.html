<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>لوحة التحكم — متابعة سكر الأطفال</title>
  
  <!-- ✅ الجزء (1): تنسيقات عصرية للصفحة -->
  <style>
    :root {
      --brand:#0ea5e9; --brand2:#6ee7b7; --line:#e5e7eb;
      --ink:#0f172a; --muted:#6b7280; --bg:#f6fbff;
      --card:#fff; --chip:#eef6ff;
    }

    * { box-sizing: border-box }
    body {
      margin: 0;
      font: 15px/1.6 system-ui, "Tajawal", "Noto Sans Arabic", sans-serif;
      background: var(--bg);
      color: var(--ink);
    }

    header {
      position: sticky;
      top: 0;
      background: linear-gradient(90deg, var(--brand), var(--brand2));
      color: #fff;
      padding: 14px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    header .title { font-weight: 800 }

    main { max-width: 1200px; margin: auto; padding: 18px }

    /* ✅ تنسيق جديد لبطاقة ولي الأمر */
    .card-parent {
      background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 30px;
      border: 1px solid #cce7f6;
    }

    .card-parent h2 {
      margin-bottom: 20px;
      font-size: 22px;
      color: #0c4a6e;
      text-align: center;
    }

    .parent-fields {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
    }

    .parent-fields input {
      padding: 10px 14px;
      border: 1px solid #bae6fd;
      border-radius: 10px;
      background-color: #fff;
      transition: 0.3s ease;
    }

    .parent-fields input:focus {
      border-color: #38bdf8;
      outline: none;
      background: #f0f9ff;
    }

    .save-btn {
      background: #0284c7;
      color: white;
      padding: 12px 18px;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s ease;
      display: block;
      margin: 20px auto 0;
    }

    .save-btn:hover {
      background: #0369a1;
    }

    .note {
      color: var(--muted);
      font-size: 13px;
    }

    .toast {
      position: fixed;
      bottom: 16px;
      left: 16px;
      background: #111;
      color: #fff;
      padding: 10px 14px;
      border-radius: 12px;
      opacity: 0;
      transform: translateY(8px);
      transition: .3s;
    }

    .toast.show {
      opacity: 1;
      transform: none;
    }
  </style>
</head>
  //الجزء الثاني
<body>
  <!-- ✅ رأس الصفحة -->
  <header>
    <div class="title">لوحة التحكم</div>
    <div class="row">
      <a class="btn gray" href="index.html">الصفحة الرئيسية</a>
      <button id="btnLogout" class="btn gray">خروج</button>
    </div>
  </header>

  <!-- ✅ محتوى الصفحة الرئيسي -->
  <main>

    <!-- ✅ بطاقة وليّ الأمر (مُنسقة بعناية) -->
    <section class="card-parent">
      <h2>👨‍👩‍👧 بيانات وليّ الأمر</h2>
      <div id="hello" class="note" style="text-align:center; margin-bottom: 10px;">تحميل...</div>
      <div class="parent-fields">
        <div>
          <label>اسم وليّ الأمر</label>
          <input id="guardianName" placeholder="مثال: ياسر حمدي">
        </div>
        <div>
          <label>الاسم (اختياري)</label>
          <input id="fullName" placeholder="الاسم الكامل">
        </div>
        <div>
          <label>الرقم المدني</label>
          <input id="civilId" placeholder="مثال: 281042603532">
        </div>
        <div>
          <label>رقم الهاتف</label>
          <input id="phone" placeholder="مثال: 50534441">
        </div>
        <div>
          <label>البريد الإلكتروني</label>
          <input id="email" disabled>
        </div>
      </div>
      <button id="saveParent" class="save-btn">💾 حفظ التعديلات</button>
    </section>
    //الجزء الثالث
    <!-- ✅ كروت الأطفال -->
    <section class="card">
      <h2 style="text-align:center; color:#0ea5e9;">🧒 أطفالي</h2>
      <div id="kids" class="kids">
        <div class="note">تحميل الأطفال...</div>
      </div>
    </section>

  </main>

  <!-- ✅ إشعار مؤقت -->
  <div id="toast" class="toast"></div>
  //الجزء الرابع
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, updateDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  // ✅ إعداد Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCOdrwdbw8b7YdWLPZ4TDdG2iS9kvvxQ7M",
    authDomain: "child-glucose-tracker.firebaseapp.com",
    projectId: "child-glucose-tracker",
    storageBucket: "child-glucose-tracker.firebasestorage.app",
    messagingSenderId: "294563325904",
    appId: "1:294563325904:web:39562550bf305fc01abbd5"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // ✅ مساعدين
  const $ = selector => document.querySelector(selector);
  const toast = (msg) => {
    const t = $("#toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(() => t.classList.remove("show"), 2000);
  };

  let uid = null;

  // ✅ عند الدخول
  onAuthStateChanged(auth, async (user) => {
    if (!user) return location.href = "index.html";
    uid = user.uid;
    $("#hello").textContent = `مرحبًا ${user.displayName || ""} — UID: ${user.uid}`;
    await loadParent();
    await loadKids();
  });

  // ✅ تحميل بيانات ولي الأمر
  async function loadParent() {
    const ref = doc(db, "users", uid);
    const snap = await getDoc(ref);
    const data = (snap.data() || {}).parentInfo || {};
    $("#guardianName").value = data.guardianName || "";
    $("#fullName").value = data.name || "";
    $("#civilId").value = data.civilId || "";
    $("#phone").value = data.phone || "";
    $("#email").value = data.email || "";
  }

  // ✅ حفظ التعديلات
  $("#saveParent").addEventListener("click", async () => {
    const ref = doc(db, "users", uid);
    const snap = await getDoc(ref);
    const root = snap.data() || {};
    root.parentInfo = {
      guardianName: $("#guardianName").value.trim(),
      name: $("#fullName").value.trim(),
      civilId: $("#civilId").value.trim(),
      phone: $("#phone").value.trim(),
      email: $("#email").value.trim()
    };
    await updateDoc(ref, root);
    toast("✅ تم حفظ التعديلات");
  });

  // ✅ تحميل الأطفال
  async function loadKids() {
    const container = $("#kids");
    container.innerHTML = "";
    const query = await getDocs(collection(db, "users", uid, "children"));
    if (query.empty) {
      container.innerHTML = '<div class="note">لا يوجد أطفال بعد — اضغطي “👧 إدارة الأطفال”.</div>';
      return;
    }

    query.forEach(docSnap => {
      const c = docSnap.data();
      const id = docSnap.id;
      const unit = c.preferredUnit === "mgdl" ? "mg/dL" : "mmol/L";

      const card = document.createElement("div");
      card.className = "kid";
      card.innerHTML = `
        <h3 style="color:#0ea5e9; margin: 0 0 6px;">👧 ${c.name || "بدون اسم"}</h3>
        <div class="note">
          📏 الطول: ${c.height ?? "—"} سم<br>
          ⚖️ الوزن: ${c.weight ?? "—"} كجم<br>
          💉 تريسيبا: ${c.tresiba ?? "—"} - نوفو: ${c.novo ?? "—"}<br>
          🧾 الرقم المدني: ${c.childCivilId ?? "—"}
        </div>
        <div class="chips" style="margin:8px 0;">
          <span class="chip">الوحدة: ${unit}</span>
          <span class="chip">منخفض &lt; ${c.lowThreshold ?? "—"}</span>
          <span class="chip">مرتفع &gt; ${c.highThreshold ?? "—"}</span>
        </div>
        <div class="kid-actions">
          <a class="btn secondary" href="measure.html?child=${id}">🩺 تسجيل قياسات</a>
          <a class="btn primary" href="report.html?child=${id}">📊 عرض التقارير</a>
          <a class="btn purple"  href="doctor.html?child=${id}">🧑‍⚕️ متابعة الطبيب</a>
          <a class="btn gray"     href="child.html?child=${id}">🛠️ تعديل بيانات الطفل</a>
          <button class="btn orange" onclick="goToMealPlanner('${id}')">🍔 اختيار وجبة</button>
        </div>
      `;
      container.appendChild(card);
    });
  }

  // ✅ ربط زر اختيار الوجبة
  window.goToMealPlanner = function(childId) {
    localStorage.setItem("selectedChildId", childId);
    window.location.href = "meal-planner.html";
  }

  // ✅ تسجيل الخروج
  $("#btnLogout").addEventListener("click", () => {
    signOut(auth).then(() => location.href = "index.html");
  });
</script>
</body>
</html>
