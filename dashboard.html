<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>لوحة التحكم — متابعة سكر الأطفال</title>
  <style>
    :root {
      --brand: #0ea5e9;
      --brand2: #6ee7b7;
      --line: #e5e7eb;
      --ink: #0f172a;
      --muted: #6b7280;
      --bg: #f6fbff;
      --card: #fff;
      --chip: #eef6ff;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font: 15px/1.6 system-ui, "Tajawal", "Noto Sans Arabic", sans-serif;
      background: var(--bg);
      color: var(--ink);
    }

    header {
      position: sticky;
      top: 0;
      background: linear-gradient(90deg, var(--brand), var(--brand2));
      color: #fff;
      padding: 14px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    header .title {
      font-weight: 800;
    }

    main {
      max-width: 1200px;
      margin: auto;
      padding: 18px;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 1px 8px rgba(0, 0, 0, 0.05);
      margin-bottom: 14px;
    }

    .kid-name {
      font-size: 22px;
      font-weight: bold;
      color: var(--brand);
      margin: 0 0 6px;
    }

    .kid-info {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 10px;
    }

    .kid-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 6px;
    }

    .btn {
      border: none;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }

    .btn.primary {
      background: var(--brand);
      color: #fff;
    }

    .btn.secondary {
      background: #10b981;
      color: #fff;
    }

    .btn.purple {
      background: #7c3aed;
      color: #fff;
    }

    .btn.gray {
      background: #e2e8f0;
    }

    .btn.orange {
      background: #f97316;
      color: #fff;
    }

    .note {
      font-size: 13px;
      color: var(--muted);
    }

    .kids {
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }

    .kid {
      border: 1px solid var(--line);
      background: #fff;
      border-radius: 14px;
      padding: 12px;
      display: flex;
      flex-direction: column;
    }

    .chip {
      background: var(--chip);
      color: #0369a1;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      margin-left: 4px;
    }

    #toast {
      position: fixed;
      bottom: 16px;
      left: 16px;
      background: #111;
      color: #fff;
      padding: 10px 14px;
      border-radius: 12px;
      opacity: 0;
      transform: translateY(8px);
      transition: 0.3s;
    }

    #toast.show {
      opacity: 1;
      transform: none;
    }
  </style>
</head>

<body>
  <header>
    <div class="title">لوحة التحكم</div>
    <div class="row">
      <a class="btn gray" href="index.html">الصفحة الرئيسية</a>
      <button id="btnLogout" class="btn gray">خروج</button>
    </div>
  </header>

  <main>
    <section class="card">
      <h2>بيانات وليّ الأمر</h2>
      <div id="hello" class="note">تحميل...</div>
      <div class="grid cols-2" style="margin-top:10px">
        <div><label>اسم وليّ الأمر</label><input id="guardianName"></div>
        <div><label>الاسم (اختياري)</label><input id="fullName"></div>
        <div><label>الرقم المدني</label><input id="civilId"></div>
        <div><label>رقم الهاتف</label><input id="phone"></div>
        <div><label>البريد الإلكتروني</label><input id="email" disabled></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="saveParent" class="btn primary">حفظ التعديلات</button>
        <span class="note">يتم الحفظ في Firestore.</span>
      </div>
    </section>

    <section class="card">
      <h2>أطفالي</h2>
      <div id="kids" class="kids">
        <div class="note">تحميل الأطفال...</div>
      </div>
    </section>
  </main>

  <div id="toast"></div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

// إعداد Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCOdrwdbw8b7YdWLPZ4TDdG2iS9kvvxQ7M",
  authDomain: "child-glucose-tracker.firebaseapp.com",
  projectId: "child-glucose-tracker",
  storageBucket: "child-glucose-tracker.firebasestorage.app",
  messagingSenderId: "294563325904",
  appId: "1:294563325904:web:39562550bf305fc01abbd5"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// مساعدات
const $ = s => document.querySelector(s);
const toast = (msg) => {
  const t = $("#toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 2000);
};

let uid = null;

// عند تسجيل الدخول
onAuthStateChanged(auth, async (user) => {
  if (!user) return location.href = "index.html";
  uid = user.uid;
  $("#hello").textContent = `مرحبًا ${user.displayName || ""} — UID: ${user.uid}`;
  await loadParent();
  await loadKids();
});

// تحميل بيانات وليّ الأمر
async function loadParent() {
  const ref = doc(db, "users", uid);
  const snap = await getDoc(ref);
  const data = (snap.data() || {}).parentInfo || {};
  $("#guardianName").value = data.guardianName || "";
  $("#fullName").value = data.name || "";
  $("#civilId").value = data.civilId || "";
  $("#phone").value = data.phone || "";
  $("#email").value = data.email || "";
}

// حفظ التعديلات
$("#saveParent").addEventListener("click", async () => {
  const ref = doc(db, "users", uid);
  const snap = await getDoc(ref);
  const root = snap.data() || {};
  root.parentInfo = {
    guardianName: $("#guardianName").value.trim(),
    name: $("#fullName").value.trim(),
    civilId: $("#civilId").value.trim(),
    phone: $("#phone").value.trim(),
    email: $("#email").value.trim()
  };
  await updateDoc(ref, root);
  toast("✅ تم حفظ التعديلات");
});

// تحميل الأطفال
async function loadKids() {
  const container = $("#kids");
  container.innerHTML = "";
  const query = await getDocs(collection(db, "users", uid, "children"));
  if (query.empty) {
    container.innerHTML = '<div class="note">لا يوجد أطفال بعد — اضغطي “👧 إدارة الأطفال”.</div>';
    return;
  }

  query.forEach(docSnap => {
    const c = docSnap.data();
    const id = docSnap.id;
    const unit = c.preferredUnit === "mgdl" ? "mg/dL" : "mmol/L";

    const childCard = document.createElement("div");
    childCard.className = "kid";
    childCard.innerHTML = `
      <div class="kid-name">${c.name || "بدون اسم"}</div>
      <div class="kid-info">
        الطول: ${c.height ?? "—"} سم • الوزن: ${c.weight ?? "—"} كجم • تريسيبا: ${c.tresiba ?? "—"} • نوفو: ${c.novo ?? "—"}
      </div>
      <div class="chips">
        <span class="chip">الوحدة: ${unit}</span>
        <span class="chip">منخفض &lt; ${c.lowThreshold ?? "—"}</span>
        <span class="chip">مرتفع &gt; ${c.highThreshold ?? "—"}</span>
        ${c.childCivilId ? `<span class="chip">الرقم المدني: ${c.childCivilId}</span>` : ""}
      </div>
      <div class="kid-actions">
        <a class="btn secondary" href="measure.html?child=${id}">تسجيل قياسات</a>
        <a class="btn primary" href="report.html?child=${id}">عرض التقارير</a>
        <a class="btn purple"  href="doctor.html?child=${id}">متابعة الطبيب</a>
        <a class="btn gray"     href="child.html?child=${id}">تعديل بيانات الطفل</a>
      </div>
    `;
    container.appendChild(childCard);
  });
}

// زر الخروج
$("#btnLogout").addEventListener("click", () => {
  signOut(auth).then(() => location.href = "index.html");
});
</script>
</body>
</html>
