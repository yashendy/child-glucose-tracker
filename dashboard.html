<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” Ù…ØªØ§Ø¨Ø¹Ø© Ø³ÙƒØ± Ø§Ù„Ø£Ø·ÙØ§Ù„</title>

  <style>
    :root{
      --brand:#0ea5e9; --brand2:#6ee7b7; --line:#e5e7eb; --ink:#0f172a; --muted:#6b7280; --bg:#f6fbff; --card:#fff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:'Tajawal',system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans Arabic',sans-serif}
    a{text-decoration:none;color:inherit}

    header{
      position:sticky;top:0;z-index:10;
      background:linear-gradient(90deg,var(--brand),var(--brand2));
      color:#fff;padding:14px 18px;display:flex;justify-content:space-between;align-items:center
    }
    .btn{border:none;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
    .btn.gray{background:#ffffff22;border:1px solid #ffffff55;color:#fff}
    .btn.blue{background:#3b82f6;color:#fff}
    .btn.wide{min-width:180px}

    main{max-width:1100px;margin:auto;padding:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.04);margin-bottom:16px}
    .note{color:var(--muted);font-size:14px}
    label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px}
    input{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media(max-width:800px){.g2{grid-template-columns:1fr}}

    /* Ø£Ø·ÙØ§Ù„ */
    .kid-card{background:#e0f7fa;border:1px solid #d0eef2;border-radius:14px;padding:14px;margin-bottom:12px}
    .kid-head{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    .kid-avatar{width:56px;height:56px;border-radius:50%;object-fit:cover;border:2px solid #fff;box-shadow:0 1px 6px rgba(0,0,0,.1)}
    .kid-name{margin:0;font-weight:800}
    .kid-meta{font-size:13px;color:#1f2937}
    .kid-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

    /* Toast */
    .toast{position:fixed;bottom:16px;left:16px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transform:translateY(8px);transition:.3s;z-index:9999}
    .toast.show{opacity:1;transform:none}

    /* Helpers */
    .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .right{display:flex;align-items:center;gap:8px}
    .muted{color:var(--muted)}
  </style>
</head>
<body>

<header>
  <div class="title">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
  <div class="right">
    <a class="btn gray" href="index.html">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    <button id="btnLogout" class="btn gray" type="button">Ø®Ø±ÙˆØ¬</button>
  </div>
</header>

<main>
  <!-- Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø± -->
  <section class="card">
    <h2 style="margin:0 0 10px">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±</h2>
    <div id="hello" class="note" style="margin-bottom:8px">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>

    <div class="grid g2">
      <div>
        <label for="guardianName">ğŸ‘¤ Ø§Ø³Ù… ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±</label>
        <input id="guardianName" placeholder="Ù…Ø«Ø§Ù„: ÙŠØ§Ø³Ø± Ø­Ù…Ø¯ÙŠ">
      </div>
      <div>
        <label for="fullName">ğŸ‘¨â€ğŸ’¼ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input id="fullName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
      </div>
      <div>
        <label for="civilId">ğŸ†” Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ</label>
        <input id="civilId" placeholder="Ù…Ø«Ø§Ù„: 281042603532">
      </div>
      <div>
        <label for="phone">ğŸ“± Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
        <input id="phone" placeholder="Ù…Ø«Ø§Ù„: 50534441">
      </div>
      <div>
        <label for="email">ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·)</label>
        <input id="email" disabled placeholder="Ø³ÙŠØ¸Ù‡Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨">
      </div>
    </div>

    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="saveParent" class="btn blue">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
    </div>
  </section>

  <!-- Ø£Ø·ÙØ§Ù„ÙŠ -->
  <section class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 style="margin:0">ğŸ§’ Ø£Ø·ÙØ§Ù„ÙŠ</h2>
      <a href="child.html" class="btn blue">â• Ø¥Ø¶Ø§ÙØ© Ø·ÙÙ„</a>
    </div>
    <div id="kids" class="note" style="margin-top:8px">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
  </section>
</main>

<div id="toast" class="toast"></div>

<script type="module">
  // âœ… Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙˆØ­Ø¯Ø©
  import { db, auth } from './firebase-init.js';

  import {
    doc, getDoc, setDoc, collection, getDocs
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  import {
    onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

  /* ========== Helpers ========== */
  const $ = (s)=>document.querySelector(s);
  const toast = (msg, ms=2200)=>{
    const t=$("#toast"); t.textContent=msg; t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), ms);
  };
  const fallbackAvatarDataURL =
    'data:image/svg+xml;utf8,'+
    encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="128" height="128">
      <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#6ee7b7"/><stop offset="1" stop-color="#0ea5e9"/></linearGradient></defs>
      <rect width="100%" height="100%" fill="url(#g)"/>
      <circle cx="64" cy="52" r="24" fill="#fff" opacity=".9"/>
      <rect x="26" y="84" width="76" height="30" rx="15" fill="#fff" opacity=".9"/>
    </svg>`);

  let uid = null;

  /* ========== Auth Init ========== */
  onAuthStateChanged(auth, async (user)=>{
    if(!user){ location.href = "index.html"; return; }
    uid = user.uid;
    $("#hello").textContent = `Ù…Ø±Ø­Ø¨Ù‹Ø§ ${user.displayName || ""} â€” UID: ${user.uid}`;
    $("#email").value = user.email || "";
    await loadParent();
    await loadKids();
  });

  /* ========== Load/Save Parent Info ========== */
  async function loadParent(){
    try{
      const ref = doc(db,"users",uid);
      const snap = await getDoc(ref);
      const data = (snap.data() || {}).parentInfo || {};
      $("#guardianName").value = data.guardianName || "";
      $("#fullName").value     = data.name || "";
      $("#civilId").value      = data.civilId || "";
      $("#phone").value        = data.phone || "";
      // Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙŠØ¸Ù‡Ø± Ù…Ù† Ø§Ù„Ø­Ø³Ø§Ø¨
    }catch(e){
      console.error(e);
      toast("âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±");
    }
  }

  $("#saveParent").addEventListener("click", async ()=>{
    try{
      const ref = doc(db,"users",uid);
      const updatedInfo = {
        guardianName: $("#guardianName").value.trim() || null,
        name:         $("#fullName").value.trim()     || null,
        civilId:      $("#civilId").value.trim()      || null,
        phone:        $("#phone").value.trim()        || null,
        email:        $("#email").value.trim()        || (auth.currentUser?.email ?? null)
      };
      await setDoc(ref, { parentInfo: updatedInfo }, { merge:true });
      toast("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
    }catch(e){
      console.error(e);
      toast("âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸");
    }
  });

  /* ========== Load Kids ========== */
  async function loadKids(){
    const container = $("#kids");
    container.innerHTML = `<div class="note">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>`;
    try{
      const qs = await getDocs(collection(db,"users",uid,"children"));
      if(qs.empty){
        container.innerHTML = `
          <div class="note" style="text-align:center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø·ÙØ§Ù„ Ø¨Ø¹Ø¯ â€” Ø§Ø¶ØºØ·ÙŠ â€œØ¥Ø¶Ø§ÙØ© Ø·ÙÙ„â€.</div>
          <div style="text-align:center;margin-top:8px">
            <a class="btn blue" href="child.html">â• Ø¥Ø¶Ø§ÙØ© Ø·ÙÙ„</a>
          </div>`;
        return;
      }

      container.innerHTML = "";
      qs.forEach(docSnap=>{
        const c = docSnap.data();
        const id = docSnap.id;
        const avatar = c.photoURL || "images/avatar-default.png";

        const card = document.createElement("div");
        card.className = "kid-card";
        card.innerHTML = `
          <div class="kid-head">
            <img class="kid-avatar" src="${avatar}"
                 alt="ØµÙˆØ±Ø© Ø§Ù„Ø·ÙÙ„"
                 onerror="this.onerror=null;this.src='${fallbackAvatarDataURL}'">
            <div>
              <h3 class="kid-name">ğŸ‘§ ${c.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"}</h3>
              <div class="kid-meta">
                ğŸ§¾ ${c.childCivilId ?? "â€”"} â€¢ âš–ï¸ ${c.weight ?? "â€”"} ÙƒØ¬Ù… â€¢ ğŸ“ ${c.height ?? "â€”"} Ø³Ù…
              </div>
            </div>
          </div>
          <div class="kid-actions">
            <button class="btn blue wide" data-open="child" data-id="${encodeURIComponent(id)}">ğŸ“‹ Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            <a class="btn gray" target="_blank" href="child-dashboard.html?child=${encodeURIComponent(id)}">ğŸ” ÙØªØ­ ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯</a>
          </div>
        `;
        container.appendChild(card);
      });
    }catch(e){
      console.error(e);
      container.innerHTML = `<div class="note">âš ï¸ ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø·ÙØ§Ù„.</div>`;
    }
  }

  // ØªÙÙˆÙŠØ¶ Ø­Ø¯Ø« Ù„Ø²Ø± "Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª"
  $("#kids").addEventListener("click", (e)=>{
    const btn = e.target.closest('button[data-open="child"]');
    if(!btn) return;
    const childId = btn.getAttribute("data-id");
    location.href = `child-dashboard.html?child=${childId}`;
  });

  // Ø®Ø±ÙˆØ¬
  $("#btnLogout").addEventListener("click", ()=>{
    signOut(auth).then(()=> location.href="index.html");
  });
</script>
</body>
</html>
