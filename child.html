<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>إدارة الأطفال — متابعة سكر</title>
<style>
:root{--brand:#0ea5e9;--brand2:#6ee7b7;--line:#e5e7eb;--ink:#0f172a;--muted:#6b7280;--bg:#f6fbff;--card:#fff;--danger:#ef4444}
*{box-sizing:border-box}body{margin:0;font:15px/1.6 system-ui,"Tajawal","Noto Sans Arabic",sans-serif;background:var(--bg);color:var(--ink)}
header{position:sticky;top:0;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;padding:14px 18px;display:flex;align-items:center;justify-content:space-between}
main{max-width:1100px;margin:auto;padding:18px;display:grid;gap:14px;grid-template-columns:320px 1fr}
@media(max-width:980px){main{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 1px 8px rgba(0,0,0,.05)}
h2{margin:0 0 10px}
label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px}
input,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
.grid{display:grid;gap:12px;grid-template-columns:repeat(2,minmax(0,1fr))}
@media(max-width:680px){.grid{grid-template-columns:1fr}}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.btn{border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn.primary{background:var(--brand);color:#fff}
.btn.gray{background:#eef2f7}
.btn.danger{background:var(--danger);color:#fff}
.list{display:flex;flex-direction:column;gap:8px}
.child-item{padding:10px;border:1px solid var(--line);border-radius:10px;cursor:pointer;background:#fff}
.child-item.active{outline:2px solid var(--brand)}
.note{color:var(--muted);font-size:13px}
.toast{position:fixed;bottom:16px;left:16px;background:#111;color:#fff;padding:10px 14px;border-radius:12px;opacity:0;transform:translateY(8px);transition:.3s}
.toast.show{opacity:1;transform:none}
</style>
</head>
<body>
<header>
  <div>إدارة الأطفال</div>
  <div class="row">
    <a class="btn gray" href="dashboard.html">رجوع للوحة التحكم</a>
    <button id="btnLogout" class="btn gray">خروج</button>
  </div>
</header>

<main>
  <aside class="card">
    <h2>الأطفال</h2>
    <div class="row" style="margin-bottom:8px">
      <button id="newChild" class="btn primary">+ طفل جديد</button>
      <span class="note">اختر طفلًا للتعديل.</span>
    </div>
    <div id="childrenList" class="list"></div>
  </aside>

  <section class="card">
    <h2 id="formTitle">إضافة/تعديل طفل</h2>
    <div class="grid">
      <div><label>اسم الطفل</label><input id="c_name" placeholder="مثال: ليان"></div>
      <div><label>تاريخ الميلاد</label><input id="c_dob" type="date"></div>
      <div><label>الطول (سم)</label><input id="c_height" type="number" step="0.1" min="0"></div>
      <div><label>الوزن (كجم)</label><input id="c_weight" type="number" step="0.1" min="0"></div>
      <div><label>جرعة تريسيبا (وحدة)</label><input id="c_tresiba" type="number" step="0.1" min="0"></div>
      <div><label>جرعة نوفو (وحدة)</label><input id="c_novo" type="number" step="0.1" min="0"></div>
      <div class="grid" style="grid-template-columns:1fr 1fr;gap:12px">
        <div><label>مستوى الانخفاض</label><input id="c_low" type="number" step="0.1" min="0" placeholder="مثال: 4"></div>
        <div><label>مستوى الارتفاع</label><input id="c_high" type="number" step="0.1" min="0" placeholder="مثال: 10"></div>
      </div>
      <div style="grid-column:1/-1"><label>التصحيحي (وصف/معامل)</label><input id="c_corr" placeholder="مثال: 1U تُنقص 50"></div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="saveChild" class="btn primary">حفظ</button>
      <button id="deleteChild" class="btn danger" disabled>حذف</button>
      <span class="note">تأكدي أن مستوى الانخفاض أقل من مستوى الارتفاع.</span>
    </div>
  </section>
</main>

<div id="toast" class="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCOdrwdbw8b7YdWLPZ4TDdG2iS9kvvxQ7M",
  authDomain: "child-glucose-tracker.firebaseapp.com",
  projectId: "child-glucose-tracker",
  storageBucket: "child-glucose-tracker.firebasestorage.app",
  messagingSenderId: "294563325904",
  appId: "1:294563325904:web:39562550bf305fc01abbd5",
  measurementId: "G-TWC063TD6X"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

const $=s=>document.querySelector(s);
const toast=(m)=>{const t=$('#toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1700);};

let uid=null, currentChildId=null;

onAuthStateChanged(auth, async (u)=>{
  if(!u){ location.href='index.html'; return; }
  uid=u.uid;
  await loadChildren();
  // لو في child id في الاستعلام نحمّله
  const url = new URL(location.href);
  const cid = url.searchParams.get('child');
  if(cid) selectChild(cid);
});

$('#btnLogout').addEventListener('click', ()=>signOut(auth).then(()=>location.href='index.html'));

async function loadChildren(){
  const list=$('#childrenList'); list.innerHTML='تحميل...';
  const q=await getDocs(collection(db,'users',uid,'children'));
  list.innerHTML='';
  if(q.empty){ list.innerHTML='<div class="note">لا يوجد أطفال — اضغطي "طفل جديد"</div>'; return; }
  q.forEach(s=>{
    const c=s.data();
    const el=document.createElement('div');
    el.className='child-item';
    el.dataset.id=s.id;
    el.innerHTML=`<b>${c.name || 'بدون اسم'}</b><div class="note">حدود: ${c.lowThreshold ?? '—'}/${c.highThreshold ?? '—'}</div>`;
    el.onclick=()=>selectChild(s.id);
    list.appendChild(el);
  });
}

function clearActive(){
  document.querySelectorAll('.child-item').forEach(i=>i.classList.remove('active'));
}

async function selectChild(id){
  clearActive();
  const el = document.querySelector(`.child-item[data-id="${id}"]`);
  if(el) el.classList.add('active');
  currentChildId=id;
  $('#deleteChild').disabled=false;
  $('#formTitle').textContent='تعديل بيانات الطفل';

  const ref=doc(db,'users',uid,'children',id);
  const snap=await getDoc(ref);
  const c=snap.data()||{};
  $('#c_name').value=c.name||'';
  $('#c_dob').value=c.dob||'';
  $('#c_height').value=c.height ?? '';
  $('#c_weight').value=c.weight ?? '';
  $('#c_tresiba').value=c.tresiba ?? '';
  $('#c_novo').value=c.novo ?? '';
  $('#c_corr').value=c.correction || '';
  $('#c_low').value=c.lowThreshold ?? '';
  $('#c_high').value=c.highThreshold ?? '';
}

$('#newChild').addEventListener('click', ()=>{
  clearActive();
  currentChildId=null;
  $('#deleteChild').disabled=true;
  $('#formTitle').textContent='إضافة طفل جديد';
  ['c_name','c_dob','c_height','c_weight','c_tresiba','c_novo','c_corr','c_low','c_high'].forEach(id=>$('#'+id).value='');
});

$('#saveChild').addEventListener('click', async ()=>{
  const name=$('#c_name').value.trim();
  const dob=$('#c_dob').value || '';
  const height = $('#c_height').value===''? null : Number($('#c_height').value);
  const weight = $('#c_weight').value===''? null : Number($('#c_weight').value);
  const tresiba= $('#c_tresiba').value===''? null : Number($('#c_tresiba').value);
  const novo   = $('#c_novo').value===''? null : Number($('#c_novo').value);
  const correction=$('#c_corr').value.trim();
  const low = $('#c_low').value===''? null : Number($('#c_low').value);
  const high= $('#c_high').value===''? null : Number($('#c_high').value);

  if(!name) return toast('اكتبي اسم الطفل أولًا');
  if(low!=null && high!=null && !(low < high)) return toast('مستوى الانخفاض يجب أن يكون أقل من الارتفاع');

  const payload={ name,dob,height,weight,tresiba,novo,correction,lowThreshold:low,highThreshold:high,updatedAt:serverTimestamp() };

  if(currentChildId){
    await updateDoc(doc(db,'users',uid,'children',currentChildId), payload);
    toast('تم تحديث بيانات الطفل ✅');
  }else{
    const newRef = await addDoc(collection(db,'users',uid,'children'), { ...payload, createdAt: serverTimestamp() });
    currentChildId=newRef.id;
    toast('تم إضافة الطفل ✅');
  }
  await loadChildren();
});

$('#deleteChild').addEventListener('click', async ()=>{
  if(!currentChildId) return;
  if(!confirm('هل أنتِ متأكدة من حذف الطفل؟ سيؤدي ذلك إلى حذف بياناته (بدون القياسات حتى نضيفها لاحقًا).')) return;
  await deleteDoc(doc(db,'users',uid,'children',currentChildId));
  currentChildId=null;
  $('#deleteChild').disabled=true;
  $('#newChild').click();
  await loadChildren();
  toast('تم الحذف ✅');
});
</script>
</body>
</html>
