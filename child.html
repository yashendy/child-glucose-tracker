<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>إدارة بيانات الطفل — متابعة سكر الأطفال</title>
<style>
:root{--brand:#0ea5e9;--brand2:#6ee7b7;--line:#e5e7eb;--ink:#0f172a;--muted:#6b7280;--bg:#f6fbff;--card:#fff}
*{box-sizing:border-box}body{margin:0;font:15px/1.6 system-ui,"Tajawal","Noto Sans Arabic",sans-serif;background:var(--bg);color:var(--ink)}
header{position:sticky;top:0;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;padding:14px 18px;display:flex;align-items:center;justify-content:space-between}
main{max-width:1000px;margin:auto;padding:18px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 1px 8px rgba(0,0,0,.05);margin-bottom:14px}
h2{margin:0 0 10px}
label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px}
input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
.grid{display:grid;gap:12px}
.g2{grid-template-columns:repeat(2,minmax(0,1fr))}
.g3{grid-template-columns:repeat(3,minmax(0,1fr))}
@media(max-width:900px){.g2,.g3{grid-template-columns:1fr}}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.btn{border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
.btn.primary{background:var(--brand);color:#fff}
.btn.gray{background:#eef2f7}
.note{color:var(--muted);font-size:13px}
.toast{position:fixed;bottom:16px;left:16px;background:#111;color:#fff;padding:10px 14px;border-radius:12px;opacity:0;transform:translateY(8px);transition:.3s}
.toast.show{opacity:1;transform:none}
</style>
</head>
<body>
<header>
  <div>إدارة بيانات الطفل</div>
  <div class="row">
    <a class="btn gray" href="dashboard.html">لوحة التحكم</a>
  </div>
</header>

<main>
  <div class="card">
    <h2>اختيار الطفل</h2>
    <select id="childSel"><option value="">— اختاري الطفل —</option></select>
    <div class="note" id="childIdNote"></div>
  </div>

  <div class="card">
    <h2>البيانات الأساسية</h2>
    <div class="grid g3">
      <div><label>اسم الطفل</label><input id="name"></div>
      <div><label>تاريخ الميلاد</label><input id="dob" type="date"></div>
      <div><label>الرقم الطبي (اختياري)</label><input id="mrn"></div>
      <div><label>الوزن (كجم)</label><input id="weight" type="number" step="0.1"></div>
      <div><label>الطول (سم)</label><input id="height" type="number" step="0.1"></div>
    </div>
  </div>

  <div class="card">
    <h2>الحدود والجرعات</h2>
    <div class="grid g3">
      <div><label>الحد المنخفض (mmol/L)</label><input id="lowThreshold" type="number" step="0.1"></div>
      <div><label>الحد المرتفع (mmol/L)</label><input id="highThreshold" type="number" step="0.1"></div>
      <div><label>الهدف (Target) mmol/L</label><input id="targetMmol" type="number" step="0.1"></div>
      <div><label>معامل التصحيح (ISF) — mmol/L لكل 1U</label><input id="cfMmol" type="number" step="0.01"></div>
      <div><label>أو ISF (mg/dL) لكل 1U</label><input id="cfMgdl" type="number" step="1"></div>
      <div><label>جرعة الترسيبا (وحدة)</label><input id="tresiba" type="number" step="0.5"></div>
      <div><label>جرعة النوفو (وحدة) — اختياري</label><input id="novo" type="number" step="0.5"></div>
    </div>
    <div class="note" style="margin-top:8px">لو أدخلتِ ISF بـ mg/dL سنحوّله تلقائيًا إلى mmol/L (بالقسمة على 18) عند الاستعمال.</div>
  </div>

  <div class="card">
    <h2>زيارة الطبيب</h2>
    <div class="grid g3">
      <div><label>تاريخ الزيارة القادمة</label><input id="doctorVisitDate" type="date"></div>
      <div><label>اسم الطبيب (اختياري)</label><input id="doctorName"></div>
      <div><label>ملاحظات الزيارة (اختياري)</label><input id="doctorNotes"></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="save" class="btn primary">حفظ البيانات</button>
    </div>
  </div>
</main>

<div id="toast" class="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig={apiKey:"AIzaSyCOdrwdbw8b7YdWLPZ4TDdG2iS9kvvxQ7M",authDomain:"child-glucose-tracker.firebaseapp.com",projectId:"child-glucose-tracker",storageBucket:"child-glucose-tracker.firebasestorage.app",messagingSenderId:"294563325904",appId:"1:294563325904:web:39562550bf305fc01abbd5"};
const app=initializeApp(firebaseConfig); const auth=getAuth(app); const db=getFirestore(app);

const $=s=>document.querySelector(s);
const toast=(m)=>{const t=$('.toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1600);};

let uid=null, initChildId=new URL(location.href).searchParams.get('child');

onAuthStateChanged(auth, async (u)=>{
  if(!u){ location.href='index.html'; return; }
  uid=u.uid; await loadChildren();
  if(initChildId){ $('#childSel').value=initChildId; $('#childSel').dispatchEvent(new Event('change')); }
});

async function loadChildren(){
  const sel=$('#childSel'); sel.innerHTML='<option value="">— تحميل —</option>';
  const q=await getDocs(collection(db,'users',uid,'children'));
  sel.innerHTML='<option value="">— اختاري الطفل —</option>';
  q.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=s.data().name||'بدون اسم'; sel.appendChild(o); });
}

$('#childSel').addEventListener('change', async ()=>{
  const id=$('#childSel').value; $('#childIdNote').textContent=id?('ID: '+id):'';
  if(!id) return;
  const snap=await getDoc(doc(db,'users',uid,'children',id));
  const c=snap.data()||{};
  $('#name').value=c.name||''; $('#dob').value=c.dob||''; $('#mrn').value=c.mrn||'';
  $('#weight').value=c.weight??''; $('#height').value=c.height??'';
  $('#lowThreshold').value=c.lowThreshold??''; $('#highThreshold').value=c.highThreshold??'';
  $('#targetMmol').value=c.targetMmol??'';
  $('#cfMmol').value=c.correctionFactorMmol??''; $('#cfMgdl').value=c.correctionFactorMgDl??'';
  $('#tresiba').value=c.tresiba??''; $('#novo').value=c.novo??'';
  $('#doctorVisitDate').value=c.doctorVisitDate??''; $('#doctorName').value=c.doctorName??''; $('#doctorNotes').value=c.doctorNotes??'';
});

$('#save').addEventListener('click', async ()=>{
  const id=$('#childSel').value;
  if(!id) return toast('اختاري الطفل أولاً');
  const payload={
    name:valStr('#name'), dob:valStr('#dob'), mrn:valStr('#mrn'),
    weight: valNum('#weight'), height: valNum('#height'),
    lowThreshold: valNum('#lowThreshold'), highThreshold: valNum('#highThreshold'),
    targetMmol: valNum('#targetMmol'),
    correctionFactorMmol: valNum('#cfMmol'), correctionFactorMgDl: valNum('#cfMgdl'),
    tresiba: valNum('#tresiba'), novo: valNum('#novo'),
    doctorVisitDate: valStr('#doctorVisitDate'),
    doctorName: valStr('#doctorName'),
    doctorNotes: valStr('#doctorNotes')
  };
  await updateDoc(doc(db,'users',uid,'children',id), payload);
  toast('تم الحفظ ✅');
});

function valNum(sel){ const v=$(sel).value; if(v==='') return null; const n=Number(v); return Number.isFinite(n)?n:null; }
function valStr(sel){ const v=$(sel).value?.trim(); return v? v : null; }
</script>
</body>
</html>
