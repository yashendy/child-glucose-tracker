<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>إدارة الأطفال — متابعة سكر الأطفال</title>
<style>
:root{--brand:#0ea5e9;--line:#e5e7eb;--ink:#0f172a;--muted:#6b7280;--bg:#f6fbff;--card:#fff}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.6 system-ui,"Tajawal","Noto Sans Arabic",sans-serif}
header{position:sticky;top:0;background:linear-gradient(90deg,#0ea5e9,#6ee7b7);color:#fff;padding:14px 18px;display:flex;justify-content:space-between;align-items:center}
main{max-width:1100px;margin:auto;padding:18px}
.card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.04);margin-bottom:12px}
label{display:block;color:var(--muted);font-size:13px;margin-bottom:4px}
input,select{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
.grid{display:grid;gap:10px}
.g3{grid-template-columns:repeat(3,minmax(0,1fr))}
@media(max-width:900px){.g3{grid-template-columns:1fr}}
.btn{border:none;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
.btn.primary{background:#0ea5e9;color:#fff}
.btn.gray{background:#eef2f7}
.small{color:var(--muted);font-size:12px}
.row{display:flex;gap:8px;flex-wrap:wrap}
</style>
</head>
<body>
<header>
  <div>إدارة الأطفال</div>
  <div class="row">
    <a class="btn gray" href="dashboard.html">⬅ لوحة التحكم</a>
  </div>
</header>

<main>
  <section class="card">
    <h3 style="margin:0 0 10px">بيانات الطفل</h3>
    <div class="grid g3">
      <div><label>اسم الطفل</label><input id="name"></div>
      <div><label>الرقم المدني للطفل</label><input id="childCivilId" placeholder="اختياري"></div>
      <div>
        <label>الوحدة الافتراضية</label>
        <select id="preferredUnit">
          <option value="mmol">mmol/L</option>
          <option value="mgdl">mg/dL</option>
        </select>
      </div>
      <div><label>الوزن (كجم)</label><input id="weight" type="number" step="0.1"></div>
      <div><label>الطول (سم)</label><input id="height" type="number" step="0.1"></div>
      <div><label>تاريخ الميلاد</label><input id="dob" type="date"></div>
    </div>
  </section>

  <section class="card">
    <h3 style="margin:0 0 10px">الحدود والأهداف</h3>
    <div class="grid g3">
      <div><label>حد منخفض (mmol/L)</label><input id="lowThreshold" type="number" step="0.1" placeholder="مثلاً 4"></div>
      <div><label>حد مرتفع (mmol/L)</label><input id="highThreshold" type="number" step="0.1" placeholder="مثلاً 10"></div>
      <div><label>الهدف (mmol/L)</label><input id="targetMmol" type="number" step="0.1" placeholder="مثلاً 6.5"></div>
      <div><label>معامل التصحيح mmol/L لكل 1U</label><input id="correctionFactorMmol" type="number" step="0.1" placeholder="مثلاً 2.5"></div>
      <div><label>معامل التصحيح mg/dL لكل 1U</label><input id="correctionFactorMgDl" type="number" step="1" placeholder="بديل إن رغبتِ"></div>
      <div><label>ICR (جرام كارب لكل 1U)</label><input id="icr" type="number" step="1" placeholder="مثلاً 15"></div>
    </div>
    <div class="small">* سنستخدم mmol داخليًا؛ لو أدخلتِ mg/dL هنحوّل تلقائيًا.</div>
  </section>

  <section class="card">
    <h3 style="margin:0 0 10px">أوقات الوجبات والتنبيه</h3>
    <div class="grid g3">
      <div><label>فطور (HH:MM)</label><input id="mealBreakfast" type="time" value="07:30"></div>
      <div><label>غداء (HH:MM)</label><input id="mealLunch" type="time" value="13:30"></div>
      <div><label>عشاء (HH:MM)</label><input id="mealDinner" type="time" value="19:30"></div>
      <div><label>دقائق قبل الوجبة للتنبيه</label><input id="notifyBeforeMins" type="number" step="1" value="15"></div>
    </div>
    <div class="small">التنبيهات تعمل طالما صفحة القياس مفتوحة ومُفعّل الإشعارات بالمتصفح.</div>
  </section>

  <section class="card">
    <div class="row">
      <button id="save" class="btn primary">حفظ</button>
      <button id="newChild" class="btn gray">طفل جديد</button>
    </div>
  </section>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig={apiKey:"AIzaSyCOdrwdbw8b7YdWLPZ4TDdG2iS9kvvxQ7M",authDomain:"child-glucose-tracker.firebaseapp.com",projectId:"child-glucose-tracker",storageBucket:"child-glucose-tracker.firebasestorage.app",messagingSenderId:"294563325904",appId:"1:294563325904:web:39562550bf305fc01abbd5"};
const app=initializeApp(firebaseConfig); const auth=getAuth(app); const db=getFirestore(app);

const $=s=>document.querySelector(s);
let uid=null, childId=new URL(location.href).searchParams.get('child')||cryptoRandom();

onAuthStateChanged(auth, async (u)=>{
  if(!u){ location.href='index.html'; return; }
  uid=u.uid;
  // تحميل لو موجود
  const ref=doc(db,'users',uid,'children',childId);
  const snap=await getDoc(ref);
  if(snap.exists()){ fillForm(snap.data()); }
});

function fillForm(c){
  $('#name').value=c.name||'';
  $('#childCivilId').value=c.childCivilId||'';
  $('#preferredUnit').value=c.preferredUnit||'mmol';
  $('#weight').value=c.weight??'';
  $('#height').value=c.height??'';
  $('#dob').value=c.dob||'';

  $('#lowThreshold').value=c.lowThreshold??'';
  $('#highThreshold').value=c.highThreshold??'';
  $('#targetMmol').value=c.targetMmol??'';
  $('#correctionFactorMmol').value=c.correctionFactorMmol??'';
  $('#correctionFactorMgDl').value=c.correctionFactorMgDl??'';
  $('#icr').value=c.icr??'';

  const mt=(c.mealTimes||{});
  $('#mealBreakfast').value=mt.breakfast||'07:30';
  $('#mealLunch').value=mt.lunch||'13:30';
  $('#mealDinner').value=mt.dinner||'19:30';
  $('#notifyBeforeMins').value=c.notifyBeforeMins??15;
}

document.querySelector('#save').addEventListener('click', async ()=>{
  const c={
    name:$('#name').value.trim(),
    childCivilId:$('#childCivilId').value.trim()||null,
    preferredUnit:$('#preferredUnit').value, // 'mmol' | 'mgdl'
    weight:numOrNull('#weight'), height:numOrNull('#height'), dob:$('#dob').value||null,
    lowThreshold:numOrNull('#lowThreshold'), highThreshold:numOrNull('#highThreshold'), targetMmol:numOrNull('#targetMmol'),
    correctionFactorMmol:numOrNull('#correctionFactorMmol'), correctionFactorMgDl:numOrNull('#correctionFactorMgDl'),
    icr:numOrNull('#icr'),
    mealTimes:{
      breakfast:$('#mealBreakfast').value||null,
      lunch:$('#mealLunch').value||null,
      dinner:$('#mealDinner').value||null
    },
    notifyBeforeMins:numOrNull('#notifyBeforeMins')??15
  };
  await setDoc(doc(db,'users',uid,'children',childId), c, {merge:true});
  alert('تم الحفظ ✅');
});

document.querySelector('#newChild').addEventListener('click', ()=>{
  const id=cryptoRandom(); location.href='child.html?child='+id;
});

function numOrNull(sel){ const v=$(sel).value; if(v===''||v==null) return null; const n=Number(v); return Number.isFinite(n)?n:null; }
function cryptoRandom(){ return (Math.random().toString(36).slice(2)+Date.now().toString(36)).slice(0,20); }
</script>
</body>
</html>
