<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>سجل زيارات الطبيب</title>
<style>
*{box-sizing:border-box}body{margin:0;background:#f6fbff;color:#0f172a;font:14px/1.6 system-ui,"Tajawal","Noto Sans Arabic"}
header{position:sticky;top:0;background:linear-gradient(90deg,#0ea5e9,#6ee7b7);color:#fff;padding:12px 14px;display:flex;justify-content:space-between;align-items:center}
header .btn{background:#ffffff22;border:1px solid #ffffff66;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
main{max-width:900px;margin:auto;padding:14px}
.card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:12px;box-shadow:0 6px 24px rgba(0,0,0,.04);margin-bottom:12px}
.grid{display:grid;gap:10px} .g2{grid-template-columns:1fr 1fr}
input,textarea{width:100%;border:1px solid #e5e7eb;border-radius:10px;padding:10px;background:#fff}
label{font-size:12px;color:#6b7280;margin-bottom:4px;display:block}
table{width:100%;border-collapse:collapse} th,td{border:1px solid #e5e7eb;padding:8px;text-align:right} th{background:#f8fafc}
@media print{@page{size:A4;margin:10mm} header .no-print{display:none}}
</style>
</head>
<body>
<header>
  <div>سجل زيارات الطبيب</div>
  <div>
    <button class="btn no-print" onclick="window.print()">طباعة PDF</button>
    <button class="btn no-print" onclick="history.back()">رجوع</button>
  </div>
</header>

<main>
  <section class="card">
    <div id="meta" style="margin-bottom:8px;color:#334155"></div>
    <div class="grid g2">
      <div>
        <label>تاريخ الزيارة</label>
        <input id="visitDate" type="date">
      </div>
      <div>
        <label>اسم الطبيب</label>
        <input id="doctorName" placeholder="مثال: د. أحمد">
      </div>
      <div>
        <label>HbA1c % (اختياري)</label>
        <input id="hba1c" type="number" step="0.1" min="0">
      </div>
      <div>
        <label>الخطة الدوائية/الغذائية (اختياري)</label>
        <input id="plan" placeholder="مثال: تعديل ICR / جرعات...">
      </div>
      <div style="grid-column:1/-1">
        <label>ملاحظات الطبيب</label>
        <textarea id="notes" rows="3" placeholder="ملخص الزيارة..."></textarea>
      </div>
    </div>
    <div style="margin-top:8px">
      <button id="addLog" class="btn no-print" style="background:#0ea5e9;border-color:#0ea5e9">حفظ الزيارة</button>
    </div>
  </section>

  <section class="card">
    <h3 style="margin:0 0 8px">الزيارات السابقة</h3>
    <table>
      <thead><tr><th>التاريخ</th><th>الطبيب</th><th>HbA1c</th><th>الخطة</th><th>الملاحظات</th><th class="no-print">حذف</th></tr></thead>
      <tbody id="logs"><tr><td colspan="6">تحميل...</td></tr></tbody>
    </table>
  </section>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, getDoc, orderBy, query } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig={apiKey:"AIzaSyCOdrwdbw8b7YdWLPZ4TDdG2iS9kvvxQ7M",authDomain:"child-glucose-tracker.firebaseapp.com",projectId:"child-glucose-tracker",storageBucket:"child-glucose-tracker.firebasestorage.app",messagingSenderId:"294563325904",appId:"1:294563325904:web:39562550bf305fc01abbd5"};
const app=initializeApp(firebaseConfig); const auth=getAuth(app); const db=getFirestore(app);

const params=new URLSearchParams(location.search); const childId=params.get('child');
const $=s=>document.querySelector(s); let uid=null;

onAuthStateChanged(auth, async (u)=>{
  if(!u){ document.body.innerHTML='<main>يجب تسجيل الدخول</main>'; return; }
  uid=u.uid;
  const cs=await getDoc(doc(db,'users',uid,'children',childId)); const c=cs.data()||{};
  $('#meta').textContent='الاسم: '+(c.name||'—')+' • الرقم المدني: '+(c.childCivilId||'—');
  loadLogs();
});

async function loadLogs(){
  const tbody=$('#logs'); tbody.innerHTML='';
  const col=collection(db,'users',uid,'children',childId,'doctorLogs');
  const qy=query(col, orderBy('visitDate','desc'));
  const qs=await getDocs(qy);
  if(qs.empty){ tbody.innerHTML='<tr><td colspan="6">لا توجد زيارات مسجلة.</td></tr>'; return; }
  qs.forEach(s=>{
    const d=s.data();
    const tr=document.createElement('tr');
    tr.innerHTML='<td>'+(d.visitDate||'—')+'</td>'+
                 '<td>'+(d.doctorName||'—')+'</td>'+
                 '<td>'+(d.hba1c!=null? d.hba1c:'—')+'</td>'+
                 '<td>'+(d.plan||'—')+'</td>'+
                 '<td>'+(d.notes||'')+'</td>'+
                 '<td class="no-print"><button data-id="'+s.id+'">حذف</button></td>';
    tr.querySelector('button')?.addEventListener('click', async(e)=>{
      if(confirm('حذف هذه الزيارة؟')){ await deleteDoc(doc(db,'users',uid,'children',childId,'doctorLogs',e.target.dataset.id)); loadLogs(); }
    });
    tbody.appendChild(tr);
  });
}

$('#addLog').addEventListener('click', async ()=>{
  if(!uid) return;
  const visitDate=$('#visitDate').value;
  const doctorName=$('#doctorName').value.trim()||null;
  const hba1c= $('#hba1c').value ? Number($('#hba1c').value) : null;
  const plan = $('#plan').value.trim()||null;
  const notes=$('#notes').value.trim()||null;
  if(!visitDate) return alert('اختاري تاريخ الزيارة');

  await addDoc(collection(db,'users',uid,'children',childId,'doctorLogs'),{
    visitDate, doctorName, hba1c, plan, notes, createdAt: new Date()
  });
  $('#visitDate').value=''; $('#doctorName').value=''; $('#hba1c').value=''; $('#plan').value=''; $('#notes').value='';
  loadLogs();
});
</script>
</body>
</html>
