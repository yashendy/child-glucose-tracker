<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ± â€” Ø§Ù„Ø·ÙÙ„</title>
<style>
:root{
  --brand:#0ea5e9; --brand2:#6ee7b7; --line:#e5e7eb; --ink:#0f172a; --muted:#6b7280;
  --bg:#f6fbff; --card:#fff; --ok:#16a34a; --low:#b45309; --high:#dc2626;
  --okbg:#ecfdf5; --lowbg:#fff7ed; --highbg:#fee2e2;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.6 system-ui,"Tajawal","Noto Sans Arabic",sans-serif}
a{text-decoration:none;color:inherit}
header{position:sticky;top:0;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;padding:12px 14px;display:flex;justify-content:space-between;align-items:center;z-index:5}
header .btn{color:#fff;text-decoration:none;border:1px solid #ffffff66;padding:8px 12px;border-radius:10px;background:#ffffff22}
.container{max-width:1100px;margin:auto;padding:14px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 6px 24px rgba(0,0,0,.04);margin-bottom:12px}
.grid{display:grid;gap:10px}
.g3{grid-template-columns:repeat(3,minmax(0,1fr))}
.g2{grid-template-columns:repeat(2,minmax(0,1fr))}
@media(max-width:900px){.g3,.g2{grid-template-columns:1fr}}
label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{border:none;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
.btn.primary{background:var(--brand);color:#fff}
.btn.gray{background:#eef2f7}
.btn.red{background:#fee2e2;color:#991b1b}
.note{color:var(--muted);font-size:12px}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;background:#eef6ff;color:#0369a1;font-weight:800}
.sep{height:1px;background:var(--line);margin:10px 0}

/* Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ… */
.table{width:100%;border-collapse:separate;border-spacing:0}
.table th,.table td{border:1px solid var(--line);padding:8px;text-align:right;vertical-align:top}
.table thead th{background:#f0f9ff;font-weight:800}
.center{text-align:center}
.state{display:inline-block;padding:2px 8px;border-radius:999px}
.state.ok{background:var(--okbg);color:var(--ok)}
.state.low{background:var(--lowbg);color:var(--low)}
.state.high{background:var(--highbg);color:var(--high)}
.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>

<header>
  <div>ğŸ§ª Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ± â€” Ø§Ù„Ø·ÙÙ„</div>
  <div class="row">
    <a class="btn" id="backBtn" href="#">â¬… Ø±Ø¬ÙˆØ¹</a>
  </div>
</header>

<main class="container">
  <!-- Ø¨Ø·Ø§Ù‚Ø© ØªØ¹Ø±ÙŠÙ Ø³Ø±ÙŠØ¹Ø© -->
  <section class="card" id="kidCard" style="display:none">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <div class="badge" id="kidName">â€”</div>
        <div class="badge" id="kidMeta">â€”</div>
      </div>
      <div class="row">
        <span class="badge">Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø©: <b id="prefUnitBadge">mmol/L</b></span>
        <span class="badge">ICR: <b id="icrBadge">â€”</b></span>
        <span class="badge">Ø­Ø¯ÙˆØ¯: <b id="rangeBadge">â€”</b></span>
      </div>
    </div>
  </section>

  <!-- Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠØ§Ø³ -->
  <section class="card">
    <h3 style="margin:0 0 8px">Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù‚ÙŠØ§Ø³</h3>
    <div class="grid g3">
      <div>
        <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
        <input id="mDate" type="date">
      </div>
      <div>
        <label>ÙˆÙ‚Øª Ø§Ù„Ù‚ÙŠØ§Ø³</label>
        <select id="mSlot">
          <option value="">â€” Ø§Ø®ØªØ§Ø±ÙŠ â€”</option>
          <option value="uponWake">Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸</option>
          <option value="preBreakfast">Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±</option>
          <option value="postBreakfast">Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±</option>
          <option value="preLunch">Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡</option>
          <option value="postLunch">Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡</option>
          <option value="preDinner">Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡</option>
          <option value="postDinner">Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡</option>
          <option value="beforeSleep">Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…</option>
          <option value="duringSleep">Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…</option>
          <option value="beforeExercise">Ù‚Ø¨Ù„ Ø§Ù„ØªÙ…Ø±ÙŠÙ†</option>
          <option value="afterExercise">Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠÙ†</option>
          <option value="random">Ù‚ÙŠØ§Ø³ Ø¹Ø´ÙˆØ§Ø¦ÙŠ</option>
          <option value="other">Ø£Ø®Ø±Ù‰</option>
        </select>
      </div>
      <div>
        <label>Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© (<span id="readingUnitLabel">mmol/L</span>)</label>
        <input id="mValue" type="number" step="0.1" min="0" placeholder="Ù…Ø«Ø§Ù„: 7.8">
        <div id="mStateBadge" class="small" style="margin-top:4px"></div>
      </div>

      <div>
        <label>ÙƒØ§Ø±Ø¨ (Ø¬Ø±Ø§Ù…)</label>
        <input id="mCarbs" type="number" step="0.1" min="0">
      </div>
      <div>
        <label>Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© (ICR)</label>
        <input id="mDoseSuggested" readonly>
      </div>
      <div>
        <label>Ø¬Ø±Ø¹Ø© ÙØ¹Ù„ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
        <input id="mDoseGiven" type="number" step="0.1" min="0">
      </div>

      <div id="corrWrap" style="display:none">
        <label>Ø¬Ø±Ø¹Ø© ØªØµØ­ÙŠØ­ÙŠØ© (ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹)</label>
        <input id="mCorrection" type="number" step="0.1" min="0">
      </div>
      <div id="raiseWrap" style="display:none">
        <label>Ø±ÙØ¹ Ø§Ù„Ø³ÙƒØ± (ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ù‡Ø¨ÙˆØ·)</label>
        <input id="mRaisedWith" placeholder="Ù…Ø«Ø§Ù„: Ø¹ØµÙŠØ±/ØªÙ…Ø±">
      </div>
      <div>
        <label>Ù…Ù„Ø§Ø­Ø¸Ø©</label>
        <input id="mNote" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ">
      </div>
    </div>

    <div class="row" style="justify-content:flex-end;margin-top:8px">
      <button id="mSave" class="btn primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³</button>
      <button id="mCancelEdit" class="btn gray" style="display:none">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
    </div>
    <div class="note" style="margin-top:6px">
      * Ø§Ù„Ø­ÙØ¸ Ø¨Ø§Ù„Ù€ mmol/L Ø¯Ø§Ø¦Ù…Ù‹Ø§. Ù„Ùˆ ÙƒØ§Ù†Øª Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø© mg/dL Ø³ÙŠØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ (Ã· 18). Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ù„Ø£Ù‚Ø±Ø¨ 0.1.
    </div>
  </section>

  <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ… -->
  <section class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">ğŸ“… Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
      <div class="row">
        <label class="small">ØªØ§Ø±ÙŠØ® Ø¢Ø®Ø±:</label>
        <input id="dayPicker" type="date">
      </div>
    </div>
    <table class="table" style="margin-top:8px">
      <thead>
        <tr>
          <th>Ø§Ù„ÙˆÙ‚Øª</th>
          <th>Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© (mmol/L)</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th>Ø§Ù„Ø¬Ø±Ø¹Ø§Øª</th>
          <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
          <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
        </tr>
      </thead>
      <tbody id="mRows">
        <tr><td colspan="6" class="center small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠØ§Ø³Ø§Øª.</td></tr>
      </tbody>
    </table>
  </section>
</main>

<script type="module">
/* ===== Firebase ===== */
import { app, db, auth } from './firebase-init.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import {
  doc, getDoc, setDoc, updateDoc, deleteField
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

/* ===== Helpers & State ===== */
const $ = s=>document.querySelector(s);
const labels = {
  uponWake:'Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸',
  preBreakfast:'Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±', postBreakfast:'Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±',
  preLunch:'Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡',      postLunch:'Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡',
  preDinner:'Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡',     postDinner:'Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡',
  beforeSleep:'Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…',    duringSleep:'Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…',
  beforeExercise:'Ù‚Ø¨Ù„ Ø§Ù„ØªÙ…Ø±ÙŠÙ†', afterExercise:'Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠÙ†',
  random:'Ù‚ÙŠØ§Ø³ Ø¹Ø´ÙˆØ§Ø¦ÙŠ', other:'Ø£Ø®Ø±Ù‰'
};
const order = ['uponWake','preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep','beforeExercise','afterExercise','random','other'];
const params = new URLSearchParams(location.search);
const childId = params.get('child');

let uid=null, child=null, preferredUnit='mmol', icr=null, low=null, high=null;
let editState = { active:false, slot:null, date:null };

function todayISO(){ return new Date().toISOString().slice(0,10); }
function round1(n){ return Math.round(Number(n)*10)/10; }
function mgdlToMmol(v){ return v/18; }
function mmolToMgdl(v){ return v*18; }
function stateOf(v, lo, hi){
  if(v==null || isNaN(v)) return 'ok';
  if(isFinite(lo) && v<lo) return 'low';
  if(isFinite(hi) && v>hi) return 'high';
  return 'ok';
}
function badgeHtml(state){
  const txt = state==='low'?'Ù…Ù†Ø®ÙØ¶':state==='high'?'Ù…Ø±ØªÙØ¹':'Ø·Ø¨ÙŠØ¹ÙŠ';
  return `<span class="state ${state}">${txt}</span>`;
}
function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

/* ===== Boot ===== */
onAuthStateChanged(auth, async (user)=>{
  if(!user){ location.href='index.html'; return; }
  uid = user.uid;
  if(!childId){ alert('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø·ÙÙ„'); return; }
  // Ø²Ø± Ø±Ø¬ÙˆØ¹
  $('#backBtn').href = `child-dashboard.html?child=${encodeURIComponent(childId)}`;
  await loadChildAndInit();
});

async function loadChildAndInit(){
  const cs = await getDoc(doc(db,'users',uid,'children',childId));
  child = cs.data()||{};
  preferredUnit = (child.preferredUnit==='mgdl') ? 'mgdl' : 'mmol';
  icr = Number(child.icr)||null;
  low = Number(child.lowThreshold);
  high= Number(child.highThreshold);

  // Ø¨Ø·Ø§Ù‚Ø§Øª Ø£Ø¹Ù„Ù‰
  $('#kidCard').style.display='block';
  $('#kidName').textContent = child.name || 'â€”';
  $('#kidMeta').textContent = `${child.gender||'â€”'} â€¢ ${child.weight??'â€”'} ÙƒØ¬Ù… â€¢ ${child.height??'â€”'} Ø³Ù…`;
  $('#prefUnitBadge').textContent = preferredUnit==='mgdl'?'mg/dL':'mmol/L';
  $('#icrBadge').textContent = icr??'â€”';
  $('#rangeBadge').textContent = `${isFinite(low)?low:'â€”'} â€“ ${isFinite(high)?high:'â€”'}`;

  // ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
  $('#readingUnitLabel').textContent = preferredUnit==='mgdl'?'mg/dL':'mmol/L';

  // Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
  const today = todayISO();
  $('#mDate').value = today;
  $('#dayPicker').value = today;

  // Ø£Ø­Ø¯Ø§Ø«
  $('#mCarbs').addEventListener('input', recomputeSuggestedDose);
  $('#mValue').addEventListener('input', onReadingInput);
  $('#mDate').addEventListener('change', syncDayPicker);
  $('#dayPicker').addEventListener('change', onDayChange);
  $('#mSave').addEventListener('click', onSave);
  $('#mCancelEdit').addEventListener('click', cancelEdit);

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…
  await loadDay(today);
}

/* ===== UI Logic ===== */
function recomputeSuggestedDose(){
  const carbs = Number($('#mCarbs').value)||0;
  if(icr && icr>0 && carbs>0){
    const dose = round1(carbs/icr);
    $('#mDoseSuggested').value = dose.toFixed(1);
  }else{
    $('#mDoseSuggested').value = '';
  }
}

function onReadingInput(){
  // Ù†Ø­ØªØ§Ø¬ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØµØ­ÙŠØ­/Ø§Ù„Ø±ÙØ¹
  const raw = Number($('#mValue').value);
  if(!(raw>0)){ $('#mStateBadge').textContent=''; $('#corrWrap').style.display='none'; $('#raiseWrap').style.display='none'; return; }
  const mmol = preferredUnit==='mgdl' ? mgdlToMmol(raw) : raw;
  const v = round1(mmol);
  const st = stateOf(v, low, high);
  $('#mStateBadge').innerHTML = badgeHtml(st);
  $('#corrWrap').style.display = (st==='high') ? 'block' : 'none';
  $('#raiseWrap').style.display = (st==='low')  ? 'block' : 'none';
}

function syncDayPicker(){
  $('#dayPicker').value = $('#mDate').value;
  loadDay($('#mDate').value);
}
function onDayChange(){
  $('#mDate').value = $('#dayPicker').value;
  loadDay($('#dayPicker').value);
}

/* ===== Load Day ===== */
async function loadDay(date){
  const ref = doc(db,'users',uid,'children',childId,'measurements',date);
  const snap = await getDoc(ref);
  const data = snap.data()||{};
  const readings = data.readings||{};

  const tbody = $('#mRows');
  let html = '';
  order.forEach(slot=>{
    const r = readings[slot];
    if(!r || r.valueMmol==null) return;
    const v = round1(Number(r.valueMmol));
    const st = r.status || stateOf(v, low, high);
    const doses = [
      (r.mealDose!=null ? `ÙˆØ¬Ø¨Ø©: ${r.mealDose}U` : ''),
      (r.correctionGiven!=null ? `ØªØµØ­ÙŠØ­: ${r.correctionGiven}U` : '')
    ].filter(Boolean).join(' â€¢ ') || 'â€”';
    const note = r.note || r.raisedWith || 'â€”';
    html += `
      <tr data-slot="${slot}">
        <td><b>${labels[slot]}</b></td>
        <td>${v.toFixed(1)}</td>
        <td>${badgeHtml(st)}</td>
        <td>${escapeHTML(doses)}</td>
        <td>${escapeHTML(note)}</td>
        <td>
          <button class="btn gray" data-act="edit">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn red"  data-act="del">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        </td>
      </tr>`;
  });
  tbody.innerHTML = html || `<tr><td colspan="6" class="center small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠØ§Ø³Ø§Øª.</td></tr>`;

  // Ø§Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¬Ø¯ÙˆÙ„
  tbody.querySelectorAll('button[data-act]').forEach(btn=>{
    const tr = btn.closest('tr');
    const slot = tr?.dataset?.slot;
    const act = btn.dataset.act;
    if(act==='edit'){
      btn.addEventListener('click', ()=> startEdit(date, slot));
    }else{
      btn.addEventListener('click', ()=> delReading(date, slot));
    }
  });

  // Ù„Ùˆ ÙƒÙ†Ø§ ÙÙŠ ÙˆØ¶Ø¹ ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ ÙŠÙˆÙ… Ø¢Ø®Ø±ØŒ Ø¥Ù„ØºÙŠÙ‡
  if(editState.active && editState.date !== date){
    cancelEdit();
  }
}

/* ===== Edit/Delete ===== */
async function startEdit(date, slot){
  const ref = doc(db,'users',uid,'children',childId,'measurements',date);
  const snap = await getDoc(ref);
  const r = (snap.data()?.readings||{})[slot];
  if(!r){ alert('Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'); return; }

  // Ø¹Ø¨Ù‘ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„
  $('#mDate').value = date;
  $('#mSlot').value = slot;
  // Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ØªÙØ¹Ø±Ø¶ Ø¨ÙˆØ­Ø¯Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø©
  let disp = Number(r.valueMmol);
  if(preferredUnit==='mgdl') disp = mmolToMgdl(disp);
  $('#mValue').value = round1(disp).toFixed(1);
  $('#mCarbs').value = r.carbs ?? '';
  $('#mDoseSuggested').value = ''; // ÙŠØ¹Ø§Ø¯ Ø­Ø³Ø§Ø¨Ù‡ Ù…Ù† Ø§Ù„ÙƒØ§Ø±Ø¨ + ICR
  recomputeSuggestedDose();
  $('#mDoseGiven').value = r.mealDose ?? '';
  $('#mCorrection').value = r.correctionGiven ?? '';
  $('#mRaisedWith').value = r.raisedWith ?? '';
  $('#mNote').value = r.note ?? '';

  // Ø­Ø§Ù„Ø© Ù„Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
  onReadingInput();

  editState = { active:true, slot, date };
  $('#mCancelEdit').style.display='inline-block';
  window.scrollTo({top:0,behavior:'smooth'});
}

function cancelEdit(){
  editState = {active:false, slot:null, date:null};
  $('#mCancelEdit').style.display='none';
  // ØªÙ†Ø¸ÙŠÙ Ø³Ø±ÙŠØ¹ (Ù„Ø§ Ù†Ù…Ø³Ø­ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙŠÙˆÙ…)
  // $('#mSlot').value = '';
  // $('#mValue').value = '';
  // $('#mCarbs').value = '';
  // $('#mDoseSuggested').value = '';
  // $('#mDoseGiven').value = '';
  // $('#mCorrection').value = '';
  // $('#mRaisedWith').value = '';
  // $('#mNote').value = '';
}

async function delReading(date, slot){
  if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ÙŠÙ† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©ØŸ')) return;
  const ref = doc(db,'users',uid,'children',childId,'measurements',date);
  await updateDoc(ref, { [`readings.${slot}`]: deleteField() });
  if(editState.active && editState.date===date && editState.slot===slot) cancelEdit();
  await loadDay(date);
}

/* ===== Save ===== */
async function onSave(){
  const date = $('#mDate').value;
  const slot = $('#mSlot').value;
  const raw  = Number($('#mValue').value);
  if(!date || !slot){ alert('Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ù‚ÙŠØ§Ø³'); return; }
  if(!(raw>0)){ alert('Ø£Ø¯Ø®Ù„ÙŠ Ù‚Ø±Ø§Ø¡Ø© ØµØ­ÙŠØ­Ø©'); return; }

  // Ø­ÙˆÙ‘Ù„ÙŠ Ø¥Ù„Ù‰ mmol/L Ù„Ùˆ ÙƒØ§Ù†Øª Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© mg/dL
  const mmol = preferredUnit==='mgdl' ? mgdlToMmol(raw) : raw;
  const v = round1(mmol);
  const st = stateOf(v, low, high);

  const carbs    = ($('#mCarbs').value==='') ? null : Number($('#mCarbs').value);
  const mealDose = ($('#mDoseGiven').value==='') ? null : Number($('#mDoseGiven').value);
  const corr     = ($('#mCorrection').value==='') ? null : Number($('#mCorrection').value);
  const raised   = $('#mRaisedWith').value.trim() || null;
  const note     = $('#mNote').value.trim() || null;

  const ref = doc(db,'users',uid,'children',childId,'measurements',date);
  const snap = await getDoc(ref);
  const base = snap.data()||{ date, readings:{} };
  if(!base.readings) base.readings = {};

  // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª Ù„Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ… (Ø¥Ù„Ø§ Ù„Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ù„Ù†ÙØ³ Ø§Ù„Ù€slot)
  const exists = base.readings[slot] && base.readings[slot].valueMmol!=null;
  if(exists && !(editState.active && editState.date===date && editState.slot===slot)){
    alert('â›” ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª Ù…Ø³Ø¨Ù‚Ù‹Ø§ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…. Ø§Ø³ØªØ®Ø¯Ù…ÙŠ "ØªØ¹Ø¯ÙŠÙ„" Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø§Ù„Ø¥Ø¶Ø§ÙØ©.');
    return;
  }

  base.readings[slot] = {
    valueMmol: v,
    status: st,
    carbs, mealDose,
    correctionGiven: (st==='high' ? corr : null),
    raisedWith:      (st==='low'  ? raised : null),
    note
  };

  await setDoc(ref, base, {merge:true});
  cancelEdit();
  await loadDay(date);
  alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³');
}
</script>
</body>
</html>
