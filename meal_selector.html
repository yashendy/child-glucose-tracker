<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø§Ø®ØªÙŠØ§Ø± ÙˆØ¬Ø¨Ø© Ø§Ù„Ø·ÙÙ„</title>
  <style>
    /* CSS Ù„Ø§ ÙŠØªØºÙŠØ± */
  </style>
</head>
<body>
  <h1>ğŸ½ Ø§Ø®ØªÙŠØ§Ø± ÙˆØ¬Ø¨Ø© Ø§Ù„Ø·ÙÙ„</h1>
  <div class="child-info" id="childInfo">ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„...</div>
  <div class="layout">
    <div class="categories" id="categoryList">ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª...</div>
    <div class="items" id="foodList">Ø§Ø®ØªØ± ØªØµÙ†ÙŠÙÙ‹Ø§ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£ØµÙ†Ø§Ù</div>
  </div>
  <h2>Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</h2>
  <table>
    <thead>
      <tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª</th><th>Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª</th><th>Ø­Ø°Ù</th></tr>
    </thead>
    <tbody id="selectedFoodsTable">
      <tr><td colspan="4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù Ù…Ø®ØªØ§Ø±Ø©.</td></tr>
    </tbody>
  </table>
  <div class="totals">
    <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª: <strong id="totalCarbs">0</strong> Ø¬Ù…</p>
    <p>Ø¬Ø±Ø¹Ø© Ø§Ù„Ø¥Ù†Ø³ÙˆÙ„ÙŠÙ†: <strong id="insulinDose">0</strong> ÙˆØ­Ø¯Ø©</p>
  </div>
  <button class="btn-save" id="saveMealBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙˆØ¬Ø¨Ø©</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "child-glucose-tracker.firebaseapp.com",
      projectId: "child-glucose-tracker",
      storageBucket: "child-glucose-tracker.appspot.com",
      messagingSenderId: "294563325904",
      appId: "1:294563325904:web:39562550bf305fc01abbd5"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const $ = s => document.querySelector(s);
    const childInfo = $("#childInfo");
    const categoryList = $("#categoryList");
    const foodList = $("#foodList");
    const selectedFoodsTable = $("#selectedFoodsTable");
    const totalCarbsEl = $("#totalCarbs");
    const insulinDoseEl = $("#insulinDose");
    const saveMealBtn = $("#saveMealBtn");

    const params = new URLSearchParams(location.search);
    const childId = params.get("child");
    const mealTime = params.get("time");
    let ICR = parseFloat(params.get("icr")) || 1;

    // Ø¨Ø¯Ø§ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù…Ø¬Ù‡ÙˆÙ„
    signInAnonymously(auth)
      .catch(err => console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„:", err));

    onAuthStateChanged(auth, async (user) => {
      if (!user) return alert("ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
      const uid = user.uid;

      // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„ ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ auth
      const snap = await getDoc(doc(db, "users", uid, "children", childId));
      if (!snap.exists()) {
        childInfo.textContent = "Ù„Ù„Ø£Ø³ÙØŒ Ø§Ù„Ø·ÙÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.";
        return;
      }
      const data = snap.data();
      childInfo.textContent = `Ø§Ù„Ø§Ø³Ù…: ${data.name} | ICR: ${data.icr} Ø¬Ù…/ÙˆØ­Ø¯Ø©`;
      ICR = data.icr;

      // Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·ÙÙ„ØŒ Ù†Ø¨Ø¯Ø£ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù ÙˆØ§Ù„ØªÙØ§Ø¹Ù„Ø§Øª:
      await loadFoods();
      setupSave();
    });

    let foods = [], selected = [];
    async function loadFoods() {
      const snap = await getDocs(collection(db, "foods"));
      foods = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      const cats = [...new Set(foods.map(f => f.category))];
      categoryList.innerHTML = cats.map(c => `<button data-cat="${c}">${c}</button>`).join("");
      categoryList.querySelectorAll("button")
        .forEach(b => b.onclick = () => renderFoods(b.dataset.cat));
    }

    function renderFoods(cat) {
      foodList.innerHTML = "";
      foods.filter(f => f.category === cat).forEach(f => {
        const div = document.createElement("div");
        div.className = "item-card";
        div.innerHTML = `
          <span>${f.name}</span>
          <input type="number" min="1" step="1" placeholder="Ø¹Ø¯Ø¯" id="unit-${f.id}">
          <button data-id="${f.id}">Ø£Ø¶Ù</button>`;
        foodList.append(div);
      });
      foodList.querySelectorAll("button")
        .forEach(b => b.onclick = () => addFood(b.dataset.id));
    }

    function addFood(id) {
      const f = foods.find(x => x.id === id);
      const qty = parseInt($(`#unit-${id}`).value);
      if (!(qty > 0)) return alert("Ø£Ø¯Ø®Ù„ÙŠ Ø¹Ø¯Ø¯ ÙˆØ­Ø¯Ø§Øª ØµØ§Ù„Ø­Ø©!");
      const carbs = qty * (f.carbsPerUnit || 0);
      selected.push({ name: f.name, qty, carbs });
      renderSelected();
    }

    function renderSelected() {
      if (!selected.length) {
        selectedFoodsTable.innerHTML = `<tr><td colspan="4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù Ù…Ø®ØªØ§Ø±Ø©.</td></tr>`;
        return;
      }
      selectedFoodsTable.innerHTML = selected.map((s, i) => `
        <tr>
          <td>${s.name}</td><td>${s.qty}</td><td>${s.carbs.toFixed(1)}</td>
          <td><button data-i="${i}">Ø­Ø°Ù</button></td>
        </tr>`).join("");
      selectedFoodsTable.querySelectorAll("button")
        .forEach(b => b.onclick = () => {
          selected.splice(b.dataset.i, 1); renderSelected();
        });
      updateTotals();
    }

    function updateTotals() {
      const total = selected.reduce((a, s) => a + s.carbs, 0);
      totalCarbsEl.textContent = total.toFixed(1);
      insulinDoseEl.textContent = (total / ICR).toFixed(1);
    }

    function setupSave() {
      saveMealBtn.onclick = async () => {
        const dateKey = new Date().toISOString().split("T")[0];
        await setDoc(doc(db, "users", auth.currentUser.uid, "children", childId, "meals", dateKey + "_" + mealTime), {
          time: mealTime,
          items: selected,
          totalCarbs: parseFloat(totalCarbsEl.textContent),
          insulinDose: parseFloat(insulinDoseEl.textContent),
          createdAt: new Date()
        });
        window.location = `measure.html?child=${childId}&time=${mealTime}&carbs=${totalCarbsEl.textContent}&dose=${insulinDoseEl.textContent}`;
      };
    }
  </script>
</body>
</html>
