<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>اختيار وجبة الطفل</title>
  <style>
    body { font-family: 'Cairo', sans-serif; background: #f0f4f8; color: #333; margin: 0; padding: 20px; }
    h1, h2 { color: #0ea5e9; text-align: center; }
    .child-info { background: #e0f7fa; padding: 15px; border-radius: 10px; max-width: 800px; margin: 20px auto; font-size: 18px; }
    .layout { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; margin: 30px auto; max-width: 1000px; }
    .categories, .items { background: #fff; border-radius: 8px; padding: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); height: 400px; overflow-y: auto; }
    .categories { width: 200px; }
    .categories button { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 6px; background: #f9fafb; font-size: 16px; cursor: pointer; }
    .categories button:hover { background: #e0f2fe; }
    .item-card { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
    .item-card input { width: 80px; padding: 5px; text-align: center; margin: 0 10px; }
    .item-card button { background: #10b981; color: #fff; padding: 6px 10px; border: none; border-radius: 6px; cursor: pointer; }
    .item-card button:hover { background: #059669; }
    table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden; margin: 20px auto; max-width: 800px; }
    th, td { padding: 10px; text-align: center; border: 1px solid #ddd; }
    th { background-color: #f0f9ff; }
    .totals { text-align: center; font-size: 18px; margin-top: 20px; }
    .btn-save { display: block; margin: 30px auto; padding: 12px 25px; font-size: 18px; border: none; border-radius: 8px; background: #0ea5e9; color: #fff; cursor: pointer; }
    .btn-save:hover { background: #0284c7; }
  </style>
</head>
<body>

  <h1>🍽 اختيار وجبة الطفل</h1>
  <div class="child-info" id="childInfo">تحميل بيانات الطفل...</div>

  <div class="layout">
    <div class="categories" id="categoryList">تحميل التصنيفات...</div>
    <div class="items" id="foodList">اختر تصنيفًا لعرض الأصناف</div>
  </div>

  <h2>الأصناف المختارة</h2>
  <table>
    <thead>
      <tr><th>الصنف</th><th>عدد الوحدات</th><th>الكربوهيدرات</th><th>حذف</th></tr>
    </thead>
    <tbody id="selectedFoodsTable">
      <tr><td colspan="4">لا توجد أصناف مختارة.</td></tr>
    </tbody>
  </table>

  <div class="totals">
    <p>إجمالي الكربوهيدرات: <strong id="totalCarbs">0</strong> جم</p>
    <p>جرعة الإنسولين: <strong id="insulinDose">0</strong> وحدة</p>
  </div>

  <button class="btn-save" id="saveMealBtn">💾 حفظ الوجبة</button>

 <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

  const app = initializeApp(/* config */);
  const db = getFirestore(app);
  const auth = getAuth(app);

  const $ = s => document.querySelector(s);
  const childInfo = $("#childInfo");
  const categoryList = $("#categoryList");
  const foodList = $("#foodList");
  const selectedFoodsTable = $("#selectedFoodsTable");
  const totalCarbsEl = $("#totalCarbs");
  const insulinDoseEl = $("#insulinDose");
  const saveMealBtn = $("#saveMealBtn");

  const params = new URLSearchParams(location.search);
  const childId = params.get("child");
  const mealTime = params.get("time");
  let ICR = parseFloat(params.get("icr")) || 1;

  signInAnonymously(auth).catch(err => {
    console.error("فشل تسجيل الدخول المجهول:", err);
    alert("برجاء تفعيل تسجيل الدخول المجهول من Firebase Console!");
  });

  onAuthStateChanged(auth, async user => {
    if (!user) return;
    const uid = user.uid;
    const snap = await getDoc(doc(db, "users", uid, "children", childId));
    if (!snap.exists()) return childInfo.textContent = "الطفل غير موجود.";
    childInfo.textContent = `الاسم: ${snap.data().name} | ICR: ${snap.data().icr} جم/وحدة`;
    ICR = snap.data().icr;

    await loadFoods();
    setupSave(uid);
  });

  let foods = [], selected = [];

  async function loadFoods() {
    const snap = await getDocs(collection(db, "foods"));
    foods = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    const categories = [...new Set(foods.map(f => f.category))];
    categoryList.innerHTML = categories.map(c => `<button data-cat="${c}">${c}</button>`).join("");
    categoryList.querySelectorAll("button").forEach(b => b.onclick = () => renderFoods(b.dataset.cat));
  }

  function renderFoods(cat) {
    foodList.innerHTML = "";
    foods.filter(f => f.category === cat).forEach(f => {
      const safeId = encodeURIComponent(f.id);
      const div = document.createElement("div");
      div.className = "item-card";
      div.innerHTML = `
        <span>${f.name} (${f.servingDescription || ''})</span>
        <input type="number" min="1" step="1" placeholder="وحدات" id="unit-${safeId}">
        <button data-id="${f.id}">أضف</button>`;
      foodList.append(div);
    });
    foodList.querySelectorAll(".item-card button").forEach(b => b.onclick = () => addFood(b.dataset.id));
  }

  function addFood(id) {
    const f = foods.find(x => x.id === id);
    const safeId = encodeURIComponent(id);
    const inp = document.getElementById(`unit-${safeId}`);
    const qty = parseInt(inp.value);
    if (!(qty > 0)) return alert("أدخلي عدد وحدات صحيح");

    const grams = f.gramsPerServing * qty;
    const carbs = grams * f.carbsPer100g / 100;
    selected.push({ name: f.name, qty, grams, carbs: +carbs.toFixed(1) });
    renderSelected();
  }

  function renderSelected() {
    if (!selected.length) {
      selectedFoodsTable.innerHTML = `<tr><td colspan="5">لا توجد أصناف مختارة.</td></tr>`;
      return;
    }
    selectedFoodsTable.innerHTML = selected.map((s, i) => `
      <tr>
        <td>${s.name}</td>
        <td>${s.qty}</td>
        <td>${s.grams}</td>
        <td>${s.carbs}</td>
        <td><button data-i="${i}">حذف</button></td>
      </tr>`).join("");
    selectedFoodsTable.querySelectorAll("button").forEach(b => b.onclick = () => {
      selected.splice(b.dataset.i, 1);
      renderSelected();
    });
    updateTotals();
  }

  function updateTotals() {
    const totalCarbs = selected.reduce((sum, f) => sum + f.carbs, 0);
    totalCarbsEl.textContent = totalCarbs.toFixed(1);
    insulinDoseEl.textContent = (totalCarbs / ICR).toFixed(1);
  }

  function setupSave(uid) {
    saveMealBtn.onclick = async () => {
      const dateKey = new Date().toISOString().slice(0, 10);
      await setDoc(doc(db, "users", uid, "children", childId, "meals", dateKey + "_" + mealTime), {
        time: mealTime,
        items: selected,
        totalCarbs: parseFloat(totalCarbsEl.textContent),
        insulinDose: parseFloat(insulinDoseEl.textContent),
        createdAt: new Date()
      });
      window.location = `measure.html?child=${childId}&time=${mealTime}&carbs=${totalCarbsEl.textContent}&dose=${insulinDoseEl.textContent}`;
    };
  }
</script>


</body>
</html>
