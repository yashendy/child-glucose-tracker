<!-- âœ… meal_selector.html â€” Ø§Ù„Ø¬Ø²Ø¡ 1 -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ¬Ø¨Ø©</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background: #f0f4f8;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    h1, h2 {
      color: #0ea5e9;
      text-align: center;
    }
    .child-info {
      background-color: #e0f7fa;
      border-radius: 10px;
      padding: 15px;
      margin: 20px auto;
      max-width: 800px;
      font-size: 18px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .layout {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-top: 30px;
    }
    .categories {
      width: 200px;
      background-color: #ffffff;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      height: 400px;
      overflow-y: auto;
    }
    .categories button {
      width: 100%;
      margin-bottom: 10px;
      padding: 10px;
      background-color: #f9fafb;
      border: 1px solid #ccc;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
    }
    .categories button:hover {
      background-color: #e0f2fe;
    }
    .items {
      flex: 1;
      max-width: 600px;
      background-color: #ffffff;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      height: 400px;
      overflow-y: auto;
    }
    .item-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #eee;
      padding: 8px 0;
    }
    .item-card input {
      width: 60px;
      padding: 5px;
      text-align: center;
    }
    .item-card button {
      padding: 6px 10px;
      background-color: #10b981;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .item-card button:hover {
      background-color: #059669;
    }
  </style>
</head>
<body>

  <h1>ğŸ½ï¸ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£ØµÙ†Ø§Ù Ù„Ù„ÙˆØ¬Ø¨Ø©</h1>

  <!-- ğŸ§’ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„ -->
  <div class="child-info" id="childInfo">
    <strong>Ø§Ù„Ø§Ø³Ù…:</strong> Ø£Ø³ÙŠÙ„ | <strong>ICR:</strong> 12 Ø¬Ø±Ø§Ù… / ÙˆØ­Ø¯Ø© | <strong>Ø§Ù„ÙˆÙ‚Øª:</strong> Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±
  </div>

  <!-- ğŸ§­ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ÙˆØ§Ù„Ø£ØµÙ†Ø§Ù -->
  <div class="layout">
    <div class="categories" id="categoryList">
      <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§ -->
    </div>
    <div class="items" id="foodList">
      <p>Ø§Ø®ØªØ± ØªØµÙ†ÙŠÙÙ‹Ø§ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£ØµÙ†Ø§Ù.</p>
    </div>
  </div>
  <!-- âœ… Ø§Ù„Ø¬Ø²Ø¡ 2: Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© -->
  <h2>ğŸ¥— Ø§Ù„Ø£ØµÙ†Ø§Ù Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</h2>
  <div style="max-width: 800px; margin: 0 auto;">
    <table style="width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden;">
      <thead style="background-color: #f0f9ff;">
        <tr>
          <th style="padding: 10px;">Ø§Ù„ØµÙ†Ù</th>
          <th>Ø§Ù„ÙƒÙ…ÙŠØ© (Ø¬Ù…)</th>
          <th>Ø§Ù„ÙƒØ§Ø±Ø¨</th>
          <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
        </tr>
      </thead>
      <tbody id="selectedFoodsTable"></tbody>
    </table>

    <!-- âœ… Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ§Ø±Ø¨ ÙˆØ§Ù„Ø¬Ø±Ø¹Ø© -->
    <div style="margin-top: 20px; text-align: center; font-size: 18px;">
      <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª: <strong id="totalCarbs">0</strong> Ø¬Ù…</p>
      <p>Ø¬Ø±Ø¹Ø© Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©: <strong id="insulinDose">0</strong> ÙˆØ­Ø¯Ø§Øª</p>
    </div>

    <!-- âœ… Ø²Ø± Ø­ÙØ¸ Ø§Ù„ÙˆØ¬Ø¨Ø© -->
    <div style="text-align: center; margin-top: 30px;">
      <button class="btn-save" id="saveMealBtn" style="padding: 12px 25px; font-size: 18px;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙˆØ¬Ø¨Ø© ÙˆØ§Ù„Ø¹ÙˆØ¯Ø©</button>
    </div>
  </div>
<!-- âœ… Ø§Ù„Ø¬Ø²Ø¡ 3: Ø§Ù„Ø³ÙƒØ±Ø¨Øª ÙˆØ§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„ØµÙØ­Ø© -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getFirestore, collection, getDocs, setDoc, doc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCOdrwdbw8b7YdWLPZ4TDdG2iS9kvvxQ7M",
    authDomain: "child-glucose-tracker.firebaseapp.com",
    projectId: "child-glucose-tracker",
    storageBucket: "child-glucose-tracker.appspot.com",
    messagingSenderId: "294563325904",
    appId: "1:294563325904:web:39562550bf305fc01abbd5",
    measurementId: "G-TWC063TD6X"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Ø¹Ù†Ø§ØµØ± Ù…Ù† Ø§Ù„ØµÙØ­Ø©
  const categoryList = document.getElementById("categoryList");
  const foodList = document.getElementById("foodList");
  const selectedFoodsTable = document.getElementById("selectedFoodsTable");
  const totalCarbsEl = document.getElementById("totalCarbs");
  const insulinDoseEl = document.getElementById("insulinDose");
  const saveMealBtn = document.getElementById("saveMealBtn");
  const childInfo = document.getElementById("childInfo");

  // Ø¨ÙŠØ§Ù†Ø§Øª ØªØ¬Ù‡Ø² ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§:
  const urlParams = new URLSearchParams(window.location.search);
  const childId = urlParams.get("child") || "";    // Ø²ÙŠ child=uhLz...
  const mealTime = urlParams.get("time") || "";    // Ø²ÙŠ time=beforeBreakfast
  const ICR = parseFloat(urlParams.get("icr")) || 12;

  childInfo.innerHTML = `
    <strong>Ø§Ù„Ø§Ø³Ù…:</strong> â€“ &nbsp;|&nbsp;
    <strong>ICR:</strong> ${ICR} Ø¬Ø±Ø§Ù…/ÙˆØ­Ø¯Ø© &nbsp;|&nbsp;
    <strong>Ø§Ù„ÙˆÙ‚Øª:</strong> ${mealTime.replace(/([A-Z])/g, ' $1').trim()}
  `;

  let categories = [];
  let foods = [];
  let selectedFoods = [];

  // Ø¬Ù„Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ù…Ù† "foods" ÙÙŠ Firebase
  async function loadFoods() {
    const snapshot = await getDocs(collection(db, "foods"));
    const arr = [];
    snapshot.forEach(doc => arr.push(doc.data()));
    foods = arr;
    categories = Array.from(new Set(arr.map(f => f.category)));
    renderCategories();
  }

  function renderCategories() {
    categoryList.innerHTML = categories.map(cat => `
      <button data-cat="${cat}">${cat}</button>
    `).join('');
    categoryList.querySelectorAll("button").forEach(btn => {
      btn.addEventListener("click", () => renderFoods(btn.dataset.cat));
    });
  }

  function renderFoods(cat) {
    foodList.innerHTML = "";
    foods.filter(f => f.category === cat).forEach(f => {
      const div = document.createElement("div");
      div.className = "item-card";
      div.innerHTML = `
        <span>${f.name}</span>
        <input type="number" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø¬Ø±Ø§Ù…" min="0" step="0.1" id="input-${f.name}">
        <button data-name="${f.name}">Ø£Ø¶Ù</button>
      `;
      foodList.appendChild(div);
    });
    foodList.querySelectorAll(".item-card button").forEach(btn => {
      btn.addEventListener("click", () => addFood(btn.dataset.name));
    });
  }

  function addFood(name) {
    const food = foods.find(f => f.name === name);
    const qtyInput = document.getElementById(`input-${name}`);
    const qty = parseFloat(qtyInput.value);
    if (!qty || qty <= 0) return alert("Ø£Ø¯Ø®Ù„ÙŠ ÙƒÙ…ÙŠØ© ØµØ§Ù„Ø­Ø©");
    const carbs = qty * (food.carbsPer100g / 100);
    selectedFoods.push({ ...food, qty, carbs });
    renderSelected();
    qtyInput.value = "";
  }

  function renderSelected() {
    selectedFoodsTable.innerHTML = selectedFoods.map((f, i) => `
      <tr>
        <td>${f.name}</td>
        <td>${f.qty}</td>
        <td>${f.carbs.toFixed(1)}</td>
        <td><button data-idx="${i}">Ø­Ø°Ù</button></td>
      </tr>
    `).join('');
    selectedFoodsTable.querySelectorAll("button").forEach(btn => {
      btn.addEventListener("click", () => {
        selectedFoods.splice(parseInt(btn.dataset.idx), 1);
        renderSelected();
      });
    });
    updateTotals();
  }

  function updateTotals() {
    const total = selectedFoods.reduce((sum, f) => sum + f.carbs, 0);
    totalCarbsEl.textContent = total.toFixed(1);
    insulinDoseEl.textContent = (total / ICR).toFixed(1);
  }

  saveMealBtn.addEventListener("click", async () => {
    if (!childId) return alert("Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø·ÙÙ„!");
    const today = new Date().toISOString().split("T")[0];
    const ref = doc(db, "users", childId, "children", childId, "meals", today + "_" + mealTime);
    await setDoc(ref, {
      time: mealTime,
      foods: selectedFoods,
      totalCarbs: parseFloat(totalCarbsEl.textContent),
      insulinDose: parseFloat(insulinDoseEl.textContent),
      createdAt: new Date()
    });
    window.location = `measure.html?child=${childId}&time=${mealTime}&carbs=${totalCarbsEl.textContent}&dose=${insulinDoseEl.textContent}`;
  });

  loadFoods();
</script>
</body>
</html>
