<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>تقارير الطفل</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    @media print { @page{ size: A4 landscape; margin: 8mm } .no-print{display:none!important} }
  </style>
</head>
<body>

  <!-- ✅ بنر الطفل -->
  <div id="childBanner" style="text-align:center; padding:12px 8px; display:none">
    <img id="bannerAvatar" class="avatar" style="width:84px;height:84px" src="images/avatar-default.png" alt="صورة الطفل">
    <div style="margin-top:6px;font-weight:800" id="bannerName">—</div>
    <div class="note" id="bannerMeta">—</div>
  </div>

  <!-- ✅ Topbar -->
  <div class="topbar">
    <div>📄 تقارير أسبوعية</div>
    <div class="row">
      <a id="lnkHome" class="btn gray">الرئيسية</a>
      <button id="btnBlank" class="btn">ورقة فارغة (7 أيام)</button>
      <button id="btnPrint" class="btn">طباعة PDF</button>
    </div>
  </div>

  <main class="container">
    <!-- ✅ Nav -->
    <div class="card"><div class="row" id="childNav"></div></div>

    <section class="card">
      <div class="grid g4 no-print">
        <div><label>من</label><input id="from" type="date"></div>
        <div><label>إلى</label><input id="to" type="date"></div>
        <div><label>المدى السريع</label>
          <select id="preset">
            <option value="7">آخر 7 أيام</option>
            <option value="14">آخر 14 يوم</option>
            <option value="30">آخر 30 يوم</option>
          </select>
        </div>
        <div style="display:flex;align-items:end"><button id="run" class="btn primary" style="width:100%">عرض</button></div>
      </div>
      <div id="meta" class="note" style="margin:6px 0">—</div>

      <div class="card" style="margin-top:8px">
        <table class="table" id="rep">
          <thead>
            <tr>
              <th>التاريخ</th>
              <th>الاستيقاظ</th>
              <th>قبل الإفطار</th><th>بعد الإفطار</th>
              <th>قبل الغداء</th><th>بعد الغداء</th>
              <th>قبل العشاء</th><th>بعد العشاء</th>
              <th>قبل النوم</th><th>أثناء النوم</th>
            </tr>
          </thead>
          <tbody id="rows"><tr><td colspan="10" class="center note">اختاري الفترة لعرض البيانات.</td></tr></tbody>
        </table>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>
  <div id="loader" class="loader"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>

  <script type="module">
    import { auth, db, ensureAuth, requireChildIdFromQuery, setChildAvatar, todayISO } from './firebase-init.js';
    import { signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { doc, getDoc, collection, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const toast=(m)=>{const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000)}
    const showLoader=(on)=>{document.getElementById('loader').style.display=on?'flex':'none'}

    const labels={
      uponWake:'الاستيقاظ',preBreakfast:'قبل الإفطار',postBreakfast:'بعد الإفطار',
      preLunch:'قبل الغداء',postLunch:'بعد الغداء',
      preDinner:'قبل العشاء',postDinner:'بعد العشاء',
      beforeSleep:'قبل النوم',duringSleep:'أثناء النوم'
    };
    const order=['uponWake','preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep'];

    let uid=null, childId=null, child=null;

    function buildNav(){
      const row=document.getElementById('childNav'); row.innerHTML='';
      [['child-dashboard.html','الرئيسية'],['measures.html','قياسات السكر'],['meals.html','الوجبات'],['reports.html','التقارير'],['visits.html','الزيارات الطبية']]
      .forEach(([h,t])=>{ const a=document.createElement('a'); a.className='btn gray'; a.href=`${h}?child=${encodeURIComponent(childId)}`; a.textContent=t; row.appendChild(a);});
      document.getElementById('lnkHome').href=`child-dashboard.html?child=${encodeURIComponent(childId)}`;
    }

    async function loadChild(){
      const s=await getDoc(doc(db,'users',uid,'children',childId));
      child=s.data()||{};
      setChildAvatar(document.getElementById('bannerAvatar'), child.name, child.photoURL);
      bannerName.textContent=child.name||'—';
      bannerMeta.textContent=`${child.gender||'—'} • ${child.weight||'—'} كجم • ${child.height||'—'} سم`;
      childBanner.style.display='block';
    }

    function iso(d){ return d.toISOString().slice(0,10); }
    function addDays(date, n){ const d=new Date(date); d.setDate(d.getDate()+n); return d; }
    function rangeDays(from,to){ const out=[]; let d=new Date(from); const end=new Date(to); while(d<=end){ out.push(iso(d)); d.setDate(d.getDate()+1);} return out; }
    function round1(n){ const v=Math.round(Number(n)*10)/10; return Number.isFinite(v)?v:null }
    function stateIcon(v,lo,hi){ if(v==null) return ''; if(isFinite(lo)&&v<lo) return '⬇️'; if(isFinite(hi)&&v>hi) return '⬆️'; return '🟢'; }

    async function buildReport(from, to){
      showLoader(true);
      const dates=rangeDays(from,to);
      const snaps=await Promise.all(dates.map(d=>getDoc(doc(db,'users',uid,'children',childId,'measurements',d))));
      const lo=Number(child?.lowThreshold), hi=Number(child?.highThreshold);

      // Meals-index by date+slot (وجود رمز 🍽️)
      const mealsQ = await getDocs(query(collection(db,'users',uid,'children',childId,'meals'), where('time','>=', from), where('time','<=', addDays(to,1).toISOString())));
      const mealMap = new Map(); // key: date|slot -> true
      mealsQ.forEach(s=>{
        const m=s.data(); if(!m?.time) return;
        const date=(new Date(m.time)).toISOString().slice(0,10);
        // مش مرتبط بوقت محدد، هنكتفي بإظهار 🍽️ في أي خلية اليوم فيها بيانات قياس + وجبة
        mealMap.set(date, true);
      });

      const tbody=document.getElementById('rows'); let html='';
      snaps.forEach((snap,i)=>{
        const d=dates[i]; const data=snap.data()||{}; const r=data.readings||{};
        let row=`<tr><td class="date">${d}</td>`;
        order.forEach(slot=>{
          const x=r[slot]; if(!x||x.valueMmol==null){ row+=`<td>—</td>`; return; }
          const v=round1(x.valueMmol); const icon=stateIcon(v,lo,hi);
          const note=(x.note||x.raisedWith)? `<div class="note">${escapeHTML(x.note||x.raisedWith)}</div>`:'';
          const mealMark = mealMap.has(d)? ' 🍽️' : '';
          const doseTxt = [x.mealDose!=null?`جرعة: ${x.mealDose}U`: '', x.correctionGiven!=null?`تصحيح: ${x.correctionGiven}U`: ''].filter(Boolean).join(' • ');
          row+=`<td><div><b>${v?.toFixed(1)||''} ${icon}${mealMark}</b></div>${doseTxt?`<div class="note">${doseTxt}</div>`:''}${note}</td>`;
        });
        row+='</tr>';
        html+=row;
      });
      tbody.innerHTML = html || `<tr><td colspan="10" class="center note">لا توجد بيانات.</td></tr>`;

      meta.textContent = `الطفل: ${child?.name||'—'} • الفترة: ${from} → ${to} • حدود: منخفض < ${child?.lowThreshold??'—'} — مرتفع > ${child?.highThreshold??'—'}`;
      showLoader(false);
    }

    function escapeHTML(s){return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]))}

    // أحداث
    btnPrint.addEventListener('click', ()=>window.print());
    btnBlank.addEventListener('click', ()=>{
      const today=new Date(); const dates=Array.from({length:7},(_,i)=>{const d=new Date(today); d.setDate(today.getDate()+i); return d.toISOString().slice(0,10);});
      rows.innerHTML = dates.map(d=>`<tr><td class="date">${d}</td>${'<td>—</td>'.repeat(9)}</tr>`).join('');
    });
    preset.addEventListener('change', ()=>{
      const days=Number(preset.value)||7; const t=new Date(); const f=new Date(); f.setDate(t.getDate()-days+1);
      from.value = iso(f); to.value = iso(t);
    });
    run.addEventListener('click', ()=>{
      if(!from.value||!to.value) return toast('اختاري الفترة');
      buildReport(from.value, to.value);
    });

    // Boot
    (async function(){
      const {uid:U}=await ensureAuth(); uid=U; childId=requireChildIdFromQuery();
      // nav
      const nav=document.getElementById('childNav'); nav.innerHTML='';
      [['child-dashboard.html','الرئيسية'],['measures.html','قياسات السكر'],['meals.html','الوجبات'],['reports.html','التقارير'],['visits.html','الزيارات الطبية']]
      .forEach(([h,t])=>{ const a=document.createElement('a'); a.className='btn gray'; a.href=`${h}?child=${encodeURIComponent(childId)}`; a.textContent=t; nav.appendChild(a);});
      document.getElementById('lnkHome').href=`child-dashboard.html?child=${encodeURIComponent(childId)}`;

      await loadChild();
      // افتراضي: آخر 7 أيام
      const d=new Date(); const f=new Date(); f.setDate(d.getDate()-6);
      from.value = todayISO(); to.value = todayISO(); // ممكن تخليها f→d لو حابة
    })();
  </script>
</body>
</html>
