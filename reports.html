<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø·ÙÙ„</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    @media print { @page{ size: A4 landscape; margin: 8mm } .no-print{display:none!important} }
  </style>
</head>
<body>

  <!-- âœ… Ø¨Ù†Ø± Ø§Ù„Ø·ÙÙ„ -->
  <div id="childBanner" style="text-align:center; padding:12px 8px; display:none">
    <img id="bannerAvatar" class="avatar" style="width:84px;height:84px" src="images/avatar-default.png" alt="ØµÙˆØ±Ø© Ø§Ù„Ø·ÙÙ„">
    <div style="margin-top:6px;font-weight:800" id="bannerName">â€”</div>
    <div class="note" id="bannerMeta">â€”</div>
  </div>

  <!-- âœ… Topbar -->
  <div class="topbar">
    <div>ğŸ“„ ØªÙ‚Ø§Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</div>
    <div class="row">
      <a id="lnkHome" class="btn gray">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <button id="btnBlank" class="btn">ÙˆØ±Ù‚Ø© ÙØ§Ø±ØºØ© (7 Ø£ÙŠØ§Ù…)</button>
      <button id="btnPrint" class="btn">Ø·Ø¨Ø§Ø¹Ø© PDF</button>
    </div>
  </div>

  <main class="container">
    <!-- âœ… Nav -->
    <div class="card"><div class="row" id="childNav"></div></div>

    <section class="card">
      <div class="grid g4 no-print">
        <div><label>Ù…Ù†</label><input id="from" type="date"></div>
        <div><label>Ø¥Ù„Ù‰</label><input id="to" type="date"></div>
        <div><label>Ø§Ù„Ù…Ø¯Ù‰ Ø§Ù„Ø³Ø±ÙŠØ¹</label>
          <select id="preset">
            <option value="7">Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</option>
            <option value="14">Ø¢Ø®Ø± 14 ÙŠÙˆÙ…</option>
            <option value="30">Ø¢Ø®Ø± 30 ÙŠÙˆÙ…</option>
          </select>
        </div>
        <div style="display:flex;align-items:end"><button id="run" class="btn primary" style="width:100%">Ø¹Ø±Ø¶</button></div>
      </div>
      <div id="meta" class="note" style="margin:6px 0">â€”</div>

      <div class="card" style="margin-top:8px">
        <table class="table" id="rep">
          <thead>
            <tr>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸</th>
              <th>Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±</th><th>Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±</th>
              <th>Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡</th><th>Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡</th>
              <th>Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡</th><th>Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡</th>
              <th>Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…</th><th>Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…</th>
            </tr>
          </thead>
          <tbody id="rows"><tr><td colspan="10" class="center note">Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„ÙØªØ±Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</td></tr></tbody>
        </table>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>
  <div id="loader" class="loader"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>

  <script type="module">
    import { auth, db, ensureAuth, requireChildIdFromQuery, setChildAvatar, todayISO } from './firebase-init.js';
    import { signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { doc, getDoc, collection, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const toast=(m)=>{const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000)}
    const showLoader=(on)=>{document.getElementById('loader').style.display=on?'flex':'none'}

    const labels={
      uponWake:'Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸',preBreakfast:'Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±',postBreakfast:'Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±',
      preLunch:'Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡',postLunch:'Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡',
      preDinner:'Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡',postDinner:'Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡',
      beforeSleep:'Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…',duringSleep:'Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…'
    };
    const order=['uponWake','preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep'];

    let uid=null, childId=null, child=null;

    function buildNav(){
      const row=document.getElementById('childNav'); row.innerHTML='';
      [['child-dashboard.html','Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'],['measures.html','Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ±'],['meals.html','Ø§Ù„ÙˆØ¬Ø¨Ø§Øª'],['reports.html','Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±'],['visits.html','Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©']]
      .forEach(([h,t])=>{ const a=document.createElement('a'); a.className='btn gray'; a.href=`${h}?child=${encodeURIComponent(childId)}`; a.textContent=t; row.appendChild(a);});
      document.getElementById('lnkHome').href=`child-dashboard.html?child=${encodeURIComponent(childId)}`;
    }

    async function loadChild(){
      const s=await getDoc(doc(db,'users',uid,'children',childId));
      child=s.data()||{};
      setChildAvatar(document.getElementById('bannerAvatar'), child.name, child.photoURL);
      bannerName.textContent=child.name||'â€”';
      bannerMeta.textContent=`${child.gender||'â€”'} â€¢ ${child.weight||'â€”'} ÙƒØ¬Ù… â€¢ ${child.height||'â€”'} Ø³Ù…`;
      childBanner.style.display='block';
    }

    function iso(d){ return d.toISOString().slice(0,10); }
    function addDays(date, n){ const d=new Date(date); d.setDate(d.getDate()+n); return d; }
    function rangeDays(from,to){ const out=[]; let d=new Date(from); const end=new Date(to); while(d<=end){ out.push(iso(d)); d.setDate(d.getDate()+1);} return out; }
    function round1(n){ const v=Math.round(Number(n)*10)/10; return Number.isFinite(v)?v:null }
    function stateIcon(v,lo,hi){ if(v==null) return ''; if(isFinite(lo)&&v<lo) return 'â¬‡ï¸'; if(isFinite(hi)&&v>hi) return 'â¬†ï¸'; return 'ğŸŸ¢'; }

    async function buildReport(from, to){
      showLoader(true);
      const dates=rangeDays(from,to);
      const snaps=await Promise.all(dates.map(d=>getDoc(doc(db,'users',uid,'children',childId,'measurements',d))));
      const lo=Number(child?.lowThreshold), hi=Number(child?.highThreshold);

      // Meals-index by date+slot (ÙˆØ¬ÙˆØ¯ Ø±Ù…Ø² ğŸ½ï¸)
      const mealsQ = await getDocs(query(collection(db,'users',uid,'children',childId,'meals'), where('time','>=', from), where('time','<=', addDays(to,1).toISOString())));
      const mealMap = new Map(); // key: date|slot -> true
      mealsQ.forEach(s=>{
        const m=s.data(); if(!m?.time) return;
        const date=(new Date(m.time)).toISOString().slice(0,10);
        // Ù…Ø´ Ù…Ø±ØªØ¨Ø· Ø¨ÙˆÙ‚Øª Ù…Ø­Ø¯Ø¯ØŒ Ù‡Ù†ÙƒØªÙÙŠ Ø¨Ø¥Ø¸Ù‡Ø§Ø± ğŸ½ï¸ ÙÙŠ Ø£ÙŠ Ø®Ù„ÙŠØ© Ø§Ù„ÙŠÙˆÙ… ÙÙŠÙ‡Ø§ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚ÙŠØ§Ø³ + ÙˆØ¬Ø¨Ø©
        mealMap.set(date, true);
      });

      const tbody=document.getElementById('rows'); let html='';
      snaps.forEach((snap,i)=>{
        const d=dates[i]; const data=snap.data()||{}; const r=data.readings||{};
        let row=`<tr><td class="date">${d}</td>`;
        order.forEach(slot=>{
          const x=r[slot]; if(!x||x.valueMmol==null){ row+=`<td>â€”</td>`; return; }
          const v=round1(x.valueMmol); const icon=stateIcon(v,lo,hi);
          const note=(x.note||x.raisedWith)? `<div class="note">${escapeHTML(x.note||x.raisedWith)}</div>`:'';
          const mealMark = mealMap.has(d)? ' ğŸ½ï¸' : '';
          const doseTxt = [x.mealDose!=null?`Ø¬Ø±Ø¹Ø©: ${x.mealDose}U`: '', x.correctionGiven!=null?`ØªØµØ­ÙŠØ­: ${x.correctionGiven}U`: ''].filter(Boolean).join(' â€¢ ');
          row+=`<td><div><b>${v?.toFixed(1)||''} ${icon}${mealMark}</b></div>${doseTxt?`<div class="note">${doseTxt}</div>`:''}${note}</td>`;
        });
        row+='</tr>';
        html+=row;
      });
      tbody.innerHTML = html || `<tr><td colspan="10" class="center note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª.</td></tr>`;

      meta.textContent = `Ø§Ù„Ø·ÙÙ„: ${child?.name||'â€”'} â€¢ Ø§Ù„ÙØªØ±Ø©: ${from} â†’ ${to} â€¢ Ø­Ø¯ÙˆØ¯: Ù…Ù†Ø®ÙØ¶ < ${child?.lowThreshold??'â€”'} â€” Ù…Ø±ØªÙØ¹ > ${child?.highThreshold??'â€”'}`;
      showLoader(false);
    }

    function escapeHTML(s){return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]))}

    // Ø£Ø­Ø¯Ø§Ø«
    btnPrint.addEventListener('click', ()=>window.print());
    btnBlank.addEventListener('click', ()=>{
      const today=new Date(); const dates=Array.from({length:7},(_,i)=>{const d=new Date(today); d.setDate(today.getDate()+i); return d.toISOString().slice(0,10);});
      rows.innerHTML = dates.map(d=>`<tr><td class="date">${d}</td>${'<td>â€”</td>'.repeat(9)}</tr>`).join('');
    });
    preset.addEventListener('change', ()=>{
      const days=Number(preset.value)||7; const t=new Date(); const f=new Date(); f.setDate(t.getDate()-days+1);
      from.value = iso(f); to.value = iso(t);
    });
    run.addEventListener('click', ()=>{
      if(!from.value||!to.value) return toast('Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„ÙØªØ±Ø©');
      buildReport(from.value, to.value);
    });

    // Boot
    (async function(){
      const {uid:U}=await ensureAuth(); uid=U; childId=requireChildIdFromQuery();
      // nav
      const nav=document.getElementById('childNav'); nav.innerHTML='';
      [['child-dashboard.html','Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'],['measures.html','Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ±'],['meals.html','Ø§Ù„ÙˆØ¬Ø¨Ø§Øª'],['reports.html','Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±'],['visits.html','Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©']]
      .forEach(([h,t])=>{ const a=document.createElement('a'); a.className='btn gray'; a.href=`${h}?child=${encodeURIComponent(childId)}`; a.textContent=t; nav.appendChild(a);});
      document.getElementById('lnkHome').href=`child-dashboard.html?child=${encodeURIComponent(childId)}`;

      await loadChild();
      // Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…
      const d=new Date(); const f=new Date(); f.setDate(d.getDate()-6);
      from.value = todayISO(); to.value = todayISO(); // Ù…Ù…ÙƒÙ† ØªØ®Ù„ÙŠÙ‡Ø§ fâ†’d Ù„Ùˆ Ø­Ø§Ø¨Ø©
    })();
  </script>
</body>
</html>
