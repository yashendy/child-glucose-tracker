<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ù„ÙˆØ­Ø© Ø§Ù„Ø·ÙÙ„ â€” Ù…ØªØ§Ø¨Ø¹Ø© Ø³ÙƒØ± Ø§Ù„Ø£Ø·ÙØ§Ù„</title>
<style>
:root{
  --brand:#0ea5e9;--brand2:#6ee7b7;--line:#e5e7eb;--ink:#0f172a;--muted:#6b7280;
  --bg:#f6fbff;--card:#fff;--ok:#10b981;--warn:#d97706;--bad:#ef4444;--chip:#eef6ff;--hi:#f97316
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.6 "Tajawal",system-ui,sans-serif;display:flex;min-height:100vh}

/* Sidebar */
.sidebar{width:260px;flex:0 0 260px;background:linear-gradient(180deg,var(--brand),var(--brand2));color:#fff;padding:16px;position:sticky;top:0;height:100vh;overflow:auto}
.sb-title{font-weight:800;font-size:18px;margin-bottom:12px}
.sb-btn{display:block;width:100%;text-align:right;background:transparent;border:none;color:#fff;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700;margin:4px 0}
.sb-btn:hover,.sb-btn.active{background:rgba(255,255,255,.18)}
.spacer{height:6px}

/* Header */
.main{flex:1;min-width:0}
header{position:sticky;top:0;z-index:10;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
.head-left{display:flex;align-items:center;gap:12px}
.kid-photo{width:56px;height:56px;border-radius:16px;overflow:hidden;border:2px solid #ffffffbf;background:#fff;display:grid;place-items:center}
.kid-photo img{width:100%;height:100%;object-fit:cover;display:block}
.avatar-fallback{width:100%;height:100%;display:none;place-items:center;background:#e0f7fa;color:#0f172a;font-weight:800;font-size:18px}
.title-wrap{display:flex;flex-direction:column}
.hello{font-size:14px;opacity:.9}
.kid-name{font-size:18px;font-weight:800}
.head-actions{display:flex;gap:8px;flex-wrap:wrap}
.btn{border:none;border-radius:10px;padding:8px 12px;font-weight:800;cursor:pointer}
.btn.gray{background:#eef2f7}
.btn.dark{background:#0f172a;color:#fff}
.btn.primary{background:var(--brand);color:#fff}
.btn.orange{background:var(--hi);color:#fff}

main{max-width:1200px;margin:auto;padding:16px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.05);margin-bottom:14px}
.note{color:var(--muted);font-size:14px}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--chip);color:#0f172a;font-size:12px;margin-inline-start:6px}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px}
input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
textarea{min-height:90px;resize:vertical}
.grid{display:grid;gap:12px}
.g2{grid-template-columns:repeat(2,minmax(0,1fr))}
.g3{grid-template-columns:repeat(3,minmax(0,1fr))}
@media (max-width:900px){.g3{grid-template-columns:1fr 1fr}}
@media (max-width:680px){.g2,.g3{grid-template-columns:1fr}}

table{width:100%;border-collapse:collapse}
th,td{border:1px solid var(--line);padding:8px;text-align:center}
th{background:#f0f9ff}
.status{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px}
.ok{background:#ecfdf5;color:#10b981}
.high{background:#fee2e2;color:#ef4444}
.low{background:#fff7ed;color:#b45309}
.section{display:none}
.section.active{display:block}

/* ===== Reports (weekly) ===== */
.wk-controls .pill{background:#f1f5f9;border-radius:999px;padding:4px 8px;font-size:12px}
.wk-wrap{display:grid;grid-template-columns:1fr;gap:12px}
.page{page-break-after:always}
.page:last-child{page-break-after:auto}
.page-title{font-weight:800;margin:6px 0 10px}
.day-card{border:1px solid var(--line);border-radius:14px;background:#fff;padding:12px;display:flex;flex-direction:column;gap:10px}
.day-head{display:flex;justify-content:space-between;align-items:center}
.day-date{font-weight:800}
.legend{font-size:12px;color:#475569}
.day-table{width:100%;border-collapse:separate;border-spacing:0}
.day-table th,.day-table td{border:1px solid #e2e8f0;padding:6px;font-size:13px;text-align:center;vertical-align:top}
.slot-name{font-weight:800;color:#334155}
.val{font-weight:800}
.arrow-up{color:#ef4444}.arrow-down{color:#d97706}.arrow-ok{color:#10b981}
.mnote{font-size:12px;color:#475569;margin-top:2px}
.meal-mini{font-size:12px;color:#7c2d12;background:#fff7ef;border:1px solid #ffd1b2;border-radius:8px;padding:2px 6px;display:inline-block;margin-top:4px}
.kpis{display:flex;flex-wrap:wrap;gap:8px}
.chip{background:#f1f5f9;border-radius:999px;padding:6px 10px;font-size:12px}

/* ===== Meals ===== */
.meals-layout{display:grid;grid-template-columns:220px 1fr;gap:12px}
.cats{display:flex;flex-direction:column;gap:8px;max-height:480px;overflow:auto}
.cat-btn{border:1px solid var(--line);background:#fff;padding:8px;border-radius:10px;text-align:right;cursor:pointer}
.cat-btn.active,.cat-btn:hover{background:#eff6ff;border-color:#bfdbfe}
.foods-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:12px}
.food-card{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff;display:flex;flex-direction:column;gap:6px}
.food-card img{width:90px;height:90px;object-fit:contain;margin:auto}
.food-name{font-weight:800;text-align:center}
.food-carb{font-size:12px;color:#0f766e;text-align:center}
.mode-tabs{display:flex;gap:6px;justify-content:center}
.mode-tabs button{border:1px solid var(--line);background:#fff;padding:4px 8px;border-radius:999px;cursor:pointer;font-size:12px}
.mode-tabs button.active{background:#0ea5e9;color:#fff;border-color:#0ea5e9}
.qty-row{display:flex;gap:6px;align-items:center;justify-content:center}
.small{font-size:12px;color:var(--muted)}
.basket table tfoot td{font-weight:800}
@media(max-width:900px){.meals-layout{grid-template-columns:1fr}}

/* Print */
@media print{
  @page{size:A4 portrait;margin:10mm}
  header,.no-print,.sidebar{display:none!important}
  body{background:#fff;font-size:12px}
  .card{border:0;box-shadow:none;padding:0;margin:0}
  main{max-width:100%;padding:0}
  .page{page-break-after:always}
  .page:last-child{page-break-after:auto}
}
</style>
</head>
<body>

<!-- Sidebar -->
<aside class="sidebar">
  <div class="sb-title">ğŸ‘§ Ù„ÙˆØ­Ø© Ø§Ù„Ø·ÙÙ„</div>
  <button class="sb-btn active" data-target="sec-home">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
  <div class="spacer"></div>
  <button class="sb-btn" data-target="sec-info">âš™ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„</button>
  <button class="sb-btn" data-target="sec-measure">ğŸ“ Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ±</button>
  <button class="sb-btn" data-target="sec-meals">ğŸ½ï¸ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª</button>
  <button class="sb-btn" data-target="sec-reports">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
  <button class="sb-btn" data-target="sec-doctor">ğŸ§‘â€âš•ï¸ Ø§Ù„Ø·Ø¨ÙŠØ¨</button>
  <button class="sb-btn" data-target="sec-visits">ğŸ“… Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©</button>
</aside>

<div class="main">
  <!-- Header -->
  <header>
    <div class="head-left">
      <div class="kid-photo">
        <img id="childPhoto" alt="ØµÙˆØ±Ø© Ø§Ù„Ø·ÙÙ„">
        <div id="avatarFallback" class="avatar-fallback">ğŸ‘§</div>
      </div>
      <div class="title-wrap">
        <div class="hello">Ù…Ø±Ø­Ø¨Ù‹Ø§ ğŸ‘‹</div>
        <div id="kidName" class="kid-name">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
      </div>
    </div>
    <div class="head-actions">
      <a class="btn gray" href="dashboard.html">Ù„ÙˆØ­Ø© ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±</a>
      <button id="btnLogout" class="btn dark">Ø®Ø±ÙˆØ¬</button>
    </div>
  </header>

  <main>
    <!-- Home -->
    <section id="sec-home" class="section active">
      <div class="card"><div class="note">Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙŠÙ…Ù†Ù‰ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.</div></div>
    </section>

    <!-- (1) Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„ -->
    <section id="sec-info" class="section">
      <div class="card">
        <h3>âš™ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„</h3>
        <div class="grid g3">
          <div><label>Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„</label><input id="childName"></div>
          <div>
            <label>Ø§Ù„Ù†ÙˆØ¹</label>
            <div class="row" style="gap:14px">
              <label><input type="radio" name="gender" value="male"> Ø°ÙƒØ±</label>
              <label><input type="radio" name="gender" value="female"> Ø£Ù†Ø«Ù‰</label>
            </div>
          </div>
          <div><label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ</label><input id="childCivilId"></div>
          <div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label><input id="dob" type="date"></div>
          <div><label>Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)</label><input id="heightCm" type="number" step="0.1" dir="ltr"></div>
          <div><label>Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)</label><input id="weightKg" type="number" step="0.1" dir="ltr"></div>
          <div><label>Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø©</label><select id="preferredUnit"><option value="mmol">mmol/L</option><option value="mgdl">mg/dL</option></select></div>
          <div><label>Ù†ÙˆØ¹ Ø§Ù„Ù‚ÙŠØ§Ø³ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</label>
            <select id="defaultMeasurementType">
              <option value="fingerstick">ğŸ©¸ ÙØ­Øµ Ø¥ØµØ¨Ø¹</option>
              <option value="cgm">ğŸ“ˆ CGM</option>
              <option value="lab">ğŸ§ª Ù…Ø®ØªØ¨Ø±</option>
              <option value="other">âœ³ï¸ Ø£Ø®Ø±Ù‰</option>
            </select>
          </div>
          <div style="grid-column:1/-1"><label>Ø±Ø§Ø¨Ø· ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input id="photoUrl" placeholder="https://..."></div>
          <div style="grid-column:1/-1"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><input id="notes" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="btnSaveInfo" class="btn primary">ğŸ’¾ Ø­ÙØ¸</button>
        </div>
      </div>

      <div class="card">
        <h3>ğŸ§ª Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø³ ÙˆØ§Ù„Ø¬Ø±Ø¹Ø§Øª <span class="badge">Ø§Ù„Ø¹Ø±Ø¶ Ø¯Ø§Ø¦Ù…Ù‹Ø§ mmol/L (1 decimal)</span></h3>
        <div class="grid g3">
          <div><label>Ø§Ù„Ù‡Ø¯Ù</label><input id="target" type="number" step="0.1" dir="ltr"></div>
          <div><label>Ø­Ø¯ Ø§Ù„Ù‡Ø¨ÙˆØ·</label><input id="low" type="number" step="0.1" dir="ltr"></div>
          <div><label>Ø­Ø¯ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹</label><input id="high" type="number" step="0.1" dir="ltr"></div>
          <div><label>ØªØ±Ø³ÙŠØ¨Ø§ (U/Day)</label><input id="tresiba" type="number" step="0.5" dir="ltr"></div>
          <div><label>TDI (U)</label><input id="tdi" type="number" step="0.5" dir="ltr"></div>
          <div><label>ISF (mmol/L Ù„ÙƒÙ„ ÙˆØ­Ø¯Ø©)</label><input id="isf" type="number" step="0.1" dir="ltr"></div>
          <div><label>ICR (Ø¬Ø±Ø§Ù…/ÙˆØ­Ø¯Ø©)</label><input id="icr" type="number" step="0.1" dir="ltr"></div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="btnSuggest" class="btn gray">ğŸ’¡ Ø§Ø­Ø³Ø¨ Ù…Ù† TDI</button>
          <button id="btnSaveGlucose" class="btn primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </div>
        <div class="note" style="margin-top:6px">Ø§Ù‚ØªØ±Ø§Ø­ Ø³Ø±ÙŠØ¹: ISFâ‰ˆ100/TDI â€¢ ICRâ‰ˆ500/TDI</div>
      </div>
    </section>

    <!-- (2) Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ± -->
    <section id="sec-measure" class="section">
      <div class="card">
        <h3>ğŸ“ Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ± <span class="badge">mmol/L â€” Ù…Ù†Ø²Ù„Ø© Ø¹Ø´Ø±ÙŠØ© ÙˆØ§Ø­Ø¯Ø©</span></h3>
        <div class="grid g3">
          <div><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="dateSel" /></div>
          <div><label>ÙˆÙ‚Øª Ø§Ù„Ù‚ÙŠØ§Ø³</label>
            <select id="slotSel">
              <option value="">â€” Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„ÙˆÙ‚Øª â€”</option>
              <option value="uponWake">Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸</option>
              <option value="preBreakfast">Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±</option>
              <option value="postBreakfast">Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±</option>
              <option value="preLunch">Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡</option>
              <option value="postLunch">Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡</option>
              <option value="preDinner">Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡</option>
              <option value="postDinner">Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡</option>
              <option value="beforeSleep">Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…</option>
              <option value="duringSleep">Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…</option>
              <option value="beforeExercise">Ù‚Ø¨Ù„ Ø§Ù„ØªÙ…Ø±ÙŠÙ†</option>
              <option value="afterExercise">Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠÙ†</option>
              <option value="random">Ù‚ÙŠØ§Ø³ Ø¹Ø´ÙˆØ§Ø¦ÙŠ</option>
              <option value="other">Ø£Ø®Ø±Ù‰</option>
            </select>
          </div>
          <div><label>Ù†ÙˆØ¹ Ø§Ù„Ù‚ÙŠØ§Ø³</label>
            <select id="mType">
              <option value="fingerstick">ğŸ©¸ ÙØ­Øµ Ø¥ØµØ¨Ø¹</option>
              <option value="cgm">ğŸ“ˆ CGM</option>
              <option value="lab">ğŸ§ª Ù…Ø®ØªØ¨Ø±</option>
              <option value="other">âœ³ï¸ Ø£Ø®Ø±Ù‰</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card">
        <h3>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù‚ÙŠØ§Ø³ ÙˆØ§Ù„ÙˆØ¬Ø¨Ø©</h3>
        <div class="grid g3">
          <div><label>Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</label><input type="number" id="reading" step="0.1" min="0" dir="ltr"/><div id="statusBadge" class="status ok" style="display:none;"></div></div>
          <div><label>ÙƒØ§Ø±Ø¨ (Ø¬Ù…)</label><input type="number" id="carbs" step="0.1" min="0" dir="ltr"/></div>
          <div><label>Ø¬Ø±Ø¹Ø© Ù…Ù‚ØªØ±Ø­Ø© (ICR)</label><input type="number" id="suggestedDose" readonly></div>
          <div><label>Ø¬Ø±Ø¹Ø© ÙØ¹Ù„ÙŠØ©</label><input type="number" id="mealDose" step="0.1" dir="ltr"/></div>
          <div id="correctionSection" style="display:none;"><label>Ø¬Ø±Ø¹Ø© ØªØµØ­ÙŠØ­ÙŠØ©</label><input type="number" id="correction" step="0.1" dir="ltr"/></div>
          <div id="raiseSection" style="display:none;"><label>Ø±ÙØ¹ Ø§Ù„Ø³ÙƒØ±</label><input type="text" id="raise"/></div>
          <div style="grid-column:1/-1"><label>Ù…Ù„Ø§Ø­Ø¸Ø©</label><textarea id="note" rows="2"></textarea></div>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn primary" id="saveBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³</button>
          <button class="btn gray" id="reloadDay">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª</button>
        </div>
      </div>

      <div class="card">
        <h3>Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
        <table>
          <thead><tr><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¬Ø±Ø¹Ø© Ø§Ù„ÙˆØ¬Ø¨Ø©</th><th>Ø§Ù„ØªØµØ­ÙŠØ­/Ø§Ù„Ø±ÙØ¹</th><th>Ù†ÙˆØ¹ Ø§Ù„Ù‚ÙŠØ§Ø³</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th></tr></thead>
          <tbody id="rows"><tr><td colspan="7" class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø¡Ø§Øª Ù„Ù„ÙŠÙˆÙ….</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- (3) Ø§Ù„ÙˆØ¬Ø¨Ø§Øª -->
    <section id="sec-meals" class="section">
      <section class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h3 class="section-title">ğŸ½ï¸ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª</h3>
          <div class="row">
            <a href="foods-admin.html" class="btn orange">ğŸ—‚ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</a>
          </div>
        </div>

        <!-- Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆØ¬Ø¨Ø© -->
        <div class="grid g3" style="margin-bottom:10px">
          <div><label>Ù†ÙˆØ¹ Ø§Ù„ÙˆØ¬Ø¨Ø©</label>
            <select id="mealType">
              <option value="breakfast">ÙØ·ÙˆØ±</option>
              <option value="lunch">ØºØ¯Ø§Ø¡</option>
              <option value="dinner">Ø¹Ø´Ø§Ø¡</option>
              <option value="snack">Ø³Ù†Ø§Ùƒ</option>
              <option value="other">Ø£Ø®Ø±Ù‰</option>
            </select>
          </div>
          <div><label>ÙˆÙ‚Øª Ø§Ù„Ø£ÙƒÙ„</label><input id="mealTime" type="datetime-local"></div>
          <div><label>Ù…Ù„Ø§Ø­Ø¸Ø©</label><input id="mealNotes" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></div>
        </div>

        <div class="meals-layout">
          <!-- Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª -->
          <div>
            <div class="row" style="margin-bottom:8px"><input id="foodSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ØµÙ†Ù..." style="width:100%"></div>
            <div id="catList" class="cats"></div>
          </div>

          <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ø£ØµÙ†Ø§Ù + Ø§Ù„Ø³Ù„Ø© -->
          <div>
            <div id="foodsGrid" class="foods-grid"><div class="note">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>

            <!-- Ø§Ù„Ø³Ù„Ø© -->
            <div class="card" style="margin-top:12px">
              <div class="row" style="justify-content:space-between">
                <h4 style="margin:0">ğŸ§º Ø³Ù„Ø© Ø§Ù„ÙˆØ¬Ø¨Ø©</h4>
                <div class="small">ICR Ø§Ù„Ø­Ø§Ù„ÙŠ: <b id="icrNow">â€”</b> g/U</div>
              </div>
              <div class="basket" style="margin-top:8px;overflow:auto">
                <table>
                  <thead><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„ÙƒØ§Ø±Ø¨ (Ø¬Ù…)</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                  <tbody id="basketBody"><tr><td colspan="4" class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ø¨Ø¹Ø¯.</td></tr></tbody>
                  <tfoot><tr><td><b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</b></td><td></td><td id="totalCarbsCell">0.0</td><td></td></tr></tfoot>
                </table>
              </div>

              <div class="grid g3" style="margin-top:10px">
                <div><label>Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©</label><input id="doseSuggestedMeal" readonly></div>
                <div><label>Ø¬Ø±Ø¹Ø© ÙØ¹Ù„ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input id="doseGivenMeal" type="number" step="0.1" dir="ltr"></div>
                <div class="row" style="align-items:flex-end;justify-content:flex-end">
                  <button id="saveMealBtn" class="btn primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙˆØ¬Ø¨Ø©</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="note" style="margin-top:8px">Ø§Ù„Ø­Ø³Ø§Ø¨: (Ø§Ù„Ø¬Ø±Ø§Ù…Ø§Øª Ã— ÙƒØ§Ø±Ø¨/100) Ã· 100 â€¢ Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© = Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ§Ø±Ø¨ Ã· ICR (ØªÙ‚Ø±ÙŠØ¨ 0.1U).</div>
      </section>
    </section>

    <!-- (4) Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± (Ø£Ø³Ø¨ÙˆØ¹ÙŠ A4ØŒ 7 Ø£ÙŠØ§Ù…/ØµÙØ­Ø©) -->
    <section id="sec-reports" class="section">
      <div class="card wk-controls">
        <h3>ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠ (mmol/L â€” Ù…Ù†Ø²Ù„Ø© Ø¹Ø´Ø±ÙŠØ© ÙˆØ§Ø­Ø¯Ø©) â€” PDF Ø¯Ø§Ø®Ù„ Ø§Ù„ØµÙØ­Ø©</h3>
        <div class="row no-print" style="gap:8px">
          <span class="pill">Ø§Ù„ÙØªØ±Ø©:</span>
          <select id="weekPreset">
            <option value="last7">Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</option>
            <option value="thisWeek">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ</option>
            <option value="prevWeek">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø³Ø§Ø¨Ù‚</option>
            <option value="custom">Ù…Ø®ØµØµ</option>
          </select>
          <input id="fromW" type="date">
          <input id="toW" type="date">
          <button id="runWeekly" class="btn primary">Ø¹Ø±Ø¶</button>
          <button id="printWeekly" class="btn gray">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© / PDF</button>
          <button id="printBlank" class="btn gray">ğŸ“ ÙˆØ±Ù‚Ø© ÙØ§Ø±ØºØ© (7 Ø£ÙŠØ§Ù…/ØµÙØ­Ø©)</button>
        </div>
        <div id="reportHeader" class="note" style="margin-top:6px"></div>
      </div>

      <div id="kpisBox" class="card" style="display:none">
        <div id="kpis" class="kpis"></div>
      </div>

      <div id="weeklyBox" class="card" style="display:none">
        <div id="pagesWrap"></div>
        <div class="note" style="margin-top:10px">
          Ù…ÙØªØ§Ø­ Ø§Ù„Ø±Ù…ÙˆØ²: ğŸŸ¢ Ø·Ø¨ÙŠØ¹ÙŠ â€¢ <span class="arrow-up">â¬†ï¸</span> Ù…Ø±ØªÙØ¹ â€¢ <span class="arrow-down">â¬‡ï¸</span> Ù…Ù†Ø®ÙØ¶
        </div>
      </div>
    </section>

    <!-- (5) Ø§Ù„Ø·Ø¨ÙŠØ¨ (Ù…Ù„Ø®Ù‘Øµ ÙˆØ±Ø³ÙˆÙ… Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯) -->
    <section id="sec-doctor" class="section">
      <div class="card">
        <h3>ğŸ§‘â€âš•ï¸ Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ø¨ÙŠØ¨</h3>
        <div class="row no-print" style="gap:8px">
          <label>Ù…Ù†</label><input id="docFrom" type="date">
          <label>Ø¥Ù„Ù‰</label><input id="docTo" type="date">
          <button class="btn primary" id="docRun">Ø¹Ø±Ø¶</button>
          <button class="btn gray" id="docPrint">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
          <button class="btn gray" id="docXlsx">ğŸ“¤ Excel</button>
        </div>
        <div id="docMeta" class="note" style="margin-top:6px"></div>
      </div>

      <div class="card">
        <div class="grid g3" style="grid-template-columns:2fr 2fr 1.2fr;align-items:start">
          <div>
            <div class="small">Ù…ØªÙˆØ³Ø· ÙƒÙ„ ÙˆÙ‚Øª (mmol/L)</div>
            <canvas id="chartSlots" height="180"></canvas>
          </div>
          <div>
            <div class="small">Ù…ØªÙˆØ³Ø· Ø§Ù„ÙŠÙˆÙ… (mmol/L)</div>
            <canvas id="chartTrend" height="180"></canvas>
          </div>
          <div id="donutBox">
            <div class="small">Ù†Ø³Ø¨ Low/OK/High</div>
            <canvas id="chartDonut" height="180"></canvas>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="kpis" id="docKPIs"></div>
      </div>

      <div class="card">
        <table>
          <thead><tr>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±</th><th>Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±</th>
            <th>Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡</th><th>Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡</th>
            <th>Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡</th><th>Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡</th>
            <th>Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…</th><th>Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…</th><th>Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸</th>
          </tr></thead>
          <tbody id="docRows"><tr><td colspan="10" class="note">Ø§Ø®ØªØ§Ø±ÙŠ ÙØªØ±Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- (6) Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ© -->
    <section id="sec-visits" class="section"><div class="card"><div class="note">ğŸ“… Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ© â€” Ù‚Ø±ÙŠØ¨Ù‹Ø§.</div></div></section>
  </main>
</div>

<!-- Toast -->
<div id="toast" style="position:fixed;bottom:16px;left:16px;background:#111;color:#fff;padding:10px 14px;border-radius:12px;opacity:0;transform:translateY(6px);transition:.25s"></div>

<!-- Ù…ÙƒØªØ¨Ø§Øª Ù„Ù„Ø·Ø¨ÙŠØ¨ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script type="module">
/* ===== Imports ===== */
import { db, auth } from './firebase-init.js';
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import {
  doc, getDoc, setDoc, collection, getDocs, addDoc, serverTimestamp, query, where, orderBy
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

/* ===== Helpers / UI ===== */
const $=s=>document.querySelector(s), $$=s=>[...document.querySelectorAll(s)];
const toast=msg=>{const t=$('#toast');t.textContent=msg;t.style.opacity=1;t.style.transform='translateY(0)';setTimeout(()=>{t.style.opacity=0;t.style.transform='translateY(6px)'},2000)};
const numOrNull=el=>{const v=typeof el==='string'?el:el.value;if(v===''||v==null)return null;const n=Number(v);return Number.isFinite(n)?n:null};
const escapeHTML=str=>(str||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
const fmtDDMMYYYY=iso=>{if(!iso)return'â€”';const d=new Date(iso);const p=n=>String(n).padStart(2,'0');return `${p(d.getDate())}/${p(d.getMonth()+1)}/${d.getFullYear()}`};
const fmtISO=d=>{const p=n=>String(n).padStart(2,'0');return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`};
const addDays=(d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x};
const startOfWeek=d=>{const x=new Date(d);const day=(x.getDay()+6)%7;x.setDate(x.getDate()-day);return x};
const endOfWeek=d=>addDays(startOfWeek(d),6);
const enumerateDays=(from,to)=>{const res=[];let d=new Date(from+"T00:00:00");const e=new Date(to+"T00:00:00");while(d<=e){res.push(fmtISO(d));d=addDays(d,1)}return res};
const chunk=(arr,size)=>arr.reduce((a,_,i)=>i%size? a : [...a,arr.slice(i,i+size)],[]);

/* ===== Sidebar Nav ===== */
$$('.sb-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    $$('.sb-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');
    $$('.section').forEach(s=>s.classList.remove('active'));$('#'+btn.dataset.target).classList.add('active');
  });
});

/* ===== State ===== */
let uid=null;
const params=new URLSearchParams(location.search);
const childId=params.get('child');
let lowMmol=null,highMmol=null,targetMmol=null,icr=null,isf=null,tdi=null,tresiba=null;

/* ===== Conversions / Status ===== */
const toMmol=v=>v==null?null:v;               // Ù†Ø®Ø²Ù†/Ù†Ø¹Ø±Ø¶ mmol Ø¨Ø§Ù„ÙØ¹Ù„
const mmol1=v=>v==null?'â€”':Number(v).toFixed(1); // Ù…Ù†Ø²Ù„Ø© ÙˆØ§Ø­Ø¯Ø©
const classify=mmol=>(lowMmol!=null&&mmol<lowMmol)?'low':(highMmol!=null&&mmol>highMmol)?'high':'ok';
const arrow=mmol=>mmol==null?'':(classify(mmol)==='low'?'â¬‡ï¸':classify(mmol)==='high'?'â¬†ï¸':'ğŸŸ¢');

/* ===== Header Avatar ===== */
const elName=$('#kidName'), img=$('#childPhoto'), fallback=$('#avatarFallback');
const slugify=s=>(s||'').trim().toLowerCase().replace(/\s+/g,'-').replace(/[^\u0600-\u06FF\w-]/g,'');
function setAvatarFallback(name,gender){
  const initials=(name||'').trim().split(/\s+/).slice(0,2).map(w=>w[0]||'').join('').toUpperCase();
  fallback.textContent=initials|| (gender==='male'?'ğŸ‘¦':'ğŸ‘§'); fallback.style.display='grid'; img.style.display='none';
}
function trySetPhoto(child){
  if(child.photoUrl){ img.src=child.photoUrl; img.onload=()=>{img.style.display='block';fallback.style.display='none'}; img.onerror=()=>setAvatarFallback(child.name,child.gender); return; }
  const byId=`images/${childId}.jpg`; // ÙÙ‚Ø· childId.jpg
  img.onload=()=>{img.style.display='block';fallback.style.display='none'};
  img.onerror=()=>setAvatarFallback(child.name,child.gender);
  img.src=byId;
}

/* ===== Auth / Boot ===== */
onAuthStateChanged(auth, async user=>{
  if(!user){location.href='index.html';return}
  uid=user.uid;
  $('#btnLogout').addEventListener('click',()=>signOut(auth).then(()=>location.href='index.html'));
  if(!childId){elName.textContent='Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø·ÙÙ„';setAvatarFallback('','');return}

  const cSnap=await getDoc(doc(db,'users',uid,'children',childId));
  if(!cSnap.exists()){elName.textContent='Ø§Ù„Ø·ÙÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯';setAvatarFallback('','');return}
  const c=cSnap.data();
  elName.textContent=c.name||'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
  trySetPhoto(c);

  // Fill info
  $('#childName').value=c.name||'';
  (c.gender && $$('input[name="gender"]').forEach(r=>r.checked=(r.value===c.gender)));
  $('#childCivilId').value=c.childCivilId||''; $('#dob').value=c.dob||'';
  $('#heightCm').value=c.heightCm ?? c.height ?? ''; $('#weightKg').value=c.weightKg ?? c.weight ?? '';
  $('#preferredUnit').value=c.preferredUnit||'mmol'; $('#defaultMeasurementType').value=c.defaultMeasurementType||'fingerstick'; $('#notes').value=c.notes||'';
  $('#photoUrl').value=c.photoUrl||'';

  const gc=c.glucoseConfig||{}; const ds=c.dosing||{};
  lowMmol=gc.lowThresholdMmol ?? c.lowThreshold ?? null;
  highMmol=gc.highThresholdMmol ?? c.highThreshold ?? null;
  targetMmol=gc.targetGlucoseMmol ?? c.targetMmol ?? null;
  $('#low').value=lowMmol??''; $('#high').value=highMmol??''; $('#target').value=targetMmol??'';
  tresiba=ds.basalTresibaUnits ?? c.tresiba ?? null;
  tdi=ds.totalDailyInsulinUnits ?? c.tdi ?? null;
  isf=ds.isfMmolPerUnit ?? c.correctionFactorMmol ?? null;
  icr=ds.icrGramsPerUnit ?? c.icr ?? null;
  $('#tresiba').value=tresiba??''; $('#tdi').value=tdi??''; $('#isf').value=isf??''; $('#icr').value=icr??'';

  bindInfoSavers(); initMeasures(); initMeals(); initWeeklyControls(); runWeeklyReport(); initDoctor();
});

/* ===== Save Info / Glucose ===== */
function bindInfoSavers(){
  $('#btnSaveInfo').addEventListener('click',async ()=>{
    const payload={
      name:$('#childName').value.trim()||null,
      gender:($$('input[name="gender"]').find(r=>r.checked)?.value||null),
      childCivilId:$('#childCivilId').value.trim()||null,
      dob:$('#dob').value||null,
      heightCm:numOrNull($('#heightCm')),weightKg:numOrNull($('#weightKg')),
      preferredUnit:$('#preferredUnit').value, defaultMeasurementType:$('#defaultMeasurementType').value||'fingerstick',
      notes:$('#notes').value.trim()||null,
      photoUrl:($('#photoUrl').value||'').trim()||null,
      lastUpdatedAt:new Date().toISOString()
    };
    try{await setDoc(doc(db,'users',uid,'children',childId),payload,{merge:true});toast('âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„')}catch(e){console.error(e);toast('â— Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸')}
  });

  $('#btnSuggest').addEventListener('click',()=>{
    const t=Number($('#tdi').value); if(!t||t<=0){toast('Ø£Ø¯Ø®Ù„ÙŠ TDI Ø£ÙˆÙ„Ù‹Ø§');return}
    const isfVal=+(100/t).toFixed(2), icrVal=+(500/t).toFixed(1);
    $('#isf').value=isfVal; $('#icr').value=icrVal; toast('ğŸ’¡ ØªÙ… Ø§Ù‚ØªØ±Ø§Ø­ ISF/ICR');
  });

  $('#btnSaveGlucose').addEventListener('click',async ()=>{
    const payload={
      glucoseConfig:{
        targetGlucoseMmol:numOrNull($('#target')),
        lowThresholdMmol:numOrNull($('#low')),
        highThresholdMmol:numOrNull($('#high'))
      },
      dosing:{
        basalTresibaUnits:numOrNull($('#tresiba')),
        totalDailyInsulinUnits:numOrNull($('#tdi')),
        isfMmolPerUnit:numOrNull($('#isf')),
        icrGramsPerUnit:numOrNull($('#icr'))
      },
      lastUpdatedAt:new Date().toISOString()
    };
    try{
      await setDoc(doc(db,'users',uid,'children',childId),payload,{merge:true});
      lowMmol=payload.glucoseConfig.lowThresholdMmol; highMmol=payload.glucoseConfig.highThresholdMmol; targetMmol=payload.glucoseConfig.targetGlucoseMmol;
      tresiba=payload.dosing.basalTresibaUnits; tdi=payload.dosing.totalDailyInsulinUnits; isf=payload.dosing.isfMmolPerUnit; icr=payload.dosing.icrGramsPerUnit;
      $('#icrNow').textContent = icr??'â€”';
      toast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
    }catch(e){console.error(e);toast('â— Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸')}
  });
}

/* ===== Measures ===== */
function initMeasures(){
  const today=new Date().toISOString().split('T')[0];
  $('#dateSel').value=today;
  $('#reloadDay').addEventListener('click',loadDay);
  $('#dateSel').addEventListener('change',loadDay);
  $('#mType').value = $('#defaultMeasurementType').value || 'fingerstick';

  $('#carbs').addEventListener('input',()=>{
    const c=Number($('#carbs').value); if(!icr||icr<=0||!Number.isFinite(c)){ $('#suggestedDose').value=''; return }
    const d=Math.round((c/icr)*10)/10; $('#suggestedDose').value=d.toFixed(1);
  });
  $('#reading').addEventListener('input',()=>{
    const val=Number($('#reading').value); if(!Number.isFinite(val)){ $('#statusBadge').style.display='none'; return }
    const mmol=toMmol(val); const cls=classify(mmol); const sb=$('#statusBadge');
    sb.className=`status ${cls}`; sb.textContent = cls==='low'?'Ù…Ù†Ø®ÙØ¶':cls==='high'?'Ù…Ø±ØªÙØ¹':'Ø·Ø¨ÙŠØ¹ÙŠ'; sb.style.display='inline-block';
    $('#correctionSection').style.display=(cls==='high')?'block':'none';
    $('#raiseSection').style.display=(cls==='low')?'block':'none';
  });
  $('#saveBtn').addEventListener('click',saveMeasure);
  loadDay();
}

async function loadDay(){
  const date=$('#dateSel').value; if(!date) return;
  const ref=doc(db,'users',uid,'children',childId,'measurements',date);
  const snap=await getDoc(ref); const readings=(snap.data()||{}).readings||{};
  renderDayRows(readings);
}

function renderDayRows(readings){
  const tbody=$('#rows');
  const labels={
    uponWake:'Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸',
    preBreakfast:'Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±', postBreakfast:'Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±',
    preLunch:'Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡', postLunch:'Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡',
    preDinner:'Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡', postDinner:'Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡',
    beforeSleep:'Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…', duringSleep:'Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…',
    beforeExercise:'Ù‚Ø¨Ù„ Ø§Ù„ØªÙ…Ø±ÙŠÙ†', afterExercise:'Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠÙ†',
    random:'Ù‚ÙŠØ§Ø³ Ø¹Ø´ÙˆØ§Ø¦ÙŠ', other:'Ø£Ø®Ø±Ù‰'
  };
  const order=['uponWake','preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep','beforeExercise','afterExercise','random','other'];
  const keys=order.filter(k=>readings[k]).concat(Object.keys(readings).filter(k=>!order.includes(k)));
  if(keys.length===0){tbody.innerHTML='<tr><td colspan="7" class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø¡Ø§Øª Ù„Ù„ÙŠÙˆÙ….</td></tr>';return}
  tbody.innerHTML='';
  for(const k of keys){
    const r=readings[k]; const mmol=r?.valueMmol ?? r?.value ?? null;
    const disp=mmol1(mmol); const cls=classify(mmol);
    const status=`<span class="status ${cls}">${cls==='low'?'Ù…Ù†Ø®ÙØ¶':cls==='high'?'Ù…Ø±ØªÙØ¹':'Ø·Ø¨ÙŠØ¹ÙŠ'}</span>`;
    const type=r?.measurementType==='cgm'?'ğŸ“ˆ CGM':r?.measurementType==='lab'?'ğŸ§ª Ù…Ø®ØªØ¨Ø±':r?.measurementType==='other'?'âœ³ï¸ Ø£Ø®Ø±Ù‰':'ğŸ©¸ ÙØ­Øµ Ø¥ØµØ¨Ø¹';
    const action=(r?.correction!=null)?`ØªØµØ­ÙŠØ­: ${r.correction}U`:(r?.raise?`Ø±ÙØ¹: ${escapeHTML(r.raise)}`:(r?.mealDose!=null?`${r.mealDose}U`:'-'));
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${labels[k]||k}</td><td>${disp} mmol/L</td><td>${status}</td><td>${r?.mealDose??'-'}</td><td>${action}</td><td>${type}</td><td>${escapeHTML(r?.note||'-')}</td>`;
    tbody.appendChild(tr);
  }
}

async function saveMeasure(){
  const date=$('#dateSel').value, slot=$('#slotSel').value, raw=Number($('#reading').value);
  if(!date||!slot||!Number.isFinite(raw)){toast('Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®/Ø§Ù„ÙˆÙ‚Øª/Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©');return}
  const ref=doc(db,'users',uid,'children',childId,'measurements',date);
  const snap=await getDoc(ref); const base=snap.exists()?snap.data():{date,readings:{}};
  if(base.readings[slot]?.valueMmol!=null || base.readings[slot]?.value!=null){toast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª Ù…Ø³Ø¨Ù‚Ù‹Ø§');return}
  const mmol=toMmol(raw);
  base.readings[slot]={
    valueMmol:+Number(mmol).toFixed(2),displayUnit:'mmol',
    measurementType:$('#mType').value||$('#defaultMeasurementType').value||'fingerstick',
    note:($('#note').value||'').trim()||null,
    carbs:numOrNull($('#carbs')),mealDose:numOrNull($('#mealDose')),
    correction:numOrNull($('#correction')),raise:($('#raise').value||'').trim()||null
  };
  base.date=date;
  try{await setDoc(ref,base,{merge:true});toast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³');await loadDay()}catch(e){console.error(e);toast('â— ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³')}
}

/* ===== Meals ===== */
let foods=[], categories=[], activeCat=null, basket=[];
function initMeals(){
  $('#icrNow').textContent = icr??'â€”';
  $('#foodSearch').addEventListener('input',renderFoods);
  $('#saveMealBtn').addEventListener('click',saveMeal);
  // ÙˆÙ‚Øª Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø§Ù„Ø¢Ù†
  const now=new Date(); now.setMinutes(now.getMinutes()-now.getTimezoneOffset());
  $('#mealTime').value = now.toISOString().slice(0,16);
  loadFoods();
}

async function loadFoods(){
  const snap=await getDocs(collection(db,'foods'));
  foods=[]; categories=[];
  snap.forEach(d=>{
    const f=d.data(); f.id=d.id;
    const cats=(f.categories||f.category||'Ø¹Ø§Ù…'); const arr=Array.isArray(cats)?cats:cats.toString().split(',').map(s=>s.trim()).filter(Boolean);
    f._cats=arr.length?arr:['Ø¹Ø§Ù…']; foods.push(f); arr.forEach(c=>{if(!categories.includes(c)) categories.push(c)});
  });
  categories.sort();
  renderCats(); renderFoods();
}

function renderCats(){
  const wrap=$('#catList'); wrap.innerHTML='';
  const allBtn=document.createElement('button'); allBtn.className='cat-btn'+(activeCat==null?' active':''); allBtn.textContent='Ø§Ù„ÙƒÙ„';
  allBtn.onclick=()=>{activeCat=null; renderCats(); renderFoods()};
  wrap.appendChild(allBtn);
  categories.forEach(c=>{
    const b=document.createElement('button'); b.className='cat-btn'+(activeCat===c?' active':''); b.textContent=c;
    b.onclick=()=>{activeCat=c; renderCats(); renderFoods()};
    wrap.appendChild(b);
  });
}

function renderFoods(){
  const grid=$('#foodsGrid'); grid.innerHTML='';
  const q=($('#foodSearch').value||'').trim().toLowerCase();
  const filtered=foods.filter(f=>{
    const hitCat = activeCat? f._cats.includes(activeCat) : true;
    const hitTxt = !q || ( (f.name||'').toLowerCase().includes(q) || (f.keywords||'').toLowerCase().includes(q) );
    return hitCat && hitTxt;
  });
  if(!filtered.length){ grid.innerHTML='<div class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù Ù…Ø·Ø§Ø¨Ù‚Ø©.</div>'; return; }

  filtered.forEach(f=>{
    const card=document.createElement('div'); card.className='food-card';
    card.innerHTML=`
      <img src="${f.imageUrl||'https://cdn-icons-png.flaticon.com/512/1046/1046784.png'}" alt="">
      <div class="food-name">${escapeHTML(f.name||'-')}</div>
      <div class="food-carb">Ø§Ù„ÙƒØ§Ø±Ø¨ Ù„ÙƒÙ„ 100Ø¬Ù…: <b>${Number(f.carbsPer100g||0)}</b></div>

      <div class="mode-tabs">
        <button class="tab-g active">Ø¬Ø±Ø§Ù…Ø§Øª</button>
        <button class="tab-h">ÙˆØ­Ø¯Ø© Ù…Ù†Ø²Ù„ÙŠØ©</button>
      </div>

      <div class="mode grams">
        <div class="qty-row">
          <input type="number" min="0" step="0.1" dir="ltr" placeholder="Ø¬Ø±Ø§Ù…Ø§Øª">
          <button class="btn primary">â• Ø£Ø¶Ù</button>
        </div>
      </div>

      <div class="mode house" style="display:none">
        <div class="qty-row">
          <select class="servSel" style="min-width:110px"></select>
          <input class="servCnt" type="number" min="0" step="0.1" dir="ltr" value="1" style="width:80px">
          <button class="btn primary">â• Ø£Ø¶Ù</button>
        </div>
        <div class="small">${escapeHTML(f.servingDescription||'')}</div>
      </div>
    `;
    // ØªØ¨ÙˆÙŠØ¨
    const tg=card.querySelector('.tab-g'), th=card.querySelector('.tab-h');
    const mg=card.querySelector('.mode.grams'), mh=card.querySelector('.mode.house');
    tg.onclick=()=>{tg.classList.add('active');th.classList.remove('active');mg.style.display='block';mh.style.display='none'};
    th.onclick=()=>{th.classList.add('active');tg.classList.remove('active');mg.style.display='none';mh.style.display='block'};

    // Ø¬Ø±Ø§Ù…Ø§Øª
    const gInput=card.querySelector('.mode.grams input');
    const gBtn=card.querySelector('.mode.grams button');
    gBtn.addEventListener('click',()=>{
      const g=parseFloat(gInput.value); if(!Number.isFinite(g)||g<=0){toast('ğŸ§® Ø£Ø¯Ø®Ù„ÙŠ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø© (Ø¬Ù…)');return}
      const carbs=(g*Number(f.carbsPer100g||0))/100;
      basket.push({ foodId:f.id, name:f.name, grams:g, carbs:+carbs.toFixed(1), unitLabel:`${g.toFixed(1)} Ø¬Ù…` });
      renderBasket();
    });

    // ÙˆØ­Ø¯Ø§Øª Ù…Ù†Ø²Ù„ÙŠØ©
    const sel=card.querySelector('.servSel'); const cnt=card.querySelector('.servCnt'); const btn=card.querySelector('.mode.house button');
    const servings=Array.isArray(f.servings)?f.servings:[]; sel.innerHTML=servings.length? '' : '<option value="">Ø¨Ø¯ÙˆÙ† ÙˆØ­Ø¯Ø§Øª</option>';
    servings.forEach(sv=>{
      const o=document.createElement('option'); o.value=sv.id; o.textContent=`${sv.label} (${sv.grams} Ø¬Ù…)`; o.dataset.grams=sv.grams; sel.appendChild(o);
    });
    btn.addEventListener('click',()=>{
      if(!servings.length){toast('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù…Ù†Ø²Ù„ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ù');return}
      const opt=sel.selectedOptions[0]; const gramsPer=parseFloat(opt?.dataset?.grams||'0'); const c=parseFloat(cnt.value||'0');
      if(!gramsPer||!c||c<=0){toast('Ø£Ø¯Ø®Ù„ÙŠ Ø¹Ø¯Ø¯ ÙˆØ­Ø¯Ø§Øª ØµØ­ÙŠØ­');return}
      const g=gramsPer*c; const carbs=(g*Number(f.carbsPer100g||0))/100;
      basket.push({ foodId:f.id, name:f.name, grams:+g.toFixed(1), carbs:+carbs.toFixed(1), unitLabel:`${c} Ã— ${opt.textContent.split('(')[0].trim()}` });
      renderBasket();
    });

    grid.appendChild(card);
  });
}

function renderBasket(){
  const body=$('#basketBody'); body.innerHTML='';
  if(!basket.length){ body.innerHTML='<tr><td colspan="4" class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ø¨Ø¹Ø¯.</td></tr>'; $('#totalCarbsCell').textContent='0.0'; $('#doseSuggestedMeal').value=''; return }
  let total=0;
  basket.forEach((it,idx)=>{
    total+=it.carbs;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${escapeHTML(it.name)}</td>
      <td>${escapeHTML(it.unitLabel||`${it.grams.toFixed(1)} Ø¬Ù…`)}</td>
      <td>${it.carbs.toFixed(1)}</td>
      <td><button class="btn gray" data-i="${idx}">Ø­Ø°Ù</button></td>
    `;
    body.appendChild(tr);
  });
  body.querySelectorAll('button[data-i]').forEach(b=>b.onclick=()=>{basket.splice(Number(b.dataset.i),1);renderBasket()});
  $('#totalCarbsCell').textContent=total.toFixed(1);
  if(icr&&icr>0){ $('#doseSuggestedMeal').value=(Math.round((total/icr)*10)/10).toFixed(1) } else { $('#doseSuggestedMeal').value='' }
}

async function saveMeal(){
  if(!basket.length){toast('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©');return}
  const eatenAt=$('#mealTime').value; const mealType=$('#mealType').value; if(!eatenAt){toast('Ø­Ø¯Ø¯ÙŠ ÙˆÙ‚Øª Ø§Ù„Ø£ÙƒÙ„');return}
  const total=parseFloat($('#totalCarbsCell').textContent)||0;
  const suggested=numOrNull($('#doseSuggestedMeal')); const given=numOrNull($('#doseGivenMeal'));
  const note=($('#mealNotes').value||'').trim()||null;

  const payload={
    childId, mealType, eatenAt: new Date(eatenAt).toISOString(), note,
    totalCarbs:+total.toFixed(1),
    bolusUnitsSuggested: suggested, bolusUnitsGiven: given,
    items: basket.map(x=>({ foodId:x.foodId, name:x.name, qtyGrams:+x.grams.toFixed(1), carbs:+x.carbs.toFixed(1), unitLabel:x.unitLabel||null })),
    icrUsed: icr??null, createdAt: serverTimestamp()
  };
  try{
    await addDoc(collection(db,'users',uid,'children',childId,'meals'), payload);
    toast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙˆØ¬Ø¨Ø©'); basket=[]; renderBasket();
  }catch(e){console.error(e);toast('â— ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„ÙˆØ¬Ø¨Ø©')}
}

/* ===== Weekly Report (A4, 7 days per page) ===== */
const wk={
  preset:$('#weekPreset'), from:$('#fromW'), to:$('#toW'),
  run:$('#runWeekly'), print:$('#printWeekly'), blank:$('#printBlank'),
  header:$('#reportHeader'), box:$('#weeklyBox'), pagesWrap:$('#pagesWrap'),
  kpisBox:$('#kpisBox'), kpis:$('#kpis'),
  slots:[
    ['uponWake','Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸'],
    ['preBreakfast','Ù‚Ø¨Ù„ Ø§Ù„ÙØ·ÙˆØ±'],['postBreakfast','Ø¨Ø¹Ø¯ Ø§Ù„ÙØ·ÙˆØ±'],
    ['preLunch','Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡'],['postLunch','Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡'],
    ['preDinner','Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡'],['postDinner','Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡'],
    ['beforeSleep','Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…'],['duringSleep','Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…'],
    ['beforeExercise','Ù‚Ø¨Ù„ Ø§Ù„ØªÙ…Ø±ÙŠÙ†'],['afterExercise','Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠÙ†'],
    ['random','Ø¹Ø´ÙˆØ§Ø¦ÙŠ'],['other','Ø£Ø®Ø±Ù‰']
  ]
};

function initWeeklyControls(){
  const now=new Date(); wk.preset.value='last7';
  wk.from.value=fmtISO(addDays(now,-6)); wk.to.value=fmtISO(now);
  wk.from.disabled=true; wk.to.disabled=true;

  wk.preset.addEventListener('change',()=>{
    const n=new Date();
    if(wk.preset.value==='custom'){ wk.from.disabled=false; wk.to.disabled=false; return }
    wk.from.disabled=true; wk.to.disabled=true;
    if(wk.preset.value==='last7'){ wk.from.value=fmtISO(addDays(n,-6)); wk.to.value=fmtISO(n) }
    else if(wk.preset.value==='thisWeek'){ wk.from.value=fmtISO(startOfWeek(n)); wk.to.value=fmtISO(endOfWeek(n)) }
    else if(wk.preset.value==='prevWeek'){ const s=addDays(startOfWeek(n),-7), e=addDays(endOfWeek(n),-7); wk.from.value=fmtISO(s); wk.to.value=fmtISO(e) }
  });
  wk.run.addEventListener('click',runWeeklyReport);
  wk.print.addEventListener('click',()=>window.print());
  wk.blank.addEventListener('click',printWeeklyBlank);
}

function calcAge(dob){ if(!dob)return null; const d=new Date(dob), n=new Date(); let y=n.getFullYear()-d.getFullYear(); const m=n.getMonth()-d.getMonth(); if(m<0||(m===0&&n.getDate()<d.getDate()))y--; return y }

async function runWeeklyReport(){
  const from=wk.from.value, to=wk.to.value; if(!from||!to){toast('Ø­Ø¯Ø¯ÙŠ Ø§Ù„ÙØªØ±Ø©');return}

  const cSnap=await getDoc(doc(db,'users',uid,'children',childId)); const c=cSnap.data()||{};
  const age=calcAge(c.dob); const weight=c.weightKg ?? c.weight ?? 'â€”'; const height=c.heightCm ?? c.height ?? 'â€”';
  wk.header.innerHTML = `
    <b>Ø§Ù„Ø§Ø³Ù…:</b> ${escapeHTML(c.name||'â€”')}
    â€¢ <b>Ø§Ù„Ø³Ù†:</b> ${age??'â€”'}
    â€¢ <b>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ:</b> ${escapeHTML(c.childCivilId||'â€”')}
    â€¢ <b>Ø§Ù„ÙˆØ²Ù†:</b> ${weight} ÙƒØ¬Ù…
    â€¢ <b>Ø§Ù„Ø·ÙˆÙ„:</b> ${height} Ø³Ù…
    â€¢ <b>ØªØ±Ø³ÙŠØ¨Ø§:</b> ${tresiba??'â€”'}U
    â€¢ <b>TDI:</b> ${tdi??'â€”'}U
    â€¢ <b>Ø­Ø¯ÙˆØ¯ (mmol/L):</b> â¬‡ï¸ ${lowMmol!=null?mmol1(lowMmol):'â€”'} â€¢ Ù‡Ø¯Ù ${targetMmol!=null?mmol1(targetMmol):'â€”'} â€¢ â¬†ï¸ ${highMmol!=null?mmol1(highMmol):'â€”'}
  `;

  const days=enumerateDays(from,to);
  const measSnaps=await Promise.all(days.map(d=>getDoc(doc(db,'users',uid,'children',childId,'measurements',d))));
  const byDate={}; days.forEach((d,i)=> byDate[d]=measSnaps[i].data()||{date:d,readings:{}});

  // Meals binding
  let mealsByDateSlot={};
  try{
    const startIso=new Date(from+"T00:00:00").toISOString();
    const endIso=new Date(to+"T23:59:59").toISOString();
    const qMeals=query(collection(db,'users',uid,'children',childId,'meals'), where('eatenAt','>=',startIso), where('eatenAt','<=',endIso), orderBy('eatenAt','asc'));
    const mSnap=await getDocs(qMeals);
    mSnap.forEach(ms=>{
      const m=ms.data(); const d=(m.eatenAt||'').slice(0,10);
      const slot=(m.mealType==='breakfast')?'postBreakfast':(m.mealType==='lunch')?'postLunch':(m.mealType==='dinner')?'postDinner':'random';
      mealsByDateSlot[d]=mealsByDateSlot[d]||{}; mealsByDateSlot[d][slot]=mealsByDateSlot[d][slot]||[];
      mealsByDateSlot[d][slot].push({ totalCarbs:m.totalCarbs??null, bolusSuggested:m.bolusUnitsSuggested??null, bolusGiven:m.bolusUnitsGiven??null });
    });
  }catch(e){ console.warn('Meals query skipped',e) }

  // KPIs
  const all=[]; let low=0,ok=0,high=0; let carbSum=0,sug=0,giv=0;

  // ØªÙ‚Ø³ÙŠÙ… 7 Ø£ÙŠØ§Ù…/ØµÙØ­Ø©
  wk.pagesWrap.innerHTML='';
  chunk(days,7).forEach((pageDays,pi)=>{
    const page=document.createElement('div'); page.className='page';
    page.innerHTML=`<div class="page-title">Ø§Ù„Ø£ÙŠØ§Ù… ${pi*7+1}â€“${pi*7+pageDays.length}</div>`;
    pageDays.forEach(d=>{
      const card=document.createElement('div'); card.className='day-card';
      const titleDate=fmtDDMMYYYY(d+'T00:00:00');
      card.innerHTML=`<div class="day-head"><div class="day-date">${titleDate}</div><div class="legend">Ø§Ù„ÙˆØ­Ø¯Ø©: mmol/L</div></div>`;
      const tbl=document.createElement('table'); tbl.className='day-table';
      const thead=document.createElement('thead'); const trH=document.createElement('tr');
      trH.appendChild(th('Ø§Ù„ØªØ§Ø±ÙŠØ®')); wk.slots.forEach(([_,name])=>trH.appendChild(th(name))); thead.appendChild(trH); tbl.appendChild(thead);
      const tbody=document.createElement('tbody'); const tr=document.createElement('tr');
      tr.appendChild(td(`<b>${titleDate}</b>`));

      const readings=(byDate[d].readings||{});
      wk.slots.forEach(([key])=>{
        const r=readings[key]; const mmol=r?.valueMmol ?? r?.value ?? null;
        if(mmol!=null){ const cls=classify(mmol); if(cls==='low')low++; else if(cls==='high')high++; else ok++; all.push(mmol); }
        const arrClass = mmol==null?'':(classify(mmol)==='low'?'arrow-down':classify(mmol)==='high'?'arrow-up':'arrow-ok');
        const v = mmol==null? 'â€”' : `${mmol1(mmol)} mmol/L`;
        const note = r?.note? `<div class="mnote">Ù…Ù„Ø§Ø­Ø¸Ø©: ${escapeHTML(r.note)}</div>` : '';
        const ms=(mealsByDateSlot[d]||{})[key]||[]; let mealLine='';
        if(ms.length){
          const csum=ms.reduce((s,x)=>s+(x.totalCarbs||0),0);
          const ssum=ms.reduce((s,x)=>s+(x.bolusSuggested||0),0);
          const gsum=ms.reduce((s,x)=>s+(x.bolusGiven||0),0);
          carbSum+=csum; sug+=ssum; giv+=gsum;
          mealLine=`<div class="meal-mini">ğŸ½ ${csum.toFixed(1)}g â€¢ ${ssum?ssum.toFixed(1):'â€”'}U â€¢ ${gsum?gsum.toFixed(1):'â€”'}U</div>`;
        }
        tr.appendChild(td(`
          <div class="val">${v} <span class="${arrClass}">${arrow(mmol)}</span></div>
          ${note}
          ${mealLine}
        `));
      });
      tbody.appendChild(tr); tbl.appendChild(tbody); card.appendChild(tbl); page.appendChild(card);
    });
    wk.pagesWrap.appendChild(page);

    function th(t){const e=document.createElement('th');e.textContent=t;return e}
    function td(html){const e=document.createElement('td');e.innerHTML=html;return e}
  });

  // KPIs
  const total=low+ok+high; const tir=total?Math.round((ok/total)*100):null;
  const avg=all.length?(all.reduce((a,b)=>a+b,0)/all.length):null;
  const min=all.length?Math.min(...all):null; const max=all.length?Math.max(...all):null;
  wk.kpis.innerHTML='';
  addChip(`TIR: ${tir!=null?tir+'%':'â€”'}`); addChip(`Ù…ØªÙˆØ³Ø·: ${avg!=null?mmol1(avg):'â€”'}`);
  addChip(`Ø£Ø¯Ù†Ù‰: ${min!=null?mmol1(min):'â€”'}`); addChip(`Ø£Ø¹Ù„Ù‰: ${max!=null?mmol1(max):'â€”'}`);
  addChip(`Ù…Ù†Ø®ÙØ¶: ${low}`); addChip(`Ø·Ø¨ÙŠØ¹ÙŠ: ${ok}`); addChip(`Ù…Ø±ØªÙØ¹: ${high}`);
  addChip(`ÙƒØ§Ø±Ø¨: ${carbSum.toFixed(1)}g`); addChip(`Ø¬Ø±Ø¹Ø§Øª: ${sug.toFixed(1)}U â€¢ ${giv.toFixed(1)}U`);
  wk.kpisBox.style.display='block'; wk.box.style.display='block';

  function addChip(t){const el=document.createElement('div');el.className='chip';el.textContent=t;wk.kpis.appendChild(el)}
}

function printWeeklyBlank(){
  const from=wk.from.value, to=wk.to.value; if(!from||!to){toast('Ø­Ø¯Ø¯ÙŠ Ø§Ù„ÙØªØ±Ø©');return}
  const days=enumerateDays(from,to);
  wk.pagesWrap.innerHTML='';
  chunk(days,7).forEach((pageDays,pi)=>{
    const page=document.createElement('div'); page.className='page';
    page.innerHTML=`<div class="page-title">ÙˆØ±Ù‚Ø© ÙØ§Ø±ØºØ© â€” Ø§Ù„Ø£ÙŠØ§Ù… ${pi*7+1}â€“${pi*7+pageDays.length}</div>`;
    pageDays.forEach(d=>{
      const card=document.createElement('div'); card.className='day-card';
      const titleDate=fmtDDMMYYYY(d+'T00:00:00');
      card.innerHTML=`<div class="day-head"><div class="day-date">${titleDate}</div><div class="legend">Ø§Ù„ÙˆØ­Ø¯Ø©: mmol/L</div></div>`;
      const tbl=document.createElement('table'); tbl.className='day-table';
      const thead=document.createElement('thead'); const trH=document.createElement('tr');
      trH.appendChild(th('Ø§Ù„ØªØ§Ø±ÙŠØ®')); wk.slots.forEach(([_,name])=>trH.appendChild(th(name))); thead.appendChild(trH); tbl.appendChild(thead);
      const tbody=document.createElement('tbody'); const tr=document.createElement('tr');
      tr.appendChild(td(`<b>${titleDate}</b>`));
      wk.slots.forEach(()=> tr.appendChild(td(`
        <div class="val">________ mmol/L</div>
        <div class="mnote">Ù…Ù„Ø§Ø­Ø¸Ø©: ___________________</div>
        <div class="meal-mini">ğŸ½ ÙƒØ§Ø±Ø¨: ___ g â€¢ Ø¬Ø±Ø¹Ø©: ___ U</div>
      `)));
      tbody.appendChild(tr); tbl.appendChild(tbody); card.appendChild(tbl); page.appendChild(card);
    });
    wk.pagesWrap.appendChild(page);

    function th(t){const e=document.createElement('th');e.textContent=t;return e}
    function td(html){const e=document.createElement('td');e.innerHTML=html;return e}
  });
  window.print();
}

/* ===== Doctor (embedded) ===== */
let chartSlots=null, chartTrend=null, chartDonut=null;
function initDoctor(){
  const iso=new Date().toISOString().slice(0,10);
  $('#docFrom').value=iso; $('#docTo').value=iso;
  $('#docRun').addEventListener('click',buildDoctor);
  $('#docPrint').addEventListener('click',()=>window.print());
  $('#docXlsx').addEventListener('click',exportDoctorXlsx);
}

async function buildDoctor(){
  const from=$('#docFrom').value, to=$('#docTo').value;
  if(!from||!to){toast('Ø­Ø¯Ø¯ÙŠ Ø§Ù„ÙØªØ±Ø©');return}

  const days=enumerateDays(from,to);
  const measSnaps=await Promise.all(days.map(d=>getDoc(doc(db,'users',uid,'children',childId,'measurements',d))));
  const byDate={}; days.forEach((d,i)=> byDate[d]=measSnaps[i].data()||{date:d,readings:{}});

  // Meta
  const cSnap=await getDoc(doc(db,'users',uid,'children',childId)); const c=cSnap.data()||{};
  $('#docMeta').textContent=`Ø§Ù„Ø§Ø³Ù…: ${c.name||'â€”'} â€¢ Ø§Ù„ÙØªØ±Ø©: ${from} â†’ ${to} â€¢ Ø­Ø¯ÙˆØ¯: â¬‡ï¸ ${lowMmol??'â€”'} â€” â¬†ï¸ ${highMmol??'â€”'} mmol/L`;

  const labelsMap={
    preBreakfast:'Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±',postBreakfast:'Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±',
    preLunch:'Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡',postLunch:'Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡',
    preDinner:'Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡',postDinner:'Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡',
    beforeSleep:'Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…',duringSleep:'Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…',uponWake:'Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸'
  };
  const order=['preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep','uponWake'];

  // Ø¬Ø¯ÙˆÙ„
  const tbody=$('#docRows'); tbody.innerHTML='';
  let total=0,cLow=0,cOk=0,cHigh=0,sum=0,all=[];
  const dailySeries=[];
  const slotAgg={}; order.forEach(k=>slotAgg[k]={sum:0,count:0});

  days.forEach(d=>{
    const readings=(byDate[d].readings||{});
    const tr=document.createElement('tr'); tr.appendChild(td(d));
    let daySum=0,cnt=0; let any=false;
    order.forEach(k=>{
      const r=readings[k]; const tdCell=document.createElement('td');
      if(!r||r.valueMmol==null){ tdCell.textContent='â€”'; }
      else{
        const mmol=Number(r.valueMmol); const st=classify(mmol);
        any=true; total++; sum+=mmol; all.push(mmol);
        if(st==='low')cLow++; else if(st==='high')cHigh++; else cOk++;
        daySum+=mmol; cnt++; slotAgg[k].sum+=mmol; slotAgg[k].count++;

        const cls=(st==='low')?'low':(st==='high'?'high':'ok');
        tdCell.innerHTML=`<span class="badge ${cls}">${mmol1(mmol)} mmol/L</span>`;
      }
      tr.appendChild(tdCell);
    });
    if(cnt) dailySeries.push({date:d,avg:+(daySum/cnt).toFixed(2)});
    if(!any){ tr.innerHTML=`<td>${d}</td><td colspan="9" class="note">â€”</td>`; }
    tbody.appendChild(tr);
  });

  // KPIs
  const tir= total? Math.round((cOk/total)*100) : 0;
  const avg= total? (sum/total).toFixed(1) : 'â€”';
  const min=all.length?Math.min(...all):null; const max=all.length?Math.max(...all):null;
  $('#docKPIs').innerHTML='';
  addChip(`Ù‚Ø±Ø§Ø¡Ø§Øª: ${total}`); addChip(`TIR: ${tir}%`); addChip(`Ù…ØªÙˆØ³Ø·: ${avg}`); addChip(`Ø£Ø¯Ù†Ù‰: ${min!=null?mmol1(min):'â€”'}`); addChip(`Ø£Ø¹Ù„Ù‰: ${max!=null?mmol1(max):'â€”'}`);

  // Charts
  const slotLabels=order.map(k=>labelsMap[k]); const slotMeans=order.map(k=>{const a=slotAgg[k];return a.count?+(a.sum/a.count).toFixed(2):0});
  if(chartSlots) chartSlots.destroy();
  chartSlots=new Chart($('#chartSlots'),{type:'bar',data:{labels:slotLabels,datasets:[{label:'Ù…ØªÙˆØ³Ø· (mmol/L)',data:slotMeans,backgroundColor:'#6ee7b7',borderColor:'#059669'}]},options:{plugins:{legend:{display:true}},scales:{x:{ticks:{autoSkip:false}}}}});

  if(chartTrend) chartTrend.destroy();
  chartTrend=new Chart($('#chartTrend'),{type:'line',data:{labels:dailySeries.map(x=>x.date),datasets:[{label:'Ù…ØªÙˆØ³Ø· ÙŠÙˆÙ…ÙŠ',data:dailySeries.map(x=>x.avg),borderColor:'#0ea5e9',backgroundColor:'rgba(14,165,233,.15)',tension:.3,spanGaps:true}]},options:{plugins:{legend:{display:true}}}});

  if(chartDonut) chartDonut.destroy();
  chartDonut=new Chart($('#chartDonut'),{type:'doughnut',data:{labels:['Ù…Ù†Ø®ÙØ¶','Ø·Ø¨ÙŠØ¹ÙŠ','Ù…Ø±ØªÙØ¹'],datasets:[{data:[cLow,cOk,cHigh],backgroundColor:['#f59e0b','#22c55e','#ef4444']}]} ,options:{plugins:{legend:{display:true,position:'bottom'}}}});

  function td(html){const e=document.createElement('td');e.innerHTML=html;return e}
  function addChip(t){const el=document.createElement('div');el.className='chip';el.textContent=t;$('#docKPIs').appendChild(el)}
}

function exportDoctorXlsx(){
  const XLSX=window.XLSX; if(!XLSX){ toast('XLSX ØºÙŠØ± Ù…ØªØ§Ø­'); return; }
  const table=document.querySelector('#sec-doctor table');
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.table_to_sheet(table);
  XLSX.utils.book_append_sheet(wb,ws,'Readings');
  XLSX.writeFile(wb,'doctor_report.xlsx');
}

/* ===== utils for charts (global td func used above) ===== */
</script>
</body>
</html>
