<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø·ÙÙ„</title>
  <!-- Ù…Ø¸Ù‡Ø± Ø¹Ø§Ù… Ù…ÙˆØ­Ù‘Ø¯ Ù„Ù„Ù…Ø´Ø±ÙˆØ¹ -->
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Ø¥Ø¶Ø§ÙØ§Øª Ø®ÙÙŠÙØ© ÙÙˆÙ‚ styles.css */
    .tiles{display:grid;gap:12px;grid-template-columns:repeat(2,minmax(0,1fr))}
    @media(min-width:900px){.tiles{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .tile{display:flex;flex-direction:column;gap:8px;background:var(--card);border:1px solid var(--line);
      border-radius:14px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    .tile h3{margin:0;font-size:18px}
    .tile .actions{margin-top:auto;display:flex;gap:8px;flex-wrap:wrap}
    .kpis{display:grid;gap:10px;grid-template-columns:repeat(3,minmax(0,1fr))}
    .kpis .box{background:#f8fafc;border:1px solid var(--line);border-radius:12px;padding:10px}
    .kpis .label{font-size:12px;color:var(--muted)}
    .kpis .value{font-weight:800}
    .child-nav{display:flex;gap:8px;flex-wrap:wrap}
    .child-banner{text-align:center;padding:12px 8px;display:none}
    .child-banner .avatar{width:84px;height:84px;border-radius:50%;object-fit:cover;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.12)}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>

  <!-- âœ… Ø¨Ù†Ø± Ø§Ù„Ø·ÙÙ„ Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© -->
  <div id="childBanner" class="child-banner">
    <img id="bannerAvatar" class="avatar" src="images/avatar-default.png" alt="ØµÙˆØ±Ø© Ø§Ù„Ø·ÙÙ„">
    <div style="margin-top:6px;font-weight:800" id="bannerName">â€”</div>
    <div class="small" id="bannerMeta">â€”</div>
  </div>

  <!-- âœ… Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ -->
  <div class="topbar">
    <div>ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ø·ÙÙ„</div>
    <div class="row">
      <a id="lnkHome" class="btn gray">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <button id="btnLogout" class="btn">Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <main class="container">

    <!-- âœ… ØªÙ†Ù‚Ù‘Ù„ ØµÙØ­Ø§Øª Ø§Ù„Ø·ÙÙ„ (Ù…Ù‡Ù…: ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠØ¨) -->
    <div class="card">
      <div id="childNav" class="child-nav"></div>
    </div>

    <!-- âœ… Ù„Ù…Ø­Ø© Ø³Ø±ÙŠØ¹Ø© + KPIs Ø§Ù„ÙŠÙˆÙ… -->
    <section class="card">
      <h3 class="section-title">Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…</h3>
      <div class="kpis" id="kpiRow">
        <div class="box"><div class="label">Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div><div id="k_today" class="value">â€”</div></div>
        <div class="box"><div class="label">Ù…ØªÙˆØ³Ø· Ø§Ù„ÙŠÙˆÙ…</div><div id="k_avg" class="value">â€”</div></div>
        <div class="box"><div class="label">% Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚</div><div id="k_tir" class="value">â€”%</div></div>
      </div>
      <div class="small" id="limitsBadge" style="margin-top:6px">â€”</div>
    </section>

    <!-- âœ… Ø¨Ù„Ø§Ø·Ø§Øª Ø£Ù‚Ø³Ø§Ù… Ø³Ø±ÙŠØ¹Ø© -->
    <section class="tiles">
      <article class="tile">
        <h3>ğŸ§ª Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ±</h3>
        <p class="small">ØªØ³Ø¬ÙŠÙ„ Ù‚Ø±Ø§Ø¡Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§Ø³ØªØ¹Ø±Ø§Ø¶ Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„ÙŠÙˆÙ….</p>
        <div class="actions">
          <a id="goMeasures" class="btn primary">Ø§ÙØªØ­ Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ±</a>
        </div>
      </article>

      <article class="tile">
        <h3>ğŸ½ï¸ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª</h3>
        <p class="small">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£ØµÙ†Ø§Ù ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„ÙƒØ§Ø±Ø¨ ÙˆØ§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©.</p>
        <div class="actions">
          <a id="goMeals" class="btn primary">Ø§ÙØªØ­ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª</a>
        </div>
      </article>

      <article class="tile">
        <h3>ğŸ“„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h3>
        <p class="small">ØªÙ‚Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹/Ø´Ù‡Ø± ÙˆÙ†Ø³Ø®Ø© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©.</p>
        <div class="actions">
          <a id="goReports" class="btn primary">Ø§ÙØªØ­ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a>
        </div>
      </article>

      <article class="tile">
        <h3>ğŸ§‘â€âš•ï¸ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠØ¨</h3>
        <p class="small">ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª + Ø±Ø³ÙˆÙ… (Ø®Ø·/Ø¯ÙˆÙ†Ø§Øª/ØªÙˆØ²ÙŠØ¹) ÙˆPDF.</p>
        <div class="actions">
          <!-- ğŸ‘‡ Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø²Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù„ÙØªØ­ ØµÙØ­Ø© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠØ¨ -->
          <a id="goDoctorReport" class="btn primary">Ø§ÙØªØ­ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠØ¨</a>
        </div>
      </article>

      <article class="tile">
        <h3>ğŸ“… Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©</h3>
        <p class="small">Ø³Ø¬Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª ÙˆØ§Ù„Ù…Ø±ÙÙ‚Ø§Øª ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø©.</p>
        <div class="actions">
          <a id="goVisits" class="btn primary">Ø§ÙØªØ­ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</a>
        </div>
      </article>

      <article class="tile">
        <h3>ğŸ§’ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„</h3>
        <p class="small">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.</p>
        <div class="actions">
          <a id="goProfile" class="btn primary">Ø§ÙØªØ­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</a>
        </div>
      </article>
    </section>

  </main>

  <div id="toast" class="toast"></div>
  <div id="loader" class="loader"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>

  <script type="module">
    import {
      auth, db, ensureAuth, requireChildIdFromQuery, setChildAvatar
    } from './firebase-init.js';

    import { signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      doc, getDoc, collection, getDocs
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const $ = s=>document.querySelector(s);
    const toast=(m)=>{const t=$("#toast");t.textContent=m;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),2000)}
    const showLoader=(on)=>{$("#loader").style.display=on?'flex':'none'}

    const z2=n=>String(n).padStart(2,'0');
    const todayISO=()=>{const d=new Date();return `${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())}`;}

    let uid=null, childId=null, child={};

    // ğŸ” Ø¨Ø¯Ø¡ Ø§Ù„Ù„ÙˆØ­Ø©
    (async function boot(){
      showLoader(true);
      const {uid:U}=await ensureAuth(); uid=U;
      childId = requireChildIdFromQuery();

      // Ø±ÙˆØ§Ø¨Ø· Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
      $("#lnkHome").href=`dashboard.html`;
      $("#btnLogout").addEventListener('click', ()=>signOut(auth).then(()=>location.href='index.html'));

      // ØªÙ†Ù‚Ù‘Ù„ Ø¨ÙŠÙ† ØµÙØ­Ø§Øª Ø§Ù„Ø·ÙÙ„ (ÙŠØ´Ù…Ù„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠØ¨)
      buildChildNav();

      // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„ + Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…
      await loadChild();
      await loadTodayKPI();

      // Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¨Ù„Ø§Ø·Ø§Øª
      $("#goMeasures").href = `measures.html?child=${encodeURIComponent(childId)}`;
      $("#goMeals").href    = `meals.html?child=${encodeURIComponent(childId)}`;
      $("#goReports").href  = `reports.html?child=${encodeURIComponent(childId)}`;
      $("#goDoctorReport").href = `doctor-report.html?child=${encodeURIComponent(childId)}`; // âœ… Ø²Ø± ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠØ¨
      $("#goVisits").href   = `visits.html?child=${encodeURIComponent(childId)}`;
      $("#goProfile").href  = `child-profile.html?child=${encodeURIComponent(childId)}`;
    })().finally(()=>showLoader(false));

    // ğŸ§­ ØªÙ†Ù‚Ù‘Ù„ Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
    function buildChildNav(){
      const row=$("#childNav"); row.innerHTML='';
      [
        ['child-dashboard.html','Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'],
        ['measures.html','Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ±'],
        ['meals.html','Ø§Ù„ÙˆØ¬Ø¨Ø§Øª'],
        ['reports.html','Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±'],
        ['doctor-report.html','ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠØ¨'], // âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠØ¨
        ['visits.html','Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©']
      ].forEach(([h,t])=>{
        const a=document.createElement('a');
        a.className='btn gray';
        a.href=`${h}?child=${encodeURIComponent(childId)}`;
        a.textContent=t;
        row.appendChild(a);
      });
    }

    // ğŸ‘¶ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„ ÙˆØ¹Ø±Ø¶Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¨Ù†Ø±
    async function loadChild(){
      const s=await getDoc(doc(db,'users',uid,'children',childId));
      if(!s.exists()){ toast('Ø§Ù„Ø·ÙÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }
      child=s.data()||{};
      setChildAvatar($('#bannerAvatar'), child.name, child.photoURL);
      $('#bannerName').textContent = child.name || 'â€”';
      $('#bannerMeta').textContent = `${child.gender||'â€”'} â€¢ ${child.weight??'â€”'} ÙƒØ¬Ù… â€¢ ${child.height??'â€”'} Ø³Ù…`;
      $('#childBanner').style.display='block';
      $('#limitsBadge').textContent = `Ø§Ù„ÙˆØ­Ø¯Ø©: mmol/L â€¢ Ø­Ø¯ÙˆØ¯: ${child.lowThreshold??'â€”'} â€” ${child.highThreshold??'â€”'}`;
    }

    // ğŸ“… Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ… Ù…Ù† Ù…Ø¬Ù…ÙˆØ¹Ø© measurements
    async function loadTodayKPI(){
      const today = todayISO();
      const ref = doc(db,'users',uid,'children',childId,'measurements',today);
      const s = await getDoc(ref);
      const readings = (s.data()||{}).readings || {};
      const values = Object.values(readings).map(r=> Number(r?.valueMmol ?? r?.value)).filter(v=>Number.isFinite(v));
      const total = values.length;
      const avg   = total? (values.reduce((a,b)=>a+b,0)/total):null;

      let ok=0, low=0, high=0;
      const lo=Number(child.lowThreshold), hi=Number(child.highThreshold);
      values.forEach(v=>{
        if(isFinite(lo)&&v<lo) low++;
        else if(isFinite(hi)&&v>hi) high++;
        else ok++;
      });
      const tir = total? Math.round((ok/total)*100) : 0;

      $('#k_today').textContent = total || 0;
      $('#k_avg').textContent   = avg!=null? avg.toFixed(1) : 'â€”';
      $('#k_tir').textContent   = tir + '%';
    }
  </script>
</body>
</html>
