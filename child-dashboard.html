<!-- child-dashboard.html â€” Ø§Ù„Ø¹Ù†Ø§ØµØ± (1+2+3/7) -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø·ÙÙ„ â€” Ù…ØªØ§Ø¨Ø¹Ø© Ø³ÙƒØ± Ø§Ù„Ø£Ø·ÙØ§Ù„</title>

  <style>
    :root{
      --brand:#0ea5e9; --brand2:#6ee7b7; --line:#e5e7eb;
      --ink:#0f172a; --muted:#6b7280; --bg:#f6fbff; --card:#fff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.6 "Tajawal",system-ui,sans-serif}

    /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
    header{
      position:sticky; top:0; z-index:10;
      background:linear-gradient(90deg,var(--brand),var(--brand2));
      color:#fff; padding:12px 16px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .head-left{display:flex; align-items:center; gap:12px}
    .kid-photo{ width:56px; height:56px; border-radius:16px; overflow:hidden; border:2px solid rgba(255,255,255,.75); background:#fff; display:grid; place-items:center }
    .kid-photo img{width:100%; height:100%; object-fit:cover; display:block}
    .avatar-fallback{ width:100%; height:100%; display:none; place-items:center; background:#e0f7fa; color:#0f172a; font-weight:800; font-size:18px }
    .title-wrap{display:flex; flex-direction:column}
    .hello{font-size:14px; opacity:.9}
    .kid-name{font-size:18px; font-weight:800}
    .head-actions{display:flex; gap:8px; flex-wrap:wrap}
    .btn{border:none; border-radius:10px; padding:8px 12px; font-weight:800; cursor:pointer}
    .btn.gray{background:#eef2f7}
    .btn.dark{background:#0f172a; color:#fff}
    .btn.primary{background:var(--brand); color:#fff}

    /* Ø§Ù„ØµÙØ­Ø© */
    main{max-width:1200px; margin:auto; padding:16px}
    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px; box-shadow:0 2px 10px rgba(0,0,0,.05); margin-bottom:14px}
    .note{color:var(--muted); font-size:14px}

    /* Ø´Ø¨ÙƒØ© Ø§Ù„ÙÙˆØ±Ù… */
    .grid{display:grid; gap:12px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width: 900px){ .g3{grid-template-columns:1fr 1fr} }
    @media (max-width: 680px){ .g2,.g3{grid-template-columns:1fr} }

    label{display:block; color:var(--muted); font-size:13px; margin-bottom:6px}
    input,select{width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#fff}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .field{display:flex; flex-direction:column}
    .radio-wrap{display:flex; gap:14px; align-items:center}
    .radio-wrap label{margin:0; font-size:14px; color:var(--ink)}
    .section-title{margin:0 0 10px; font-size:18px}
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; background:#eef6ff; color:#0f172a; font-size:12px; margin-inline-start:6px}

    /* Toast */
    .toast{position:fixed; bottom:16px; left:16px; background:#111; color:#fff; padding:10px 14px; border-radius:12px; opacity:0; transform:translateY(6px); transition:.25s}
    .toast.show{opacity:1; transform:none}
  </style>
</head>
<body>

  <!-- (1) Ø§Ù„Ù‡ÙŠØ¯Ø±: ØµÙˆØ±Ø© Ø§Ù„Ø·ÙÙ„ + Ø§Ù„ØªØ±Ø­ÙŠØ¨ -->
  <header>
    <div class="head-left">
      <div class="kid-photo">
        <img id="childPhoto" alt="ØµÙˆØ±Ø© Ø§Ù„Ø·ÙÙ„">
        <div id="avatarFallback" class="avatar-fallback">ğŸ‘§</div>
      </div>
      <div class="title-wrap">
        <div class="hello">Ù…Ø±Ø­Ø¨Ù‹Ø§ ğŸ‘‹</div>
        <div id="kidName" class="kid-name">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…...</div>
      </div>
    </div>
    <div class="head-actions">
      <a class="btn gray" href="dashboard.html">Ù„ÙˆØ­Ø© ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±</a>
      <button id="btnSaveInfo" class="btn primary">ğŸ’¾ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„</button>
      <button id="btnLogout" class="btn dark">Ø®Ø±ÙˆØ¬</button>
    </div>
  </header>

  <main>
    <!-- (2) Ù‚Ø³Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„ -->
    <section class="card" id="childInfoSection">
      <h3 class="section-title">âš™ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„</h3>
      <div class="grid g3">
        <div class="field">
          <label for="childName">Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„</label>
          <input id="childName" placeholder="Ù…Ø«Ø§Ù„: Ù„ÙŠÙ„Ù‰ Ø£Ø­Ù…Ø¯">
        </div>

        <div class="field">
          <label>Ø§Ù„Ù†ÙˆØ¹</label>
          <div class="radio-wrap">
            <label><input type="radio" name="gender" value="male"> Ø°ÙƒØ±</label>
            <label><input type="radio" name="gender" value="female"> Ø£Ù†Ø«Ù‰</label>
          </div>
        </div>

        <div class="field">
          <label for="childCivilId">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ</label>
          <input id="childCivilId" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ">
        </div>

        <div class="field">
          <label for="dob">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label>
          <input id="dob" type="date">
        </div>

        <div class="field">
          <label for="heightCm">Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)</label>
          <input id="heightCm" type="number" step="0.1" placeholder="Ù…Ø«Ø§Ù„: 125">
        </div>

        <div class="field">
          <label for="weightKg">Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)</label>
          <input id="weightKg" type="number" step="0.1" placeholder="Ù…Ø«Ø§Ù„: 26.4">
        </div>

        <div class="field">
          <label for="preferredUnit">Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø© Ù„Ù„Ø¹Ø±Ø¶</label>
          <select id="preferredUnit">
            <option value="mmol">mmol/L</option>
            <option value="mgdl">mg/dL</option>
          </select>
        </div>

        <div class="field" style="grid-column:1/-1">
          <label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
          <input id="notes" placeholder="Ø­Ø³Ø§Ø³ÙŠØ©ØŒ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø®Ø§ØµØ©ØŒ Ø¥Ù„Ø® (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
        </div>
      </div>
      <div class="note" style="margin-top:8px">* ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ£Ø³Ø§Ø³ Ù„Ø¨Ù‚ÙŠØ© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… (Ø§Ù„Ù‚ÙŠØ§Ø³Ø§ØªØŒ Ø§Ù„Ø¬Ø±Ø¹Ø§ØªØŒ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±â€¦)</div>
    </section>

    <!-- (3) ÙƒØ§Ø±Øª Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø³ ÙˆØ§Ù„Ø¬Ø±Ø¹Ø§Øª -->
    <section class="card" id="glucoseDosingSection">
      <h3 class="section-title">
        ğŸ§ª Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø³ Ùˆ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª
        <span id="unitBadge" class="badge">Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©: mmol/L</span>
      </h3>

      <div class="grid g3">
        <!-- Ø§Ù„Ù‡Ø¯Ù ÙˆØ§Ù„Ø­Ø¯ÙˆØ¯ -->
        <div class="field">
          <label for="target">Ø§Ù„Ù‚ÙŠØ§Ø³ Ø§Ù„Ø£Ù…Ø«Ù„ (Ø§Ù„Ù‡Ø¯Ù)</label>
          <input id="target" type="number" step="0.1" placeholder="Ù…Ø«Ø§Ù„: 6.5">
        </div>
        <div class="field">
          <label for="low">Ø­Ø¯ Ø§Ù„Ù‡Ø¨ÙˆØ·</label>
          <input id="low" type="number" step="0.1" placeholder="Ù…Ø«Ø§Ù„: 4.0">
        </div>
        <div class="field">
          <label for="high">Ø­Ø¯ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹</label>
          <input id="high" type="number" step="0.1" placeholder="Ù…Ø«Ø§Ù„: 10.0">
        </div>

        <!-- Ø§Ù„Ø¬Ø±Ø¹Ø§Øª ÙˆØ§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª -->
        <div class="field">
          <label for="tresiba">Ø¬Ø±Ø¹Ø© Ø§Ù„ØªØ±Ø³ÙŠØ¨Ø§ (ÙˆØ­Ø¯Ø©/ÙŠÙˆÙ…)</label>
          <input id="tresiba" type="number" step="0.5" placeholder="Ù…Ø«Ø§Ù„: 10">
        </div>
        <div class="field">
          <label for="tdi">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…ÙŠ TDI (ÙˆØ­Ø¯Ø©)</label>
          <input id="tdi" type="number" step="0.5" placeholder="Ù…Ø«Ø§Ù„: 24">
        </div>
        <div class="field">
          <label for="isf">Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„ØªØµØ­ÙŠØ­ ISF <span id="isfUnitLabel" class="badge">mmol/L Ù„ÙƒÙ„ 1U</span></label>
          <input id="isf" type="number" step="0.1" placeholder="ÙƒÙ… ØªÙ†Ø²Ù„ Ø§Ù„ÙˆØ­Ø¯Ø©ØŸ">
        </div>
        <div class="field">
          <label for="icr">Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„ÙƒØ§Ø±Ø¨ ICR (Ø¬Ø±Ø§Ù…/ÙˆØ­Ø¯Ø©)</label>
          <input id="icr" type="number" step="0.5" placeholder="Ø¬Ø±Ø§Ù… ÙƒØ§Ø±Ø¨ Ù„ÙƒÙ„ 1U">
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <button id="btnSuggest" class="btn gray">ğŸ’¡ Ø§Ø­Ø³Ø¨ Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ…</button>
        <button id="btnSaveGlucose" class="btn primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
      </div>

      <div class="note" style="margin-top:8px">
        * Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø¯Ø§Ø®Ù„ÙŠÙ‹Ø§ Ø¨Ø§Ù„Ù€ mmol Ù„Ø¶Ù…Ø§Ù† Ø§ØªØ³Ø§Ù‚ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª.  
        * Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø³Ø±ÙŠØ¹Ø©: ISF â‰ˆ <strong>100 / TDI</strong> (mmol/L Ù„ÙƒÙ„ 1U) â€” ICR â‰ˆ <strong>500 / TDI</strong> (Ø¬Ø±Ø§Ù…/1U). Ø§Ù„Ù‚ÙŠÙ… Ø¥Ø±Ø´Ø§Ø¯ÙŠØ© ÙˆØªÙØ¶Ø¨Ø· Ø·Ø¨ÙŠÙ‹Ø§.
      </div>
    </section>

    <!-- Ø­Ø§Ù…Ù„ Ù„Ø£Ù‚Ø³Ø§Ù… Ù„Ø§Ø­Ù‚Ø© -->
    <section class="card">
      <div class="note">Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ØªØ§Ù„ÙŠØ© Ø³Ù†Ø¶ÙŠÙÙ‡Ø§ ØªØ¨Ø§Ø¹Ù‹Ø§ (Ø§Ù„ÙˆØ¬Ø¨Ø§ØªØŒ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§ØªØŒ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±ØŒ Ø§Ù„Ø·Ø¨ÙŠØ¨ØŒ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª...).</div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <script type="module">
    import { db, auth } from './firebase-init.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // Ø¹Ù†Ø§ØµØ± Ø¹Ø§Ù…Ø©
    const elName   = document.getElementById('kidName');
    const img      = document.getElementById('childPhoto');
    const fallback = document.getElementById('avatarFallback');
    const toastEl  = document.getElementById('toast');

    const input = id => document.getElementById(id);
    const genderRadios = () => [...document.querySelectorAll('input[name="gender"]')];
    const btnSaveInfo = document.getElementById('btnSaveInfo');
    const btnLogout   = document.getElementById('btnLogout');

    // Ø¹Ù†Ø§ØµØ± ÙƒØ§Ø±Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
    const unitBadge     = document.getElementById('unitBadge');
    const isfUnitLabel  = document.getElementById('isfUnitLabel');
    const btnSuggest    = document.getElementById('btnSuggest');
    const btnSaveGlu    = document.getElementById('btnSaveGlucose');

    // childId Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
    const params  = new URLSearchParams(location.search);
    const childId = params.get('child');

    // Helpers
    const slugify = s => (s||'').trim().toLowerCase()
                          .replace(/\s+/g,'-')
                          .replace(/[^\u0600-\u06FF\w-]/g,'');
    const showToast = (msg) => { toastEl.textContent = msg; toastEl.classList.add('show'); setTimeout(()=> toastEl.classList.remove('show'), 2200); };
    const setAvatarFallback = (name, gender) => {
      const initials = (name||'').trim().split(/\s+/).slice(0,2).map(w=>w[0]||'').join('').toUpperCase();
      fallback.textContent = initials || (gender==='male' ? 'ğŸ‘¦' : 'ğŸ‘§'); fallback.style.display = 'grid';
    };
    const trySetPhoto = (child) => {
      const byId = `/images/${childId}.jpg`, byName = `/images/${slugify(child.name||'')}.jpg`;
      const test = (srcs,i=0)=>{ if(i>=srcs.length){ img.style.display='none'; setAvatarFallback(child.name, child.gender); return; }
        img.onload=()=>{ img.style.display='block'; fallback.style.display='none'; };
        img.onerror=()=>test(srcs,i+1); img.src=srcs[i];
      }; test([byId,byName]);
    };

    const setGenderUI = (value) => genderRadios().forEach(r => r.checked = (r.value === value));
    const getGenderUI = () => (genderRadios().find(r => r.checked)?.value || null);
    const numOrNull = (el) => { const v = el.value; if (v === '' || v == null) return null; const n = Number(v); return Number.isFinite(n) ? n : null; };

    // ÙˆØ­Ø¯Ø§Øª (Ø¹Ø±Ø¶/ØªØ®Ø²ÙŠÙ†)
    let preferredUnit = 'mmol'; // Ù„Ù„Ø¹Ø±Ø¶
    const toMmol  = (v) => (v==null?null : (preferredUnit==='mgdl' ? v*0.0555 : v));
    const fromMmol= (v) => (v==null?''   : (preferredUnit==='mgdl' ? +(v/0.0555).toFixed(0) : +(+v).toFixed(1)));

    // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„ + ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¹Ù†ØµØ±ÙŠÙ† Ø§Ù„Ø³Ø§Ø¨Ù‚ÙŠÙ†
    onAuthStateChanged(auth, async (user) => {
      if (!user) { location.href = 'index.html'; return; }
      if (!childId) { elName.textContent = 'Ù„Ù… ÙŠØªÙ… ØªÙ…Ø±ÙŠØ± Ø±Ù‚Ù… Ø§Ù„Ø·ÙÙ„ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.'; setAvatarFallback('',''); return; }

      try {
        const childRef = doc(db, 'users', user.uid, 'children', childId);
        const snap = await getDoc(childRef);

        if (!snap.exists()) { elName.textContent = 'Ø§Ù„Ø·ÙÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ â—'; setAvatarFallback('', ''); return; }

        const c = snap.data();
        elName.textContent = c.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
        trySetPhoto(c);

        // (2) ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„
        input('childName').value     = c.name || '';
        setGenderUI(c.gender || '');
        input('childCivilId').value  = c.childCivilId || '';
        input('dob').value           = c.dob || '';
        input('heightCm').value      = c.heightCm ?? '';
        input('weightKg').value      = c.weightKg ?? '';
        preferredUnit                = c.preferredUnit || 'mmol';
        input('preferredUnit').value = preferredUnit;
        input('notes').value         = c.notes || '';

        // (3) ØªØ¹Ø¨Ø¦Ø© ÙƒØ§Ø±Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ù…Ø®Ø²Ù† Ø¨Ø§Ù„Ù€ mmol)
        unitBadge.textContent = `Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©: ${preferredUnit==='mgdl' ? 'mg/dL' : 'mmol/L'}`;
        isfUnitLabel.textContent = preferredUnit==='mgdl' ? 'mg/dL Ù„ÙƒÙ„ 1U' : 'mmol/L Ù„ÙƒÙ„ 1U';

        const gc  = (c.glucoseConfig || {});
        const dos = (c.dosing || {});

        input('target').value = fromMmol(gc.targetGlucoseMmol ?? null);
        input('low').value    = fromMmol(gc.lowThresholdMmol ?? null);
        input('high').value   = fromMmol(gc.highThresholdMmol ?? null);

        input('tresiba').value = dos.basalTresibaUnits ?? '';
        input('tdi').value     = dos.totalDailyInsulinUnits ?? '';

        // ISF Ù…Ø®Ø²Ù† Ø¨Ø§Ù„Ù€ mmol/L Ù„ÙƒÙ„ ÙˆØ­Ø¯Ø© â€” Ù†Ø­ÙˆÙ„Ù‡ Ù„Ù„Ø¹Ø±Ø¶
        const isfMmol = dos.isfMmolPerUnit ?? null;
        input('isf').value = preferredUnit==='mgdl'
          ? (isfMmol==null ? '' : +(+isfMmol/0.0555).toFixed(0)) // mg/dL per U
          : (isfMmol==null ? '' : +(+isfMmol).toFixed(1));       // mmol/L per U

        input('icr').value = dos.icrGramsPerUnit ?? '';

      } catch (err) {
        console.error(err);
        elName.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
        setAvatarFallback('', '');
      }
    });

    // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„ (Ø§Ù„Ø¹Ù†ØµØ± 2)
    btnSaveInfo.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user || !childId) return;

      const payload = {
        name: input('childName').value.trim() || null,
        gender: getGenderUI(),
        childCivilId: input('childCivilId').value.trim() || null,
        dob: input('dob').value || null,
        heightCm: numOrNull(input('heightCm')),
        weightKg: numOrNull(input('weightKg')),
        preferredUnit: input('preferredUnit').value, // "mmol" | "mgdl"
        notes: input('notes').value.trim() || null,
        storageUnit: "mmol",
        lastUpdatedAt: new Date().toISOString()
      };

      try {
        await setDoc(doc(db, 'users', user.uid, 'children', childId), payload, { merge: true });
        preferredUnit = payload.preferredUnit;
        unitBadge.textContent = `Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©: ${preferredUnit==='mgdl' ? 'mg/dL' : 'mmol/L'}`;
        isfUnitLabel.textContent = preferredUnit==='mgdl' ? 'mg/dL Ù„ÙƒÙ„ 1U' : 'mmol/L Ù„ÙƒÙ„ 1U';
        elName.textContent = payload.name || elName.textContent;
        showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„');
      } catch (e) {
        console.error(e);
        showToast('â— Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸');
      }
    });

    // ğŸ’¡ Ø§Ù‚ØªØ±Ø§Ø­ ISF & ICR Ù…Ù† TDI
    btnSuggest.addEventListener('click', () => {
      const tdi = Number(input('tdi').value);
      if (!tdi || tdi <= 0) { showToast('Ø£Ø¯Ø®Ù„ÙŠ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ… Ø£ÙˆÙ„Ù‹Ø§'); return; }

      // mmols:
      const isfMmol = +(100/tdi).toFixed(2);     // 1800-rule Ù…ÙƒØ§ÙØ¦ mmol â‰ˆ 100/TDI
      const icr     = +(500/tdi).toFixed(1);     // 500-rule Grams per Unit

      // Ø¹Ø±Ø¶ Ø­Ø³Ø¨ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
      input('isf').value = (preferredUnit==='mgdl')
        ? Math.round(isfMmol/0.0555)            // mg/dL per U
        : isfMmol;                              // mmol/L per U
      input('icr').value = icr;

      showToast('ğŸ’¡ ØªÙ… Ø§Ù‚ØªØ±Ø§Ø­ ISF Ùˆ ICR Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ…');
    });

    // Ø­ÙØ¸ ÙƒØ§Ø±Øª Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø§Ù„Ø¹Ù†ØµØ± 3)
    btnSaveGlu.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user || !childId) return;

      // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚ÙŠÙ… Ø¨Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø© ÙˆØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ù„ØªØ®Ø²ÙŠÙ† (mmol)
      const targetDisp = numOrNull(input('target'));
      const lowDisp    = numOrNull(input('low'));
      const highDisp   = numOrNull(input('high'));

      const targetMmol = toMmol(targetDisp);
      const lowMmol    = toMmol(lowDisp);
      const highMmol   = toMmol(highDisp);

      // ØªØ­Ù‚Ù‚ Ø¨Ø³ÙŠØ·
      if (targetMmol!=null && lowMmol!=null && lowMmol >= targetMmol) { showToast('âš ï¸ Ø­Ø¯ Ø§Ù„Ù‡Ø¨ÙˆØ· ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù‡Ø¯Ù'); return; }
      if (targetMmol!=null && highMmol!=null && highMmol <= targetMmol) { showToast('âš ï¸ Ø­Ø¯ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù‡Ø¯Ù'); return; }

      // ISF (Ø­Ù‚Ù„ Ù…Ø¹Ø±ÙˆØ¶ Ø¨ÙˆØ­Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶ â€“ Ù†Ø¹ÙŠØ¯Ù‡ Ø¥Ù„Ù‰ mmol/L per U)
      const isfDisp = numOrNull(input('isf'));
      const isfMmol = (preferredUnit==='mgdl')
        ? (isfDisp==null ? null : +(isfDisp*0.0555).toFixed(2))
        : (isfDisp==null ? null : +(+isfDisp).toFixed(2));

      const payload = {
        glucoseConfig: {
          targetGlucoseMmol: targetMmol,
          lowThresholdMmol : lowMmol,
          highThresholdMmol: highMmol
        },
        dosing: {
          basalTresibaUnits      : numOrNull(input('tresiba')),
          totalDailyInsulinUnits : numOrNull(input('tdi')),
          isfMmolPerUnit         : isfMmol,
          icrGramsPerUnit        : numOrNull(input('icr'))
        },
        lastUpdatedAt: new Date().toISOString()
      };

      try {
        await setDoc(doc(db, 'users', user.uid, 'children', childId), payload, { merge: true });
        showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø³ ÙˆØ§Ù„Ø¬Ø±Ø¹Ø§Øª');
      } catch (e) {
        console.error(e);
        showToast('â— Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸');
      }
    });

    // Ø®Ø±ÙˆØ¬
    btnLogout.addEventListener('click', () => { signOut(auth).then(()=> location.href='index.html'); });
  </script>
</body>
</html>
