<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø·ÙÙ„ â€” Ù…ØªØ§Ø¨Ø¹Ø© Ø³ÙƒØ± Ø§Ù„Ø£Ø·ÙØ§Ù„</title>

  <style>
    :root{
      --brand:#0ea5e9; --brand2:#6ee7b7; --line:#e5e7eb;
      --ink:#0f172a; --muted:#6b7280; --bg:#f6fbff; --card:#fff;
      --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; --chip:#eef6ff;
      --hi:#f97316;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.6 "Tajawal",system-ui,sans-serif; display:flex; min-height:100vh}

    /* Sidebar */
    .sidebar{
      width:260px; flex:0 0 260px; background:linear-gradient(180deg,var(--brand),var(--brand2));
      color:#fff; padding:16px; position:sticky; top:0; height:100vh; overflow:auto
    }
    .sb-title{font-weight:800; font-size:18px; margin-bottom:12px}
    .sb-btn{display:block; width:100%; text-align:right; background:transparent; border:none; color:#fff;
      padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:700; margin:4px 0}
    .sb-btn:hover, .sb-btn.active{background:rgba(255,255,255,.18)}
    .spacer{height:6px}

    /* Main + header */
    .main{flex:1; min-width:0}
    header{
      position:sticky; top:0; z-index:10; background:linear-gradient(90deg,var(--brand),var(--brand2));
      color:#fff; padding:12px 16px; display:flex; align-items:center; justify-content:space-between;
    }
    .head-left{display:flex; align-items:center; gap:12px}
    .kid-photo{ width:56px; height:56px; border-radius:16px; overflow:hidden; border:2px solid rgba(255,255,255,.75); background:#fff; display:grid; place-items:center }
    .kid-photo img{width:100%; height:100%; object-fit:cover; display:block}
    .avatar-fallback{ width:100%; height:100%; display:none; place-items:center; background:#e0f7fa; color:#0f172a; font-weight:800; font-size:18px }
    .title-wrap{display:flex; flex-direction:column}
    .hello{font-size:14px; opacity:.9}
    .kid-name{font-size:18px; font-weight:800}
    .head-actions{display:flex; gap:8px; flex-wrap:wrap}
    .btn{border:none; border-radius:10px; padding:8px 12px; font-weight:800; cursor:pointer}
    .btn.gray{background:#eef2f7}
    .btn.dark{background:#0f172a; color:#fff}
    .btn.primary{background:var(--brand); color:#fff}
    .btn.orange{background:var(--hi); color:#fff}

    main{max-width:1200px; margin:auto; padding:16px}
    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px; box-shadow:0 2px 10px rgba(0,0,0,.05); margin-bottom:14px}
    .note{color:var(--muted); font-size:14px}
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; background:var(--chip); color:#0f172a; font-size:12px; margin-inline-start:6px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}

    /* Grids */
    .grid{display:grid; gap:12px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width: 900px){ .g3{grid-template-columns:1fr 1fr} }
    @media (max-width: 680px){ .g2,.g3{grid-template-columns:1fr} }

    label{display:block; color:var(--muted); font-size:13px; margin-bottom:6px}
    input,select,textarea{width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#fff}
    textarea{min-height:90px; resize:vertical}

    /* Measurements table */
    table{width:100%; border-collapse:collapse}
    th,td{border:1px solid var(--line); padding:8px; text-align:center}
    th{background:#f0f9ff}
    .status{display:inline-block; padding:6px 10px; border-radius:999px; font-size:12px}
    .ok{background:#ecfdf5; color:#10b981}
    .high{background:#fee2e2; color:#ef4444}
    .low{background:#fff7ed; color:#b45309}

    /* Meals UI */
    .meals-layout{display:grid; grid-template-columns:220px 1fr; gap:12px}
    .cats{display:flex; flex-direction:column; gap:8px}
    .cat-btn{border:1px solid var(--line); background:#fff; color:var(--ink); border-radius:10px; padding:8px 10px; cursor:pointer; text-align:right; font-weight:700}
    .cat-btn.active, .cat-btn:hover{background:#e6f7ff; border-color:#cfefff}
    .foods-grid{display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(180px,1fr))}
    .food-card{border:1px solid var(--line); background:#fff; border-radius:14px; padding:12px; box-shadow:0 2px 8px rgba(0,0,0,0.04)}
    .food-card img{width:80px; height:80px; object-fit:contain; display:block; margin:0 auto 6px}
    .food-name{font-weight:800; text-align:center}
    .food-sub{font-size:12px; color:var(--muted); text-align:center; margin-bottom:8px}
    .toggle{display:flex; gap:6px; justify-content:center; margin:6px 0}
    .toggle button{flex:1; border:1px solid var(--line); background:#fff; padding:6px 8px; border-radius:8px; cursor:pointer; font-weight:700}
    .toggle button.active{background:#eef6ff; border-color:#cfefff}
    .food-actions{display:flex; gap:6px; align-items:center; justify-content:center}
    .small{font-size:12px; color:var(--muted)}
    .basket{border:1px solid var(--line); border-radius:12px; overflow:hidden}
    .basket th{background:#fff}
    .basket tfoot td{font-weight:800}

    .pill{display:inline-block; background:#f1f5f9; border-radius:999px; padding:3px 8px; font-size:12px}

    /* Toast */
    .toast{position:fixed; bottom:16px; left:16px; background:#111; color:#fff; padding:10px 14px; border-radius:12px; opacity:0; transform:translateY(6px); transition:.25s}
    .toast.show{opacity:1; transform:none}

    .section{display:none}
    .section.active{display:block}

    /* ===== Reports Weekly ===== */
    .kpis{display:flex; flex-wrap:wrap; gap:8px}
    .chip{background:#f1f5f9;border-radius:999px;padding:6px 10px;font-size:12px}
    .weekly-layout{display:grid; grid-template-columns:1fr 300px; gap:12px}
    .day-card{border:1px solid var(--line); border-radius:12px; padding:10px; background:#fff}
    .day-head{display:flex; justify-content:space-between; align-items:center; margin-bottom:6px}
    .day-title{font-weight:800}
    .day-main{font-size:14px}
    .day-notes{font-size:12px; color:var(--muted)}
    .slots{border:1px dashed var(--line); border-radius:12px; padding:10px; background:#fff}
    .slot{display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed #eef2f7}
    .slot:last-child{border-bottom:none}
    .slot-name{color:#334155}
    .slot-val{font-weight:800}
    .meal-mini{font-size:12px; color:#7c2d12; background:#fff7ef; border:1px solid #ffd1b2; border-radius:8px; padding:2px 6px; margin-top:4px; width:max-content}
    .arrow-up{color:#ef4444} .arrow-down{color:#b45309} .arrow-ok{color:#10b981}

    /* Print */
    @media print{
      @page{ size: A4 portrait; margin: 10mm }
      header,.controls,.no-print{display:none!important}
      body{background:#fff;font-size:12px}
      .card{border:0;box-shadow:none;padding:0;margin:0}
      .weekly-layout{grid-template-columns:1fr 280px}
      .day-card{page-break-inside:avoid}
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sb-title">ğŸ‘§ Ù„ÙˆØ­Ø© Ø§Ù„Ø·ÙÙ„</div>
    <button class="sb-btn active" data-target="sec-home">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <div class="spacer"></div>
    <button class="sb-btn" data-target="sec-info">âš™ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„</button>
    <button class="sb-btn" data-target="sec-measure">ğŸ“ Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ±</button>
    <button class="sb-btn" data-target="sec-meals">ğŸ½ï¸ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª</button>
    <button class="sb-btn" data-target="sec-reports">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
    <button class="sb-btn" data-target="sec-doctor">ğŸ§‘â€âš•ï¸ Ø§Ù„Ø·Ø¨ÙŠØ¨</button>
    <button class="sb-btn" data-target="sec-visits">ğŸ“… Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©</button>
  </aside>

  <div class="main">
    <!-- Header -->
    <header>
      <div class="head-left">
        <div class="kid-photo">
          <img id="childPhoto" alt="ØµÙˆØ±Ø© Ø§Ù„Ø·ÙÙ„">
          <div id="avatarFallback" class="avatar-fallback">ğŸ‘§</div>
        </div>
        <div class="title-wrap">
          <div class="hello">Ù…Ø±Ø­Ø¨Ù‹Ø§ ğŸ‘‹</div>
          <div id="kidName" class="kid-name">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…...</div>
        </div>
      </div>
      <div class="head-actions">
        <a class="btn gray" href="dashboard.html">Ù„ÙˆØ­Ø© ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±</a>
        <button id="btnLogout" class="btn dark">Ø®Ø±ÙˆØ¬</button>
      </div>
    </header>

    <main>
      <!-- Home -->
      <section id="sec-home" class="section active">
        <div class="card"><div class="note">Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙŠÙ…Ù†Ù‰ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.</div></div>
      </section>

      <!-- (1) Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„ + Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
      <section id="sec-info" class="section">
        <section class="card" id="childInfoSection">
          <h3 class="section-title">âš™ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„</h3>
          <div class="grid g3">
            <div><label>Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„</label><input id="childName" placeholder="Ù…Ø«Ø§Ù„: Ù„ÙŠÙ„Ù‰ Ø£Ø­Ù…Ø¯"></div>
            <div>
              <label>Ø§Ù„Ù†ÙˆØ¹</label>
              <div class="row" style="gap:14px">
                <label><input type="radio" name="gender" value="male"> Ø°ÙƒØ±</label>
                <label><input type="radio" name="gender" value="female"> Ø£Ù†Ø«Ù‰</label>
              </div>
            </div>
            <div><label>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ</label><input id="childCivilId" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></div>
            <div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label><input id="dob" type="date"></div>
            <div><label>Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)</label><input id="heightCm" type="number" step="0.1"></div>
            <div><label>Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)</label><input id="weightKg" type="number" step="0.1"></div>
            <div><label>Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø©</label>
              <select id="preferredUnit"><option value="mmol">mmol/L</option><option value="mgdl">mg/dL</option></select>
            </div>
            <div><label>Ù†ÙˆØ¹ Ø§Ù„Ù‚ÙŠØ§Ø³ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</label>
              <select id="defaultMeasurementType">
                <option value="fingerstick">ğŸ©¸ ÙØ­Øµ Ø¥ØµØ¨Ø¹</option>
                <option value="cgm">ğŸ“ˆ CGM</option>
                <option value="lab">ğŸ§ª Ù…Ø®ØªØ¨Ø±</option>
                <option value="other">âœ³ï¸ Ø£Ø®Ø±Ù‰</option>
              </select>
            </div>
            <div style="grid-column:1/-1"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><input id="notes" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></div>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="btnSaveInfo" class="btn primary">ğŸ’¾ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„</button>
          </div>
        </section>

        <section class="card" id="glucoseDosingSection">
          <h3 class="section-title">ğŸ§ª Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø³ Ùˆ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª
            <span id="unitBadge" class="badge">Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©: mmol/L</span>
          </h3>
          <div class="grid g3">
            <div><label>Ø§Ù„Ù‡Ø¯Ù</label><input id="target" type="number" step="0.1"></div>
            <div><label>Ø­Ø¯ Ø§Ù„Ù‡Ø¨ÙˆØ·</label><input id="low" type="number" step="0.1"></div>
            <div><label>Ø­Ø¯ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹</label><input id="high" type="number" step="0.1"></div>
            <div><label>ØªØ±Ø³ÙŠØ¨Ø§ (U/Day)</label><input id="tresiba" type="number" step="0.5"></div>
            <div><label>TDI (U)</label><input id="tdi" type="number" step="0.5"></div>
            <div><label>ISF <span id="isfUnitLabel" class="badge">mmol/L Ù„ÙƒÙ„ 1U</span></label><input id="isf" type="number" step="0.1"></div>
            <div><label>ICR (Ø¬Ø±Ø§Ù…/ÙˆØ­Ø¯Ø©)</label><input id="icr" type="number" step="0.1"></div>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="btnSuggest" class="btn gray">ğŸ’¡ Ø§Ø­Ø³Ø¨ Ù…Ù† TDI</button>
            <button id="btnSaveGlucose" class="btn primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
          </div>
          <div class="note" style="margin-top:8px">Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª: ISFâ‰ˆ100/TDI (mmol/L/U) â€” ICRâ‰ˆ500/TDI (g/U).</div>
        </section>
      </section>

      <!-- (2) Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ± -->
      <section id="sec-measure" class="section">
        <section class="card">
          <h3 class="section-title">ğŸ“ Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ± <span id="mUnitBadge" class="badge">Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©: mmol/L</span></h3>
          <div class="grid g3">
            <div><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="dateSel" /></div>
            <div><label>ÙˆÙ‚Øª Ø§Ù„Ù‚ÙŠØ§Ø³</label>
              <select id="slotSel">
                <option value="">â€” Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„ÙˆÙ‚Øª â€”</option>

                <option value="uponWake">Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸</option>

                <option value="preBreakfast">Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±</option>
                <option value="postBreakfast">Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±</option>

                <option value="preLunch">Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡</option>
                <option value="postLunch">Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡</option>

                <option value="preDinner">Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡</option>
                <option value="postDinner">Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡</option>

                <option value="beforeSleep">Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…</option>
                <option value="duringSleep">Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…</option>

                <option value="beforeExercise">Ù‚Ø¨Ù„ Ø§Ù„ØªÙ…Ø±ÙŠÙ†</option>
                <option value="afterExercise">Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠÙ†</option>

                <option value="random">Ù‚ÙŠØ§Ø³ Ø¹Ø´ÙˆØ§Ø¦ÙŠ</option>
                <option value="other">Ø£Ø®Ø±Ù‰...</option>
              </select>
            </div>
            <div><label>Ù†ÙˆØ¹ Ø§Ù„Ù‚ÙŠØ§Ø³</label>
              <select id="mType">
                <option value="fingerstick">ğŸ©¸ ÙØ­Øµ Ø¥ØµØ¨Ø¹</option>
                <option value="cgm">ğŸ“ˆ CGM</option>
                <option value="lab">ğŸ§ª Ù…Ø®ØªØ¨Ø±</option>
                <option value="other">âœ³ï¸ Ø£Ø®Ø±Ù‰</option>
              </select>
            </div>
          </div>
        </section>

        <section class="card">
          <h3 class="section-title">Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù‚ÙŠØ§Ø³ ÙˆØ§Ù„ÙˆØ¬Ø¨Ø©</h3>
          <div class="grid g3">
            <div><label>Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</label><input type="number" id="reading" step="0.1" min="0"/><div id="statusBadge" class="status ok" style="display:none;"></div></div>
            <div><label>ÙƒØ§Ø±Ø¨ (Ø¬Ù…)</label><input type="number" id="carbs" step="0.1" min="0"/></div>
            <div><label>Ø¬Ø±Ø¹Ø© Ù…Ù‚ØªØ±Ø­Ø© (ICR)</label><input type="number" id="suggestedDose" readonly/></div>
            <div><label>Ø¬Ø±Ø¹Ø© ÙØ¹Ù„ÙŠØ©</label><input type="number" id="mealDose" step="0.1"/></div>
            <div id="correctionSection" style="display:none;"><label>Ø¬Ø±Ø¹Ø© ØªØµØ­ÙŠØ­ÙŠØ©</label><input type="number" id="correction" step="0.1"/></div>
            <div id="raiseSection" style="display:none;"><label>Ø±ÙØ¹ Ø§Ù„Ø³ÙƒØ±</label><input type="text" id="raise"/></div>
            <div style="grid-column:1/-1"><label>Ù…Ù„Ø§Ø­Ø¸Ø©</label><textarea id="note" rows="2"></textarea></div>
          </div>
          <div class="row" style="margin-top:8px">
            <button class="btn primary" id="saveBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³</button>
            <button class="btn gray" id="reloadDay">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª</button>
          </div>
        </section>

        <section class="card">
          <h3 class="section-title">Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
          <table>
            <thead><tr><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¬Ø±Ø¹Ø© Ø§Ù„ÙˆØ¬Ø¨Ø©</th><th>Ø§Ù„ØªØµØ­ÙŠØ­/Ø§Ù„Ø±ÙØ¹</th><th>Ù†ÙˆØ¹ Ø§Ù„Ù‚ÙŠØ§Ø³</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th></tr></thead>
            <tbody id="rows"><tr><td colspan="7" class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø¡Ø§Øª Ù„Ù„ÙŠÙˆÙ….</td></tr></tbody>
          </table>
        </section>
      </section>

      <!-- (3) Ø§Ù„ÙˆØ¬Ø¨Ø§Øª -->
      <section id="sec-meals" class="section">
        <section class="card">
          <div class="row" style="justify-content:space-between; align-items:center">
            <h3 class="section-title">ğŸ½ï¸ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª</h3>
            <div class="row">
              <a href="foods-admin.html" class="btn orange">ğŸ—‚ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</a>
            </div>
          </div>

          <!-- Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆØ¬Ø¨Ø© -->
          <div class="grid g3" style="margin-bottom:10px">
            <div><label>Ù†ÙˆØ¹ Ø§Ù„ÙˆØ¬Ø¨Ø©</label>
              <select id="mealType">
                <option value="breakfast">ÙØ·ÙˆØ±</option>
                <option value="lunch">ØºØ¯Ø§Ø¡</option>
                <option value="dinner">Ø¹Ø´Ø§Ø¡</option>
                <option value="snack">Ø³Ù†Ø§Ùƒ</option>
                <option value="other">Ø£Ø®Ø±Ù‰</option>
              </select>
            </div>
            <div><label>ÙˆÙ‚Øª Ø§Ù„Ø£ÙƒÙ„</label><input id="mealTime" type="datetime-local"></div>
            <div><label>Ù…Ù„Ø§Ø­Ø¸Ø©</label><input id="mealNotes" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></div>
          </div>

          <div class="meals-layout">
            <!-- Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª -->
            <div>
              <div class="row" style="margin-bottom:8px">
                <input id="foodSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ØµÙ†Ù..." style="width:100%">
              </div>
              <div id="catList" class="cats"></div>
            </div>

            <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ø£ØµÙ†Ø§Ù -->
            <div>
              <div id="foodsGrid" class="foods-grid"><div class="note">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>

              <!-- Ø§Ù„Ø³Ù„Ø© -->
              <div class="card" style="margin-top:12px">
                <div class="row" style="justify-content:space-between">
                  <h4 style="margin:0">ğŸ§º Ø³Ù„Ø© Ø§Ù„ÙˆØ¬Ø¨Ø©</h4>
                  <div class="small">ICR Ø§Ù„Ø­Ø§Ù„ÙŠ: <b id="icrNow">â€”</b> g/U</div>
                </div>
                <div class="basket" style="margin-top:8px; overflow:auto">
                  <table>
                    <thead><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„ÙƒØ§Ø±Ø¨ (Ø¬Ù…)</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                    <tbody id="basketBody"><tr><td colspan="4" class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ø¨Ø¹Ø¯.</td></tr></tbody>
                    <tfoot>
                      <tr><td><b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</b></td><td></td><td id="totalCarbsCell">0.0</td><td></td></tr>
                    </tfoot>
                  </table>
                </div>

                <div class="grid g3" style="margin-top:10px">
                  <div><label>Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©</label><input id="doseSuggestedMeal" readonly></div>
                  <div><label>Ø¬Ø±Ø¹Ø© ÙØ¹Ù„ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input id="doseGivenMeal" type="number" step="0.1"></div>
                  <div class="row" style="align-items:flex-end; justify-content:flex-end">
                    <button id="saveMealBtn" class="btn primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙˆØ¬Ø¨Ø©</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="note" style="margin-top:8px">Ø§Ù„Ø­Ø³Ø§Ø¨: (Ø§Ù„Ø¬Ø±Ø§Ù…Ø§Øª Ã— ÙƒØ§Ø±Ø¨/100) Ã· 100 â€¢ Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© = Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ§Ø±Ø¨ Ã· ICR (ØªÙ‚Ø±ÙŠØ¨ 0.1U).</div>
        </section>
      </section>

      <!-- (4) Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¯Ø§Ø´ Ø¨ÙˆØ±Ø¯ -->
      <section id="sec-reports" class="section">
        <section class="card controls">
          <h3 class="section-title">ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠ (mmol/L â€” Ù…Ù†Ø²Ù„Ø© Ø¹Ø´Ø±ÙŠØ© ÙˆØ§Ø­Ø¯Ø©)</h3>
          <div class="row">
            <label>Ø§Ù„ÙØªØ±Ø©:</label>
            <select id="weekPreset" class="no-print">
              <option value="last7">Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</option>
              <option value="thisWeek">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ</option>
              <option value="prevWeek">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø³Ø§Ø¨Ù‚</option>
              <option value="custom">Ù…Ø®ØµØµ</option>
            </select>
            <input id="fromW" type="date" class="no-print">
            <input id="toW" type="date" class="no-print">
            <button id="runWeekly" class="btn primary no-print">Ø¹Ø±Ø¶</button>
            <button id="printWeekly" class="btn gray">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© PDF</button>
            <button id="printBlank" class="btn gray">ğŸ“ ÙˆØ±Ù‚Ø© ÙØ§Ø±ØºØ©</button>
          </div>
          <div id="reportHeader" class="note" style="margin-top:6px"></div>
        </section>

        <section id="kpisBox" class="card" style="display:none">
          <div id="kpis" class="kpis"></div>
        </section>

        <section id="weeklyBox" class="card" style="display:none">
          <div class="weekly-layout">
            <div id="daysColumn"></div>
            <div>
              <div class="slots">
                <div class="slot"><div class="slot-name">Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸</div><div class="slot-val">uponWake</div></div>
                <div class="slot"><div class="slot-name">Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±</div><div class="slot-val">preBreakfast</div></div>
                <div class="slot"><div class="slot-name">Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±</div><div class="slot-val">postBreakfast</div></div>
                <div class="slot"><div class="slot-name">Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡</div><div class="slot-val">preLunch</div></div>
                <div class="slot"><div class="slot-name">Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡</div><div class="slot-val">postLunch</div></div>
                <div class="slot"><div class="slot-name">Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡</div><div class="slot-val">preDinner</div></div>
                <div class="slot"><div class="slot-name">Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡</div><div class="slot-val">postDinner</div></div>
                <div class="slot"><div class="slot-name">Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…</div><div class="slot-val">beforeSleep</div></div>
                <div class="slot"><div class="slot-name">Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…</div><div class="slot-val">duringSleep</div></div>
                <div class="slot"><div class="slot-name">Ù‚Ø¨Ù„ Ø§Ù„ØªÙ…Ø±ÙŠÙ†</div><div class="slot-val">beforeExercise</div></div>
                <div class="slot"><div class="slot-name">Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠÙ†</div><div class="slot-val">afterExercise</div></div>
                <div class="slot"><div class="slot-name">Ù‚ÙŠØ§Ø³ Ø¹Ø´ÙˆØ§Ø¦ÙŠ</div><div class="slot-val">random</div></div>
                <div class="slot"><div class="slot-name">Ø£Ø®Ø±Ù‰</div><div class="slot-val">other</div></div>
              </div>
              <div class="note" style="margin-top:8px">Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠØ³Ø± ÙŠÙˆØ¶Ø­ ØªÙˆÙ‚ÙŠØªØ§Øª Ø§Ù„ÙŠÙˆÙ… (ÙŠÙØ³ØªØ®Ø¯Ù… ÙƒÙ…Ø±Ø¬Ø¹ Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©/Ø§Ù„ØªØ¹Ø¨Ø¦Ø©).</div>
            </div>
          </div>
        </section>
      </section>

      <!-- Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… -->
      <section id="sec-doctor" class="section">
        <div class="card"><div class="note">ğŸ§‘â€âš•ï¸ Ø§Ù„Ø·Ø¨ÙŠØ¨ â€” Ù‚Ø±ÙŠØ¨Ù‹Ø§.</div></div>
      </section>
      <section id="sec-visits" class="section">
        <div class="card"><div class="note">ğŸ“… Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ© â€” Ù‚Ø±ÙŠØ¨Ù‹Ø§.</div></div>
      </section>
    </main>
  </div>

  <div id="toast" class="toast"></div>

  <script type="module">
    import { db, auth } from './firebase-init.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      doc, getDoc, setDoc,
      collection, getDocs, addDoc, query, orderBy, where, limit, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // ===== Helpers & DOM =====
    const $  = s => document.querySelector(s);
    const $$ = s => [...document.querySelectorAll(s)];
    const toastEl = $('#toast');
    const showToast = (m)=>{ toastEl.textContent=m; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'),2200); };
    const escapeHtml = s => (s||'').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    const slugify = s => (s||'').trim().toLowerCase().replace(/\s+/g,'-').replace(/[^\u0600-\u06FF\w-]/g,'');

    // Sidebar nav
    $$('.sb-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        $$('.sb-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        $$('.section').forEach(s=>s.classList.remove('active'));
        document.getElementById(btn.dataset.target).classList.add('active');
      });
    });

    // Header bits
    const elName   = $('#kidName');
    const img      = $('#childPhoto');
    const fallback = $('#avatarFallback');

    const params  = new URLSearchParams(location.search);
    const childId = params.get('child');

    const input   = id => document.getElementById(id);
    const genderRadios = () => [...document.querySelectorAll('input[name="gender"]')];
    const setGenderUI = (value) => genderRadios().forEach(r => r.checked = (r.value === value));
    const getGenderUI = () => (genderRadios().find(r => r.checked)?.value || null);
    const numOrNull = (el) => { const v = el.value; if (v === '' || v == null) return null; const n = Number(v); return Number.isFinite(n) ? n : null; };

    const setAvatarFallback = (name, gender) => {
      const initials = (name||'').trim().split(/\s+/).slice(0,2).map(w=>w[0]||'').join('').toUpperCase();
      fallback.textContent = initials || (gender==='male' ? 'ğŸ‘¦' : 'ğŸ‘§');
      fallback.style.display = 'grid';
    };
    const trySetPhoto = (child) => {
      const byId = `/images/${childId}.jpg`, byName = `/images/${slugify(child.name||'')}.jpg`;
      const test = (srcs,i=0)=>{ if(i>=srcs.length){ img.style.display='none'; setAvatarFallback(child.name, child.gender); return; }
        img.onload=()=>{ img.style.display='block'; fallback.style.display='none'; };
        img.onerror=()=>test(srcs,i+1); img.src=srcs[i];
      }; test([byId,byName]);
    };

    // Units & thresholds (Ù†Ø¹Ø±Ø¶ Ø¯Ø§Ø¦Ù…Ù‹Ø§ mmol 1 decimal Ø­Ø³Ø¨ Ø·Ù„Ø¨ Ø§Ù„ÙƒÙˆÙŠØª)
    let preferredUnit = 'mmol'; // Ù„Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙÙ‚Ø·ØŒ Ø§Ù„Ø¹Ø±Ø¶ Ø«Ø§Ø¨Øª mmol
    let targetMmol=null, lowMmol=null, highMmol=null;
    let icr = null; // g/U
    let basal = null, tdi = null; // Ù„Ù„ØªÙ‚Ø±ÙŠØ±

    const toMmol  = (v) => (v==null?null : (preferredUnit==='mgdl' ? v*0.0555 : v));
    const mmolDisp = (mmol) => (mmol==null? 'â€”' : Number(mmol).toFixed(1)); // Ø§Ù„ÙƒÙˆÙŠØª: Ù…Ù†Ø²Ù„Ø© ÙˆØ§Ø­Ø¯Ø© Ø¯Ø§Ø¦Ù…Ù‹Ø§
    const classify = (mmol)=> (lowMmol!=null && mmol<lowMmol)?'low': (highMmol!=null && mmol>highMmol)?'high':'ok';
    const arrow = (mmol)=> (mmol==null?'': classify(mmol)==='low'?'â¬‡ï¸': classify(mmol)==='high'?'â¬†ï¸':'âœ”ï¸');

    // ===== Auth & initial load =====
    onAuthStateChanged(auth, async (user) => {
      if (!user) { location.href='index.html'; return; }
      $('#btnLogout').addEventListener('click', ()=> signOut(auth).then(()=>location.href='index.html'));
      if (!childId){ elName.textContent='Ù„Ù… ÙŠØªÙ… ØªÙ…Ø±ÙŠØ± Ø±Ù‚Ù… Ø§Ù„Ø·ÙÙ„ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.'; setAvatarFallback('',''); return; }

      const childRef = doc(db, 'users', user.uid, 'children', childId);
      const snap = await getDoc(childRef);
      if (!snap.exists()){ elName.textContent='Ø§Ù„Ø·ÙÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ â—'; setAvatarFallback('',''); return; }

      const c = snap.data();
      elName.textContent = c.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
      trySetPhoto(c);

      // Fill child info
      input('childName').value     = c.name || '';
      setGenderUI(c.gender || '');
      input('childCivilId').value  = c.childCivilId || '';
      input('dob').value           = c.dob || '';
      input('heightCm').value      = c.heightCm ?? c.height ?? '';
      input('weightKg').value      = c.weightKg ?? c.weight ?? '';
      preferredUnit                = c.preferredUnit || 'mmol';
      input('preferredUnit').value = preferredUnit;
      input('defaultMeasurementType').value = c.defaultMeasurementType || 'fingerstick';
      input('notes').value         = c.notes || '';

      // Glucose config & dosing
      $('#unitBadge').textContent = `Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©: mmol/L`;
      $('#mUnitBadge').textContent= `Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©: mmol/L`;
      $('#isfUnitLabel').textContent = 'mmol/L Ù„ÙƒÙ„ 1U';

      const gc = (c.glucoseConfig||{});
      const dos= (c.dosing||{});
      targetMmol = gc.targetGlucoseMmol ?? null;
      lowMmol    = gc.lowThresholdMmol ?? null;
      highMmol   = gc.highThresholdMmol ?? null;

      input('target').value = targetMmol==null ? '' : Number(targetMmol).toFixed(1);
      input('low').value    = lowMmol==null ? ''    : Number(lowMmol).toFixed(1);
      input('high').value   = highMmol==null ? ''   : Number(highMmol).toFixed(1);

      basal = dos.basalTresibaUnits ?? null;
      tdi   = dos.totalDailyInsulinUnits ?? null;
      input('tresiba').value = basal ?? '';
      input('tdi').value     = tdi ?? '';
      const isfMmol = dos.isfMmolPerUnit ?? null;
      input('isf').value = isfMmol==null ? '' : Number(isfMmol).toFixed(2);
      input('icr').value = dos.icrGramsPerUnit ?? '';
      icr = dos.icrGramsPerUnit ?? null;
      $('#icrNow').textContent = icr ?? 'â€”';

      // Measurements defaults
      const today = new Date().toISOString().split('T')[0];
      input('dateSel').value = today;
      input('mType').value = c.defaultMeasurementType || 'fingerstick';

      bindInfoSavers(user.uid);
      bindMeasurementHandlers(user.uid);

      // Meals init
      setDefaultDateTimeNow(input('mealTime'));
      await mealsInit(user.uid);

      // Reports init
      initWeeklyControls();
      await runWeeklyReport(user.uid);
    });

    // ===== Save Info & Glucose config =====
    function bindInfoSavers(uid){
      $('#btnSaveInfo').addEventListener('click', async ()=>{
        const payload = {
          name: input('childName').value.trim() || null,
          gender: getGenderUI(),
          childCivilId: input('childCivilId').value.trim() || null,
          dob: input('dob').value || null,
          heightCm: numOrNull(input('heightCm')),
          weightKg: numOrNull(input('weightKg')),
          preferredUnit: input('preferredUnit').value, // Ù„Ù„Ù…Ø±Ø¬Ø¹ÙŠØ© ÙÙ‚Ø·
          defaultMeasurementType: input('defaultMeasurementType').value || 'fingerstick',
          notes: input('notes').value.trim() || null,
          storageUnit: "mmol",
          lastUpdatedAt: new Date().toISOString()
        };
        try{
          await setDoc(doc(db,'users',auth.currentUser.uid,'children',childId), payload, {merge:true});
          elName.textContent = payload.name || elName.textContent;
          showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„');
        }catch(e){ console.error(e); showToast('â— Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸'); }
      });

      $('#btnSuggest').addEventListener('click', ()=>{
        const tdiVal = Number(input('tdi').value);
        if (!tdiVal || tdiVal <= 0) { showToast('Ø£Ø¯Ø®Ù„ÙŠ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ… Ø£ÙˆÙ„Ù‹Ø§'); return; }
        const isfMmol = +(100/tdiVal).toFixed(2);
        const icrVal  = +(500/tdiVal).toFixed(1);
        input('isf').value = isfMmol;
        input('icr').value = icrVal;
        icr = icrVal;
        $('#icrNow').textContent = icr ?? 'â€”';
        showToast('ğŸ’¡ ØªÙ… Ø§Ù‚ØªØ±Ø§Ø­ ISF Ùˆ ICR');
      });

      $('#btnSaveGlucose').addEventListener('click', async ()=>{
        const target = numOrNull(input('target'));
        const low    = numOrNull(input('low'));
        const high   = numOrNull(input('high'));
        if (target!=null && low!=null && low >= target) { showToast('âš ï¸ Ø­Ø¯ Ø§Ù„Ù‡Ø¨ÙˆØ· Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù‡Ø¯Ù'); return; }
        if (target!=null && high!=null && high <= target){ showToast('âš ï¸ Ø­Ø¯ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù‡Ø¯Ù'); return; }

        const payload = {
          glucoseConfig: { targetGlucoseMmol: target, lowThresholdMmol: low, highThresholdMmol: high },
          dosing: {
            basalTresibaUnits      : numOrNull(input('tresiba')),
            totalDailyInsulinUnits : numOrNull(input('tdi')),
            isfMmolPerUnit         : numOrNull(input('isf')),
            icrGramsPerUnit        : numOrNull(input('icr'))
          },
          lastUpdatedAt: new Date().toISOString()
        };
        try{
          await setDoc(doc(db,'users',auth.currentUser.uid,'children',childId), payload, {merge:true});
          icr   = payload.dosing.icrGramsPerUnit ?? icr;
          basal = payload.dosing.basalTresibaUnits ?? basal;
          tdi   = payload.dosing.totalDailyInsulinUnits ?? tdi;
          $('#icrNow').textContent = icr ?? 'â€”';
          showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
        }catch(e){ console.error(e); showToast('â— Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸'); }
      });
    }

    // ===== Measurements =====
    function bindMeasurementHandlers(uid){
      input('dateSel').addEventListener('change', ()=> loadDay(uid));
      $('#reloadDay').addEventListener('click', ()=> loadDay(uid));
      input('carbs').addEventListener('input', ()=>{
        const carbs = Number(input('carbs').value);
        input('suggestedDose').value = (!icr || icr<=0 || !Number.isFinite(carbs)) ? '' : +(Math.round((carbs/icr)*10)/10).toFixed(1);
      });
      input('reading').addEventListener('input', onReadingChange);
      $('#saveBtn').addEventListener('click', ()=> onSaveMeasurement(uid));
      loadDay(uid);
    }

    function onReadingChange(){
      const valDisp = Number(input('reading').value);
      $('#correctionSection').style.display = 'none';
      $('#raiseSection').style.display      = 'none';
      $('#statusBadge').style.display       = 'none';
      if (!Number.isFinite(valDisp)) return;
      const mmol = toMmol(valDisp); // Ù„Ùˆ ÙƒØ§Ù†Øª mgdl ÙÙŠ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
      const cls = classify(mmol);
      const sb = $('#statusBadge');
      sb.className = `status ${cls}`;
      sb.style.display = 'inline-block';
      sb.textContent = (cls==='low'?'Ù…Ù†Ø®ÙØ¶':cls==='high'?'Ù…Ø±ØªÙØ¹':'Ø·Ø¨ÙŠØ¹ÙŠ');
      if (cls==='high') $('#correctionSection').style.display = 'block';
      if (cls==='low')  $('#raiseSection').style.display = 'block';
    }

    async function loadDay(uid){
      const date = input('dateSel').value;
      if (!date) return;
      const ref = doc(db,'users',uid,'children',childId,'measurements',date);
      const snap = await getDoc(ref);
      const readings = (snap.data()||{}).readings || {};
      renderRows(readings);
    }

    function renderRows(readings){
      const tbody = $('#rows');
      const labelSlot = {
        uponWake:'Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸',
        preBreakfast:'Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±', postBreakfast:'Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±',
        preLunch:'Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡', postLunch:'Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡',
        preDinner:'Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡', postDinner:'Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡',
        beforeSleep:'Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…', duringSleep:'Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…',
        beforeExercise:'Ù‚Ø¨Ù„ Ø§Ù„ØªÙ…Ø±ÙŠÙ†', afterExercise:'Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠÙ†',
        random:'Ù‚ÙŠØ§Ø³ Ø¹Ø´ÙˆØ§Ø¦ÙŠ', other:'Ø£Ø®Ø±Ù‰'
      };
      const slotsOrder = ['uponWake','preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep','beforeExercise','afterExercise','random','other'];

      const keys = slotsOrder.filter(k => readings[k]) // Ù…Ø±ØªØ¨Ø©
                      .concat(Object.keys(readings).filter(k=>!slotsOrder.includes(k)));

      if (keys.length===0){ tbody.innerHTML = '<tr><td colspan="7" class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø¡Ø§Øª Ù„Ù„ÙŠÙˆÙ….</td></tr>'; return; }
      tbody.innerHTML = '';
      for (const slot of keys){
        const r = readings[slot];
        const mmol = r?.valueMmol ?? (r?.value ?? null);
        const disp = mmolDisp(mmol);
        const cls = classify(mmol);
        const statusHtml = `<span class="status ${cls}">${cls==='low'?'Ù…Ù†Ø®ÙØ¶':cls==='high'?'Ù…Ø±ØªÙØ¹':'Ø·Ø¨ÙŠØ¹ÙŠ'}</span>`;
        const typeLabel = r?.measurementType==='cgm'?'ğŸ“ˆ CGM': r?.measurementType==='lab'?'ğŸ§ª Ù…Ø®ØªØ¨Ø±': r?.measurementType==='other'?'âœ³ï¸ Ø£Ø®Ø±Ù‰':'ğŸ©¸ ÙØ­Øµ Ø¥ØµØ¨Ø¹';
        const actionText = (r?.correction!=null) ? `ØªØµØ­ÙŠØ­: ${r.correction}U` : (r?.raise ? `Ø±ÙØ¹: ${escapeHtml(r.raise)}` : (r?.mealDose!=null? `${r.mealDose}U`:'-'));
        const note = r?.note || '-';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${labelSlot[slot]||slot}</td>
          <td>${disp} mmol/L</td>
          <td>${statusHtml}</td>
          <td>${r?.mealDose!=null ? r.mealDose : '-'}</td>
          <td>${actionText}</td>
          <td>${typeLabel}</td>
          <td>${escapeHtml(note)}</td>`;
        tbody.appendChild(tr);
      }
    }

    async function onSaveMeasurement(uid){
      const date = input('dateSel').value;
      const slot = input('slotSel').value;
      const raw = Number(input('reading').value);
      if (!date || !slot || !Number.isFinite(raw)) { showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„Ù‚ÙŠÙ…Ø©'); return; }
      const ref = doc(db,'users',uid,'children',childId,'measurements',date);
      const snap = await getDoc(ref);
      const base = snap.exists()? snap.data() : { readings:{} };
      if (base.readings[slot]?.valueMmol!=null || base.readings[slot]?.value!=null){ showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª Ù…Ø³Ø¨Ù‚Ø§Ù‹'); return; }
      const mmol = toMmol(raw) ?? raw;
      const payload = {
        valueMmol: +Number(mmol).toFixed(2),
        displayUnit: 'mmol',
        measurementType: input('mType').value || 'fingerstick',
        note: (input('note').value||'').trim() || null,
        carbs: numOrNull(input('carbs')),
        mealDose: numOrNull(input('mealDose')),
        correction: numOrNull(input('correction')),
        raise: (input('raise').value||'').trim() || null
      };
      base.readings[slot] = payload;
      try{
        await setDoc(ref, base, {merge:true});
        showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³');
        await loadDay(uid);
      }catch(e){ console.error(e); showToast('â— ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³'); }
    }

    // ===== Meals section =====
    let foods = [];           // Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù
    let catSet = [];          // ØªØµÙ†ÙŠÙØ§Øª ÙØ±ÙŠØ¯Ø©
    let activeCategory = 'Ø§Ù„ÙƒÙ„';
    let basket = [];          // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø³Ù„Ø©
    const DEFAULT_IMG = 'https://cdn-icons-png.flaticon.com/512/1046/1046784.png';

    async function mealsInit(uid){
      const qFoods = query(collection(db,'foods'), orderBy('category'), orderBy('name'), limit(500));
      const snap = await getDocs(qFoods);
      foods = [];
      snap.forEach(d => foods.push({id:d.id, ...d.data()}));

      const set = new Set();
      foods.forEach(f => { if (f.visible!==false && (f.status||'approved')==='approved' && f.category) set.add(f.category); });
      catSet = ['Ø§Ù„ÙƒÙ„', ...[...set].sort((a,b)=>a.localeCompare(b,'ar'))];
      renderCategories();
      renderFoods();

      $('#foodSearch').addEventListener('input', ()=> renderFoods());
      $('#icrNow').textContent = icr ?? 'â€”';
      updateBasketUI();
      setDefaultDateTimeNow(input('mealTime'));
    }

    function renderCategories(){
      const catList = $('#catList'); catList.innerHTML='';
      catSet.forEach(cat=>{
        const b = document.createElement('button');
        b.className = 'cat-btn' + (cat===activeCategory?' active':'');
        b.textContent = cat;
        b.addEventListener('click', ()=>{ activeCategory = cat; renderCategories(); renderFoods(); });
        catList.appendChild(b);
      });
    }

    function renderFoods(){
      const grid = $('#foodsGrid'); grid.innerHTML='';
      const term = ($('#foodSearch').value||'').trim().toLowerCase();
      const filtered = foods.filter(f=>{
        if (f.visible===false || (f.status||'approved')!=='approved') return false;
        if (activeCategory!=='Ø§Ù„ÙƒÙ„' && f.category!==activeCategory) return false;
        if (!term) return true;
        const tags = Array.isArray(f.tags) ? f.tags.join(' ') : (f.tags||'');
        return (f.name||'').toLowerCase().includes(term) || tags.toLowerCase().includes(term);
      });

      if (filtered.length===0){ grid.innerHTML='<div class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù.</div>'; return; }

      filtered.forEach(food=>{
        const card = document.createElement('div');
        card.className='food-card';
        const img = food.imageUrl || DEFAULT_IMG;
        const carbs = food.carbsPer100g ?? null;
        const servings = Array.isArray(food.servings) ? food.servings : [];
        const hasServings = servings.length>0;

        card.innerHTML = `
          <img src="${img}" alt="${escapeHtml(food.name)}">
          <div class="food-name">${escapeHtml(food.name||'â€”')}</div>
          <div class="food-sub">ÙƒØ§Ø±Ø¨/100Ø¬Ù…: <b>${carbs!=null? carbs: 'â€”'}</b></div>

          <div class="toggle">
            <button class="tg-gram active">Ø¬Ø±Ø§Ù…Ø§Øª</button>
            <button class="tg-serv" ${hasServings?'':'disabled'}>Ù…Ù‚ÙŠØ§Ø³</button>
          </div>

          <div class="mode-grams">
            <div class="row" style="justify-content:center">
              <input class="inp-grams" type="number" step="1" min="1" placeholder="Ø¬Ù…" style="width:90px">
            </div>
          </div>

          <div class="mode-serv" style="display:none">
            <div class="row" style="justify-content:center">
              <select class="sel-serv" style="min-width:140px"></select>
              <input class="inp-count" type="number" step="0.5" value="1" style="width:80px">
            </div>
          </div>

          <div class="small" style="text-align:center; margin:6px 0"><span class="live-carb pill">â€”</span></div>

          <div class="food-actions">
            <button class="btn primary btn-add">â• Ø£Ø¶Ù</button>
          </div>
        `;

        const sel = card.querySelector('.sel-serv');
        if (hasServings){
          servings.forEach((s,i)=>{
            const opt=document.createElement('option');
            opt.value=String(i);
            opt.textContent = `${s.label} â€” ${s.grams}Ø¬Ù…`;
            sel.appendChild(opt);
          });
        }else{
          const opt=document.createElement('option'); opt.value=''; opt.textContent='â€”';
          sel?.appendChild(opt);
        }

        const tgG = card.querySelector('.tg-gram');
        const tgS = card.querySelector('.tg-serv');
        const gBlock = card.querySelector('.mode-grams');
        const sBlock = card.querySelector('.mode-serv');
        tgG.addEventListener('click', ()=>{ tgG.classList.add('active'); tgS.classList.remove('active'); gBlock.style.display='block'; sBlock.style.display='none'; updateLive(); });
        tgS.addEventListener('click', ()=>{ if(!hasServings) return; tgS.classList.add('active'); tgG.classList.remove('active'); gBlock.style.display='none'; sBlock.style.display='block'; updateLive(); });

        const inpGrams = card.querySelector('.inp-grams');
        const inpCount = card.querySelector('.inp-count');
        sel?.addEventListener('change', updateLive);
        inpGrams?.addEventListener('input', updateLive);
        inpCount?.addEventListener('input', updateLive);

        function currentGrams(){
          if (tgG.classList.contains('active')){
            const g = Number(inpGrams.value);
            return Number.isFinite(g) && g>0 ? g : 0;
          }else{
            const ix = Number(sel.value);
            const cnt = Number(inpCount.value)||0;
            const s = servings[ix];
            if (!s || !Number.isFinite(cnt)) return 0;
            return s.grams * cnt;
          }
        }

        function updateLive(){
          const grams = currentGrams();
          const carb = grams && carbs!=null ? (grams*carbs/100) : 0;
          card.querySelector('.live-carb').textContent = carb? `${carb.toFixed(1)} Ø¬Ù…` : 'â€”';
        }
        updateLive();

        card.querySelector('.btn-add').addEventListener('click', ()=>{
          const grams = currentGrams();
          if (!grams || grams<=0){ showToast('Ø£Ø¯Ø®Ù„ÙŠ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©'); return; }
          const item = {
            foodId: food.id,
            name: food.name,
            category: food.category || '',
            grams: Math.round(grams),
            servingLabel: (!tgG.classList.contains('active') && hasServings) ? (servings[Number(sel.value)]?.label || null) : null,
            servingCount: (!tgG.classList.contains('active') && hasServings) ? (Number(inpCount.value)||1) : null,
            carbsPer100g: carbs ?? null,
            carbs: carbs!=null ? +(grams*carbs/100).toFixed(1) : null
          };
          basket.push(item);
          updateBasketUI();
          showToast('âœ… ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©');
          if (inpGrams) inpGrams.value='';
          if (inpCount) inpCount.value='1';
          updateLive();
        });

        grid.appendChild(card);
      });
    }

    function updateBasketUI(){
      const body = $('#basketBody');
      if (!basket.length){ body.innerHTML = '<tr><td colspan="4" class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ø¨Ø¹Ø¯.</td></tr>'; $('#totalCarbsCell').textContent='0.0'; $('#doseSuggestedMeal').value=''; return; }
      body.innerHTML='';
      let totalCarbs=0;
      basket.forEach((it,idx)=>{
        totalCarbs += it.carbs||0;
        const tr=document.createElement('tr');
        const qty = it.servingLabel ? `${it.servingCount} Ã— ${it.servingLabel} (${it.grams}Ø¬Ù…)` : `${it.grams} Ø¬Ù…`;
        tr.innerHTML = `
          <td>${escapeHtml(it.name)}</td>
          <td>${qty}</td>
          <td>${(it.carbs??0).toFixed(1)}</td>
          <td><button class="btn gray btn-del" data-i="${idx}">Ø­Ø°Ù</button></td>`;
        body.appendChild(tr);
      });
      body.querySelectorAll('.btn-del').forEach(b=>{
        b.addEventListener('click', ()=>{
          const i = Number(b.dataset.i);
          basket.splice(i,1);
          updateBasketUI();
        });
      });
      $('#totalCarbsCell').textContent = totalCarbs.toFixed(1);

      if (icr && icr>0){
        const dose = totalCarbs / icr;
        const rounded = Math.round(dose*10)/10;
        $('#doseSuggestedMeal').value = rounded.toFixed(1);
      }else{
        $('#doseSuggestedMeal').value = '';
      }
    }

    function setDefaultDateTimeNow(el){
      const d = new Date();
      const pad = n=> String(n).padStart(2,'0');
      const local = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
      el.value = local;
    }

    $('#saveMealBtn')?.addEventListener('click', async ()=>{
      const user = auth.currentUser; if (!user){ showToast('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'); return; }
      if (!basket.length){ showToast('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©'); return; }
      const eatenAtLocal = input('mealTime').value;
      if (!eatenAtLocal){ showToast('Ø§Ø®ØªØ§Ø±ÙŠ ÙˆÙ‚Øª Ø§Ù„Ø£ÙƒÙ„'); return; }
      const eatenAt = new Date(eatenAtLocal).toISOString();
      const totalCarbs = basket.reduce((s,it)=> s+(it.carbs||0), 0);
      const bolusSuggested = (icr && icr>0) ? Math.round((totalCarbs/icr)*10)/10 : null;

      try{
        await addDoc(collection(db,'users', auth.currentUser.uid,'children',childId,'meals'), {
          mealType: input('mealType').value || 'other',
          eatenAt,
          notes: input('mealNotes').value.trim() || null,
          totalCarbs: +totalCarbs.toFixed(1),
          bolusUnitsSuggested: bolusSuggested,
          bolusUnitsGiven: numOrNull(input('doseGivenMeal')),
          items: basket,
          computed: { icrGramsPerUnit: icr ?? null, preferredUnit: 'mmol' },
          createdAt: serverTimestamp()
        });
        showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙˆØ¬Ø¨Ø©');
        basket = [];
        updateBasketUI();
      }catch(e){ console.error(e); showToast('â— ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„ÙˆØ¬Ø¨Ø©'); }
    });

    // ===== Weekly Report inside dashboard =====
    const wk = {
      preset: $('#weekPreset'),
      from:   $('#fromW'),
      to:     $('#toW'),
      run:    $('#runWeekly'),
      print:  $('#printWeekly'),
      blank:  $('#printBlank'),
      header: $('#reportHeader'),
      kpisBox:$('#kpisBox'), kpis: $('#kpis'),
      box:    $('#weeklyBox'), daysCol: $('#daysColumn'),
      slotsMap: [
        ['uponWake','Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸'],
        ['preBreakfast','Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±'], ['postBreakfast','Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±'],
        ['preLunch','Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡'],     ['postLunch','Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡'],
        ['preDinner','Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡'],     ['postDinner','Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡'],
        ['beforeSleep','Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…'],    ['duringSleep','Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…'],
        ['beforeExercise','Ù‚Ø¨Ù„ Ø§Ù„ØªÙ…Ø±ÙŠÙ†'], ['afterExercise','Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠÙ†'],
        ['random','Ù‚ÙŠØ§Ø³ Ø¹Ø´ÙˆØ§Ø¦ÙŠ'], ['other','Ø£Ø®Ø±Ù‰']
      ]
    };

    function initWeeklyControls(){
      // default last 7 days
      const today = new Date();
      const to = fmtDate(today);
      const from = fmtDate(addDays(today, -6));
      wk.from.value = from; wk.to.value = to;
      wk.preset.value = 'last7';

      wk.preset.addEventListener('change', ()=>{
        if (wk.preset.value==='custom'){ wk.from.disabled=false; wk.to.disabled=false; return; }
        wk.from.disabled=true; wk.to.disabled=true;
        const now = new Date();
        if (wk.preset.value==='last7'){
          wk.from.value = fmtDate(addDays(now,-6));
          wk.to.value   = fmtDate(now);
        }else if (wk.preset.value==='thisWeek'){
          const s = startOfWeek(now); const e = endOfWeek(now);
          wk.from.value = fmtDate(s); wk.to.value = fmtDate(e);
        }else if (wk.preset.value==='prevWeek'){
          const s = addDays(startOfWeek(now), -7); const e = addDays(endOfWeek(now), -7);
          wk.from.value = fmtDate(s); wk.to.value = fmtDate(e);
        }
      });
      wk.run.addEventListener('click', ()=> runWeeklyReport(auth.currentUser.uid));
      wk.print.addEventListener('click', ()=> window.print());
      wk.blank.addEventListener('click', ()=> printWeeklyBlank());
    }

    function fmtDate(d){ const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`; }
    function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
    function startOfWeek(d){ const x=new Date(d); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); return x; } // Monday
    function endOfWeek(d){ const s=startOfWeek(d); return addDays(s,6); }

    async function runWeeklyReport(uid){
      const from = wk.from.value, to = wk.to.value;
      if (!from || !to) { showToast('Ø­Ø¯Ø¯ÙŠ Ø§Ù„ÙØªØ±Ø©'); return; }

      // Header: Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„ + Ø§Ù„Ø¬Ø±Ø¹Ø§Øª
      const childSnap = await getDoc(doc(db,'users',uid,'children',childId));
      const c = childSnap.data()||{};
      const age = calcAge(c.dob);
      const weight = (c.weightKg ?? c.weight ?? 'â€”');
      const height = (c.heightCm ?? c.height ?? 'â€”');
      wk.header.innerHTML = `
        <b>Ø§Ù„Ø§Ø³Ù…:</b> ${escapeHtml(c.name||'â€”')}
        â€¢ <b>Ø§Ù„Ø³Ù†:</b> ${age ?? 'â€”'}
        â€¢ <b>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ:</b> ${escapeHtml(c.childCivilId||'â€”')}
        â€¢ <b>Ø§Ù„ÙˆØ²Ù†:</b> ${weight} ÙƒØ¬Ù…
        â€¢ <b>Ø§Ù„Ø·ÙˆÙ„:</b> ${height} Ø³Ù…
        â€¢ <b>ØªØ±Ø³ÙŠØ¨Ø§:</b> ${basal??'â€”'}U
        â€¢ <b>TDI:</b> ${tdi??'â€”'}U
        â€¢ <b>Ø§Ù„Ø­Ø¯ÙˆØ¯ (mmol/L):</b> â¬‡ï¸ ${lowMmol!=null? mmolDisp(lowMmol):'â€”'} â€¢ Ù‡Ø¯Ù ${targetMmol!=null? mmolDisp(targetMmol):'â€”'} â€¢ â¬†ï¸ ${highMmol!=null? mmolDisp(highMmol):'â€”'}
      `;

      const days = enumerateDays(from, to); // max 7 Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹

      // Measurements docs
      const measSnaps = await Promise.all(days.map(d => getDoc(doc(db,'users',uid,'children',childId,'measurements',d))));
      const byDate = {}; days.forEach((d,i)=> byDate[d] = measSnaps[i].data() || { date:d, readings:{} });

      // Meals for the window
      let mealsByDateSlot = {};
      try{
        const startIso = new Date(from+"T00:00:00").toISOString();
        const endIso   = new Date(to  +"T23:59:59").toISOString();
        const qMeals = query(
          collection(db,'users',uid,'children',childId,'meals'),
          where('eatenAt','>=', startIso),
          where('eatenAt','<=', endIso),
          orderBy('eatenAt','asc')
        );
        const mSnap = await getDocs(qMeals);
        mSnap.forEach(ms=>{
          const m=ms.data();
          const d = (m.eatenAt||'').slice(0,10);
          const slot = mealTypeToSlot(m.mealType||'other');
          mealsByDateSlot[d] = mealsByDateSlot[d] || {};
          mealsByDateSlot[d][slot] = mealsByDateSlot[d][slot] || [];
          mealsByDateSlot[d][slot].push({
            totalCarbs: m.totalCarbs ?? null,
            bolusSuggested: m.bolusUnitsSuggested ?? null,
            bolusGiven: m.bolusUnitsGiven ?? null,
            note: m.notes || null
          });
        });
      }catch(e){ console.warn('Meals query needs index or failed, continuing without meals', e); }

      // KPIs
      const allMMOL = [];
      let cntLow=0, cntOk=0, cntHigh=0;
      let mealsCarb=0, bolusSug=0, bolusGiven=0;

      // Render days
      wk.daysCol.innerHTML='';
      days.forEach(d=>{
        const dayBox = document.createElement('div');
        dayBox.className = 'day-card';
        const readings = (byDate[d].readings||{});

        // â€œÙ…Ù„Ù Ø§Ù„ÙŠÙˆÙ…â€ ÙŠÙ…ÙŠÙ†: Ø§Ù„ØªØ§Ø±ÙŠØ® + Ø£Ø¨Ø±Ø² Ù‚Ø±Ø§Ø¡Ø© + Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ø®ØªØµØ±Ø©
        const main = bestDailyReading(readings);
        if (main.mmol!=null){
          allMMOL.push(main.mmol);
          const cls = classify(main.mmol);
          if (cls==='low') cntLow++; else if (cls==='high') cntHigh++; else cntOk++;
        }
        const mealsBrief = summarizeMeals(mealsByDateSlot[d]);

        dayBox.innerHTML = `
          <div class="day-head">
            <div class="day-title">${d}</div>
            <div class="day-arrow ${main.cls==='low'?'arrow-down':main.cls==='high'?'arrow-up':'arrow-ok'}">${arrow(main.mmol)}</div>
          </div>
          <div class="day-main">
            <b>Ø§Ù„Ù‚ÙŠØ§Ø³:</b> ${main.mmol!=null? mmolDisp(main.mmol)+' mmol/L' : 'â€”'}
            ${mealsBrief? `<div class="meal-mini">ğŸ½ ${mealsBrief}</div>`:''}
          </div>
          <div class="day-notes">${escapeHtml(main.note||'')}</div>
        `;

        // â€œØ³Ù„Ù… Ø§Ù„ØªÙˆÙ‚ÙŠØªØ§Øªâ€ Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„ÙƒØ§Ø±Øª (ØªØ­Øª Ø§Ù„Ù…Ù„Ù)
        const slotsWrap = document.createElement('div');
        slotsWrap.className = 'slots';
        wk.slotsMap.forEach(([key,name])=>{
          const r = readings[key];
          const mmol = (r?.valueMmol ?? r?.value ?? null);
          const val = mmol!=null ? `${arrow(mmol)} ${mmolDisp(mmol)} mmol/L` : 'â€”';
          const line = document.createElement('div');
          line.className = 'slot';
          line.innerHTML = `<div class="slot-name">${name}</div><div class="slot-val">${val}</div>`;
          // attach meal line if exist
          const ms = (mealsByDateSlot[d]||{})[key] || [];
          if (ms.length){
            const csum = ms.reduce((s,x)=> s+(x.totalCarbs||0), 0);
            const ssum = ms.reduce((s,x)=> s+(x.bolusSuggested||0), 0);
            const gsum = ms.reduce((s,x)=> s+(x.bolusGiven||0), 0);
            mealsCarb += csum; bolusSug += ssum; bolusGiven += gsum;
            const mdiv = document.createElement('div');
            mdiv.className = 'meal-mini';
            mdiv.textContent = `ğŸ½ ${csum.toFixed(1)}g â€¢ Ù…Ù‚ØªØ±Ø­ ${ssum? ssum.toFixed(1):'â€”'}U â€¢ ÙØ¹Ù„ÙŠ ${gsum? gsum.toFixed(1):'â€”'}U`;
            line.appendChild(mdiv);
          }
          slotsWrap.appendChild(line);
        });
        dayBox.appendChild(slotsWrap);
        wk.daysCol.appendChild(dayBox);
      });

      // KPIs render
      const total = cntLow+cntOk+cntHigh;
      const tir = total? Math.round((cntOk/total)*100) : null;
      const avg = allMMOL.length ? (allMMOL.reduce((a,b)=>a+b,0)/allMMOL.length) : null;
      const min = allMMOL.length ? Math.min(...allMMOL) : null;
      const max = allMMOL.length ? Math.max(...allMMOL) : null;

      wk.kpis.innerHTML='';
      addChip(`TIR: ${tir!=null? tir+'%':'â€”'}`);
      addChip(`Ù…ØªÙˆØ³Ø·: ${avg!=null? mmolDisp(avg):'â€”'} mmol/L`);
      addChip(`Ø£Ø¯Ù†Ù‰: ${min!=null? mmolDisp(min):'â€”'} mmol/L`);
      addChip(`Ø£Ø¹Ù„Ù‰: ${max!=null? mmolDisp(max):'â€”'} mmol/L`);
      addChip(`Ù…Ù†Ø®ÙØ¶: ${cntLow}`);
      addChip(`Ø·Ø¨ÙŠØ¹ÙŠ: ${cntOk}`);
      addChip(`Ù…Ø±ØªÙØ¹: ${cntHigh}`);
      addChip(`ÙƒØ§Ø±Ø¨ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª: ${mealsCarb.toFixed(1)} g`);
      addChip(`Ø¬Ø±Ø¹Ø§Øª: Ù…Ù‚ØªØ±Ø­ ${bolusSug.toFixed(1)}U â€¢ ÙØ¹Ù„ÙŠ ${bolusGiven.toFixed(1)}U`);
      wk.kpisBox.style.display='block';
      wk.box.style.display='block';

      function addChip(text){ const el=document.createElement('div'); el.className='chip'; el.textContent=text; wk.kpis.appendChild(el); }
    }

    function enumerateDays(from,to){
      const res=[]; let d=new Date(from+"T00:00:00"); const end=new Date(to+"T00:00:00");
      // Ù†Ù‚ØªØµØ± Ø¹Ù„Ù‰ 7 Ø£ÙŠØ§Ù… Ù„Ø¹Ø±Ø¶ Ø£Ø³Ø¨ÙˆØ¹
      for(let i=0;i<7 && d<=end;i++){ res.push(fmtDate(d)); d = addDays(d,1); }
      return res;
    }

    function calcAge(dob){
      if (!dob) return null;
      const d=new Date(dob); const n=new Date();
      let y=n.getFullYear()-d.getFullYear();
      const m=n.getMonth()-d.getMonth();
      if (m<0 || (m===0 && n.getDate()<d.getDate())) y--;
      return y;
    }

    function bestDailyReading(readings){
      // Ø§Ø®ØªÙŠØ§Ø± Ø£Ø¨Ø²Ø± Ù‚Ø±Ø§Ø¡Ø© (ØªÙØ¶ÙŠÙ„: uponWake -> preBreakfast -> beforeSleep -> ØºÙŠØ± Ø°Ù„ÙƒØŒ ÙˆØ¥Ù„Ø§ Ø£ÙˆÙ„ Ù‚Ø±Ø§Ø¡Ø©)
      const order = ['uponWake','preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep','beforeExercise','afterExercise','random','other'];
      for (const k of order){
        if (readings[k] && (readings[k].valueMmol!=null || readings[k].value!=null)){
          const r = readings[k]; const mmol = r.valueMmol ?? r.value;
          return { mmol, cls: classify(mmol), note: r.note||r.raise||'' };
        }
      }
      // fallback
      const keys = Object.keys(readings);
      if (keys.length){
        const r = readings[keys[0]];
        const mmol = r?.valueMmol ?? r?.value ?? null;
        return { mmol, cls: classify(mmol), note: r?.note||'' };
      }
      return { mmol:null, cls:'ok', note:'' };
    }

    function mealTypeToSlot(mealType){
      switch(mealType){
        case 'breakfast': return 'postBreakfast';
        case 'lunch':     return 'postLunch';
        case 'dinner':    return 'postDinner';
        case 'snack':     return 'random';
        default:          return 'random';
      }
    }

    function summarizeMeals(bySlot){
      if (!bySlot) return '';
      // Ù†Ø¬Ù…Ø¹ Ø£Ù‡Ù… Ù…Ø§ ÙÙŠ Ø§Ù„ÙŠÙˆÙ…
      let carbs=0, sug=0, giv=0;
      Object.values(bySlot).forEach(arr=>{
        (arr||[]).forEach(m=>{ carbs += (m.totalCarbs||0); sug += (m.bolusSuggested||0); giv += (m.bolusGiven||0); });
      });
      if (!carbs) return '';
      return `${carbs.toFixed(1)}g â€¢ ${sug? sug.toFixed(1):'â€”'}U â€¢ ${giv? giv.toFixed(1):'â€”'}U`;
    }

    function printWeeklyBlank(){
      // ØªØ­ÙˆÙŠÙ„ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¥Ù„Ù‰ â€œÙØ±Ø§ØºØ§Øªâ€ Ø¨Ø´ÙƒÙ„ Ø³Ø±ÙŠØ¹ Ø«Ù… print
      const daysCol = wk.daysCol;
      daysCol.innerHTML='';
      const from = wk.from.value, to = wk.to.value;
      const days = enumerateDays(from,to);

      days.forEach(d=>{
        const dayBox = document.createElement('div'); dayBox.className='day-card';
        dayBox.innerHTML = `
          <div class="day-head">
            <div class="day-title">${d}</div>
            <div class="day-arrow"> </div>
          </div>
          <div class="day-main"><b>Ø§Ù„Ù‚ÙŠØ§Ø³:</b> ________ mmol/L</div>
          <div class="day-notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ________________________________</div>
        `;
        const slotsWrap = document.createElement('div'); slotsWrap.className='slots';
        wk.slotsMap.forEach(([key,name])=>{
          const line = document.createElement('div'); line.className='slot';
          line.innerHTML = `<div class="slot-name">${name}</div><div class="slot-val">________ mmol/L</div>`;
          const mdiv = document.createElement('div');
          mdiv.className = 'meal-mini';
          mdiv.textContent = `ğŸ½ ÙƒØ§Ø±Ø¨: ________ g â€¢ Ø¬Ø±Ø¹Ø©: ________ U`;
          line.appendChild(mdiv);
          slotsWrap.appendChild(line);
        });
        dayBox.appendChild(slotsWrap);
        daysCol.appendChild(dayBox);
      });

      // Ø±Ø£Ø³ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙŠØ¸Ù„ ÙƒÙ…Ø§ Ù‡Ùˆ (Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„)
      window.print();
    }
  </script>
</body>
</html>
