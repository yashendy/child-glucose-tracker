<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>لوحة الطفل</title>
  <!-- مظهر عام موحّد للمشروع -->
  <link rel="stylesheet" href="styles.css">
  <style>
    /* إضافات خفيفة فوق styles.css */
    .tiles{display:grid;gap:12px;grid-template-columns:repeat(2,minmax(0,1fr))}
    @media(min-width:900px){.tiles{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .tile{display:flex;flex-direction:column;gap:8px;background:var(--card);border:1px solid var(--line);
      border-radius:14px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    .tile h3{margin:0;font-size:18px}
    .tile .actions{margin-top:auto;display:flex;gap:8px;flex-wrap:wrap}
    .kpis{display:grid;gap:10px;grid-template-columns:repeat(3,minmax(0,1fr))}
    .kpis .box{background:#f8fafc;border:1px solid var(--line);border-radius:12px;padding:10px}
    .kpis .label{font-size:12px;color:var(--muted)}
    .kpis .value{font-weight:800}
    .child-nav{display:flex;gap:8px;flex-wrap:wrap}
    .child-banner{text-align:center;padding:12px 8px;display:none}
    .child-banner .avatar{width:84px;height:84px;border-radius:50%;object-fit:cover;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.12)}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>

  <!-- ✅ بنر الطفل أعلى الصفحة -->
  <div id="childBanner" class="child-banner">
    <img id="bannerAvatar" class="avatar" src="images/avatar-default.png" alt="صورة الطفل">
    <div style="margin-top:6px;font-weight:800" id="bannerName">—</div>
    <div class="small" id="bannerMeta">—</div>
  </div>

  <!-- ✅ شريط علوي -->
  <div class="topbar">
    <div>📊 لوحة الطفل</div>
    <div class="row">
      <a id="lnkHome" class="btn gray">الرئيسية</a>
      <button id="btnLogout" class="btn">خروج</button>
    </div>
  </div>

  <main class="container">

    <!-- ✅ تنقّل صفحات الطفل (مهم: تمت إضافة تقرير الطبيب) -->
    <div class="card">
      <div id="childNav" class="child-nav"></div>
    </div>

    <!-- ✅ لمحة سريعة + KPIs اليوم -->
    <section class="card">
      <h3 class="section-title">ملخص اليوم</h3>
      <div class="kpis" id="kpiRow">
        <div class="box"><div class="label">قراءات اليوم</div><div id="k_today" class="value">—</div></div>
        <div class="box"><div class="label">متوسط اليوم</div><div id="k_avg" class="value">—</div></div>
        <div class="box"><div class="label">% داخل النطاق</div><div id="k_tir" class="value">—%</div></div>
      </div>
      <div class="small" id="limitsBadge" style="margin-top:6px">—</div>
    </section>

    <!-- ✅ بلاطات أقسام سريعة -->
    <section class="tiles">
      <article class="tile">
        <h3>🧪 قياسات السكر</h3>
        <p class="small">تسجيل قراءة جديدة واستعراض قراءات اليوم.</p>
        <div class="actions">
          <a id="goMeasures" class="btn primary">افتح قياسات السكر</a>
        </div>
      </article>

      <article class="tile">
        <h3>🍽️ الوجبات</h3>
        <p class="small">اختيار الأصناف وحساب الكارب والجرعة المقترحة.</p>
        <div class="actions">
          <a id="goMeals" class="btn primary">افتح الوجبات</a>
        </div>
      </article>

      <article class="tile">
        <h3>📄 التقارير</h3>
        <p class="small">تقرير أسبوع/شهر ونسخة للطباعة.</p>
        <div class="actions">
          <a id="goReports" class="btn primary">افتح التقارير</a>
        </div>
      </article>

      <article class="tile">
        <h3>🧑‍⚕️ تقرير الطبيب</h3>
        <p class="small">تحليل القياسات + رسوم (خط/دونات/توزيع) وPDF.</p>
        <div class="actions">
          <!-- 👇 هذا هو الزر المطلوب لفتح صفحة تقرير الطبيب -->
          <a id="goDoctorReport" class="btn primary">افتح تقرير الطبيب</a>
        </div>
      </article>

      <article class="tile">
        <h3>📅 الزيارات الطبية</h3>
        <p class="small">سجل الزيارات والمرفقات والطباعة.</p>
        <div class="actions">
          <a id="goVisits" class="btn primary">افتح الزيارات</a>
        </div>
      </article>

      <article class="tile">
        <h3>🧒 بيانات الطفل</h3>
        <p class="small">تعديل البيانات والصورة والإعدادات.</p>
        <div class="actions">
          <a id="goProfile" class="btn primary">افتح البيانات</a>
        </div>
      </article>
    </section>

  </main>

  <div id="toast" class="toast"></div>
  <div id="loader" class="loader"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>

  <script type="module">
    import {
      auth, db, ensureAuth, requireChildIdFromQuery, setChildAvatar
    } from './firebase-init.js';

    import { signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      doc, getDoc, collection, getDocs
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const $ = s=>document.querySelector(s);
    const toast=(m)=>{const t=$("#toast");t.textContent=m;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),2000)}
    const showLoader=(on)=>{$("#loader").style.display=on?'flex':'none'}

    const z2=n=>String(n).padStart(2,'0');
    const todayISO=()=>{const d=new Date();return `${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())}`;}

    let uid=null, childId=null, child={};

    // 🔁 بدء اللوحة
    (async function boot(){
      showLoader(true);
      const {uid:U}=await ensureAuth(); uid=U;
      childId = requireChildIdFromQuery();

      // روابط أعلى الصفحة
      $("#lnkHome").href=`dashboard.html`;
      $("#btnLogout").addEventListener('click', ()=>signOut(auth).then(()=>location.href='index.html'));

      // تنقّل بين صفحات الطفل (يشمل تقرير الطبيب)
      buildChildNav();

      // تحميل بيانات الطفل + ملخص اليوم
      await loadChild();
      await loadTodayKPI();

      // ربط أزرار البلاطات
      $("#goMeasures").href = `measures.html?child=${encodeURIComponent(childId)}`;
      $("#goMeals").href    = `meals.html?child=${encodeURIComponent(childId)}`;
      $("#goReports").href  = `reports.html?child=${encodeURIComponent(childId)}`;
      $("#goDoctorReport").href = `doctor-report.html?child=${encodeURIComponent(childId)}`; // ✅ زر تقرير الطبيب
      $("#goVisits").href   = `visits.html?child=${encodeURIComponent(childId)}`;
      $("#goProfile").href  = `child-profile.html?child=${encodeURIComponent(childId)}`;
    })().finally(()=>showLoader(false));

    // 🧭 تنقّل أعلى الصفحة
    function buildChildNav(){
      const row=$("#childNav"); row.innerHTML='';
      [
        ['child-dashboard.html','الرئيسية'],
        ['measures.html','قياسات السكر'],
        ['meals.html','الوجبات'],
        ['reports.html','التقارير'],
        ['doctor-report.html','تقرير الطبيب'], // ✅ تمت إضافة تقرير الطبيب
        ['visits.html','الزيارات الطبية']
      ].forEach(([h,t])=>{
        const a=document.createElement('a');
        a.className='btn gray';
        a.href=`${h}?child=${encodeURIComponent(childId)}`;
        a.textContent=t;
        row.appendChild(a);
      });
    }

    // 👶 تحميل بيانات الطفل وعرضها في البنر
    async function loadChild(){
      const s=await getDoc(doc(db,'users',uid,'children',childId));
      if(!s.exists()){ toast('الطفل غير موجود'); return; }
      child=s.data()||{};
      setChildAvatar($('#bannerAvatar'), child.name, child.photoURL);
      $('#bannerName').textContent = child.name || '—';
      $('#bannerMeta').textContent = `${child.gender||'—'} • ${child.weight??'—'} كجم • ${child.height??'—'} سم`;
      $('#childBanner').style.display='block';
      $('#limitsBadge').textContent = `الوحدة: mmol/L • حدود: ${child.lowThreshold??'—'} — ${child.highThreshold??'—'}`;
    }

    // 📅 ملخص اليوم من مجموعة measurements
    async function loadTodayKPI(){
      const today = todayISO();
      const ref = doc(db,'users',uid,'children',childId,'measurements',today);
      const s = await getDoc(ref);
      const readings = (s.data()||{}).readings || {};
      const values = Object.values(readings).map(r=> Number(r?.valueMmol ?? r?.value)).filter(v=>Number.isFinite(v));
      const total = values.length;
      const avg   = total? (values.reduce((a,b)=>a+b,0)/total):null;

      let ok=0, low=0, high=0;
      const lo=Number(child.lowThreshold), hi=Number(child.highThreshold);
      values.forEach(v=>{
        if(isFinite(lo)&&v<lo) low++;
        else if(isFinite(hi)&&v>hi) high++;
        else ok++;
      });
      const tir = total? Math.round((ok/total)*100) : 0;

      $('#k_today').textContent = total || 0;
      $('#k_avg').textContent   = avg!=null? avg.toFixed(1) : '—';
      $('#k_tir').textContent   = tir + '%';
    }
  </script>
</body>
</html>
