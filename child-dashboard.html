<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ููุญุฉ ุงูุทูู</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <!-- โ ุจูุฑ ุงูุทูู (ูุจู ุงูุชูุจ ุจุงุฑ) -->
  <div id="childBanner" style="text-align:center; padding:12px 8px; display:none">
    <img id="bannerAvatar" src="images/avatar-default.png" alt="ุตูุฑุฉ ุงูุทูู" class="avatar" style="width:84px;height:84px">
    <div style="margin-top:6px; font-weight:800" id="bannerName">โ</div>
    <div class="note" id="bannerMeta">โ</div>
  </div>

  <!-- โ Topbar -->
  <div class="topbar">
    <div>๐ ููุญุฉ ุงูุทูู</div>
    <div class="row">
      <a id="lnkHome" class="btn gray">ุงูุฑุฆูุณูุฉ</a>
      <button id="btnLogout" class="btn">ุฎุฑูุฌ</button>
    </div>
  </div>

  <!-- โ ุฑูุงุจุท ุชููู ุฏุงุฎููุฉ -->
  <main class="container">
    <div class="card">
      <div class="row" id="childNav" style="flex-wrap:wrap"></div>
    </div>

    <!-- โ ุจูุงูุงุช ุงูุทูู -->
    <section class="card">
      <h3 class="section-title">๐ง ุจูุงูุงุช ุงูุทูู</h3>
      <div class="grid g2">
        <div><label>ุงูุงุณู</label><input id="cName"></div>
        <div><label>ุงูููุน</label>
          <select id="cGender"><option>ุฐูุฑ</option><option>ุฃูุซู</option></select>
        </div>
        <div><label>ุงูุฑูู ุงููุฏูู</label><input id="cCivilId"></div>
        <div><label>ุชุงุฑูุฎ ุงููููุงุฏ</label><input id="cBirth" type="date"></div>
        <div><label>ุงููุฒู (ูุฌู)</label><input id="cWeight" type="number" step="0.1"></div>
        <div><label>ุงูุทูู (ุณู)</label><input id="cHeight" type="number" step="0.1"></div>
      </div>

      <div class="sep" style="height:8px"></div>
      <h4 class="section-title">โ๏ธ ุฅุนุฏุงุฏุงุช ุงูุณูุฑ</h4>
      <div class="grid g3">
        <div><label>ุงููุญุฏุฉ ุงูููุถูุฉ</label>
          <select id="cUnit"><option value="mmol/L">mmol/L</option><option value="mg/dL">mg/dL</option></select>
        </div>
        <div><label>ุงููุฏู</label><input id="cTarget" type="number" step="0.1"></div>
        <div><label>ุญุฏ ุงููุจูุท</label><input id="cLow" type="number" step="0.1"></div>
        <div><label>ุญุฏ ุงูุงุฑุชูุงุน</label><input id="cHigh" type="number" step="0.1"></div>
        <div><label>ุฌุฑุนุฉ ุงูุชุฑุณูุจุง</label><input id="cTresiba" type="number" step="0.1"></div>
        <div><label>ุงูุฃูุณูููู ุงููููู</label><input id="cTotalInsulin" type="number" step="0.1"></div>
        <div><label>ูุนุงูู ุงูุชุตุญูุญ (mmol/L ููู 1U)</label><input id="cCorrectionFactor" type="number" step="0.1"></div>
        <div><label>ICR (ุฌุฑุงู ูุงุฑุจ/1U)</label><input id="cICR" type="number" step="0.1"></div>
      </div>

      <div class="sep" style="height:8px"></div>
      <h4 class="section-title">๐ท ุตูุฑุฉ ุงูุทูู</h4>
      <div class="row">
        <input type="file" id="cPhoto" accept="image/*">
        <div id="uploadProg" style="height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden;display:none;min-width:160px">
          <span style="display:block;height:100%;background:linear-gradient(90deg,#22c55e,#06b6d4);width:0%"></span>
        </div>
      </div>

      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button id="saveInfo" class="btn primary">๐พ ุญูุธ ุงูุจูุงูุงุช</button>
      </div>
    </section>
  </main>

  <!-- โ Toast + Loader -->
  <div id="toast" class="toast"></div>
  <div id="loader" class="loader"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>

  <!-- โ Script -->
  <script type="module">
    import { auth, db, storage, ensureAuth, logout, requireChildIdFromQuery, setChildAvatar } from './firebase-init.js';
    import { signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    import { ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

    const toast = (m)=>{ const t=document.getElementById('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); }
    const showLoader=(on)=>{ const l=document.getElementById('loader'); l.style.display=on?'flex':'none'; }

    let uid=null, childId=null, child=null;

    // ุฑูุงุจุท ุชููู ููุญูุฏุฉ
    function buildNav(){
      const base = [
        ['dashboard.html','ุงูุฑุฆูุณูุฉ'],
        ['measures.html','ููุงุณุงุช ุงูุณูุฑ'],
        ['meals.html','ุงููุฌุจุงุช'],
        ['reports.html','ุงูุชูุงุฑูุฑ'],
        ['visits.html','ุงูุฒูุงุฑุงุช ุงูุทุจูุฉ']
      ];
      const row = document.getElementById('childNav');
      row.innerHTML = '';
      base.forEach(([href,label])=>{
        const a = document.createElement('a');
        a.className='btn gray';
        a.href = `${href}?child=${encodeURIComponent(childId)}`;
        a.textContent = label;
        row.appendChild(a);
      });
      // ุฒุฑ ุงูุฑุฆูุณูุฉ ุฃุนูู ุฃูุถูุง
      document.getElementById('lnkHome').href = `child-dashboard.html?child=${encodeURIComponent(childId)}`;
    }

    async function loadChild(){
      const snap = await getDoc(doc(db,'users',uid,'children',childId));
      if(!snap.exists()){ toast('ุงูุทูู ุบูุฑ ููุฌูุฏ'); return; }
      child = snap.data();
      // ุจูุฑ
      setChildAvatar(document.getElementById('bannerAvatar'), child.name, child.photoURL);
      document.getElementById('bannerName').textContent = child.name || 'โ';
      document.getElementById('bannerMeta').textContent =
        `${child.gender||'โ'} โข ${child.weight||'โ'} ูุฌู โข ${child.height||'โ'} ุณู`;
      document.getElementById('childBanner').style.display='block';

      // ููุก ุงูููุฑู
      cName.value = child.name||''; cGender.value = child.gender||'ุฐูุฑ';
      cCivilId.value = child.childCivilId||''; cBirth.value = child.birthDate||'';
      cWeight.value = child.weight??''; cHeight.value = child.height??'';
      cUnit.value = child.unit||'mmol/L'; cTarget.value = child.target??'';
      cLow.value = child.lowThreshold??''; cHigh.value = child.highThreshold??'';
      cTresiba.value = child.tresibaDose??''; cTotalInsulin.value = child.totalInsulin??'';
      cCorrectionFactor.value = child.correctionFactor??''; cICR.value = child.icr??'';
    }

    // ุญูุธ
    saveInfo.addEventListener('click', async ()=>{
      showLoader(true);
      const data = {
        name:cName.value.trim(), gender:cGender.value, childCivilId:cCivilId.value.trim(),
        birthDate:cBirth.value||null, weight: cWeight.value? Number(cWeight.value):null,
        height: cHeight.value? Number(cHeight.value):null, unit: cUnit.value,
        target: cTarget.value? Number(cTarget.value):null,
        lowThreshold: cLow.value? Number(cLow.value):null,
        highThreshold: cHigh.value? Number(cHigh.value):null,
        tresibaDose: cTresiba.value? Number(cTresiba.value):null,
        totalInsulin: cTotalInsulin.value? Number(cTotalInsulin.value):null,
        correctionFactor: cCorrectionFactor.value? Number(cCorrectionFactor.value):null,
        icr: cICR.value? Number(cICR.value):null
      };
      await setDoc(doc(db,'users',uid,'children',childId), data, {merge:true});
      toast('โ ุชู ุงูุญูุธ'); showLoader(false);
    });

    // ุฑูุน ุตูุฑุฉ
    cPhoto.addEventListener('change', async (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const bar = document.getElementById('uploadProg'); const fill = bar.querySelector('span');
      bar.style.display='block'; fill.style.width='0%';
      const path = `users/${uid}/children/${childId}/avatar/${Date.now()}_${f.name}`;
      const task = uploadBytesResumable(ref(storage,path), f);
      await new Promise((res,rej)=> task.on('state_changed', s=>{ fill.style.width=(s.bytesTransferred/s.totalBytes*100)+'%'; }, rej, res));
      const url = await getDownloadURL(task.snapshot.ref);
      await setDoc(doc(db,'users',uid,'children',childId), {photoURL:url}, {merge:true});
      setChildAvatar(document.getElementById('bannerAvatar'), cName.value.trim(), url);
      toast('๐ท ุชู ุฑูุน ุงูุตูุฑุฉ'); bar.style.display='none';
    });

    // ุฎุฑูุฌ
    btnLogout.addEventListener('click', ()=> signOut(auth).then(()=>location.href='index.html'));

    // Boot
    (async function(){
      showLoader(true);
      const session = await ensureAuth(); uid = session.uid;
      childId = requireChildIdFromQuery();
      buildNav();
      await loadChild();
      showLoader(false);
    })();
  </script>
</body>
</html>

