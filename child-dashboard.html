<!-- child-dashboard.html â€” Ø§Ù„Ø¹Ù†ØµØ± (1/7): Ø§Ù„Ù‡ÙŠØ¯Ø± + ØµÙˆØ±Ø© Ø§Ù„Ø·ÙÙ„ + Ø§Ù„ØªØ±Ø­ÙŠØ¨ -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø·ÙÙ„ â€” Ù…ØªØ§Ø¨Ø¹Ø© Ø³ÙƒØ± Ø§Ù„Ø£Ø·ÙØ§Ù„</title>

  <style>
    :root{
      --brand:#0ea5e9; --brand2:#6ee7b7; --line:#e5e7eb;
      --ink:#0f172a; --muted:#6b7280; --bg:#f6fbff; --card:#fff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.6 "Tajawal",system-ui,sans-serif}

    /* Ø§Ù„Ù‡ÙŠØ¯Ø± */
    header{
      position:sticky; top:0; z-index:10;
      background:linear-gradient(90deg,var(--brand),var(--brand2));
      color:#fff; padding:12px 16px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .head-left{display:flex; align-items:center; gap:12px}
    /* Ø¥Ø·Ø§Ø± ØµÙˆØ±Ø© Ø§Ù„Ø·ÙÙ„ */
    .kid-photo{
      width:56px; height:56px; border-radius:16px; overflow:hidden;
      border:2px solid rgba(255,255,255,.75); background:#fff;
      display:grid; place-items:center;
    }
    .kid-photo img{width:100%; height:100%; object-fit:cover; display:block}
    /* fallback Ù„Ù„Ø£ÙØ§ØªØ§Ø± Ø¨Ø­Ø±ÙˆÙ Ø§Ù„Ø§Ø³Ù… */
    .avatar-fallback{
      width:100%; height:100%; display:none; place-items:center;
      background:#e0f7fa; color:#0f172a; font-weight:800; font-size:18px;
    }

    .title-wrap{display:flex; flex-direction:column}
    .hello{font-size:14px; opacity:.9}
    .kid-name{font-size:18px; font-weight:800}

    .head-actions{display:flex; gap:8px; flex-wrap:wrap}
    .btn{border:none; border-radius:10px; padding:8px 12px; font-weight:800; cursor:pointer}
    .btn.gray{background:#eef2f7}
    .btn.dark{background:#0f172a; color:#fff}

    /* Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù„Ø§Ø­Ù‚Ù‹Ø§ */
    main{max-width:1200px; margin:auto; padding:16px}
    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; box-shadow:0 2px 10px rgba(0,0,0,.04)}
    .note{color:var(--muted); font-size:14px}
  </style>
</head>
<body>

  <!-- Ø§Ù„Ù‡ÙŠØ¯Ø±: ØµÙˆØ±Ø© Ø§Ù„Ø·ÙÙ„ + Ø§Ù„ØªØ±Ø­ÙŠØ¨ -->
  <header>
    <div class="head-left">
      <div class="kid-photo">
        <img id="childPhoto" alt="ØµÙˆØ±Ø© Ø§Ù„Ø·ÙÙ„">
        <div id="avatarFallback" class="avatar-fallback">ğŸ‘§</div>
      </div>
      <div class="title-wrap">
        <div class="hello">Ù…Ø±Ø­Ø¨Ù‹Ø§ ğŸ‘‹</div>
        <div id="kidName" class="kid-name">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…...</div>
      </div>
    </div>
    <div class="head-actions">
      <a class="btn gray" href="dashboard.html">Ù„ÙˆØ­Ø© ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±</a>
      <button id="btnLogout" class="btn dark">Ø®Ø±ÙˆØ¬</button>
    </div>
  </header>

  <!-- Ù…Ø¬Ø±Ø¯ Ø­Ø§Ù…Ù„ Ù…Ø¤Ù‚Øª Ù„Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªÙŠ Ø³Ù†Ø¶ÙŠÙÙ‡Ø§ ØªØ¨Ø§Ø¹Ù‹Ø§ -->
  <main>
    <section class="card">
      <div class="note">Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø¨Ø§Ù‚ÙŠ Ø£Ù‚Ø³Ø§Ù… Ù„ÙˆØ­Ø© Ø§Ù„Ø·ÙÙ„ (Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„ØŒ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§ØªØŒ Ø§Ù„ÙˆØ¬Ø¨Ø§ØªØŒ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±ØŒ Ø§Ù„Ø·Ø¨ÙŠØ¨ØŒ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª) â€” Ø³Ù†Ø¶ÙŠÙÙ‡Ø§ Ø¹Ù†ØµØ±Ù‹Ø§ ØªÙ„Ùˆ Ø§Ù„Ø¢Ø®Ø±.</div>
    </section>
  </main>

  <script type="module">
    import { db, auth } from './firebase-init.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // Ø¹Ù†Ø§ØµØ± DOM
    const elName   = document.getElementById('kidName');
    const img      = document.getElementById('childPhoto');
    const fallback = document.getElementById('avatarFallback');
    const btnLogout= document.getElementById('btnLogout');

    // childId Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
    const params  = new URLSearchParams(location.search);
    const childId = params.get('child');

    // Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø©
    const slugify = s => (s||'').trim().toLowerCase()
                          .replace(/\s+/g,'-')
                          .replace(/[^\u0600-\u06FF\w-]/g,''); // ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ ÙˆØ§Ù„Ø­Ø±ÙˆÙ/Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„Ø´Ø±Ø·Ø©

    const setAvatarFallback = (name, gender) => {
      // Ø­Ø±ÙˆÙ Ø£ÙˆÙ„ÙŠØ© Ù…Ù† Ø§Ù„Ø§Ø³Ù… (Ø£ÙˆÙ„ Ø­Ø±ÙÙŠÙ† Ø¹Ø±Ø¨ÙŠ/Ù„Ø§ØªÙŠÙ†ÙŠ)
      const initials = (name||'').trim().split(/\s+/).slice(0,2).map(w=>w[0]||'').join('').toUpperCase();
      fallback.textContent = initials || (gender==='male' ? 'ğŸ‘¦' : 'ğŸ‘§');
      fallback.style.display = 'grid';
    };

    const trySetPhoto = (child) => {
      // Ù†Ø­Ø§ÙˆÙ„: by-id Ø«Ù… by-name-slug
      const byId   = `/images/${childId}.jpg`;
      const byName = `/images/${slugify(child.name||'')}.jpg`;

      // Ù†Ø®ØªØ¨Ø± id Ø£ÙˆÙ„Ø§Ù‹ØŒ Ù„Ùˆ ÙØ´Ù„Øª Ù†Ø­ÙˆÙ„ Ù„Ù„Ø§Ø³Ù…ØŒ ÙˆÙ„Ùˆ ÙØ´Ù„Øª Ù†Ø¹Ø±Ø¶ fallback
      const test = (srcs, i=0) => {
        if (i >= srcs.length) { img.style.display='none'; setAvatarFallback(child.name, child.gender); return; }
        img.onload = () => { img.style.display='block'; fallback.style.display='none'; };
        img.onerror= () => test(srcs, i+1);
        img.src = srcs[i];
      };
      test([byId, byName]);
    };

    // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„
    onAuthStateChanged(auth, async (user) => {
      if (!user) { location.href = 'index.html'; return; }

      if (!childId) {
        elName.textContent = 'Ù„Ù… ÙŠØªÙ… ØªÙ…Ø±ÙŠØ± Ø±Ù‚Ù… Ø§Ù„Ø·ÙÙ„ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.';
        setAvatarFallback('','');
        return;
      }

      try {
        const childRef = doc(db, 'users', user.uid, 'children', childId);
        const snap = await getDoc(childRef);

        if (!snap.exists()) {
          elName.textContent = 'Ø§Ù„Ø·ÙÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ â—';
          setAvatarFallback('', '');
          return;
        }

        const child = snap.data();
        elName.textContent = child.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
        trySetPhoto(child);

      } catch (err) {
        console.error(err);
        elName.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
        setAvatarFallback('', '');
      }
    });

    // Ø®Ø±ÙˆØ¬
    btnLogout.addEventListener('click', () => {
      signOut(auth).then(()=> location.href='index.html');
    });
  </script>
</body>
</html>
