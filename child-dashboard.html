<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>لوحة الطفل — متابعة سكر الأطفال</title>
  <style>
    /*  ===== أنماط لوحة التحكم الأصلية كاملة ===== */
    :root{--brand:#0ea5e9;--brand2:#6ee7b7;--line:#e5e7eb;--ink:#0f172a;--muted:#6b7280;
      --bg:#f6fbff;--card:#fff;--ok:#10b981;--warn:#f59e0b;--bad:#ef4444;
      --chip:#eef6ff;--hi:#f97316;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.6 "Tajawal",system-ui,sans-serif;
      display:flex;min-height:100vh}
    .sidebar{width:260px;flex:0 0 260px;background:linear-gradient(180deg,var(--brand),var(--brand2));
      color:#fff;padding:16px;position:sticky;top:0;height:100vh;overflow:auto}
    .sb-title{font-weight:800;font-size:18px;margin-bottom:12px}
    .sb-btn{display:block;width:100%;text-align:right;background:transparent;border:none;color:#fff;
      padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:700;margin:4px 0}
    .sb-btn:hover,.sb-btn.active{background:rgba(255,255,255,.18)}
    .spacer{height:6px}
    .main{flex:1;min-width:0}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(90deg,var(--brand),var(--brand2));
      color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between}
    .head-left{display:flex;align-items:center;gap:12px}
    .kid-photo{width:56px;height:56px;border-radius:16px;overflow:hidden;
      border:2px solid rgba(255,255,255,.75);background:#fff;display:grid;place-items:center}
    .kid-photo img{width:100%;height:100%;object-fit:cover;display:block}
    .avatar-fallback{width:100%;height:100%;display:none;place-items:center;background:#e0f7fa;
      color:#0f172a;font-weight:800;font-size:18px}
    .title-wrap{display:flex;flex-direction:column}
    .hello{font-size:14px;opacity:.9}
    .kid-name{font-size:18px;font-weight:800}
    .head-actions{display:flex;gap:8px;flex-wrap:wrap}
    .btn{border:none;border-radius:10px;padding:8px 12px;font-weight:800;cursor:pointer}
    .btn.gray{background:#eef2f7}
    .btn.dark{background:#0f172a;color:#fff}
    .btn.primary{background:var(--brand);color:#fff}
    .btn.orange{background:var(--hi);color:#fff}
    main{max-width:1200px;margin:auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;
      padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.05);margin-bottom:14px}
    .note{color:var(--muted);font-size:14px}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:var(--chip);
      color:#0f172a;font-size:12px;margin-inline-start:6px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .grid{display:grid;gap:12px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media(max-width:900px){.g3{grid-template-columns:1fr 1fr}}
    @media(max-width:680px){.g2,.g3{grid-template-columns:1fr}}
    label{display:block;color:var(--muted);font-size:13px;margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);
      border-radius:10px;background:#fff}
    textarea{min-height:90px;resize:vertical}
    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--line);padding:8px;text-align:center}
    th{background:#f0f9ff}
    .status{display:inline-block;padding:6px 10px;border-radius:999px;font-size:12px}
    .ok{background:#ecfdf5;color:var(--ok)}
    .high{background:#fee2e2;color:#ef4444}
    .low{background:#fff7ed;color:#b45309}
    .meals-layout{display:grid;grid-template-columns:220px 1fr;gap:12px}
    .cats{display:flex;flex-direction:column;gap:8px}
    .cat-btn{border:1px solid var(--line);background:#fff;color:var(--ink);
      border-radius:10px;padding:8px 10px;cursor:pointer;text-align:right;font-weight:700}
    .cat-btn.active,.cat-btn:hover{background:#e6f7ff;border-color:#cfefff}
    .foods-grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
    .food-card{border:1px solid var(--line);background:#fff;border-radius:14px;padding:12px;
      box-shadow:0 2px 8px rgba(0,0,0,0.04)}
    .food-card img{width:80px;height:80px;object-fit:contain;display:block;margin:0 auto 6px}
    .food-name{font-weight:800;text-align:center}
    .food-sub{font-size:12px;color:var(--muted);text-align:center;margin-bottom:8px}
    .toggle{display:flex;gap:6px;justify-content:center;margin:6px 0}
    .toggle button{flex:1;border:1px solid var(--line);background:#fff;padding:6px 8px;
      border-radius:8px;cursor:pointer;font-weight:700}
    .toggle button.active{background:#eef6ff;border-color:#cfefff}
    .food-actions{display:flex;gap:6px;align-items:center;justify-content:center}
    .small{font-size:12px;color:var(--muted)}
    .basket{border:1px solid var(--line);border-radius:12px;overflow:hidden}
    .basket th{background:#fff}
    .basket tfoot td{font-weight:800}
    .pill{display:inline-block;background:#f1f5f9;border-radius:999px;padding:3px 8px;font-size:12px}
    .toast{position:fixed;bottom:16px;left:16px;background:#111;color:#fff;padding:10px 14px;border-radius:12px;opacity:0;transform:translateY(6px);transition:.25s}
    .toast.show{opacity:1;transform:none}
    .section{display:none}
    .section.active{display:block}

    /*  ===== أنماط صفحة التقارير ===== */
    .controls-rep {
      background: var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:14px;
    }
    .controls-rep .grid {
      display:grid;gap:10px;grid-template-columns:repeat(4,minmax(0,1fr));
    }
    @media(max-width:900px){.controls-rep .grid{grid-template-columns:1fr 1fr}}
    .table-rep {width:100%;border-collapse:separate;border-spacing:0}
    .table-rep th, .table-rep td {border:1px solid var(--line);padding:8px;vertical-align:top;text-align:right}
    .table-rep thead th {background:#f8fafc;font-weight:800;text-align:right}
    .table-rep td.date {background:#fbfdff;white-space:nowrap;font-weight:800}
    .cell {display:flex;flex-direction:column;gap:3px}
    .line {font-size:12px}
    .state {padding:2px 8px;border-radius:999px;width:max-content;margin:0}
    .state.ok {color:var(--ok);background:var(--card)}
    .state.low {color:var(--warn);background:#fff7ed}
    .state.high {color:var(--bad);background:#fee2e2}
    @media print {
      @page {size:A4 landscape;margin:8mm}
      body {font-size:11px;background:#fff}
      header, .controls-rep {display:none!important}
      .card, .section {border:0;box-shadow:none;padding:0;margin:0}
      .table-rep th, .table-rep td {padding:4px}
      .line {font-size:10px}
    }
  </style>
</head>
<body>

<aside class="sidebar">
  <div class="sb-title">👧 لوحة الطفل</div>
  <button class="sb-btn active" data-target="sec-home">🏠 الرئيسية</button>
  <div class="spacer"></div>
  <button class="sb-btn" data-target="sec-info">⚙️ بيانات الطفل</button>
  <button class="sb-btn" data-target="sec-measure">📝 قياسات السكر</button>
  <button class="sb-btn" data-target="sec-meals">🍽️ الوجبات</button>
  <button class="sb-btn" data-target="sec-reports">📊 التقارير</button>
  <button class="sb-btn" data-target="sec-doctor">🧑‍⚕️ الطبيب</button>
  <button class="sb-btn" data-target="sec-visits">📅 الزيارات الطبية</button>
</aside>

<div class="main">
  <header>
    <div class="head-left">
      <div class="kid-photo">
        <img id="childPhoto" alt="صورة الطفل">
        <div id="avatarFallback" class="avatar-fallback">👧</div>
      </div>
      <div class="title-wrap">
        <div class="hello">مرحبًا 👋</div>
        <div id="kidName" class="kid-name">جاري تحميل الاسم...</div>
      </div>
    </div>
    <div class="head-actions">
      <a class="btn gray" href="dashboard.html">لوحة وليّ الأمر</a>
      <button id="btnLogout" class="btn dark">خروج</button>
    </div>
  </header>

  <main>
    <!-- 1: الرئيسية -->
    <section id="sec-home" class="section active">
      <div class="card"><div class="note">اختاري من القائمة اليمنى القسم المطلوب.</div></div>
    </section>

  
   <!-- (2) بيانات الطفل + الإعدادات -->
      <section id="sec-info" class="section">
        <section class="card" id="childInfoSection">
          <h3 class="section-title">⚙️ بيانات الطفل</h3>
          <div class="grid g3">
            <div><label>اسم الطفل</label><input id="childName" placeholder="مثال: ليلى أحمد"></div>
            <div>
              <label>النوع</label>
              <div class="row" style="gap:14px">
                <label><input type="radio" name="gender" value="male"> ذكر</label>
                <label><input type="radio" name="gender" value="female"> أنثى</label>
              </div>
            </div>
            <div><label>الرقم المدني</label><input id="childCivilId" placeholder="اختياري"></div>
            <div><label>تاريخ الميلاد</label><input id="dob" type="date"></div>
            <div><label>الطول (سم)</label><input id="heightCm" type="number" step="0.1"></div>
            <div><label>الوزن (كجم)</label><input id="weightKg" type="number" step="0.1"></div>
            <div><label>الوحدة المفضلة</label>
              <select id="preferredUnit"><option value="mmol">mmol/L</option><option value="mgdl">mg/dL</option></select>
            </div>
            <div><label>نوع القياس الافتراضي</label>
              <select id="defaultMeasurementType">
                <option value="fingerstick">🩸 فحص إصبع</option>
                <option value="cgm">📈 CGM</option>
                <option value="lab">🧪 مختبر</option>
                <option value="other">✳️ أخرى</option>
              </select>
            </div>
            <div style="grid-column:1/-1"><label>ملاحظات</label><input id="notes" placeholder="اختياري"></div>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="btnSaveInfo" class="btn primary">💾 حفظ بيانات الطفل</button>
          </div>
        </section>

        <section class="card" id="glucoseDosingSection">
          <h3 class="section-title">🧪 إعدادات القياس و الجرعات
            <span id="unitBadge" class="badge">الوحدة المعروضة: mmol/L</span>
          </h3>
          <div class="grid g3">
            <div><label>الهدف</label><input id="target" type="number" step="0.1"></div>
            <div><label>حد الهبوط</label><input id="low" type="number" step="0.1"></div>
            <div><label>حد الارتفاع</label><input id="high" type="number" step="0.1"></div>
            <div><label>ترسيبا (U/Day)</label><input id="tresiba" type="number" step="0.5"></div>
            <div><label>TDI (U)</label><input id="tdi" type="number" step="0.5"></div>
            <div><label>ISF <span id="isfUnitLabel" class="badge">mmol/L لكل 1U</span></label><input id="isf" type="number" step="0.1"></div>
            <div><label>ICR (جرام/وحدة)</label><input id="icr" type="number" step="0.1"></div>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="btnSuggest" class="btn gray">💡 احسب من TDI</button>
            <button id="btnSaveGlucose" class="btn primary">💾 حفظ الإعدادات</button>
          </div>
          <div class="note" style="margin-top:8px">اقتراحات: ISF≈100/TDI (mmol/L/U) — ICR≈500/TDI (g/U).</div>
        </section>
      </section>


    <!-- 3: قياسات السكر -->
   <section id="sec-measure" class="section">
        <section class="card">
          <h3 class="section-title">📝 قياسات السكر <span id="mUnitBadge" class="badge">الوحدة المعروضة: mmol/L</span></h3>
          <div class="grid g3">
            <div><label>التاريخ</label><input type="date" id="dateSel" /></div>
            <div><label>وقت القياس</label>
              <select id="slotSel">
                <option value="">— اختاري الوقت —</option>
                <option value="preBreakfast">قبل الإفطار</option>
                <option value="postBreakfast">بعد الإفطار</option>
                <option value="preLunch">قبل الغداء</option>
                <option value="postLunch">بعد الغداء</option>
                <option value="preDinner">قبل العشاء</option>
                <option value="postDinner">بعد العشاء</option>
                <option value="bedtime">قبل النوم</option>
                <option value="exercise">بعد التمرين</option>
                <option value="other">أخرى...</option>
              </select>
            </div>
            <div><label>نوع القياس</label>
              <select id="mType">
                <option value="fingerstick">🩸 فحص إصبع</option>
                <option value="cgm">📈 CGM</option>
                <option value="lab">🧪 مختبر</option>
                <option value="other">✳️ أخرى</option>
              </select>
            </div>
          </div>
        </section>

        <section class="card">
          <h3 class="section-title">إدخال القياس والوجبة</h3>
          <div class="grid g3">
            <div><label>القراءة</label><input type="number" id="reading" step="0.1" min="0"/><div id="statusBadge" class="status ok" style="display:none;"></div></div>
            <div><label>كارب (جم)</label><input type="number" id="carbs" step="0.1" min="0"/></div>
            <div><label>جرعة مقترحة (ICR)</label><input type="number" id="suggestedDose" readonly/></div>
            <div><label>جرعة فعلية</label><input type="number" id="mealDose" step="0.1"/></div>
            <div id="correctionSection" style="display:none;"><label>جرعة تصحيحية</label><input type="number" id="correction" step="0.1"/></div>
            <div id="raiseSection" style="display:none;"><label>رفع السكر</label><input type="text" id="raise"/></div>
            <div style="grid-column:1/-1"><label>ملاحظة</label><textarea id="note" rows="2"></textarea></div>
          </div>
          <div class="row" style="margin-top:8px">
            <button class="btn primary" id="saveBtn">💾 حفظ القياس</button>
            <button class="btn gray" id="reloadDay">🔄 تحديث القراءات</button>
          </div>
        </section>

        <section class="card">
          <h3 class="section-title">قراءات اليوم</h3>
          <table>
            <thead><tr><th>الوقت</th><th>القراءة</th><th>الحالة</th><th>جرعة الوجبة</th><th>التصحيح/الرفع</th><th>نوع القياس</th><th>ملاحظة</th></tr></thead>
            <tbody id="rows"><tr><td colspan="7" class="note">لا توجد قراءات لليوم.</td></tr></tbody>
          </table>
        </section>
      </section>

      <!-- (3) الوجبات — جديد -->
      <section id="sec-meals" class="section">
        <section class="card">
          <div class="row" style="justify-content:space-between; align-items:center">
            <h3 class="section-title">🍽️ الوجبات</h3>
            <div class="row">
              <a href="foods-admin.html" class="btn orange">🗂️ إدارة الأصناف</a>
            </div>
          </div>

          <!-- إعداد الوجبة -->
          <div class="grid g3" style="margin-bottom:10px">
            <div><label>نوع الوجبة</label>
              <select id="mealType">
                <option value="breakfast">فطور</option>
                <option value="lunch">غداء</option>
                <option value="dinner">عشاء</option>
                <option value="snack">سناك</option>
                <option value="other">أخرى</option>
              </select>
            </div>
            <div><label>وقت الأكل</label><input id="mealTime" type="datetime-local"></div>
            <div><label>ملاحظة</label><input id="mealNotes" placeholder="اختياري"></div>
          </div>

          <div class="meals-layout">
            <!-- التصنيفات -->
            <div>
              <div class="row" style="margin-bottom:8px">
                <input id="foodSearch" placeholder="ابحث عن صنف..." style="width:100%">
              </div>
              <div id="catList" class="cats"></div>
            </div>

            <!-- شبكة الأصناف -->
            <div>
              <div id="foodsGrid" class="foods-grid"><div class="note">جاري التحميل...</div></div>

              <!-- السلة -->
              <div class="card" style="margin-top:12px">
                <div class="row" style="justify-content:space-between">
                  <h4 style="margin:0">🧺 سلة الوجبة</h4>
                  <div class="small">ICR الحالي: <b id="icrNow">—</b> g/U</div>
                </div>
                <div class="basket" style="margin-top:8px; overflow:auto">
                  <table>
                    <thead><tr><th>الصنف</th><th>الكمية</th><th>الكارب (جم)</th><th>إجراء</th></tr></thead>
                    <tbody id="basketBody"><tr><td colspan="4" class="note">لا توجد عناصر بعد.</td></tr></tbody>
                    <tfoot>
                      <tr><td><b>الإجمالي</b></td><td></td><td id="totalCarbsCell">0.0</td><td></td></tr>
                    </tfoot>
                  </table>
                </div>

                <div class="grid g3" style="margin-top:10px">
                  <div><label>الجرعة المقترحة</label><input id="doseSuggestedMeal" readonly></div>
                  <div><label>جرعة فعلية (اختياري)</label><input id="doseGivenMeal" type="number" step="0.1"></div>
                  <div class="row" style="align-items:flex-end; justify-content:flex-end">
                    <button id="saveMealBtn" class="btn primary">💾 حفظ الوجبة</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="note" style="margin-top:8px">الحساب: (الجرامات × كارب/100) ÷ 100 • الجرعة المقترحة = إجمالي الكارب ÷ ICR (تقريب 0.1U).</div>
        </section>
      </section>

    </section>

    <!-- 4: الوجبات -->
    <section id="sec-meals" class="section">
      ... <!-- انسخ الكود الأصلي الخاص بالوجبات هنا -->
    </section>

    <!-- 5: التقارير -->
    <section id="sec-reports" class="section">
      <section class="controls-rep card">
        <div class="grid">
          <div><label>الطفل</label><select id="childSelRep"><option value="">— اختاري الطفل —</option></select></div>
          <div><label>من تاريخ</label><input type="date" id="fromRep"></div>
          <div><label>إلى تاريخ</label><input type="date" id="toRep"></div>
          <div style="display:flex;align-items:end">
            <button id="runRep" class="btn primary">عرض التقرير</button>
          </div>
        </div>
        <div id="childMetaRep" class="note" style="margin-top:10px;"></div>
        <div id="blankHeaderRep" class="blank-header" style="display:none;margin-top:10px;"></div>
      </section>
      <section id="reportBoxRep" class="card" style="display:none;">
        <button id="btnBlankRep" class="btn gray" style="margin-bottom:10px;">طباعة ورقة فارغة</button>
        <button id="btnPrintRep" class="btn primary" style="margin-bottom:10px;">طباعة التقرير</button>
        <table id="repTable" class="table-rep"></table>
      </section>
    </section>

    <!-- 6: الطبيب -->
    <section id="sec-doctor" class="section">
      <div class="card"><div class="note">🧑‍⚕️ الطبيب — قريبًا.</div></div>
    </section>

    <!-- 7: الزيارات الطبية -->
    <section id="sec-visits" class="section">
      <div class="card"><div class="note">📅 الزيارات الطبية — قريبًا.</div></div>
    </section>
  </main>
</div>

<div id="toast" class="toast"></div>

<script type="module">
  import { db, auth } from './firebase-init.js';
  import {
    onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  import {
    doc, getDoc, setDoc,
    collection, getDocs, addDoc, query, orderBy, limit, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  const $ = s => document.querySelector(s);
  const $$ = s => [...document.querySelectorAll(s)];
  const toastEl = $('#toast');
  const showToast = (m) => {
    toastEl.textContent = m;
    toastEl.classList.add('show');
    setTimeout(() => toastEl.classList.remove('show'), 2200);
  };
  const escapeHtml = s => (s || '').replace(/[&<>"']/g, m =>
    ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m]));

  /** لوحة التحكم — التنقل */
  $$('.sb-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      $$('.sb-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      $$('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(btn.dataset.target).classList.add('active');
    });
  });

  /*** تقارير — الوظائف ***/
  function enumerateDates(from, to) {
    const res = [], d = new Date(from), end = new Date(to);
    while (d <= end) {
      res.push(d.toISOString().slice(0, 10));
      d.setDate(d.getDate() + 1);
    }
    return res;
  }
  function stateLabel(s) {
    return s === 'low' ? '⬇︎ منخفض' :
           s === 'high' ? '⬆︎ مرتفع' :
           '✔️ طبيعي';
  }

  auth.onAuthStateChanged(async user => {
    if (!user) { location.href = 'index.html'; return; }

    // — تسجيل الخروج
    $('#btnLogout').addEventListener('click', () => signOut(auth).then(() => location.href = 'index.html'));

    // — ل تشغيل أقسام البيانات والوجبات والقياس، ضعي كودك الأصلي هناك.
    // — هنا فقط تكميل وظائف التقارير:
    await loadChildrenRep(user.uid);
    setDefaultsRep();
    $('#runRep').addEventListener('click', () => buildReportRep(user.uid));
    $('#btnBlankRep').addEventListener('click', () => printBlankRep());
    $('#btnPrintRep').addEventListener('click', () => window.print());
  });

  async function loadChildrenRep(uid) {
    const sel = $('#childSelRep');
    sel.innerHTML = '<option>— تحميل —</option>';
    const snap = await getDocs(collection(db, 'users', uid, 'children'));
    sel.innerHTML = '<option value="">— اختاري الطفل —</option>';
    snap.forEach(s => {
      const o = document.createElement('option');
      o.value = s.id;
      o.textContent = s.data().name || 'بدون اسم';
      sel.appendChild(o);
    });
  }

  function setDefaultsRep() {
    const iso = new Date().toISOString().slice(0, 10);
    $('#fromRep').value = iso;
    $('#toRep').value = iso;
  }

  async function buildReportRep(uid) {
    const childId = $('#childSelRep').value, from = $('#fromRep').value, to = $('#toRep').value;
    if (!childId || !from || !to) return alert('اختاري الطفل وحددي الفترة');
    $('#blankHeaderRep').style.display = 'none';
    const cSnap = await getDoc(doc(db, 'users', uid, 'children', childId));
    const c = cSnap.data() || {};
    $('#childMetaRep').innerHTML = `<b>الطفل:</b> ${c.name || '—'} • <b>الوزن:</b> ${c.weight || '—'} كجم • <b>الطول:</b> ${c.height || '—'} سم`;

    const dates = enumerateDates(from, to);
    const snaps = await Promise.all(dates.map(d =>
      getDoc(doc(db, 'users', uid, 'children', childId, 'measurements', d))
    ));
    const byDate = {};
    snaps.forEach((snap, i) => byDate[dates[i]] = snap.data() || { readings: {} });

    const tbl = $('#repTable');
    tbl.innerHTML = '';
    const thead = document.createElement('thead');
    const htr = document.createElement('tr');
    htr.innerHTML = `<th>التاريخ</th>${['قبل الإفطار','بعد الإفطار','قبل الغداء','بعد الغداء','قبل العشاء','بعد العشاء',
      'قبل النوم','أثناء النوم','عند الاستيقاظ'].map(t => `<th>${t}</th>`).join('')}`;
    thead.appendChild(htr);
    tbl.appendChild(thead);

    const tbody = document.createElement('tbody');
    dates.forEach(d => {
      const readings = byDate[d].readings || {};
      const tr = document.createElement('tr');
      let rowHtml = `<td class="date">${d}</td>`;
      ['preBreakfast','postBreakfast','preLunch','postLunch',
       'preDinner','postDinner','beforeSleep','duringSleep','uponWake']
      .forEach(slot => {
        const r = readings[slot];
        if (!r || (r.valueMmol == null && r.value == null)) {
          rowHtml += '<td>—</td>';
        } else {
          const val = r.value ?? r.valueMmol;
          const st = r.status || 'ok';
          rowHtml += `<td><div class="cell">
                        <div class="line"><b>القياس:</b> ${val}</div>
                        ${r.mealDose != null ? `<div class="line">جرعة: ${r.mealDose}U</div>` : ''}
                        ${r.correction != null ? `<div class="line">تصحيحي: ${r.correction}U</div>` : ''}
                        ${r.note ? `<div class="line note">ملاحظة: ${escapeHtml(r.note)}</div>` : ''}
                        <div class="line state ${st}">${stateLabel(st)}</div>
                      </div></td>`;
        }
      });
      tr.innerHTML = rowHtml;
      tbody.appendChild(tr);
    });
    tbl.appendChild(tbody);
    $('#reportBoxRep').style.display = 'block';
  }

  function printBlankRep() {
    const childId = $('#childSelRep').value;
    if (!childId) return alert('اختاري الطفل أولاً');

    $('#childMetaRep').innerHTML = '';
    $('#blankHeaderRep').style.display = 'flex';
    $('#blankHeaderRep').innerHTML = `
      <span class="bh-item">الاسم:<span class="line"></span></span>
      <span class="bh-item">الوزن:<span class="line"></span></span>
      <span class="bh-item">الطول:<span class="line"></span></span>`;

    const tbl = $('#repTable');
    tbl.innerHTML = '';
    const thead = document.createElement('thead');
    const htr = document.createElement('tr');
    htr.innerHTML = `<th>التاريخ</th>${['قبل الإفطار','بعد الإفطار','قبل الغداء','بعد الغداء',
      'قبل العشاء','بعد العشاء','قبل النوم','أثناء النوم','عند الاستيقاظ']
      .map(t => `<th>${t}</th>`).join('')}`;
    thead.appendChild(htr);
    tbl.appendChild(thead);

    const tbody = document.createElement('tbody');
    for (let i = 0; i < 7; i++) {
      const tr = document.createElement('tr');
      let rowHtml = `<td class="date">&nbsp;</td>`;
      for (let j = 0; j < 9; j++) {
        rowHtml += `<td>
                      <div class="cell">
                        <div class="line">القياس: ________</div>
                        <div class="line">جرعة: ________</div>
                        <div class="line">ملاحظة: _______________</div>
                        <div class="line">الحالة: ________</div>
                      </div>
                    </td>`;
      }
      tr.innerHTML = rowHtml;
      tbody.appendChild(tr);
    }
    tbl.appendChild(tbody);
    $('#reportBoxRep').style.display = 'block';
    setTimeout(() => window.print(), 50);
  }
</script>

</body>
</html>
