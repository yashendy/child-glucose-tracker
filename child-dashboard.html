<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>لوحة الطفل — متابعة سكر الأطفال</title>
  <style>
    :root{
      --brand:#0ea5e9; --brand2:#6ee7b7; --line:#e5e7eb;
      --ink:#0f172a; --muted:#6b7280; --bg:#f6fbff; --card:#fff;
      --ok:#10b981; --warn:#d97706; --bad:#ef4444; --chip:#eef6ff;
      --hi:#f97316;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.6 "Tajawal",system-ui,sans-serif; display:flex; min-height:100vh}

    /* Sidebar */
    .sidebar{
      width:260px; flex:0 0 260px; background:linear-gradient(180deg,var(--brand),var(--brand2));
      color:#fff; padding:16px; position:sticky; top:0; height:100vh; overflow:auto
    }
    .sb-title{font-weight:800; font-size:18px; margin-bottom:12px}
    .sb-btn{display:block; width:100%; text-align:right; background:transparent; border:none; color:#fff;
      padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:700; margin:4px 0}
    .sb-btn:hover, .sb-btn.active{background:rgba(255,255,255,.18)}
    .spacer{height:6px}

    /* Main + header */
    .main{flex:1; min-width:0}
    header{
      position:sticky; top:0; z-index:10; background:linear-gradient(90deg,var(--brand),var(--brand2));
      color:#fff; padding:12px 16px; display:flex; align-items:center; justify-content:space-between;
    }
    .head-left{display:flex; align-items:center; gap:12px}
    .kid-photo{ width:56px; height:56px; border-radius:16px; overflow:hidden; border:2px solid rgba(255,255,255,.75); background:#fff; display:grid; place-items:center }
    .kid-photo img{width:100%; height:100%; object-fit:cover; display:block}
    .avatar-fallback{ width:100%; height:100%; display:none; place-items:center; background:#e0f7fa; color:#0f172a; font-weight:800; font-size:18px }
    .title-wrap{display:flex; flex-direction:column}
    .hello{font-size:14px; opacity:.9}
    .kid-name{font-size:18px; font-weight:800}
    .head-actions{display:flex; gap:8px; flex-wrap:wrap}
    .btn{border:none; border-radius:10px; padding:8px 12px; font-weight:800; cursor:pointer}
    .btn.gray{background:#eef2f7}
    .btn.dark{background:#0f172a; color:#fff}
    .btn.primary{background:var(--brand); color:#fff}
    .btn.orange{background:var(--hi); color:#fff}

    main{max-width:1200px; margin:auto; padding:16px}
    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px; box-shadow:0 2px 10px rgba(0,0,0,.05); margin-bottom:14px}
    .note{color:var(--muted); font-size:14px}
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; background:var(--chip); color:#0f172a; font-size:12px; margin-inline-start:6px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    label{display:block; color:var(--muted); font-size:13px; margin-bottom:6px}
    input,select,textarea{width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#fff}
    textarea{min-height:90px; resize:vertical}

    .grid{display:grid; gap:12px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width: 900px){ .g3{grid-template-columns:1fr 1fr} }
    @media (max-width: 680px){ .g2,.g3{grid-template-columns:1fr} }

    table{width:100%; border-collapse:collapse}
    th,td{border:1px solid var(--line); padding:8px; text-align:center}
    th{background:#f0f9ff}

    .status{display:inline-block; padding:6px 10px; border-radius:999px; font-size:12px}
    .ok{background:#ecfdf5; color:#10b981}
    .high{background:#fee2e2; color:#ef4444}
    .low{background:#fff7ed; color:#b45309}

    /* Sections */
    .section{display:none}
    .section.active{display:block}

    /* ===== Reports — New Vertical Cards layout ===== */
    .wk-controls .pill{background:#f1f5f9;border-radius:999px;padding:4px 8px;font-size:12px}
    .wk-wrap{display:grid; grid-template-columns:1fr 1fr; gap:12px} /* شبكتين لعرض 7 كروت مدمجة */
    @media (max-width: 920px){ .wk-wrap{grid-template-columns:1fr} }

    .day-card{border:1px solid var(--line); border-radius:14px; background:#fff; padding:12px; display:flex; flex-direction:column; gap:8px}
    .day-head{display:flex; justify-content:space-between; align-items:center}
    .day-date{font-weight:800}
    .legend{font-size:12px; color:#475569}
    .legend .dot{display:inline-block; width:8px; height:8px; border-radius:50%; background:#10b981; vertical-align:middle; margin-inline:4px}

    .slots{display:flex; flex-direction:column; gap:8px}
    .slot-box{border:1px dashed #e2e8f0; border-radius:10px; padding:8px}
    .slot-title{font-weight:800; color:#334155; margin-bottom:4px}
    .mline{display:flex; align-items:center; gap:6px; font-weight:700}
    .mval{min-width:96px}
    .arrow-up{color:#ef4444} .arrow-down{color:#d97706} .arrow-ok{color:#10b981}
    .mlabel{font-size:12px; color:#64748b}
    .mnote{font-size:12px; color:#475569}
    .meal-mini{font-size:12px; color:#7c2d12; background:#fff7ef; border:1px solid #ffd1b2; border-radius:8px; padding:2px 6px; width:max-content; margin-top:4px}

    .kpis{display:flex; flex-wrap:wrap; gap:8px}
    .chip{background:#f1f5f9;border-radius:999px;padding:6px 10px;font-size:12px}

    /* Print */
    @media print{
      @page{ size: A4 portrait; margin: 10mm }
      header,.no-print,.sidebar{display:none!important}
      body{background:#fff;font-size:12px}
      .card{border:0;box-shadow:none;padding:0;margin:0}
      main{max-width:100%; padding:0}
      .wk-wrap{grid-template-columns:1fr 1fr} /* صفحتين عرضيتين داخل A4 عمودي */
      .day-card{page-break-inside:avoid}
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sb-title">👧 لوحة الطفل</div>
    <button class="sb-btn active" data-target="sec-home">🏠 الرئيسية</button>
    <div class="spacer"></div>
    <button class="sb-btn" data-target="sec-info">⚙️ بيانات الطفل</button>
    <button class="sb-btn" data-target="sec-measure">📝 قياسات السكر</button>
    <button class="sb-btn" data-target="sec-meals">🍽️ الوجبات</button>
    <button class="sb-btn" data-target="sec-reports">📊 التقارير</button>
    <button class="sb-btn" data-target="sec-doctor">🧑‍⚕️ الطبيب</button>
    <button class="sb-btn" data-target="sec-visits">📅 الزيارات الطبية</button>
  </aside>

  <div class="main">
    <!-- Header -->
    <header>
      <div class="head-left">
        <div class="kid-photo">
          <img id="childPhoto" alt="صورة الطفل">
          <div id="avatarFallback" class="avatar-fallback">👧</div>
        </div>
        <div class="title-wrap">
          <div class="hello">مرحبًا 👋</div>
          <div id="kidName" class="kid-name">جاري التحميل...</div>
        </div>
      </div>
      <div class="head-actions">
        <a class="btn gray" href="dashboard.html">لوحة وليّ الأمر</a>
        <button id="btnLogout" class="btn dark">خروج</button>
      </div>
    </header>

    <main>
      <!-- Home -->
      <section id="sec-home" class="section active">
        <div class="card"><div class="note">اختاري من القائمة اليمنى القسم المطلوب.</div></div>
      </section>

      <!-- (1) بيانات الطفل — مختصرة (يمكن توسعتها لاحقًا) -->
      <section id="sec-info" class="section">
        <div class="card">
          <h3>⚙️ بيانات الطفل</h3>
          <div class="grid g3">
            <div><label>اسم الطفل</label><input id="childName"></div>
            <div>
              <label>النوع</label>
              <div class="row" style="gap:14px">
                <label><input type="radio" name="gender" value="male"> ذكر</label>
                <label><input type="radio" name="gender" value="female"> أنثى</label>
              </div>
            </div>
            <div><label>الرقم المدني</label><input id="childCivilId"></div>
            <div><label>تاريخ الميلاد</label><input id="dob" type="date"></div>
            <div><label>الطول (سم)</label><input id="heightCm" type="number" step="0.1"></div>
            <div><label>الوزن (كجم)</label><input id="weightKg" type="number" step="0.1"></div>
            <div><label>الوحدة المفضلة</label><select id="preferredUnit"><option value="mmol">mmol/L</option><option value="mgdl">mg/dL</option></select></div>
            <div><label>نوع القياس الافتراضي</label>
              <select id="defaultMeasurementType">
                <option value="fingerstick">🩸 فحص إصبع</option>
                <option value="cgm">📈 CGM</option>
                <option value="lab">🧪 مختبر</option>
                <option value="other">✳️ أخرى</option>
              </select>
            </div>
            <div style="grid-column:1/-1"><label>ملاحظات</label><input id="notes" placeholder="اختياري"></div>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="btnSaveInfo" class="btn primary">💾 حفظ</button>
          </div>
        </div>

        <div class="card">
          <h3>🧪 إعدادات القياس و الجرعات <span class="badge">العرض دائمًا mmol/L (1 decimal)</span></h3>
          <div class="grid g3">
            <div><label>الهدف</label><input id="target" type="number" step="0.1"></div>
            <div><label>حد الهبوط</label><input id="low" type="number" step="0.1"></div>
            <div><label>حد الارتفاع</label><input id="high" type="number" step="0.1"></div>
            <div><label>ترسيبا (U/Day)</label><input id="tresiba" type="number" step="0.5"></div>
            <div><label>TDI (U)</label><input id="tdi" type="number" step="0.5"></div>
            <div><label>ISF (mmol/L لكل وحدة)</label><input id="isf" type="number" step="0.1"></div>
            <div><label>ICR (جرام/وحدة)</label><input id="icr" type="number" step="0.1"></div>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="btnSuggest" class="btn gray">💡 احسب من TDI</button>
            <button id="btnSaveGlucose" class="btn primary">💾 حفظ الإعدادات</button>
          </div>
          <div class="note" style="margin-top:6px">اقتراح سريع: ISF≈100/TDI • ICR≈500/TDI</div>
        </div>
      </section>

      <!-- (2) قياسات السكر -->
      <section id="sec-measure" class="section">
        <div class="card">
          <h3>📝 قياسات السكر <span class="badge">mmol/L — منزلة عشرية واحدة</span></h3>
          <div class="grid g3">
            <div><label>التاريخ</label><input type="date" id="dateSel" /></div>
            <div><label>وقت القياس</label>
              <select id="slotSel">
                <option value="">— اختاري الوقت —</option>
                <option value="uponWake">عند الاستيقاظ</option>
                <option value="preBreakfast">قبل الإفطار</option>
                <option value="postBreakfast">بعد الإفطار</option>
                <option value="preLunch">قبل الغداء</option>
                <option value="postLunch">بعد الغداء</option>
                <option value="preDinner">قبل العشاء</option>
                <option value="postDinner">بعد العشاء</option>
                <option value="beforeSleep">قبل النوم</option>
                <option value="duringSleep">أثناء النوم</option>
                <option value="beforeExercise">قبل التمرين</option>
                <option value="afterExercise">بعد التمرين</option>
                <option value="random">قياس عشوائي</option>
                <option value="other">أخرى</option>
              </select>
            </div>
            <div><label>نوع القياس</label>
              <select id="mType">
                <option value="fingerstick">🩸 فحص إصبع</option>
                <option value="cgm">📈 CGM</option>
                <option value="lab">🧪 مختبر</option>
                <option value="other">✳️ أخرى</option>
              </select>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>إدخال القياس والوجبة</h3>
          <div class="grid g3">
            <div><label>القراءة</label><input type="number" id="reading" step="0.1" min="0"/><div id="statusBadge" class="status ok" style="display:none;"></div></div>
            <div><label>كارب (جم)</label><input type="number" id="carbs" step="0.1" min="0"/></div>
            <div><label>جرعة مقترحة (ICR)</label><input type="number" id="suggestedDose" readonly/></div>
            <div><label>جرعة فعلية</label><input type="number" id="mealDose" step="0.1"/></div>
            <div id="correctionSection" style="display:none;"><label>جرعة تصحيحية</label><input type="number" id="correction" step="0.1"/></div>
            <div id="raiseSection" style="display:none;"><label>رفع السكر</label><input type="text" id="raise"/></div>
            <div style="grid-column:1/-1"><label>ملاحظة</label><textarea id="note" rows="2"></textarea></div>
          </div>
          <div class="row" style="margin-top:8px">
            <button class="btn primary" id="saveBtn">💾 حفظ القياس</button>
            <button class="btn gray" id="reloadDay">🔄 تحديث القراءات</button>
          </div>
        </div>

        <div class="card">
          <h3>قراءات اليوم</h3>
          <table>
            <thead><tr><th>الوقت</th><th>القراءة</th><th>الحالة</th><th>جرعة الوجبة</th><th>التصحيح/الرفع</th><th>نوع القياس</th><th>ملاحظة</th></tr></thead>
            <tbody id="rows"><tr><td colspan="7" class="note">لا توجد قراءات لليوم.</td></tr></tbody>
          </table>
        </div>
      </section>

      <!-- (3) الوجبات (مبسط هنا — إدارة كاملة عندك في foods-admin) -->
      <section id="sec-meals" class="section">
        <div class="card">
          <h3>🍽️ الوجبات</h3>
          <div class="note">قسم الوجبات يعمل مع صفحة إدارة الأصناف، ويمكن ربطه بالقياسات داخل التقارير.</div>
          <div class="row" style="margin-top:8px">
            <a href="foods-admin.html" class="btn orange">🗂️ إدارة الأصناف</a>
          </div>
        </div>
      </section>

      <!-- (4) التقارير — الشكل الجديد -->
      <section id="sec-reports" class="section">
        <div class="card wk-controls">
          <h3>📊 تقرير أسبوعي (mmol/L — منزلة عشرية واحدة)</h3>
          <div class="row no-print" style="gap:8px">
            <span class="pill">الفترة:</span>
            <select id="weekPreset">
              <option value="last7">آخر 7 أيام</option>
              <option value="thisWeek">الأسبوع الحالي</option>
              <option value="prevWeek">الأسبوع السابق</option>
              <option value="custom">مخصص</option>
            </select>
            <input id="fromW" type="date">
            <input id="toW" type="date">
            <button id="runWeekly" class="btn primary">عرض</button>
            <button id="printWeekly" class="btn gray">🖨️ طباعة PDF</button>
            <button id="printBlank" class="btn gray">📝 ورقة فارغة</button>
          </div>
          <div id="reportHeader" class="note" style="margin-top:6px"></div>
        </div>

        <div id="kpisBox" class="card" style="display:none">
          <div id="kpis" class="kpis"></div>
        </div>

        <div id="weeklyBox" class="card" style="display:none">
          <div class="wk-wrap" id="daysWrap"></div>
          <div class="note" style="margin-top:10px">
            مفتاح الرموز: <span class="legend"><span class="dot"></span> طبيعي • <span class="arrow-up">⬆️</span> مرتفع • <span class="arrow-down">⬇️</span> منخفض</span>
          </div>
        </div>
      </section>

      <!-- باقي الأقسام (مكان حفظ للطبيب/الزيارات) -->
      <section id="sec-doctor" class="section">
        <div class="card"><div class="note">🧑‍⚕️ الطبيب — سنضيفه لاحقًا بنفس المستوى.</div></div>
      </section>
      <section id="sec-visits" class="section">
        <div class="card"><div class="note">📅 الزيارات الطبية — سنكملها لاحقًا.</div></div>
      </section>
    </main>
  </div>

  <div id="toast" class="toast" style="position:fixed;bottom:16px;left:16px;background:#111;color:#fff;padding:10px 14px;border-radius:12px;opacity:0;transform:translateY(6px);transition:.25s"></div>

  <script type="module">
    import { db, auth } from './firebase-init.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { doc, getDoc, setDoc, collection, getDocs, addDoc, query, where, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    /* ---------- Helpers ---------- */
    const $=s=>document.querySelector(s); const $$=s=>[...document.querySelectorAll(s)];
    const toast=msg=>{ const t=$('#toast'); t.textContent=msg; t.style.opacity=1; t.style.transform='translateY(0)'; setTimeout(()=>{t.style.opacity=0; t.style.transform='translateY(6px)';},2000); };
    const numOrNull = (el)=>{ const v=typeof el==='string'?el:el.value; if(v===''||v==null) return null; const n=Number(v); return Number.isFinite(n)?n:null; };
    const escapeHTML=str=>(str||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));
    const fmtDDMMYYYY = (iso)=>{ if(!iso) return '—'; const d=new Date(iso); const p=n=>String(n).padStart(2,'0'); return `${p(d.getDate())}/${p(d.getMonth()+1)}/${d.getFullYear()}`; };

    // Sidebar nav
    $$('.sb-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        $$('.sb-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
        $$('.section').forEach(s=>s.classList.remove('active')); $('#'+btn.dataset.target).classList.add('active');
      });
    });

    /* ---------- State ---------- */
    let uid=null; 
    const params=new URLSearchParams(location.search);
    const childId=params.get('child');
    const preferred = { unit:'mmol' }; // العرض دائمًا mmol
    let lowMmol=null, highMmol=null, targetMmol=null;
    let icr=null, isf=null, tdi=null, tresiba=null;

    // تحويل + عرض
    const toMmol = v => v==null?null : v; // نحفظ/نعرض mmol
    const mmol1 = v => v==null?'—': Number(v).toFixed(1); // الكويت: منزلة واحدة
    const classify = mmol => (lowMmol!=null && mmol<lowMmol)?'low' : (highMmol!=null && mmol>highMmol)?'high':'ok';
    const arrow = mmol => mmol==null?'': (classify(mmol)==='low'?'⬇️': classify(mmol)==='high'?'⬆️':'🟢');

    /* ---------- Header Avatar ---------- */
    const elName=$('#kidName'), img=$('#childPhoto'), fallback=$('#avatarFallback');
    const slugify = s => (s||'').trim().toLowerCase().replace(/\s+/g,'-').replace(/[^\u0600-\u06FF\w-]/g,'');
    function setAvatarFallback(name, gender){
      const initials=(name||'').trim().split(/\s+/).slice(0,2).map(w=>w[0]||'').join('').toUpperCase();
      fallback.textContent = initials || (gender==='male'?'👦':'👧');
      fallback.style.display='grid'; img.style.display='none';
    }
    function trySetPhoto(child){
      const byId=`/images/${childId}.jpg`, byName=`/images/${slugify(child.name||'')}.jpg`;
      const test=(srcs,i=0)=>{ if(i>=srcs.length){ setAvatarFallback(child.name, child.gender); return; }
        img.onload=()=>{ img.style.display='block'; fallback.style.display='none'; };
        img.onerror=()=>test(srcs,i+1); img.src=srcs[i];
      }; test([byId,byName]);
    }

    /* ---------- Auth ---------- */
    onAuthStateChanged(auth, async user=>{
      if(!user){ location.href='index.html'; return; }
      uid=user.uid;
      $('#btnLogout').addEventListener('click', ()=>signOut(auth).then(()=>location.href='index.html'));
      if(!childId){ elName.textContent='لم يتم تحديد الطفل'; setAvatarFallback('',''); return; }

      const cSnap = await getDoc(doc(db,'users',uid,'children',childId));
      if(!cSnap.exists()){ elName.textContent='الطفل غير موجود'; setAvatarFallback('',''); return; }
      const c=cSnap.data();
      elName.textContent=c.name||'بدون اسم';
      trySetPhoto(c);

      // Fill info
      $('#childName').value=c.name||'';
      (c.gender && $$('input[name="gender"]').forEach(r=>r.checked=(r.value===c.gender)));
      $('#childCivilId').value=c.childCivilId||'';
      $('#dob').value=c.dob||'';
      $('#heightCm').value=c.heightCm ?? c.height ?? '';
      $('#weightKg').value=c.weightKg ?? c.weight ?? '';
      $('#preferredUnit').value=c.preferredUnit||'mmol';
      $('#defaultMeasurementType').value=c.defaultMeasurementType||'fingerstick';
      $('#notes').value=c.notes||'';

      const gc=c.glucoseConfig||{};
      const ds=c.dosing||{};
      lowMmol=gc.lowThresholdMmol ?? null;
      highMmol=gc.highThresholdMmol ?? null;
      targetMmol=gc.targetGlucoseMmol ?? null;
      $('#low').value = lowMmol??'';
      $('#high').value= highMmol??'';
      $('#target').value= targetMmol??'';

      tresiba=ds.basalTresibaUnits ?? null;
      tdi = ds.totalDailyInsulinUnits ?? null;
      isf = ds.isfMmolPerUnit ?? null;
      icr = ds.icrGramsPerUnit ?? null;
      $('#tresiba').value=tresiba??'';
      $('#tdi').value=tdi??'';
      $('#isf').value=isf??'';
      $('#icr').value=icr??'';

      bindInfoSavers();
      initMeasures();
      initWeeklyControls();
      await runWeeklyReport(); // افتراضي: آخر 7 أيام
    });

    /* ---------- Save Info ---------- */
    function bindInfoSavers(){
      $('#btnSaveInfo').addEventListener('click', async ()=>{
        const payload={
          name: $('#childName').value.trim()||null,
          gender: ($$('input[name="gender"]').find(r=>r.checked)?.value||null),
          childCivilId: $('#childCivilId').value.trim()||null,
          dob: $('#dob').value||null,
          heightCm: numOrNull($('#heightCm')),
          weightKg: numOrNull($('#weightKg')),
          preferredUnit: $('#preferredUnit').value,
          defaultMeasurementType: $('#defaultMeasurementType').value||'fingerstick',
          notes: $('#notes').value.trim()||null,
          lastUpdatedAt: new Date().toISOString()
        };
        try{ await setDoc(doc(db,'users',uid,'children',childId), payload,{merge:true}); toast('✅ تم حفظ بيانات الطفل'); }
        catch(e){ console.error(e); toast('❗ خطأ أثناء الحفظ'); }
      });

      $('#btnSuggest').addEventListener('click', ()=>{
        const t=Number($('#tdi').value);
        if(!t||t<=0){ toast('أدخلي TDI أولًا'); return; }
        const isfVal=+(100/t).toFixed(2), icrVal=+(500/t).toFixed(1);
        $('#isf').value=isfVal; $('#icr').value=icrVal; toast('💡 تم اقتراح ISF/ICR');
      });

      $('#btnSaveGlucose').addEventListener('click', async ()=>{
        const payload={
          glucoseConfig:{
            targetGlucoseMmol: numOrNull($('#target')),
            lowThresholdMmol:  numOrNull($('#low')),
            highThresholdMmol: numOrNull($('#high'))
          },
          dosing:{
            basalTresibaUnits:      numOrNull($('#tresiba')),
            totalDailyInsulinUnits: numOrNull($('#tdi')),
            isfMmolPerUnit:         numOrNull($('#isf')),
            icrGramsPerUnit:        numOrNull($('#icr'))
          },
          lastUpdatedAt: new Date().toISOString()
        };
        try{
          await setDoc(doc(db,'users',uid,'children',childId), payload,{merge:true});
          lowMmol=payload.glucoseConfig.lowThresholdMmol; highMmol=payload.glucoseConfig.highThresholdMmol; targetMmol=payload.glucoseConfig.targetGlucoseMmol;
          tresiba=payload.dosing.basalTresibaUnits; tdi=payload.dosing.totalDailyInsulinUnits; isf=payload.dosing.isfMmolPerUnit; icr=payload.dosing.icrGramsPerUnit;
          toast('✅ تم حفظ الإعدادات');
        }catch(e){ console.error(e); toast('❗ خطأ أثناء الحفظ'); }
      });
    }

    /* ---------- Measures Section ---------- */
    function initMeasures(){
      const today=new Date().toISOString().split('T')[0];
      $('#dateSel').value=today;
      $('#reloadDay').addEventListener('click', ()=>loadDay());
      $('#dateSel').addEventListener('change', ()=>loadDay());
      $('#carbs').addEventListener('input', ()=>{
        const c=Number($('#carbs').value); if(!icr||icr<=0||!Number.isFinite(c)) { $('#suggestedDose').value=''; return; }
        const d=Math.round((c/icr)*10)/10; $('#suggestedDose').value=d.toFixed(1);
      });
      $('#reading').addEventListener('input', ()=>{
        const val=Number($('#reading').value); if(!Number.isFinite(val)){ $('#statusBadge').style.display='none'; return; }
        const mmol=toMmol(val); const cls=classify(mmol); const sb=$('#statusBadge');
        sb.className=`status ${cls}`; sb.textContent = cls==='low'?'منخفض':cls==='high'?'مرتفع':'طبيعي'; sb.style.display='inline-block';
        $('#correctionSection').style.display = (cls==='high')?'block':'none';
        $('#raiseSection').style.display      = (cls==='low')?'block':'none';
      });
      $('#saveBtn').addEventListener('click', ()=>saveMeasure());
      loadDay();
    }

    async function loadDay(){
      const date=$('#dateSel').value; if(!date) return;
      const ref=doc(db,'users',uid,'children',childId,'measurements',date);
      const snap=await getDoc(ref); const readings=(snap.data()||{}).readings||{};
      renderDayRows(readings);
    }

    function renderDayRows(readings){
      const tbody=$('#rows');
      const labels={
        uponWake:'عند الاستيقاظ',
        preBreakfast:'قبل الإفطار', postBreakfast:'بعد الإفطار',
        preLunch:'قبل الغداء', postLunch:'بعد الغداء',
        preDinner:'قبل العشاء', postDinner:'بعد العشاء',
        beforeSleep:'قبل النوم', duringSleep:'أثناء النوم',
        beforeExercise:'قبل التمرين', afterExercise:'بعد التمرين',
        random:'قياس عشوائي', other:'أخرى'
      };
      const order=['uponWake','preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep','beforeExercise','afterExercise','random','other'];
      const keys=order.filter(k=>readings[k]).concat(Object.keys(readings).filter(k=>!order.includes(k)));
      if(keys.length===0){ tbody.innerHTML='<tr><td colspan="7" class="note">لا توجد قراءات لليوم.</td></tr>'; return; }
      tbody.innerHTML='';
      for(const k of keys){
        const r=readings[k]; const mmol=r?.valueMmol ?? r?.value ?? null;
        const disp= mmol1(mmol); const cls=classify(mmol);
        const status=`<span class="status ${cls}">${cls==='low'?'منخفض':cls==='high'?'مرتفع':'طبيعي'}</span>`;
        const type = r?.measurementType==='cgm'?'📈 CGM': r?.measurementType==='lab'?'🧪 مختبر': r?.measurementType==='other'?'✳️ أخرى':'🩸 فحص إصبع';
        const action = (r?.correction!=null)?`تصحيح: ${r.correction}U` : (r?.raise?`رفع: ${escapeHTML(r.raise)}` : (r?.mealDose!=null?`${r.mealDose}U`:'-'));
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${labels[k]||k}</td><td>${disp} mmol/L</td><td>${status}</td><td>${r?.mealDose??'-'}</td><td>${action}</td><td>${type}</td><td>${escapeHTML(r?.note||'-')}</td>`;
        tbody.appendChild(tr);
      }
    }

    async function saveMeasure(){
      const date=$('#dateSel').value, slot=$('#slotSel').value, raw=Number($('#reading').value);
      if(!date||!slot||!Number.isFinite(raw)){ toast('أدخلي التاريخ/الوقت/القراءة'); return; }
      const ref=doc(db,'users',uid,'children',childId,'measurements',date);
      const snap=await getDoc(ref); const base=snap.exists()?snap.data():{readings:{}};
      if(base.readings[slot]?.valueMmol!=null || base.readings[slot]?.value!=null){ toast('تم تسجيل هذا الوقت مسبقًا'); return; }
      const mmol=toMmol(raw);
      base.readings[slot]={
        valueMmol:+Number(mmol).toFixed(2), displayUnit:'mmol',
        measurementType: $('#mType').value||'fingerstick',
        note: ($('#note').value||'').trim()||null,
        carbs: numOrNull($('#carbs')),
        mealDose: numOrNull($('#mealDose')),
        correction: numOrNull($('#correction')),
        raise: ($('#raise').value||'').trim()||null
      };
      try{ await setDoc(ref, base, {merge:true}); toast('✅ تم حفظ القياس'); await loadDay(); }
      catch(e){ console.error(e); toast('❗ تعذر حفظ القياس'); }
    }

    /* ---------- Weekly Report (new layout) ---------- */
    const wk={
      preset:$('#weekPreset'), from:$('#fromW'), to:$('#toW'),
      run:$('#runWeekly'), print:$('#printWeekly'), blank:$('#printBlank'),
      header:$('#reportHeader'), box:$('#weeklyBox'), wrap:$('#daysWrap'),
      kpisBox:$('#kpisBox'), kpis:$('#kpis'),
      slots:[
        ['uponWake','الاستيقاظ'],
        ['preBreakfast','قبل الفطور'], ['postBreakfast','بعد الفطور'],
        ['preLunch','قبل الغداء'], ['postLunch','بعد الغداء'],
        ['preDinner','قبل العشاء'], ['postDinner','بعد العشاء'],
        ['beforeSleep','قبل النوم'], ['duringSleep','أثناء النوم'],
        ['beforeExercise','قبل التمرين'], ['afterExercise','بعد التمرين'],
        ['random','قياس عشوائي'], ['other','أخرى']
      ]
    };

    function initWeeklyControls(){
      const today=new Date();
      const to = fmtDate(today);
      const from = fmtDate(addDays(today,-6));
      wk.from.value=from; wk.to.value=to; wk.preset.value='last7';
      wk.from.disabled=true; wk.to.disabled=true;

      wk.preset.addEventListener('change', ()=>{
        const now=new Date();
        if(wk.preset.value==='custom'){ wk.from.disabled=false; wk.to.disabled=false; return; }
        wk.from.disabled=true; wk.to.disabled=true;
        if(wk.preset.value==='last7'){ wk.from.value=fmtDate(addDays(now,-6)); wk.to.value=fmtDate(now); }
        else if(wk.preset.value==='thisWeek'){ const s=startOfWeek(now), e=endOfWeek(now); wk.from.value=fmtDate(s); wk.to.value=fmtDate(e); }
        else if(wk.preset.value==='prevWeek'){ const s=addDays(startOfWeek(now),-7), e=addDays(endOfWeek(now),-7); wk.from.value=fmtDate(s); wk.to.value=fmtDate(e); }
      });
      wk.run.addEventListener('click', runWeeklyReport);
      wk.print.addEventListener('click', ()=>window.print());
      wk.blank.addEventListener('click', printWeeklyBlank);
    }

    function fmtDate(d){ const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`; }
    function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
    function startOfWeek(d){ const x=new Date(d); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); return x; }
    function endOfWeek(d){ const s=startOfWeek(d); return addDays(s,6); }
    function enumerateDays(from,to){ const res=[]; let d=new Date(from+"T00:00:00"); const end=new Date(to+"T00:00:00"); for(let i=0;i<7 && d<=end;i++){ res.push(fmtDate(d)); d=addDays(d,1);} return res; }

    function calcAge(dob){
      if(!dob) return null; const d=new Date(dob), n=new Date();
      let y=n.getFullYear()-d.getFullYear(); const m=n.getMonth()-d.getMonth(); if(m<0||(m===0&&n.getDate()<d.getDate())) y--; return y;
    }

    async function runWeeklyReport(){
      const from=wk.from.value, to=wk.to.value; if(!from||!to){ toast('حددي الفترة'); return; }
      // Header: بيانات الطفل
      const cSnap=await getDoc(doc(db,'users',uid,'children',childId)); const c=cSnap.data()||{};
      const age=calcAge(c.dob); const weight=c.weightKg ?? c.weight ?? '—'; const height=c.heightCm ?? c.height ?? '—';
      wk.header.innerHTML = `
        <b>الاسم:</b> ${escapeHTML(c.name||'—')}
        • <b>السن:</b> ${age??'—'}
        • <b>الرقم المدني:</b> ${escapeHTML(c.childCivilId||'—')}
        • <b>الوزن:</b> ${weight} كجم
        • <b>الطول:</b> ${height} سم
        • <b>ترسيبا:</b> ${tresiba??'—'}U
        • <b>TDI:</b> ${tdi??'—'}U
        • <b>حدود (mmol/L):</b> ⬇︎ ${lowMmol!=null? mmol1(lowMmol):'—'} • هدف ${targetMmol!=null? mmol1(targetMmol):'—'} • ⬆︎ ${highMmol!=null? mmol1(highMmol):'—'}
      `;

      const days=enumerateDays(from,to);
      const measSnaps=await Promise.all(days.map(d=>getDoc(doc(db,'users',uid,'children',childId,'measurements',d))));
      const byDate={}; days.forEach((d,i)=> byDate[d]=measSnaps[i].data()||{date:d, readings:{}});

      // Meals (اختياري: نجلبها ونربطها بالتوقيت)
      let mealsByDateSlot={};
      try{
        const startIso=new Date(from+"T00:00:00").toISOString();
        const endIso  =new Date(to  +"T23:59:59").toISOString();
        const qMeals=query(collection(db,'users',uid,'children',childId,'meals'), where('eatenAt','>=',startIso), where('eatenAt','<=',endIso), orderBy('eatenAt','asc'));
        const mSnap=await getDocs(qMeals);
        mSnap.forEach(ms=>{
          const m=ms.data(); const d=(m.eatenAt||'').slice(0,10);
          const slot = (m.mealType==='breakfast')?'postBreakfast': (m.mealType==='lunch')?'postLunch': (m.mealType==='dinner')?'postDinner':'random';
          mealsByDateSlot[d]=mealsByDateSlot[d]||{}; mealsByDateSlot[d][slot]=mealsByDateSlot[d][slot]||[];
          mealsByDateSlot[d][slot].push({
            totalCarbs: m.totalCarbs ?? null,
            bolusSuggested: m.bolusUnitsSuggested ?? null,
            bolusGiven: m.bolusUnitsGiven ?? null
          });
        });
      }catch(e){ console.warn('Meals query skipped/needs index', e); }

      // KPIs
      const all=[]; let low=0, ok=0, high=0; let carbSum=0, sug=0, giv=0;

      // Render
      wk.wrap.innerHTML='';
      for(const d of days){
        const card=document.createElement('div'); card.className='day-card';
        const titleDate = fmtDDMMYYYY(d+'T00:00:00');
        // رأس الكارت
        card.innerHTML = `
          <div class="day-head">
            <div class="day-date">${titleDate}</div>
            <div class="legend">الوحدة: mmol/L (منزلة واحدة)</div>
          </div>
        `;

        // جسم الكارت: قائمة التوقيتات
        const slotsDiv=document.createElement('div'); slotsDiv.className='slots';
        const readings=(byDate[d].readings||{});

        wk.slots.forEach(([key, name])=>{
          const box=document.createElement('div'); box.className='slot-box';
          const r = readings[key];
          const mmol = r?.valueMmol ?? r?.value ?? null;
          if(mmol!=null){
            const cls = classify(mmol);
            if(cls==='low') low++; else if(cls==='high') high++; else ok++;
            all.push(mmol);
          }
          const arrowSpan = `<span class="${mmol==null?'':(classify(mmol)==='low'?'arrow-down':classify(mmol)==='high'?'arrow-up':'arrow-ok')}">${arrow(mmol)}</span>`;
          const val = mmol==null? '—' : `${mmol1(mmol)} mmol/L`;
          const note = r?.note ? `<div class="mnote">ملاحظة: ${escapeHTML(r.note)}</div>` : '';
          // meal line
          const ms = (mealsByDateSlot[d]||{})[key]||[];
          let mealLine = '';
          if(ms.length){
            const csum = ms.reduce((s,x)=>s+(x.totalCarbs||0),0);
            const ssum = ms.reduce((s,x)=>s+(x.bolusSuggested||0),0);
            const gsum = ms.reduce((s,x)=>s+(x.bolusGiven||0),0);
            carbSum+=csum; sug+=ssum; giv+=gsum;
            mealLine = `<div class="meal-mini">🍽 ${csum.toFixed(1)}g • مقترح ${ssum? ssum.toFixed(1):'—'}U • فعلي ${gsum? gsum.toFixed(1):'—'}U</div>`;
          }
          box.innerHTML = `
            <div class="slot-title">${name}</div>
            <div class="mline"><span class="mval">${val}</span> ${arrowSpan}</div>
            ${note}
            ${mealLine}
          `;
          slotsDiv.appendChild(box);
        });

        card.appendChild(slotsDiv);
        wk.wrap.appendChild(card);
      }

      // KPIs
      const total=low+ok+high;
      const tir = total? Math.round((ok/total)*100):null;
      const avg = all.length? (all.reduce((a,b)=>a+b,0)/all.length):null;
      const min = all.length? Math.min(...all):null;
      const max = all.length? Math.max(...all):null;
      wk.kpis.innerHTML='';
      addKPI(`TIR: ${tir!=null? tir+'%':'—'}`);
      addKPI(`متوسط: ${avg!=null? mmol1(avg):'—'}`);
      addKPI(`أدنى: ${min!=null? mmol1(min):'—'}`);
      addKPI(`أعلى: ${max!=null? mmol1(max):'—'}`);
      addKPI(`منخفض: ${low}`); addKPI(`طبيعي: ${ok}`); addKPI(`مرتفع: ${high}`);
      addKPI(`كارب: ${carbSum.toFixed(1)}g`);
      addKPI(`جرعات: مقترح ${sug.toFixed(1)}U • فعلي ${giv.toFixed(1)}U`);
      wk.kpisBox.style.display='block';
      wk.box.style.display='block';

      function addKPI(t){ const el=document.createElement('div'); el.className='chip'; el.textContent=t; wk.kpis.appendChild(el); }
    }

    function printWeeklyBlank(){
      // يبقى الهيدر كما هو — نبدّل محتوى الأيام لفراغات
      wk.wrap.innerHTML='';
      const days=enumerateDays(wk.from.value,wk.to.value);
      for(const d of days){
        const card=document.createElement('div'); card.className='day-card';
        const titleDate=fmtDDMMYYYY(d+'T00:00:00');
        card.innerHTML = `
          <div class="day-head">
            <div class="day-date">${titleDate}</div>
            <div class="legend">الوحدة: mmol/L</div>
          </div>
        `;
        const slotsDiv=document.createElement('div'); slotsDiv.className='slots';
        wk.slots.forEach(([_,name])=>{
          const box=document.createElement('div'); box.className='slot-box';
          box.innerHTML = `
            <div class="slot-title">${name}</div>
            <div class="mline"><span class="mval">________ mmol/L</span> </div>
            <div class="mnote">ملاحظة: ______________________________</div>
            <div class="meal-mini">🍽 كارب: ________ g • جرعة: ________ U</div>
          `;
          slotsDiv.appendChild(box);
        });
        card.appendChild(slotsDiv);
        wk.wrap.appendChild(card);
      }
      window.print();
    }

    /* ---------- Utils ---------- */
    function fmtDate(d){ const p=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}`; }
    function addKPI(){}

  </script>
</body>
</html>
