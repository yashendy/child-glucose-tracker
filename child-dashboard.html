<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø·ÙÙ„ â€” Ù…ØªØ§Ø¨Ø¹Ø© Ø³ÙƒØ± Ø§Ù„Ø£Ø·ÙØ§Ù„</title>

  <style>
    :root{
      --brand:#0ea5e9; --brand2:#6ee7b7; --line:#e5e7eb;
      --ink:#0f172a; --muted:#6b7280; --bg:#f6fbff; --card:#fff;
      --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; --chip:#eef6ff;
      --hi:#f97316;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.6 "Tajawal",system-ui,sans-serif; display:flex; min-height:100vh}
    .sidebar{width:260px; flex:0 0 260px; background:linear-gradient(180deg,var(--brand),var(--brand2)); color:#fff; padding:16px; position:sticky; top:0; height:100vh; overflow:auto}
    .sb-title{font-weight:800; font-size:18px; margin-bottom:12px}
    .sb-btn{display:block; width:100%; text-align:right; background:transparent; border:none; color:#fff; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:700; margin:4px 0}
    .sb-btn:hover, .sb-btn.active{background:rgba(255,255,255,.18)}
    .spacer{height:6px}
    .main{flex:1; min-width:0}
    header{position:sticky; top:0; z-index:10; background:linear-gradient(90deg,var(--brand),var(--brand2)); color:#fff; padding:12px 16px; display:flex; align-items:center; justify-content:space-between;}
    .head-left{display:flex; align-items:center; gap:12px}
    .kid-photo{width:56px; height:56px; border-radius:16px; overflow:hidden; border:2px solid rgba(255,255,255,.75); background:#fff; display:grid; place-items:center}
    .kid-photo img{width:100%; height:100%; object-fit:cover; display:block}
    .avatar-fallback{width:100%; height:100%; display:none; place-items:center; background:#e0f7fa; color:#0f172a; font-weight:800; font-size:18px}
    .title-wrap{display:flex; flex-direction:column}
    .hello{font-size:14px; opacity:.9}
    .kid-name{font-size:18px; font-weight:800}
    .head-actions{display:flex; gap:8px; flex-wrap:wrap}
    .btn{border:none; border-radius:10px; padding:8px 12px; font-weight:800; cursor:pointer}
    .btn.gray{background:#eef2f7}
    .btn.dark{background:#0f172a; color:#fff}
    .btn.primary{background:var(--brand); color:#fff}
    .btn.orange{background:var(--hi); color:#fff}
    main{max-width:1200px; margin:auto; padding:16px}
    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px; box-shadow:0 2px 10px rgba(0,0,0,.05); margin-bottom:14px}
    .note{color:var(--muted); font-size:14px}
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; background:var(--chip); color:#0f172a; font-size:12px; margin-inline-start:6px}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .grid{display:grid; gap:12px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width:900px){.g3{grid-template-columns:1fr 1fr}}
    @media (max-width:680px){.g2,.g3{grid-template-columns:1fr}}
    label{display:block; color:var(--muted); font-size:13px; margin-bottom:6px}
    input,select,textarea{width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#fff}
    textarea{min-height:90px; resize:vertical}
    table{width:100%; border-collapse:collapse}
    th,td{border:1px solid var(--line); padding:8px; text-align:center}
    th{background:#f0f9ff}
    .status{display:inline-block; padding:6px 10px; border-radius:999px; font-size:12px}
    .ok{background:#ecfdf5; color:var(--ok)}
    .high{background:#fee2e2; color:#ef4444}
    .low{background:#fff7ed; color:#b45309}
    .meals-layout{display:grid; grid-template-columns:220px 1fr; gap:12px}
    .cats{display:flex; flex-direction:column; gap:8px}
    .cat-btn{border:1px solid var(--line); background:#fff; color:var(--ink); border-radius:10px; padding:8px 10px; cursor:pointer; text-align:right; font-weight:700}
    .cat-btn.active, .cat-btn:hover{background:#e6f7ff; border-color:#cfefff}
    .foods-grid{display:grid; gap:12px; grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
    .food-card{border:1px solid var(--line); background:#fff; border-radius:14px; padding:12px; box-shadow:0 2px 8px rgba(0,0,0,0.04)}
    .food-card img{width:80px; height:80px; object-fit:contain; display:block; margin:0 auto 6px}
    .food-name{font-weight:800; text-align:center}
    .food-sub{font-size:12px; color:var(--muted); text-align:center; margin-bottom:8px}
    .toggle{display:flex; gap:6px; justify-content:center; margin:6px 0}
    .toggle button{flex:1; border:1px solid var(--line); background:#fff; padding:6px 8px; border-radius:8px; cursor:pointer; font-weight:700}
    .toggle button.active{background:#eef6ff; border-color:#cfefff}
    .food-actions{display:flex; gap:6px; align-items:center; justify-content:center}
    .small{font-size:12px; color:var(--muted)}
    .basket{border:1px solid var(--line); border-radius:12px; overflow:hidden}
    .basket th{background:#fff}
    .basket tfoot td{font-weight:800}
    .pill{display:inline-block; background:#f1f5f9; border-radius:999px; padding:3px 8px; font-size:12px}
    .toast{position:fixed; bottom:16px; left:16px; background:#111; color:#fff; padding:10px 14px; border-radius:12px; opacity:0; transform:translateY(6px); transition:.25s}
    .toast.show{opacity:1; transform:none}
    .section{display:none}
    .section.active{display:block}
    #reportsFilter{display:flex; gap:12px; align-items:flex-end; margin-bottom:12px}
    #reportsTable{width:100%; border-collapse:collapse; margin-top:12px}
    #reportsTable th, #reportsTable td{border:1px solid var(--line); padding:8px; text-align:center}
    #reportsTable th{background:var(--line); font-weight:bold}
    @media print {
      body * { visibility:hidden; }
      #sectionReports, #sectionReports * { visibility:visible; }
      #sectionReports { position:absolute; top:0; left:0; width:100%; }
    }
  </style>

  <!-- html2pdf.js CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.2/html2pdf.bundle.min.js" integrity="" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>
  <aside class="sidebar">
    <div class="sb-title">ğŸ‘§ Ù„ÙˆØ­Ø© Ø§Ù„Ø·ÙÙ„</div>
    <button class="sb-btn active" data-target="sec-home">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <div class="spacer"></div>
    <button class="sb-btn" data-target="sec-info">âš™ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„</button>
    <button class="sb-btn" data-target="sec-measure">ğŸ“ Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ±</button>
    <button class="sb-btn" data-target="sec-meals">ğŸ½ï¸ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª</button>
    <button class="sb-btn" data-target="sec-reports">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
    <button class="sb-btn" data-target="sec-doctor">ğŸ§‘â€âš•ï¸ Ø§Ù„Ø·Ø¨ÙŠØ¨</button>
    <button class="sb-btn" data-target="sec-visits">ğŸ“… Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©</button>
  </aside>

  <div class="main">
    <header>
      <div class="head-left">
        <div class="kid-photo">
          <img id="childPhoto" alt="ØµÙˆØ±Ø© Ø§Ù„Ø·ÙÙ„">
          <div id="avatarFallback" class="avatar-fallback">ğŸ‘§</div>
        </div>
        <div class="title-wrap">
          <div class="hello">Ù…Ø±Ø­Ø¨Ù‹Ø§ ğŸ‘‹</div>
          <div id="kidName" class="kid-name">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…...</div>
        </div>
      </div>
      <div class="head-actions">
        <button id="btnLogout" class="btn dark">Ø®Ø±ÙˆØ¬</button>
      </div>
    </header>

    <main>
      <section id="sec-home" class="section active">
        <div class="card"><div class="note">Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙŠÙ…Ù†Ù‰ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.</div></div>
      </section>

      <!-- sections sec-info, sec-measure, sec-meals just like before -->

      <section id="sec-reports" class="section">
        <div class="card" id="sectionReports">
          <h3 class="section-title">ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ± Ù‚ÙŠØ§Ø³ Ø§Ù„Ø³ÙƒØ±</h3>

          <div id="reportMeta" style="margin-bottom:12px; border-bottom:1px dashed #ccc; padding-bottom:8px;">
            <div><strong>Ø§Ù„Ø§Ø³Ù…:</strong> <span id="reportChildName">â€”</span></div>
            <div><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±:</strong> <span id="reportDate">â€”</span></div>
          </div>

          <div id="reportsFilter">
            <div><label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label><input type="date" id="reportFromDate"></div>
            <div><label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label><input type="date" id="reportToDate"></div>
            <button class="btn primary" id="btnLoadReport">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
            <button class="btn gray" id="btnEmptyReport">ØªÙ‚Ø±ÙŠØ± ÙØ§Ø±Øº</button>
            <button class="btn primary" id="btnSavePdf">ØªØ­Ù…ÙŠÙ„ PDF</button>
            <button class="btn orange" id="btnPrintReport">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
          </div>

          <div id="reportHeader" class="note"></div>
          <table id="reportsTable"></table>
          <div id="noReportMsg" class="note">Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø£ÙŠ ØªÙ‚Ø±ÙŠØ± Ø¨Ø¹Ø¯.</div>
        </div>
      </section>

      <section id="sec-doctor" class="section">
        <div class="card"><div class="note">ğŸ§‘â€âš•ï¸ Ø§Ù„Ø·Ø¨ÙŠØ¨ â€” Ù‚Ø±ÙŠØ¨Ù‹Ø§.</div></div>
      </section>
      <section id="sec-visits" class="section">
        <div class="card"><div class="note">ğŸ“… Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ© â€” Ù‚Ø±ÙŠØ¨Ù‹Ø§.</div></div>
      </section>
    </main>
  </div>

  <div id="toast" class="toast"></div>

  <script type="module">
    import { db, auth } from './firebase-init.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      doc, getDoc, setDoc,
      collection, getDocs, addDoc, query, orderBy, limit, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

  
    const $ = s => document.querySelector(s);

    const showToast = (msg) â‡’ {
      const t = $('#toast');
      t.textContent = msg; t.classList.add('show');
      setTimeout(() â‡’ t.classList.remove('show'), 2200);
    };
    const escapeHtml = s â‡’ (s||'').replace(/[&<>"']/g, m â‡’ ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));

    const input = id â‡’ document.getElementById(id);
    let childId, childData;

    onAuthStateChanged(auth, async (user) â‡’ {
      if (!user) { location.href = 'index.html'; return; }
      $('#btnLogout').addEventListener('click', () â‡’ signOut(auth).then(â‡’ location.href = 'index.html'));

      childId = new URLSearchParams(location.search).get('child');
      if (!childId) { $('#kidName').textContent = 'Ù„Ù… ÙŠØªÙ… ØªÙ…Ø±ÙŠØ± Ù…Ø¹Ø±Ù Ø§Ù„Ø·ÙÙ„.'; return; }

      const snap = await getDoc(doc(db, 'users', user.uid, 'children', childId));
      if (!snap.exists()) { $('#kidName').textContent = 'Ø§Ù„Ø·ÙÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.'; return; }

      childData = snap.data();
      $('#kidName').textContent = childData.name || 'â€”';
      setupReportMeta();

      // (Call existing initialization functions: bind data sections)
    });

    function setupReportMeta(){
      $('#reportChildName').textContent = childData.name || 'â€”';
      $('#reportDate').textContent = new Date().toLocaleDateString('ar-EG');
    }

    $('#btnLoadReport').addEventListener('click', loadReport);
    $('#btnEmptyReport').addEventListener('click', () â‡’ { setupReportMeta(); showEmptyReport(); });
    $('#btnSavePdf').addEventListener('click', savePdfReport);
    $('#btnPrintReport').addEventListener('click', () â‡’ window.print());

    async function loadReport(){
      setupReportMeta();

      const from = input('reportFromDate').value;
      const to = input('reportToDate').value;
      const hdr = $('#reportHeader'), tbl = $('#reportsTable'), msg = $('#noReportMsg');
      tbl.innerHTML = ''; hdr.textContent = ''; msg.style.display = 'none';

      if (!from || !to) { showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø¯Ù‰ Ø§Ù„Ø²Ù…Ù†ÙŠ ÙƒØ§Ù…Ù„Ø§Ù‹.'); return; }
      if (from > to) { showToast('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® "Ù…Ù†" â‰¤ "Ø¥Ù„Ù‰".'); return; }

      hdr.textContent = `Ù…Ù† ${from} Ø¥Ù„Ù‰ ${to}`;
      const dates = getDatesInRange(from, to);

      let html = '<thead><tr><th>Ø§Ù„ØªÙˆÙ‚ÙŠØª</th>';
      dates.forEach(d â‡’ html += `<th>${d}</th>`);
      html += '</tr></thead><tbody>';

      const slots = [
        ['preBreakfast', 'Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±'],
        ['postBreakfast', 'Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±'],
        ['preLunch', 'Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡'],
        ['postLunch', 'Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡'],
        ['preDinner', 'Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡'],
        ['postDinner', 'Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡'],
        ['bedtime', 'Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…'],
        ['exercise', 'Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠÙ†'],
        ['other', 'Ø£Ø®Ø±Ù‰']
      ];

      for (const [slotKey, slotLabel] of slots) {
        html += `<tr><td><strong>${slotLabel}</strong></td>`;
        for (const date of dates) {
          const snap = await getDoc(doc(db, 'users', auth.currentUser.uid, 'children', childId, 'measurements', date));
          if (snap.exists() && snap.data().readings?.[slotKey]) {
            const r = snap.data().readings[slotKey];
            const mmol = r.valueMmol ?? r.value;
            const disp = preferredUnit === 'mgdl'
              ? String(Math.round(mmol / 0.0555))
              : mmol.toFixed(1);
            const cls = (lowMmol !== null && mmol < lowMmol) ? 'low' :
                        (highMmol !== null && mmol > highMmol) ? 'high' : 'ok';
            const icon = cls === 'high' ? 'ğŸ”º' : cls === 'low' ? 'ğŸ”»' : 'ğŸŸ¢';
            html += `<td>${disp} ${preferredUnit === 'mgdl' ? 'mg/dL' : 'mmol/L'} ${icon}<br>`;
            html += r.mealDose != null ? `${r.mealDose}U` : '';
            html += r.note ? `<br><span class="note">${escapeHtml(r.note)}</span>` : '';
            html += '</td>';
          } else {
            html += '<td>-</td>';
          }
        }
        html += '</tr>';
      }

      html += '</tbody>';
      tbl.innerHTML = html;
    }

    function showEmptyReport(){
      const today = new Date().toISOString().split('T')[0];
      $('#reportHeader').textContent = '';
      $('#reportsTable').innerHTML = '';
      $('#noReportMsg').style.display = 'none';

      const hdr = $('#reportHeader');
      hdr.textContent = `ØªÙ‚Ø±ÙŠØ± ÙØ§Ø±Øº â€” ${today}`;
      const dates = [today];
      let html = '<thead><tr><th>Ø§Ù„ØªÙˆÙ‚ÙŠØª</th>';
      dates.forEach(d â‡’ html += `<th>${d}</th>`);
      html += '</tr></thead><tbody>';

      const labels = ['Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±','Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±','Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡','Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡','Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡','Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡','Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…','Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠÙ†','Ø£Ø®Ø±Ù‰'];
      labels.forEach(lbl â‡’ {
        html += `<tr><td><strong>${lbl}</strong></td>`;
        dates.forEach(() â‡’ html += '<td>-</td>');
        html += '</tr>';
      });

      html += '</tbody>';
      $('#reportsTable').innerHTML = html;
    }

    function savePdfReport(){
      setupReportMeta();
      html2pdf().set({
        margin: [0.5, 0.75],
        filename: `ØªÙ‚Ø±ÙŠØ±-${childData?.name || 'Ø§Ù„Ø·ÙÙ„'}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'landscape' }
      }).from($('#sectionReports')).save();
    }

    function getDatesInRange(start, end){
      const arr = [];
      let dt = new Date(start), ed = new Date(end);
      while (dt <= ed) {
        arr.push(dt.toISOString().split('T')[0]);
        dt.setDate(dt.getDate() + 1);
      }
      return arr;
    }

    // (Ù‡Ù†Ø§ ØªØ¶Ø¹ Ø¨Ù‚ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ Ø³Ø§Ø¨Ù‚Ù‹Ø§ Ø¥Ù† ÙˆØ¬Ø¯: data bindings, measurements, meals, Ø¥Ù„Ø®.)
  </script>
</body>
</html>
