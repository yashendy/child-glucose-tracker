<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>لوحة الطفل</title>
<style>
:root{--brand:#0ea5e9;--brand2:#6ee7b7;--line:#e5e7eb;--ink:#0f172a;--muted:#6b7280;--bg:#f6fbff;--card:#fff}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.6 system-ui,"Tajawal","Noto Sans Arabic",sans-serif}
a{color:inherit;text-decoration:none}
.btn{border:none;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
.btn.primary{background:var(--brand);color:#fff}.btn.gray{background:#eef2f7}
.note{color:var(--muted);font-size:13px}
.badge{display:inline-block;background:#eef6ff;color:#0369a1;border-radius:999px;padding:6px 10px;font-weight:800}
.badge-soft{display:inline-block;background:#eef6ff;color:#0369a1;border-radius:999px;padding:4px 8px;font-weight:800;font-size:12px}

/* ===== Layout with sidebar ===== */
.topbar{position:sticky;top:0;z-index:10;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;padding:10px 14px;display:flex;justify-content:space-between;align-items:center}
.topbar .btn{background:#ffffff22;border:1px solid #ffffff66;color:#fff}
.layout{display:grid;grid-template-columns:260px 1fr;gap:14px;max-width:1200px;margin:auto;padding:14px}
@media(max-width:980px){.layout{grid-template-columns:1fr}}
.sidebar{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:10px;position:sticky;top:66px;height:max-content}
.navbtn{display:flex;align-items:center;gap:8px;width:100%;border:1px solid var(--line);background:#fff;border-radius:10px;padding:10px 12px;margin-bottom:8px;cursor:pointer;font-weight:700}
.navbtn.active,.navbtn:hover{background:#e6f7ff;border-color:#b3e5ff}
.content{min-width:0}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 6px 24px rgba(0,0,0,.04);margin-bottom:14px}
.row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.grid{display:grid;gap:10px}.g2{grid-template-columns:repeat(2,minmax(0,1fr))}.g3{grid-template-columns:repeat(3,minmax(0,1fr))}
@media(max-width:920px){.g2,.g3{grid-template-columns:1fr}}
.sep{height:1px;background:var(--line);margin:10px 0}

/* child header */
.child-head{display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap}
.kid{display:flex;align-items:center;gap:12px}
.avatar{width:64px;height:64px;border-radius:50%;object-fit:cover;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.12)}

/* meals grid */
.meals-wrap{display:grid;grid-template-columns:220px 1fr;gap:12px}
@media(max-width:900px){.meals-wrap{grid-template-columns:1fr}}
.cats{display:flex;flex-direction:column;gap:8px}
.cat-btn{border:1px solid var(--line);border-radius:12px;padding:10px;background:#fff;cursor:pointer;text-align:right;font-weight:800}
.cat-btn.active,.cat-btn:hover{background:#e6f7ff;border-color:#b3e5ff}
.foods-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
.food{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.04)}
.food img{width:80px;height:80px;object-fit:contain}
.food .name{font-weight:800;margin-top:6px}
.food .carb{color:#0f766e;font-weight:700;font-size:13px}
.input-mini{width:84px}

/* basket */
.basket table{width:100%;border-collapse:separate;border-spacing:0}
.basket th,.basket td{border:1px solid var(--line);padding:8px;text-align:center}
.basket thead th{background:#f0f9ff}

/* measures table */
.table{width:100%;border-collapse:separate;border-spacing:0}
.table th,.table td{border:1px solid var(--line);padding:8px;text-align:right;vertical-align:top}
.table thead th{background:#f0f9ff;font-weight:800}
.center{text-align:center}
.state{display:inline-block;padding:2px 8px;border-radius:999px}
.state.ok{background:#ecfdf5;color:#16a34a}.state.low{background:#fff7ed;color:#b45309}.state.high{background:#fee2e2;color:#dc2626}

/* reports */
.table-report{width:100%;border-collapse:collapse}
.table-report th,.table-report td{border:1px solid var(--line);padding:6px;text-align:center;vertical-align:top}
.table-report thead th{background:#f1f5f9;font-weight:800}
.report-meta{font-size:13px;margin-bottom:8px;color:var(--muted)}
@media print{header,.sidebar{display:none!important}.layout{display:block;padding:0}.card{border:0;box-shadow:none}}
.toast{position:fixed;bottom:16px;left:16px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transform:translateY(8px);transition:.3s;z-index:9999}
.toast.show{opacity:1;transform:none}
</style>
</head>
<body>

<header class="topbar">
  <div class="row">
    <a class="btn" href="dashboard.html">لوحة وليّ الأمر</a>
    <button id="btnLogout" class="btn" type="button">خروج</button>
  </div>
  <div id="hello" class="row">مرحبًا…</div>
</header>

<div class="layout">
  <!-- ===== Sidebar ===== -->
  <aside class="sidebar">
    <button class="navbtn active" data-target="#sec-home">🏠 الرئيسية</button>
    <button class="navbtn" data-target="#sec-info">👶 بيانات الطفل</button>
    <button class="navbtn" data-target="#sec-measures">🧪 قياسات السكر</button>
    <button class="navbtn" data-target="#sec-meals">🍽️ الوجبات</button>
    <button class="navbtn" data-target="#sec-report">📊 تقرير الطبيب</button>
    <button class="navbtn" data-target="#sec-visits">🩺 الزيارات الطبية</button>
  </aside>

  <!-- ===== Content ===== -->
  <main class="content">

    <!-- الرئيسية -->
    <section class="card child-head" id="sec-home">
      <div class="kid">
        <img id="kidAvatar" class="avatar" src="images/avatar-default.png" alt="صورة الطفل" onerror="this.src='https://cdn-icons-png.flaticon.com/512/9131/9131529.png'">
        <div>
          <div class="name" id="kidName">—</div>
          <div class="note" id="kidMeta">—</div>
        </div>
      </div>
      <span class="badge" id="unitBadge">الوحدة: mmol/L</span>
    </section>

    <!-- بيانات الطفل -->
    <section class="card" id="sec-info" style="display:none">
      <h3 style="margin:0 0 10px">🧒 بيانات الطفل</h3>
      <div class="grid g2">
        <div><label>الاسم</label><input id="cName"></div>
        <div><label>النوع</label><select id="cGender"><option>ذكر</option><option>أنثى</option></select></div>
        <div><label>الرقم المدني</label><input id="cCivilId"></div>
        <div><label>تاريخ الميلاد</label><input id="cBirth" type="date"></div>
        <div><label>الوزن (كجم)</label><input id="cWeight" type="number" step="0.1"></div>
        <div><label>الطول (سم)</label><input id="cHeight" type="number" step="0.1"></div>
      </div>

      <div class="sep"></div>

      <h4>⚙️ إعدادات السكر</h4>
      <div class="grid g2">
        <div><label>الوحدة المفضلة</label><select id="cUnit"><option value="mmol/L">mmol/L</option><option value="mg/dL">mg/dL</option></select></div>
        <div><label>القياس الأمثل</label><input id="cTarget" type="number" step="0.1"></div>
        <div><label>حد الهبوط</label><input id="cLow" type="number" step="0.1"></div>
        <div><label>حد الارتفاع</label><input id="cHigh" type="number" step="0.1"></div>
      </div>

      <div class="sep"></div>

      <h4>💉 جرعات</h4>
      <div class="grid g3">
        <div><label>جرعة الترسيبا</label><input id="cTresiba" type="number" step="0.1"></div>
        <div><label>جرعة الأنسولين اليومية</label><input id="cTotalInsulin" type="number" step="0.1"></div>
        <div><label>معامل التصحيح</label><input id="cCorrectionFactor" type="number" step="0.1"></div>
        <div><label>ICR (جم كارب/وحدة)</label><input id="cICR" type="number" step="0.1"></div>
      </div>

      <div class="sep"></div>

      <h4>📷 صورة الطفل</h4>
      <div class="row">
        <input type="file" id="cPhoto" accept="image/*">
      </div>

      <div class="row" style="justify-content:flex-end;margin-top:10px">
        <button id="saveInfo" class="btn primary">💾 حفظ البيانات</button>
      </div>
    </section>

    <!-- قياسات السكر -->
    <section class="card" id="sec-measures" style="display:none">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">🧪 تسجيل القياسات</h3>
        <span class="badge-soft">الوحدة: <b id="mUnitBadge">mmol/L</b></span>
      </div>

      <div class="grid g3" style="margin:10px 0">
        <div><label>التاريخ</label><input id="mDate" type="date"></div>
        <div><label>وقت القياس</label>
          <select id="mSlot">
            <option value="">— اختاري —</option>
            <option value="uponWake">الاستيقاظ</option>
            <option value="preBreakfast">قبل الإفطار</option>
            <option value="postBreakfast">بعد الإفطار</option>
            <option value="preLunch">قبل الغداء</option>
            <option value="postLunch">بعد الغداء</option>
            <option value="preDinner">قبل العشاء</option>
            <option value="postDinner">بعد العشاء</option>
            <option value="beforeSleep">قبل النوم</option>
            <option value="duringSleep">أثناء النوم</option>
            <option value="beforeExercise">قبل التمرين</option>
            <option value="afterExercise">بعد التمرين</option>
            <option value="random">قياس عشوائي</option>
            <option value="other">أخرى</option>
          </select>
        </div>
        <div><label>القراءة (mmol/L)</label><input id="mValue" type="number" step="0.1" min="0"></div>

        <div><label>كارب (جم)</label><input id="mCarbs" type="number" step="0.1" min="0"></div>
        <div><label>جرعة مقترحة (ICR)</label><input id="mDoseSuggested" readonly></div>
        <div><label>جرعة فعلية</label><input id="mDoseGiven" type="number" step="0.1" min="0"></div>

        <div><label>جرعة تصحيحية</label><input id="mCorrection" type="number" step="0.1" min="0"></div>
        <div><label>رفع السكر (إن لزم)</label><input id="mRaisedWith" placeholder="عصير/تمر..."></div>
        <div><label>ملاحظة</label><input id="mNote" placeholder="اختياري"></div>
      </div>

      <div class="row" style="justify-content:flex-end">
        <button id="mSave" class="btn primary">💾 حفظ القياس</button>
      </div>

      <div class="sep"></div>

      <h4 style="margin:0 0 6px">📅 قراءات اليوم</h4>
      <div class="note">يتم التقريب لأقرب 0.1 (مثال: 7.8)</div>
      <table class="table">
        <thead>
          <tr><th>الوقت</th><th>القراءة</th><th>الحالة</th><th>جرعات</th><th>ملاحظات</th></tr>
        </thead>
        <tbody id="mRows"><tr><td colspan="5" class="note center">لا توجد قياسات.</td></tr></tbody>
      </table>
    </section>

    <!-- الوجبات -->
    <section class="card" id="sec-meals" style="display:none">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">🍽️ الوجبات</h3>
        <span class="badge-soft">ICR الحالي: <b id="icrNow">—</b> g/U</span>
      </div>

      <div class="grid g3" style="margin:10px 0">
        <div><label>نوع الوجبة</label>
          <select id="mealType"><option value="breakfast">فطور</option><option value="lunch">غداء</option><option value="dinner">عشاء</option><option value="snack">سناك</option><option value="other">أخرى</option></select>
        </div>
        <div><label>وقت الأكل</label><input id="mealTime" type="datetime-local"></div>
        <div><label>ملاحظة</label><input id="mealNote" placeholder="اختياري"></div>
      </div>

      <div class="meals-wrap">
        <div>
          <input id="foodSearch" placeholder="ابحث عن صنف..." style="width:100%;margin-bottom:8px">
          <div id="catList" class="cats"><button class="cat-btn active" data-cat="*">كل الأصناف</button></div>
        </div>

        <div>
          <div id="foodsGrid" class="foods-grid"><div class="note">جاري التحميل...</div></div>
          <div class="card" style="margin-top:12px">
            <div class="row" style="justify-content:space-between">
              <h4 style="margin:0">🧺 سلة الوجبة</h4>
              <div class="badge-soft">إجمالي الكارب: <b id="totalCarbs">0.0</b> جم</div>
            </div>
            <div class="basket" style="margin-top:8px;overflow:auto">
              <table>
                <thead><tr><th>الصنف</th><th>الوحدة</th><th>الكمية</th><th>الكارب (جم)</th><th>إجراء</th></tr></thead>
                <tbody id="basketBody"><tr><td colspan="5" class="note">لا توجد عناصر بعد.</td></tr></tbody>
                <tfoot><tr><td colspan="3"><b>الإجمالي</b></td><td id="totalCarbsCell">0.0</td><td></td></tr></tfoot>
              </table>
            </div>
            <div class="grid g3" style="margin-top:10px">
              <div><label>الجرعة المقترحة</label><input id="doseSuggestedMeal" readonly></div>
              <div><label>جرعة فعلية (اختياري)</label><input id="doseGivenMeal" type="number" step="0.1"></div>
              <div class="row" style="align-items:flex-end;justify-content:flex-end"><button id="saveMealBtn" class="btn primary">💾 حفظ الوجبة</button></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- تقرير الطبيب -->
    <section class="card" id="sec-report" style="display:none">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">📊 تقرير الطبيب</h3>
        <div><button id="btnReportPDF" class="btn primary">📄 طباعة PDF</button>
            <button id="btnReportBlank" class="btn gray">📝 تقرير فارغ (7 أيام)</button></div>
      </div>
      <div class="report-meta" id="reportMeta">—</div>
      <table class="table-report" id="reportTable">
        <thead><tr>
          <th>التاريخ</th><th>الاستيقاظ</th><th>قبل الإفطار</th><th>بعد الإفطار</th><th>قبل الغداء</th><th>بعد الغداء</th><th>قبل العشاء</th><th>بعد العشاء</th><th>قبل النوم</th><th>أثناء النوم</th>
        </tr></thead>
        <tbody id="reportRows"><tr><td colspan="10" class="note">لا توجد بيانات بعد.</td></tr></tbody>
      </table>
    </section>

    <!-- الزيارات -->
    <section class="card" id="sec-visits" style="display:none">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">📅 الزيارات الطبية</h3>
        <div class="row"><button id="btnVisitNew" class="btn">➕ زيارة جديدة</button></div>
      </div>
      <div id="visitFormBox" style="display:none;margin-top:8px">
        <h4 style="margin:0 0 6px">إضافة / تعديل زيارة</h4>
        <div class="grid g3">
          <div><label>تاريخ الزيارة</label><input id="vDate" type="date"></div>
          <div><label>اسم الطبيب</label><input id="vDoctor"></div>
          <div><label>العيادة / المستشفى</label><input id="vClinic"></div>
          <div style="grid-column:1/-1"><label>السبب / الشكوى</label><input id="vReason"></div>
          <div style="grid-column:1/-1"><label>ملاحظات</label><textarea id="vNotes" rows="2"></textarea></div>
        </div>
        <div class="row" style="justify-content:flex-end;margin-top:8px">
          <button id="btnVisitSave" class="btn primary">💾 حفظ الزيارة</button>
          <button id="btnVisitCancel" class="btn gray">إلغاء</button>
        </div>
      </div>
      <div style="margin-top:10px">
        <table class="table"><thead><tr><th>التاريخ</th><th>الطبيب</th><th>العيادة</th><th>السبب</th><th>إجراءات</th></tr></thead>
          <tbody id="visitsRows"><tr><td colspan="5" class="note">لا توجد زيارات بعد.</td></tr></tbody>
        </table>
      </div>
    </section>

  </main>
</div>

<div id="toast" class="toast"></div>

<script type="module">
/* ===== Firebase ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, getDocs, query, where, orderBy, addDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig={apiKey:"AIzaSyCOdrwdbw8b7YdWLPZ4TDdG2iS9kvvxQ7M",authDomain:"child-glucose-tracker.firebaseapp.com",projectId:"child-glucose-tracker",storageBucket:"child-glucose-tracker.firebasestorage.app",messagingSenderId:"294563325904",appId:"1:294563325904:web:39562550bf305fc01abbd5"};
const app=initializeApp(firebaseConfig); const auth=getAuth(app); const db=getFirestore(app);

const $=s=>document.querySelector(s);
const toast=m=>{const t=$("#toast"); t.textContent=m; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),2200);};

let uid=null, childId=null, child=null;

onAuthStateChanged(auth, async (user)=>{
  if(!user){ location.href="index.html"; return; }
  uid=user.uid;
  childId = new URLSearchParams(location.search).get('child');
  if(!childId){ alert("لم يتم تحديد الطفل"); return; }
  await loadChild();
  initNav();
  initInfo();
  initMeasures();
  initMeals();
  initReport();
  initVisits();
});

/* ===== Sidebar nav ===== */
function initNav(){
  const btns=[...document.querySelectorAll(".navbtn")];
  btns.forEach(b=>b.addEventListener("click",()=>{
    btns.forEach(x=>x.classList.remove("active"));
    b.classList.add("active");
    const target=b.dataset.target;
    [...document.querySelectorAll("main .card")].forEach(sec=>sec.style.display="none");
    $(target).style.display="block";
    if(target==="#sec-home") $("#sec-home").style.display="flex";
  }));
  // افتراضي: الرئيسية ظاهرة
  $("#sec-home").style.display="flex";
}

/* ===== Load child ===== */
async function loadChild(){
  const snap=await getDoc(doc(db,'users',uid,'children',childId));
  if(!snap.exists()){ alert("الطفل غير موجود"); return; }
  child=snap.data();
  $("#kidName").textContent = child.name || "—";
  $("#kidMeta").textContent = `${child.gender||''} • ${child.weight||'—'}كجم • ${child.height||'—'}سم`;
  $("#unitBadge").textContent = `الوحدة: ${child.unit||'mmol/L'}`;
  if(child.photoURL) $("#kidAvatar").src = child.photoURL;
}

/* ===== Info section ===== */
function initInfo(){
  // تعبئة الحقول
  $('#cName').value=child.name||''; $('#cGender').value=child.gender||'ذكر';
  $('#cCivilId').value=child.childCivilId||''; $('#cBirth').value=child.birthDate||'';
  $('#cWeight').value=child.weight??''; $('#cHeight').value=child.height??'';
  $('#cUnit').value=child.unit||'mmol/L'; $('#cTarget').value=child.target??'';
  $('#cLow').value=child.lowThreshold??''; $('#cHigh').value=child.highThreshold??'';
  $('#cTresiba').value=child.tresibaDose??''; $('#cTotalInsulin').value=child.totalInsulin??'';
  $('#cCorrectionFactor').value=child.correctionFactor??''; $('#cICR').value=child.icr??'';

  $('#saveInfo').onclick = async ()=>{
    const data={
      name:$('#cName').value.trim(),
      gender:$('#cGender').value,
      childCivilId:$('#cCivilId').value.trim(),
      birthDate:$('#cBirth').value||null,
      weight:num($('#cWeight')), height:num($('#cHeight')),
      unit:$('#cUnit').value, target:num($('#cTarget')),
      lowThreshold:num($('#cLow')), highThreshold:num($('#cHigh')),
      tresibaDose:num($('#cTresiba')), totalInsulin:num($('#cTotalInsulin')),
      correctionFactor:num($('#cCorrectionFactor')), icr:num($('#cICR'))
    };
    await setDoc(doc(db,'users',uid,'children',childId), data, {merge:true});
    toast("✅ تم حفظ البيانات");
    await loadChild();
  };

  // رفع صورة (اختياري): حفظ URL خارجي بسيط عبر FileReader كمعاينة فقط — للرفع الحقيقي نحتاج storage rules مناسبة
  $('#cPhoto').addEventListener('change', async (e)=>{
    const f=e.target.files[0]; if(!f) return;
    const fr=new FileReader(); fr.onload=()=>{$('#kidAvatar').src=fr.result};
    fr.readAsDataURL(f);
    // لو لديك تخزين مُفعل وقواعد تسمح، ارفع واحفظ photoURL
  });
}
function num(el){const v=el.value; if(v===''||v==null) return null; const n=Number(v); return Number.isFinite(n)?n:null;}

/* ===== Measures section ===== */
const mLabels = {uponWake:'الاستيقاظ',preBreakfast:'قبل الإفطار',postBreakfast:'بعد الإفطار',preLunch:'قبل الغداء',postLunch:'بعد الغداء',preDinner:'قبل العشاء',postDinner:'بعد العشاء',beforeSleep:'قبل النوم',duringSleep:'أثناء النوم',beforeExercise:'قبل التمرين',afterExercise:'بعد التمرين',random:'قياس عشوائي',other:'أخرى'};
const mOrder=['uponWake','preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep','beforeExercise','afterExercise','random','other'];

function initMeasures(){
  $("#mUnitBadge").textContent='mmol/L';
  $("#mDate").value=todayISO();
  $("#mDate").addEventListener('change', loadDay);
  $("#mCarbs").addEventListener('input', ()=>{
    const carbs=Number($("#mCarbs").value)||0; const icr=Number(child?.icr)||0;
    $("#mDoseSuggested").value = (icr>0 && carbs>0) ? (Math.round((carbs/icr)*10)/10).toFixed(1) : '';
  });
  $("#mSave").addEventListener('click', saveMeasure);
  loadDay();
}

function todayISO(){return new Date().toISOString().slice(0,10);}
function round1(n){return Math.round(Number(n)*10)/10;}
function stateBy(v,low,high){if(v==null||isNaN(v))return'ok'; if(isFinite(low)&&v<low)return'low'; if(isFinite(high)&&v>high)return'high'; return'ok';}

async function loadDay(){
  const date=$("#mDate").value;
  const ref=doc(db,'users',uid,'children',childId,'measurements',date);
  const snap=await getDoc(ref);
  const data=snap.data()||{};
  const readings=data.readings||{};
  const low=Number(child?.lowThreshold), high=Number(child?.highThreshold);
  const tb=$("#mRows"); let html='';
  mOrder.forEach(k=>{
    const r=readings[k]; if(!r||r.valueMmol==null) return;
    const v=round1(Number(r.valueMmol)); const st=stateBy(v,low,high);
    const doses=[(r.mealDose!=null?`وجبة: ${r.mealDose}U`:''),(r.correctionGiven!=null?`تصحيح: ${r.correctionGiven}U`:'')].filter(Boolean).join(' • ')||'—';
    const note=r.note||r.raisedWith||'—';
    html+=`<tr><td><b>${mLabels[k]}</b></td><td>${v.toFixed(1)} mmol/L</td><td><span class="state ${st}">${st==='low'?'منخفض':st==='high'?'مرتفع':'طبيعي'}</span></td><td>${doses}</td><td>${escapeHTML(note)}</td></tr>`;
  });
  tb.innerHTML = html || `<tr><td colspan="5" class="note center">لا توجد قياسات.</td></tr>`;
}

/* ✅ منع تكرار نفس الوقت لنفس اليوم */
async function saveMeasure(){
  const date=$("#mDate").value.trim();
  const slot=$("#mSlot").value;
  const val=round1(Number($("#mValue").value||0));
  if(!date||!slot){ alert("اختاري التاريخ ووقت القياس"); return; }
  if(!(val>0)){ alert("اكتبي قراءة صحيحة"); return; }

  const ref=doc(db,'users',uid,'children',childId,'measurements',date);
  const snap=await getDoc(ref);
  const base=snap.data()||{date,readings:{}};
  if(!base.readings) base.readings={};

  /* 👇 هنا المنع */
  if(base.readings[slot] && base.readings[slot].valueMmol!=null){
    alert("هذا الوقت مسجّل بالفعل لهذا اليوم. لا يمكن تكراره.");
    return;
  }

  const payload={
    valueMmol:val,
    status:stateBy(val, Number(child?.lowThreshold), Number(child?.highThreshold)),
    carbs: numEl('#mCarbs'), mealDose: numEl('#mDoseGiven'),
    correctionGiven: numEl('#mCorrection'),
    raisedWith: textEl('#mRaisedWith'), note: textEl('#mNote')
  };
  base.readings[slot]=payload;
  await setDoc(ref, base, {merge:true});
  toast("✅ تم حفظ القياس");
  await loadDay();
}
function numEl(sel){const v=$(sel).value; if(v===''||v==null) return null; const n=Number(v); return Number.isFinite(n)?n:null;}
function textEl(sel){const v=$(sel).value?.trim(); return v? v : null;}
function escapeHTML(s){return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}

/* ===== Meals section (مختصر مع سلة) ===== */
let foodsAll=[], currentCategory='*', basket=[];
async function initMeals(){
  $('#icrNow').textContent = Number(child?.icr)||'—';
  const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); $('#mealTime').value=d.toISOString().slice(0,16);
  await loadFoods(); buildCategories(); renderFoods();
  $('#foodSearch').addEventListener('input', renderFoods);
  $('#saveMealBtn').addEventListener('click', saveMeal);
}
async function loadFoods(){
  foodsAll=[]; const qs=await getDocs(collection(db,'foods'));
  qs.forEach(s=>{ const d=s.data(); foodsAll.push({id:s.id,name:d.name||'—',category:d.category||'أخرى',carbsPer100g:Number(d.carbsPer100g)||0,imageUrl:d.imageUrl||'https://cdn-icons-png.flaticon.com/512/1046/1046784.png',servingUnits:Array.isArray(d.servingUnits)&&d.servingUnits.length?d.servingUnits:[{unit:'جرام',grams:100}]}); });
}
function buildCategories(){
  const set=new Set(['*']); foodsAll.forEach(f=>set.add(f.category));
  const box=$("#catList"); box.innerHTML='';
  [...set].forEach(cat=>{ const b=document.createElement('button'); b.className='cat-btn'+(cat===currentCategory?' active':''); b.dataset.cat=cat; b.textContent=(cat==='*'?'كل الأصناف':cat); b.onclick=()=>{currentCategory=cat;[...box.children].forEach(x=>x.classList.remove('active'));b.classList.add('active');renderFoods();}; box.appendChild(b); });
}
function renderFoods(){
  const grid=$("#foodsGrid"); const q=($('#foodSearch').value||'').toLowerCase();
  const list=foodsAll.filter(f=>(currentCategory==='*'||f.category===currentCategory)&&(!q||f.name.toLowerCase().includes(q)));
  if(!list.length){ grid.innerHTML='<div class="note">لا توجد أصناف.</div>'; return; }
  grid.innerHTML=''; list.forEach(f=>{
    const card=document.createElement('div'); card.className='food';
    const unitOpts=f.servingUnits.map(u=>`<option value="${u.grams}">${u.unit} (${u.grams} جم)</option>`).join('');
    card.innerHTML=`<img src="${f.imageUrl}"><div class="name">${escapeHTML(f.name)}</div><div class="carb">كارب/100جم: <b>${f.carbsPer100g}</b></div>
      <div class="row" style="justify-content:center;margin-top:6px"><select class="unitSel">${unitOpts}</select><input class="input-mini qty" type="number" min="0.1" step="0.1" value="1"></div>
      <div class="row" style="justify-content:space-between;margin-top:8px"><button class="btn gray addBtn">➕ أضف</button><span class="badge-soft">${escapeHTML(f.category)}</span></div>`;
    const unitSel=card.querySelector('.unitSel'); const qty=card.querySelector('.qty');
    card.querySelector('.addBtn').onclick=()=>{
      const grams=Number(unitSel.value)||100, qv=Number(qty.value)||0; if(qv<=0) return alert('أدخلي كمية صحيحة');
      const total = +((grams*qv*f.carbsPer100g)/100).toFixed(1);
      basket.push({name:f.name,unit:findUnitName(f.servingUnits,grams),gramsPerUnit:grams,qty:qv,carbsPer100g:f.carbsPer100g,totalCarbs:total});
      renderBasket();
    };
    grid.appendChild(card);
  });
}
function findUnitName(units,grams){const u=(units||[]).find(x=>Number(x.grams)===Number(grams));return u?`${u.unit} (${u.grams}جم)`:`جرام (${grams})`;}
function renderBasket(){
  const tb=$("#basketBody"); if(!basket.length){ tb.innerHTML='<tr><td colspan="5" class="note">لا توجد عناصر بعد.</td></tr>'; $('#totalCarbs').textContent='0.0'; $('#totalCarbsCell').textContent='0.0'; $('#doseSuggestedMeal').value=''; return; }
  tb.innerHTML=''; let total=0;
  basket.forEach((it,i)=>{ total+=it.totalCarbs; const tr=document.createElement('tr');
    tr.innerHTML=`<td>${escapeHTML(it.name)}</td><td>${escapeHTML(it.unit)}</td>
      <td><input class="input-mini q" type="number" min="0.1" step="0.1" value="${it.qty}"></td>
      <td class="c">${it.totalCarbs.toFixed(1)}</td><td><button class="btn gray">🗑️ حذف</button></td>`;
    tr.querySelector('.q').oninput=e=>{it.qty=Number(e.target.value)||0; it.totalCarbs=+((it.gramsPerUnit*it.qty*it.carbsPer100g)/100).toFixed(1); tr.querySelector('.c').textContent=it.totalCarbs.toFixed(1); recomputeTotals();};
    tr.querySelector('button').onclick=()=>{basket.splice(i,1); renderBasket();};
    tb.appendChild(tr);
  });
  $('#totalCarbs').textContent=total.toFixed(1); $('#totalCarbsCell').textContent=total.toFixed(1);
  const icr=Number(child?.icr)||0; $('#doseSuggestedMeal').value=(icr>0&&total>0)?(Math.round((total/icr)*10)/10).toFixed(1):'';
}
function recomputeTotals(){let t=0; basket.forEach(b=>t+=b.totalCarbs); $('#totalCarbs').textContent=t.toFixed(1); $('#totalCarbsCell').textContent=t.toFixed(1); const icr=Number(child?.icr)||0; $('#doseSuggestedMeal').value=(icr>0&&t>0)?(Math.round((t/icr)*10)/10).toFixed(1):'';}
async function saveMeal(){
  if(!basket.length) return alert('السلة فارغة');
  const time=$('#mealTime').value; if(!time) return alert('اختاري وقت الأكل');
  const total=basket.reduce((a,b)=>a+b.totalCarbs,0);
  await addDoc(collection(db,'users',uid,'children',childId,'meals'),{type:$('#mealType').value,time, note:$('#mealNote').value||null, icrUsed:Number(child?.icr)||null,totalCarbs:+total.toFixed(1), items:basket});
  toast('✅ تم حفظ الوجبة'); basket=[]; renderBasket();
}

/* ===== Doctor report (مختصر) ===== */
function initReport(){
  $('#btnReportPDF').onclick=()=>window.print();
  $('#btnReportBlank').onclick=()=>renderBlank7();
  buildReportRange(todayISO(), todayISO());
}
async function buildReportRange(from,to){
  $('#reportMeta').textContent=`الاسم: ${child?.name||'—'} • الفترة: ${from} → ${to} • الوحدة: mmol/L`;
  const qy=query(collection(db,'users',uid,'children',childId,'measurements'), where('date','>=',from), where('date','<=',to), orderBy('date','asc'));
  const qs=await getDocs(qy); const rows=[];
  qs.forEach(s=>{const d=s.data(); const r=d.readings||{}; const row=[d.date];
    ['uponWake','preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep'].forEach(k=>{const x=r[k]; if(x&&x.valueMmol!=null){const st=stateBy(x.valueMmol,child?.lowThreshold,child?.highThreshold); const icon=st==='low'?'⬇️':st==='high'?'⬆️':'🟢'; row.push(`${(Math.round(x.valueMmol*10)/10).toFixed(1)} ${icon}`);} else row.push('—');});
    rows.push(row);
  });
  const tb=$("#reportRows"); tb.innerHTML = rows.length? rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('') : `<tr><td colspan="10" class="note">لا توجد بيانات.</td></tr>`;
}
function renderBlank7(){
  const t=new Date(); const days=[...Array(7)].map((_,i)=>{const d=new Date(t); d.setDate(t.getDate()+i); return d.toISOString().slice(0,10);});
  $('#reportRows').innerHTML = days.map(date=>`<tr><td>${date}</td>${'<td>—</td>'.repeat(9)}</tr>`).join('');
}

/* ===== Visits (بسيط) ===== */
function initVisits(){
  $('#btnVisitNew').onclick=()=>{$('#visitFormBox').style.display='block'; $('#vDate').value=todayISO();};
  $('#btnVisitCancel').onclick=()=>{$('#visitFormBox').style.display='none'};
  $('#btnVisitSave').onclick=saveVisit;
  loadVisits();
}
async function saveVisit(){
  const payload={date:$('#vDate').value, doctor:$('#vDoctor').value||null, clinic:$('#vClinic').value||null, reason:$('#vReason').value||null, notes:$('#vNotes').value||null};
  if(!payload.date) return alert('أدخلي تاريخ الزيارة');
  await addDoc(collection(db,'users',uid,'children',childId,'visits'), payload);
  toast('✅ تم حفظ الزيارة'); $('#visitFormBox').style.display='none'; loadVisits();
}
async function loadVisits(){
  const tb=$("#visitsRows"); const qs=await getDocs(query(collection(db,'users',uid,'children',childId,'visits'), orderBy('date','desc')));
  if(qs.empty){ tb.innerHTML='<tr><td colspan="5" class="note">لا توجد زيارات بعد.</td></tr>'; return; }
  const rows=[]; qs.forEach(s=>{const v=s.data(); rows.push(`<tr><td><b>${v.date||'—'}</b></td><td>${v.doctor||'—'}</td><td>${v.clinic||'—'}</td><td>${v.reason||'—'}</td><td class="center">—</td></tr>`);});
  tb.innerHTML=rows.join('');
}

/* ===== Logout ===== */
$("#btnLogout").onclick=()=>signOut(auth).then(()=>location.href='index.html');
</script>
</body>
</html>
