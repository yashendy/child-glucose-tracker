<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø·ÙÙ„ â€” Ù…ØªØ§Ø¨Ø¹Ø© Ø³ÙƒØ± Ø§Ù„Ø£Ø·ÙØ§Ù„</title>

  <style>
    :root{
      --brand:#0ea5e9; --brand2:#6ee7b7; --line:#e5e7eb;
      --ink:#0f172a; --muted:#6b7280; --bg:#f6fbff; --card:#fff;
      --ok:#10b981; --warn:#f59e0b; --bad:#ef4444; --chip:#eef6ff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.6 "Tajawal",system-ui,sans-serif; display:flex; min-height:100vh}

    /* ===== Sidebar ===== */
    .sidebar{
      width:260px; flex:0 0 260px; background:linear-gradient(180deg,var(--brand),var(--brand2));
      color:#fff; padding:16px; position:sticky; top:0; height:100vh; overflow:auto
    }
    .sb-title{font-weight:800; font-size:18px; margin-bottom:12px}
    .sb-btn{display:block; width:100%; text-align:right; background:transparent; border:none; color:#fff;
      padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:700; margin:4px 0}
    .sb-btn:hover, .sb-btn.active{background:rgba(255,255,255,.18)}
    .spacer{height:6px}

    /* ===== Main ===== */
    .main{flex:1; min-width:0}
    header{
      position:sticky; top:0; z-index:10; background:linear-gradient(90deg,var(--brand),var(--brand2));
      color:#fff; padding:12px 16px; display:flex; align-items:center; justify-content:space-between;
    }
    .head-left{display:flex; align-items:center; gap:12px}
    .kid-photo{ width:56px; height:56px; border-radius:16px; overflow:hidden; border:2px solid rgba(255,255,255,.75); background:#fff; display:grid; place-items:center }
    .kid-photo img{width:100%; height:100%; object-fit:cover; display:block}
    .avatar-fallback{ width:100%; height:100%; display:none; place-items:center; background:#e0f7fa; color:#0f172a; font-weight:800; font-size:18px }
    .title-wrap{display:flex; flex-direction:column}
    .hello{font-size:14px; opacity:.9}
    .kid-name{font-size:18px; font-weight:800}
    .head-actions{display:flex; gap:8px; flex-wrap:wrap}
    .btn{border:none; border-radius:10px; padding:8px 12px; font-weight:800; cursor:pointer}
    .btn.gray{background:#eef2f7}
    .btn.dark{background:#0f172a; color:#fff}
    .btn.primary{background:var(--brand); color:#fff}

    main{max-width:1200px; margin:auto; padding:16px}
    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px; box-shadow:0 2px 10px rgba(0,0,0,.05); margin-bottom:14px}
    .note{color:var(--muted); font-size:14px}

    /* Grids */
    .grid{display:grid; gap:12px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width: 900px){ .g3{grid-template-columns:1fr 1fr} }
    @media (max-width: 680px){ .g2,.g3{grid-template-columns:1fr} }

    label{display:block; color:var(--muted); font-size:13px; margin-bottom:6px}
    input,select,textarea{width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#fff}
    textarea{min-height:90px; resize:vertical}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .field{display:flex; flex-direction:column}
    .radio-wrap{display:flex; gap:14px; align-items:center}
    .radio-wrap label{margin:0; font-size:14px; color:var(--ink)}
    .section-title{margin:0 0 10px; font-size:18px}
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; background:var(--chip); color:#0f172a; font-size:12px; margin-inline-start:6px}

    /* Measurements list */
    table{width:100%; border-collapse:collapse}
    th,td{border:1px solid var(--line); padding:8px; text-align:center}
    th{background:#f0f9ff}
    .status{display:inline-block; padding:6px 10px; border-radius:999px; font-size:12px}
    .ok{background:#ecfdf5; color:var(--ok)}
    .high{background:#fee2e2; color:var(--bad)}
    .low{background:#fff7ed; color:#b45309}

    /* Toast */
    .toast{position:fixed; bottom:16px; left:16px; background:#111; color:#fff; padding:10px 14px; border-radius:12px; opacity:0; transform:translateY(6px); transition:.25s}
    .toast.show{opacity:1; transform:none}

    /* Section visibility */
    .section{display:none}
    .section.active{display:block}
  </style>
</head>
<body>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sb-title">ğŸ‘§ Ù„ÙˆØ­Ø© Ø§Ù„Ø·ÙÙ„</div>
    <button class="sb-btn active" data-target="sec-home">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
    <div class="spacer"></div>
    <button class="sb-btn" data-target="sec-info">âš™ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„</button>
    <button class="sb-btn" data-target="sec-measure">ğŸ“ Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ±</button>
    <button class="sb-btn" data-target="sec-meals">ğŸ½ï¸ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª</button>
    <button class="sb-btn" data-target="sec-reports">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
    <button class="sb-btn" data-target="sec-doctor">ğŸ§‘â€âš•ï¸ Ø§Ù„Ø·Ø¨ÙŠØ¨</button>
    <button class="sb-btn" data-target="sec-visits">ğŸ“… Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©</button>
  </aside>

  <div class="main">
    <!-- Header -->
    <header>
      <div class="head-left">
        <div class="kid-photo">
          <img id="childPhoto" alt="ØµÙˆØ±Ø© Ø§Ù„Ø·ÙÙ„">
          <div id="avatarFallback" class="avatar-fallback">ğŸ‘§</div>
        </div>
        <div class="title-wrap">
          <div class="hello">Ù…Ø±Ø­Ø¨Ù‹Ø§ ğŸ‘‹</div>
          <div id="kidName" class="kid-name">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…...</div>
        </div>
      </div>
      <div class="head-actions">
        <a class="btn gray" href="dashboard.html">Ù„ÙˆØ­Ø© ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±</a>
        <button id="btnLogout" class="btn dark">Ø®Ø±ÙˆØ¬</button>
      </div>
    </header>

    <main>
      <!-- Home -->
      <section id="sec-home" class="section active">
        <div class="card">
          <div class="note">Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙŠÙ…Ù†Ù‰ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨.</div>
        </div>
      </section>

      <!-- (1) Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„ -->
      <section id="sec-info" class="section">
        <section class="card" id="childInfoSection">
          <h3 class="section-title">âš™ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„</h3>
          <div class="grid g3">
            <div class="field">
              <label for="childName">Ø§Ø³Ù… Ø§Ù„Ø·ÙÙ„</label>
              <input id="childName" placeholder="Ù…Ø«Ø§Ù„: Ù„ÙŠÙ„Ù‰ Ø£Ø­Ù…Ø¯">
            </div>
            <div class="field">
              <label>Ø§Ù„Ù†ÙˆØ¹</label>
              <div class="radio-wrap">
                <label><input type="radio" name="gender" value="male"> Ø°ÙƒØ±</label>
                <label><input type="radio" name="gender" value="female"> Ø£Ù†Ø«Ù‰</label>
              </div>
            </div>
            <div class="field">
              <label for="childCivilId">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¯Ù†ÙŠ</label>
              <input id="childCivilId" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ">
            </div>
            <div class="field">
              <label for="dob">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label>
              <input id="dob" type="date">
            </div>
            <div class="field">
              <label for="heightCm">Ø§Ù„Ø·ÙˆÙ„ (Ø³Ù…)</label>
              <input id="heightCm" type="number" step="0.1" placeholder="Ù…Ø«Ø§Ù„: 125">
            </div>
            <div class="field">
              <label for="weightKg">Ø§Ù„ÙˆØ²Ù† (ÙƒØ¬Ù…)</label>
              <input id="weightKg" type="number" step="0.1" placeholder="Ù…Ø«Ø§Ù„: 26.4">
            </div>
            <div class="field">
              <label for="preferredUnit">Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø© Ù„Ù„Ø¹Ø±Ø¶</label>
              <select id="preferredUnit">
                <option value="mmol">mmol/L</option>
                <option value="mgdl">mg/dL</option>
              </select>
            </div>
            <div class="field">
              <label for="defaultMeasurementType">Ù†ÙˆØ¹ Ø§Ù„Ù‚ÙŠØ§Ø³ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</label>
              <select id="defaultMeasurementType">
                <option value="fingerstick">ğŸ©¸ ÙØ­Øµ Ø¥ØµØ¨Ø¹</option>
                <option value="cgm">ğŸ“ˆ CGM</option>
                <option value="lab">ğŸ§ª Ù…Ø®ØªØ¨Ø±</option>
                <option value="other">âœ³ï¸ Ø£Ø®Ø±Ù‰</option>
              </select>
            </div>
            <div class="field" style="grid-column:1/-1">
              <label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
              <input id="notes" placeholder="Ø­Ø³Ø§Ø³ÙŠØ©ØŒ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø®Ø§ØµØ©ØŒ Ø¥Ù„Ø® (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="btnSaveInfo" class="btn primary">ğŸ’¾ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„</button>
          </div>
        </section>

        <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø³ ÙˆØ§Ù„Ø¬Ø±Ø¹Ø§Øª -->
        <section class="card" id="glucoseDosingSection">
          <h3 class="section-title">
            ğŸ§ª Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø³ Ùˆ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª
            <span id="unitBadge" class="badge">Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©: mmol/L</span>
          </h3>
          <div class="grid g3">
            <div class="field">
              <label for="target">Ø§Ù„Ù‚ÙŠØ§Ø³ Ø§Ù„Ø£Ù…Ø«Ù„ (Ø§Ù„Ù‡Ø¯Ù)</label>
              <input id="target" type="number" step="0.1" placeholder="Ù…Ø«Ø§Ù„: 6.5">
            </div>
            <div class="field">
              <label for="low">Ø­Ø¯ Ø§Ù„Ù‡Ø¨ÙˆØ·</label>
              <input id="low" type="number" step="0.1" placeholder="Ù…Ø«Ø§Ù„: 4.0">
            </div>
            <div class="field">
              <label for="high">Ø­Ø¯ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹</label>
              <input id="high" type="number" step="0.1" placeholder="Ù…Ø«Ø§Ù„: 10.0">
            </div>
            <div class="field">
              <label for="tresiba">Ø¬Ø±Ø¹Ø© Ø§Ù„ØªØ±Ø³ÙŠØ¨Ø§ (ÙˆØ­Ø¯Ø©/ÙŠÙˆÙ…)</label>
              <input id="tresiba" type="number" step="0.5" placeholder="Ù…Ø«Ø§Ù„: 10">
            </div>
            <div class="field">
              <label for="tdi">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…ÙŠ TDI (ÙˆØ­Ø¯Ø©)</label>
              <input id="tdi" type="number" step="0.5" placeholder="Ù…Ø«Ø§Ù„: 24">
            </div>
            <div class="field">
              <label for="isf">Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„ØªØµØ­ÙŠØ­ ISF <span id="isfUnitLabel" class="badge">mmol/L Ù„ÙƒÙ„ 1U</span></label>
              <input id="isf" type="number" step="0.1" placeholder="ÙƒÙ… ØªÙ†Ø²Ù„ Ø§Ù„ÙˆØ­Ø¯Ø©ØŸ">
            </div>
            <div class="field">
              <label for="icr">Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„ÙƒØ§Ø±Ø¨ ICR (Ø¬Ø±Ø§Ù…/ÙˆØ­Ø¯Ø©)</label>
              <input id="icr" type="number" step="0.5" placeholder="Ø¬Ø±Ø§Ù… ÙƒØ§Ø±Ø¨ Ù„ÙƒÙ„ 1U">
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="btnSuggest" class="btn gray">ğŸ’¡ Ø§Ø­Ø³Ø¨ Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ…</button>
            <button id="btnSaveGlucose" class="btn primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
          </div>
        </section>
      </section>

      <!-- (2) Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ± â€” Ø¨Ù†Ù…Ø·Ùƒ Ø§Ù„Ù‚Ø¯ÙŠÙ… (ÙˆØ«ÙŠÙ‚Ø© Ù„ÙƒÙ„ ÙŠÙˆÙ… + slots) -->
      <section id="sec-measure" class="section">
        <section class="card">
          <h3 class="section-title">
            ğŸ“ Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ±
            <span id="mUnitBadge" class="badge">Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©: mmol/L</span>
          </h3>
          <div class="grid g3">
            <div>
              <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
              <input type="date" id="dateSel" />
            </div>
            <div>
              <label>ÙˆÙ‚Øª Ø§Ù„Ù‚ÙŠØ§Ø³</label>
              <select id="slotSel">
                <option value="">â€” Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„ÙˆÙ‚Øª â€”</option>
                <option value="preBreakfast">Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±</option>
                <option value="postBreakfast">Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±</option>
                <option value="preLunch">Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡</option>
                <option value="postLunch">Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡</option>
                <option value="preDinner">Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡</option>
                <option value="postDinner">Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡</option>
                <option value="bedtime">Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…</option>
                <option value="exercise">Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠÙ†</option>
                <option value="other">Ø£Ø®Ø±Ù‰...</option>
              </select>
            </div>
            <div>
              <label>Ù†ÙˆØ¹ Ø§Ù„Ù‚ÙŠØ§Ø³</label>
              <select id="mType">
                <option value="fingerstick">ğŸ©¸ ÙØ­Øµ Ø¥ØµØ¨Ø¹</option>
                <option value="cgm">ğŸ“ˆ CGM</option>
                <option value="lab">ğŸ§ª Ù…Ø®ØªØ¨Ø±</option>
                <option value="other">âœ³ï¸ Ø£Ø®Ø±Ù‰</option>
              </select>
            </div>
          </div>
        </section>

        <section class="card">
          <h3 class="section-title">Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù‚ÙŠØ§Ø³ ÙˆØ§Ù„ÙˆØ¬Ø¨Ø©</h3>
          <div class="grid g3">
            <div>
              <label>Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</label>
              <input type="number" id="reading" step="0.1" min="0" />
              <div id="statusBadge" class="status ok" style="display:none;"></div>
            </div>
            <div>
              <label>ÙƒØ§Ø±Ø¨ (Ø¬Ù…)</label>
              <input type="number" id="carbs" step="0.1" min="0" />
            </div>
            <div>
              <label>Ø¬Ø±Ø¹Ø© Ù…Ù‚ØªØ±Ø­Ø© (ICR)</label>
              <input type="number" id="suggestedDose" readonly />
            </div>
            <div>
              <label>Ø¬Ø±Ø¹Ø© ÙØ¹Ù„ÙŠØ©</label>
              <input type="number" id="mealDose" step="0.1" />
            </div>
            <div id="correctionSection" style="display:none;">
              <label>Ø¬Ø±Ø¹Ø© ØªØµØ­ÙŠØ­ÙŠØ©</label>
              <input type="number" id="correction" step="0.1" />
            </div>
            <div id="raiseSection" style="display:none;">
              <label>Ø±ÙØ¹ Ø§Ù„Ø³ÙƒØ± (Ù…Ø«Ù„Ø§Ù‹ Ø¹ØµÙŠØ±)</label>
              <input type="text" id="raise" />
            </div>
            <div style="grid-column:1/-1">
              <label>Ù…Ù„Ø§Ø­Ø¸Ø©</label>
              <textarea id="note" rows="2"></textarea>
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <button class="btn primary" id="saveBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³</button>
            <button class="btn gray" id="reloadDay">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª</button>
          </div>
        </section>

        <section class="card">
          <h3 class="section-title">Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
          <table>
            <thead>
              <tr><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¬Ø±Ø¹Ø© Ø§Ù„ÙˆØ¬Ø¨Ø©</th><th>Ø§Ù„ØªØµØ­ÙŠØ­/Ø§Ù„Ø±ÙØ¹</th><th>Ù†ÙˆØ¹ Ø§Ù„Ù‚ÙŠØ§Ø³</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th></tr>
            </thead>
            <tbody id="rows">
              <tr><td colspan="7" class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø¡Ø§Øª Ù„Ù„ÙŠÙˆÙ….</td></tr>
            </tbody>
          </table>
        </section>
      </section>

      <!-- (3) Ø§Ù„ÙˆØ¬Ø¨Ø§Øª -->
      <section id="sec-meals" class="section">
        <section class="card">
          <h3 class="section-title">ğŸ½ï¸ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª</h3>
          <div class="note">Ù‡Ù†ÙƒÙ…Ù‘Ù„Ù‡Ø§ Ø¨Ø¹Ø¯ Ù…Ø§ ØªØªØ£ÙƒØ¯ÙŠ Ù…Ù† Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª ÙˆØ§Ù„Ù‚Ø§Ø¦Ù…Ø© ğŸ‘</div>
        </section>
      </section>

      <!-- Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù…Ø¬Ø±Ø¯ Placeholders Ø­Ø§Ù„ÙŠØ§Ù‹ -->
      <section id="sec-reports" class="section">
        <div class="card"><div class="note">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± â€” Ù‚Ø±ÙŠØ¨Ù‹Ø§.</div></div>
      </section>

      <section id="sec-doctor" class="section">
        <div class="card"><div class="note">ğŸ§‘â€âš•ï¸ Ø§Ù„Ø·Ø¨ÙŠØ¨ â€” Ù‚Ø±ÙŠØ¨Ù‹Ø§.</div></div>
      </section>

      <section id="sec-visits" class="section">
        <div class="card"><div class="note">ğŸ“… Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ© â€” Ù‚Ø±ÙŠØ¨Ù‹Ø§.</div></div>
      </section>
    </main>
  </div>

  <div id="toast" class="toast"></div>

  <script type="module">
    import { db, auth } from './firebase-init.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      doc, getDoc, setDoc,
      collection, getDocs, query, orderBy, limit, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // ===== Helpers & DOM =====
    const $ = sel => document.querySelector(sel);
    const $$ = sel => [...document.querySelectorAll(sel)];
    const toastEl = $('#toast');
    const showToast = (msg)=>{ toastEl.textContent=msg; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'),2200); };

    const elName   = $('#kidName');
    const img      = $('#childPhoto');
    const fallback = $('#avatarFallback');

    const params  = new URLSearchParams(location.search);
    const childId = params.get('child');

    const input = id => document.getElementById(id);
    const genderRadios = () => [...document.querySelectorAll('input[name="gender"]')];
    const setGenderUI = (value) => genderRadios().forEach(r => r.checked = (r.value === value));
    const getGenderUI = () => (genderRadios().find(r => r.checked)?.value || null);
    const numOrNull = (el) => { const v = el.value; if (v === '' || v == null) return null; const n = Number(v); return Number.isFinite(n) ? n : null; };

    const slugify = s => (s||'').trim().toLowerCase().replace(/\s+/g,'-').replace(/[^\u0600-\u06FF\w-]/g,'');

    const setAvatarFallback = (name, gender) => {
      const initials = (name||'').trim().split(/\s+/).slice(0,2).map(w=>w[0]||'').join('').toUpperCase();
      fallback.textContent = initials || (gender==='male' ? 'ğŸ‘¦' : 'ğŸ‘§');
      fallback.style.display = 'grid';
    };
    const trySetPhoto = (child) => {
      const byId = `/images/${childId}.jpg`, byName = `/images/${slugify(child.name||'')}.jpg`;
      const test = (srcs,i=0)=>{ if(i>=srcs.length){ img.style.display='none'; setAvatarFallback(child.name, child.gender); return; }
        img.onload=()=>{ img.style.display='block'; fallback.style.display='none'; };
        img.onerror=()=>test(srcs,i+1); img.src=srcs[i];
      }; test([byId,byName]);
    };

    // ===== Sidebar navigation =====
    $$('.sb-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        $$('.sb-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const target = btn.dataset.target;
        $$('.section').forEach(sec=>sec.classList.remove('active'));
        document.getElementById(target).classList.add('active');
      });
    });

    // ===== Units & thresholds =====
    let preferredUnit = 'mmol'; // "mmol" | "mgdl"
    let targetMmol=null, lowMmol=null, highMmol=null;
    let icr = null; // Ø¬Ø±Ø§Ù…/ÙˆØ­Ø¯Ø©

    const toMmol  = (v) => (v==null?null : (preferredUnit==='mgdl' ? v*0.0555 : v));
    const fromMmolNumber = (v) => (preferredUnit==='mgdl' ? (v/0.0555) : v);

    function displayValue(valueMmol){
      if (valueMmol==null) return '';
      if (preferredUnit==='mgdl'){
        return String(Math.round(valueMmol/0.0555)); // mg/dL integer
      }
      return Number(valueMmol).toFixed(1); // mmol/L one decimal
    }

    function classify(mmol){
      if (lowMmol!=null && mmol < lowMmol)  return 'low';
      if (highMmol!=null && mmol > highMmol) return 'high';
      return 'ok';
    }

    // ===== Auth & initial load =====
    onAuthStateChanged(auth, async (user) => {
      if (!user) { location.href='index.html'; return; }
      if (!childId){ elName.textContent='Ù„Ù… ÙŠØªÙ… ØªÙ…Ø±ÙŠØ± Ø±Ù‚Ù… Ø§Ù„Ø·ÙÙ„ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.'; setAvatarFallback('',''); return; }

      $('#btnLogout').addEventListener('click', ()=> signOut(auth).then(()=>location.href='index.html'));

      const childRef = doc(db, 'users', user.uid, 'children', childId);
      const snap = await getDoc(childRef);
      if (!snap.exists()){ elName.textContent='Ø§Ù„Ø·ÙÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ â—'; setAvatarFallback('',''); return; }

      const c = snap.data();
      elName.textContent = c.name || 'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…';
      trySetPhoto(c);

      // Fill child info
      input('childName').value     = c.name || '';
      setGenderUI(c.gender || '');
      input('childCivilId').value  = c.childCivilId || '';
      input('dob').value           = c.dob || '';
      input('heightCm').value      = c.heightCm ?? '';
      input('weightKg').value      = c.weightKg ?? '';
      preferredUnit                = c.preferredUnit || 'mmol';
      input('preferredUnit').value = preferredUnit;
      input('defaultMeasurementType').value = c.defaultMeasurementType || 'fingerstick';
      input('notes').value         = c.notes || '';

      // Glucose config & dosing
      $('#unitBadge').textContent = `Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©: ${preferredUnit==='mgdl'?'mg/dL':'mmol/L'}`;
      $('#mUnitBadge').textContent= `Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©: ${preferredUnit==='mgdl'?'mg/dL':'mmol/L'}`;
      $('#isfUnitLabel').textContent = preferredUnit==='mgdl' ? 'mg/dL Ù„ÙƒÙ„ 1U' : 'mmol/L Ù„ÙƒÙ„ 1U';

      const gc = (c.glucoseConfig||{});
      const dos= (c.dosing||{});
      targetMmol = gc.targetGlucoseMmol ?? null;
      lowMmol    = gc.lowThresholdMmol ?? null;
      highMmol   = gc.highThresholdMmol ?? null;

      input('target').value = targetMmol==null ? '' : (preferredUnit==='mgdl'? Math.round(targetMmol/0.0555) : (+targetMmol).toFixed(1));
      input('low').value    = lowMmol==null ? ''    : (preferredUnit==='mgdl'? Math.round(lowMmol/0.0555)    : (+lowMmol).toFixed(1));
      input('high').value   = highMmol==null ? ''   : (preferredUnit==='mgdl'? Math.round(highMmol/0.0555)   : (+highMmol).toFixed(1));

      input('tresiba').value = dos.basalTresibaUnits ?? '';
      input('tdi').value     = dos.totalDailyInsulinUnits ?? '';
      const isfMmol = dos.isfMmolPerUnit ?? null;
      input('isf').value = preferredUnit==='mgdl'
        ? (isfMmol==null ? '' : Math.round(isfMmol/0.0555))
        : (isfMmol==null ? '' : (+isfMmol).toFixed(1));
      input('icr').value = dos.icrGramsPerUnit ?? '';
      icr = dos.icrGramsPerUnit ?? null;

      // Measurements defaults
      const today = new Date().toISOString().split('T')[0];
      input('dateSel').value = today;
      // Default type from child
      input('mType').value = c.defaultMeasurementType || 'fingerstick';

      bindInfoSavers(user.uid);
      bindMeasurementHandlers(user.uid);
      // Load today's readings
      await loadDay(user.uid);
    });

    // ===== Save Info & Glucose config =====
    function bindInfoSavers(uid){
      $('#btnSaveInfo').addEventListener('click', async ()=>{
        const payload = {
          name: input('childName').value.trim() || null,
          gender: getGenderUI(),
          childCivilId: input('childCivilId').value.trim() || null,
          dob: input('dob').value || null,
          heightCm: numOrNull(input('heightCm')),
          weightKg: numOrNull(input('weightKg')),
          preferredUnit: input('preferredUnit').value,
          defaultMeasurementType: input('defaultMeasurementType').value || 'fingerstick',
          notes: input('notes').value.trim() || null,
          storageUnit: "mmol",
          lastUpdatedAt: new Date().toISOString()
        };
        try{
          await setDoc(doc(db,'users',auth.currentUser.uid,'children',childId), payload, {merge:true});
          preferredUnit = payload.preferredUnit;
          $('#unitBadge').textContent = `Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©: ${preferredUnit==='mgdl'?'mg/dL':'mmol/L'}`;
          $('#mUnitBadge').textContent= `Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©: ${preferredUnit==='mgdl'?'mg/dL':'mmol/L'}`;
          $('#isfUnitLabel').textContent = preferredUnit==='mgdl'?'mg/dL Ù„ÙƒÙ„ 1U':'mmol/L Ù„ÙƒÙ„ 1U';
          elName.textContent = payload.name || elName.textContent;
          showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„');
        }catch(e){ console.error(e); showToast('â— Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸'); }
      });

      $('#btnSuggest').addEventListener('click', ()=>{
        const tdi = Number(input('tdi').value);
        if (!tdi || tdi <= 0) { showToast('Ø£Ø¯Ø®Ù„ÙŠ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ… Ø£ÙˆÙ„Ù‹Ø§'); return; }
        const isfMmol = +(100/tdi).toFixed(2);
        const icrVal  = +(500/tdi).toFixed(1);
        input('isf').value = (preferredUnit==='mgdl') ? Math.round(isfMmol/0.0555) : isfMmol;
        input('icr').value = icrVal;
        icr = icrVal;
        showToast('ğŸ’¡ ØªÙ… Ø§Ù‚ØªØ±Ø§Ø­ ISF Ùˆ ICR Ù…Ù† Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙŠÙˆÙ…');
      });

      $('#btnSaveGlucose').addEventListener('click', async ()=>{
        const tDisp = numOrNull(input('target'));
        const lDisp = numOrNull(input('low'));
        const hDisp = numOrNull(input('high'));
        const target = toMmol(tDisp);
        const low    = toMmol(lDisp);
        const high   = toMmol(hDisp);

        if (target!=null && low!=null && low >= target) { showToast('âš ï¸ Ø­Ø¯ Ø§Ù„Ù‡Ø¨ÙˆØ· ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù‡Ø¯Ù'); return; }
        if (target!=null && high!=null && high <= target){ showToast('âš ï¸ Ø­Ø¯ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† Ø§Ù„Ù‡Ø¯Ù'); return; }

        const isfDisp = numOrNull(input('isf'));
        const isfMmol = (preferredUnit==='mgdl')
          ? (isfDisp==null ? null : +(isfDisp*0.0555).toFixed(2))
          : (isfDisp==null ? null : +(+isfDisp).toFixed(2));

        const payload = {
          glucoseConfig: {
            targetGlucoseMmol: target,
            lowThresholdMmol : low,
            highThresholdMmol: high
          },
          dosing: {
            basalTresibaUnits      : numOrNull(input('tresiba')),
            totalDailyInsulinUnits : numOrNull(input('tdi')),
            isfMmolPerUnit         : isfMmol,
            icrGramsPerUnit        : numOrNull(input('icr'))
          },
          lastUpdatedAt: new Date().toISOString()
        };
        try{
          await setDoc(doc(db,'users',auth.currentUser.uid,'children',childId), payload, {merge:true});
          targetMmol = target; lowMmol = low; highMmol = high;
          icr = payload.dosing.icrGramsPerUnit ?? icr;
          showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø³ ÙˆØ§Ù„Ø¬Ø±Ø¹Ø§Øª');
        }catch(e){ console.error(e); showToast('â— Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸'); }
      });
    }

    // ===== Measurements (per day doc + slots) =====
    function bindMeasurementHandlers(uid){
      input('dateSel').addEventListener('change', ()=> loadDay(uid));
      $('#reloadDay').addEventListener('click', ()=> loadDay(uid));

      // Ø§Ù‚ØªØ±Ø§Ø­ Ø¬Ø±Ø¹Ø© Ù…Ù† ICR Ø¹Ù†Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒØ§Ø±Ø¨
      input('carbs').addEventListener('input', ()=>{
        const carbs = Number(input('carbs').value);
        if (icr && icr>0 && carbs>=0) input('suggestedDose').value = +(carbs/icr).toFixed(1);
        else input('suggestedDose').value = '';
      });

      // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØµØ­ÙŠØ­/Ø§Ù„Ø±ÙØ¹ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
      input('reading').addEventListener('input', onReadingChange);

      // Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³
      $('#saveBtn').addEventListener('click', ()=> onSave(uid));
    }

    function onReadingChange(){
      const valDisp = Number(input('reading').value);
      $('#correctionSection').style.display = 'none';
      $('#raiseSection').style.display      = 'none';
      $('#statusBadge').style.display       = 'none';

      if (!valDisp && valDisp !== 0) return;

      const mmol = toMmol(valDisp);
      const cls = classify(mmol);
      const sb = $('#statusBadge');
      sb.className = `status ${cls}`;
      sb.style.display = 'inline-block';
      sb.textContent = (cls==='low'?'Ù…Ù†Ø®ÙØ¶':cls==='high'?'Ù…Ø±ØªÙØ¹':'Ø·Ø¨ÙŠØ¹ÙŠ');

      if (cls==='high') $('#correctionSection').style.display = 'block';
      if (cls==='low')  $('#raiseSection').style.display = 'block';
    }

    async function loadDay(uid){
      const date = input('dateSel').value;
      if (!date) return;
      const ref = doc(db,'users',uid,'children',childId,'measurements',date);
      const snap = await getDoc(ref);
      const readings = (snap.data()||{}).readings || {};
      renderRows(readings);
    }

    function renderRows(readings){
      const tbody = $('#rows');
      const keys = Object.keys(readings);
      if (keys.length===0){ tbody.innerHTML = '<tr><td colspan="7" class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø¡Ø§Øª Ù„Ù„ÙŠÙˆÙ….</td></tr>'; return; }

      const labelSlot = {
        preBreakfast:'Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±', postBreakfast:'Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±',
        preLunch:'Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡', postLunch:'Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡',
        preDinner:'Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡', postDinner:'Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡',
        bedtime:'Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…', exercise:'Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠÙ†', other:'Ø£Ø®Ø±Ù‰'
      };

      tbody.innerHTML = '';
      for (const slot of keys){
        const r = readings[slot];
        const mmol = r?.valueMmol ?? (r?.value ?? null); // Ø¯Ø¹Ù… Ù„Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
        const disp = displayValue(mmol);
        const cls = classify(mmol);
        const statusHtml = `<span class="status ${cls}">${cls==='low'?'Ù…Ù†Ø®ÙØ¶':cls==='high'?'Ù…Ø±ØªÙØ¹':'Ø·Ø¨ÙŠØ¹ÙŠ'}</span>`;
        const typeLabel = r?.measurementType==='cgm'?'ğŸ“ˆ CGM': r?.measurementType==='lab'?'ğŸ§ª Ù…Ø®ØªØ¨Ø±': r?.measurementType==='other'?'âœ³ï¸ Ø£Ø®Ø±Ù‰':'ğŸ©¸ ÙØ­Øµ Ø¥ØµØ¨Ø¹';
        const action = (r?.mealDose ?? r?.correction ?? r?.raise ?? '-') ;
        const actionText = (r?.correction!=null) ? `ØªØµØ­ÙŠØ­: ${r.correction}U` : (r?.raise ? `Ø±ÙØ¹: ${r.raise}` : (r?.mealDose!=null? `${r.mealDose}U`:'-'));
        const note = r?.note || '-';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${labelSlot[slot]||slot}</td>
          <td>${disp} ${preferredUnit==='mgdl'?'mg/dL':'mmol/L'}</td>
          <td>${statusHtml}</td>
          <td>${r?.mealDose!=null ? r.mealDose : '-'}</td>
          <td>${actionText}</td>
          <td>${typeLabel}</td>
          <td>${escapeHtml(note)}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    async function onSave(uid){
      const date = input('dateSel').value;
      const slot = input('slotSel').value;
      const rawDisp = Number(input('reading').value);

      if (!date || !slot || !rawDisp) { showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„Ù‚ÙŠÙ…Ø©'); return; }

      const ref = doc(db,'users',uid,'children',childId,'measurements',date);
      const snap = await getDoc(ref);
      const base = snap.exists()? snap.data() : { readings:{} };

      if (base.readings[slot]?.valueMmol!=null || base.readings[slot]?.value!=null){
        showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª Ù…Ø³Ø¨Ù‚Ø§Ù‹'); return;
      }

      const mmol = toMmol(rawDisp);
      const payload = {
        valueMmol: +(+mmol).toFixed(2),                 // ØªØ®Ø²ÙŠÙ† Ø¨Ø§Ù„Ù€ mmol
        displayUnit: preferredUnit,                      // Ù„Ù„ÙˆØµÙ ÙÙ‚Ø·
        measurementType: input('mType').value || 'fingerstick',
        note: (input('note').value||'').trim() || null,
        carbs: numOrNull(input('carbs')),
        mealDose: numOrNull(input('mealDose')),
        correction: numOrNull(input('correction')),
        raise: (input('raise').value||'').trim() || null,
        // Ù„Ø²ÙˆÙ… Ø§Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):
        value: undefined
      };

      base.readings[slot] = payload;
      try{
        await setDoc(ref, base, {merge:true});
        showToast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³');
        await loadDay(uid);
      }catch(e){ console.error(e); showToast('â— ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³'); }
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
  </script>
</body>
</html>
