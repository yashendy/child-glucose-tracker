<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª â€” Ø¹Ø±Ø¶ Ø£ÙÙ‚ÙŠ (Ù…Ø¹ Ø±Ø¨Ø· Ø§Ù„ÙˆØ¬Ø¨Ø§Øª)</title>
<style>
:root{
  --brand:#0ea5e9;--brand2:#6ee7b7;--line:#e5e7eb;--ink:#0f172a;--muted:#6b7280;
  --bg:#f6fbff;--card:#fff;--ok:#16a34a;--low:#b45309;--high:#dc2626;
  --okbg:#ecfdf5;--lowbg:#fff7ed;--highbg:#fee2e2;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.55 system-ui,"Tajawal","Noto Sans Arabic",sans-serif}
header{position:sticky;top:0;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;padding:12px 14px;display:flex;justify-content:space-between;align-items:center;z-index:5}
header .btn{color:#fff;text-decoration:none;border:1px solid #ffffff66;padding:8px 12px;border-radius:10px;margin-inline-start:6px;background:#ffffff22}
main{max-width:1200px;margin:auto;padding:16px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:0 6px 24px rgba(0,0,0,.04);margin-bottom:12px}

/* ÙÙˆØ±Ù… Ø§Ù„ØªØ­ÙƒÙ… */
label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
input,select{width:100%;padding:9px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}
.grid{display:grid;gap:10px}
.g4{grid-template-columns:repeat(4,minmax(0,1fr))}
@media(max-width:900px){.g4{grid-template-columns:1fr 1fr}}

#childMeta{color:#0f172ab3;font-size:12px;margin-top:6px}

/* Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„ÙØ§Ø±Øº Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
.blank-header{display:flex;flex-wrap:wrap;gap:18px;row-gap:10px;margin:10px 0 12px;font-weight:700}
.blank-header .bh-item{display:inline-block;min-width:230px}
.blank-header .line{display:inline-block;border-bottom:1px dashed #9aa6b2;min-width:160px;height:1.2em;vertical-align:middle;margin-inline-start:8px}

/* Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
.table{width:100%;border-collapse:separate;border-spacing:0}
.table th,.table td{
  border:1px solid var(--line);
  padding:8px;
  vertical-align:top;
  text-align:right;
}
.table thead th{background:#f8fafc;font-weight:800;text-align:right}
.table td.date{background:#fbfdff;white-space:nowrap;font-weight:800}

.cell{display:flex;flex-direction:column;gap:3px}
.line{font-size:12px}
.state{padding:2px 8px;border-radius:999px;width:max-content;margin:0}
.state.ok{color:var(--ok);background:var(--okbg)}
.state.low{color:var(--low);background:var(--lowbg)}
.state.high{color:var(--high);background:var(--highbg)}
.note{color:var(--muted)}
.meal{font-size:12px;background:#fff7f0;border:1px solid #ffd1b2;color:#7c2d12;border-radius:8px;padding:3px 6px;width:max-content}

/* Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø¹Ù„ÙˆÙŠ Ù„Ù„ÙØªØ±Ø© */
.summary{display:flex;flex-wrap:wrap;gap:10px}
.summary .chip{background:#f1f5f9;border-radius:999px;padding:6px 10px;font-size:12px}

/* Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
@media print{
  @page{ size: A4 landscape; margin: 8mm }
  header,.controls{display:none!important}
  body{background:#fff;font-size:11px}
  .card{border:0;box-shadow:none;padding:0;margin:0}
  .table th,.table td{padding:4px}
  .line{font-size:10px}
}
</style>
</head>
<body>
<header>
  <div>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª (Ø£ÙÙ‚ÙŠ)</div>
  <div>
    <a class="btn" href="dashboard.html">Ø±Ø¬ÙˆØ¹</a>
    <button id="btnBlank" class="btn" type="button">Ø·Ø¨Ø§Ø¹Ø© ÙˆØ±Ù‚Ø© ÙØ§Ø±ØºØ©</button>
    <button id="btnPrint" class="btn" type="button">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
  </div>
</header>

<main>
  <section class="card controls">
    <div class="grid g4">
      <div>
        <label>Ø§Ù„Ø·ÙÙ„</label>
        <select id="childSel"><option value="">â€” Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„Ø·ÙÙ„ â€”</option></select>
      </div>
      <div>
        <label>Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
        <input id="from" type="date">
      </div>
      <div>
        <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
        <input id="to" type="date">
      </div>
      <div style="display:flex;align-items:end">
        <button id="run" style="width:100%;padding:10px;border:none;border-radius:10px;background:var(--brand);color:#fff;font-weight:800;cursor:pointer">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
      </div>
    </div>
    <div id="childMeta"></div>

    <!-- ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø·Ø¨Ø§Ø¹Ø© ÙˆØ±Ù‚Ø© ÙØ§Ø±ØºØ© -->
    <div id="blankHeader" class="blank-header" style="display:none"></div>
  </section>

  <!-- Ù…Ù„Ø®Øµ Ø¹Ù„ÙˆÙŠ Ù„Ù„ÙØªØ±Ø© -->
  <section id="summaryBox" class="card" style="display:none">
    <div class="summary" id="summaryChips"></div>
  </section>

  <section id="reportBox" class="card" style="display:none">
    <table id="rep" class="table"></table>
  </section>
</main>

<script type="module">
/* ---------- Firebase ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, getDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCOdrwdbw8b7YdWLPZ4TDdG2iS9kvvxQ7M",
  authDomain: "child-glucose-tracker.firebaseapp.com",
  projectId: "child-glucose-tracker",
  storageBucket: "child-glucose-tracker.firebasestorage.app",
  messagingSenderId: "294563325904",
  appId: "1:294563325904:web:39562550bf305fc01abbd5"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* ---------- Helpers ---------- */
const $=s=>document.querySelector(s);
const labels={
  uponWake:'Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸',
  preBreakfast:'Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±', postBreakfast:'Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±',
  preLunch:'Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡',     postLunch:'Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡',
  preDinner:'Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡',    postDinner:'Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡',
  beforeSleep:'Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…',   duringSleep:'Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…',
  beforeExercise:'Ù‚Ø¨Ù„ Ø§Ù„ØªÙ…Ø±ÙŠÙ†', afterExercise:'Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠÙ†',
  random:'Ù‚ÙŠØ§Ø³ Ø¹Ø´ÙˆØ§Ø¦ÙŠ',
  other:'Ø£Ø®Ø±Ù‰'
};
const order = [
  'uponWake',
  'preBreakfast','postBreakfast',
  'preLunch','postLunch',
  'preDinner','postDinner',
  'beforeSleep','duringSleep',
  'beforeExercise','afterExercise',
  'random','other'
];

let uid=null, initChildId=new URL(location.href).searchParams.get('child');

/* ---------- Auth ---------- */
onAuthStateChanged(auth, async (u)=>{
  if(!u){ location.href='index.html'; return; }
  uid=u.uid;
  await loadChildren();
  setDefaults();
  if(initChildId){
    const opt=[...$('#childSel').options].find(o=>o.value===initChildId);
    if(opt){ $('#childSel').value=initChildId; $('#childSel').disabled=true; }
  }
});

/* ---------- UI init ---------- */
function setDefaults(){
  const d=new Date(), iso=d.toISOString().slice(0,10);
  $('#from').value=iso; $('#to').value=iso;
}
async function loadChildren(){
  const sel=$('#childSel'); sel.innerHTML='<option value="">â€” ØªØ­Ù…ÙŠÙ„ â€”</option>';
  const q=await getDocs(collection(db,'users',uid,'children'));
  sel.innerHTML='<option value="">â€” Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„Ø·ÙÙ„ â€”</option>';
  q.forEach(s=>{
    const o=document.createElement('option'); o.value=s.id; o.textContent=s.data().name||'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'; sel.appendChild(o);
  });
}

/* ---------- Actions ---------- */
$('#btnPrint').addEventListener('click', ()=>window.print());
$('#run').addEventListener('click', buildReport);
$('#btnBlank').addEventListener('click', printBlankSheet);

/* Utilities */
const pad=n=>String(n).padStart(2,'0');
function enumerateDates(from,to){
  const res=[]; let d=new Date(from+"T00:00:00"); const end=new Date(to+"T00:00:00");
  while(d<=end){ res.push(`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`); d.setDate(d.getDate()+1); }
  return res;
}
function escapeHTML(str){ return (str||'').toString().replace(/[&<>"']/g,(c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

/* ØªØ­ÙˆÙŠÙ„Ø§Øª/ØªØµÙ†ÙŠÙ Ø­Ø³Ø¨ ÙˆØ­Ø¯Ø© Ø§Ù„Ø·ÙÙ„ ÙˆØ­Ø¯ÙˆØ¯Ù‡ */
function toMmolFromReading(r){
  if(r==null) return null;
  if(r.valueMmol!=null) return Number(r.valueMmol);
  if(r.value!=null){
    // Ù„Ùˆ ÙÙŠÙ‡ displayUnit Ù‚Ø¯ÙŠÙ…Ø©
    if(r.displayUnit==='mgdl') return Number(r.value)*0.0555;
    // Ø§Ø¹ØªØ¨Ø±Ù‡Ø§ mmol
    return Number(r.value);
  }
  return null;
}
function displayByUnit(mmol, preferredUnit){
  if(mmol==null) return 'â€”';
  return preferredUnit==='mgdl' ? String(Math.round(mmol/0.0555)) : (Number(mmol).toFixed(1));
}
function classify(mmol, lowMmol, highMmol){
  if(mmol==null || lowMmol==null || highMmol==null) return 'ok';
  if(mmol<lowMmol) return 'low';
  if(mmol>highMmol) return 'high';
  return 'ok';
}

/* Ø®Ø±Ø§Ø¦Ø· Ø±Ø¨Ø· Ø§Ù„ÙˆØ¬Ø¨Ø§Øª Ø¨Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© */
function mealTypeToSlot(mealType){
  switch(mealType){
    case 'breakfast': return 'postBreakfast';
    case 'lunch':     return 'postLunch';
    case 'dinner':    return 'postDinner';
    case 'snack':     return 'random';
    default:          return 'random';
  }
}

/* ---------- Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ---------- */
async function buildReport(){
  const childId=$('#childSel').value, from=$('#from').value, to=$('#to').value;
  if(!childId || !from || !to) return alert('Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„Ø·ÙÙ„ ÙˆØ­Ø¯Ø¯ÙŠ Ø§Ù„ÙØªØ±Ø©');

  // Ø£Ø®ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„ÙØ§Ø±Øº
  $('#blankHeader').style.display='none';

  // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„ (Ø§Ù„ÙˆØ­Ø¯Ø§Øª ÙˆØ§Ù„Ø­Ø¯ÙˆØ¯)
  const cs=await getDoc(doc(db,'users',uid,'children',childId));
  const c=cs.data()||{};
  const preferredUnit=(c.preferredUnit||'mmol')==='mgdl'?'mgdl':'mmol';
  const gc=c.glucoseConfig||{};
  const lowMmol = gc.lowThresholdMmol ?? null;
  const highMmol= gc.highThresholdMmol ?? null;
  const targetMmol = gc.targetGlucoseMmol ?? null;

  $('#childMeta').innerHTML = `
    <b>Ø§Ù„Ø·ÙÙ„:</b> ${escapeHTML(c.name||'â€”')}
    â€¢ <b>Ø§Ù„ÙˆØ²Ù†:</b> ${c.weightKg??c.weight??'â€”'} ÙƒØ¬Ù…
    â€¢ <b>Ø§Ù„Ø·ÙˆÙ„:</b> ${c.heightCm??c.height??'â€”'} Ø³Ù…
    â€¢ <b>Ø§Ù„Ø­Ø¯ÙˆØ¯:</b> Ù…Ù†Ø®ÙØ¶ &lt; ${lowMmol!=null? displayByUnit(lowMmol,preferredUnit):'â€”'} â€” Ù…Ø±ØªÙØ¹ &gt; ${highMmol!=null? displayByUnit(highMmol,preferredUnit):'â€”'}
    â€¢ <b>Ø§Ù„ÙˆØ­Ø¯Ø©:</b> ${preferredUnit==='mgdl'?'mg/dL':'mmol/L'}
  `;

  const dates = enumerateDates(from,to);

  // Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø£ÙŠØ§Ù…
  const measSnaps = await Promise.all(dates.map(d=>getDoc(doc(db,'users',uid,'children',childId,'measurements',d))));
  const byDate = {}; dates.forEach((d,i)=> byDate[d] = measSnaps[i].data() || { date:d, readings:{} });

  // ÙˆØ¬Ø¨Ø§Øª Ø§Ù„ÙØªØ±Ø© (Ø¬Ù„Ø¨ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙˆØªØ¬Ù…ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®)
  // Ù†Ø¬ÙŠØ¨ meals Ø­ÙŠØ« eatenAt Ø¨ÙŠÙ† fromT00:00 Ùˆ toT23:59
  const startIso = new Date(from+"T00:00:00").toISOString();
  const endIso   = new Date(to  +"T23:59:59").toISOString();
  let mealsByDateSlot = {};
  try{
    const qMeals = query(
      collection(db,'users',uid,'children',childId,'meals'),
      where('eatenAt','>=', startIso),
      where('eatenAt','<=', endIso),
      orderBy('eatenAt','asc')
    );
    const mSnap = await getDocs(qMeals);
    mSnap.forEach(ms=>{
      const m=ms.data();
      const d = (m.eatenAt||'').slice(0,10);
      const slot = mealTypeToSlot(m.mealType||'other');
      mealsByDateSlot[d] = mealsByDateSlot[d] || {};
      mealsByDateSlot[d][slot] = mealsByDateSlot[d][slot] || [];
      mealsByDateSlot[d][slot].push({
        totalCarbs: m.totalCarbs ?? null,
        bolusSuggested: m.bolusUnitsSuggested ?? null,
        bolusGiven: m.bolusUnitsGiven ?? null,
        note: m.notes || null
      });
    });
  }catch(e){
    console.warn('Meals query requires index if many conditions; fallback to no meals', e);
  }

  // Ø­Ø³Ø§Ø¨ Ù…Ù„Ø®Øµ Ø§Ù„ÙØªØ±Ø© (TIRØŒ Ù…ØªÙˆØ³Ø·ØŒ Ø£Ø¯Ù†Ù‰/Ø£Ø¹Ù„Ù‰ØŒ Ù…Ø¬Ù…ÙˆØ¹ ÙƒØ§Ø±Ø¨ ÙˆØ¬Ø¨Ø§ØªØŒ Ù…Ø¬Ù…ÙˆØ¹ Ø¬Ø±Ø¹Ø§Øª)
  const allReadingsMMOL=[];
  let cntLow=0, cntHigh=0, cntOk=0;
  let sumMealsCarb=0, sumBolusGiven=0, sumBolusSuggested=0;

  // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
  const tbl=$('#rep'); tbl.innerHTML='';
  const thead=document.createElement('thead');
  const htr=document.createElement('tr');
  const thDate=document.createElement('th'); thDate.textContent='Ø§Ù„ØªØ§Ø±ÙŠØ®'; htr.appendChild(thDate);
  order.forEach(slot=>{ const th=document.createElement('th'); th.textContent=labels[slot]; htr.appendChild(th); });
  thead.appendChild(htr); tbl.appendChild(thead);

  const tbody=document.createElement('tbody');

  dates.forEach(d=>{
    const tr=document.createElement('tr');
    const tdDate=document.createElement('td'); tdDate.className='date'; tdDate.textContent=d; tr.appendChild(tdDate);

    order.forEach(slot=>{
      const td=document.createElement('td');
      const r=(byDate[d].readings||{})[slot];

      // Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠØ§Ø³
      if(r && (r.valueMmol!=null || r.value!=null)){
        const mmol = toMmolFromReading(r);
        const disp = displayByUnit(mmol, preferredUnit);
        const cls  = classify(mmol, lowMmol, highMmol);
        // Ø¥Ø­ØµØ§Ø¡ Ø§Ù„Ù…Ù„Ø®Øµ
        if(mmol!=null){
          allReadingsMMOL.push(mmol);
          if(cls==='low') cntLow++; else if(cls==='high') cntHigh++; else cntOk++;
        }

        const mealDose = r.mealDose!=null ? `Ø¬Ø±Ø¹Ø©: ${r.mealDose}U` : '';
        const corr     = r.correction!=null ? `ØªØµØ­ÙŠØ­: ${r.correction}U` : '';
        const note     = r.note || r.raise || '';

        td.innerHTML = `
          <div class="cell">
            <div class="line"><b>Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©:</b> ${disp} ${preferredUnit==='mgdl'?'mg/dL':'mmol/L'}</div>
            ${corr?`<div class="line">${corr}</div>`:''}
            ${note?`<div class="line note">${escapeHTML(note)}</div>`:''}
            ${mealDose?`<div class="line note">${mealDose}</div>`:''}
            <div class="line state ${cls}">${cls==='low'?'â¬‡ï¸ Ù…Ù†Ø®ÙØ¶':cls==='high'?'â¬†ï¸ Ù…Ø±ØªÙØ¹':'âœ”ï¸ Ø·Ø¨ÙŠØ¹ÙŠ'}</div>
          </div>`;
      }else{
        td.textContent='â€”';
      }

      // Ø±Ø¨Ø· Ø§Ù„ÙˆØ¬Ø¨Ø§Øª (Ø¥Ù† ÙˆÙØ¬Ø¯Øª) Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…/Ø§Ù„Ø¹Ù…ÙˆØ¯
      const ms = (mealsByDateSlot[d]||{})[slot] || [];
      if(ms.length){
        // Ø¬Ù…Ø¹ Ø³Ø±ÙŠØ¹ Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„Ø®Ù„ÙŠØ©
        const carbsSum = ms.reduce((s,x)=> s+(x.totalCarbs||0), 0);
        const suggSum  = ms.reduce((s,x)=> s+(x.bolusSuggested||0), 0);
        const givenSum = ms.reduce((s,x)=> s+(x.bolusGiven||0), 0);
        sumMealsCarb += carbsSum;
        sumBolusSuggested += suggSum;
        sumBolusGiven += givenSum;

        const mealLine = document.createElement('div');
        mealLine.className = 'meal line';
        mealLine.textContent = `ğŸ½ ${carbsSum.toFixed(1)}g â€¢ Ù…Ù‚ØªØ±Ø­ ${suggSum? suggSum.toFixed(1):'â€”'}U â€¢ Ù…Ø¹Ø·Ù‰ ${givenSum? givenSum.toFixed(1):'â€”'}U`;
        td.appendChild(mealLine);
      }

      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });

  tbl.appendChild(tbody);

  // Ù…Ù„Ø®Øµ Ø§Ù„ÙØªØ±Ø©
  const total = cntLow+cntOk+cntHigh;
  const avgMmol = allReadingsMMOL.length ? (allReadingsMMOL.reduce((a,b)=>a+b,0)/allReadingsMMOL.length) : null;
  const minMmol = allReadingsMMOL.length ? Math.min(...allReadingsMMOL) : null;
  const maxMmol = allReadingsMMOL.length ? Math.max(...allReadingsMMOL) : null;
  const tir = total? Math.round((cntOk/total)*100) : null;

  const chips = $('#summaryChips'); chips.innerHTML='';
  chips.appendChild(chip(`TIR: ${tir!=null? tir+'%':'â€”'}`));
  chips.appendChild(chip(`Ù…ØªÙˆØ³Ø·: ${avgMmol!=null? displayByUnit(avgMmol,preferredUnit):'â€”'}`));
  chips.appendChild(chip(`Ø£Ø¯Ù†Ù‰: ${minMmol!=null? displayByUnit(minMmol,preferredUnit):'â€”'}`));
  chips.appendChild(chip(`Ø£Ø¹Ù„Ù‰: ${maxMmol!=null? displayByUnit(maxMmol,preferredUnit):'â€”'}`));
  chips.appendChild(chip(`Ù…Ù†Ø®ÙØ¶: ${cntLow}`));
  chips.appendChild(chip(`Ø·Ø¨ÙŠØ¹ÙŠ: ${cntOk}`));
  chips.appendChild(chip(`Ù…Ø±ØªÙØ¹: ${cntHigh}`));
  chips.appendChild(chip(`Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙƒØ§Ø±Ø¨ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª: ${sumMealsCarb.toFixed(1)}g`));
  chips.appendChild(chip(`Ø¬Ø±Ø¹Ø§Øª: Ù…Ù‚ØªØ±Ø­ ${sumBolusSuggested.toFixed(1)}U â€¢ ÙØ¹Ù„ÙŠ ${sumBolusGiven.toFixed(1)}U`));

  $('#summaryBox').style.display='block';
  $('#reportBox').style.display='block';

  function chip(text){
    const el=document.createElement('div'); el.className='chip'; el.textContent=text; return el;
  }
}

/* Ø·Ø¨Ø§Ø¹Ø© ÙˆØ±Ù‚Ø© ÙØ§Ø±ØºØ© */
async function printBlankSheet(){
  const childId=$('#childSel').value;
  if(!childId) return alert('Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„Ø·ÙÙ„ Ø£ÙˆÙ„Ø§Ù‹');

  const cs=await getDoc(doc(db,'users',uid,'children',childId));
  const c=cs.data()||{};
  const gc=c.glucoseConfig||{};
  const preferredUnit=(c.preferredUnit||'mmol')==='mgdl'?'mgdl':'mmol';
  const target=gc.targetGlucoseMmol!=null? displayByUnit(gc.targetGlucoseMmol,preferredUnit):'â€”';
  const isf = (c.dosing?.isfMmolPerUnit!=null)
    ? displayByUnit(c.dosing.isfMmolPerUnit, preferredUnit)
    : 'â€”';
  const icr = c.dosing?.icrGramsPerUnit ?? 'â€”';

  $('#childMeta').innerHTML='';
  const bh = $('#blankHeader');
  bh.innerHTML = `
    <span class="bh-item">Ø§Ù„Ø§Ø³Ù…:<span class="line"></span></span>
    <span class="bh-item">Ø§Ù„ÙˆØ²Ù†:<span class="line"></span></span>
    <span class="bh-item">Ø§Ù„Ø·ÙˆÙ„:<span class="line"></span></span>
    <span class="bh-item">Target:<span class="line"> ${target} </span></span>
    <span class="bh-item">ISF:<span class="line"> ${isf} /U </span></span>
    <span class="bh-item">ICR:<span class="line"> ${icr} g/U </span></span>
  `;
  bh.style.display='flex';

  const tbl=$('#rep'); tbl.innerHTML='';
  const thead=document.createElement('thead');
  const htr=document.createElement('tr');
  const thDate=document.createElement('th'); thDate.textContent='Ø§Ù„ØªØ§Ø±ÙŠØ®'; htr.appendChild(thDate);
  order.forEach(slot=>{ const th=document.createElement('th'); th.textContent=labels[slot]; htr.appendChild(th); });
  thead.appendChild(htr); tbl.appendChild(thead);

  const tbody=document.createElement('tbody');
  for(let i=0;i<7;i++){
    const tr=document.createElement('tr');
    const tdDate=document.createElement('td'); tdDate.className='date'; tdDate.innerHTML='&nbsp;'; tr.appendChild(tdDate);
    order.forEach(()=>{ 
      const td=document.createElement('td');
      td.innerHTML=`
        <div class="cell">
          <div class="line">Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©: ________</div>
          <div class="line">Ø¬Ø±Ø¹Ø© Ø§Ù„ØªØµØ­ÙŠØ­ÙŠ: ________</div>
          <div class="line">Ù…Ù„Ø§Ø­Ø¸Ø§Øª: __________________________</div>
          <div class="line">Ø§Ù„Ø­Ø§Ù„Ø©: ________</div>
          <div class="line">ğŸ½ ÙƒØ§Ø±Ø¨: ________ Ø¬Ù… â€¢ Ø¬Ø±Ø¹Ø©: ________U</div>
        </div>`;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  }
  tbl.appendChild(tbody);

  $('#summaryBox').style.display='none';
  $('#reportBox').style.display='block';
  setTimeout(()=>window.print(), 50);
}
</script>
</body>
</html>
