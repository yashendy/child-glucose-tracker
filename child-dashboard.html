<!-- child-dashboard.html — العنصر (1+2/7): الهيدر + صورة الطفل + قسم بيانات الطفل -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>لوحة الطفل — متابعة سكر الأطفال</title>

  <style>
    :root{
      --brand:#0ea5e9; --brand2:#6ee7b7; --line:#e5e7eb;
      --ink:#0f172a; --muted:#6b7280; --bg:#f6fbff; --card:#fff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.6 "Tajawal",system-ui,sans-serif}

    /* الهيدر */
    header{
      position:sticky; top:0; z-index:10;
      background:linear-gradient(90deg,var(--brand),var(--brand2));
      color:#fff; padding:12px 16px;
      display:flex; align-items:center; justify-content:space-between;
    }
    .head-left{display:flex; align-items:center; gap:12px}
    .kid-photo{
      width:56px; height:56px; border-radius:16px; overflow:hidden;
      border:2px solid rgba(255,255,255,.75); background:#fff;
      display:grid; place-items:center;
    }
    .kid-photo img{width:100%; height:100%; object-fit:cover; display:block}
    .avatar-fallback{
      width:100%; height:100%; display:none; place-items:center;
      background:#e0f7fa; color:#0f172a; font-weight:800; font-size:18px;
    }
    .title-wrap{display:flex; flex-direction:column}
    .hello{font-size:14px; opacity:.9}
    .kid-name{font-size:18px; font-weight:800}

    .head-actions{display:flex; gap:8px; flex-wrap:wrap}
    .btn{border:none; border-radius:10px; padding:8px 12px; font-weight:800; cursor:pointer}
    .btn.gray{background:#eef2f7}
    .btn.dark{background:#0f172a; color:#fff}
    .btn.primary{background:var(--brand); color:#fff}

    /* الصفحة */
    main{max-width:1200px; margin:auto; padding:16px}
    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:16px; box-shadow:0 2px 10px rgba(0,0,0,.05); margin-bottom:14px}
    .note{color:var(--muted); font-size:14px}

    /* شبكة الفورم */
    .grid{display:grid; gap:12px}
    .g2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width: 900px){ .g3{grid-template-columns:1fr 1fr} }
    @media (max-width: 680px){ .g2,.g3{grid-template-columns:1fr} }

    label{display:block; color:var(--muted); font-size:13px; margin-bottom:6px}
    input,select{width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#fff}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .field{display:flex; flex-direction:column}

    .radio-wrap{display:flex; gap:14px; align-items:center}
    .radio-wrap label{margin:0; font-size:14px; color:var(--ink)}
    .section-title{margin:0 0 10px; font-size:18px}

    /* Toast */
    .toast{position:fixed; bottom:16px; left:16px; background:#111; color:#fff; padding:10px 14px; border-radius:12px; opacity:0; transform:translateY(6px); transition:.25s}
    .toast.show{opacity:1; transform:none}
  </style>
</head>
<body>

  <!-- الهيدر: صورة الطفل + الترحيب -->
  <header>
    <div class="head-left">
      <div class="kid-photo">
        <img id="childPhoto" alt="صورة الطفل">
        <div id="avatarFallback" class="avatar-fallback">👧</div>
      </div>
      <div class="title-wrap">
        <div class="hello">مرحبًا 👋</div>
        <div id="kidName" class="kid-name">جاري تحميل الاسم...</div>
      </div>
    </div>
    <div class="head-actions">
      <a class="btn gray" href="dashboard.html">لوحة وليّ الأمر</a>
      <button id="btnSaveInfo" class="btn primary">💾 حفظ بيانات الطفل</button>
      <button id="btnLogout" class="btn dark">خروج</button>
    </div>
  </header>

  <main>
    <!-- (2) قسم بيانات الطفل -->
    <section class="card" id="childInfoSection">
      <h3 class="section-title">⚙️ بيانات الطفل</h3>
      <div class="grid g3">
        <div class="field">
          <label for="childName">اسم الطفل</label>
          <input id="childName" placeholder="مثال: ليلى أحمد">
        </div>

        <div class="field">
          <label>النوع</label>
          <div class="radio-wrap">
            <label><input type="radio" name="gender" value="male"> ذكر</label>
            <label><input type="radio" name="gender" value="female"> أنثى</label>
          </div>
        </div>

        <div class="field">
          <label for="childCivilId">الرقم المدني</label>
          <input id="childCivilId" placeholder="اختياري">
        </div>

        <div class="field">
          <label for="dob">تاريخ الميلاد</label>
          <input id="dob" type="date">
        </div>

        <div class="field">
          <label for="heightCm">الطول (سم)</label>
          <input id="heightCm" type="number" step="0.1" placeholder="مثال: 125">
        </div>

        <div class="field">
          <label for="weightKg">الوزن (كجم)</label>
          <input id="weightKg" type="number" step="0.1" placeholder="مثال: 26.4">
        </div>

        <div class="field">
          <label for="preferredUnit">الوحدة المفضلة للعرض</label>
          <select id="preferredUnit">
            <option value="mmol">mmol/L</option>
            <option value="mgdl">mg/dL</option>
          </select>
        </div>

        <div class="field" style="grid-column:1/-1">
          <label for="notes">ملاحظات</label>
          <input id="notes" placeholder="حساسية، تعليمات خاصة، إلخ (اختياري)">
        </div>
      </div>
      <div class="note" style="margin-top:8px">* سيتم استخدام هذه البيانات في جميع الأقسام التالية (القياسات، الجرعات، التقارير…)</div>
    </section>

    <!-- حامل لباقي الأقسام التي سنضيفها لاحقًا -->
    <section class="card">
      <div class="note">سنُضيف في الخطوة التالية “إعدادات القياس والجرعات (الحدود/المفاتيح + ISF + ICR + ترسيبا…)”.</div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

  <script type="module">
    import { db, auth } from './firebase-init.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // عناصر DOM
    const elName   = document.getElementById('kidName');
    const img      = document.getElementById('childPhoto');
    const fallback = document.getElementById('avatarFallback');
    const toastEl  = document.getElementById('toast');

    const input = id => document.getElementById(id);
    const genderRadios = () => [...document.querySelectorAll('input[name="gender"]')];

    const btnSaveInfo = document.getElementById('btnSaveInfo');
    const btnLogout   = document.getElementById('btnLogout');

    // childId من الرابط
    const params  = new URLSearchParams(location.search);
    const childId = params.get('child');

    // Helpers
    const slugify = s => (s||'').trim().toLowerCase()
                          .replace(/\s+/g,'-')
                          .replace(/[^\u0600-\u06FF\w-]/g,'');

    const showToast = (msg) => {
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      setTimeout(()=> toastEl.classList.remove('show'), 2200);
    };

    const setAvatarFallback = (name, gender) => {
      const initials = (name||'').trim().split(/\s+/).slice(0,2).map(w=>w[0]||'').join('').toUpperCase();
      fallback.textContent = initials || (gender==='male' ? '👦' : '👧');
      fallback.style.display = 'grid';
    };

    const trySetPhoto = (child) => {
      const byId   = `/images/${childId}.jpg`;
      const byName = `/images/${slugify(child.name||'')}.jpg`;
      const test = (srcs, i=0) => {
        if (i >= srcs.length) { img.style.display='none'; setAvatarFallback(child.name, child.gender); return; }
        img.onload = () => { img.style.display='block'; fallback.style.display='none'; };
        img.onerror= () => test(srcs, i+1);
        img.src = srcs[i];
      };
      test([byId, byName]);
    };

    const setGenderUI = (value) => genderRadios().forEach(r => r.checked = (r.value === value));
    const getGenderUI = () => (genderRadios().find(r => r.checked)?.value || null);

    const numOrNull = (el) => {
      const v = el.value;
      if (v === '' || v == null) return null;
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    };

    // تحميل بيانات الطفل
    onAuthStateChanged(auth, async (user) => {
      if (!user) { location.href = 'index.html'; return; }
      if (!childId) { elName.textContent = 'لم يتم تمرير رقم الطفل في الرابط.'; setAvatarFallback('',''); return; }

      try {
        const childRef = doc(db, 'users', user.uid, 'children', childId);
        const snap = await getDoc(childRef);

        if (!snap.exists()) {
          elName.textContent = 'الطفل غير موجود ❗';
          setAvatarFallback('', '');
          return;
        }

        const c = snap.data();
        elName.textContent = c.name || 'بدون اسم';
        trySetPhoto(c);

        // تعبئة النموذج
        input('childName').value     = c.name || '';
        setGenderUI(c.gender || '');
        input('childCivilId').value  = c.childCivilId || '';
        input('dob').value           = c.dob || '';
        input('heightCm').value      = c.heightCm ?? '';
        input('weightKg').value      = c.weightKg ?? '';
        input('preferredUnit').value = c.preferredUnit || 'mmol';
        input('notes').value         = c.notes || '';

      } catch (err) {
        console.error(err);
        elName.textContent = 'حدث خطأ أثناء تحميل البيانات';
        setAvatarFallback('', '');
      }
    });

    // حفظ بيانات الطفل (Merge)
    btnSaveInfo.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user || !childId) return;

      const payload = {
        name: input('childName').value.trim() || null,
        gender: getGenderUI(),
        childCivilId: input('childCivilId').value.trim() || null,
        dob: input('dob').value || null,
        heightCm: numOrNull(input('heightCm')),
        weightKg: numOrNull(input('weightKg')),
        preferredUnit: input('preferredUnit').value, // "mmol" | "mgdl"
        notes: input('notes').value.trim() || null,

        // قيم ثابتة لضمان توحيد الحسابات لاحقًا
        storageUnit: "mmol", // سنخزن الحسابات المرجعية دائمًا بالـ mmol
        lastUpdatedAt: new Date().toISOString()
      };

      try {
        await setDoc(doc(db, 'users', user.uid, 'children', childId), payload, { merge: true });
        elName.textContent = payload.name || elName.textContent;
        showToast('✅ تم حفظ بيانات الطفل');
      } catch (e) {
        console.error(e);
        showToast('❗ حدث خطأ أثناء الحفظ');
      }
    });

    // خروج
    btnLogout.addEventListener('click', () => {
      signOut(auth).then(()=> location.href='index.html');
    });
  </script>
</body>
</html>
