<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>لوحة الطفل</title>
<style>
:root{
  --brand:#0ea5e9; --brand2:#6ee7b7; --line:#e5e7eb; --ink:#0f172a; --muted:#6b7280;
  --bg:#f6fbff; --card:#fff;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.6 system-ui,"Tajawal","Noto Sans Arabic",sans-serif}
a{text-decoration:none;color:inherit}
label{display:block;color:var(--muted);font-size:13px;margin-bottom:4px}
input,select,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}
.row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.btn{border:none;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
.btn.primary{background:var(--brand);color:#fff}
.btn.gray{background:#eef2f7}
.btn.red{background:#fee2e2;color:#b91c1c}
.note{color:var(--muted);font-size:13px}
.sep{height:1px;background:var(--line);margin:10px 0}

.grid{display:grid;gap:10px}
.g2{grid-template-columns:repeat(2,minmax(0,1fr))}
.g3{grid-template-columns:repeat(3,minmax(0,1fr))}
@media(max-width:900px){.g2,.g3{grid-template-columns:1fr}}

/* Header */
.topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;
  padding:10px 14px;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;position:sticky;top:0;z-index:10}
.topbar .btn{background:#ffffff22;border:1px solid #ffffff66;color:#fff}

/* Layout */
.container{max-width:1100px;margin:auto;padding:14px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 6px 24px rgba(0,0,0,.04);margin-bottom:12px}

/* child header */
.child-head{display:flex;align-items:center;justify-content:space-between;gap:14px;flex-wrap:wrap}
.kid{display:flex;align-items:center;gap:12px}
.avatar{width:64px;height:64px;border-radius:50%;object-fit:cover;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.12)}
.kid .name{font-weight:800}
.badge{display:inline-block;background:#eef6ff;color:#0369a1;padding:6px 10px;border-radius:999px;font-weight:800}

/* upload progress */
#uploadProg{height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden;display:none;width:260px}
#uploadProg span{display:block;height:100%;background:linear-gradient(90deg,#22c55e,#06b6d4);width:0%}

/* ===== [المرحلة 3] الوجبات (CSS) ===== */
.meals-wrap{display:grid;grid-template-columns:240px 1fr;gap:12px}
@media(max-width:900px){.meals-wrap{grid-template-columns:1fr}}
.cats{display:flex;flex-direction:column;gap:8px}
.cat-btn{border:none;border-radius:12px;padding:10px;background:#ffffff;cursor:pointer;text-align:right;
  box-shadow:0 1px 6px rgba(0,0,0,.06);border:1px solid var(--line);font-weight:800}
.cat-btn.active,.cat-btn:hover{background:#e6f7ff;border-color:#b3e5ff}
.foods-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
.food{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.04)}
.food img{width:80px;height:80px;object-fit:contain}
.food .name{font-weight:800;margin-top:6px}
.food .carb{color:#0f766e;font-weight:700;font-size:13px}
.food .row{justify-content:center}
.badge-soft{display:inline-block;background:#eef6ff;color:#0369a1;border-radius:999px;padding:4px 8px;font-weight:800;font-size:12px}

.basket table{width:100%;border-collapse:separate;border-spacing:0}
.basket th,.basket td{border:1px solid var(--line);padding:8px;text-align:center}
.basket thead th{background:#f0f9ff}
.input-mini{width:84px}

/* ===== [المرحلة 4] قياسات السكر ===== */
.table{width:100%;border-collapse:separate;border-spacing:0}
.table th,.table td{border:1px solid var(--line);padding:8px;text-align:right;vertical-align:top}
.table thead th{background:#f0f9ff;font-weight:800}
.center{text-align:center}
.state{display:inline-block;padding:2px 8px;border-radius:999px}
.state.ok{background:#ecfdf5;color:#16a34a}
.state.low{background:#fff7ed;color:#b45309}
.state.high{background:#fee2e2;color:#dc2626}

/* ===== [المرحلة 5] التقارير للطبيب ===== */
.table-report{width:100%;border-collapse:collapse}
.table-report th,.table-report td{border:1px solid var(--line);padding:6px;text-align:center;vertical-align:top}
.table-report thead th{background:#f1f5f9;font-weight:800}
.report-meta{font-size:13px;margin-bottom:8px;color:var(--muted)}
.pdf-container{page-break-after:always;padding:10mm;background:#fff;color:#000}
.state-icon{font-weight:bold}
.state-icon.low{color:#b45309}
.state-icon.high{color:#dc2626}
.state-icon.ok{color:#16a34a}
@media print {
  body{background:#fff;color:#000}
  header,.no-print{display:none!important}
  .pdf-container{page-break-after:always}
}

/* ===== [المرحلة 6] الزيارات الطبية ===== */
.visits-form .grid{display:grid;gap:10px}
.visits-form .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
@media(max-width:900px){.visits-form .g3{grid-template-columns:1fr}}
.table-visits{width:100%;border-collapse:separate;border-spacing:0}
.table-visits th,.table-visits td{border:1px solid var(--line);padding:8px;text-align:right;vertical-align:top}
.table-visits thead th{background:#f0f9ff;font-weight:800}
.chips{display:flex;gap:6px;flex-wrap:wrap}
.chip{display:inline-flex;align-items:center;gap:6px;background:#eef6ff;color:#0369a1;border-radius:999px;padding:4px 8px;font-weight:800;font-size:12px}
.actions .btn{padding:6px 10px}
.print-visit{display:none;background:#fff;color:#000;padding:12px;border:1px dashed var(--line);margin-top:10px}
.print-visit h4{margin:0 0 6px}
@media print{
  header,.no-print,.container > :not(#visitPrintArea){display:none!important}
  #visitPrintArea{display:block!important}
}

/* ===== [المرحلة 7] تحسينات واجهة عامة ===== */
.badge-kpi{display:inline-block;background:#ecfeff;color:#075985;border:1px solid #bae6fd;
  padding:6px 10px;border-radius:999px;font-weight:800;font-size:12px}
.loader{display:none;position:fixed;inset:0;background:rgba(255,255,255,.6);z-index:9999;
  align-items:center;justify-content:center}
.loader .dot{width:10px;height:10px;border-radius:50%;margin:0 4px;background:#0ea5e9;animation:b 0.9s infinite alternate}
.loader .dot:nth-child(2){animation-delay:.15s}.loader .dot:nth-child(3){animation-delay:.3s}
@keyframes b{to{transform:translateY(-6px);background:#06b6d4}}
.toast{position:fixed;bottom:16px;left:16px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transform:translateY(8px);transition:.3s;z-index:99999}
.toast.show{opacity:1;transform:none}
@media print{ .badge-kpi{border:none} }
</style>
</head>
<body>

<!-- ===== الهيدر ===== -->
<header class="topbar">
  <div class="row">
    <a class="btn" href="dashboard.html">لوحة وليّ الأمر</a>
    <button id="btnLogout" class="btn" type="button">خروج</button>
  </div>
  <div id="hello" class="row">مرحبًا…</div>
</header>

<!-- ===== المحتوى ===== -->
<main class="container">

  <!-- ===== بيانات الطفل ===== -->
  <section class="card child-head" id="headCard" style="display:none">
    <div class="kid">
      <img id="kidAvatar" class="avatar" src="images/avatar-default.png" alt="صورة الطفل">
      <div>
        <div class="name" id="kidName">—</div>
        <div class="note" id="kidMeta">—</div>
      </div>
    </div>
    <span class="badge" id="unitBadge">الوحدة: mmol/L</span>
  </section>

  <section class="card" id="infoCard" style="display:none">
    <h3 style="margin:0 0 10px">🧒 بيانات الطفل</h3>
    <div class="grid g2">
      <div>
        <label>الاسم</label>
        <input id="cName">
      </div>
      <div>
        <label>النوع</label>
        <select id="cGender">
          <option value="ذكر">ذكر</option>
          <option value="أنثى">أنثى</option>
        </select>
      </div>
      <div>
        <label>الرقم المدني</label>
        <input id="cCivilId">
      </div>
      <div>
        <label>تاريخ الميلاد</label>
        <input id="cBirth" type="date">
      </div>
      <div>
        <label>الوزن (كجم)</label>
        <input id="cWeight" type="number" step="0.1">
      </div>
      <div>
        <label>الطول (سم)</label>
        <input id="cHeight" type="number" step="0.1">
      </div>
    </div>

    <div class="sep"></div>

    <h4>⚙️ إعدادات السكر</h4>
    <div class="grid g2">
      <div>
        <label>الوحدة المفضلة</label>
        <select id="cUnit">
          <option value="mmol/L">mmol/L</option>
          <option value="mg/dL">mg/dL</option>
        </select>
      </div>
      <div>
        <label>القياس الأمثل</label>
        <input id="cTarget" type="number" step="0.1">
      </div>
      <div>
        <label>حد الهبوط</label>
        <input id="cLow" type="number" step="0.1">
      </div>
      <div>
        <label>حد الارتفاع</label>
        <input id="cHigh" type="number" step="0.1">
      </div>
    </div>

    <div class="sep"></div>

    <h4>💉 جرعات</h4>
    <div class="grid g3">
      <div>
        <label>جرعة الترسيبا</label>
        <input id="cTresiba" type="number" step="0.1">
      </div>
      <div>
        <label>جرعة الأنسولين اليومية</label>
        <input id="cTotalInsulin" type="number" step="0.1">
      </div>
      <div>
        <label>معامل التصحيح</label>
        <input id="cCorrectionFactor" type="number" step="0.1">
      </div>
      <div>
        <label>ICR (جم كارب/وحدة)</label>
        <input id="cICR" type="number" step="0.1">
      </div>
    </div>

    <div class="sep"></div>

    <h4>📷 صورة الطفل</h4>
    <div class="row">
      <input type="file" id="cPhoto" accept="image/*">
      <div id="uploadProg"><span></span></div>
    </div>

    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button id="saveInfo" class="btn primary">💾 حفظ البيانات</button>
    </div>
  </section>

  <!-- ===== الوجبات ===== -->
  <section class="card" id="mealsCard" style="display:none">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">🍽️ الوجبات</h3>
      <div class="row">
        <span class="badge-soft">ICR الحالي: <b id="icrNow">—</b> g/U</span>
      </div>
    </div>

    <!-- إعداد الوجبة -->
    <div class="grid g3" style="margin:10px 0">
      <div>
        <label>نوع الوجبة</label>
        <select id="mealType">
          <option value="breakfast">فطور</option>
          <option value="lunch">غداء</option>
          <option value="dinner">عشاء</option>
          <option value="snack">سناك</option>
          <option value="other">أخرى</option>
        </select>
      </div>
      <div>
        <label>وقت الأكل</label>
        <input id="mealTime" type="datetime-local">
      </div>
      <div>
        <label>ملاحظة</label>
        <input id="mealNote" placeholder="اختياري">
      </div>
    </div>

    <div class="meals-wrap">
      <!-- التصنيفات + البحث -->
      <div>
        <input id="foodSearch" placeholder="ابحث عن صنف..." style="width:100%;margin-bottom:8px">
        <div id="catList" class="cats"><button class="cat-btn active" data-cat="*">كل الأصناف</button></div>
      </div>

      <!-- شبكة الأصناف + السلة -->
      <div>
        <div id="foodsGrid" class="foods-grid"><div class="note">جاري التحميل...</div></div>

        <div class="card" style="margin-top:12px">
          <div class="row" style="justify-content:space-between">
            <h4 style="margin:0">🧺 سلة الوجبة</h4>
            <div class="badge-soft">إجمالي الكارب: <b id="totalCarbs">0.0</b> جم</div>
          </div>
          <div class="basket" style="margin-top:8px; overflow:auto">
            <table>
              <thead><tr><th>الصنف</th><th>الوحدة</th><th>الكمية</th><th>الكارب (جم)</th><th>إجراء</th></tr></thead>
              <tbody id="basketBody"><tr><td colspan="5" class="note">لا توجد عناصر بعد.</td></tr></tbody>
              <tfoot>
                <tr><td colspan="3"><b>الإجمالي</b></td><td id="totalCarbsCell">0.0</td><td></td></tr>
              </tfoot>
            </table>
          </div>

          <div class="grid g3" style="margin-top:10px">
            <div>
              <label>الجرعة المقترحة</label>
              <input id="doseSuggestedMeal" readonly>
            </div>
            <div>
              <label>جرعة فعلية (اختياري)</label>
              <input id="doseGivenMeal" type="number" step="0.1">
            </div>
            <div class="row" style="align-items:flex-end; justify-content:flex-end">
              <button id="saveMealBtn" class="btn primary">💾 حفظ الوجبة</button>
            </div>
          </div>

          <div class="note">الحساب: الكارب = (جرام الوحدة × الكمية × كارب/100g) ÷ 100 — الجرعة = إجمالي الكارب ÷ ICR (تقريب 0.1U).</div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== قياسات السكر ===== -->
  <section class="card" id="measuresCard" style="display:none">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">🧪 تسجيل القياسات</h3>
      <span class="badge-soft">الوحدة: <b id="mUnitBadge">mmol/L</b></span>
    </div>

    <div class="grid g3" style="margin:10px 0">
      <div>
        <label>التاريخ</label>
        <input id="mDate" type="date">
      </div>
      <div>
        <label>وقت القياس</label>
        <select id="mSlot">
          <option value="">— اختاري —</option>
          <option value="uponWake">الاستيقاظ</option>
          <option value="preBreakfast">قبل الإفطار</option>
          <option value="postBreakfast">بعد الإفطار</option>
          <option value="preLunch">قبل الغداء</option>
          <option value="postLunch">بعد الغداء</option>
          <option value="preDinner">قبل العشاء</option>
          <option value="postDinner">بعد العشاء</option>
          <option value="beforeSleep">قبل النوم</option>
          <option value="duringSleep">أثناء النوم</option>
          <option value="beforeExercise">قبل التمرين</option>
          <option value="afterExercise">بعد التمرين</option>
          <option value="random">قياس عشوائي</option>
          <option value="other">أخرى</option>
        </select>
      </div>
      <div>
        <label>القراءة (mmol/L)</label>
        <input id="mValue" type="number" step="0.1" min="0">
      </div>

      <div>
        <label>كارب (جم)</label>
        <input id="mCarbs" type="number" step="0.1" min="0">
      </div>
      <div>
        <label>جرعة مقترحة (ICR)</label>
        <input id="mDoseSuggested" readonly>
      </div>
      <div>
        <label>جرعة فعلية</label>
        <input id="mDoseGiven" type="number" step="0.1" min="0">
      </div>

      <div>
        <label>جرعة تصحيحية</label>
        <input id="mCorrection" type="number" step="0.1" min="0">
      </div>
      <div>
        <label>رفع السكر (إن لزم)</label>
        <input id="mRaisedWith" placeholder="عصير/تمر...">
      </div>
      <div>
        <label>ملاحظة</label>
        <input id="mNote" placeholder="اختياري">
      </div>
    </div>

    <div class="row" style="justify-content:flex-end">
      <button id="mSave" class="btn primary">💾 حفظ القياس</button>
    </div>
  </section>

  <section class="card" id="measuresToday" style="display:none">
    <h4 style="margin:0 0 6px">📅 قراءات اليوم</h4>
    <div class="note">يتم التقريب لأقرب 0.1 (مثال: 7.8)</div>
    <table class="table">
      <thead>
        <tr>
          <th>الوقت</th>
          <th>القراءة</th>
          <th>الحالة</th>
          <th>جرعات</th>
          <th>ملاحظات</th>
        </tr>
      </thead>
      <tbody id="mRows">
        <tr><td colspan="5" class="note center">لا توجد قياسات.</td></tr>
      </tbody>
    </table>
  </section>

  <!-- ===== تقارير الطبيب ===== -->
  <section class="card" id="doctorReports" style="display:none">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">📊 تقرير الطبيب</h3>
      <div>
        <button id="btnReportPDF" class="btn primary">📄 طباعة PDF</button>
        <button id="btnReportBlank" class="btn">📝 تقرير فارغ (7 أيام)</button>
      </div>
    </div>
    <div class="report-meta" id="reportMeta">—</div>
    <div id="reportTableWrap">
      <table class="table-report" id="reportTable">
        <thead>
          <tr>
            <th>التاريخ</th>
            <th>الاستيقاظ</th>
            <th>قبل الإفطار</th><th>بعد الإفطار</th>
            <th>قبل الغداء</th><th>بعد الغداء</th>
            <th>قبل العشاء</th><th>بعد العشاء</th>
            <th>قبل النوم</th><th>أثناء النوم</th>
          </tr>
        </thead>
        <tbody id="reportRows">
          <tr><td colspan="10" class="note">لا توجد بيانات بعد.</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <!-- ===== الزيارات الطبية ===== -->
  <section class="card" id="visitsCard" style="display:none">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">📅 الزيارات الطبية</h3>
      <div class="row no-print">
        <button id="btnVisitNew" class="btn">➕ زيارة جديدة</button>
      </div>
    </div>

    <!-- نموذج الزيارة -->
    <div class="visits-form" id="visitFormBox" style="display:none; margin-top:8px">
      <h4 style="margin:0 0 6px">إضافة / تعديل زيارة</h4>
      <div class="grid g3">
        <div>
          <label>تاريخ الزيارة</label>
          <input id="vDate" type="date">
        </div>
        <div>
          <label>اسم الطبيب</label>
          <input id="vDoctor" placeholder="مثال: د. أحمد علي">
        </div>
        <div>
          <label>العيادة / المستشفى</label>
          <input id="vClinic" placeholder="مثال: مستشفى الأطفال">
        </div>
        <div style="grid-column:1/-1">
          <label>السبب / الشكوى</label>
          <input id="vReason" placeholder="صداع / ضبط جرعات / متابعة دورية ...">
        </div>
        <div style="grid-column:1/-1">
          <label>ملاحظات</label>
          <textarea id="vNotes" rows="2" placeholder="ملاحظات الطبيب/التوصيات"></textarea>
        </div>
        <div style="grid-column:1/-1">
          <label>مرفقات (صور أو PDF) — اختياري</label>
          <input id="vFiles" type="file" accept="image/*,application/pdf" multiple>
          <div class="note">يتم رفع المرفقات بعد حفظ الزيارة مباشرة.</div>
        </div>
      </div>
      <div class="row" style="justify-content:flex-end; margin-top:8px">
        <button id="btnVisitSave" class="btn primary">💾 حفظ الزيارة</button>
        <button id="btnVisitCancel" class="btn gray">إلغاء</button>
      </div>
    </div>

    <!-- قائمة الزيارات -->
    <div style="margin-top:10px">
      <table class="table-visits">
        <thead>
          <tr>
            <th>التاريخ</th>
            <th>الطبيب</th>
            <th>العيادة</th>
            <th>السبب</th>
            <th>مرفقات</th>
            <th class="no-print">إجراءات</th>
          </tr>
        </thead>
        <tbody id="visitsRows">
          <tr><td colspan="6" class="note">لا توجد زيارات بعد.</td></tr>
        </tbody>
      </table>
    </div>

    <!-- مساحة طباعة زيارة واحدة -->
    <div id="visitPrintArea" class="print-visit">
      <h4>🧑‍⚕️ ملخص زيارة طبية</h4>
      <div id="printBody"></div>
    </div>
  </section>

</main>

<!-- عناصر مساعدة عامة -->
<div id="loader" class="loader" aria-hidden="true"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- ===== سكربت Firebase ===== -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import {
  getFirestore, doc, getDoc, setDoc,
  collection, getDocs, query, where, orderBy,
  addDoc, updateDoc, deleteDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyCOdrwdbw8b7YdWLPZ4TDdG2iS9kvvxQ7M",
  authDomain: "child-glucose-tracker.firebaseapp.com",
  projectId: "child-glucose-tracker",
  storageBucket: "child-glucose-tracker.firebasestorage.app",
  messagingSenderId: "294563325904",
  appId: "1:294563325904:web:39562550bf305fc01abbd5"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

/* حالة عامة */
let uid=null, childId=null, child=null;

/* أدوات عامة */
function showToast(msg, ms=2200){
  const t=document.getElementById('toast'); if(!t) return alert(msg);
  t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), ms);
}
function showLoader(on=true){
  const x=document.getElementById('loader'); if(!x) return;
  x.style.display = on? 'flex' : 'none';
  x.setAttribute('aria-hidden', on? 'false':'true');
}
function round1(n){ const v = Math.round(Number(n)*10)/10; return Number.isFinite(v)? v : null; }
function toFixed1(n){ const v = round1(n); return v==null? '' : v.toFixed(1); }
function todayISO(){ return new Date().toISOString().slice(0,10); }
function localDT(value){ const d=value?new Date(value):new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,16); }
function escapeHTML(str){ return String(str||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

/* تسجيل الدخول */
onAuthStateChanged(auth, async (user)=>{
  if(!user){ location.href='index.html'; return; }
  uid=user.uid;
  const params = new URLSearchParams(location.search);
  childId = params.get('child');
  if(!childId){ alert('لم يتم تحديد الطفل'); return; }
  await bootDashboard();
});

/* تحميل بيانات الطفل */
async function loadChild(){
  const snap = await getDoc(doc(db,'users',uid,'children',childId));
  if(!snap.exists()){ alert('الطفل غير موجود'); return; }
  child = snap.data();

  // هيدر
  document.getElementById('kidName').textContent = child.name || '—';
  const gender = child.gender||'';
  const wt = child.weight!=null? `${child.weight}كجم`:'—';
  const ht = child.height!=null? `${child.height}سم`:'—';
  document.getElementById('kidMeta').textContent = `${gender} • ${wt} • ${ht}`;
  document.getElementById('unitBadge').textContent = `الوحدة: ${child.unit||'mmol/L'}`;
  if(child.photoURL) document.getElementById('kidAvatar').src = child.photoURL;
  document.getElementById('headCard').style.display='flex';
  document.getElementById('infoCard').style.display='block';

  // تعبئة النموذج
  document.getElementById('cName').value  = child.name||'';
  document.getElementById('cGender').value= child.gender||'ذكر';
  document.getElementById('cCivilId').value = child.childCivilId||'';
  document.getElementById('cBirth').value   = child.birthDate||'';
  document.getElementById('cWeight').value  = child.weight??'';
  document.getElementById('cHeight').value  = child.height??'';
  document.getElementById('cUnit').value    = child.unit||'mmol/L';
  document.getElementById('cTarget').value  = child.target??'';
  document.getElementById('cLow').value     = child.lowThreshold??'';
  document.getElementById('cHigh').value    = child.highThreshold??'';
  document.getElementById('cTresiba').value = child.tresibaDose??'';
  document.getElementById('cTotalInsulin').value = child.totalInsulin??'';
  document.getElementById('cCorrectionFactor').value = child.correctionFactor??'';
  document.getElementById('cICR').value = child.icr??'';
}

/* حفظ بيانات الطفل */
document.getElementById('saveInfo').addEventListener('click', async ()=>{
  const data = {
    name: document.getElementById('cName').value.trim()||null,
    gender: document.getElementById('cGender').value||null,
    childCivilId: document.getElementById('cCivilId').value.trim()||null,
    birthDate: document.getElementById('cBirth').value||null,
    weight: document.getElementById('cWeight').value? Number(document.getElementById('cWeight').value) : null,
    height: document.getElementById('cHeight').value? Number(document.getElementById('cHeight').value) : null,
    unit: document.getElementById('cUnit').value||'mmol/L',
    target: document.getElementById('cTarget').value? Number(document.getElementById('cTarget').value) : null,
    lowThreshold: document.getElementById('cLow').value? Number(document.getElementById('cLow').value) : null,
    highThreshold: document.getElementById('cHigh').value? Number(document.getElementById('cHigh').value) : null,
    tresibaDose: document.getElementById('cTresiba').value? Number(document.getElementById('cTresiba').value) : null,
    totalInsulin: document.getElementById('cTotalInsulin').value? Number(document.getElementById('cTotalInsulin').value) : null,
    correctionFactor: document.getElementById('cCorrectionFactor').value? Number(document.getElementById('cCorrectionFactor').value) : null,
    icr: document.getElementById('cICR').value? Number(document.getElementById('cICR').value) : null,
    photoURL: child.photoURL || null,
    updatedAt: serverTimestamp()
  };
  await setDoc(doc(db,'users',uid,'children',childId), data, {merge:true});
  showToast('تم حفظ البيانات ✅');
  await loadChild();
});

/* رفع صورة الطفل */
document.getElementById('cPhoto').addEventListener('change', async (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  const progBar = document.getElementById('uploadProg');
  const progFill = progBar.querySelector('span');
  progBar.style.display='block';
  const storageRef = ref(storage, `child-photos/${uid}/${childId}-${Date.now()}-${file.name.replace(/[^\w.\-]+/g,'_')}`);
  const uploadTask = uploadBytesResumable(storageRef, file);
  uploadTask.on('state_changed',
    (snap)=>{ const p = (snap.bytesTransferred / snap.totalBytes) * 100; progFill.style.width = p + '%'; },
    (err)=>{ alert('فشل رفع الصورة: ' + err.message); progBar.style.display='none'; },
    async ()=>{
      const url = await getDownloadURL(uploadTask.snapshot.ref);
      child.photoURL = url;
      await setDoc(doc(db,'users',uid,'children',childId), {photoURL:url, updatedAt:serverTimestamp()}, {merge:true});
      document.getElementById('kidAvatar').src = url;
      progBar.style.display='none';
      showToast('تم رفع الصورة 📷');
    }
  );
});

/* ===== الوجبات (JS) ===== */
let foodsAll = [];
let foodsFiltered = [];
let basket = [];
let currentCategory = '*';

async function initMealsSection(){
  document.getElementById('mealsCard').style.display='block';
  // ICR
  const icrVal = Number(child.icr)||0;
  document.getElementById('icrNow').textContent = icrVal ? icrVal : '—';
  // وقت افتراضي الآن
  document.getElementById('mealTime').value = localDT();

  await loadFoods();
  buildCategories();
  renderFoods();

  document.getElementById('foodSearch').addEventListener('input', renderFoods);
  document.getElementById('saveMealBtn').addEventListener('click', saveMeal);
}

async function loadFoods(){
  foodsAll = [];
  const qs = await getDocs(collection(db,'foods'));
  qs.forEach(s=>{
    const d = s.data();
    if(d.isActive===false) return;
    foodsAll.push({
      id: s.id,
      name: d.name || 'بدون اسم',
      category: d.category || 'أخرى',
      carbsPer100g: Number(d.carbsPer100g)||0,
      imageUrl: d.imageUrl || 'https://cdn-icons-png.flaticon.com/512/1046/1046784.png',
      servingUnits: Array.isArray(d.servingUnits) && d.servingUnits.length
        ? d.servingUnits
        : [{unit:'جرام', grams:100}]
    });
  });
}

function buildCategories(){
  const set = new Set(['*']); foodsAll.forEach(f=>set.add(f.category||'أخرى'));
  const catList = document.getElementById('catList'); catList.innerHTML='';
  [...set].forEach(cat=>{
    const btn=document.createElement('button');
    btn.className='cat-btn'+(cat===currentCategory?' active':'');
    btn.textContent=(cat==='*'?'كل الأصناف':cat);
    btn.dataset.cat=cat;
    btn.addEventListener('click', ()=>{
      currentCategory=cat;
      [...catList.querySelectorAll('.cat-btn')].forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      renderFoods();
    });
    catList.appendChild(btn);
  });
}

function renderFoods(){
  const grid = document.getElementById('foodsGrid'); grid.innerHTML='';
  const q = (document.getElementById('foodSearch').value||'').trim().toLowerCase();
  foodsFiltered = foodsAll.filter(f=>{
    const byCat = (currentCategory==='*' || f.category===currentCategory);
    const byText = !q || f.name.toLowerCase().includes(q);
    return byCat && byText;
  });
  if(!foodsFiltered.length){ grid.innerHTML='<div class="note">لا توجد أصناف مطابقة.</div>'; return; }

  foodsFiltered.forEach(f=>{
    const card=document.createElement('div'); card.className='food';
    const unitOptions = f.servingUnits.map(u=>`<option value="${u.grams}">${u.unit} (${u.grams} جم)</option>`).join('');
    card.innerHTML=`
      <img src="${f.imageUrl}" alt="${escapeHTML(f.name)}">
      <div class="name">${escapeHTML(f.name)}</div>
      <div class="carb">كارب / 100جم: <b>${f.carbsPer100g}</b></div>
      <div class="row" style="margin-top:6px">
        <select class="unitSel">${unitOptions}</select>
        <input class="qty input-mini" type="number" min="0.1" step="0.1" value="1">
      </div>
      <div class="row" style="justify-content:space-between;margin-top:8px">
        <button class="btn gray addBtn">➕ أضف</button>
        <span class="badge-soft">${escapeHTML(f.category)}</span>
      </div>
    `;
    const unitSel = card.querySelector('.unitSel');
    const qtyInp  = card.querySelector('.qty');
    card.querySelector('.addBtn').addEventListener('click', ()=>{
      const gramsPerUnit = Number(unitSel.value)||100;
      const qty = Number(qtyInp.value)||0;
      if(qty<=0) return alert('أدخلي كمية صحيحة');

      const totalCarbs = +((gramsPerUnit * qty * f.carbsPer100g)/100).toFixed(1);
      basket.push({
        foodId: f.id, name: f.name,
        unit: findUnitName(f.servingUnits, gramsPerUnit),
        gramsPerUnit, qty, carbsPer100g: f.carbsPer100g,
        totalCarbs
      });
      renderBasket();
    });
    grid.appendChild(card);
  });
}

function findUnitName(units, grams){
  const u=(units||[]).find(x=>Number(x.grams)===Number(grams));
  return u? `${u.unit} (${u.grams}جم)` : `جرام (${grams})`;
}

function renderBasket(){
  const tbody=document.getElementById('basketBody');
  if(!basket.length){
    tbody.innerHTML='<tr><td colspan="5" class="note">لا توجد عناصر بعد.</td></tr>';
    document.getElementById('totalCarbs').textContent='0.0';
    document.getElementById('totalCarbsCell').textContent='0.0';
    document.getElementById('doseSuggestedMeal').value='';
    return;
  }
  tbody.innerHTML='';
  let total=0;

  basket.forEach((it,idx)=>{
    total+=it.totalCarbs;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${escapeHTML(it.name)}</td>
      <td>${escapeHTML(it.unit)}</td>
      <td><input class="input-mini qtyRow" type="number" min="0.1" step="0.1" value="${it.qty}"></td>
      <td class="carbCell">${it.totalCarbs.toFixed(1)}</td>
      <td><button class="btn gray rmBtn">🗑️ حذف</button></td>
    `;
    tr.querySelector('.qtyRow').addEventListener('input', (e)=>{
      const q=Number(e.target.value)||0;
      it.qty=q;
      it.totalCarbs=+((it.gramsPerUnit*q*it.carbsPer100g)/100).toFixed(1);
      tr.querySelector('.carbCell').textContent=it.totalCarbs.toFixed(1);
      recomputeTotals();
    });
    tr.querySelector('.rmBtn').addEventListener('click', ()=>{ basket.splice(idx,1); renderBasket(); });
    tbody.appendChild(tr);
  });

  document.getElementById('totalCarbs').textContent=total.toFixed(1);
  document.getElementById('totalCarbsCell').textContent=total.toFixed(1);

  const icrVal=Number(child.icr)||0;
  document.getElementById('doseSuggestedMeal').value = (icrVal>0 && total>0)? (Math.round((total/icrVal)*10)/10).toFixed(1) : '';
}

function recomputeTotals(){
  let total=0; basket.forEach(it=> total+=it.totalCarbs);
  document.getElementById('totalCarbs').textContent=total.toFixed(1);
  document.getElementById('totalCarbsCell').textContent=total.toFixed(1);
  const icrVal=Number(child.icr)||0;
  document.getElementById('doseSuggestedMeal').value=(icrVal>0 && total>0)? (Math.round((total/icrVal)*10)/10).toFixed(1) : '';
}

async function saveMeal(){
  if(!basket.length) return alert('السلة فارغة');
  const dateLocal=document.getElementById('mealTime').value;
  if(!dateLocal) return alert('اختاري وقت الأكل');

  const totalCarbs = +basket.reduce((a,b)=>a+b.totalCarbs,0).toFixed(1);
  const suggested = document.getElementById('doseSuggestedMeal').value ? Number(document.getElementById('doseSuggestedMeal').value) : null;
  const given     = document.getElementById('doseGivenMeal').value ? Number(document.getElementById('doseGivenMeal').value) : null;

  const payload={
    type: document.getElementById('mealType').value,
    time: dateLocal,
    note: document.getElementById('mealNote').value||null,
    icrUsed: Number(child.icr)||null,
    totalCarbs, doseSuggested: suggested, doseGiven: given,
    items: basket,
    createdAt: serverTimestamp()
  };

  const id = `${Date.now()}`;
  await setDoc(doc(db,'users',uid,'children',childId,'meals',id), payload);
  showToast('✅ تم حفظ الوجبة');
  basket=[]; renderBasket();
  document.getElementById('mealType').value='breakfast';
}

/* ===== القياسات (JS) ===== */
const mLabels = {
  uponWake:'الاستيقاظ',
  preBreakfast:'قبل الإفطار', postBreakfast:'بعد الإفطار',
  preLunch:'قبل الغداء',      postLunch:'بعد الغداء',
  preDinner:'قبل العشاء',     postDinner:'بعد العشاء',
  beforeSleep:'قبل النوم',    duringSleep:'أثناء النوم',
  beforeExercise:'قبل التمرين', afterExercise:'بعد التمرين',
  random:'قياس عشوائي', other:'أخرى'
};
const mOrder = ['uponWake','preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep','beforeExercise','afterExercise','random','other'];

function stateBy(v, low, high){
  if(v==null || isNaN(v)) return 'ok';
  if(isFinite(low)  && v<low)  return 'low';
  if(isFinite(high) && v>high) return 'high';
  return 'ok';
}
function extractReadings(d){
  if(!d) return {};
  if(d.readings) return d.readings;
  const o={}; Object.keys(d).forEach(k=>{ if(mOrder.includes(k)) o[k]=d[k]; });
  return o;
}

async function initMeasuresSection(){
  document.getElementById('measuresCard').style.display='block';
  document.getElementById('measuresToday').style.display='block';
  document.getElementById('mUnitBadge').textContent = 'mmol/L';
  const mDate=document.getElementById('mDate');
  mDate.value=todayISO();
  mDate.addEventListener('change', loadDay);

  const recomputeDose = ()=>{
    const carbs=Number(document.getElementById('mCarbs').value)||0;
    const icr=Number(child?.icr)||0;
    document.getElementById('mDoseSuggested').value = (icr>0 && carbs>0) ? round1(carbs/icr).toFixed(1) : '';
  };
  document.getElementById('mCarbs').addEventListener('input', recomputeDose);
  document.getElementById('mSave').addEventListener('click', saveMeasure);

  await loadDay();
}

async function loadDay(){
  const date=document.getElementById('mDate').value;
  const ref=doc(db,'users',uid,'children',childId,'measurements',date);
  const snap=await getDoc(ref);
  const data=snap.data()||{};
  const readings=extractReadings(data);
  const low=Number(child?.lowThreshold);
  const high=Number(child?.highThreshold);

  const tbody=document.getElementById('mRows'); let html='';
  mOrder.forEach(key=>{
    const r=readings[key];
    if(!r || (r.valueMmol==null && r.value==null)) return;
    const v=round1(Number(r.valueMmol ?? r.value));
    const st=stateBy(v, low, high);
    const doses=[
      (r.mealDose!=null ? `وجبة: ${r.mealDose}U` : ''),
      (r.correctionGiven!=null ? `تصحيح: ${r.correctionGiven}U` : '')
    ].filter(Boolean).join(' • ') || '—';
    const note=r.note || r.raisedWith || '—';
    html += `
      <tr>
        <td><b>${mLabels[key]}</b></td>
        <td>${toFixed1(v)} mmol/L</td>
        <td><span class="state ${st}">${st==='low'?'منخفض':st==='high'?'مرتفع':'طبيعي'}</span></td>
        <td>${doses}</td>
        <td>${escapeHTML(note)}</td>
      </tr>`;
  });
  tbody.innerHTML = html || `<tr><td colspan="5" class="note center">لا توجد قياسات.</td></tr>`;
}

async function saveMeasure(){
  const date=document.getElementById('mDate').value.trim();
  const slot=document.getElementById('mSlot').value;
  const val=round1(Number(document.getElementById('mValue').value||0));
  if(!date || !slot){ alert('اختاري التاريخ ووقت القياس'); return; }
  if(!(val>0)){ alert('اكتبي قراءة صحيحة'); return; }

  const carbs = document.getElementById('mCarbs').value? Number(document.getElementById('mCarbs').value) : null;
  const mealDose = document.getElementById('mDoseGiven').value? Number(document.getElementById('mDoseGiven').value) : null;
  const corr     = document.getElementById('mCorrection').value? Number(document.getElementById('mCorrection').value) : null;
  const raised   = document.getElementById('mRaisedWith').value || null;
  const note     = document.getElementById('mNote').value || null;

  const low  = Number(child?.lowThreshold);
  const high = Number(child?.highThreshold);
  const st   = stateBy(val, low, high);

  const ref=doc(db,'users',uid,'children',childId,'measurements',date);
  const snap=await getDoc(ref);
  const base=snap.data()||{ date, readings:{} };
  if(!base.readings) base.readings={};
  base.readings[slot] = {
    valueMmol: val, status: st,
    carbs, mealDose, correctionGiven: corr,
    raisedWith: raised, note
  };
  await setDoc(ref, base, {merge:true});
  showToast('✅ تم حفظ القياس');
  await loadDay();
}

/* ===== تقارير الطبيب ===== */
async function initDoctorReports(){
  document.getElementById('doctorReports').style.display='block';
  await buildDoctorReport();
}
async function buildDoctorReport(){
  if(!childId) return;
  const from = todayISO();
  const to   = todayISO();

  document.getElementById('reportMeta').textContent =
    `الاسم: ${child?.name||'—'} • الرقم المدني: ${child?.childCivilId||'—'} • الوزن: ${child?.weight||'—'} كجم • الطول: ${child?.height||'—'} سم • الفترة: ${from} → ${to} • الوحدة: mmol/L`;

  const qy = query(
    collection(db,'users',uid,'children',childId,'measurements'),
    where('date','>=',from), where('date','<=',to),
    orderBy('date','asc')
  );
  const snap = await getDocs(qy);
  const rows=[];
  snap.forEach(docSnap=>{
    const d=docSnap.data(); const readings=d.readings||{};
    const row=[d.date];
    ['uponWake','preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep'].forEach(slot=>{
      const r=readings[slot];
      if(r && r.valueMmol!=null){
        const st=stateBy(r.valueMmol, child?.lowThreshold, child?.highThreshold);
        const icon= st==='low'?'⬇️': st==='high'?'⬆️':'🟢';
        row.push(`${r.valueMmol.toFixed(1)} ${icon}${r.note?'<br><small>'+escapeHTML(r.note)+'</small>':''}`);
      }else{ row.push('—'); }
    });
    rows.push(row);
  });

  const tbody=document.getElementById('reportRows');
  tbody.innerHTML = rows.length
    ? rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('')
    : `<tr><td colspan="10" class="note">لا توجد بيانات.</td></tr>`;
}

document.getElementById('btnReportPDF').addEventListener('click', ()=>window.print());
document.getElementById('btnReportBlank').addEventListener('click', ()=>{
  const today=new Date();
  const days=Array.from({length:7},(_,i)=>{const d=new Date(today); d.setDate(today.getDate()+i); return d.toISOString().slice(0,10);});
  const blankRows = days.map(date=>`<tr><td>${date}</td>${Array(9).fill('<td>—</td>').join('')}</tr>`).join('');
  document.getElementById('reportRows').innerHTML=blankRows;
});

/* ===== الزيارات الطبية ===== */
let editVisitId=null;

async function initVisitsSection(){
  document.getElementById('visitsCard').style.display='block';
  bindVisitFormUI();
  await loadVisits();
}
function bindVisitFormUI(){
  const btnNew=document.getElementById('btnVisitNew');
  const box=document.getElementById('visitFormBox');
  document.getElementById('btnVisitCancel').addEventListener('click', ()=>{ box.style.display='none'; clearVisitForm(); editVisitId=null; });
  btnNew.addEventListener('click', ()=>{
    clearVisitForm(); editVisitId=null;
    document.getElementById('vDate').value = todayISO();
    box.style.display='block';
  });
  document.getElementById('btnVisitSave').addEventListener('click', saveVisit);
}
function clearVisitForm(){
  ['vDate','vDoctor','vClinic','vReason','vNotes'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('vFiles').value='';
}
async function loadVisits(){
  const tbody=document.getElementById('visitsRows');
  const qy=query(collection(db,'users',uid,'children',childId,'visits'), orderBy('date','desc'));
  const qs=await getDocs(qy);
  if(qs.empty){ tbody.innerHTML='<tr><td colspan="6" class="note">لا توجد زيارات بعد.</td></tr>'; return; }
  const rows=[];
  qs.forEach(s=>{
    const v=s.data(); const files=Array.isArray(v.files)? v.files : [];
    rows.push(`
      <tr>
        <td><b>${escapeHTML(v.date||'—')}</b></td>
        <td>${escapeHTML(v.doctor||'—')}</td>
        <td>${escapeHTML(v.clinic||'—')}</td>
        <td>${escapeHTML(v.reason||'—')}</td>
        <td>${files.length? files.map(f=>`<span class="chip" title="${escapeHTML(f.name)}">${f.type?.startsWith('image/')?'🖼️':'📄'} ${escapeHTML(short(f.name))}</span>`).join(' ') : '—'}</td>
        <td class="actions no-print">
          <button class="btn gray" data-act="view" data-id="${s.id}">👁️ عرض/طباعة</button>
          <button class="btn gray" data-act="edit" data-id="${s.id}">✏️ تعديل</button>
          <button class="btn red"  data-act="del"  data-id="${s.id}">🗑️ حذف</button>
        </td>
      </tr>`);
  });
  tbody.innerHTML=rows.join('');
  tbody.querySelectorAll('button[data-act]').forEach(btn=>{
    const id=btn.dataset.id, act=btn.dataset.act;
    btn.addEventListener('click', ()=>{ if(act==='view') viewVisit(id); else if(act==='edit') editVisit(id); else if(act==='del') delVisit(id); });
  });
}
async function saveVisit(){
  const date=document.getElementById('vDate').value;
  const doctor=document.getElementById('vDoctor').value.trim();
  const clinic=document.getElementById('vClinic').value.trim();
  const reason=document.getElementById('vReason').value.trim();
  const notes=document.getElementById('vNotes').value.trim();
  const files=document.getElementById('vFiles').files;
  if(!date){ alert('أدخلي تاريخ الزيارة'); return; }

  const base={ date, doctor:doctor||null, clinic:clinic||null, reason:reason||null, notes:notes||null, updatedAt:serverTimestamp() };
  let vid=editVisitId;
  if(!vid){
    const docRef=await addDoc(collection(db,'users',uid,'children',childId,'visits'), { ...base, createdAt:serverTimestamp(), files:[] });
    vid=docRef.id;
  }else{
    await updateDoc(doc(db,'users',uid,'children',childId,'visits',vid), base);
  }

  if(files && files.length){
    const uploaded=await uploadVisitFiles(vid, files);
    if(uploaded.length){
      const refV=doc(db,'users',uid,'children',childId,'visits',vid);
      const snap=await getDoc(refV);
      const cur=snap.data()||{};
      const curFiles=Array.isArray(cur.files)? cur.files : [];
      await updateDoc(refV, { files: curFiles.concat(uploaded) });
    }
  }
  showToast('✅ تم حفظ الزيارة');
  document.getElementById('visitFormBox').style.display='none';
  clearVisitForm(); editVisitId=null;
  await loadVisits();
}
async function uploadVisitFiles(visitId, fileList){
  const arr=Array.from(fileList||[]), out=[];
  for(const f of arr){
    const path=`users/${uid}/children/${childId}/visits/${visitId}/files/${Date.now()}_${(f.name||'file').replace(/[^\w.\-]+/g,'_')}`;
    const r=ref(storage, path);
    const task=uploadBytesResumable(r, f, {contentType:f.type});
    await new Promise((res,rej)=>{ task.on('state_changed', ()=>{}, rej, res); });
    const url=await getDownloadURL(task.snapshot.ref);
    out.push({ name:f.name, url, type:f.type, size:f.size });
  }
  return out;
}
async function viewVisit(id){
  const refV=doc(db,'users',uid,'children',childId,'visits',id);
  const snap=await getDoc(refV); if(!snap.exists()){ alert('الزيارة غير موجودة'); return; }
  const v=snap.data(); const files=Array.isArray(v.files)? v.files : [];
  const meta = `
    <div><b>الطفل:</b> ${escapeHTML(child?.name||'—')}</div>
    <div><b>التاريخ:</b> ${escapeHTML(v.date||'—')}</div>
    <div><b>الطبيب:</b> ${escapeHTML(v.doctor||'—')}</div>
    <div><b>العيادة:</b> ${escapeHTML(v.clinic||'—')}</div>
    <div><b>السبب:</b> ${escapeHTML(v.reason||'—')}</div>
    <div><b>ملاحظات:</b> ${escapeHTML(v.notes||'—')}</div>
    <div><b>مرفقات:</b> ${files.length? files.map(f=>`<div>• ${f.type?.startsWith('image/')?'🖼️':'📄'} <a href="${f.url}" target="_blank">${escapeHTML(f.name)}</a></div>`).join('') : '—'}</div>
  `;
  document.getElementById('printBody').innerHTML=meta;
  document.getElementById('visitPrintArea').style.display='block';
  window.print();
}
async function editVisit(id){
  const refV=doc(db,'users',uid,'children',childId,'visits',id);
  const snap=await getDoc(refV); if(!snap.exists()){ alert('الزيارة غير موجودة'); return; }
  const v=snap.data(); editVisitId=id;
  document.getElementById('vDate').value=v.date||'';
  document.getElementById('vDoctor').value=v.doctor||'';
  document.getElementById('vClinic').value=v.clinic||'';
  document.getElementById('vReason').value=v.reason||'';
  document.getElementById('vNotes').value=v.notes||'';
  document.getElementById('visitFormBox').style.display='block';
}
async function delVisit(id){
  if(!confirm('هل تريدين حذف هذه الزيارة؟')) return;
  await deleteDoc(doc(db,'users',uid,'children',childId,'visits',id));
  await loadVisits();
}
function short(n){ return (n&&n.length>18)? (n.slice(0,16)+'…') : (n||'ملف'); }

/* تشغيل اللوحة */
document.getElementById('btnLogout')?.addEventListener('click', ()=>{ signOut(auth).then(()=> location.href='index.html'); });

async function bootDashboard(){
  try{
    showLoader(true);
    await loadChild();
    await initMealsSection();
    await initMeasuresSection();
    await initDoctorReports();
    await initVisitsSection();
    showToast('✨ اللوحة جاهزة للاستخدام');
  }catch(err){
    console.error(err);
    alert('حدث خطأ عند تهيئة اللوحة');
  }finally{
    showLoader(false);
  }
}

/* أخطاء عامة */
window.addEventListener('error', (e)=>{ console.error('GlobalError:', e.message); showToast('⚠️ حدث خطأ غير متوقع'); });
window.addEventListener('unhandledrejection', (e)=>{ console.error('UnhandledRejection:', e.reason); showToast('⚠️ تعذّر تنفيذ العملية'); });

</script>
</body>
</html>
