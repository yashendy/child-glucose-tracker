<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠØ¨ â€” ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    :root{
      --line:#e5e7eb; --muted:#6b7280; --ok:#16a34a; --low:#b45309; --high:#dc2626;
      --okbg:#ecfdf5; --lowbg:#fff7ed; --highbg:#fee2e2;
    }
    /* Ù„Ù…Ø³Ø§Øª Ø®ÙÙŠÙØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© */
    .state{display:inline-block;padding:2px 8px;border-radius:999px}
    .state.ok{background:var(--okbg);color:var(--ok)}
    .state.low{background:var(--lowbg);color:var(--low)}
    .state.high{background:var(--highbg);color:var(--high)}
    .small{font-size:12px;color:var(--muted)}
    .table{width:100%;border-collapse:separate;border-spacing:0}
    .table th,.table td{border:1px solid var(--line);padding:8px;text-align:right;vertical-align:top}
    .table thead th{background:#f1f5f9;font-weight:800}
    .table td.date{background:#fbfdff;white-space:nowrap;font-weight:800}
    .cell{display:flex;flex-direction:column;gap:4px}
    .icon-plate{font-size:14px}
    .kpi{display:grid;gap:10px;grid-template-columns:repeat(7,minmax(0,1fr))}
    .kpi .box{background:#f8fafc;border:1px solid var(--line);border-radius:12px;padding:10px}
    .kpi .v{font-weight:800}
    .chart-box{position:relative;width:260px;max-width:100%}
    .tir-center{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;font-weight:800}
    .tir-big{font-size:22px}
    .tir-small{font-size:11px;color:#475569}
    @media print{
      @page{size:A4;margin:10mm}
      header,.no-print{display:none!important}
      body{background:#fff}
      .card{border:0;box-shadow:none;margin:0 0 8px;padding:0}
      .chart-box{width:220px}
      .table th,.table td{padding:6px}
    }
  </style>
</head>
<body>

  <!-- Ø¨Ù†Ø± Ø§Ù„Ø·ÙÙ„ -->
  <div id="childBanner" style="text-align:center; padding:12px 8px; display:none">
    <img id="bannerAvatar" class="avatar" style="width:84px;height:84px" src="images/avatar-default.png" alt="ØµÙˆØ±Ø© Ø§Ù„Ø·ÙÙ„">
    <div style="margin-top:6px;font-weight:800" id="bannerName">â€”</div>
    <div class="note" id="bannerMeta">â€”</div>
  </div>

  <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
  <div class="topbar">
    <div>ğŸ©º ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠØ¨</div>
    <div class="row">
      <a id="lnkHome" class="btn gray">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <button id="btnPrint" class="btn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© PDF</button>
    </div>
  </div>

  <main class="container">
    <!-- ØªÙ†Ù‚Ù‘Ù„ ØµÙØ­Ø§Øª Ø§Ù„Ø·ÙÙ„ -->
    <div class="card"><div class="row" id="childNav"></div></div>

    <!-- ÙÙ„Ø§ØªØ± Ø§Ù„ÙØªØ±Ø© -->
    <section class="card">
      <div class="grid g4">
        <div>
          <label class="small">Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</label>
          <select id="preset">
            <option value="7">Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</option>
            <option value="14">Ø¢Ø®Ø± 14 ÙŠÙˆÙ…Ù‹Ø§</option>
            <option value="30">Ø¢Ø®Ø± 30 ÙŠÙˆÙ…Ù‹Ø§</option>
            <option value="custom">Ù…Ø®ØµØµâ€¦</option>
          </select>
        </div>
        <div>
          <label class="small">Ù…Ù†</label>
          <input id="from" type="date">
        </div>
        <div>
          <label class="small">Ø¥Ù„Ù‰</label>
          <input id="to" type="date">
        </div>
        <div class="row" style="align-items:end">
          <button id="run" class="btn primary" style="width:100%">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
        </div>
      </div>
      <div id="periodMeta" class="small" style="margin-top:6px">â€”</div>
    </section>

    <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹Ø© -->
    <section class="card" id="kidInfoCard" style="display:none">
      <div class="row" style="flex-wrap:wrap; gap:12px">
        <span class="badge-soft">Ø§Ù„ÙˆØ­Ø¯Ø©: mmol/L</span>
        <span id="kidBounds" class="badge-soft">Ø­Ø¯ÙˆØ¯: â€”</span>
        <span id="kidTargets" class="badge-soft">Ù‡Ø¯Ù/CF/ICR: â€”</span>
      </div>
    </section>

    <!-- KPIs -->
    <section class="card">
      <div class="kpi">
        <div class="box"><div class="small">Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª</div><div id="k_total" class="v">â€”</div></div>
        <div class="box"><div class="small">Ù…Ù†Ø®ÙØ¶</div><div id="k_low" class="v">â€”</div></div>
        <div class="box"><div class="small">Ø·Ø¨ÙŠØ¹ÙŠ</div><div id="k_ok" class="v">â€”</div></div>
        <div class="box"><div class="small">Ù…Ø±ØªÙØ¹</div><div id="k_high" class="v">â€”</div></div>
        <div class="box"><div class="small">Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚ %</div><div id="k_tir" class="v">â€”%</div></div>
        <div class="box"><div class="small">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</div><div id="k_avg" class="v">â€”</div></div>
        <div class="box"><div class="small">Ø£Ø¹Ù„Ù‰ / Ø£Ù‚Ù„</div><div id="k_minmax" class="v">â€”</div></div>
      </div>
    </section>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø£ÙÙ‚ÙŠ (ØªØ§Ø±ÙŠØ® Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† + Ø®Ø§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ‚Ø§Øª) -->
    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
        <h3 style="margin:0">ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª</h3>
        <div class="small">Ø§Ù„Ø®Ø§Ù†Ø© ØªØ¹Ø±Ø¶: Ø§Ù„Ù‚ÙŠØ§Ø³ (Ø¨Ø³Ù‡Ù…/Ù†Ù‚Ø·Ø©) Ø«Ù… Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø«Ù… Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆğŸ½ï¸ Ù„Ùˆ ÙˆÙØ¬Ø¯Øª ÙˆØ¬Ø¨Ø© Ø¨Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…</div>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸</th>
            <th>Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±</th><th>Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±</th>
            <th>Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡</th><th>Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡</th>
            <th>Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡</th><th>Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡</th>
            <th>Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…</th><th>Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="10" class="small">Ø§Ø®ØªØ§Ø±ÙŠ ÙØªØ±Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</td></tr>
        </tbody>
      </table>
    </section>

    <!-- Doughnut -->
    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">ğŸ© ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª</h3>
        <span class="badge-soft small">TIR ÙÙŠ Ø§Ù„ÙˆØ³Ø·</span>
      </div>
      <div class="row" style="gap:20px;align-items:center;flex-wrap:wrap">
        <div class="chart-box">
          <canvas id="chartDonut" width="260" height="260"></canvas>
          <div class="tir-center">
            <div id="tirBig" class="tir-big">â€”%</div>
            <div class="tir-small">Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚</div>
          </div>
        </div>
        <div class="small" id="donutMeta">â€”</div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>
  <div id="loader" class="loader"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script type="module">
    /* ===== Ø£Ø¯ÙˆØ§Øª Ù…Ø´ØªØ±ÙƒØ© Ù…Ù† firebase-init.js ===== */
    import {
      auth, db, ensureAuth, requireChildIdFromQuery,
      setChildAvatar
    } from './firebase-init.js';

    import { signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { doc, getDoc, collection, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const $=s=>document.querySelector(s);
    const toast=(m)=>{const t=$("#toast");t.textContent=m;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),2000)}
    const showLoader=(on)=>{$("#loader").style.display=on?"flex":"none"}

    const labels={
      uponWake:'Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸',
      preBreakfast:'Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±', postBreakfast:'Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±',
      preLunch:'Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡',     postLunch:'Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡',
      preDinner:'Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡',    postDinner:'Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡',
      beforeSleep:'Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…',   duringSleep:'Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…'
    };
    const order=['uponWake','preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep'];

    const z2=n=>String(n).padStart(2,'0');
    const todayISO = ()=>{const d=new Date();return `${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())}`};
    function addDays(iso, n){const d=new Date(iso);d.setDate(d.getDate()+n);return `${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())}`}
    function enumerateDates(from,to){const out=[];let d=new Date(from);const end=new Date(to);while(d<=end){out.push(d.toISOString().slice(0,10));d.setDate(d.getDate()+1)}return out}
    const round1=n=>Math.round(Number(n)*10)/10;
    function stateBy(v, low, high){ if(v==null||isNaN(v)) return 'ok'; if(isFinite(low)&&v<low) return 'low'; if(isFinite(high)&&v>high) return 'high'; return 'ok' }
    const iconByState = s => s==='low'?'â¬‡ï¸':(s==='high'?'â¬†ï¸':'ğŸŸ¢');

    let uid=null, childId=new URL(location.search).searchParams.get('child');
    let child={}, donutChart=null;

    (async function boot(){
      showLoader(true);
      const u=await ensureAuth(); uid=u.uid;
      if(!childId) childId=requireChildIdFromQuery();

      // nav
      const nav=$("#childNav"); nav.innerHTML="";
      [
        ['child-dashboard.html','Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'],
        ['measures.html','Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ±'],
        ['meals.html','Ø§Ù„ÙˆØ¬Ø¨Ø§Øª'],
        ['reports.html','Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±'],
        ['visits.html','Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©'],
        ['doctor-report.html','ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¯ÙƒØªÙˆØ±']
      ].forEach(([h,t])=>{
        const a=document.createElement('a'); a.className='btn gray'; a.href=`${h}?child=${encodeURIComponent(childId)}`; a.textContent=t; nav.appendChild(a);
      });
      $("#lnkHome").href=`child-dashboard.html?child=${encodeURIComponent(childId)}`;

      await loadChild();
      initFilters();
      await build();

      $("#btnPrint").addEventListener('click',()=>window.print());
      showLoader(false);
    })().catch(err=>{console.error(err);toast('âš ï¸ ÙØ´Ù„ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©');showLoader(false)});

    async function loadChild(){
      const snap=await getDoc(doc(db,'users',uid,'children',childId));
      if(!snap.exists()){ toast('Ø§Ù„Ø·ÙÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }
      child=snap.data()||{};
      setChildAvatar($("#bannerAvatar"),child.name,child.photoURL);
      $("#bannerName").textContent=child.name||'â€”';
      $("#bannerMeta").textContent=[child.gender||'', (child.weight!=null?child.weight+' ÙƒØ¬Ù…':'â€”'), (child.height!=null?child.height+' Ø³Ù…':'â€”')].filter(Boolean).join(' â€¢ ');
      $("#childBanner").style.display='block';

      $("#kidInfoCard").style.display='block';
      $("#kidBounds").textContent = `Ø­Ø¯ÙˆØ¯: ${child.lowThreshold??'â€”'} â€” ${child.highThreshold??'â€”'}`;
      $("#kidTargets").textContent= `Ù‡Ø¯Ù/CF/ICR: ${child.target??'â€”'} â€¢ ${child.correctionFactor??'â€”'} â€¢ ${child.icr??'â€”'}`;
    }

    function initFilters(){
      const to=todayISO(), from=addDays(to,-6);
      $("#from").value=from; $("#to").value=to;
      $("#preset").addEventListener('change',()=>{
        const v=$("#preset").value; if(v==='custom') return;
        const to=todayISO(); const from=addDays(to,-(Number(v)-1));
        $("#from").value=from; $("#to").value=to; updatePeriodMeta();
      });
      $("#run").addEventListener('click', build);
      updatePeriodMeta();
    }
    function updatePeriodMeta(){
      $("#periodMeta").textContent=`Ø§Ù„ÙØªØ±Ø©: ${$("#from").value||'â€”'} â†’ ${$("#to").value||'â€”'}`;
    }

    async function build(){
      updatePeriodMeta();
      const from=$("#from").value, to=$("#to").value;
      if(!from || !to){ toast('Ø­Ø¯Ø¯ÙŠ Ù…Ù†/Ø¥Ù„Ù‰'); return; }

      // Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„ÙØªØ±Ø©
      const qy=query(
        collection(db,'users',uid,'children',childId,'measurements'),
        where('date','>=',from), where('date','<=',to), orderBy('date','asc')
      );
      const qs=await getDocs(qy);
      const byDate=new Map();
      qs.forEach(s=>{ const d=s.data()||{}; byDate.set(d.date, d.readings||{}) });

      // ÙˆØ¬ÙˆØ¯ ÙˆØ¬Ø¨Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙŠÙˆÙ… (Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© ğŸ½ï¸)
      const mealsByDate = await getMealsPresenceByDate(from,to);

      const dates=enumerateDates(from,to);
      const tbody=$("#rows"); tbody.innerHTML='';

      let total=0,cLow=0,cOk=0,cHigh=0,sum=0;
      let minV=Infinity,maxV=-Infinity,minD='â€”',maxD='â€”';

      dates.forEach(date=>{
        const tr=document.createElement('tr');
        const tdDate=document.createElement('td'); tdDate.className='date'; tdDate.textContent=date; tr.appendChild(tdDate);

        const readings=byDate.get(date)||{};
        const hasMeal=mealsByDate.get(date)===true;

        order.forEach(slot=>{
          const td=document.createElement('td');
          const r=readings[slot];
          if(!r || (r.valueMmol==null && r.value==null)){ td.textContent='â€”'; }
          else{
            const v=round1(Number(r.valueMmol ?? r.value));
            const st=stateBy(v, Number(child.lowThreshold), Number(child.highThreshold));
            const icon = iconByState(st);
            const doses=[ (r.mealDose!=null?`ÙˆØ¬Ø¨Ø©: ${r.mealDose}U`:''), (r.correctionGiven!=null?`ØªØµØ­ÙŠØ­: ${r.correctionGiven}U`:'') ].filter(Boolean).join(' â€¢ ');
            const note=[r.note||'', r.raisedWith||''].filter(Boolean).join(' â€” ');
            const plate = hasMeal ? ' <span class="icon-plate" title="ÙŠÙˆØ¬Ø¯ ÙˆØ¬Ø¨Ø© Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…">ğŸ½ï¸</span>' : '';

            td.innerHTML = `
              <div class="cell">
                <div><b>${v.toFixed(1)} mmol/L</b> ${icon}</div>
                ${doses? `<div class="small">${doses}</div>`:''}
                ${(note||hasMeal)? `<div class="small">${note||''}${plate}</div>`:''}
              </div>
            `;

            total++; sum+=v;
            if(isFinite(Number(child.lowThreshold)) && v<Number(child.lowThreshold)) cLow++;
            else if(isFinite(Number(child.highThreshold)) && v>Number(child.highThreshold)) cHigh++;
            else cOk++;

            if(v<minV){minV=v;minD=date} if(v>maxV){maxV=v;maxD=date}
          }
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      $("#k_total").textContent=total||0;
      $("#k_low").textContent=cLow;
      $("#k_ok").textContent=cOk;
      $("#k_high").textContent=cHigh;
      const tir = total? Math.round((cOk/total)*100) : 0;
      $("#k_tir").textContent=tir+'%';
      $("#k_avg").textContent= total? (sum/total).toFixed(1)+' mmol/L' : 'â€”';
      $("#k_minmax").textContent=(isFinite(minV)&&isFinite(maxV))? `${minV.toFixed(1)} / ${maxV.toFixed(1)} mmol/L (${minD} â€” ${maxD})` : 'â€”';

      renderDonut(cLow,cOk,cHigh,total,tir);
    }

    async function getMealsPresenceByDate(from,to){
      const map=new Map();
      const snap=await getDocs(collection(db,'users',uid,'children',childId,'meals'));
      snap.forEach(s=>{
        const m=s.data()||{}; if(!m.time) return;
        const d=String(m.time).slice(0,10);
        if(d>=from && d<=to) map.set(d,true);
      });
      return map;
    }

    let donutChart=null;
    function renderDonut(low,ok,high,total,tir){
      const ctx=$("#chartDonut").getContext('2d');
      if(donutChart) donutChart.destroy();
      donutChart = new Chart(ctx,{
        type:'doughnut',
        data:{labels:['Ù…Ù†Ø®ÙØ¶','Ø·Ø¨ÙŠØ¹ÙŠ','Ù…Ø±ØªÙØ¹'],datasets:[{data:[low,ok,high],backgroundColor:['#f59e0b','#22c55e','#ef4444'],borderColor:'#fff',borderWidth:2,hoverOffset:6}]},
        options:{
          plugins:{
            legend:{display:true,position:'bottom',labels:{usePointStyle:true,pointStyle:'circle'}},
            tooltip:{callbacks:{label:(c)=>{const v=c.parsed;const pct= total? Math.round((v/total)*100):0; return `${c.label}: ${v} (${pct}%)`;}}}
          },
          cutout:'65%', responsive:true, animation:{duration:500}
        }
      });
      $("#tirBig").textContent=(isFinite(tir)?tir:0)+'%';
      $("#donutMeta").textContent=`Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total||0} â€¢ Ù…Ù†Ø®ÙØ¶: ${low} â€¢ Ø·Ø¨ÙŠØ¹ÙŠ: ${ok} â€¢ Ù…Ø±ØªÙØ¹: ${high}`;
    }

    // Ø®Ø±ÙˆØ¬
    $("#btnLogout")?.addEventListener('click', ()=>signOut(auth).then(()=>location.href='index.html'));
  </script>
</body>
</html>
