<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠØ¨ â€” Ù…ØªØ§Ø¨Ø¹Ø© Ø³ÙƒØ± Ø§Ù„Ø·ÙÙ„</title>
  <!-- Ù…Ø¸Ù‡Ø± Ù…ÙˆØ­Ù‘Ø¯ -->
  <link rel="stylesheet" href="styles.css">

  <style>
  /* Ø¥Ø¶Ø§ÙØ§Øª Ø¨Ø³ÙŠØ·Ø© ÙÙˆÙ‚ styles.css */

  .kpi {display:grid;gap:10px;grid-template-columns:repeat(7,minmax(0,1fr))}
  .kpi .box{background:#f8fafc;border:1px solid var(--line);border-radius:12px;padding:10px}
  .kpi .box .v{font-weight:800}

  .table-report{width:100%;border-collapse:separate;border-spacing:0}
  .table-report th,.table-report td{border:1px solid var(--line);padding:8px;text-align:right;vertical-align:top}
  .table-report thead th{background:#f1f5f9;font-weight:800}
  .table-report td.date{background:#fbfdff;white-space:nowrap;font-weight:800}

  .cell{display:flex;flex-direction:column;gap:4px}
  .state{display:inline-block;padding:2px 8px;border-radius:999px;font-weight:700}
  .state.ok{background:#ecfdf5;color:#16a34a}
  .state.low{background:#fff7ed;color:#b45309}
  .state.high{background:#fee2e2;color:#dc2626}
  .icon-plate{font-size:14px}

  .chart-wrap{display:grid;gap:14px;grid-template-columns:2fr 2fr 1.2fr}
  @media(max-width:900px){.chart-wrap{grid-template-columns:1fr}}

  .chart-card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}

  .chart-donut-box{position:relative;max-width:320px}
  .tir-center{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;font-weight:800;pointer-events:none}
  .tir-big{font-size:22px}
  .tir-small{font-size:11px;color:#475569}

  .insights li{margin:4px 0}

  /* Ø·Ø¨Ø§Ø¹Ø© */
  @media print{
    @page{ size: A4; margin: 10mm }
    header,.no-print,.topbar,.child-nav,.toast,.loader{display:none!important}
    body{background:#fff}
    .container{padding:0}
    .chart-wrap{grid-template-columns:1fr 1fr}
    .table-report th,.table-report td{padding:6px}
  }
  </style>
</head>
<body>

  <!-- Ø¨Ù†Ø± Ø§Ù„Ø·ÙÙ„ Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© (Ù…ÙˆØ­Ù‘Ø¯) -->
  <div id="childBanner" style="text-align:center; padding:12px 8px; display:none">
    <img id="bannerAvatar" class="avatar" style="width:84px;height:84px" src="images/avatar-default.png" alt="ØµÙˆØ±Ø© Ø§Ù„Ø·ÙÙ„">
    <div style="margin-top:6px;font-weight:800" id="bannerName">â€”</div>
    <div class="note" id="bannerMeta">â€”</div>
  </div>

  <!-- Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ -->
  <div class="topbar">
    <div>ğŸ“‘ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠØ¨</div>
    <div class="row">
      <a id="lnkHome" class="btn gray">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <button id="btnPrint" class="btn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© PDF</button>
      <button id="btnBlank" class="btn">ğŸ“ ØªÙ‚Ø±ÙŠØ± ÙØ§Ø±Øº (7 Ø£ÙŠØ§Ù…)</button>
      <button id="btnLogout" class="btn">Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <main class="container">

    <!-- ØªÙ†Ù‚Ù„ ØµÙØ­Ø§Øª Ø§Ù„Ø·ÙÙ„ -->
    <div class="card"><div class="row child-nav" id="childNav"></div></div>

    <!-- ÙÙ„Ø§ØªØ± -->
    <section class="card">
      <div class="grid g4">
        <div>
          <label>Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</label>
          <select id="preset">
            <option value="7">Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</option>
            <option value="14">Ø¢Ø®Ø± 14 ÙŠÙˆÙ…Ù‹Ø§</option>
            <option value="30">Ø¢Ø®Ø± 30 ÙŠÙˆÙ…Ù‹Ø§</option>
            <option value="custom">Ù…Ø®ØµØµâ€¦</option>
          </select>
        </div>
        <div>
          <label>Ù…Ù†</label>
          <input id="from" type="date">
        </div>
        <div>
          <label>Ø¥Ù„Ù‰</label>
          <input id="to" type="date">
        </div>
        <div>
          <label>Ù†ÙˆØ¹ Ø§Ù„ÙˆØ¬Ø¨Ø© (Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ£Ø«ÙŠØ±)</label>
          <select id="mealFilter">
            <option value="*">Ø§Ù„ÙƒÙ„</option>
            <option value="breakfast">ÙØ·ÙˆØ±</option>
            <option value="lunch">ØºØ¯Ø§Ø¡</option>
            <option value="dinner">Ø¹Ø´Ø§Ø¡</option>
            <option value="snack">Ø³Ù†Ø§Ùƒ</option>
            <option value="other">Ø£Ø®Ø±Ù‰</option>
          </select>
        </div>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:8px">
        <button id="run" class="btn primary">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
      </div>
      <div id="periodMeta" class="small" style="margin-top:6px">â€”</div>
    </section>

    <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„ Ø§Ù„Ù…Ø®ØªØµØ±Ø© + Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
    <section class="card">
      <div class="row" style="gap:14px;flex-wrap:wrap">
        <span class="badge-soft">Ø§Ù„ÙˆØ­Ø¯Ø©: <b id="unitNow">mmol/L</b></span>
        <span class="badge-soft">Ø§Ù„Ø­Ø¯ÙˆØ¯: <b id="limitsNow">â€”</b></span>
        <span class="badge-soft">ICR: <b id="icrNow">â€”</b> g/U</span>
        <span class="badge-soft">ØªØµØ­ÙŠØ­ÙŠ: <b id="cfNow">â€”</b> mmol/L Ù„ÙƒÙ„ 1U</span>
      </div>
    </section>

    <!-- KPIs -->
    <section class="card">
      <div class="kpi">
        <div class="box"><div class="small">Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª</div><div id="k_total" class="v">â€”</div></div>
        <div class="box"><div class="small">Ù…Ù†Ø®ÙØ¶</div><div id="k_low" class="v">â€”</div></div>
        <div class="box"><div class="small">Ø·Ø¨ÙŠØ¹ÙŠ</div><div id="k_ok" class="v">â€”</div></div>
        <div class="box"><div class="small">Ù…Ø±ØªÙØ¹</div><div id="k_high" class="v">â€”</div></div>
        <div class="box"><div class="small">% Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚</div><div id="k_tir" class="v">â€”%</div></div>
        <div class="box"><div class="small">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</div><div id="k_avg" class="v">â€”</div></div>
        <div class="box"><div class="small">Ø£Ø¹Ù„Ù‰ / Ø£Ù‚Ù„</div><div id="k_minmax" class="v">â€”</div></div>
      </div>
    </section>

    <!-- Ø§Ù„Ø±Ø³ÙˆÙ… -->
    <section class="chart-wrap">
      <div class="chart-card">
        <div class="small">ğŸ“ˆ Ø®Ø· Ø²Ù…Ù†ÙŠ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø§Øª (mmol/L)</div>
        <canvas id="chartLine" height="180"></canvas>
      </div>
      <div class="chart-card">
        <div class="small">ğŸ“Š ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª (Histogram)</div>
        <canvas id="chartHist" height="180"></canvas>
      </div>
      <div class="chart-card chart-donut-box">
        <div class="small">ğŸ© Ù†Ø³Ø¨ Low / OK / High</div>
        <canvas id="chartDonut" width="280" height="280"></canvas>
        <div class="tir-center">
          <div id="tirBig" class="tir-big">â€”%</div>
          <div class="tir-small">Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚</div>
        </div>
      </div>
    </section>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø£ÙÙ‚ÙŠ -->
    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
        <h3 style="margin:0">ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª (Ø£ÙÙ‚ÙŠ)</h3>
        <div class="small">ÙƒÙ„ Ø®Ø§Ù†Ø©: Ø§Ù„Ù‚ÙŠØ§Ø³ (Ø±Ù…Ø² Ø§Ù„Ø­Ø§Ù„Ø©) Ø«Ù… Ø§Ù„Ø¬Ø±Ø¹Ø§Øª ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆğŸ½ï¸ Ø¥Ù†Ù’ ÙˆÙØ¬Ø¯Øª ÙˆØ¬Ø¨Ø© Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…</div>
      </div>
      <table class="table-report">
        <thead>
          <tr>
            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
            <th>Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸</th>
            <th>Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±</th><th>Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±</th>
            <th>Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡</th><th>Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡</th>
            <th>Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡</th><th>Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡</th>
            <th>Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…</th><th>Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…</th>
          </tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="10" class="small">Ø§Ø®ØªØ§Ø±ÙŠ ÙØªØ±Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</td></tr>
        </tbody>
      </table>
    </section>

    <!-- ØªØ­Ù„ÙŠÙ„Ø§Øª Ø°ÙƒÙŠØ© Ù…Ø®ØªØµØ±Ø© -->
    <section class="card">
      <h3 style="margin:0 0 6px">ğŸ¤– Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø°ÙƒÙŠØ© (Ù…Ø¨Ø¯Ø¦ÙŠØ©)</h3>
      <ul id="insights" class="insights small" style="margin:6px 0 0 0"></ul>
    </section>

  </main>

  <div id="toast" class="toast"></div>
  <div id="loader" class="loader"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>

  <!-- Ù…ÙƒØªØ¨Ø© Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script type="module">
    import {
      auth, db, ensureAuth, requireChildIdFromQuery, setChildAvatar
    } from './firebase-init.js';

    import { signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      doc, getDoc, collection, getDocs, query, where, orderBy
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    /* ===== Helpers ===== */
    const $ = s => document.querySelector(s);
    const toast=(m)=>{const t=$("#toast");t.textContent=m;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),2000)}
    const showLoader=(on)=>{$("#loader").style.display=on?'flex':'none'}

    const z2 = n => String(n).padStart(2,'0');
    const todayISO = ()=>{ const d=new Date(); return `${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())}`; };
    const addDays=(iso,n)=>{const d=new Date(iso); d.setDate(d.getDate()+n); return `${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())}`;};
    const enumerateDates=(from,to)=>{const out=[]; let d=new Date(from), end=new Date(to); while(d<=end){out.push(d.toISOString().slice(0,10)); d.setDate(d.getDate()+1)} return out;}
    const round1=x=>Math.round(Number(x)*10)/10;
    const stateBy=(v,low,high)=> (v==null||isNaN(v))?'ok':(isFinite(low)&&v<low?'low':(isFinite(high)&&v>high?'high':'ok'));

    const labels = {
      uponWake:'Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸',
      preBreakfast:'Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±', postBreakfast:'Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±',
      preLunch:'Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡',     postLunch:'Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡',
      preDinner:'Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡',    postDinner:'Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡',
      beforeSleep:'Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…',   duringSleep:'Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…'
    };
    const orderSlots = ['uponWake','preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep'];

    // Ø£ÙˆÙ‚Ø§Øª ØªÙ‚Ø±ÙŠØ¨ÙŠØ© Ù„ÙˆØ¶Ø¹ Ù†Ù‚Ø§Ø· Ø§Ù„Ø®Ø· Ø§Ù„Ø²Ù…Ù†ÙŠ
    const slotTime = {
      uponWake:'06:30', preBreakfast:'07:45', postBreakfast:'09:30',
      preLunch:'13:00', postLunch:'15:00',
      preDinner:'19:00', postDinner:'21:00',
      beforeSleep:'23:00', duringSleep:'03:00'
    };

    let uid=null, childId=null, child={}, donutChart=null, lineChart=null, histChart=null;

    /* ===== Boot ===== */
    (async function(){
      showLoader(true);
      const {uid:U} = await ensureAuth(); uid=U;
      childId = requireChildIdFromQuery();

      // Nav + Ù„ÙŠØ¯ÙŠÙ†Ø¬
      buildChildNav();
      $('#lnkHome').href=`child-dashboard.html?child=${encodeURIComponent(childId)}`;

      await loadChild();
      initFilters();
      await buildReport();

      $('#btnPrint').addEventListener('click', ()=>window.print());
      $('#btnBlank').addEventListener('click', makeBlank7);
      $('#btnLogout').addEventListener('click', ()=>signOut(auth).then(()=>location.href='index.html'));
    })().finally(()=>showLoader(false));

    /* ===== UI: Child header & nav ===== */
    async function loadChild(){
      const s=await getDoc(doc(db,'users',uid,'children',childId));
      child=s.data()||{};
      setChildAvatar($('#bannerAvatar'), child.name, child.photoURL);
      $('#bannerName').textContent = child.name || 'â€”';
      $('#bannerMeta').textContent = `${child.gender||'â€”'} â€¢ ${child.weight??'â€”'} ÙƒØ¬Ù… â€¢ ${child.height??'â€”'} Ø³Ù…`;
      $('#childBanner').style.display='block';

      $('#unitNow').textContent = 'mmol/L';
      $('#limitsNow').textContent = `${child.lowThreshold??'â€”'} â€” ${child.highThreshold??'â€”'}`;
      $('#icrNow').textContent = child.icr??'â€”';
      $('#cfNow').textContent  = child.correctionFactor??'â€”';
    }

    function buildChildNav(){
      const row = $('#childNav'); row.innerHTML='';
      [
        ['child-dashboard.html','Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'],
        ['measures.html','Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ±'],
        ['meals.html','Ø§Ù„ÙˆØ¬Ø¨Ø§Øª'],
        ['reports.html','Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±'],
        ['doctor-report.html','ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠØ¨'],
        ['visits.html','Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©']
      ].forEach(([h,t])=>{
        const a=document.createElement('a');
        a.className='btn gray';
        a.href=`${h}?child=${encodeURIComponent(childId)}`;
        a.textContent=t;
        row.appendChild(a);
      });
    }

    /* ===== Filters ===== */
    function initFilters(){
      const to=todayISO(), from=addDays(to,-6);
      $('#from').value=from; $('#to').value=to; $('#preset').value='7';
      $('#preset').addEventListener('change', ()=>{
        const v=$('#preset').value;
        if(v==='custom') return;
        const to=todayISO(); const from=addDays(to, -(Number(v)-1));
        $('#from').value=from; $('#to').value=to; updatePeriodMeta();
      });
      $('#run').addEventListener('click', buildReport);
      $('#mealFilter').addEventListener('change', buildReport);
      updatePeriodMeta();
    }
    function updatePeriodMeta(){
      $('#periodMeta').textContent = `Ø§Ù„ÙØªØ±Ø©: ${$('#from').value||'â€”'} â†’ ${$('#to').value||'â€”'} â€¢ Ù†ÙˆØ¹ Ø§Ù„ÙˆØ¬Ø¨Ø©: ${($('#mealFilter').selectedOptions[0]||{}).textContent||'Ø§Ù„ÙƒÙ„'}`;
    }

    /* ===== Data fetch ===== */
    async function fetchMeasures(from,to){
      const col=collection(db,'users',uid,'children',childId,'measurements');
      const qy=query(col, where('date','>=',from), where('date','<=',to), orderBy('date','asc'));
      const qs=await getDocs(qy);
      const byDate=new Map();
      qs.forEach(s=>{
        const d=s.data()||{}; byDate.set(d.date, d.readings||{});
      });
      return byDate;
    }
    async function fetchMeals(from,to, type='*'){
      const col=collection(db,'users',uid,'children',childId,'meals');
      const qs=await getDocs(col);
      const arr=[];
      qs.forEach(s=>{
        const m=s.data()||{}; if(!m.time) return;
        const d=String(m.time).slice(0,10);
        if(d>=from && d<=to){
          if(type==='*' || m.type===type) arr.push(m);
        }
      });
      return arr;
    }

    /* ===== Build report ===== */
    async function buildReport(){
      try{
        showLoader(true);
        updatePeriodMeta();
        const from=$('#from').value, to=$('#to').value;
        if(!from || !to){ toast('Ø­Ø¯Ø¯ÙŠ Ù…Ù†/Ø¥Ù„Ù‰'); return; }

        const measures = await fetchMeasures(from,to);
        const meals    = await fetchMeals(from,to, $('#mealFilter').value);
        const mealsPresence = new Map(meals.map(m=>[String(m.time).slice(0,10), true]));

        // Ø¬Ø¯ÙˆÙ„
        buildTable(from,to, measures, mealsPresence);

        // Ø¥Ø­ØµØ§Ø¡Ø§Øª + Ø±Ø³ÙˆÙ…
        const flat = flattenReadingsForCharts(from,to, measures);
        buildKPIs(flat, from, to);
        drawLine(flat);
        drawHist(flat);
        drawDonut(flat);

        // Insights
        buildInsights(flat, meals);
      }finally{
        showLoader(false);
      }
    }

    function buildTable(from,to, measuresMap, mealsPresence){
      const dates=enumerateDates(from,to);
      const tbody=$('#rows'); tbody.innerHTML='';

      dates.forEach(date=>{
        const tr=document.createElement('tr');
        const tdDate=document.createElement('td'); tdDate.className='date'; tdDate.textContent=date; tr.appendChild(tdDate);

        const readings = measuresMap.get(date)||{};
        const hasMeal  = mealsPresence.get(date)===true;

        orderSlots.forEach(slot=>{
          const td=document.createElement('td');
          const r=readings[slot];
          if(!r || (r.valueMmol==null && r.value==null)){ td.textContent='â€”'; }
          else{
            const v=round1(Number(r.valueMmol ?? r.value));
            const st=stateBy(v, Number(child.lowThreshold), Number(child.highThreshold));
            const icon = st==='low'?'â¬‡ï¸':(st==='high'?'â¬†ï¸':'ğŸŸ¢');
            const doses = [
              r.mealDose!=null ? `ÙˆØ¬Ø¨Ø©: ${r.mealDose}U` : '',
              r.correctionGiven!=null ? `ØªØµØ­ÙŠØ­: ${r.correctionGiven}U` : ''
            ].filter(Boolean).join(' â€¢ ');
            const note = [r.note||'', r.raisedWith||''].filter(Boolean).join(' â€” ');
            const plate = hasMeal? ' <span class="icon-plate" title="ÙˆØ¬Ø¨Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…">ğŸ½ï¸</span>' : '';
            td.innerHTML = `
              <div class="cell">
                <div><b>${v.toFixed(1)} mmol/L</b> ${icon}</div>
                ${doses? `<div class="small">${doses}</div>`:''}
                ${(note||hasMeal)? `<div class="note small">${note||''}${plate}</div>`:''}
              </div>`;
          }
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });
    }

    /* ===== Flatten for charts/KPIs ===== */
    function flattenReadingsForCharts(from,to, measuresMap){
      const out=[]; // {t:Date, v: number, slot: key, date:'YYYY-MM-DD'}
      enumerateDates(from,to).forEach(date=>{
        const r=measuresMap.get(date)||{};
        orderSlots.forEach(slot=>{
          const obj=r[slot];
          if(obj && (obj.valueMmol!=null || obj.value!=null)){
            const v = round1(Number(obj.valueMmol ?? obj.value));
            const hhmm = slotTime[slot] || '12:00';
            const dt = new Date(`${date}T${hhmm}:00`);
            out.push({t:dt, v, slot, date});
          }
        });
      });
      return out.sort((a,b)=>a.t-b.t);
    }

    function buildKPIs(flat, from, to){
      let total=0,cLow=0,cOk=0,cHigh=0,sum=0,minV=Infinity,maxV=-Infinity,minD='â€”',maxD='â€”';
      flat.forEach(p=>{
        const v=p.v; total++; sum+=v;
        if(v<Number(child.lowThreshold)) cLow++;
        else if(v>Number(child.highThreshold)) cHigh++;
        else cOk++;
        if(v<minV){minV=v;minD=p.date}
        if(v>maxV){maxV=v;maxD=p.date}
      });
      $('#k_total').textContent=total||0;
      $('#k_low').textContent=cLow; $('#k_ok').textContent=cOk; $('#k_high').textContent=cHigh;
      const tir= total? Math.round((cOk/total)*100):0; $('#k_tir').textContent=tir+'%';
      $('#tirBig').textContent = tir+'%';
      $('#k_avg').textContent = total? (sum/total).toFixed(1)+' mmol/L' : 'â€”';
      $('#k_minmax').textContent = (isFinite(minV)&&isFinite(maxV))? `${minV.toFixed(1)} / ${maxV.toFixed(1)} mmol/L (${minD} â€” ${maxD})` : 'â€”';
    }

    /* ===== Charts ===== */
    function drawLine(flat){
      const ctx=$('#chartLine');
      if(lineChart) lineChart.destroy();
      lineChart=new Chart(ctx,{
        type:'line',
        data:{
          labels: flat.map(p=>p.t),
          datasets:[{
            label:'Ø§Ù„Ø³ÙƒØ± (mmol/L)',
            data: flat.map(p=>p.v),
            borderColor:'#0ea5e9',
            backgroundColor:'rgba(14,165,233,.12)',
            tension:.3,
            spanGaps:true,
            pointRadius:2
          }]
        },
        options:{
          parsing:false,
          scales:{
            x:{type:'time', time:{unit:'day'}, ticks:{autoSkip:true,maxTicksLimit:10}},
            y:{beginAtZero:false}
          },
          plugins:{legend:{display:false}}
        }
      });
    }

    function drawHist(flat){
      // Ø­Ø§ÙˆÙŠØ§Øª Ø¨Ø³ÙŠØ·Ø©: <4 | 4â€“6.9 | 7â€“9.9 | 10â€“12.9 | >=13
      const bins=[{k:'<4',from:-Infinity,to:4},{k:'4â€“6.9',from:4,to:7},{k:'7â€“9.9',from:7,to:10},{k:'10â€“12.9',from:10,to:13},{k:'â‰¥13',from:13,to:Infinity}];
      const cnt=bins.map(()=>0);
      flat.forEach(p=>{
        for(let i=0;i<bins.length;i++){
          const b=bins[i]; if(p.v>=b.from && p.v< b.to){ cnt[i]++; break; }
        }
      });
      const ctx=$('#chartHist');
      if(histChart) histChart.destroy();
      histChart=new Chart(ctx,{
        type:'bar',
        data:{labels:bins.map(b=>b.k),datasets:[{label:'Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª',data:cnt,backgroundColor:'#6ee7b7',borderColor:'#10b981'}]},
        options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
      });
    }

    function drawDonut(flat){
      let low=0,ok=0,high=0,total=flat.length;
      flat.forEach(p=>{
        if(p.v<Number(child.lowThreshold)) low++;
        else if(p.v>Number(child.highThreshold)) high++;
        else ok++;
      });
      const ctx=$('#chartDonut').getContext('2d');
      if(donutChart) donutChart.destroy();
      donutChart=new Chart(ctx,{
        type:'doughnut',
        data:{labels:['Ù…Ù†Ø®ÙØ¶','Ø·Ø¨ÙŠØ¹ÙŠ','Ù…Ø±ØªÙØ¹'],datasets:[{data:[low,ok,high],backgroundColor:['#f59e0b','#22c55e','#ef4444'],borderWidth:2,borderColor:'#fff'}]},
        options:{plugins:{legend:{display:true,position:'bottom'}},cutout:'65%'}
      });
    }

    /* ===== Insights ===== */
    function buildInsights(flat, meals){
      const ul = $('#insights'); ul.innerHTML='';
      if(!flat.length){ ul.innerHTML='<li>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ©.</li>'; return; }

      const add=(txt)=>{ const li=document.createElement('li'); li.textContent=txt; ul.appendChild(li); };

      // TIR
      const low = flat.filter(p=>p.v<Number(child.lowThreshold)).length;
      const high= flat.filter(p=>p.v>Number(child.highThreshold)).length;
      const ok  = flat.length - low - high;
      const tir = flat.length? Math.round((ok/flat.length)*100):0;
      if(tir<60) add('TIR Ø£Ù‚Ù„ Ù…Ù† 60% â€” ÙŠÙÙ†ØµØ­ Ø¨Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¬Ø±Ø¹Ø§Øª/Ø§Ù„ÙƒØ§Ø±Ø¨ (Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨).');

      // Ø£Ù†Ù…Ø§Ø· Ø­Ø³Ø¨ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª (Ù…ØªÙˆØ³Ø· ÙƒÙ„ Ø®Ø§Ù†Ø©)
      const bySlot=new Map();
      orderSlots.forEach(s=>bySlot.set(s,[]));
      flat.forEach(p=>bySlot.get(p.slot)?.push(p.v));
      const avgSlot={}; orderSlots.forEach(s=>{ const arr=bySlot.get(s)||[]; avgSlot[s]=arr.length? (arr.reduce((a,b)=>a+b,0)/arr.length):null; });

      if(avgSlot.postDinner!=null && avgSlot.postDinner > Number(child.highThreshold||10))
        add('Ø§Ø±ØªÙØ§Ø¹ Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡ Ù…ØªÙƒØ±Ø± â€” Ø±Ø§Ø¬Ø¹ÙŠ Ø¬Ø±Ø¹Ø© Ø§Ù„ÙˆØ¬Ø¨Ø©/ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø¨Ù„Ø¹Ø©.');
      if(avgSlot.uponWake!=null && avgSlot.uponWake < Number(child.lowThreshold||4))
        add('Ø§Ù†Ø®ÙØ§Ø¶Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸ â€” Ù‚Ø¯ ÙŠÙ„Ø²Ù… Ø¶Ø¨Ø· Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¹Ø¯ÙŠØ© (Ø§Ø³ØªØ´Ø§Ø±Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨).');

      // ØªØ£Ø«ÙŠØ± Ø§Ù„ÙˆØ¬Ø¨Ø§Øª (ØªÙ‚Ø±ÙŠØ¨ÙŠ)
      if(meals && meals.length){
        add(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${meals.length} ÙˆØ¬Ø¨Ø© ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©.`);
      }
    }

    /* ===== Blank 7 days ===== */
    function makeBlank7(){
      const today=todayISO();
      const days=Array.from({length:7},(_,i)=>addDays(today,i));
      const tbody=$('#rows');
      tbody.innerHTML = days.map(d=>{
        const empties = Array(orderSlots.length).fill('<td>â€”</td>').join('');
        return `<tr><td class="date">${d}</td>${empties}</tr>`;
      }).join('');
      // ØªØµÙÙŠØ± Ø§Ù„ÙƒÙŠ Ø¨ÙŠ Ø¢ÙŠØ² ÙˆØ§Ù„Ø±Ø³ÙˆÙ…
      $('#k_total').textContent='0'; $('#k_low').textContent='0'; $('#k_ok').textContent='0'; $('#k_high').textContent='0';
      $('#k_tir').textContent='0%'; $('#k_avg').textContent='â€”'; $('#k_minmax').textContent='â€”';
      drawDonut([]); // ØµÙØ±ÙŠØ©
    }
  </script>
</body>
</html>
