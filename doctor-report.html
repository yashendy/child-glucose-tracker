<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ â€” ØªÙ‚Ø±ÙŠØ± ÙˆØªØ­Ù„ÙŠÙ„</title>
<style>
:root{
  --brand:#0ea5e9; --brand2:#6ee7b7; --line:#e5e7eb; --ink:#0f172a; --muted:#6b7280;
  --bg:#f6fbff; --card:#fff; --ok:#16a34a; --low:#b45309; --high:#dc2626;
  --okbg:#ecfdf5; --lowbg:#fff7ed; --highbg:#fee2e2;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.6 system-ui,"Tajawal","Noto Sans Arabic",sans-serif}
a{text-decoration:none;color:inherit}
header{position:sticky;top:0;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;padding:12px 14px;display:flex;justify-content:space-between;align-items:center;z-index:5}
header .btn{color:#fff;border:1px solid #ffffff66;background:#ffffff22;padding:8px 12px;border-radius:10px;cursor:pointer}
.container{max-width:1200px;margin:auto;padding:14px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:0 6px 24px rgba(0,0,0,.04);margin-bottom:12px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{border:none;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
.btn.primary{background:var(--brand);color:#fff}
.btn.gray{background:#eef2f7}
.small{font-size:12px;color:var(--muted)}
.badge{display:inline-flex;align-items:center;gap:6px;background:#eef6ff;color:#0369a1;border-radius:999px;padding:6px 10px;font-weight:800}
.kpi{display:grid;gap:10px;grid-template-columns:repeat(7,minmax(0,1fr))}
.kpi .box{background:#f8fafc;border:1px solid var(--line);border-radius:12px;padding:10px}
.kpi .box .v{font-weight:800}

/* Ø·ÙÙ„ */
.child-head{display:flex;justify-content:space-between;align-items:center;gap:14px;flex-wrap:wrap}
.kid{display:flex;gap:12px;align-items:center}
.avatar{width:64px;height:64px;border-radius:50%;object-fit:cover;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.12)}

/* ÙÙˆØ±Ù… Ø§Ù„ØªØ­ÙƒÙ… */
.grid{display:grid;gap:10px}
.g4{grid-template-columns:repeat(4,minmax(0,1fr))}
@media(max-width:900px){.g4{grid-template-columns:1fr 1fr}}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
input,select{width:100%;padding:9px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}

/* Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± */
.table{width:100%;border-collapse:separate;border-spacing:0}
.table th,.table td{border:1px solid var(--line);padding:8px;vertical-align:top;text-align:right}
.table thead th{background:#f1f5f9;font-weight:800}
.table td.date{background:#fbfdff;white-space:nowrap;font-weight:800}
.cell{display:flex;flex-direction:column;gap:4px}
.line{font-size:12px}
.state{display:inline-block;padding:2px 8px;border-radius:999px}
.state.ok{background:var(--okbg);color:var(--ok)}
.state.low{background:var(--lowbg);color:var(--low)}
.state.high{background:var(--highbg);color:var(--high)}
.note{color:var(--muted)}
.icon-plate{font-size:14px}

/* Doughnut */
.chart-wrap{display:flex;gap:20px;align-items:center;flex-wrap:wrap}
.tir-center{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;font-weight:800}
.tir-big{font-size:22px}
.tir-small{font-size:11px;color:#475569}
.chart-box{position:relative;width:280px;max-width:100%}

/* Ø·Ø¨Ø§Ø¹Ø© */
@media print{
  @page{ size: A4; margin: 10mm }
  header,.no-print{display:none!important}
  body{background:#fff}
  .card{border:0;box-shadow:none;padding:0;margin:0 0 8px}
  .kpi{grid-template-columns:repeat(7,1fr)}
  .chart-box{width:240px}
  .table th,.table td{padding:6px}
}
</style>
</head>
<body>

<header>
  <div>Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ â€” ØªÙ‚Ø±ÙŠØ± ÙˆØªØ­Ù„ÙŠÙ„</div>
  <div class="row">
    <a class="btn" href="dashboard.html">Ù„ÙˆØ­Ø© ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±</a>
    <button id="btnPrint" class="btn">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© PDF</button>
    <button id="btnBlank" class="btn">ğŸ“ ØªÙ‚Ø±ÙŠØ± ÙØ§Ø±Øº (7 Ø£ÙŠØ§Ù…)</button>
  </div>
</header>

<main class="container">
  <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„ -->
  <section class="card child-head">
    <div class="kid">
      <img id="kidAvatar" class="avatar" src="images/avatar-default.png" alt="ØµÙˆØ±Ø© Ø§Ù„Ø·ÙÙ„">
      <div>
        <div id="kidName" style="font-weight:800">â€”</div>
        <div id="kidMeta" class="small">â€”</div>
      </div>
    </div>
    <div class="badge" id="kidSetup">Ø§Ù„ÙˆØ­Ø¯Ø©: mmol/L â€¢ Ø­Ø¯ÙˆØ¯: â€”</div>
  </section>

  <!-- ÙÙ„Ø§ØªØ± -->
  <section class="card">
    <div class="grid g4">
      <div>
        <label>Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</label>
        <select id="preset">
          <option value="7">Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</option>
          <option value="14">Ø¢Ø®Ø± 14 ÙŠÙˆÙ…Ù‹Ø§</option>
          <option value="30">Ø¢Ø®Ø± 30 ÙŠÙˆÙ…Ù‹Ø§</option>
          <option value="custom">Ù…Ø®ØµØµâ€¦</option>
        </select>
      </div>
      <div>
        <label>Ù…Ù†</label>
        <input id="from" type="date">
      </div>
      <div>
        <label>Ø¥Ù„Ù‰</label>
        <input id="to" type="date">
      </div>
      <div class="row" style="align-items:end">
        <button id="run" class="btn primary" style="width:100%">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
      </div>
    </div>
    <div id="periodMeta" class="small" style="margin-top:6px">â€”</div>
  </section>

  <!-- KPIs -->
  <section class="card">
    <div class="kpi">
      <div class="box"><div class="small">Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª</div><div id="k_total" class="v">â€”</div></div>
      <div class="box"><div class="small">Ù…Ù†Ø®ÙØ¶</div><div id="k_low" class="v">â€”</div></div>
      <div class="box"><div class="small">Ø·Ø¨ÙŠØ¹ÙŠ</div><div id="k_ok" class="v">â€”</div></div>
      <div class="box"><div class="small">Ù…Ø±ØªÙØ¹</div><div id="k_high" class="v">â€”</div></div>
      <div class="box"><div class="small">% Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚</div><div id="k_tir" class="v">â€”%</div></div>
      <div class="box"><div class="small">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</div><div id="k_avg" class="v">â€”</div></div>
      <div class="box"><div class="small">Ø£Ø¹Ù„Ù‰ / Ø£Ù‚Ù„</div><div id="k_minmax" class="v">â€”</div></div>
    </div>
  </section>

  <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± (Ø£ÙÙ‚ÙŠ) -->
  <section class="card">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
      <h3 style="margin:0">ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª (Ø´ÙƒÙ„ Ø£ÙÙ‚ÙŠ)</h3>
      <div class="small">Ø®Ø§Ù†Ø© ÙƒÙ„ ØªÙˆÙ‚ÙŠØª ØªØ¹Ø±Ø¶: Ø§Ù„Ù‚ÙŠØ§Ø³ (Ø¨Ø³Ù‡Ù…) Ø«Ù… Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø«Ù… Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª/ğŸ½ï¸</div>
    </div>
    <table class="table" id="rep">
      <thead>
        <tr>
          <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th>Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸</th>
          <th>Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±</th><th>Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±</th>
          <th>Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡</th><th>Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡</th>
          <th>Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡</th><th>Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡</th>
          <th>Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…</th><th>Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="10" class="small">Ø§Ø®ØªØ§Ø±ÙŠ ÙØªØ±Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</td></tr>
      </tbody>
    </table>
  </section>

  <!-- Doughnut -->
  <section class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">ğŸ© ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª Ø¨Ø§Ù„ÙØªØ±Ø©</h3>
      <span class="badge small">ÙŠÙØ¸Ù‡Ø± Ù†Ø³Ø¨Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚ TIR ÙÙŠ Ø§Ù„ÙˆØ³Ø·</span>
    </div>
    <div class="chart-wrap">
      <div class="chart-box">
        <canvas id="chartDonut" width="280" height="280" aria-label="ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª"></canvas>
        <div class="tir-center" aria-hidden="true">
          <div id="tirBig" class="tir-big">â€”%</div>
          <div class="tir-small">Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚</div>
        </div>
      </div>
      <div class="small">
        <div>Ø§Ù„Ø£Ù„ÙˆØ§Ù†: <span style="color:#f59e0b">Ù…Ù†Ø®ÙØ¶</span> â€¢ <span style="color:#22c55e">Ø·Ø¨ÙŠØ¹ÙŠ</span> â€¢ <span style="color:#ef4444">Ù…Ø±ØªÙØ¹</span></div>
        <div id="donutMeta" style="margin-top:6px">â€”</div>
      </div>
    </div>
  </section>
</main>

<!-- Ù…ÙƒØªØ¨Ø§Øª -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script type="module">
/* ================ Firebase ================ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, doc, getDoc, collection, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCOdrwdbw8b7YdWLPZ4TDdG2iS9kvvxQ7M",
  authDomain: "child-glucose-tracker.firebaseapp.com",
  projectId: "child-glucose-tracker",
  storageBucket: "child-glucose-tracker.firebasestorage.app",
  messagingSenderId: "294563325904",
  appId: "1:294563325904:web:39562550bf305fc01abbd5"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* ================ Helpers ================ */
const $ = s => document.querySelector(s);
const labels = {
  uponWake:'Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸',
  preBreakfast:'Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±', postBreakfast:'Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±',
  preLunch:'Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡',     postLunch:'Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡',
  preDinner:'Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡',    postDinner:'Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡',
  beforeSleep:'Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…',   duringSleep:'Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…'
};
const order = ['uponWake','preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep'];
const slotKeysForDay = order; // Ù„Ù„Ø¬Ø¯ÙˆÙ„

let uid=null, childId=new URL(location.search).searchParams.get('child');
let child={}, donutChart=null;

const z2 = n => String(n).padStart(2,'0');
const todayISO = ()=> {
  const d=new Date();
  return `${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())}`;
};
function addDays(iso, n){
  const d=new Date(iso); d.setDate(d.getDate()+n);
  return `${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())}`;
}
function enumerateDates(from,to){
  const out=[]; let d=new Date(from); const end=new Date(to);
  while(d<=end){ out.push(d.toISOString().slice(0,10)); d.setDate(d.getDate()+1); }
  return out;
}
function round1(x){ return Math.round(Number(x)*10)/10; }
function stateBy(v, low, high){
  if(v==null || isNaN(v)) return 'ok';
  if(isFinite(low)  && v<low)  return 'low';
  if(isFinite(high) && v>high) return 'high';
  return 'ok';
}

/* ================ Auth & load child ================ */
onAuthStateChanged(auth, async (u)=>{
  if(!u){ location.href='index.html'; return; }
  uid=u.uid;
  if(!childId){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ø·ÙÙ„ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·'); return; }
  await loadChild();
  initFilters();
  await build();
});

async function loadChild(){
  const snap = await getDoc(doc(db,'users',uid,'children',childId));
  if(!snap.exists()){ alert('Ø§Ù„Ø·ÙÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }
  child = snap.data() || {};
  $('#kidName').textContent = child.name || 'â€”';
  $('#kidMeta').textContent = [
    child.gender||'',
    (child.weight!=null? (child.weight+' ÙƒØ¬Ù…') : 'â€”'),
    (child.height!=null? (child.height+' Ø³Ù…') : 'â€”')
  ].filter(Boolean).join(' â€¢ ');
  $('#kidSetup').textContent = `Ø§Ù„ÙˆØ­Ø¯Ø©: mmol/L â€¢ Ø­Ø¯ÙˆØ¯: ${child.lowThreshold??'â€”'} â€” ${child.highThreshold??'â€”'}`;
  if(child.photoURL){ $('#kidAvatar').src = child.photoURL; }
}

/* ================ Filters ================ */
function initFilters(){
  const to = todayISO();
  const from = addDays(to, -6);
  $('#from').value = from;
  $('#to').value   = to;
  $('#preset').addEventListener('change', onPreset);
  $('#run').addEventListener('click', build);
  $('#btnPrint').addEventListener('click', ()=>window.print());
  $('#btnBlank').addEventListener('click', makeBlank7);
  updatePeriodMeta();
}
function onPreset(){
  const v=$('#preset').value;
  if(v==='custom') return;
  const to = todayISO();
  const from = addDays(to, -(Number(v)-1));
  $('#from').value=from; $('#to').value=to;
  updatePeriodMeta();
}
function updatePeriodMeta(){
  $('#periodMeta').textContent = `Ø§Ù„ÙØªØ±Ø©: ${$('#from').value||'â€”'} â†’ ${$('#to').value||'â€”'}`;
}

/* ================ Build report ================ */
async function build(){
  updatePeriodMeta();
  const from=$('#from').value, to=$('#to').value;
  if(!from || !to){ alert('Ø­Ø¯Ø¯ÙŠ Ù…Ù†/Ø¥Ù„Ù‰'); return; }

  // 1) Ø§Ø³Ø­Ø¨ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª Ù„Ù„ÙØªØ±Ø©
  const col = collection(db,'users',uid,'children',childId,'measurements');
  const qy  = query(col, where('date','>=',from), where('date','<=',to), orderBy('date','asc'));
  const qs  = await getDocs(qy);

  const mapByDate = new Map(); // date -> readings
  qs.forEach(s=>{
    const d=s.data()||{};
    mapByDate.set(d.date, d.readings||{});
  });

  // 2) Ø§Ø³Ø­Ø¨ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù†Ø·Ø§Ù‚ (Ù„ØªÙØ¹ÙŠÙ„ ğŸ½ï¸ ÙÙŠ Ø§Ù„Ø®Ù„ÙŠØ©)
  const mealsByDate = await getMealsPresenceByDate(from,to);

  // 3) Ø§Ø¨Ù†ÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
  const dates = enumerateDates(from,to);
  const tbody = $('#rows'); tbody.innerHTML='';
  if(!dates.length){ tbody.innerHTML='<tr><td colspan="10" class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙŠØ§Ù….</td></tr>'; }

  // Counters for KPIs & donut
  let total=0, cLow=0, cOk=0, cHigh=0, sum=0;
  let minV=Infinity, maxV=-Infinity, minD='â€”', maxD='â€”';

  dates.forEach(date=>{
    const tr = document.createElement('tr');

    // Ø§Ù„ØªØ§Ø±ÙŠØ®
    const tdDate = document.createElement('td');
    tdDate.className='date';
    tdDate.textContent = date;
    tr.appendChild(tdDate);

    const readings = mapByDate.get(date) || {};
    const hasMeal  = mealsByDate.get(date)===true;

    // Ø®Ù„Ø§ÙŠØ§ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª
    slotKeysForDay.forEach(slot=>{
      const td=document.createElement('td');
      const r=readings[slot];
      if(!r || (r.valueMmol==null && r.value==null)){
        td.innerHTML='â€”';
      }else{
        const v = round1(Number(r.valueMmol ?? r.value));
        const st = stateBy(v, Number(child.lowThreshold), Number(child.highThreshold));
        const icon = st==='low'?'â¬‡ï¸':(st==='high'?'â¬†ï¸':'ğŸŸ¢');
        const doses = [
          r.mealDose!=null ? `ÙˆØ¬Ø¨Ø©: ${r.mealDose}U` : '',
          r.correctionGiven!=null ? `ØªØµØ­ÙŠØ­: ${r.correctionGiven}U` : ''
        ].filter(Boolean).join(' â€¢ ');
        const note = [r.note||'', r.raisedWith||''].filter(Boolean).join(' â€” ');
        const plate = hasMeal ? ' <span class="icon-plate" title="ÙŠÙˆØ¬Ø¯ ÙˆØ¬Ø¨Ø© Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…">ğŸ½ï¸</span>' : '';

        td.innerHTML = `
          <div class="cell">
            <div class="line"><b>${v.toFixed(1)} mmol/L</b> ${icon}</div>
            ${doses? `<div class="line small">${doses}</div>`:''}
            ${(note||hasMeal)? `<div class="line note">${note||''}${plate}</div>`:''}
          </div>
        `;

        // KPIs
        total++; sum+=v;
        if(v<Number(child.lowThreshold)) cLow++;
        else if(v>Number(child.highThreshold)) cHigh++;
        else cOk++;
        if(v<minV){minV=v;minD=date;} if(v>maxV){maxV=v;maxD=date;}
      }
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });

  // 4) KPIs
  $('#k_total').textContent = total||0;
  $('#k_low').textContent   = cLow;
  $('#k_ok').textContent    = cOk;
  $('#k_high').textContent  = cHigh;
  const tir = total? Math.round((cOk/total)*100) : 0;
  $('#k_tir').textContent   = tir + '%';
  $('#k_avg').textContent   = total? (sum/total).toFixed(1)+' mmol/L' : 'â€”';
  $('#k_minmax').textContent= (isFinite(minV)&&isFinite(maxV)) ? `${minV.toFixed(1)} / ${maxV.toFixed(1)} mmol/L (${minD} â€” ${maxD})` : 'â€”';

  // 5) Doughnut
  renderDonut(cLow,cOk,cHigh,total,tir);
}

/* ================ Meals presence by day ================ */
async function getMealsPresenceByDate(from,to){
  // Ø³Ù†Ø¬Ù„Ø¨ ÙƒÙ„ Ù…Ø³ØªÙ†Ø¯Ø§Øª meals Ø¨ÙŠÙ† from..to (Ø¨ÙƒÙØ§ÙŠØ© ØªÙ‚Ø±ÙŠØ¨ÙŠØ© Ø¹Ø¨Ø± ØªØµÙÙŠØ© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©)
  // Ù†ÙØªØ±Ø¶ field time = "YYYY-MM-DDTHH:mm" (local)
  const map = new Map();
  const mealsCol = collection(db,'users',uid,'children',childId,'meals');
  const snap = await getDocs(mealsCol);
  snap.forEach(s=>{
    const m=s.data()||{};
    if(!m.time) return;
    const d=(String(m.time).slice(0,10));
    if(d>=from && d<=to) map.set(d, true);
  });
  return map;
}

/* ================ Doughnut ================ */
function renderDonut(low,ok,high,total,tir){
  const ctx = document.getElementById('chartDonut').getContext('2d');
  if(donutChart) donutChart.destroy();
  donutChart = new Chart(ctx,{
    type:'doughnut',
    data:{
      labels:['Ù…Ù†Ø®ÙØ¶','Ø·Ø¨ÙŠØ¹ÙŠ','Ù…Ø±ØªÙØ¹'],
      datasets:[{
        data:[low,ok,high],
        backgroundColor:['#f59e0b','#22c55e','#ef4444'],
        borderColor:'#ffffff',
        borderWidth:2,
        hoverOffset:6
      }]
    },
    options:{
      plugins:{
        legend:{display:true,position:'bottom',labels:{usePointStyle:true,pointStyle:'circle'}},
        tooltip:{callbacks:{label:(ctx)=>{
          const val=ctx.parsed, pct = total? Math.round((val/total)*100):0;
          return `${ctx.label}: ${val} (${pct}%)`;
        }}}
      },
      cutout:'65%',
      responsive:true,
      animation:{duration:500}
    }
  });
  document.getElementById('tirBig').textContent = (isFinite(tir)?tir:0) + '%';
  document.getElementById('donutMeta').textContent =
    `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total||0} â€¢ Ù…Ù†Ø®ÙØ¶: ${low} â€¢ Ø·Ø¨ÙŠØ¹ÙŠ: ${ok} â€¢ Ù…Ø±ØªÙØ¹: ${high}`;
}

/* ================ Blank report (7 days) ================ */
function makeBlank7(){
  const today = todayISO();
  const days = Array.from({length:7},(_,i)=> addDays(today, i));
  const tbody = $('#rows');
  tbody.innerHTML = days.map(d=>{
    const emptyCells = Array(order.length).fill('<td>â€”</td>').join('');
    return `<tr><td class="date">${d}</td>${emptyCells}</tr>`;
  }).join('');
  // KPIs Ùˆ Doughnut ØµÙØ±ÙŠØ©
  $('#k_total').textContent='0'; $('#k_low').textContent='0'; $('#k_ok').textContent='0'; $('#k_high').textContent='0';
  $('#k_tir').textContent='0%'; $('#k_avg').textContent='â€”'; $('#k_minmax').textContent='â€”';
  renderDonut(0,0,0,0,0);
}
</script>
</body>
</html>
