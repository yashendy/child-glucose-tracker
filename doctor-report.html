<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>تقرير الطبيب</title>
<link rel="stylesheet" href="styles.css">
<style>
.table thead th{white-space:nowrap}
.chart-box{position:relative;width:280px;max-width:100%}
.tir-center{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;flex-direction:column;font-weight:800}
.tir-big{font-size:22px}
.tir-small{font-size:11px;color:#475569}
@media print{
  @page{ size:A4; margin:10mm }
  .chart-box{width:240px}
}
</style>
</head>
<body>
<div class="topbar">
  <div>📊 تقرير الطبيب</div>
  <div class="row">
    <a id="lnkDash" class="btn gray">لوحة الطفل</a>
    <button id="btnPrint" class="btn">🖨️ طباعة</button>
    <button id="btnBlank" class="btn">📝 تقرير فارغ (7 أيام)</button>
  </div>
</div>

<main class="container">
  <section class="card">
    <div class="row" style="gap:12px;align-items:center">
      <img id="avatar" class="avatar" style="width:64px;height:64px" src="images/avatar-default.png" alt="">
      <div>
        <div id="kidName" style="font-weight:800">—</div>
        <div id="kidMeta" class="note">—</div>
      </div>
      <span class="badge-soft" id="kidSetup">—</span>
    </div>
  </section>

  <section class="card">
    <div class="grid g4">
      <div><label>الفترة السريعة</label>
        <select id="preset">
          <option value="7">آخر 7 أيام</option>
          <option value="14">آخر 14 يومًا</option>
          <option value="30">آخر 30 يومًا</option>
          <option value="custom">مخصص…</option>
        </select>
      </div>
      <div><label>من</label><input id="from" type="date"></div>
      <div><label>إلى</label><input id="to" type="date"></div>
      <div class="row" style="align-items:end">
        <button id="run" class="btn primary" style="width:100%">عرض</button>
      </div>
    </div>
    <div id="periodMeta" class="note" style="margin-top:6px">—</div>
  </section>

  <section class="card">
    <div class="kpi" style="display:grid;gap:10px;grid-template-columns:repeat(7,minmax(0,1fr))">
      <div class="box"><div class="small">عدد القراءات</div><div id="k_total" class="v" style="font-weight:800">—</div></div>
      <div class="box"><div class="small">منخفض</div><div id="k_low" class="v" style="font-weight:800">—</div></div>
      <div class="box"><div class="small">طبيعي</div><div id="k_ok" class="v" style="font-weight:800">—</div></div>
      <div class="box"><div class="small">مرتفع</div><div id="k_high" class="v" style="font-weight:800">—</div></div>
      <div class="box"><div class="small">% داخل النطاق</div><div id="k_tir" class="v" style="font-weight:800">—%</div></div>
      <div class="box"><div class="small">متوسط القراءة</div><div id="k_avg" class="v" style="font-weight:800">—</div></div>
      <div class="box"><div class="small">أعلى/أقل</div><div id="k_minmax" class="v" style="font-weight:800">—</div></div>
    </div>
  </section>

  <section class="card">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
      <h3 style="margin:0">📋 جدول القياسات</h3>
      <div class="small">يعرض القراءة (بسهم) ثم الجرعات ثم الملاحظات و🍽️ لو فيه وجبة</div>
    </div>
    <table class="table">
      <thead>
        <tr>
          <th>التاريخ</th>
          <th>الاستيقاظ</th><th>قبل الإفطار</th><th>بعد الإفطار</th>
          <th>قبل الغداء</th><th>بعد الغداء</th>
          <th>قبل العشاء</th><th>بعد العشاء</th>
          <th>قبل النوم</th><th>أثناء النوم</th>
        </tr>
      </thead>
      <tbody id="rows"><tr><td colspan="10" class="note">—</td></tr></tbody>
    </table>
  </section>

  <section class="card">
    <h3 style="margin:0 0 6px">🍩 توزيع القراءات</h3>
    <div class="row" style="gap:18px;align-items:center;flex-wrap:wrap">
      <div class="chart-box">
        <canvas id="chartDonut" width="280" height="280"></canvas>
        <div class="tir-center">
          <div id="tirBig" class="tir-big">—%</div>
          <div class="tir-small">داخل النطاق</div>
        </div>
      </div>
      <div class="note" id="donutMeta">—</div>
    </div>
  </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script type="module">
import { auth, db, ensureAuth, requireChildIdFromQuery, loadChildProfile, setChildAvatar, todayISO } from './firebase-init.js';
import { collection, getDocs, doc, getDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const $=s=>document.querySelector(s);
let uid=null, childId=null, child=null, donut=null;

const labels={
  uponWake:'الاستيقاظ', preBreakfast:'قبل الإفطار', postBreakfast:'بعد الإفطار',
  preLunch:'قبل الغداء', postLunch:'بعد الغداء',
  preDinner:'قبل العشاء', postDinner:'بعد العشاء',
  beforeSleep:'قبل النوم', duringSleep:'أثناء النوم'
};
const order=['uponWake','preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep'];

function z2(n){return String(n).padStart(2,'0')}
function addDays(iso,n){const d=new Date(iso); d.setDate(d.getDate()+n); return `${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())}`;}
function enumerateDates(from,to){const out=[];let d=new Date(from),e=new Date(to);while(d<=e){out.push(d.toISOString().slice(0,10));d.setDate(d.getDate()+1)}return out;}
function round1(x){return Math.round(Number(x)*10)/10}
function stateBy(v,low,high){ if(v==null||isNaN(v))return'ok'; if(isFinite(low)&&v<low)return'low'; if(isFinite(high)&&v>high)return'high'; return 'ok'; }
function iconBy(st){return st==='low'?'⬇️':st==='high'?'⬆️':'🟢'}

(async function boot(){
  ({uid}=await ensureAuth());
  childId=requireChildIdFromQuery();
  $('#lnkDash').href=`child-dashboard.html?child=${encodeURIComponent(childId)}`;

  child=await loadChildProfile(uid, childId);
  setChildAvatar($('#avatar'), child.name, child.photoURL);
  $('#kidName').textContent=child.name||'—';
  $('#kidMeta').textContent=`${child.gender||'—'} • ${child.weight??'—'} كجم • ${child.height??'—'} سم`;
  $('#kidSetup').textContent=`الوحدة: mmol/L • حدود: ${child.lowThreshold??'—'} — ${child.highThreshold??'—'}`;

  const to=todayISO(), from=addDays(to,-6);
  $('#from').value=from; $('#to').value=to;
  updatePeriodMeta();

  $('#preset').addEventListener('change',()=>{
    if($('#preset').value==='custom') return;
    const n=Number($('#preset').value); const to=todayISO(), from=addDays(to,-(n-1));
    $('#from').value=from; $('#to').value=to; updatePeriodMeta();
  });
  $('#run').addEventListener('click',build);
  $('#btnPrint').addEventListener('click',()=>window.print());
  $('#btnBlank').addEventListener('click',makeBlank7);

  await build();
})();

function updatePeriodMeta(){
  $('#periodMeta').textContent = `الفترة: ${$('#from').value||'—'} → ${$('#to').value||'—'}`;
}

async function getMealsPresenceByDate(from,to){
  const map=new Map();
  const snap=await getDocs(collection(db,'users',uid,'children',childId,'meals'));
  snap.forEach(s=>{
    const d=(String((s.data().time||'')).slice(0,10));
    if(d>=from&&d<=to) map.set(d,true);
  });
  return map;
}

async function build(){
  updatePeriodMeta();
  const from=$('#from').value, to=$('#to').value; if(!from||!to){alert('حددي الفترة'); return;}
  const col=collection(db,'users',uid,'children',childId,'measurements');
  const qs=await getDocs(query(col, where('date','>=',from), where('date','<=',to), orderBy('date','asc')));

  const mapByDate=new Map();
  qs.forEach(s=>{ const d=s.data()||{}; mapByDate.set(d.date, d.readings||{}) });

  const mealsMap = await getMealsPresenceByDate(from,to);

  const dates=enumerateDates(from,to);
  const tbody=$('#rows'); tbody.innerHTML='';

  let total=0, cLow=0, cOk=0, cHigh=0, sum=0, minV=Infinity, maxV=-Infinity, minD='—', maxD='—';

  dates.forEach(date=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="date">${date}</td>`;
    const readings=mapByDate.get(date)||{};
    const hasMeal=mealsMap.get(date)===true;

    order.forEach(slot=>{
      const r=readings[slot];
      const td=document.createElement('td');
      if(!r || (r.valueMmol==null && r.value==null)){ td.textContent='—'; tr.appendChild(td); return; }
      const v=round1(r.valueMmol ?? r.value);
      const st=stateBy(v, Number(child.lowThreshold), Number(child.highThreshold));
      const doses = [
        r.mealDose!=null? `وجبة: ${r.mealDose}U` : '',
        r.correctionGiven!=null? `تصحيح: ${r.correctionGiven}U` : ''
      ].filter(Boolean).join(' • ');
      const note = [r.note||'', r.raisedWith||''].filter(Boolean).join(' — ');
      const plate = hasMeal? ' 🍽️' : '';
      td.innerHTML = `
        <div class="cell">
          <div class="line"><b>${v.toFixed(1)} mmol/L</b> ${iconBy(st)}</div>
          ${doses? `<div class="line small">${doses}</div>`:''}
          ${(note||hasMeal)? `<div class="line note">${note||''}${plate}</div>`:''}
        </div>`;
      tr.appendChild(td);

      total++; sum+=v;
      if(st==='low') cLow++; else if(st==='high') cHigh++; else cOk++;
      if(v<minV){minV=v;minD=date;} if(v>maxV){maxV=v;maxD=date;}
    });

    tbody.appendChild(tr);
  });

  $('#k_total').textContent=total; $('#k_low').textContent=cLow; $('#k_ok').textContent=cOk; $('#k_high').textContent=cHigh;
  const tir = total? Math.round((cOk/total)*100) : 0;
  $('#k_tir').textContent = tir+'%';
  $('#k_avg').textContent = total? (sum/total).toFixed(1)+' mmol/L' : '—';
  $('#k_minmax').textContent = (isFinite(minV)&&isFinite(maxV))? `${minV.toFixed(1)} / ${maxV.toFixed(1)} mmol/L (${minD} — ${maxD})` : '—';

  renderDonut(cLow,cOk,cHigh,total,tir);
}

function renderDonut(low,ok,high,total,tir){
  const ctx=document.getElementById('chartDonut').getContext('2d');
  if(donut) donut.destroy();
  donut=new Chart(ctx,{
    type:'doughnut',
    data:{labels:['منخفض','طبيعي','مرتفع'],datasets:[{data:[low,ok,high],backgroundColor:['#f59e0b','#22c55e','#ef4444'],borderWidth:2,borderColor:'#fff'}]},
    options:{plugins:{legend:{display:true,position:'bottom'}},cutout:'65%'}
  });
  $('#tirBig').textContent = (isFinite(tir)?tir:0)+'%';
  $('#donutMeta').textContent = `الإجمالي: ${total} • منخفض: ${low} • طبيعي: ${ok} • مرتفع: ${high}`;
}

function makeBlank7(){
  const to=todayISO(); const from=addDays(to,-6);
  $('#from').value=from; $('#to').value=to; updatePeriodMeta();
  const dates=enumerateDates(from,to);
  const tbody=$('#rows');
  tbody.innerHTML= dates.map(d=>{
    const empty = '<td>—</td>'.repeat(order.length);
    return `<tr><td class="date">${d}</td>${empty}</tr>`;
  }).join('');
  renderDonut(0,0,0,0,0);
}
</script>
</body>
</html>
