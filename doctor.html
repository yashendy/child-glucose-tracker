<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>متابعة الطبيب — ملخص القياسات</title>
<style>
:root{
  --brand:#0ea5e9;--brand2:#6ee7b7;--line:#e5e7eb;--ink:#0f172a;--muted:#6b7280;
  --bg:#f6fbff;--card:#fff;
  --ok:#16a34a;--low:#b45309;--high:#dc2626;
  --okbg:#ecfdf5;--lowbg:#fff7ed;--highbg:#fee2e2;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.55 system-ui,"Tajawal","Noto Sans Arabic",sans-serif}
header{position:sticky;top:0;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;padding:12px 14px;display:flex;justify-content:space-between;align-items:center;z-index:5}
header .btn{color:#fff;text-decoration:none;border:1px solid #ffffff66;padding:8px 12px;border-radius:10px;margin-inline-start:6px;background:#ffffff22;cursor:pointer}
main{max-width:1100px;margin:auto;padding:16px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:0 6px 24px rgba(0,0,0,.04);margin-bottom:12px}
.small{font-size:12px;color:var(--muted)}
.kv{display:flex;gap:8px;flex-wrap:wrap}
.kv .chip{background:#eef6ff;color:#0369a1;padding:6px 10px;border-radius:999px}
.table{width:100%;border-collapse:separate;border-spacing:0}
.table th,.table td{border:1px solid var(--line);padding:8px;vertical-align:top;text-align:right}
.table thead th{background:#f8fafc;font-weight:800;text-align:right}
.table td.date{background:#fbfdff;white-space:nowrap;font-weight:800}
.badge{display:inline-block;padding:2px 8px;border-radius:999px}
.badge.ok{background:var(--okbg);color:var(--ok)}
.badge.low{background:var(--lowbg);color:var(--low)}
.badge.high{background:var(--highbg);color:var(--high)}
.controls{display:grid;gap:10px;grid-template-columns:repeat(4,minmax(0,1fr))}
@media(max-width:900px){.controls{grid-template-columns:1fr 1fr}}
@media(max-width:600px){.controls{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <div>متابعة الطبيب — ملخص القياسات</div>
  <div>
    <a class="btn" href="dashboard.html">رجوع</a>
    <button id="btnPrint" class="btn" type="button">طباعة PDF</button>
    <button id="btnXLSX"  class="btn" type="button">تصدير Excel</button>
  </div>
</header>

<main>
  <!-- معلومات الطفل المختصره -->
  <section class="card" id="childCard">
    <div id="childTitle" style="font-weight:800;margin-bottom:6px">الطفل: —</div>
    <div id="meta" class="small">تحميل...</div>
    <div id="chips" class="kv" style="margin-top:8px"></div>
  </section>

  <!-- فلاتر الفترة -->
  <section class="card">
    <div class="controls">
      <div>
        <label class="small">من تاريخ</label>
        <input id="from" type="date">
      </div>
      <div>
        <label class="small">إلى تاريخ</label>
        <input id="to" type="date">
      </div>
      <div style="display:flex;align-items:end">
        <button id="run" style="width:100%;padding:10px;border:none;border-radius:10px;background:var(--brand);color:#fff;font-weight:800;cursor:pointer">
          عرض المتابعة
        </button>
      </div>
    </div>
  </section>

  <!-- ملخص -->
  <section class="card">
    <div style="display:grid;gap:10px;grid-template-columns:repeat(7,minmax(0,1fr))">
      <div><div class="small">عدد القراءات</div><div id="s_total" style="font-weight:800">—</div></div>
      <div><div class="small">منخفض</div><div id="s_low" style="font-weight:800">—</div></div>
      <div><div class="small">طبيعي</div><div id="s_ok" style="font-weight:800">—</div></div>
      <div><div class="small">مرتفع</div><div id="s_high" style="font-weight:800">—</div></div>
      <div><div class="small">% داخل النطاق</div><div id="s_tir" style="font-weight:800">—%</div></div>
      <div><div class="small">متوسط القراءة</div><div id="s_avg" style="font-weight:800">—</div></div>
      <div><div class="small">أعلى / أقل</div><div id="s_minmax" style="font-weight:800">—</div></div>
    </div>
  </section>

  <!-- جدول -->
  <section class="card">
    <table class="table">
      <thead>
        <tr>
          <th>التاريخ</th>
          <th>قبل الإفطار</th><th>بعد الإفطار</th>
          <th>قبل الغداء</th><th>بعد الغداء</th>
          <th>قبل العشاء</th><th>بعد العشاء</th>
          <th>قبل النوم</th><th>أثناء النوم</th><th>عند الاستيقاظ</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="10" class="small">حددي الفترة ثم اضغطي عرض المتابعة.</td></tr>
      </tbody>
    </table>
  </section>
</main>

<!-- XLSX مكتبة عالمية -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script type="module">
/* Firebase */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, getDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

/* إعدادات المشروع */
const firebaseConfig = {
  apiKey:"AIzaSyCOdrwdbw8b7YdWLPZ4TDdG2iS9kvvxQ7M",
  authDomain:"child-glucose-tracker.firebaseapp.com",
  projectId:"child-glucose-tracker",
  storageBucket:"child-glucose-tracker.firebasestorage.app",
  messagingSenderId:"294563325904",
  appId:"1:294563325904:web:39562550bf305fc01abbd5"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* أدوات مساعدة */
function $(s){return document.querySelector(s);}
function escapeHTML(str){return (str||'').replace(/[&<>\"']/g,function(c){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c];});}
const labels={preBreakfast:'قبل الإفطار',postBreakfast:'بعد الإفطار',preLunch:'قبل الغداء',postLunch:'بعد الغداء',preDinner:'قبل العشاء',postDinner:'بعد العشاء',beforeSleep:'قبل النوم',duringSleep:'أثناء النوم',uponWake:'عند الاستيقاظ'};
const order=['preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep','uponWake'];

/* حالة عامة */
let uid=null;
let childId=new URL(location.href).searchParams.get('child'); // لازم يكون موجود
let childDoc=null;        // بيانات الطفل
let preferredUnit='mmol'; // mmol أو mgdl
let cachedDetailed=[];    // للتصدير

/* تأكيد تسجيل الدخول */
onAuthStateChanged(auth, async function(u){
  if(!u){ location.href='index.html'; return; }
  uid=u.uid;
  // ضبط تاريخ افتراضي اليوم
  const iso=(new Date()).toISOString().slice(0,10);
  $('#from').value=iso; $('#to').value=iso;

  if(!childId){ // لو مفيش child في الرابط
    $('#childTitle').textContent='الطفل: غير محدد';
    $('#meta').textContent='افتح الصفحة من زر "متابعة الطبيب" أسفل بطاقة الطفل.';
    return;
  }
  await loadChild();
});

/* تحميل بيانات الطفل */
async function loadChild(){
  const snap=await getDoc(doc(db,'users',uid,'children',childId));
  childDoc=snap.data()||{};
  preferredUnit = childDoc.preferredUnit || 'mmol';

  // عنوان الطفل وملخص ثابت
  $('#childTitle').textContent = 'الطفل: ' + (childDoc.name || '—');
  const civil   = childDoc.childCivilId || '—';
  const wt      = (childDoc.weight!=null)? childDoc.weight : '—';
  const ht      = (childDoc.height!=null)? childDoc.height : '—';
  const lo      = (childDoc.lowThreshold!=null)? childDoc.lowThreshold : '—';
  const hi      = (childDoc.highThreshold!=null)? childDoc.highThreshold : '—';
  const unitTxt = (preferredUnit==='mgdl')? 'mg/dL' : 'mmol/L';

  $('#meta').innerHTML = 'الرقم المدني: '+escapeHTML(civil)+
                         ' • الوحدة: '+unitTxt+
                         ' • الطول: '+ht+' سم • الوزن: '+wt+' كجم'+
                         ' • الحدود: منخفض < '+lo+' — مرتفع > '+hi;

  // شباتس معلومات سريعة (ICR/CF/أوقات الوجبات/جرعات)
  const chips=$('#chips'); chips.innerHTML='';
  function addChip(txt){ const s=document.createElement('span'); s.className='chip'; s.textContent=txt; chips.appendChild(s); }
  if(childDoc.icr!=null) addChip('ICR: 1u-'+childDoc.icr);
  if(childDoc.correctionFactorMmol!=null) addChip('CF: '+childDoc.correctionFactorMmol+' mmol/L لكل 1U');
  if(childDoc.correctionFactorMgDl!=null) addChip('CF: '+childDoc.correctionFactorMgDl+' mg/dL لكل 1U');
  if(childDoc.tresiba!=null) addChip('تريسيبا: '+childDoc.tresiba);
  if(childDoc.novo!=null) addChip('نوفو: '+childDoc.novo);
  if(childDoc.breakfast) addChip('فطور: '+childDoc.breakfast);
  if(childDoc.lunch)     addChip('غداء: '+childDoc.lunch);
  if(childDoc.dinner)    addChip('عشاء: '+childDoc.dinner);
}

/* أزرار */
document.getElementById('btnPrint').addEventListener('click', function(){ window.print(); });
document.getElementById('btnXLSX').addEventListener('click', exportXLSX);
document.getElementById('run').addEventListener('click', buildReport);

/* بناء التقرير */
async function buildReport(){
  if(!childDoc){ alert('لا يوجد طفل محدد.'); return; }
  const from=$('#from').value, to=$('#to').value;
  if(!from||!to){ alert('حددي الفترة أولاً.'); return; }

  const col=collection(db,'users',uid,'children',childId,'measurements');
  const qy=query(col, where('date','>=',from), where('date','<=',to), orderBy('date','asc'));
  const qs=await getDocs(qy);

  let total=0,cLow=0,cOk=0,cHigh=0,sum=0,minR=Infinity,maxR=-Infinity,minD='—',maxD='—';
  cachedDetailed=[];
  const tbody=$('#rows'); tbody.innerHTML='';

  if(qs.empty){
    tbody.innerHTML='<tr><td colspan="10" class="small">لا توجد قراءات في هذه الفترة.</td></tr>';
  }else{
    qs.forEach(function(s){
      const d=s.data(); const readings=d.readings||{};
      const tr=document.createElement('tr');
      const tdDate=document.createElement('td'); tdDate.className='date'; tdDate.textContent=d.date; tr.appendChild(tdDate);

      const rowExport={date:d.date};

      order.forEach(function(slot){
        const r=readings[slot]; const td=document.createElement('td');
        if(!r||r.value==null){ td.textContent='—'; rowExport[slot]=''; }
        else{
          const mmol=Number(r.value)||0;
          const disp=(preferredUnit==='mgdl')? (Math.round(mmol*18)+' mg/dL') : (mmol.toFixed(1)+' mmol/L');
          const st   = r.status || (mmol<Number(childDoc.lowThreshold)?'low':(mmol>Number(childDoc.highThreshold)?'high':'ok'));
          const cls  = (st==='low')?'low':((st==='high')?'high':'ok');
          const name = (st==='ok')?'طبيعي':((st==='low')?'منخفض':'مرتفع');

          td.innerHTML = '<div><b>'+disp+'</b> <span class="badge '+cls+'">'+name+'</span></div>'+
                         (r.mealDose!=null?('<div class="small">جرعة: '+r.mealDose+'U</div>'):'')+
                         (r.correctionGiven!=null?('<div class="small">تصحيحي: '+r.correctionGiven+'U</div>'):'')+
                         ((r.note||r.raisedWith)?('<div class="small">ملاحظة: '+escapeHTML(r.note||r.raisedWith)+'</div>'):'');
          rowExport[slot]=disp+
            (r.mealDose!=null?(' | جرعة: '+r.mealDose+'U'):'')+
            (r.correctionGiven!=null?(' | تصحيحي: '+r.correctionGiven+'U'):'')+
            ((r.note||r.raisedWith)?(' | ملاحظة: '+(r.note||r.raisedWith)):'');
          total++; sum+=mmol;
          if(st==='low')cLow++; else if(st==='high')cHigh++; else cOk++;
          if(mmol<minR){minR=mmol; minD=d.date;} if(mmol>maxR){maxR=mmol; maxD=d.date;}
        }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
      cachedDetailed.push(rowExport);
    });
  }

  $('#s_total').textContent=total;
  $('#s_low').textContent=cLow;
  $('#s_ok').textContent=cOk;
  $('#s_high').textContent=cHigh;
  const tir = total? Math.round((cOk/total)*100) : 0;
  $('#s_tir').textContent = tir + '%';
  $('#s_avg').textContent = total? (sum/total).toFixed(1) + ' mmol/L' : '—';
  // مفيش أي محارف غريبة هنا
  $('#s_minmax').textContent = (isFinite(minR)&&isFinite(maxR)) ? (minR.toFixed(1)+' / '+maxR.toFixed(1)+' mmol/L ('+minD+' - '+maxD+')') : '—';
}

/* تصدير Excel */
function exportXLSX(){
  const XLSX=window.XLSX;
  if(!XLSX){ alert('XLSX library not loaded'); return; }

  const childName=(childDoc && childDoc.name)? childDoc.name : 'child';
  const from=$('#from').value, to=$('#to').value;

  const head=['التاريخ']; order.forEach(function(k){ head.push(labels[k]); });
  const rows=cachedDetailed.map(function(r){
    const a=[r.date]; order.forEach(function(k){ a.push(r[k]||''); }); return a;
  });

  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([
    ['الفترة', from+' -> '+to],
    ['عدد القراءات', $('#s_total').textContent],
    ['منخفض', $('#s_low').textContent],
    ['طبيعي', $('#s_ok').textContent],
    ['مرتفع', $('#s_high').textContent],
    ['داخل النطاق %', $('#s_tir').textContent],
    ['متوسط القراءة', $('#s_avg').textContent],
    ['أعلى / أقل', $('#s_minmax').textContent]
  ]), 'Summary');

  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([head].concat(rows)), 'Detailed');
  XLSX.writeFile(wb, 'doctor_followup_'+childName+'_'+from+'_to_'+to+'.xlsx');
}
</script>
</body>
</html>
