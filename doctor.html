<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>متابعة الطبيب — ملخص القياسات</title>
<style>
:root{
  --brand:#0ea5e9;--brand2:#6ee7b7;--line:#e5e7eb;--ink:#0f172a;--muted:#6b7280;
  --bg:#f6fbff;--card:#fff;--ok:#16a34a;--low:#b45309;--high:#dc2626;
  --okbg:#ecfdf5;--lowbg:#fff7ed;--highbg:#fee2e2;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.55 system-ui,"Tajawal","Noto Sans Arabic",sans-serif}
header{position:sticky;top:0;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;padding:12px 14px;display:flex;justify-content:space-between;align-items:center;z-index:5}
header .btn{color:#fff;text-decoration:none;border:1px solid #ffffff66;padding:8px 12px;border-radius:10px;margin-inline-start:6px;background:#ffffff22}
main{max-width:1100px;margin:auto;padding:16px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:0 6px 24px rgba(0,0,0,.04);margin-bottom:12px}

label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
input,select{width:100%;padding:9px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}
.grid{display:grid;gap:10px}
.g4{grid-template-columns:repeat(4,minmax(0,1fr))}
@media(max-width:900px){.g4{grid-template-columns:1fr 1fr}}
.controls .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:end}
.btn-main{padding:10px;border:none;border-radius:10px;background:var(--brand);color:#fff;font-weight:800;cursor:pointer}

.summary{display:grid;grid-template-columns:repeat(7,minmax(0,1fr));gap:10px}
@media(max-width:1000px){.summary{grid-template-columns:repeat(3,minmax(0,1fr))}}
.sum{border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px;text-align:center}
.sum .k{font-size:12px;color:var(--muted)}
.sum .v{font-size:20px;font-weight:900;margin-top:4px}
.sum.low{background:var(--lowbg);color:var(--low)}
.sum.ok{background:var(--okbg);color:var(--ok)}
.sum.high{background:var(--highbg);color:var(--high)}

.small{font-size:12px;color:var(--muted)}
.table{width:100%;border-collapse:separate;border-spacing:0}
.table th,.table td{border:1px solid var(--line);padding:8px;vertical-align:top;text-align:right}
.table thead th{background:#f8fafc;font-weight:800;text-align:right}
.table td.date{background:#fbfdff;white-space:nowrap;font-weight:800}
.badge{display:inline-block;padding:2px 8px;border-radius:999px}
.badge.ok{background:var(--okbg);color:var(--ok)}
.badge.low{background:var(--lowbg);color:var(--low)}
.badge.high{background:var(--highbg);color:var(--high)}

@media print{
  @page{ size: A4 landscape; margin: 8mm }
  header,.controls{display:none!important}
  body{background:#fff;font-size:11px}
  .card{border:0;box-shadow:none;padding:0;margin:0}
  .table th,.table td{padding:4px}
}
</style>
</head>
<body>
<header>
  <div>متابعة الطبيب — ملخص القياسات</div>
  <div>
    <a class="btn" href="dashboard.html">رجوع</a>
    <button id="btnPrint" class="btn" type="button">طباعة PDF</button>
    <button id="btnXLSX"  class="btn" type="button">تصدير Excel</button>
  </div>
</header>

<main>
  <!-- اختيارات -->
  <section class="card controls">
    <div class="grid g4">
      <div>
        <label>الطفل</label>
        <select id="childSel"><option value="">— اختاري الطفل —</option></select>
      </div>
      <div><label>من تاريخ</label><input id="from" type="date"></div>
      <div><label>إلى تاريخ</label><input id="to" type="date"></div>
      <div class="actions"><button id="run" class="btn-main" style="width:100%">عرض المتابعة</button></div>
    </div>
    <div id="meta" class="small" style="margin-top:6px"></div>
  </section>

  <!-- ملخص -->
  <section class="card">
    <div class="summary">
      <div class="sum"><div class="k">عدد القراءات</div><div class="v" id="s_total">—</div></div>
      <div class="sum low"><div class="k">منخفض</div><div class="v" id="s_low">—</div></div>
      <div class="sum ok"><div class="k">طبيعي</div><div class="v" id="s_ok">—</div></div>
      <div class="sum high"><div class="k">مرتفع</div><div class="v" id="s_high">—</div></div>
      <div class="sum"><div class="k">% داخل النطاق</div><div class="v" id="s_tir">—%</div></div>
      <div class="sum"><div class="k">متوسط القراءة</div><div class="v" id="s_avg">—</div></div>
      <div class="sum"><div class="k">أعلى / أقل</div><div class="v" id="s_minmax">—</div></div>
    </div>
  </section>

  <!-- مخططات -->
  <section class="card">
    <div class="grid" style="grid-template-columns:1fr 1fr">
      <canvas id="chartDaily"></canvas>
      <canvas id="chartSlots"></canvas>
    </div>
  </section>

  <!-- جدول تفصيلي -->
  <section class="card">
    <table class="table">
      <thead>
        <tr>
          <th>التاريخ</th>
          <th>قبل الإفطار</th><th>بعد الإفطار</th>
          <th>قبل الغداء</th><th>بعد الغداء</th>
          <th>قبل العشاء</th><th>بعد العشاء</th>
          <th>قبل النوم</th><th>أثناء النوم</th><th>عند الاستيقاظ</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="10" class="small">اختاري طفلًا وحددي فترة لعرض البيانات.</td></tr>
      </tbody>
    </table>
  </section>
</main>

<!-- مكتبات خارجية -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script type="module">
/* ===== Firebase ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, getDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

var firebaseConfig={
  apiKey:"AIzaSyCOdrwdbw8b7YdWLPZ4TDdG2iS9kvvxQ7M",
  authDomain:"child-glucose-tracker.firebaseapp.com",
  projectId:"child-glucose-tracker",
  storageBucket:"child-glucose-tracker.firebasestorage.app",
  messagingSenderId:"294563325904",
  appId:"1:294563325904:web:39562550bf305fc01abbd5"
};
var app=initializeApp(firebaseConfig);
var auth=getAuth(app);
var db=getFirestore(app);

/* ===== Helpers ===== */
function $(s){ return document.querySelector(s); }
var labels={
  preBreakfast:'قبل الإفطار', postBreakfast:'بعد الإفطار',
  preLunch:'قبل الغداء',     postLunch:'بعد الغداء',
  preDinner:'قبل العشاء',    postDinner:'بعد العشاء',
  beforeSleep:'قبل النوم',   duringSleep:'أثناء النوم', uponWake:'عند الاستيقاظ'
};
var order=['preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep','uponWake'];

var uid=null;
var initChildId=(new URL(location.href)).searchParams.get('child');
var cachedDetailed=[];

/* refs للمخططات */
window.chartDaily=null;
window.chartSlots=null;

/* ===== Auth ===== */
onAuthStateChanged(auth, function(u){
  if(!u){ location.href='index.html'; return; }
  uid=u.uid;
  loadChildren().then(function(){
    setDefaults();
    if(initChildId){
      var opts=$('#childSel').options;
      for(var i=0;i<opts.length;i++){ if(opts[i].value===initChildId){ $('#childSel').value=initChildId; $('#childSel').disabled=true; break; } }
    }
  });
});

/* ===== UI ===== */
function setDefaults(){
  var d=new Date();
  var iso=d.toISOString().slice(0,10);
  $('#from').value=iso; $('#to').value=iso;
}
async function loadChildren(){
  var sel=$('#childSel');
  sel.innerHTML='<option value="">— تحميل —</option>';
  var q=await getDocs(collection(db,'users',uid,'children'));
  sel.innerHTML='<option value="">— اختاري الطفل —</option>';
  q.forEach(function(s){
    var o=document.createElement('option');
    o.value=s.id; o.textContent=(s.data().name||'بدون اسم'); sel.appendChild(o);
  });
}

/* ===== Events ===== */
$('#btnPrint').addEventListener('click', function(){ window.print(); });
$('#btnXLSX').addEventListener('click', exportXLSX);
$('#run').addEventListener('click', buildReport);

/* ===== Build Report ===== */
async function buildReport(){
  var id=$('#childSel').value, from=$('#from').value, to=$('#to').value;
  if(!id||!from||!to){ alert('اختاري الطفل وحددي الفترة'); return; }

  // meta
  var cs=await getDoc(doc(db,'users',uid,'children',id)); var c=cs.data()||{};
  var name=(c.name||'—'), wt=(c.weight!=null?c.weight:'—'), ht=(c.height!=null?c.height:'—');
  var lo=(c.lowThreshold!=null?c.lowThreshold:'—'), hi=(c.highThreshold!=null?c.highThreshold:'—');
  $('#meta').innerHTML='الاسم: '+name+' • الوزن: '+wt+' كجم • الطول: '+ht+' سم • حدود: منخفض &lt; '+lo+' — مرتفع &gt; '+hi+' • الفترة: '+from+' → '+to;

  // query
  var col=collection(db,'users',uid,'children',id,'measurements');
  var qy=query(col, where('date','>=',from), where('date','<=',to), orderBy('date','asc'));
  var qs=await getDocs(qy);

  // aggregates
  var total=0,cLow=0,cOk=0,cHigh=0,sum=0,minR=Infinity,maxR=-Infinity,minD='—',maxD='—';
  var slotAgg={}; for(var si=0;si<order.length;si++){ slotAgg[order[si]]={sum:0,count:0}; }
  cachedDetailed=[];
  var dailyAvgLabels=[], dailyAvgValues=[];
  var tbody=$('#rows'); tbody.innerHTML='';

  if(qs.empty){
    tbody.innerHTML='<tr><td colspan="10" class="small">لا توجد قراءات في هذه الفترة.</td></tr>';
  }else{
    qs.forEach(function(s){
      var d=s.data(); var readings=d.readings||{};
      var daySum=0, dayCnt=0;

      var tr=document.createElement('tr');
      var tdDate=document.createElement('td'); tdDate.className='date'; tdDate.textContent=d.date; tr.appendChild(tdDate);

      var rowExport={date:d.date};

      for(var j=0;j<order.length;j++){
        var slot=order[j]; var r=readings[slot];
        var td=document.createElement('td');

        if(!r || r.value==null){
          td.textContent='—'; rowExport[slot]='';
        }else{
          var val=Number(r.value)||0;
          total++; sum+=val;
          if(r.status==='low') cLow++; else if(r.status==='high') cHigh++; else cOk++;
          if(val<minR){minR=val; minD=d.date;} if(val>maxR){maxR=val; maxD=d.date;}
          daySum+=val; dayCnt++;
          slotAgg[slot].sum+=val; slotAgg[slot].count++;

          var cls=(r.status==='low')?'low':((r.status==='high')?'high':'ok');
          var statusName=(cls==='ok')?'طبيعي':((cls==='low')?'منخفض':'مرتفع');
          var badge='<span class="badge '+cls+'">'+statusName+'</span>';
          var meal=(r.mealDose!=null)?('جرعة: '+r.mealDose+'U'):'';
          var corr=(r.correctionGiven!=null)?('تصحيحي: '+r.correctionGiven+'U'):'';
          var note=(r.note?r.note:(r.raisedWith?r.raisedWith:''))||'';

          td.innerHTML='<div><b>'+r.value+'</b> '+badge+'</div>'
                       +(meal?('<div class="small">'+meal+'</div>'):'')
                       +(corr?('<div class="small">'+corr+'</div>'):'')
                       +(note?('<div class="small">ملاحظة: '+escapeHTML(note)+'</div>'):'');
          rowExport[slot]= r.value + (meal?(' | '+meal):'') + (corr?(' | '+corr):'') + (note?(' | ملاحظة: '+note):'');
        }
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
      cachedDetailed.push(rowExport);

      dailyAvgLabels.push(d.date);
      dailyAvgValues.push(dayCnt? Number((daySum/dayCnt).toFixed(2)) : null);
    });
  }

  // summary
  $('#s_total').textContent=total;
  $('#s_low').textContent=cLow;
  $('#s_ok').textContent=cOk;
  $('#s_high').textContent=cHigh;
  var tir= total? Math.round((cOk/total)*100) : 0;
  $('#s_tir').textContent=(tir+'%');
  $('#s_avg').textContent= total? (sum/total).toFixed(1) : '—';
  $('#s_minmax').textContent = (isFinite(minR)&&isFinite(maxR)) ? (minR+' ('+minD+') / '+maxR+' ('+maxD+')') : '—';

  renderCharts(dailyAvgLabels, dailyAvgValues, slotAgg);
}

/* ===== Charts (نسخة مبسطة) ===== */
function renderCharts(dailyLabels, dailyValues, slotAgg){
  var ctx1=document.getElementById('chartDaily');
  var ctx2=document.getElementById('chartSlots');

  if(window.chartDaily){ window.chartDaily.destroy(); }
  if(window.chartSlots){ window.chartSlots.destroy(); }

  window.chartDaily=new Chart(ctx1,{
    type:'line',
    data:{
      labels: dailyLabels,
      datasets:[{
        label:'متوسط اليوم (mmol/L)',
        data: dailyValues,
        borderColor:'#0ea5e9',
        backgroundColor:'rgba(14,165,233,.15)',
        tension:0.3,
        spanGaps:true
      }]
    },
    options:{ plugins:{legend:{display:true}}, scales:{x:{ticks:{autoSkip:true,maxTicksLimit:14}} } }
  });

  var slotLabels=[]; var slotMeans=[];
  for(var i=0;i<order.length;i++){
    var k=order[i]; slotLabels.push(labels[k]);
    var a=slotAgg[k]||{sum:0,count:0}; slotMeans.push( a.count? Number((a.sum/a.count).toFixed(2)) : 0 );
  }

  window.chartSlots=new Chart(ctx2,{
    type:'bar',
    data:{
      labels: slotLabels,
      datasets:[{ label:'متوسط الوقت', data: slotMeans, backgroundColor:'#6ee7b7', borderColor:'#059669' }]
    },
    options:{ plugins:{legend:{display:true}}, scales:{x:{ticks:{autoSkip:false}} } }
  });
}

/* ===== Excel ===== */
function exportXLSX(){
  var sel=$('#childSel'); var childText=(sel && sel.selectedOptions && sel.selectedOptions[0])? sel.selectedOptions[0].textContent : 'child';
  var from=$('#from').value, to=$('#to').value;

  var head=['التاريخ'];
  for(var i=0;i<order.length;i++){ head.push(labels[order[i]]); }

  var rows=[];
  for(var r=0;r<cachedDetailed.length;r++){
    var row=cachedDetailed[r];
    var arr=[row.date];
    for(var j=0;j<order.length;j++){ var k=order[j]; arr.push(row[k]?row[k]:''); }
    rows.push(arr);
  }

  var wb=XLSX.utils.book_new();
  var summaryAoA=[
    ['الفترة', from+' → '+to],
    ['عدد القراءات', document.getElementById('s_total').textContent],
    ['منخفض', document.getElementById('s_low').textContent],
    ['طبيعي', document.getElementById('s_ok').textContent],
    ['مرتفع', document.getElementById('s_high').textContent],
    ['داخل النطاق %', document.getElementById('s_tir').textContent],
    ['متوسط القراءة', document.getElementById('s_avg').textContent],
    ['أعلى / أقل', document.getElementById('s_minmax').textContent]
  ];
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summaryAoA), 'Summary');

  var detailedAoA=[head];
  for(var rr=0; rr<rows.length; rr++){ detailedAoA.push(rows[rr]); }
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(detailedAoA), 'Detailed');

  XLSX.writeFile(wb, 'doctor_followup_'+childText+'_'+from+'_to_'+to+'.xlsx');
}

/* ===== Utils ===== */
function escapeHTML(str){
  str = str || '';
  return str.replace(/[&<>"']/g,function(c){
    var m={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}; return m[c];
  });
}
</script>
</body>
</html>
