<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>متابعة الطبيب — ملخص القياسات</title>
<style>
:root{
  --brand:#0ea5e9;--brand2:#6ee7b7;--line:#e5e7eb;--ink:#0f172a;--muted:#6b7280;
  --bg:#f6fbff;--card:#fff;--ok:#16a34a;--low:#b45309;--high:#dc2626;
  --okbg:#ecfdf5;--lowbg:#fff7ed;--highbg:#fee2e2;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.55 system-ui,"Tajawal","Noto Sans Arabic",sans-serif}
header{position:sticky;top:0;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;padding:12px 14px;display:flex;justify-content:space-between;align-items:center;z-index:5}
header .btn{color:#fff;text-decoration:none;border:1px solid #ffffff66;padding:8px 12px;border-radius:10px;margin-inline-start:6px;background:#ffffff22}
main{max-width:1100px;margin:auto;padding:16px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:0 6px 24px rgba(0,0,0,.04);margin-bottom:12px}
.small{font-size:12px;color:var(--muted)}
.table{width:100%;border-collapse:separate;border-spacing:0}
.table th,.table td{border:1px solid var(--line);padding:8px;vertical-align:top;text-align:right}
.table thead th{background:#f8fafc;font-weight:800;text-align:right}
.table td.date{background:#fbfdff;white-space:nowrap;font-weight:800}
.badge{display:inline-block;padding:2px 8px;border-radius:999px}
.badge.ok{background:var(--okbg);color:var(--ok)}
.badge.low{background:var(--lowbg);color:var(--low)}
.badge.high{background:var(--highbg);color:var(--high)}
</style>
</head>
<body>
<header>
  <div>متابعة الطبيب — ملخص القياسات</div>
  <div>
    <a class="btn" href="dashboard.html">رجوع</a>
    <button id="btnPrint" class="btn" type="button">طباعة PDF</button>
    <button id="btnXLSX"  class="btn" type="button">تصدير Excel</button>
  </div>
</header>

<main>
  <!-- فلاتر -->
  <section class="card">
    <div style="display:grid;gap:10px;grid-template-columns:repeat(4,minmax(0,1fr))">
      <div>
        <label class="small">الطفل</label>
        <select id="childSel"><option value="">— اختاري الطفل —</option></select>
      </div>
      <div><label class="small">من تاريخ</label><input id="from" type="date"></div>
      <div><label class="small">إلى تاريخ</label><input id="to" type="date"></div>
      <div style="display:flex;align-items:end">
        <button id="run" style="width:100%;padding:10px;border:none;border-radius:10px;background:var(--brand);color:#fff;font-weight:800;cursor:pointer">
          عرض المتابعة
        </button>
      </div>
    </div>
    <div id="meta" class="small" style="margin-top:6px"></div>
  </section>

  <!-- ملخص -->
  <section class="card">
    <div style="display:grid;gap:10px;grid-template-columns:repeat(7,minmax(0,1fr))">
      <div><div class="small">عدد القراءات</div><div id="s_total" style="font-weight:800">—</div></div>
      <div><div class="small">منخفض</div><div id="s_low" style="font-weight:800">—</div></div>
      <div><div class="small">طبيعي</div><div id="s_ok" style="font-weight:800">—</div></div>
      <div><div class="small">مرتفع</div><div id="s_high" style="font-weight:800">—</div></div>
      <div><div class="small">% داخل النطاق</div><div id="s_tir" style="font-weight:800">—%</div></div>
      <div><div class="small">متوسط القراءة</div><div id="s_avg" style="font-weight:800">—</div></div>
      <div><div class="small">أعلى / أقل</div><div id="s_minmax" style="font-weight:800">—</div></div>
    </div>
  </section>

  <!-- جدول -->
  <section class="card">
    <table class="table">
      <thead>
        <tr>
          <th>التاريخ</th>
          <th>قبل الإفطار</th><th>بعد الإفطار</th>
          <th>قبل الغداء</th><th>بعد الغداء</th>
          <th>قبل العشاء</th><th>بعد العشاء</th>
          <th>قبل النوم</th><th>أثناء النوم</th><th>عند الاستيقاظ</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="10" class="small">اختاري طفلًا وحددي فترة لعرض البيانات.</td></tr>
      </tbody>
    </table>
  </section>
</main>

<!-- نحمل مكتبة XLSX كـ global لتجنّب import الديناميكي -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script type="module">
/* ================= Firebase ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, getDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

/* -------- إعدادات -------- */
const firebaseConfig = {
  apiKey: "AIzaSyCOdrwdbw8b7YdWLPZ4TDdG2iS9kvvxQ7M",
  authDomain: "child-glucose-tracker.firebaseapp.com",
  projectId: "child-glucose-tracker",
  storageBucket: "child-glucose-tracker.firebasestorage.app",
  messagingSenderId: "294563325904",
  appId: "1:294563325904:web:39562550bf305fc01abbd5"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* -------- أدوات -------- */
function $(s){ return document.querySelector(s); }
const labels = {
  preBreakfast:'قبل الإفطار', postBreakfast:'بعد الإفطار',
  preLunch:'قبل الغداء',     postLunch:'بعد الغداء',
  preDinner:'قبل العشاء',    postDinner:'بعد العشاء',
  beforeSleep:'قبل النوم',   duringSleep:'أثناء النوم', uponWake:'عند الاستيقاظ'
};
const order = ['preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep','uponWake'];

/* -------- حالة عامة -------- */
let uid = null;
const initChildId = new URL(location.href).searchParams.get('child');
let preferredUnit = 'mmol';
let cachedDetailed = [];

/* ================= Auth ================= */
onAuthStateChanged(auth, async function(u){
  if(!u){ location.href = 'index.html'; return; }
  uid = u.uid;
  await loadChildren();
  setDefaults();
  if(initChildId){
    var list = Array.prototype.slice.call($('#childSel').options);
    var opt = list.find(function(o){ return o.value === initChildId; });
    if(opt){ $('#childSel').value = initChildId; $('#childSel').disabled = true; }
  }
});

/* ================= UI ================= */
function setDefaults(){
  var iso = new Date().toISOString().slice(0,10);
  $('#from').value = iso;
  $('#to').value   = iso;
}
async function loadChildren(){
  var sel = $('#childSel');
  sel.innerHTML = '<option value="">— تحميل —</option>';
  var q = await getDocs(collection(db,'users',uid,'children'));
  sel.innerHTML = '<option value="">— اختاري الطفل —</option>';
  q.forEach(function(s){
    var o = document.createElement('option');
    o.value = s.id;
    o.textContent = (s.data().name || 'بدون اسم');
    sel.appendChild(o);
  });
}

/* أزرار */
$('#btnPrint').addEventListener('click', function(){ window.print(); });
$('#btnXLSX').addEventListener('click', exportXLSX);
$('#run').addEventListener('click', buildReport);

/* ================= بناء التقرير ================= */
async function buildReport(){
  var id   = $('#childSel').value;
  var from = $('#from').value;
  var to   = $('#to').value;
  if(!id || !from || !to){ alert('اختاري الطفل وحددي الفترة'); return; }

  // بيانات الطفل
  var cs = await getDoc(doc(db,'users',uid,'children',id));
  var c  = cs.data() || {};
  preferredUnit = c.preferredUnit || 'mmol';
  var civil = (c.childCivilId || '—');
  var name  = (c.name || '—');
  var wt    = (c.weight != null ? c.weight : '—');
  var ht    = (c.height != null ? c.height : '—');
  var lo    = (c.lowThreshold != null ? c.lowThreshold : '—');
  var hi    = (c.highThreshold != null ? c.highThreshold : '—');

  $('#meta').innerHTML =
    'الاسم: ' + name +
    ' • الرقم المدني: ' + civil +
    ' • الوزن: ' + wt + ' كجم' +
    ' • الطول: ' + ht + ' سم' +
    ' • حدود: منخفض &lt; ' + lo + ' — مرتفع &gt; ' + hi +
    ' • الفترة: ' + from + ' → ' + to +
    ' • الوحدة: ' + (preferredUnit === 'mgdl' ? 'mg/dL' : 'mmol/L');

  // جلب القياسات
  var col = collection(db,'users',uid,'children',id,'measurements');
  var qy  = query(col, where('date','>=',from), where('date','<=',to), orderBy('date','asc'));
  var qs  = await getDocs(qy);

  var total=0, cLow=0, cOk=0, cHigh=0;
  var sum=0, minR=Infinity, maxR=-Infinity, minD='—', maxD='—';
  cachedDetailed = [];
  var tbody = $('#rows'); tbody.innerHTML = '';

  if(qs.empty){
    tbody.innerHTML = '<tr><td colspan="10" class="small">لا توجد قراءات.</td></tr>';
  }else{
    qs.forEach(function(snap){
      var d = snap.data();
      var readings = d.readings || {};
      var tr = document.createElement('tr');
      var tdDate = document.createElement('td');
      tdDate.className = 'date';
      tdDate.textContent = d.date;
      tr.appendChild(tdDate);

      var rowExport = { date: d.date };

      order.forEach(function(slot){
        var r = readings[slot];
        var td = document.createElement('td');

        if(!r || r.value == null){
          td.textContent = '—';
          rowExport[slot] = '';
        }else{
          var mmol = Number(r.value) || 0;
          var disp = (preferredUnit === 'mgdl') ? (Math.round(mmol*18) + ' mg/dL')
                                               : (mmol.toFixed(1) + ' mmol/L');

          var st = r.status || (mmol < Number(c.lowThreshold) ? 'low'
                    : (mmol > Number(c.highThreshold) ? 'high' : 'ok'));
          var cls = (st === 'low') ? 'low' : ((st === 'high') ? 'high' : 'ok');
          var badge = '<span class="badge ' + cls + '">' +
                      (st === 'ok' ? 'طبيعي' : (st === 'low' ? 'منخفض' : 'مرتفع')) +
                      '</span>';

          var meal = (r.mealDose != null) ? ('<div class="small">جرعة: ' + r.mealDose + 'U</div>') : '';
          var corr = (r.correctionGiven != null) ? ('<div class="small">تصحيحي: ' + r.correctionGiven + 'U</div>') : '';
          var note = (r.note || r.raisedWith) ? ('<div class="small">ملاحظة: ' + (r.note || r.raisedWith) + '</div>') : '';

          td.innerHTML = '<div><b>' + disp + '</b> ' + badge + '</div>' + meal + corr + note;

          rowExport[slot] = disp +
            (r.mealDose != null       ? (' | جرعة: ' + r.mealDose + 'U')       : '') +
            (r.correctionGiven != null ? (' | تصحيحي: ' + r.correctionGiven + 'U') : '') +
            ((r.note || r.raisedWith)  ? (' | ملاحظة: ' + (r.note || r.raisedWith)) : '');

          total++;
          sum += mmol;
          if(st === 'low') cLow++; else if(st === 'high') cHigh++; else cOk++;
          if(mmol < minR){ minR = mmol; minD = d.date; }
          if(mmol > maxR){ maxR = mmol; maxD = d.date; }
        }

        tr.appendChild(td);
      });

      tbody.appendChild(tr);
      cachedDetailed.push(rowExport);
    });
  }

  $('#s_total').textContent = total;
  $('#s_low').textContent   = cLow;
  $('#s_ok').textContent    = cOk;
  $('#s_high').textContent  = cHigh;

  var tir = total ? Math.round((cOk/total)*100) : 0;
  $('#s_tir').textContent = tir + '%';

  $('#s_avg').textContent =
    total ? (sum/total).toFixed(1) + ' mmol/L' : '—';

  $('#s_minmax').textContent =
    (isFinite(minR) && isFinite(maxR))
      ? (minR.toFixed(1) + ' / ' + maxR.toFixed(1) + ' mmol/L (' + minD + ' — ' + maxD + ')'
      : '—';
}

/* ================= تصدير Excel ================= */
function exportXLSX(){
  var XLSX = window.XLSX;
  if(!XLSX){ alert('XLSX library not loaded'); return; }

  var sel = document.querySelector('#childSel');
  var childText = sel && sel.selectedOptions[0] ? sel.selectedOptions[0].textContent : 'child';
  var from = document.querySelector('#from').value;
  var to   = document.querySelector('#to').value;

  var head = ['التاريخ'];
  order.forEach(function(k){ head.push(labels[k]); });

  var rows = cachedDetailed.map(function(r){
    var row = [r.date];
    order.forEach(function(k){ row.push(r[k] || ''); });
    return row;
  });

  var wb = XLSX.utils.book_new();

  var summary = XLSX.utils.aoa_to_sheet([
    ['الفترة',          from + ' → ' + to],
    ['عدد القراءات',    document.querySelector('#s_total').textContent],
    ['منخفض',           document.querySelector('#s_low').textContent],
    ['طبيعي',           document.querySelector('#s_ok').textContent],
    ['مرتفع',           document.querySelector('#s_high').textContent],
    ['داخل النطاق %',   document.querySelector('#s_tir').textContent],
    ['متوسط القراءة',   document.querySelector('#s_avg').textContent],
    ['أعلى / أقل',      document.querySelector('#s_minmax').textContent]
  ]);
  XLSX.utils.book_append_sheet(wb, summary, 'Summary');

  var detailed = XLSX.utils.aoa_to_sheet([head].concat(rows));
  XLSX.utils.book_append_sheet(wb, detailed, 'Detailed');

  XLSX.writeFile(wb, 'doctor_followup_' + childText + '_' + from + '_to_' + to + '.xlsx');
}
</script>
</body>
</html>
