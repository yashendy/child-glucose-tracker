<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>متابعة الطبيب — ملخص القياسات</title>
<style>
:root{
  --brand:#0ea5e9;--brand2:#6ee7b7;--line:#e5e7eb;--ink:#0f172a;--muted:#6b7280;
  --bg:#f6fbff;--card:#fff;--ok:#16a34a;--low:#b45309;--high:#dc2626;
  --okbg:#ecfdf5;--lowbg:#fff7ed;--highbg:#fee2e2;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.55 system-ui,"Tajawal","Noto Sans Arabic",sans-serif}
header{position:sticky;top:0;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;padding:12px 14px;display:flex;justify-content:space-between;align-items:center;z-index:5}
header .btn{color:#fff;text-decoration:none;border:1px solid #ffffff66;padding:8px 12px;border-radius:10px;margin-inline-start:6px;background:#ffffff22;cursor:pointer}
main{max-width:1200px;margin:auto;padding:16px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:0 6px 24px rgba(0,0,0,.04);margin-bottom:12px}
.small{font-size:12px;color:var(--muted)}
.grid{display:grid;gap:10px}
.g4{grid-template-columns:repeat(4,minmax(0,1fr))}
.g3{grid-template-columns:repeat(3,minmax(0,1fr))}
.table{width:100%;border-collapse:separate;border-spacing:0}
.table th,.table td{border:1px solid var(--line);padding:8px;vertical-align:top;text-align:right}
.table thead th{background:#f8fafc;font-weight:800;text-align:right}
.table td.date{background:#fbfdff;white-space:nowrap;font-weight:800}
.badge{display:inline-block;padding:2px 8px;border-radius:999px}
.badge.ok{background:var(--okbg);color:var(--ok)}
.badge.low{background:var(--lowbg);color:var(--low)}
.badge.high{background:var(--highbg);color:var(--high)}
.chip{display:inline-flex;align-items:center;gap:6px;background:#eef6ff;color:#0369a1;border-radius:999px;padding:6px 10px;font-weight:800}
@media print{
  @page{ size: A4; margin: 10mm }
  header,.no-print{display:none!important}
  body{background:#fff}
  /* إخفاء الدونات وقت الطباعة */
  #donutBox{display:none!important}
}
</style>
</head>
<body>
<header>
  <div>متابعة الطبيب — ملخص القياسات</div>
  <div>
    <a class="btn" href="dashboard.html">رجوع</a>
    <button id="btnPrint" class="btn" type="button">طباعة PDF</button>
    <button id="btnXLSX"  class="btn" type="button">تصدير Excel</button>
    <button id="btnPrintTable" class="btn" type="button">جدول القراءات فقط (PDF)</button>
    <button id="btnDoctorLog"  class="btn" type="button">سجل زيارات الطبيب</button>
  </div>
</header>

<main>
  <!-- فلاتر -->
  <section class="card">
    <div class="grid g4">
      <div>
        <label class="small">الطفل</label>
        <select id="childSel"><option value="">— اختاري الطفل —</option></select>
      </div>
      <div><label class="small">من تاريخ</label><input id="from" type="date"></div>
      <div><label class="small">إلى تاريخ</label><input id="to" type="date"></div>
      <div class="no-print" style="display:flex;align-items:end">
        <button id="run" style="width:100%;padding:10px;border:none;border-radius:10px;background:var(--brand);color:#fff;font-weight:800;cursor:pointer">عرض المتابعة</button>
      </div>
    </div>
    <div class="no-print" style="margin-top:10px;display:flex;gap:10px;align-items:center">
      <span class="small">تجميع خط المتوسط:</span>
      <select id="aggSel">
        <option value="daily">يومي</option>
        <option value="weekly">أسبوعي</option>
        <option value="monthly">شهري</option>
        <option value="quarterly">كل 3 شهور</option>
      </select>
    </div>
    <div id="meta" class="small" style="margin-top:8px"></div>
  </section>

  <!-- ملخص -->
  <section class="card">
    <div class="grid g4" style="grid-template-columns:repeat(7,minmax(0,1fr))">
      <div><div class="small">عدد القراءات</div><div id="s_total" style="font-weight:800">—</div></div>
      <div><div class="small">منخفض</div><div id="s_low" style="font-weight:800">—</div></div>
      <div><div class="small">طبيعي</div><div id="s_ok" style="font-weight:800">—</div></div>
      <div><div class="small">مرتفع</div><div id="s_high" style="font-weight:800">—</div></div>
      <div><div class="small">% داخل النطاق</div><div id="s_tir" style="font-weight:800">—%</div></div>
      <div><div class="small">متوسط القراءة</div><div id="s_avg" style="font-weight:800">—</div></div>
      <div><div class="small">أعلى / أقل</div><div id="s_minmax" style="font-weight:800">—</div></div>
    </div>
  </section>

  <!-- رسومات -->
  <section class="card">
    <div class="grid g3" style="grid-template-columns:2fr 2fr 1.2fr;align-items:start">
      <div>
        <div class="small">متوسط كل وقت (mmol/L)</div>
        <canvas id="chartSlots" height="180"></canvas>
      </div>
      <div>
        <div class="small">متوسط اليوم (mmol/L) — حسب التجميع</div>
        <canvas id="chartTrend" height="180"></canvas>
      </div>
      <div id="donutBox">
        <div class="small">نسب Low / OK / High للفترة</div>
        <canvas id="chartDonut" height="180"></canvas>
      </div>
    </div>
  </section>

  <!-- ملخص دوائي -->
  <section class="card">
    <h3 style="margin:0 0 8px">الملخص الدوائي</h3>
    <div class="grid g4">
      <div class="chip">إجمالي جرعات الوجبة: <b id="mealTotal">—</b> U</div>
      <div class="chip">إجمالي التصحيحي: <b id="corrTotal">—</b> U</div>
      <div class="chip">متوسط وجبة/اليوم: <b id="mealPerDay">—</b> U</div>
      <div class="chip">متوسط تصحيحي/اليوم: <b id="corrPerDay">—</b> U</div>
    </div>
  </section>

  <!-- جدول -->
  <section class="card">
    <table class="table">
      <thead>
        <tr>
          <th>التاريخ</th>
          <th>قبل الإفطار</th><th>بعد الإفطار</th>
          <th>قبل الغداء</th><th>بعد الغداء</th>
          <th>قبل العشاء</th><th>بعد العشاء</th>
          <th>قبل النوم</th><th>أثناء النوم</th><th>عند الاستيقاظ</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="10" class="small">اختاري طفلًا وحددي فترة لعرض البيانات.</td></tr>
      </tbody>
    </table>
  </section>
</main>

<!-- مكتبات -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script type="module">
/* ------------ Firebase ------------ */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, getDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig={
  apiKey:"AIzaSyCOdrwdbw8b7YdWLPZ4TDdG2iS9kvvxQ7M",
  authDomain:"child-glucose-tracker.firebaseapp.com",
  projectId:"child-glucose-tracker",
  storageBucket:"child-glucose-tracker.firebasestorage.app",
  messagingSenderId:"294563325904",
  appId:"1:294563325904:web:39562550bf305fc01abbd5"
};
const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

/* ------------ Helpers ------------ */
const $=s=>document.querySelector(s);
const labels={
  preBreakfast:'قبل الإفطار',postBreakfast:'بعد الإفطار',
  preLunch:'قبل الغداء',postLunch:'بعد الغداء',
  preDinner:'قبل العشاء',postDinner:'بعد العشاء',
  beforeSleep:'قبل النوم',duringSleep:'أثناء النوم',uponWake:'عند الاستيقاظ'
};
const order=['preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep','uponWake'];

let uid=null, initChildId=new URL(location.href).searchParams.get('child');
let cachedDetailed=[], dailySeries=[], slotAgg={}, cMeta={};
let chartSlots=null, chartTrend=null, chartDonut=null;

onAuthStateChanged(auth, async (u)=>{
  if(!u){ location.href='index.html'; return; }
  uid=u.uid; await loadChildren(); setDefaults();
  if(initChildId){
    const opts=[...$('#childSel').options];
    const o=opts.find(x=>x.value===initChildId);
    if(o){ $('#childSel').value=initChildId; $('#childSel').disabled=true; }
  }
});

function setDefaults(){
  const iso=new Date().toISOString().slice(0,10);
  $('#from').value=iso; $('#to').value=iso;
}
async function loadChildren(){
  const sel=$('#childSel');
  sel.innerHTML='<option value="">— تحميل —</option>';
  const q=await getDocs(collection(db,'users',uid,'children'));
  sel.innerHTML='<option value="">— اختاري الطفل —</option>';
  q.forEach(s=>{
    const o=document.createElement('option');
    o.value=s.id; o.textContent=(s.data().name||'بدون اسم');
    sel.appendChild(o);
  });
}

/* ------------ Actions ------------ */
$('#btnPrint').addEventListener('click', ()=>window.print());
$('#btnXLSX').addEventListener('click', exportXLSX);
$('#run').addEventListener('click', buildReport);

$('#btnPrintTable').addEventListener('click', ()=>{
  const c=$('#childSel').value, f=$('#from').value, t=$('#to').value;
  if(!c||!f||!t){ alert('اختاري الطفل والفترة'); return; }
  window.open('readings-print.html?child='+encodeURIComponent(c)+'&from='+encodeURIComponent(f)+'&to='+encodeURIComponent(t),'_blank');
});
$('#btnDoctorLog').addEventListener('click', ()=>{
  const c=$('#childSel').value; if(!c){ alert('اختاري الطفل أولًا'); return; }
  window.open('doctor-log.html?child='+encodeURIComponent(c),'_blank');
});
$('#aggSel').addEventListener('change', ()=>renderTrend());

/* ------------ Build report ------------ */
async function buildReport(){
  const childId=$('#childSel').value, from=$('#from').value, to=$('#to').value;
  if(!childId||!from||!to){ alert('اختاري الطفل وحددي الفترة'); return; }

  const cs=await getDoc(doc(db,'users',uid,'children',childId));
  const c=cs.data()||{};
  cMeta={
    name:(c.name||'—'),
    civil:(c.childCivilId||'—'),
    wt:(c.weight!=null?c.weight:'—'),
    ht:(c.height!=null?c.height:'—'),
    lo:(c.lowThreshold!=null?c.lowThreshold:'—'),
    hi:(c.highThreshold!=null?c.highThreshold:'—')
  };

  $('#meta').innerHTML='الاسم: '+cMeta.name+' • الرقم المدني: '+cMeta.civil+
    ' • الوزن: '+cMeta.wt+' كجم • الطول: '+cMeta.ht+' سم • حدود: منخفض < '+cMeta.lo+
    ' — مرتفع > '+cMeta.hi+' • الفترة: '+from+' → '+to+' • الوحدة: mmol/L';

  const col=collection(db,'users',uid,'children',childId,'measurements');
  const qy=query(col, where('date','>=',from), where('date','<=',to), orderBy('date','asc'));
  const qs=await getDocs(qy);

  let total=0,cLow=0,cOk=0,cHigh=0,sum=0, minR=Infinity,maxR=-Infinity,minD='—',maxD='—';
  cachedDetailed=[]; dailySeries=[]; slotAgg={}; order.forEach(k=>slotAgg[k]={sum:0,count:0});
  let daysWithAny=0;

  const tbody=$('#rows'); tbody.innerHTML='';
  if(qs.empty){
    tbody.innerHTML='<tr><td colspan="10" class="small">لا توجد قراءات.</td></tr>';
  }else{
    qs.forEach(s=>{
      const d=s.data(); const readings=d.readings||{};
      const tr=document.createElement('tr'); const tdDate=document.createElement('td');
      tdDate.className='date'; tdDate.textContent=d.date; tr.appendChild(tdDate);

      let daySum=0, dayCnt=0; let any=false;
      const rowExport={date:d.date};

      order.forEach(slot=>{
        const r=readings[slot]; const td=document.createElement('td');
        if(!r||r.value==null){ td.textContent='—'; rowExport[slot]=''; }
        else{
          const mmol=Number(r.value)||0; any=true;
          const lowNum = Number(cMeta.lo); const highNum = Number(cMeta.hi);
          let st='ok';
          if(!isNaN(lowNum) && mmol<lowNum) st='low';
          else if(!isNaN(highNum) && mmol>highNum) st='high';

          const cls=(st==='low')?'low':(st==='high'?'high':'ok');
          const badge='<span class="badge '+cls+'">'+(st==='ok'?'طبيعي':(st==='low'?'منخفض':'مرتفع'))+'</span>';
          td.innerHTML='<div><b>'+mmol.toFixed(1)+' mmol/L</b> '+badge+'</div>'+
                       (r.mealDose!=null?('<div class="small">جرعة: '+r.mealDose+'U</div>'):'')+
                       (r.correctionGiven!=null?('<div class="small">تصحيحي: '+r.correctionGiven+'U</div>'):'')+
                       ((r.note||r.raisedWith)?('<div class="small">ملاحظة: '+(r.note||r.raisedWith)+'</div>'):'');
          rowExport[slot]= mmol.toFixed(1)+' mmol/L'+
            (r.mealDose!=null?(' | جرعة: '+r.mealDose+'U'):'')+
            (r.correctionGiven!=null?(' | تصحيحي: '+r.correctionGiven+'U'):'')+
            ((r.note||r.raisedWith)?(' | ملاحظة: '+(r.note||r.raisedWith)):'');
          total++; sum+=mmol;
          if(st==='low')cLow++; else if(st==='high')cHigh++; else cOk++;
          if(mmol<minR){minR=mmol; minD=d.date;} if(mmol>maxR){maxR=mmol; maxD=d.date;}
          daySum+=mmol; dayCnt++; slotAgg[slot].sum+=mmol; slotAgg[slot].count++;
        }
        tr.appendChild(td);
      });

      if(!any) tr.innerHTML='<td class="date">'+d.date+'</td><td colspan="9" class="small">—</td>';
      tbody.appendChild(tr);
      cachedDetailed.push(rowExport);

      if(dayCnt){ dailySeries.push({date:d.date, avg: +(daySum/dayCnt).toFixed(2)}); daysWithAny++; }
    });
  }

  // Summary numbers
  $('#s_total').textContent=total; $('#s_low').textContent=cLow; $('#s_ok').textContent=cOk; $('#s_high').textContent=cHigh;
  const tir= total? Math.round((cOk/total)*100) : 0; $('#s_tir').textContent=tir+'%';
  $('#s_avg').textContent= total? (sum/total).toFixed(1)+' mmol/L' : '—';
  const hasMinMax = isFinite(minR) && isFinite(maxR);
  $('#s_minmax').textContent = hasMinMax ? (minR.toFixed(1)+' / '+maxR.toFixed(1)+' mmol/L ('+minD+' — '+maxD+')') : '—';

  // Drug summary
  const totals = drugTotals();
  const days = (daysWithAny>0)?daysWithAny:1;
  $('#mealTotal').textContent=totals.meal.toFixed(1);
  $('#corrTotal').textContent=totals.corr.toFixed(1);
  $('#mealPerDay').textContent=(totals.meal/days).toFixed(1);
  $('#corrPerDay').textContent=(totals.corr/days).toFixed(1);

  renderSlots();
  renderTrend();
  renderDonut(cLow,cOk,cHigh);
}

/* ------------ Charts ------------ */
function renderSlots(){
  const ctx=$('#chartSlots');
  const slotLabels=order.map(k=>labels[k]);
  const slotMeans=order.map(k=>{
    const a=slotAgg[k]||{sum:0,count:0}; return a.count? +(a.sum/a.count).toFixed(2):0;
  });
  if(chartSlots) chartSlots.destroy();
  chartSlots=new Chart(ctx,{
    type:'bar',
    data:{labels:slotLabels,datasets:[{label:'متوسط الوقت (mmol/L)',data:slotMeans,backgroundColor:'#6ee7b7',borderColor:'#059669'}]},
    options:{plugins:{legend:{display:true}},scales:{x:{ticks:{autoSkip:false}}}}
  });
}

function renderTrend(){
  const mode=$('#aggSel').value; // daily/weekly/monthly/quarterly
  const groups = aggregateSeries(dailySeries, mode);
  const ctx=$('#chartTrend');
  if(chartTrend) chartTrend.destroy();
  chartTrend=new Chart(ctx,{
    type:'line',
    data:{labels:groups.map(g=>g.label),datasets:[{label:'متوسط (mmol/L)',data:groups.map(g=>g.avg),borderColor:'#0ea5e9',backgroundColor:'rgba(14,165,233,.15)',tension:.3,spanGaps:true}]},
    options:{plugins:{legend:{display:true}},scales:{x:{ticks:{autoSkip:true,maxTicksLimit:14}}}}
  });
}

function renderDonut(low,ok,high){
  const ctx=$('#chartDonut');
  if(chartDonut) chartDonut.destroy();
  chartDonut=new Chart(ctx,{
    type:'doughnut',
    data:{labels:['منخفض','طبيعي','مرتفع'],datasets:[{data:[low,ok,high],backgroundColor:['#f59e0b','#22c55e','#ef4444']}]},
    options:{plugins:{legend:{display:true,position:'bottom'}}}
  });
}

/* ------------ Aggregation helpers ------------ */
// dailySeries = [{date:'YYYY-MM-DD', avg:7.4}, ...]
function aggregateSeries(series, mode){
  if(!series.length) return [];
  const toKeyMap={
    daily:function(d){ return d; },
    weekly:function(d){
      const dt=new Date(d);
      const one=dt.getDate()-dt.getDay()+1; // بداية الأسبوع (الاثنين)
      const wkStart=new Date(dt); wkStart.setDate(one);
      return iso(wkStart)+' (أسبوع)';
    },
    monthly:function(d){ return d.slice(0,7); }, // YYYY-MM
    quarterly:function(d){
      const p=d.split('-'); const y=p[0]; const m=parseInt(p[1],10);
      const q=Math.floor((m-1)/3)+1; return y+' Q'+q;
    }
  };
  const toKey=toKeyMap[mode] || toKeyMap.daily;

  const map=new Map();
  series.forEach(function(it){
    const k=toKey(it.date);
    if(!map.has(k)) map.set(k,{sum:0,count:0});
    const o=map.get(k); o.sum+=it.avg; o.count++;
  });
  return Array.from(map.entries()).map(function(e){
    const label=e[0]; const o=e[1];
    return {label:label, avg: +(o.sum/o.count).toFixed(2)};
  });
}
function iso(d){
  const z=n=>String(n).padStart(2,'0');
  return d.getFullYear()+'-'+z(d.getMonth()+1)+'-'+z(d.getDate());
}

/* ------------ Drug totals ------------ */
function drugTotals(){
  let meal=0,corr=0;
  cachedDetailed.forEach(function(r){
    order.forEach(function(k){
      const txt=r[k]||'';
      const m=txt.match(/جرعة:\s*([\d.]+)U/); if(m) meal+=+m[1];
      const c=txt.match(/تصحيحي:\s*([\d.]+)U/); if(c) corr+=+c[1];
    });
  });
  return {meal:meal,corr:corr};
}

/* ------------ Export Excel ------------ */
function exportXLSX(){
  const XLSX=window.XLSX; if(!XLSX){ alert('XLSX library missing'); return; }
  const childSel=$('#childSel'); const childText=childSel && childSel.selectedOptions[0]? childSel.selectedOptions[0].textContent : 'child';
  const from=$('#from').value, to=$('#to').value;

  const head=['التاريخ'].concat(order.map(function(k){return labels[k];}));
  const rows=cachedDetailed.map(function(r){ return [r.date].concat(order.map(function(k){return r[k]||'';})); });

  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([
    ['الفترة', from+' → '+to],
    ['الاسم', cMeta.name], ['الرقم المدني', cMeta.civil],
    ['الوزن/الطول', cMeta.wt+' كجم • '+cMeta.ht+' سم'],
    ['حدود', 'Low < '+cMeta.lo+' — High > '+cMeta.hi],
    ['عدد القراءات', document.getElementById('s_total').textContent],
    ['منخفض/طبيعي/مرتفع', document.getElementById('s_low').textContent+' / '+document.getElementById('s_ok').textContent+' / '+document.getElementById('s_high').textContent],
    ['داخل النطاق %', document.getElementById('s_tir').textContent],
    ['متوسط القراءة', document.getElementById('s_avg').textContent],
    ['أعلى / أقل', document.getElementById('s_minmax').textContent],
    ['إجمالي جرعات الوجبة', document.getElementById('mealTotal').textContent+' U'],
    ['إجمالي التصحيحي', document.getElementById('corrTotal').textContent+' U'],
    ['متوسط وجبة/اليوم', document.getElementById('mealPerDay').textContent+' U'],
    ['متوسط تصحيحي/اليوم', document.getElementById('corrPerDay').textContent+' U']
  ]), 'Summary');

  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([head].concat(rows)), 'Detailed');
  XLSX.writeFile(wb, 'doctor_followup_'+childText+'_'+from+'_to_'+to+'.xlsx');
}
</script>
</body>
</html>
