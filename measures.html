<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ±</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø®ÙÙŠÙØ© Ø¥Ø¶Ø§ÙÙŠØ© Ø®Ø§ØµØ© Ø¨Ø§Ù„ØµÙØ­Ø© */
    .unit-toggle{display:flex;gap:10px;align-items:center}
    .unit-toggle label{display:inline-flex;align-items:center;gap:6px;background:#fff;border:1px solid var(--line);padding:6px 10px;border-radius:10px;cursor:pointer}
    .unit-toggle input{accent-color:#0ea5e9}
    .state{display:inline-block;padding:2px 8px;border-radius:999px}
    .state.ok{background:#ecfdf5;color:#16a34a}
    .state.low{background:#fff7ed;color:#b45309}
    .state.high{background:#fee2e2;color:#dc2626}
    .icon{font-size:14px}
    .hide{display:none!important}
    .table{width:100%;border-collapse:separate;border-spacing:0}
    .table th,.table td{border:1px solid var(--line);padding:8px;text-align:right;vertical-align:top}
    .table thead th{background:#f0f9ff;font-weight:800}
    .cell-hint{font-size:12px;color:var(--muted)}
    .actions .btn{padding:6px 10px}
  </style>
</head>
<body>

  <!-- âœ… Ø¨Ù†Ø± Ø§Ù„Ø·ÙÙ„ -->
  <div id="childBanner" style="text-align:center; padding:12px 8px; display:none">
    <img id="bannerAvatar" class="avatar" style="width:84px;height:84px" src="images/avatar-default.png" alt="ØµÙˆØ±Ø© Ø§Ù„Ø·ÙÙ„">
    <div style="margin-top:6px;font-weight:800" id="bannerName">â€”</div>
    <div class="note" id="bannerMeta">â€”</div>
  </div>

  <!-- âœ… Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
  <div class="topbar">
    <div>ğŸ§ª Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ±</div>
    <div class="row">
      <a id="lnkHome" class="btn gray">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <button id="btnLogout" class="btn">Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <main class="container">
    <!-- âœ… Ø±ÙˆØ§Ø¨Ø· ØªÙ†Ù‚Ù‘Ù„ Ø·ÙÙ„ -->
    <div class="card"><div class="row" id="childNav"></div></div>

    <!-- âœ… Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ -->
    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 class="section-title" style="margin:0">Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù‚ÙŠØ§Ø³</h3>
        <span class="badge-soft">Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©: mmol/L (ØªÙ‚Ø±ÙŠØ¨ 0.1)</span>
      </div>

      <div class="grid g3" style="margin-top:10px">
        <div>
          <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
          <input id="mDate" type="date">
        </div>

        <div>
          <label>ÙˆÙ‚Øª Ø§Ù„Ù‚ÙŠØ§Ø³</label>
          <select id="mSlot">
            <option value="">â€” Ø§Ø®ØªØ§Ø±ÙŠ â€”</option>
            <option value="uponWake">Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸</option>
            <option value="preBreakfast">Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±</option>
            <option value="postBreakfast">Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±</option>
            <option value="preLunch">Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡</option>
            <option value="postLunch">Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡</option>
            <option value="preDinner">Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡</option>
            <option value="postDinner">Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡</option>
            <option value="beforeSleep">Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…</option>
            <option value="duringSleep">Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…</option>
            <option value="beforeExercise">Ù‚Ø¨Ù„ Ø§Ù„ØªÙ…Ø±ÙŠÙ†</option>
            <option value="afterExercise">Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠÙ†</option>
            <option value="random">Ù‚ÙŠØ§Ø³ Ø¹Ø´ÙˆØ§Ø¦ÙŠ</option>
            <option value="other">Ø£Ø®Ø±Ù‰</option>
          </select>
        </div>

        <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ­Ø¯Ø© + Ø§Ù„Ù‚ÙŠÙ…Ø© -->
        <div>
          <label>Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</label>
          <div class="unit-toggle" style="margin-bottom:6px">
            <label><input type="radio" name="unit" value="mmol" checked> mmol/L</label>
            <label><input type="radio" name="unit" value="mg"> mg/dL</label>
          </div>
          <input id="mValue" type="number" step="0.1" min="0" placeholder="Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø­Ø³Ø¨ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©">
          <div class="cell-hint">ÙŠØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ ÙˆØ§Ù„ØªØ®Ø²ÙŠÙ† Ø¨Ø§Ù„Ù€ mmol/L (ØªÙ‚Ø±ÙŠØ¨ 0.1)</div>
        </div>

        <div>
          <label>ÙƒØ§Ø±Ø¨ (Ø¬Ù…)</label>
          <input id="mCarbs" type="number" step="0.1" min="0" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ">
        </div>

        <div>
          <label>Ø¬Ø±Ø¹Ø© Ø§Ù„ÙˆØ¬Ø¨Ø© (Ù…Ù‚ØªØ±Ø­Ø©)</label>
          <input id="mDoseSuggested" readonly placeholder="ÙŠÙØ­Ø³Ø¨ Ù…Ù† ICR">
          <div class="cell-hint">Ø§Ù„Ù…Ù‚ØªØ±Ø­ = Ø§Ù„ÙƒØ§Ø±Ø¨ Ã· ICR</div>
        </div>

        <div>
          <label>Ø¬Ø±Ø¹Ø© ÙØ¹Ù„ÙŠØ© (Ø¥Ù† Ø£ÙØ¹Ø·ÙŠØª)</label>
          <input id="mDoseGiven" type="number" step="0.1" min="0" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ">
        </div>

        <!-- Ø§Ù„ØªØµØ­ÙŠØ­ ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ -->
        <div id="boxCorr" class="hide">
          <label>Ø¬Ø±Ø¹Ø© ØªØµØ­ÙŠØ­ÙŠØ© (Ù…Ù‚ØªØ±Ø­Ø©)</label>
          <input id="mCorr" type="number" step="0.1" min="0">
          <div class="cell-hint">Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ù…Ù‚ØªØ±Ø­ = (Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© - Ø§Ù„Ù‡Ø¯Ù) Ã· Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„ØªØµØ­ÙŠØ­</div>
        </div>

        <!-- Ø§Ù„Ø±ÙØ¹ ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ù‡Ø¨ÙˆØ· -->
        <div id="boxRaise" class="hide">
          <label>Ø±ÙØ¹ Ø§Ù„Ø³ÙƒØ±</label>
          <input id="mRaisedWith" placeholder="Ø¹ØµÙŠØ± / ØªÙ…Ø± â€¦">
          <div class="cell-hint">ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ù‡Ø¨ÙˆØ·</div>
        </div>

        <div style="grid-column:1/-1">
          <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
          <input id="mNote" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ">
        </div>
      </div>

      <div class="row" style="justify-content:flex-end;margin-top:8px">
        <button id="mSave" class="btn primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³</button>
        <button id="mCancelEdit" class="btn gray hide" type="button">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
      </div>

      <div class="note" style="margin-top:6px">
        â€¢ Ø¹Ù†Ø¯ <b>Ø§Ù„Ø§Ø±ØªÙØ§Ø¹</b> ÙŠØ¸Ù‡Ø± Ø§Ù„ØªØµØ­ÙŠØ­ÙŠ ÙÙ‚Ø·. â€¢ Ø¹Ù†Ø¯ <b>Ø§Ù„Ù‡Ø¨ÙˆØ·</b> ÙŠØ¸Ù‡Ø± Ø±ÙØ¹ Ø§Ù„Ø³ÙƒØ± ÙÙ‚Ø·. â€¢ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚ ÙŠÙØ®ÙÙ‰ Ø§Ù„Ø¥Ø«Ù†Ø§Ù†.
      </div>
    </section>

    <!-- âœ… Ø¬Ø¯ÙˆÙ„ Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„ÙŠÙˆÙ…/Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø¯Ø¯ -->
    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 class="section-title" style="margin:0">ğŸ“… Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø®ØªØ§Ø±</h3>
        <div class="row">
          <button id="btnReloadDay" class="btn gray">ğŸ” Ø¹Ø±Ø¶ Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„ÙŠÙˆÙ…</button>
        </div>
      </div>
      <div class="note">Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ù„Ø£Ù‚Ø±Ø¨ 0.1 mmol/L. Ø§Ù„Ø£Ø³Ù‡Ù…: â¬†ï¸ Ù…Ø±ØªÙØ¹ â€¢ â¬‡ï¸ Ù…Ù†Ø®ÙØ¶ â€¢ ğŸŸ¢ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚</div>
      <table class="table" style="margin-top:8px">
        <thead>
          <tr>
            <th>Ø§Ù„ØªÙˆÙ‚ÙŠØª</th>
            <th>Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø¬Ø±Ø¹Ø§Øª</th>
            <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
            <th class="center">Ø¥Ø¬Ø±Ø§Ø¡</th>
          </tr>
        </thead>
        <tbody id="mRows">
          <tr><td colspan="6" class="note center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠØ§Ø³Ø§Øª.</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <div id="toast" class="toast"></div>
  <div id="loader" class="loader"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>

  <script type="module">
    /* ===== Imports Ù…Ø´ØªØ±ÙƒØ© ===== */
    import {
      auth, db, ensureAuth, requireChildIdFromQuery,
      setChildAvatar, toLocalDatetimeValue
    } from './firebase-init.js';

    import { signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    /* ===== Helpers Ù…Ø­Ù„ÙŠØ© ===== */
    const $ = s => document.querySelector(s);
    const toast=(m)=>{const t=$("#toast");t.textContent=m;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),2000)}
    const showLoader=(on)=>{$("#loader").style.display=on?"flex":"none"}

    const mLabels = {
      uponWake:'Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸',
      preBreakfast:'Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±', postBreakfast:'Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±',
      preLunch:'Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡',      postLunch:'Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡',
      preDinner:'Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡',     postDinner:'Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡',
      beforeSleep:'Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…',    duringSleep:'Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…',
      beforeExercise:'Ù‚Ø¨Ù„ Ø§Ù„ØªÙ…Ø±ÙŠÙ†', afterExercise:'Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠÙ†',
      random:'Ù‚ÙŠØ§Ø³ Ø¹Ø´ÙˆØ§Ø¦ÙŠ', other:'Ø£Ø®Ø±Ù‰'
    };
    const mOrder = ['uponWake','preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep','beforeExercise','afterExercise','random','other'];

    const round1 = n => Math.round(Number(n)*10)/10;
    function stateBy(v, low, high){
      if(v==null || isNaN(v)) return 'ok';
      if(isFinite(low) && v < low) return 'low';
      if(isFinite(high) && v > high) return 'high';
      return 'ok';
    }
    const iconByState = s => s==='low'?'â¬‡ï¸':(s==='high'?'â¬†ï¸':'ğŸŸ¢');

    /* ===== Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© ===== */
    let uid=null, childId=null, child=null;
    let editMode = { on:false, slot:null }; // Ù„Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª Ø¥Ù„Ø§ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„

    /* ===== Boot ===== */
    (async function(){
      showLoader(true);
      const a = await ensureAuth(); uid=a.uid;
      childId = requireChildIdFromQuery();

      // ØªÙ†Ù‚Ù„ Ø§Ù„Ø·ÙÙ„
      const nav=$("#childNav"); nav.innerHTML="";
      [
        ['child-dashboard.html','Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'],
        ['measures.html','Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ±'],
        ['meals.html','Ø§Ù„ÙˆØ¬Ø¨Ø§Øª'],
        ['reports.html','Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±'],
        ['visits.html','Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©'],
        ['doctor-report.html','ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¯ÙƒØªÙˆØ±']
      ].forEach(([h,t])=>{
        const a=document.createElement('a'); a.className='btn gray'; a.href=`${h}?child=${encodeURIComponent(childId)}`; a.textContent=t; nav.appendChild(a);
      });
      $("#lnkHome").href=`child-dashboard.html?child=${encodeURIComponent(childId)}`;

      await loadChild();
      initForm();
      bindUI();
      await loadDay(); // Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ

      $("#btnLogout").addEventListener("click", ()=>signOut(auth).then(()=>location.href='index.html'));
      showLoader(false);
    })().catch(e=>{console.error(e); toast('âš ï¸ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„'); showLoader(false);});

    /* ===== ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„ ===== */
    async function loadChild(){
      const s = await getDoc(doc(db,'users',uid,'children',childId));
      child = s.data()||{};
      setChildAvatar($("#bannerAvatar"), child.name, child.photoURL);
      $("#bannerName").textContent = child.name || 'â€”';
      $("#bannerMeta").textContent = `${child.gender||'â€”'} â€¢ ${child.weight??'â€”'} ÙƒØ¬Ù… â€¢ ${child.height??'â€”'} Ø³Ù…`;
      $("#childBanner").style.display = 'block';
    }

    /* ===== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ===== */
    function initForm(){
      // ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…
      const d=new Date(); const iso = d.toISOString().slice(0,10);
      $("#mDate").value = iso;

      // Ø­Ø³Ø§Ø¨ Ø¬Ø±Ø¹Ø© Ø§Ù„ÙˆØ¬Ø¨Ø© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© Ù…Ù† ICR
      const recalcMealDose = ()=>{
        const carbs = Number($("#mCarbs").value)||0;
        const icr = Number(child?.icr)||0;
        $("#mDoseSuggested").value = (icr>0 && carbs>0) ? (Math.round((carbs/icr)*10)/10).toFixed(1) : '';
      };
      $("#mCarbs").addEventListener('input', recalcMealDose);

      // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù„Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØµØ­ÙŠØ­/Ø§Ù„Ø±ÙØ¹
      const refreshStateBoxes = ()=>{
        const unit = document.querySelector('input[name="unit"]:checked').value;
        const raw  = Number($("#mValue").value)||0;
        // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ mmol/L Ù„Ùˆ ÙƒØ§Ù†Øª mg/dL
        const mmol = unit==='mg' ? round1(raw/18) : round1(raw);
        const low  = Number(child?.lowThreshold);
        const high = Number(child?.highThreshold);
        const target = Number(child?.target);
        const corrFactor = Number(child?.correctionFactor);

        // Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
        const st = stateBy(mmol, low, high);

        // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡
        if(st==='high'){
          $("#boxCorr").classList.remove('hide');
          $("#boxRaise").classList.add('hide');
          // Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„ØªØµØ­ÙŠØ­ Ø¥Ù† ØªÙˆÙÙ‘Ø± target & CF
          if(isFinite(target) && isFinite(corrFactor) && corrFactor>0){
            const corr = Math.max(0, round1((mmol - target) / corrFactor));
            $("#mCorr").value = corr ? corr.toFixed(1) : '';
          }
        }else if(st==='low'){
          $("#boxCorr").classList.add('hide');
          $("#boxRaise").classList.remove('hide');
          $("#mCorr").value='';
        }else{
          $("#boxCorr").classList.add('hide');
          $("#boxRaise").classList.add('hide');
          $("#mCorr").value='';
        }
      };

      $("#mValue").addEventListener('input', refreshStateBoxes);
      document.querySelectorAll('input[name="unit"]').forEach(r=>{
        r.addEventListener('change', ()=>{
          // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ø§ Ù†Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù‚ÙŠÙ…Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ØŒ ÙÙ‚Ø· Ù†Ø¹ÙŠØ¯ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø­Ø§Ù„Ø©
          refreshStateBoxes();
        });
      });

      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ… Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ØªØ§Ø±ÙŠØ®
      $("#mDate").addEventListener('change', loadDay);
      $("#btnReloadDay").addEventListener('click', loadDay);

      // Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³
      $("#mSave").addEventListener('click', onSave);
      $("#mCancelEdit").addEventListener('click', ()=>{
        editMode={on:false,slot:null};
        $("#mCancelEdit").classList.add('hide');
        $("#mSlot").disabled=false;
        toast('ØªÙ… Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„');
      });
    }

    /* ===== ØªØ­Ù…ÙŠÙ„ Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø­Ø¯Ø¯ ===== */
    async function loadDay(){
      showLoader(true);
      try{
        const date = $("#mDate").value;
        const ref  = doc(db,'users',uid,'children',childId,'measurements',date);
        const snap = await getDoc(ref);
        const data = snap.data()||{};
        const readings = data.readings||{};
        renderDay(readings);
      }catch(e){ console.error(e); toast('âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…'); }
      finally{ showLoader(false); }
    }

    function renderDay(readings){
      const low  = Number(child?.lowThreshold);
      const high = Number(child?.highThreshold);
      const tb = $("#mRows");
      let html = '';

      mOrder.forEach(key=>{
        const r = readings[key];
        if(!r || (r.valueMmol==null && r.value==null)) return;
        const v = round1(Number(r.valueMmol ?? r.value));
        const st = stateBy(v, low, high);
        const doses = [
          (r.mealDose!=null ? `ÙˆØ¬Ø¨Ø©: ${r.mealDose}U` : ''),
          (r.correctionGiven!=null ? `ØªØµØ­ÙŠØ­: ${r.correctionGiven}U` : '')
        ].filter(Boolean).join(' â€¢ ') || 'â€”';
        const note  = [r.note||'', r.raisedWith||''].filter(Boolean).join(' â€” ') || 'â€”';

        html += `
          <tr>
            <td><b>${mLabels[key]}</b></td>
            <td>${v.toFixed(1)} mmol/L <span class="icon">${iconByState(st)}</span></td>
            <td><span class="state ${st}">${st==='low'?'Ù…Ù†Ø®ÙØ¶':st==='high'?'Ù…Ø±ØªÙØ¹':'Ø·Ø¨ÙŠØ¹ÙŠ'}</span></td>
            <td>${doses}</td>
            <td>${escapeHTML(note)}</td>
            <td class="actions center">
              <button class="btn gray" data-edit="${key}">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
            </td>
          </tr>`;
      });

      tb.innerHTML = html || `<tr><td colspan="6" class="note center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠØ§Ø³Ø§Øª.</td></tr>`;

      // Ø±Ø¨Ø· Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
      tb.querySelectorAll('button[data-edit]').forEach(btn=>{
        btn.addEventListener('click', ()=>editReading(btn.dataset.edit, readings[btn.dataset.edit]));
      });
    }

    function editReading(slot, r){
      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ…Ø© ÙÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ + ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
      $("#mSlot").value = slot;
      $("#mSlot").disabled = true;
      editMode = { on:true, slot };
      $("#mCancelEdit").classList.remove('hide');

      // Ù†Ù…Ù„Ø£ Ø§Ù„Ø­Ù‚ÙˆÙ„ (Ø§Ø¹ØªÙ…Ø§Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²Ù† mmol)
      const mmol = round1(Number(r?.valueMmol ?? r?.value ?? 0));
      document.querySelector('input[name="unit"][value="mmol"]').checked = true;
      $("#mValue").value = mmol ? mmol.toFixed(1) : '';
      $("#mCarbs").value = r?.carbs ?? '';
      $("#mDoseSuggested").value = ''; // ÙŠÙØ¹Ø§Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø­Ø³Ø¨ ICR ÙˆØ§Ù„Ù€ carbs
      $("#mDoseGiven").value = r?.mealDose ?? '';
      $("#mCorr").value = r?.correctionGiven ?? '';
      $("#mRaisedWith").value = r?.raisedWith ?? '';
      $("#mNote").value = r?.note ?? '';

      // ØªØ­Ø¯ÙŠØ« ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„Ø©/Ø§Ù„ØªØµØ­ÙŠØ­/Ø§Ù„Ø±ÙØ¹
      const event = new Event('input'); $("#mValue").dispatchEvent(event); $("#mCarbs").dispatchEvent(event);
      toast('ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…ÙØ¹Ù‘Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„ØªÙˆÙ‚ÙŠØª');
    }

    /* ===== Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³ ===== */
    async function onSave(){
      const date = $("#mDate").value.trim();
      const slot = $("#mSlot").value;
      const unit = document.querySelector('input[name="unit"]:checked').value; // mmol | mg
      const raw  = Number($("#mValue").value||0);

      if(!date || !slot){ toast('Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ù‚ÙŠØ§Ø³'); return; }
      if(!(raw>0)){ toast('Ø£Ø¯Ø®Ù„ÙŠ Ù‚Ø±Ø§Ø¡Ø© ØµØ­ÙŠØ­Ø©'); return; }

      // Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ mmol/L
      const mmol = unit==='mg' ? round1(raw/18) : round1(raw);

      // Ø¬Ø±Ø¹Ø§Øª ÙˆÙ…Ù„Ø§Ø­Ø¸Ø§Øª
      const carbs = ($("#mCarbs").value==='') ? null : Number($("#mCarbs").value);
      const mealDose = ($("#mDoseGiven").value==='') ? null : Number($("#mDoseGiven").value);
      const correction = ($("#mCorr").value==='') ? null : Number($("#mCorr").value);
      const raised = $("#mRaisedWith").value.trim() || null;
      const note   = $("#mNote").value.trim() || null;

      // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„Ø©
      const low  = Number(child?.lowThreshold);
      const high = Number(child?.highThreshold);
      const status = stateBy(mmol, low, high);

      showLoader(true);
      try{
        const ref  = doc(db,'users',uid,'children',childId,'measurements',date);
        const snap = await getDoc(ref);
        const base = snap.data() || { date, readings:{} };
        if(!base.readings) base.readings = {};

        // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª Ù„Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…â€”Ø¥Ù„Ø§ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø®Ø§Ù†Ø©
        if(!editMode.on){
          if(base.readings[slot] && base.readings[slot].valueMmol!=null){
            toast('âš ï¸ Ù‡Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª Ù…ÙØ³Ø¬Ù‘Ù„ Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…'); showLoader(false); return;
          }
        }else{
          // Ù„Ùˆ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„ÙƒÙ† ØºÙŠÙ‘Ø±ØªÙ Ø§Ù„Ø³Ù„ÙˆÙ’Øª Ù…Ù…Ù†ÙˆØ¹ (Ø§Ù„Ù…Ø±Ø¨Ø¹ Ù…Ù‚ÙÙˆÙ„ Ø¨Ø§Ù„ÙØ¹Ù„)
          if(editMode.slot !== slot){
            toast('âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ†ÙƒÙ ØªØºÙŠÙŠØ± ÙˆÙ‚Øª Ø§Ù„Ù‚ÙŠØ§Ø³ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„'); showLoader(false); return;
          }
        }

        base.readings[slot] = {
          valueMmol: mmol,
          status,
          carbs,
          mealDose,
          correctionGiven: correction,
          raisedWith: raised,
          note
        };

        await setDoc(ref, base, {merge:true});
        toast(editMode.on ? 'âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚ÙŠØ§Ø³' : 'âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³');

        // Ø¥Ù†Ù‡Ø§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¥Ù† ÙˆØ¬Ø¯
        editMode={on:false,slot:null};
        $("#mCancelEdit").classList.add('hide');
        $("#mSlot").disabled=false;

        // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø®ÙÙŠÙØ©
        // $("#mValue").value=''; $("#mCarbs").value=''; $("#mDoseGiven").value=''; $("#mCorr").value=''; $("#mRaisedWith").value=''; $("#mNote").value='';

        await loadDay();
      }catch(e){
        console.error(e);
        toast('âš ï¸ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ â€” ØªØ­Ù‚Ù‚ÙŠ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª');
      }finally{
        showLoader(false);
      }
    }

    /* ===== Utils ===== */
    function escapeHTML(str){ return String(str||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
  </script>
</body>
</html>
