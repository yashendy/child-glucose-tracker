<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>قياسات السكر</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* تنسيقات خفيفة إضافية خاصة بالصفحة */
    .unit-toggle{display:flex;gap:10px;align-items:center}
    .unit-toggle label{display:inline-flex;align-items:center;gap:6px;background:#fff;border:1px solid var(--line);padding:6px 10px;border-radius:10px;cursor:pointer}
    .unit-toggle input{accent-color:#0ea5e9}
    .state{display:inline-block;padding:2px 8px;border-radius:999px}
    .state.ok{background:#ecfdf5;color:#16a34a}
    .state.low{background:#fff7ed;color:#b45309}
    .state.high{background:#fee2e2;color:#dc2626}
    .icon{font-size:14px}
    .hide{display:none!important}
    .table{width:100%;border-collapse:separate;border-spacing:0}
    .table th,.table td{border:1px solid var(--line);padding:8px;text-align:right;vertical-align:top}
    .table thead th{background:#f0f9ff;font-weight:800}
    .cell-hint{font-size:12px;color:var(--muted)}
    .actions .btn{padding:6px 10px}
  </style>
</head>
<body>

  <!-- ✅ بنر الطفل -->
  <div id="childBanner" style="text-align:center; padding:12px 8px; display:none">
    <img id="bannerAvatar" class="avatar" style="width:84px;height:84px" src="images/avatar-default.png" alt="صورة الطفل">
    <div style="margin-top:6px;font-weight:800" id="bannerName">—</div>
    <div class="note" id="bannerMeta">—</div>
  </div>

  <!-- ✅ الشريط العلوي -->
  <div class="topbar">
    <div>🧪 قياسات السكر</div>
    <div class="row">
      <a id="lnkHome" class="btn gray">الرئيسية</a>
      <button id="btnLogout" class="btn">خروج</button>
    </div>
  </div>

  <main class="container">
    <!-- ✅ روابط تنقّل طفل -->
    <div class="card"><div class="row" id="childNav"></div></div>

    <!-- ✅ نموذج الإدخال -->
    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 class="section-title" style="margin:0">إدخال القياس</h3>
        <span class="badge-soft">الوحدة الداخلية: mmol/L (تقريب 0.1)</span>
      </div>

      <div class="grid g3" style="margin-top:10px">
        <div>
          <label>التاريخ</label>
          <input id="mDate" type="date">
        </div>

        <div>
          <label>وقت القياس</label>
          <select id="mSlot">
            <option value="">— اختاري —</option>
            <option value="uponWake">الاستيقاظ</option>
            <option value="preBreakfast">قبل الإفطار</option>
            <option value="postBreakfast">بعد الإفطار</option>
            <option value="preLunch">قبل الغداء</option>
            <option value="postLunch">بعد الغداء</option>
            <option value="preDinner">قبل العشاء</option>
            <option value="postDinner">بعد العشاء</option>
            <option value="beforeSleep">قبل النوم</option>
            <option value="duringSleep">أثناء النوم</option>
            <option value="beforeExercise">قبل التمرين</option>
            <option value="afterExercise">بعد التمرين</option>
            <option value="random">قياس عشوائي</option>
            <option value="other">أخرى</option>
          </select>
        </div>

        <!-- اختيار الوحدة + القيمة -->
        <div>
          <label>القراءة</label>
          <div class="unit-toggle" style="margin-bottom:6px">
            <label><input type="radio" name="unit" value="mmol" checked> mmol/L</label>
            <label><input type="radio" name="unit" value="mg"> mg/dL</label>
          </div>
          <input id="mValue" type="number" step="0.1" min="0" placeholder="أدخلي القيمة حسب الوحدة المختارة">
          <div class="cell-hint">يتم التحويل والتخزين بالـ mmol/L (تقريب 0.1)</div>
        </div>

        <div>
          <label>كارب (جم)</label>
          <input id="mCarbs" type="number" step="0.1" min="0" placeholder="اختياري">
        </div>

        <div>
          <label>جرعة الوجبة (مقترحة)</label>
          <input id="mDoseSuggested" readonly placeholder="يُحسب من ICR">
          <div class="cell-hint">المقترح = الكارب ÷ ICR</div>
        </div>

        <div>
          <label>جرعة فعلية (إن أُعطيت)</label>
          <input id="mDoseGiven" type="number" step="0.1" min="0" placeholder="اختياري">
        </div>

        <!-- التصحيح يظهر فقط عند الارتفاع -->
        <div id="boxCorr" class="hide">
          <label>جرعة تصحيحية (مقترحة)</label>
          <input id="mCorr" type="number" step="0.1" min="0">
          <div class="cell-hint">التصحيح المقترح = (القراءة - الهدف) ÷ معامل التصحيح</div>
        </div>

        <!-- الرفع يظهر فقط عند الهبوط -->
        <div id="boxRaise" class="hide">
          <label>رفع السكر</label>
          <input id="mRaisedWith" placeholder="عصير / تمر …">
          <div class="cell-hint">يظهر فقط عند الهبوط</div>
        </div>

        <div style="grid-column:1/-1">
          <label>ملاحظات</label>
          <input id="mNote" placeholder="اختياري">
        </div>
      </div>

      <div class="row" style="justify-content:flex-end;margin-top:8px">
        <button id="mSave" class="btn primary">💾 حفظ القياس</button>
        <button id="mCancelEdit" class="btn gray hide" type="button">إلغاء التعديل</button>
      </div>

      <div class="note" style="margin-top:6px">
        • عند <b>الارتفاع</b> يظهر التصحيحي فقط. • عند <b>الهبوط</b> يظهر رفع السكر فقط. • داخل النطاق يُخفى الإثنان.
      </div>
    </section>

    <!-- ✅ جدول قراءات اليوم/التاريخ المحدد -->
    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 class="section-title" style="margin:0">📅 قراءات اليوم المختار</h3>
        <div class="row">
          <button id="btnReloadDay" class="btn gray">🔁 عرض قياسات اليوم</button>
        </div>
      </div>
      <div class="note">التقريب لأقرب 0.1 mmol/L. الأسهم: ⬆️ مرتفع • ⬇️ منخفض • 🟢 داخل النطاق</div>
      <table class="table" style="margin-top:8px">
        <thead>
          <tr>
            <th>التوقيت</th>
            <th>القراءة</th>
            <th>الحالة</th>
            <th>جرعات</th>
            <th>ملاحظات</th>
            <th class="center">إجراء</th>
          </tr>
        </thead>
        <tbody id="mRows">
          <tr><td colspan="6" class="note center">لا توجد قياسات.</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <div id="toast" class="toast"></div>
  <div id="loader" class="loader"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>

  <script type="module">
    /* ===== Imports مشتركة ===== */
    import {
      auth, db, ensureAuth, requireChildIdFromQuery,
      setChildAvatar, toLocalDatetimeValue
    } from './firebase-init.js';

    import { signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    /* ===== Helpers محلية ===== */
    const $ = s => document.querySelector(s);
    const toast=(m)=>{const t=$("#toast");t.textContent=m;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),2000)}
    const showLoader=(on)=>{$("#loader").style.display=on?"flex":"none"}

    const mLabels = {
      uponWake:'الاستيقاظ',
      preBreakfast:'قبل الإفطار', postBreakfast:'بعد الإفطار',
      preLunch:'قبل الغداء',      postLunch:'بعد الغداء',
      preDinner:'قبل العشاء',     postDinner:'بعد العشاء',
      beforeSleep:'قبل النوم',    duringSleep:'أثناء النوم',
      beforeExercise:'قبل التمرين', afterExercise:'بعد التمرين',
      random:'قياس عشوائي', other:'أخرى'
    };
    const mOrder = ['uponWake','preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep','beforeExercise','afterExercise','random','other'];

    const round1 = n => Math.round(Number(n)*10)/10;
    function stateBy(v, low, high){
      if(v==null || isNaN(v)) return 'ok';
      if(isFinite(low) && v < low) return 'low';
      if(isFinite(high) && v > high) return 'high';
      return 'ok';
    }
    const iconByState = s => s==='low'?'⬇️':(s==='high'?'⬆️':'🟢');

    /* ===== متغيرات عامة ===== */
    let uid=null, childId=null, child=null;
    let editMode = { on:false, slot:null }; // لمنع تكرار نفس الوقت إلا عند التعديل

    /* ===== Boot ===== */
    (async function(){
      showLoader(true);
      const a = await ensureAuth(); uid=a.uid;
      childId = requireChildIdFromQuery();

      // تنقل الطفل
      const nav=$("#childNav"); nav.innerHTML="";
      [
        ['child-dashboard.html','الرئيسية'],
        ['measures.html','قياسات السكر'],
        ['meals.html','الوجبات'],
        ['reports.html','التقارير'],
        ['visits.html','الزيارات الطبية'],
        ['doctor-report.html','تقرير الدكتور']
      ].forEach(([h,t])=>{
        const a=document.createElement('a'); a.className='btn gray'; a.href=`${h}?child=${encodeURIComponent(childId)}`; a.textContent=t; nav.appendChild(a);
      });
      $("#lnkHome").href=`child-dashboard.html?child=${encodeURIComponent(childId)}`;

      await loadChild();
      initForm();
      bindUI();
      await loadDay(); // اليوم الافتراضي

      $("#btnLogout").addEventListener("click", ()=>signOut(auth).then(()=>location.href='index.html'));
      showLoader(false);
    })().catch(e=>{console.error(e); toast('⚠️ فشل التحميل'); showLoader(false);});

    /* ===== تحميل بيانات الطفل ===== */
    async function loadChild(){
      const s = await getDoc(doc(db,'users',uid,'children',childId));
      child = s.data()||{};
      setChildAvatar($("#bannerAvatar"), child.name, child.photoURL);
      $("#bannerName").textContent = child.name || '—';
      $("#bannerMeta").textContent = `${child.gender||'—'} • ${child.weight??'—'} كجم • ${child.height??'—'} سم`;
      $("#childBanner").style.display = 'block';
    }

    /* ===== تهيئة النموذج ===== */
    function initForm(){
      // تاريخ اليوم
      const d=new Date(); const iso = d.toISOString().slice(0,10);
      $("#mDate").value = iso;

      // حساب جرعة الوجبة المقترحة من ICR
      const recalcMealDose = ()=>{
        const carbs = Number($("#mCarbs").value)||0;
        const icr = Number(child?.icr)||0;
        $("#mDoseSuggested").value = (icr>0 && carbs>0) ? (Math.round((carbs/icr)*10)/10).toFixed(1) : '';
      };
      $("#mCarbs").addEventListener('input', recalcMealDose);

      // مراقبة القراءة لعرض/إخفاء التصحيح/الرفع
      const refreshStateBoxes = ()=>{
        const unit = document.querySelector('input[name="unit"]:checked').value;
        const raw  = Number($("#mValue").value)||0;
        // تحويل إلى mmol/L لو كانت mg/dL
        const mmol = unit==='mg' ? round1(raw/18) : round1(raw);
        const low  = Number(child?.lowThreshold);
        const high = Number(child?.highThreshold);
        const target = Number(child?.target);
        const corrFactor = Number(child?.correctionFactor);

        // حالة القراءة
        const st = stateBy(mmol, low, high);

        // إظهار/إخفاء
        if(st==='high'){
          $("#boxCorr").classList.remove('hide');
          $("#boxRaise").classList.add('hide');
          // اقتراح التصحيح إن توفّر target & CF
          if(isFinite(target) && isFinite(corrFactor) && corrFactor>0){
            const corr = Math.max(0, round1((mmol - target) / corrFactor));
            $("#mCorr").value = corr ? corr.toFixed(1) : '';
          }
        }else if(st==='low'){
          $("#boxCorr").classList.add('hide');
          $("#boxRaise").classList.remove('hide');
          $("#mCorr").value='';
        }else{
          $("#boxCorr").classList.add('hide');
          $("#boxRaise").classList.add('hide');
          $("#mCorr").value='';
        }
      };

      $("#mValue").addEventListener('input', refreshStateBoxes);
      document.querySelectorAll('input[name="unit"]').forEach(r=>{
        r.addEventListener('change', ()=>{
          // عند تغيير الوحدة لا نعدّل القيمة تلقائيًا، فقط نعيد تقييم الحالة
          refreshStateBoxes();
        });
      });

      // تحميل اليوم عند تغيير التاريخ
      $("#mDate").addEventListener('change', loadDay);
      $("#btnReloadDay").addEventListener('click', loadDay);

      // حفظ القياس
      $("#mSave").addEventListener('click', onSave);
      $("#mCancelEdit").addEventListener('click', ()=>{
        editMode={on:false,slot:null};
        $("#mCancelEdit").classList.add('hide');
        $("#mSlot").disabled=false;
        toast('تم إلغاء وضع التعديل');
      });
    }

    /* ===== تحميل قراءات اليوم المحدد ===== */
    async function loadDay(){
      showLoader(true);
      try{
        const date = $("#mDate").value;
        const ref  = doc(db,'users',uid,'children',childId,'measurements',date);
        const snap = await getDoc(ref);
        const data = snap.data()||{};
        const readings = data.readings||{};
        renderDay(readings);
      }catch(e){ console.error(e); toast('⚠️ حدث خطأ في تحميل اليوم'); }
      finally{ showLoader(false); }
    }

    function renderDay(readings){
      const low  = Number(child?.lowThreshold);
      const high = Number(child?.highThreshold);
      const tb = $("#mRows");
      let html = '';

      mOrder.forEach(key=>{
        const r = readings[key];
        if(!r || (r.valueMmol==null && r.value==null)) return;
        const v = round1(Number(r.valueMmol ?? r.value));
        const st = stateBy(v, low, high);
        const doses = [
          (r.mealDose!=null ? `وجبة: ${r.mealDose}U` : ''),
          (r.correctionGiven!=null ? `تصحيح: ${r.correctionGiven}U` : '')
        ].filter(Boolean).join(' • ') || '—';
        const note  = [r.note||'', r.raisedWith||''].filter(Boolean).join(' — ') || '—';

        html += `
          <tr>
            <td><b>${mLabels[key]}</b></td>
            <td>${v.toFixed(1)} mmol/L <span class="icon">${iconByState(st)}</span></td>
            <td><span class="state ${st}">${st==='low'?'منخفض':st==='high'?'مرتفع':'طبيعي'}</span></td>
            <td>${doses}</td>
            <td>${escapeHTML(note)}</td>
            <td class="actions center">
              <button class="btn gray" data-edit="${key}">✏️ تعديل</button>
            </td>
          </tr>`;
      });

      tb.innerHTML = html || `<tr><td colspan="6" class="note center">لا توجد قياسات.</td></tr>`;

      // ربط زر التعديل
      tb.querySelectorAll('button[data-edit]').forEach(btn=>{
        btn.addEventListener('click', ()=>editReading(btn.dataset.edit, readings[btn.dataset.edit]));
      });
    }

    function editReading(slot, r){
      // تحميل القيمة في النموذج + تفعيل وضع التعديل
      $("#mSlot").value = slot;
      $("#mSlot").disabled = true;
      editMode = { on:true, slot };
      $("#mCancelEdit").classList.remove('hide');

      // نملأ الحقول (اعتمادًا على المخزن mmol)
      const mmol = round1(Number(r?.valueMmol ?? r?.value ?? 0));
      document.querySelector('input[name="unit"][value="mmol"]').checked = true;
      $("#mValue").value = mmol ? mmol.toFixed(1) : '';
      $("#mCarbs").value = r?.carbs ?? '';
      $("#mDoseSuggested").value = ''; // يُعاد الحساب حسب ICR والـ carbs
      $("#mDoseGiven").value = r?.mealDose ?? '';
      $("#mCorr").value = r?.correctionGiven ?? '';
      $("#mRaisedWith").value = r?.raisedWith ?? '';
      $("#mNote").value = r?.note ?? '';

      // تحديث صناديق الحالة/التصحيح/الرفع
      const event = new Event('input'); $("#mValue").dispatchEvent(event); $("#mCarbs").dispatchEvent(event);
      toast('وضع التعديل مفعّل لهذا التوقيت');
    }

    /* ===== حفظ القياس ===== */
    async function onSave(){
      const date = $("#mDate").value.trim();
      const slot = $("#mSlot").value;
      const unit = document.querySelector('input[name="unit"]:checked').value; // mmol | mg
      const raw  = Number($("#mValue").value||0);

      if(!date || !slot){ toast('اختاري التاريخ ووقت القياس'); return; }
      if(!(raw>0)){ toast('أدخلي قراءة صحيحة'); return; }

      // التحويل إلى mmol/L
      const mmol = unit==='mg' ? round1(raw/18) : round1(raw);

      // جرعات وملاحظات
      const carbs = ($("#mCarbs").value==='') ? null : Number($("#mCarbs").value);
      const mealDose = ($("#mDoseGiven").value==='') ? null : Number($("#mDoseGiven").value);
      const correction = ($("#mCorr").value==='') ? null : Number($("#mCorr").value);
      const raised = $("#mRaisedWith").value.trim() || null;
      const note   = $("#mNote").value.trim() || null;

      // تحديد الحالة
      const low  = Number(child?.lowThreshold);
      const high = Number(child?.highThreshold);
      const status = stateBy(mmol, low, high);

      showLoader(true);
      try{
        const ref  = doc(db,'users',uid,'children',childId,'measurements',date);
        const snap = await getDoc(ref);
        const base = snap.data() || { date, readings:{} };
        if(!base.readings) base.readings = {};

        // منع تكرار نفس الوقت لنفس اليوم—إلا في وضع التعديل على نفس الخانة
        if(!editMode.on){
          if(base.readings[slot] && base.readings[slot].valueMmol!=null){
            toast('⚠️ هذا الوقت مُسجّل بالفعل لهذا اليوم'); showLoader(false); return;
          }
        }else{
          // لو في وضع التعديل لكن غيّرتِ السلوْت ممنوع (المربع مقفول بالفعل)
          if(editMode.slot !== slot){
            toast('⚠️ لا يمكنكِ تغيير وقت القياس أثناء التعديل'); showLoader(false); return;
          }
        }

        base.readings[slot] = {
          valueMmol: mmol,
          status,
          carbs,
          mealDose,
          correctionGiven: correction,
          raisedWith: raised,
          note
        };

        await setDoc(ref, base, {merge:true});
        toast(editMode.on ? '✅ تم تحديث القياس' : '✅ تم حفظ القياس');

        // إنهاء وضع التعديل إن وجد
        editMode={on:false,slot:null};
        $("#mCancelEdit").classList.add('hide');
        $("#mSlot").disabled=false;

        // تفريغ الحقول الخفيفة
        // $("#mValue").value=''; $("#mCarbs").value=''; $("#mDoseGiven").value=''; $("#mCorr").value=''; $("#mRaisedWith").value=''; $("#mNote").value='';

        await loadDay();
      }catch(e){
        console.error(e);
        toast('⚠️ فشل الحفظ — تحققي من الصلاحيات');
      }finally{
        showLoader(false);
      }
    }

    /* ===== Utils ===== */
    function escapeHTML(str){ return String(str||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
  </script>
</body>
</html>
