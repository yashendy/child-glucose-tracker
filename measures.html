<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ±</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .state{display:inline-block;padding:2px 8px;border-radius:999px}
    .state.ok{background:#ecfdf5;color:#16a34a}
    .state.low{background:#fff7ed;color:#b45309}
    .state.high{background:#fee2e2;color:#dc2626}
    .small{font-size:12px;color:#6b7280}
    .table{width:100%;border-collapse:separate;border-spacing:0}
    .table th,.table td{border:1px solid #e5e7eb;padding:8px;text-align:right;vertical-align:top}
    .table thead th{background:#f1f5f9;font-weight:800}
    .center{text-align:center}
  </style>
</head>
<body>

  <!-- Ø¨Ù†Ø± Ø§Ù„Ø·ÙÙ„ -->
  <div id="childBanner" style="text-align:center; padding:12px 8px; display:none">
    <img id="bannerAvatar" class="avatar" style="width:84px;height:84px" src="images/avatar-default.png" alt="ØµÙˆØ±Ø© Ø§Ù„Ø·ÙÙ„">
    <div style="margin-top:6px;font-weight:800" id="bannerName">â€”</div>
    <div class="note" id="bannerMeta">â€”</div>
  </div>

  <!-- Topbar -->
  <div class="topbar">
    <div>ğŸ§ª Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ±</div>
    <div class="row">
      <a id="lnkHome" class="btn gray">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <button id="btnLogout" class="btn">Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <main class="container">
    <!-- Nav -->
    <div class="card"><div class="row" id="childNav"></div></div>

    <!-- Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù‚ÙŠØ§Ø³ -->
    <section class="card">
      <h3 style="margin:0 0 8px">Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠØ§Ø³</h3>
      <div class="grid g3" style="margin:10px 0">
        <div>
          <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
          <input id="mDate" type="date">
        </div>
        <div>
          <label>ÙˆÙ‚Øª Ø§Ù„Ù‚ÙŠØ§Ø³</label>
          <select id="mSlot">
            <option value="">â€” Ø§Ø®ØªØ§Ø±ÙŠ â€”</option>
            <option value="uponWake">Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸</option>
            <option value="preBreakfast">Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±</option>
            <option value="postBreakfast">Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±</option>
            <option value="preLunch">Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡</option>
            <option value="postLunch">Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡</option>
            <option value="preDinner">Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡</option>
            <option value="postDinner">Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡</option>
            <option value="beforeSleep">Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…</option>
            <option value="duringSleep">Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…</option>
            <option value="beforeExercise">Ù‚Ø¨Ù„ Ø§Ù„ØªÙ…Ø±ÙŠÙ†</option>
            <option value="afterExercise">Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠÙ†</option>
            <option value="random">Ù‚ÙŠØ§Ø³ Ø¹Ø´ÙˆØ§Ø¦ÙŠ</option>
            <option value="other">Ø£Ø®Ø±Ù‰</option>
          </select>
        </div>
        <div>
          <label>Ù‚Ø±Ø§Ø¡Ø© mmol/L</label>
          <input id="valMmol" type="number" step="0.1" min="0" placeholder="Ù…Ø«Ø§Ù„: 7.8">
        </div>

        <div>
          <label>Ù‚Ø±Ø§Ø¡Ø© mg/dL</label>
          <input id="valMg" type="number" step="1" min="0" placeholder="Ù…Ø«Ø§Ù„: 140">
        </div>
        <div>
          <label>ÙƒØ§Ø±Ø¨ (Ø¬Ù…) â€” Ø§Ø®ØªÙŠØ§Ø±ÙŠ</label>
          <input id="mCarbs" type="number" step="0.1" min="0">
        </div>
        <div>
          <label>Ø¬Ø±Ø¹Ø© ÙˆØ¬Ø¨Ø© Ù…Ù‚ØªØ±Ø­Ø©</label>
          <input id="doseSuggested" readonly placeholder="ÙŠÙØ­Ø³Ø¨ Ù…Ù† ICR">
        </div>

        <!-- ØªØ¸Ù‡Ø± Ø´Ø±Ø·ÙŠÙ‹Ø§ -->
        <div id="corrBox">
          <label>Ø¬Ø±Ø¹Ø© ØªØµØ­ÙŠØ­ÙŠØ© Ù…Ù‚ØªØ±Ø­Ø©</label>
          <input id="corrSuggested" readonly placeholder="ÙŠÙØ­Ø³Ø¨ Ù…Ù† CF/Ø§Ù„Ù‡Ø¯Ù">
        </div>
        <div id="corrGivenBox">
          <label>Ø¬Ø±Ø¹Ø© ØªØµØ­ÙŠØ­ÙŠØ© ÙØ¹Ù„ÙŠØ©</label>
          <input id="corrGiven" type="number" step="0.1" min="0">
        </div>

        <div id="raiseBox">
          <label>Ø±ÙØ¹ Ø§Ù„Ø³ÙƒØ± (Ù„Ù„Ù…Ù†Ø®ÙØ¶)</label>
          <input id="raisedWith" placeholder="Ø¹ØµÙŠØ±/ØªÙ…Ø±â€¦">
        </div>
        <div style="grid-column:1/-1">
          <label>Ù…Ù„Ø§Ø­Ø¸Ø©</label>
          <input id="mNote" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ">
        </div>
      </div>

      <div class="row" style="justify-content:flex-end">
        <button id="mSave" class="btn primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³</button>
      </div>
      <div class="small" style="margin-top:6px">ÙŠØªÙ… Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ù„Ø£Ù‚Ø±Ø¨ 0.1 mmol/L. Ù„Ø§ ÙŠÙØ³Ù…Ø­ Ø¨ØªÙƒØ±Ø§Ø± Ù†ÙØ³ Ø§Ù„ØªÙˆÙ‚ÙŠØª Ù„Ù†ÙØ³ Ø§Ù„ØªØ§Ø±ÙŠØ®.</div>
    </section>

    <!-- Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„ÙŠÙˆÙ… -->
    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:end">
        <div>
          <h3 style="margin:0">ğŸ“… Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
          <div class="small">Ø§Ø®ØªØ§Ø±ÙŠ ØªØ§Ø±ÙŠØ®Ù‹Ø§ Ù„Ø¹Ø±Ø¶ Ù‚Ø±Ø§Ø¡Ø§Øª Ø°Ù„Ùƒ Ø§Ù„ÙŠÙˆÙ….</div>
        </div>
        <div class="row">
          <input id="dayPicker" type="date">
          <button id="btnLoadDay" class="btn">Ø¹Ø±Ø¶</button>
        </div>
      </div>
      <table class="table" style="margin-top:8px">
        <thead>
          <tr>
            <th>Ø§Ù„ÙˆÙ‚Øª</th>
            <th>Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</th>
            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
            <th>Ø¬Ø±Ø¹Ø§Øª</th>
            <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="mRows">
          <tr><td colspan="5" class="note center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠØ§Ø³Ø§Øª.</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <div id="toast" class="toast"></div>
  <div id="loader" class="loader"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>

  <script type="module">
    import { auth, db, ensureAuth, requireChildIdFromQuery, setChildAvatar } from './firebase-init.js';
    import { signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const $=s=>document.querySelector(s);
    const toast=(m)=>{const t=$("#toast");t.textContent=m;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),2000)}
    const showLoader=(on)=>{$("#loader").style.display=on?"flex":"none"}

    const mLabels={
      uponWake:'Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸',
      preBreakfast:'Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±', postBreakfast:'Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±',
      preLunch:'Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡',      postLunch:'Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡',
      preDinner:'Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡',     postDinner:'Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡',
      beforeSleep:'Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…',    duringSleep:'Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…',
      beforeExercise:'Ù‚Ø¨Ù„ Ø§Ù„ØªÙ…Ø±ÙŠÙ†', afterExercise:'Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠÙ†',
      random:'Ù‚ÙŠØ§Ø³ Ø¹Ø´ÙˆØ§Ø¦ÙŠ', other:'Ø£Ø®Ø±Ù‰'
    };
    const mOrder=['uponWake','preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep','beforeExercise','afterExercise','random','other'];
    const z2=n=>String(n).padStart(2,'0');
    const todayISO=()=>{const d=new Date();return `${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())}`};
    const round1=n=>Math.round(Number(n)*10)/10;
    function stateBy(v, low, high){ if(v==null||isNaN(v)) return 'ok'; if(isFinite(low)&&v<low) return 'low'; if(isFinite(high)&&v>high) return 'high'; return 'ok' }

    let uid=null, childId=null, child={};

    (async function boot(){
      showLoader(true);
      const u=await ensureAuth(); uid=u.uid; childId=requireChildIdFromQuery();

      // nav
      const nav=$("#childNav"); nav.innerHTML="";
      [
        ['child-dashboard.html','Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'],
        ['measures.html','Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ±'],
        ['meals.html','Ø§Ù„ÙˆØ¬Ø¨Ø§Øª'],
        ['reports.html','Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±'],
        ['visits.html','Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©'],
        ['doctor-report.html','ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¯ÙƒØªÙˆØ±']
      ].forEach(([h,t])=>{
        const a=document.createElement('a'); a.className='btn gray'; a.href=`${h}?child=${encodeURIComponent(childId)}`; a.textContent=t; nav.appendChild(a);
      });
      $("#lnkHome").href=`child-dashboard.html?child=${encodeURIComponent(childId)}`;

      await loadChild();
      initInputs();
      await loadDayTable($("#dayPicker").value);

      $("#btnLogout").addEventListener('click', ()=>signOut(auth).then(()=>location.href='index.html'));
      showLoader(false);
    })().catch(err=>{console.error(err);toast('ÙØ´Ù„ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©');showLoader(false)});

    async function loadChild(){
      const s=await getDoc(doc(db,'users',uid,'children',childId));
      child=s.data()||{};
      setChildAvatar($("#bannerAvatar"), child.name, child.photoURL);
      $("#bannerName").textContent=child.name||'â€”';
      $("#bannerMeta").textContent=[child.gender||'', (child.weight!=null?child.weight+' ÙƒØ¬Ù…':'â€”'), (child.height!=null?child.height+' Ø³Ù…':'â€”')].filter(Boolean).join(' â€¢ ');
      $("#childBanner").style.display='block';
    }

    function initInputs(){
      $("#mDate").value=todayISO();
      $("#dayPicker").value=todayISO();
      // Ø±Ø¨Ø· mmol/mg
      $("#valMmol").addEventListener('input', ()=>{
        const v=Number($("#valMmol").value); $("#valMg").value = v? Math.round(v*18) : '';
        recomputeDoseBoxes();
      });
      $("#valMg").addEventListener('input', ()=>{
        const v=Number($("#valMg").value); $("#valMmol").value = v? (Math.round((v/18)*10)/10).toFixed(1) : '';
        recomputeDoseBoxes();
      });
      $("#mCarbs").addEventListener('input', recomputeDoseBoxes);
      $("#mSave").addEventListener('click', saveMeasure);
      $("#btnLoadDay").addEventListener('click', ()=>loadDayTable($("#dayPicker").value));
      $("#dayPicker").addEventListener('change', ()=>loadDayTable($("#dayPicker").value));
    }

    function recomputeDoseBoxes(){
      const mmol=Number($("#valMmol").value)||null;
      const target=Number(child?.target)||null;
      const cf=Number(child?.correctionFactor)||null;
      const icr=Number(child?.icr)||null;
      const carbs=Number($("#mCarbs").value)||0;

      // ÙˆØ¬Ø¨Ø© Ù…Ù‚ØªØ±Ø­Ø©
      $("#doseSuggested").value = (icr>0 && carbs>0) ? (Math.round((carbs/icr)*10)/10).toFixed(1) : '';

      const low=Number(child?.lowThreshold), high=Number(child?.highThreshold);
      const st= stateBy(mmol, low, high);

      // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø±ÙØ¹/Ø§Ù„ØªØµØ­ÙŠØ­ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
      const showCorr = (st==='high');
      const showRaise = (st==='low');
      $("#corrBox").style.display = showCorr? 'block':'none';
      $("#corrGivenBox").style.display = showCorr? 'block':'none';
      $("#raiseBox").style.display = showRaise? 'block':'none';

      // ØªØµØ­ÙŠØ­ Ù…Ù‚ØªØ±Ø­
      if(showCorr && isFinite(target)&&target>0 && isFinite(cf)&&cf>0 && mmol!=null){
        const corr = Math.max(0, (mmol - target)/cf);
        $("#corrSuggested").value = (Math.round(corr*10)/10).toFixed(1);
      }else{
        $("#corrSuggested").value='';
      }
      if(!showCorr){ $("#corrGiven").value=''; }
      if(!showRaise){ $("#raisedWith").value=''; }
    }

    async function saveMeasure(){
      const date=$("#mDate").value.trim();
      const slot=$("#mSlot").value;
      const mmol = Number($("#valMmol").value);
      if(!date||!slot) return toast('Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ù‚ÙŠØ§Ø³');
      if(!(mmol>0)) return toast('ÙƒØªØ§Ø¨Ø© Ù‚Ø±Ø§Ø¡Ø© ØµØ­ÙŠØ­Ø© (mmol/L)');

      // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±: Ø¥Ø°Ø§ ÙŠÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø¡Ø© Ù„Ù†ÙØ³ slot ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ… â€” Ø§Ø±ÙØ¶ÙŠ
      const ref=doc(db,'users',uid,'children',childId,'measurements',date);
      const snap=await getDoc(ref);
      const base=snap.data()||{date, readings:{}};
      if(base.readings && base.readings[slot] && base.readings[slot].valueMmol!=null){
        toast('Ù‡Ø°Ø§ Ø§Ù„ØªÙˆÙ‚ÙŠØª Ù…Ø³Ø¬Ù‘Ù„ Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…'); return;
      }

      const low=Number(child?.lowThreshold), high=Number(child?.highThreshold);
      const st=stateBy(mmol, low, high);
      const carbs = $("#mCarbs").value? Number($("#mCarbs").value): null;
      const mealDose = $("#doseSuggested").value? Number($("#doseSuggested").value): null;
      const corrSuggested = $("#corrSuggested").value? Number($("#corrSuggested").value): null;
      const corrGiven = $("#corrGiven").value? Number($("#corrGiven").value): null;
      const raised = $("#raisedWith").value || null;
      const note = $("#mNote").value || null;

      if(!base.readings) base.readings={};
      base.readings[slot] = {
        valueMmol: Math.round(mmol*10)/10,
        status: st,
        carbs,
        mealDose,
        correctionSuggested: corrSuggested ?? null,
        correctionGiven: (st==='high' ? (corrGiven ?? null) : null),
        raisedWith: (st==='low' ? (raised ?? null) : null),
        note
      };

      await setDoc(ref, base, {merge:true});
      toast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³');
      await loadDayTable(date);

      // ØªÙØ±ÙŠØº Ø¬Ø²Ø¦ÙŠ
      $("#mSlot").value=''; $("#valMmol").value=''; $("#valMg").value='';
      $("#mCarbs").value=''; $("#doseSuggested").value=''; $("#corrSuggested").value=''; $("#corrGiven").value=''; $("#raisedWith").value=''; $("#mNote").value='';
      recomputeDoseBoxes();
    }

    async function loadDayTable(date){
      if(!date){ $("#mRows").innerHTML='<tr><td colspan="5" class="note center">â€”</td></tr>'; return; }
      const ref=doc(db,'users',uid,'children',childId,'measurements',date);
      const snap=await getDoc(ref);
      const data=snap.data()||{};
      const readings=data.readings||{};
      let html=''; let any=false;
      const low=Number(child?.lowThreshold), high=Number(child?.highThreshold);

      mOrder.forEach(k=>{
        const r=readings[k];
        if(!r || (r.valueMmol==null && r.value==null)) return;
        any=true;
        const v=round1(Number(r.valueMmol ?? r.value));
        const st=stateBy(v, low, high);
        const doses=[ r.mealDose!=null?`ÙˆØ¬Ø¨Ø©: ${r.mealDose}U`:'' , r.correctionGiven!=null?`ØªØµØ­ÙŠØ­: ${r.correctionGiven}U`:'' ].filter(Boolean).join(' â€¢ ') || 'â€”';
        const notes = r.note || r.raisedWith || 'â€”';
        html+=`
          <tr>
            <td><b>${mLabels[k]}</b></td>
            <td>${v.toFixed(1)} mmol/L</td>
            <td><span class="state ${st}">${st==='low'?'Ù…Ù†Ø®ÙØ¶':st==='high'?'Ù…Ø±ØªÙØ¹':'Ø·Ø¨ÙŠØ¹ÙŠ'}</span></td>
            <td>${doses}</td>
            <td>${escapeHTML(notes)}</td>
          </tr>`;
      });
      $("#mRows").innerHTML = any? html : `<tr><td colspan="5" class="note center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠØ§Ø³Ø§Øª.</td></tr>`;
    }

    function escapeHTML(s){return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]))}
  </script>
</body>
</html>
