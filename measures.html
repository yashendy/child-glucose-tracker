<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ± â€” Ø§Ù„Ø·ÙÙ„</title>
<style>
:root{--brand:#0ea5e9;--brand2:#6ee7b7;--line:#e5e7eb;--ink:#0f172a;--muted:#6b7280;--bg:#f6fbff;--card:#fff;
--ok:#16a34a;--low:#b45309;--high:#dc2626;--okbg:#ecfdf5;--lowbg:#fff7ed;--highbg:#fee2e2;}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.6 system-ui,"Tajawal",sans-serif}
a{text-decoration:none;color:inherit}
header{position:sticky;top:0;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;padding:12px 14px;display:flex;justify-content:space-between;align-items:center;z-index:5}
header .btn{color:#fff;border:1px solid #ffffff66;background:#ffffff22;padding:8px 12px;border-radius:10px;cursor:pointer}
.container{max-width:1100px;margin:auto;padding:14px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:0 6px 24px rgba(0,0,0,.04);margin-bottom:12px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{border:none;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
.btn.primary{background:var(--brand);color:#fff}
.btn.gray{background:#eef2f7}
.small{font-size:12px;color:var(--muted)}
/* Ø·ÙÙ„ */
.child-head{display:flex;justify-content:space-between;align-items:center;gap:14px;flex-wrap:wrap}
.kid{display:flex;gap:12px;align-items:center}
.avatar{width:56px;height:56px;border-radius:50%;object-fit:cover;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.12)}
/* Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ */
.grid{display:grid;gap:10px}
.g3{grid-template-columns:repeat(3,minmax(0,1fr))}
.g2{grid-template-columns:repeat(2,minmax(0,1fr))}
@media(max-width:900px){.g3{grid-template-columns:1fr} .g2{grid-template-columns:1fr}}
label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
input,select{width:100%;padding:9px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}
.hide{display:none!important}
/* Ø¬Ø¯ÙˆÙ„ */
.table{width:100%;border-collapse:separate;border-spacing:0}
.table th,.table td{border:1px solid var(--line);padding:8px;text-align:right;vertical-align:top}
.table thead th{background:#f0f9ff;font-weight:800}
.center{text-align:center}
.state{display:inline-block;padding:2px 8px;border-radius:999px}
.state.ok{background:var(--okbg);color:var(--ok)}
.state.low{background:var(--lowbg);color:var(--low)}
.state.high{background:var(--highbg);color:var(--high)}
.note{color:var(--muted)}
</style>
</head>
<body>

<header>
  <div>ğŸ§ª Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ± â€” Ø§Ù„Ø·ÙÙ„</div>
  <div class="row">
    <a class="btn" href="dashboard.html">Ù„ÙˆØ­Ø© ÙˆÙ„ÙŠÙ‘ Ø§Ù„Ø£Ù…Ø±</a>
    <a id="backToChild" class="btn" href="#">Ù„ÙˆØ­Ø© Ø§Ù„Ø·ÙÙ„</a>
  </div>
</header>

<main class="container">
  <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„ -->
  <section class="card child-head" id="headCard" style="display:none">
    <div class="kid">
      <img id="kidAvatar" class="avatar" src="default.jpg" alt="ØµÙˆØ±Ø© Ø§Ù„Ø·ÙÙ„">
      <div>
        <div id="kidName" style="font-weight:800">â€”</div>
        <div id="kidMeta" class="small">â€”</div>
      </div>
    </div>
    <div class="small" id="kidSetup">Ø§Ù„ÙˆØ­Ø¯Ø©: mmol/L â€¢ Ø­Ø¯ÙˆØ¯: â€”</div>
  </section>

  <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ -->
  <section class="card">
    <h3 style="margin:0 0 8px">Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù‚ÙŠØ§Ø³</h3>
    <div class="grid g3">
      <div>
        <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
        <input id="mDate" type="date">
      </div>
      <div>
        <label>ÙˆÙ‚Øª Ø§Ù„Ù‚ÙŠØ§Ø³</label>
        <select id="mSlot">
          <option value="">â€” Ø§Ø®ØªØ§Ø±ÙŠ â€”</option>
          <option value="uponWake">Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸</option>
          <option value="preBreakfast">Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±</option>
          <option value="postBreakfast">Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±</option>
          <option value="preLunch">Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡</option>
          <option value="postLunch">Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡</option>
          <option value="preDinner">Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡</option>
          <option value="postDinner">Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡</option>
          <option value="beforeSleep">Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…</option>
          <option value="duringSleep">Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…</option>
        </select>
      </div>
      <div>
        <label>Ø§Ù„ÙˆØ­Ø¯Ø©</label>
        <select id="mUnitSel">
          <option value="mmol">mmol/L</option>
          <option value="mgdl">mg/dL</option>
        </select>
      </div>

      <div>
        <label>Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</label>
        <input id="mValue" type="number" step="0.1" min="0" placeholder="Ù…Ø«Ø§Ù„: 7.8 Ø£Ùˆ 140">
      </div>
      <div>
        <label>ÙƒØ§Ø±Ø¨ (Ø¬Ù…)</label>
        <input id="mCarbs" type="number" step="0.1" min="0" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ">
      </div>
      <div>
        <label>Ø¬Ø±Ø¹Ø© ÙˆØ¬Ø¨Ø© Ù…Ù‚ØªØ±Ø­Ø© (ICR)</label>
        <input id="mDoseSuggested" readonly placeholder="ØªØ­Ø³Ø¨ Ø¢Ù„ÙŠÙ‹Ø§ Ù…Ù† ICR">
      </div>

      <!-- ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ -->
      <div id="boxCorrection" class="hide">
        <label>Ø¬Ø±Ø¹Ø© ØªØµØ­ÙŠØ­ÙŠØ© (Ù…Ù‚ØªØ±Ø­Ø©)</label>
        <input id="mCorrectionSuggested" readonly>
      </div>
      <div id="boxCorrectionGiven" class="hide">
        <label>Ø¬Ø±Ø¹Ø© ØªØµØ­ÙŠØ­ÙŠØ© ÙØ¹Ù„ÙŠØ©</label>
        <input id="mCorrectionGiven" type="number" step="0.1" min="0" placeholder="ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù‚ØªØ±Ø­">
      </div>

      <!-- ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ù‡Ø¨ÙˆØ· -->
      <div id="boxRaise" class="hide">
        <label>Ø±ÙØ¹ Ø§Ù„Ø³ÙƒØ± (Ù„Ùˆ Ù…Ù†Ø®ÙØ¶)</label>
        <input id="mRaisedWith" placeholder="Ø¹ØµÙŠØ±/Ø¬Ù„ÙˆÙƒÙˆØ²...">
      </div>

      <div>
        <label>Ù…Ù„Ø§Ø­Ø¸Ø©</label>
        <input id="mNote" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ">
      </div>
    </div>

    <div class="row" style="justify-content:flex-end;gap:8px;margin-top:8px">
      <button id="mSave" class="btn primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³</button>
    </div>

    <div class="small" style="margin-top:6px">Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø¯Ø§Ø®Ù„ÙŠÙ‹Ø§ Ø¨Ù€ mmol/L (Ù…Ø¹ Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© ÙˆÙˆØ­Ø¯ØªÙ‡Ø§). ÙŠØªÙ… Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ Ù„Ø£Ù‚Ø±Ø¨ 0.1.</div>
  </section>

  <!-- Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„ÙŠÙˆÙ… -->
  <section class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">ğŸ“… Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
      <div class="row">
        <input id="dayPicker" type="date">
        <button id="btnLoadDay" class="btn gray">Ø¹Ø±Ø¶ Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„ÙŠÙˆÙ…</button>
      </div>
    </div>
    <div class="small">Ø§Ù„ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ØªØ§Ø±ÙŠØ® (ÙˆØ²Ø± Ù„Ø¹Ø±Ø¶ ÙŠØ¯ÙˆÙŠÙ‹Ø§ Ø£ÙŠØ¶Ù‹Ø§).</div>
    <table class="table" style="margin-top:8px">
      <thead>
        <tr>
          <th>Ø§Ù„ÙˆÙ‚Øª</th>
          <th>Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th>Ø¬Ø±Ø¹Ø§Øª</th>
          <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
          <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
        </tr>
      </thead>
      <tbody id="mRows">
        <tr><td colspan="6" class="note center">â€”</td></tr>
      </tbody>
    </table>
  </section>
</main>

<script type="module">
/* Firebase init (Ù†ÙØ³ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø´ØªØ±Ùƒ) */
import { app, db, auth } from './firebase-init.js';
import {
  doc, getDoc, setDoc
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
import {
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

/* Helpers */
const $ = s => document.querySelector(s);
const z2 = n => String(n).padStart(2,'0');
const todayISO = ()=>{ const d=new Date(); return `${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())}`; };
const round1 = n => Math.round(Number(n)*10)/10;

const labels={
  uponWake:'Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸',
  preBreakfast:'Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±', postBreakfast:'Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±',
  preLunch:'Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡',     postLunch:'Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡',
  preDinner:'Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡',    postDinner:'Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡',
  beforeSleep:'Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…',   duringSleep:'Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…'
};
const order=['uponWake','preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep'];

let uid=null, childId=new URL(location.search).searchParams.get('child');
let child=null;

/* Auth & load child */
onAuthStateChanged(auth, async (u)=>{
  if(!u){ location.href='index.html'; return; }
  uid=u.uid;
  if(!childId){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ø·ÙÙ„ ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·'); return; }
  await loadChild();
  initForm();
  initDayTable();
});

async function loadChild(){
  const snap = await getDoc(doc(db,'users',uid,'children',childId));
  if(!snap.exists()){ alert('Ø§Ù„Ø·ÙÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }
  child = snap.data();
  $('#headCard').style.display='flex';
  $('#kidName').textContent = child.name||'â€”';
  $('#kidMeta').textContent = `${child.gender||''} â€¢ ${child.weight??'â€”'} ÙƒØ¬Ù… â€¢ ${child.height??'â€”'} Ø³Ù…`;
  $('#kidSetup').textContent = `Ø§Ù„ÙˆØ­Ø¯Ø©: mmol/L â€¢ Ø­Ø¯ÙˆØ¯: ${child.lowThreshold??'â€”'} â€” ${child.highThreshold??'â€”'}`;
  if(child.photoURL) $('#kidAvatar').src = child.photoURL;
  // Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø·ÙÙ„
  $('#backToChild').href = `child-dashboard.html?child=${encodeURIComponent(childId)}`;
}

/* ============ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ============ */
function initForm(){
  // ØªÙˆØ§Ø±ÙŠØ® Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
  $('#mDate').value = todayISO();
  $('#dayPicker').value = todayISO();

  // ØªØ­Ø¯ÙŠØ« ICR (Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯) Ù„Ø­Ø³Ø§Ø¨ Ø¬Ø±Ø¹Ø© Ø§Ù„ÙˆØ¬Ø¨Ø© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© Ø¹Ù†Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒØ§Ø±Ø¨
  const recomputeMealDose = ()=>{
    const carbs = Number($('#mCarbs').value)||0;
    const icr = Number(child?.icr)||0;
    $('#mDoseSuggested').value = (icr>0 && carbs>0) ? (Math.round((carbs/icr)*10)/10).toFixed(1) : '';
  };
  $('#mCarbs').addEventListener('input', recomputeMealDose);

  // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©/Ø§Ù„ÙˆØ­Ø¯Ø© Ø­Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØ£Ø¸Ù‡Ø±/Ø£Ø®ÙÙ Ø§Ù„Ø®Ø§Ù†Ø§Øª
  ['mValue','mUnitSel'].forEach(id=> $('#'+id).addEventListener('input', onReadingChange));

  // Ø­ÙØ¸
  $('#mSave').addEventListener('click', saveMeasure);
}

function toMmol(value, unitSel){
  const v = Number(value)||0;
  return unitSel==='mgdl' ? round1(v/18) : round1(v);
}
function stateBy(v){
  const low = Number(child?.lowThreshold);
  const high= Number(child?.highThreshold);
  if(isFinite(low) && v<low) return 'low';
  if(isFinite(high)&& v>high) return 'high';
  return 'ok';
}
function showBox(id, show){ const el=$(id); if(!el) return; el.classList.toggle('hide', !show); }

function onReadingChange(){
  const unit = $('#mUnitSel').value;
  const raw  = $('#mValue').value;
  if(!raw){ showBox('#boxCorrection',false); showBox('#boxCorrectionGiven',false); showBox('#boxRaise',false); return; }
  const mmol = toMmol(raw, unit);
  const st   = stateBy(mmol);

  if(st==='high'){
    // Ø§Ø­Ø³Ø¨ Ø§Ù„ØªØµØ­ÙŠØ­ÙŠ Ø§Ù„Ù…Ù‚ØªØ±Ø­
    const cfMmol = getCorrectionFactorMmol();
    const target = Number(child?.target) || midpoint();
    const excess = Math.max(0, mmol - target);
    const sug    = (cfMmol>0)? round1(excess / cfMmol) : null;
    $('#mCorrectionSuggested').value = (sug!=null && isFinite(sug) && sug>0)? sug.toFixed(1) : '';
    showBox('#boxCorrection',true);
    showBox('#boxCorrectionGiven',true);
    showBox('#boxRaise',false);
  }else if(st==='low'){
    showBox('#boxCorrection',false);
    showBox('#boxCorrectionGiven',false);
    showBox('#boxRaise',true);
  }else{
    showBox('#boxCorrection',false);
    showBox('#boxCorrectionGiven',false);
    showBox('#boxRaise',false);
  }
}
function midpoint(){
  const lo=Number(child?.lowThreshold), hi=Number(child?.highThreshold);
  if(isFinite(lo)&&isFinite(hi)) return round1((lo+hi)/2);
  return 7.0; // Ù‚ÙŠÙ…Ø© Ø¢Ù…Ù†Ø©
}
function getCorrectionFactorMmol(){
  if(Number(child?.correctionFactorMmol)>0) return Number(child.correctionFactorMmol);
  if(Number(child?.correctionFactorMgDl)>0) return round1(Number(child.correctionFactorMgDl)/18);
  // Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙÙƒÙŠÙƒ Ù†Øµ Ù…Ø«Ù„ "1u-3"
  if(typeof child?.correction==='string'){
    const m=child.correction.match(/1u\s*[-/]\s*(\d+(\.\d+)?)/i);
    if(m) return Number(m[1]);
  }
  return 0; // ØºÙŠØ± Ù…ØªØ§Ø­
}

/* Ø­ÙØ¸ Ù…Ø¹ Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± */
async function saveMeasure(){
  const date=$('#mDate').value.trim();
  const slot=$('#mSlot').value;
  const unit=$('#mUnitSel').value;    // mmol | mgdl
  const rawV=$('#mValue').value;
  if(!date || !slot){ alert('Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ù‚ÙŠØ§Ø³'); return; }
  const mmol = toMmol(rawV, unit);
  if(!(mmol>0)){ alert('Ø£Ø¯Ø®Ù„ÙŠ Ù‚Ø±Ø§Ø¡Ø© ØµØ­ÙŠØ­Ø©'); return; }

  const ref = doc(db,'users',uid,'children',childId,'measurements',date);
  const snap= await getDoc(ref);
  const base= snap.data() || { date, readings:{} };
  if(!base.readings) base.readings={};

  // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ù†ÙØ³ Ø§Ù„ØªÙˆÙ‚ÙŠØª
  if(base.readings[slot]){
    const ok = confirm('ÙŠÙˆØ¬Ø¯ Ù‚ÙŠØ§Ø³ Ù„Ù‡Ø°Ø§ Ø§Ù„ØªÙˆÙ‚ÙŠØª Ø§Ù„ÙŠÙˆÙ…. Ù‡Ù„ ØªØ±ØºØ¨ÙŠÙ† ÙÙŠ ØªØ¹Ø¯ÙŠÙ„Ù‡ØŸ');
    if(!ok) return;
  }

  const carbs = $('#mCarbs').value===''? null : Number($('#mCarbs').value);
  const mealDose = $('#mDoseSuggested').value===''? null : Number($('#mDoseSuggested').value);
  const corrSug  = $('#mCorrectionSuggested').value===''? null : Number($('#mCorrectionSuggested').value);
  const corrGiven= $('#mCorrectionGiven').value===''? null : Number($('#mCorrectionGiven').value);
  const raised   = ($('#mRaisedWith').value||'') || null;
  const note     = ($('#mNote').value||'') || null;

  const st = stateBy(mmol);

  base.readings[slot] = {
    valueMmol: round1(mmol),
    originalValue: rawV===''? null : Number(rawV),
    originalUnit: unit==='mgdl'?'mgdl':'mmol',
    status: st,
    carbs,
    mealDose,
    correctionSuggested: corrSug,
    correctionGiven: corrGiven,
    raisedWith: (st==='low'? raised : null),
    note
  };

  await setDoc(ref, base, {merge:true});
  alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³');

  // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ… Ù„Ùˆ ÙƒØ§Ù† Ù…Ø¹Ø±ÙˆØ¶Ù‹Ø§
  if($('#dayPicker').value === date) await loadDayTable(date);
}

/* ============ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ… ============ */
function initDayTable(){
  $('#dayPicker').addEventListener('change', ()=> loadDayTable($('#dayPicker').value));
  $('#btnLoadDay').addEventListener('click', ()=> loadDayTable($('#dayPicker').value));
  // Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„
  loadDayTable($('#dayPicker').value || todayISO());
}
function arrow(st){ return st==='low'?'â¬‡ï¸':(st==='high'?'â¬†ï¸':'ğŸŸ¢'); }
function stateBadge(st){
  const lbl = st==='low'?'Ù…Ù†Ø®ÙØ¶':(st==='high'?'Ù…Ø±ØªÙØ¹':'Ø·Ø¨ÙŠØ¹ÙŠ');
  return `<span class="state ${st}">${lbl}</span>`;
}
async function loadDayTable(date){
  if(!date) date=todayISO();
  const ref = doc(db,'users',uid,'children',childId,'measurements',date);
  const snap= await getDoc(ref);
  const data= snap.data()||{};
  const readings = data.readings||{};

  const tbody=$('#mRows'); tbody.innerHTML='';

  let hasAny=false;
  order.forEach(key=>{
    const r=readings[key];
    if(!r || r.valueMmol==null) return;
    hasAny=true;
    const doses = [
      (r.mealDose!=null?`ÙˆØ¬Ø¨Ø©: ${r.mealDose}U`:''),
      (r.correctionGiven!=null?`ØªØµØ­ÙŠØ­: ${r.correctionGiven}U`:'')
    ].filter(Boolean).join(' â€¢ ') || 'â€”';
    const notes = (r.raisedWith||r.note)? [r.raisedWith||'', r.note||''].filter(Boolean).join(' â€” ') : 'â€”';
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><b>${labels[key]}</b></td>
      <td>${Number(r.valueMmol).toFixed(1)} ${arrow(r.status)}</td>
      <td>${stateBadge(r.status)}</td>
      <td>${doses}</td>
      <td>${notes}</td>
      <td><button class="btn gray" data-slot="${key}">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button></td>
    `;
    tr.querySelector('button').addEventListener('click', ()=> fillFormForEdit(date,key,r));
    tbody.appendChild(tr);
  });

  if(!hasAny) tbody.innerHTML = `<tr><td colspan="6" class="note center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠØ§Ø³Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….</td></tr>`;
}

function fillFormForEdit(date,slot,r){
  $('#mDate').value = date;
  $('#mSlot').value = slot;
  // Ø£Ø¹ÙØ¯ Ø§Ù„Ø£ØµÙ„ ÙƒÙ…Ø§ Ø£Ø¯Ø®ÙÙ„ (Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯)
  if(r.originalUnit==='mgdl' && r.originalValue!=null){
    $('#mUnitSel').value='mgdl'; $('#mValue').value = r.originalValue;
  }else{
    $('#mUnitSel').value='mmol'; $('#mValue').value = Number(r.valueMmol).toFixed(1);
  }
  $('#mCarbs').value = r.carbs??'';
  $('#mDoseSuggested').value = r.mealDose??'';
  $('#mCorrectionSuggested').value = r.correctionSuggested??'';
  $('#mCorrectionGiven').value = r.correctionGiven??'';
  $('#mRaisedWith').value = r.raisedWith||'';
  $('#mNote').value = r.note||'';
  onReadingChange(); // Ù„ØªØ­Ø¯ÙŠØ« Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø®Ø§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
}
</script>
</body>
</html>
