<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ููุงุณุงุช ุงูุทูู</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <!-- โ ุจูุฑ ุงูุทูู -->
  <div id="childBanner" style="text-align:center; padding:12px 8px; display:none">
    <img id="bannerAvatar" class="avatar" style="width:84px;height:84px" src="images/avatar-default.png" alt="ุตูุฑุฉ ุงูุทูู">
    <div style="margin-top:6px;font-weight:800" id="bannerName">โ</div>
    <div class="note" id="bannerMeta">โ</div>
  </div>

  <!-- โ Topbar -->
  <div class="topbar">
    <div>๐งช ููุงุณุงุช ุงูุณูุฑ</div>
    <div class="row">
      <a id="lnkHome" class="btn gray">ุงูุฑุฆูุณูุฉ</a>
      <button id="btnLogout" class="btn">ุฎุฑูุฌ</button>
    </div>
  </div>

  <main class="container">
    <!-- โ Nav -->
    <div class="card"><div class="row" id="childNav"></div></div>

    <!-- ุฅุฏุฎุงู ููุงุณ -->
    <section class="card">
      <h3 class="section-title">ุฅุฏุฎุงู ููุงุณ</h3>
      <div class="grid g3">
        <div><label>ุงูุชุงุฑูุฎ</label><input id="mDate" type="date"></div>
        <div><label>ููุช ุงูููุงุณ</label>
          <select id="mSlot">
            <option value="">โ ุงุฎุชุงุฑู โ</option>
            <option value="uponWake">ุงูุงุณุชููุงุธ</option>
            <option value="preBreakfast">ูุจู ุงูุฅูุทุงุฑ</option>
            <option value="postBreakfast">ุจุนุฏ ุงูุฅูุทุงุฑ</option>
            <option value="preLunch">ูุจู ุงูุบุฏุงุก</option>
            <option value="postLunch">ุจุนุฏ ุงูุบุฏุงุก</option>
            <option value="preDinner">ูุจู ุงูุนุดุงุก</option>
            <option value="postDinner">ุจุนุฏ ุงูุนุดุงุก</option>
            <option value="beforeSleep">ูุจู ุงูููู</option>
            <option value="duringSleep">ุฃุซูุงุก ุงูููู</option>
            <option value="beforeExercise">ูุจู ุงูุชูุฑูู</option>
            <option value="afterExercise">ุจุนุฏ ุงูุชูุฑูู</option>
            <option value="random">ููุงุณ ุนุดูุงุฆู</option>
            <option value="other">ุฃุฎุฑู</option>
          </select>
        </div>
        <div><label>ุงููุฑุงุกุฉ (mmol/L)</label><input id="mVal" type="number" step="0.1" min="0"></div>

        <div><label>ูุงุฑุจ (ุฌู)</label><input id="mCarbs" type="number" step="0.1" min="0"></div>
        <div><label>ุฌุฑุนุฉ ููุชุฑุญุฉ ูููุฌุจุฉ (ICR)</label><input id="doseMealSug" readonly></div>
        <div><label>ุฌุฑุนุฉ ูุนููุฉ (ูุฌุจุฉ)</label><input id="doseMealGiven" type="number" step="0.1" min="0"></div>

        <div><label>ุฌุฑุนุฉ ุชุตุญูุญูุฉ (ุชุธูุฑ ูู ูุฑุชูุน)</label><input id="doseCorr" type="number" step="0.1" min="0" disabled></div>
        <div><label>ุฑูุน ุงูุณูุฑ (ูู ููุฎูุถ)</label><input id="raisedWith" placeholder="ุนุตูุฑ/ุชูุฑ..." disabled></div>
        <div><label>ููุงุญุธุฉ</label><input id="mNote" placeholder="ุงุฎุชูุงุฑู"></div>
      </div>

      <div class="row" style="justify-content:flex-end">
        <button id="btnSave" class="btn primary">๐พ ุญูุธ ุงูููุงุณ</button>
      </div>
    </section>

    <!-- ูุฑุงุกุงุช ุงูููู -->
    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 class="section-title">๐ ูุฑุงุกุงุช ุงูููู</h3>
        <div class="row">
          <label style="margin:0">ุจุญุซ ุจุชุงุฑูุฎ</label>
          <input id="searchDate" type="date">
        </div>
      </div>
      <div class="note">ุงูุชูุฑูุจ ูุฃูุฑุจ 0.1 (ูุซุงู 7.8)</div>
      <table class="table">
        <thead>
          <tr>
            <th>ุงูููุช</th>
            <th>ุงููุฑุงุกุฉ</th>
            <th>ุงูุญุงูุฉ</th>
            <th>ุฌุฑุนุงุช</th>
            <th>ููุงุญุธุงุช</th>
            <th>ุชุนุฏูู</th>
          </tr>
        </thead>
        <tbody id="rows"><tr><td colspan="6" class="center note">ูุง ุชูุฌุฏ ููุงุณุงุช.</td></tr></tbody>
      </table>
    </section>
  </main>

  <div id="toast" class="toast"></div>
  <div id="loader" class="loader"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>

  <script type="module">
    import { auth, db, ensureAuth, requireChildIdFromQuery, setChildAvatar } from './firebase-init.js';
    import { signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const toast=(m)=>{const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000)}
    const showLoader=(on)=>{document.getElementById('loader').style.display=on?'flex':'none'}
    const labels={
      uponWake:'ุงูุงุณุชููุงุธ',preBreakfast:'ูุจู ุงูุฅูุทุงุฑ',postBreakfast:'ุจุนุฏ ุงูุฅูุทุงุฑ',
      preLunch:'ูุจู ุงูุบุฏุงุก',postLunch:'ุจุนุฏ ุงูุบุฏุงุก',
      preDinner:'ูุจู ุงูุนุดุงุก',postDinner:'ุจุนุฏ ุงูุนุดุงุก',
      beforeSleep:'ูุจู ุงูููู',duringSleep:'ุฃุซูุงุก ุงูููู',
      beforeExercise:'ูุจู ุงูุชูุฑูู',afterExercise:'ุจุนุฏ ุงูุชูุฑูู',random:'ุนุดูุงุฆู',other:'ุฃุฎุฑู'
    };
    const order=['uponWake','preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep','beforeExercise','afterExercise','random','other'];

    let uid=null, childId=null, child=null;

    function buildNav(){
      const row=document.getElementById('childNav'); row.innerHTML='';
      [['child-dashboard.html','ุงูุฑุฆูุณูุฉ'],['measures.html','ููุงุณุงุช ุงูุณูุฑ'],['meals.html','ุงููุฌุจุงุช'],['reports.html','ุงูุชูุงุฑูุฑ'],['visits.html','ุงูุฒูุงุฑุงุช ุงูุทุจูุฉ']]
      .forEach(([href,t])=>{
        const a=document.createElement('a'); a.className='btn gray'; a.href=`${href}?child=${encodeURIComponent(childId)}`; a.textContent=t; row.appendChild(a);
      });
      document.getElementById('lnkHome').href=`child-dashboard.html?child=${encodeURIComponent(childId)}`;
    }

    function round1(n){const v=Math.round(Number(n)*10)/10;return Number.isFinite(v)?v:null}
    function stateBy(v,lo,hi){ if(v==null) return 'ok'; if(isFinite(lo)&&v<lo) return 'low'; if(isFinite(hi)&&v>hi) return 'high'; return 'ok'; }

    async function loadChild(){
      const s=await getDoc(doc(db,'users',uid,'children',childId));
      if(!s.exists()){ toast('ุงูุทูู ุบูุฑ ููุฌูุฏ'); return; }
      child=s.data();
      setChildAvatar(document.getElementById('bannerAvatar'), child.name, child.photoURL);
      bannerName.textContent=child.name||'โ';
      bannerMeta.textContent=`${child.gender||'โ'} โข ${child.weight||'โ'} ูุฌู โข ${child.height||'โ'} ุณู`;
      childBanner.style.display='block';
    }

    async function loadDay(date){
      const ref=doc(db,'users',uid,'children',childId,'measurements',date);
      const snap=await getDoc(ref);
      const data=snap.data()||{};
      const readings=data.readings||{};
      const lo=Number(child?.lowThreshold), hi=Number(child?.highThreshold);
      const tb=document.getElementById('rows'); let html='';
      order.forEach(k=>{
        const r=readings[k]; if(!r||r.valueMmol==null) return;
        const v=round1(r.valueMmol); const st=stateBy(v,lo,hi);
        const doses=[r.mealDose!=null?`ูุฌุจุฉ: ${r.mealDose}U`:'' , r.correctionGiven!=null?`ุชุตุญูุญ: ${r.correctionGiven}U`:'' ].filter(Boolean).join(' โข ')||'โ';
        const note=r.note||r.raisedWith||'โ';
        html+=`<tr>
          <td><b>${labels[k]}</b></td>
          <td>${v.toFixed(1)}</td>
          <td><span class="state ${st}">${st==='low'?'ููุฎูุถ':st==='high'?'ูุฑุชูุน':'ุทุจูุนู'}</span></td>
          <td>${doses}</td>
          <td>${escapeHTML(note)}</td>
          <td><button class="btn gray" data-edit="${k}">โ๏ธ ุชุนุฏูู</button></td>
        </tr>`;
      });
      tb.innerHTML=html||`<tr><td colspan="6" class="center note">ูุง ุชูุฌุฏ ููุงุณุงุช.</td></tr>`;
      // ุฑุจุท ุงูุชุนุฏูู
      tb.querySelectorAll('button[data-edit]').forEach(btn=>{
        btn.addEventListener('click',()=> {
          mSlot.value = btn.dataset.edit;
          mVal.focus();
        });
      });
    }

    function escapeHTML(s){return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]))}

    // ุญุณุงุจุงุช UI
    function recomputeMealDose(){
      const carbs = Number(mCarbs.value)||0;
      const icr = Number(child?.icr)||0;
      doseMealSug.value = (icr>0 && carbs>0) ? (Math.round((carbs/icr)*10)/10).toFixed(1) : '';
    }
    mCarbs?.addEventListener('input', recomputeMealDose);

    // ุงูุชุญูู ูู ุงูุญููู ุจูุงุกู ุนูู ุงูุญุงูุฉ
    function onValueChange(){
      const v = Number(mVal.value)||null;
      const lo=Number(child?.lowThreshold), hi=Number(child?.highThreshold);
      const st = v!=null ? stateBy(v,lo,hi) : 'ok';
      // ุฌุฑุนุฉ ุงูุชุตุญูุญ ุชุธูุฑ ููุท ุนูุฏ ุงุฑุชูุงุน
      doseCorr.disabled = (st!=='high');
      if(st!=='high') doseCorr.value='';
      // ุฑูุน ุงูุณูุฑ ูุธูุฑ ููุท ุนูุฏ ุงูุฎูุงุถ
      raisedWith.disabled = (st!=='low');
      if(st!=='low') raisedWith.value='';
    }
    mVal?.addEventListener('input', onValueChange);

    // ุญูุธ ุงูููุงุณ (ูุน ููุน ุชูุฑุงุฑ ููุณ ุงูููุช ูู ููุณ ุงูููู)
    btnSave.addEventListener('click', async ()=>{
      const date=mDate.value.trim(), slot=mSlot.value, val=round1(mVal.value);
      if(!date||!slot||!(val>0)){ toast('ุฃุฏุฎูู ุงูุชุงุฑูุฎ/ุงูููุช/ุงููุฑุงุกุฉ'); return; }
      showLoader(true);
      const ref=doc(db,'users',uid,'children',childId,'measurements',date);
      const snap=await getDoc(ref);
      const base=snap.data()||{date, readings:{}};
      if(base.readings?.[slot]?.valueMmol!=null){ showLoader(false); toast('โ ูุณุฌู ุจุงููุนู ููุฐุง ุงูููุช'); return; }
      base.readings = base.readings||{};
      base.readings[slot]={
        valueMmol: val,
        status: stateBy(val, Number(child?.lowThreshold), Number(child?.highThreshold)),
        carbs: mCarbs.value? Number(mCarbs.value):null,
        mealDose: doseMealGiven.value? Number(doseMealGiven.value):null,
        correctionGiven: doseCorr.value? Number(doseCorr.value):null,
        raisedWith: raisedWith.value||null,
        note: mNote.value||null
      };
      await setDoc(ref, base, {merge:true});
      toast('โ ุชู ุงูุญูุธ');
      await loadDay(date);
      showLoader(false);
    });

    // Boot
    let today = new Date().toISOString().slice(0,10);
    (async function(){
      const {uid:U}=await ensureAuth(); uid=U;
      childId=requireChildIdFromQuery();
      document.getElementById('lnkHome').href=`child-dashboard.html?child=${encodeURIComponent(childId)}`;
      // nav
      const nav=document.getElementById('childNav'); nav.innerHTML='';
      [['child-dashboard.html','ุงูุฑุฆูุณูุฉ'],['measures.html','ููุงุณุงุช ุงูุณูุฑ'],['meals.html','ุงููุฌุจุงุช'],['reports.html','ุงูุชูุงุฑูุฑ'],['visits.html','ุงูุฒูุงุฑุงุช ุงูุทุจูุฉ']]
      .forEach(([h,t])=>{ const a=document.createElement('a'); a.className='btn gray'; a.href=`${h}?child=${encodeURIComponent(childId)}`; a.textContent=t; nav.appendChild(a);});

      await loadChild();
      mDate.value = today;
      searchDate.value = today;
      await loadDay(today);

      searchDate.addEventListener('change', ()=> loadDay(searchDate.value||today));
      btnLogout.addEventListener('click', ()=> signOut(auth).then(()=>location.href='index.html'));
    })();
  </script>
</body>
</html>
