<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ููุงุณุงุช ุงูุณูุฑ</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .state{display:inline-block;padding:2px 8px;border-radius:999px}
    .state.ok{background:#ecfdf5;color:#16a34a}
    .state.low{background:#fff7ed;color:#b45309}
    .state.high{background:#fee2e2;color:#dc2626}
    .small{font-size:12px;color:#6b7280}
    .table{width:100%;border-collapse:separate;border-spacing:0}
    .table th,.table td{border:1px solid #e5e7eb;padding:8px;text-align:right;vertical-align:top}
    .table thead th{background:#f1f5f9;font-weight:800}
    .center{text-align:center}
  </style>
</head>
<body>

  <!-- ุจูุฑ ุงูุทูู -->
  <div id="childBanner" style="text-align:center; padding:12px 8px; display:none">
    <img id="bannerAvatar" class="avatar" style="width:84px;height:84px" src="images/avatar-default.png" alt="ุตูุฑุฉ ุงูุทูู">
    <div style="margin-top:6px;font-weight:800" id="bannerName">โ</div>
    <div class="note" id="bannerMeta">โ</div>
  </div>

  <!-- Topbar -->
  <div class="topbar">
    <div>๐งช ููุงุณุงุช ุงูุณูุฑ</div>
    <div class="row">
      <a id="lnkHome" class="btn gray">ุงูุฑุฆูุณูุฉ</a>
      <button id="btnLogout" class="btn">ุฎุฑูุฌ</button>
    </div>
  </div>

  <main class="container">
    <!-- Nav -->
    <div class="card"><div class="row" id="childNav"></div></div>

    <!-- ุฅุฏุฎุงู ุงูููุงุณ -->
    <section class="card">
      <h3 style="margin:0 0 8px">ุฅุฏุฎุงู ููุงุณ</h3>
      <div class="grid g3" style="margin:10px 0">
        <div>
          <label>ุงูุชุงุฑูุฎ</label>
          <input id="mDate" type="date">
        </div>
        <div>
          <label>ููุช ุงูููุงุณ</label>
          <select id="mSlot">
            <option value="">โ ุงุฎุชุงุฑู โ</option>
            <option value="uponWake">ุงูุงุณุชููุงุธ</option>
            <option value="preBreakfast">ูุจู ุงูุฅูุทุงุฑ</option>
            <option value="postBreakfast">ุจุนุฏ ุงูุฅูุทุงุฑ</option>
            <option value="preLunch">ูุจู ุงูุบุฏุงุก</option>
            <option value="postLunch">ุจุนุฏ ุงูุบุฏุงุก</option>
            <option value="preDinner">ูุจู ุงูุนุดุงุก</option>
            <option value="postDinner">ุจุนุฏ ุงูุนุดุงุก</option>
            <option value="beforeSleep">ูุจู ุงูููู</option>
            <option value="duringSleep">ุฃุซูุงุก ุงูููู</option>
            <option value="beforeExercise">ูุจู ุงูุชูุฑูู</option>
            <option value="afterExercise">ุจุนุฏ ุงูุชูุฑูู</option>
            <option value="random">ููุงุณ ุนุดูุงุฆู</option>
            <option value="other">ุฃุฎุฑู</option>
          </select>
        </div>
        <div>
          <label>ูุฑุงุกุฉ mmol/L</label>
          <input id="valMmol" type="number" step="0.1" min="0" placeholder="ูุซุงู: 7.8">
        </div>

        <div>
          <label>ูุฑุงุกุฉ mg/dL</label>
          <input id="valMg" type="number" step="1" min="0" placeholder="ูุซุงู: 140">
        </div>
        <div>
          <label>ูุงุฑุจ (ุฌู) โ ุงุฎุชูุงุฑู</label>
          <input id="mCarbs" type="number" step="0.1" min="0">
        </div>
        <div>
          <label>ุฌุฑุนุฉ ูุฌุจุฉ ููุชุฑุญุฉ</label>
          <input id="doseSuggested" readonly placeholder="ููุญุณุจ ูู ICR">
        </div>

        <!-- ุชุธูุฑ ุดุฑุทููุง -->
        <div id="corrBox">
          <label>ุฌุฑุนุฉ ุชุตุญูุญูุฉ ููุชุฑุญุฉ</label>
          <input id="corrSuggested" readonly placeholder="ููุญุณุจ ูู CF/ุงููุฏู">
        </div>
        <div id="corrGivenBox">
          <label>ุฌุฑุนุฉ ุชุตุญูุญูุฉ ูุนููุฉ</label>
          <input id="corrGiven" type="number" step="0.1" min="0">
        </div>

        <div id="raiseBox">
          <label>ุฑูุน ุงูุณูุฑ (ููููุฎูุถ)</label>
          <input id="raisedWith" placeholder="ุนุตูุฑ/ุชูุฑโฆ">
        </div>
        <div style="grid-column:1/-1">
          <label>ููุงุญุธุฉ</label>
          <input id="mNote" placeholder="ุงุฎุชูุงุฑู">
        </div>
      </div>

      <div class="row" style="justify-content:flex-end">
        <button id="mSave" class="btn primary">๐พ ุญูุธ ุงูููุงุณ</button>
      </div>
      <div class="small" style="margin-top:6px">ูุชู ุงูุชูุฑูุจ ูุฃูุฑุจ 0.1 mmol/L. ูุง ููุณูุญ ุจุชูุฑุงุฑ ููุณ ุงูุชูููุช ูููุณ ุงูุชุงุฑูุฎ.</div>
    </section>

    <!-- ูุฑุงุกุงุช ุงูููู -->
    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:end">
        <div>
          <h3 style="margin:0">๐ ูุฑุงุกุงุช ุงูููู</h3>
          <div class="small">ุงุฎุชุงุฑู ุชุงุฑูุฎูุง ูุนุฑุถ ูุฑุงุกุงุช ุฐูู ุงูููู.</div>
        </div>
        <div class="row">
          <input id="dayPicker" type="date">
          <button id="btnLoadDay" class="btn">ุนุฑุถ</button>
        </div>
      </div>
      <table class="table" style="margin-top:8px">
        <thead>
          <tr>
            <th>ุงูููุช</th>
            <th>ุงููุฑุงุกุฉ</th>
            <th>ุงูุญุงูุฉ</th>
            <th>ุฌุฑุนุงุช</th>
            <th>ููุงุญุธุงุช</th>
          </tr>
        </thead>
        <tbody id="mRows">
          <tr><td colspan="5" class="note center">ูุง ุชูุฌุฏ ููุงุณุงุช.</td></tr>
        </tbody>
      </table>
    </section>
  </main>

  <div id="toast" class="toast"></div>
  <div id="loader" class="loader"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>

  <script type="module">
    import { auth, db, ensureAuth, requireChildIdFromQuery, setChildAvatar } from './firebase-init.js';
    import { signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const $=s=>document.querySelector(s);
    const toast=(m)=>{const t=$("#toast");t.textContent=m;t.classList.add("show");setTimeout(()=>t.classList.remove("show"),2000)}
    const showLoader=(on)=>{$("#loader").style.display=on?"flex":"none"}

    const mLabels={
      uponWake:'ุงูุงุณุชููุงุธ',
      preBreakfast:'ูุจู ุงูุฅูุทุงุฑ', postBreakfast:'ุจุนุฏ ุงูุฅูุทุงุฑ',
      preLunch:'ูุจู ุงูุบุฏุงุก',      postLunch:'ุจุนุฏ ุงูุบุฏุงุก',
      preDinner:'ูุจู ุงูุนุดุงุก',     postDinner:'ุจุนุฏ ุงูุนุดุงุก',
      beforeSleep:'ูุจู ุงูููู',    duringSleep:'ุฃุซูุงุก ุงูููู',
      beforeExercise:'ูุจู ุงูุชูุฑูู', afterExercise:'ุจุนุฏ ุงูุชูุฑูู',
      random:'ููุงุณ ุนุดูุงุฆู', other:'ุฃุฎุฑู'
    };
    const mOrder=['uponWake','preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep','beforeExercise','afterExercise','random','other'];
    const z2=n=>String(n).padStart(2,'0');
    const todayISO=()=>{const d=new Date();return `${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())}`};
    const round1=n=>Math.round(Number(n)*10)/10;
    function stateBy(v, low, high){ if(v==null||isNaN(v)) return 'ok'; if(isFinite(low)&&v<low) return 'low'; if(isFinite(high)&&v>high) return 'high'; return 'ok' }

    let uid=null, childId=null, child={};

    (async function boot(){
      showLoader(true);
      const u=await ensureAuth(); uid=u.uid; childId=requireChildIdFromQuery();

      // nav
      const nav=$("#childNav"); nav.innerHTML="";
      [
        ['child-dashboard.html','ุงูุฑุฆูุณูุฉ'],
        ['measures.html','ููุงุณุงุช ุงูุณูุฑ'],
        ['meals.html','ุงููุฌุจุงุช'],
        ['reports.html','ุงูุชูุงุฑูุฑ'],
        ['visits.html','ุงูุฒูุงุฑุงุช ุงูุทุจูุฉ'],
        ['doctor-report.html','ุชูุฑูุฑ ุงูุฏูุชูุฑ']
      ].forEach(([h,t])=>{
        const a=document.createElement('a'); a.className='btn gray'; a.href=`${h}?child=${encodeURIComponent(childId)}`; a.textContent=t; nav.appendChild(a);
      });
      $("#lnkHome").href=`child-dashboard.html?child=${encodeURIComponent(childId)}`;

      await loadChild();
      initInputs();
      await loadDayTable($("#dayPicker").value);

      $("#btnLogout").addEventListener('click', ()=>signOut(auth).then(()=>location.href='index.html'));
      showLoader(false);
    })().catch(err=>{console.error(err);toast('ูุดู ุงูุชููุฆุฉ');showLoader(false)});

    async function loadChild(){
      const s=await getDoc(doc(db,'users',uid,'children',childId));
      child=s.data()||{};
      setChildAvatar($("#bannerAvatar"), child.name, child.photoURL);
      $("#bannerName").textContent=child.name||'โ';
      $("#bannerMeta").textContent=[child.gender||'', (child.weight!=null?child.weight+' ูุฌู':'โ'), (child.height!=null?child.height+' ุณู':'โ')].filter(Boolean).join(' โข ');
      $("#childBanner").style.display='block';
    }

    function initInputs(){
      $("#mDate").value=todayISO();
      $("#dayPicker").value=todayISO();
      // ุฑุจุท mmol/mg
      $("#valMmol").addEventListener('input', ()=>{
        const v=Number($("#valMmol").value); $("#valMg").value = v? Math.round(v*18) : '';
        recomputeDoseBoxes();
      });
      $("#valMg").addEventListener('input', ()=>{
        const v=Number($("#valMg").value); $("#valMmol").value = v? (Math.round((v/18)*10)/10).toFixed(1) : '';
        recomputeDoseBoxes();
      });
      $("#mCarbs").addEventListener('input', recomputeDoseBoxes);
      $("#mSave").addEventListener('click', saveMeasure);
      $("#btnLoadDay").addEventListener('click', ()=>loadDayTable($("#dayPicker").value));
      $("#dayPicker").addEventListener('change', ()=>loadDayTable($("#dayPicker").value));
    }

    function recomputeDoseBoxes(){
      const mmol=Number($("#valMmol").value)||null;
      const target=Number(child?.target)||null;
      const cf=Number(child?.correctionFactor)||null;
      const icr=Number(child?.icr)||null;
      const carbs=Number($("#mCarbs").value)||0;

      // ูุฌุจุฉ ููุชุฑุญุฉ
      $("#doseSuggested").value = (icr>0 && carbs>0) ? (Math.round((carbs/icr)*10)/10).toFixed(1) : '';

      const low=Number(child?.lowThreshold), high=Number(child?.highThreshold);
      const st= stateBy(mmol, low, high);

      // ุฅุธูุงุฑ ุญููู ุงูุฑูุน/ุงูุชุตุญูุญ ุญุณุจ ุงูุญุงูุฉ
      const showCorr = (st==='high');
      const showRaise = (st==='low');
      $("#corrBox").style.display = showCorr? 'block':'none';
      $("#corrGivenBox").style.display = showCorr? 'block':'none';
      $("#raiseBox").style.display = showRaise? 'block':'none';

      // ุชุตุญูุญ ููุชุฑุญ
      if(showCorr && isFinite(target)&&target>0 && isFinite(cf)&&cf>0 && mmol!=null){
        const corr = Math.max(0, (mmol - target)/cf);
        $("#corrSuggested").value = (Math.round(corr*10)/10).toFixed(1);
      }else{
        $("#corrSuggested").value='';
      }
      if(!showCorr){ $("#corrGiven").value=''; }
      if(!showRaise){ $("#raisedWith").value=''; }
    }

    async function saveMeasure(){
      const date=$("#mDate").value.trim();
      const slot=$("#mSlot").value;
      const mmol = Number($("#valMmol").value);
      if(!date||!slot) return toast('ุงุฎุชุงุฑู ุงูุชุงุฑูุฎ ูููุช ุงูููุงุณ');
      if(!(mmol>0)) return toast('ูุชุงุจุฉ ูุฑุงุกุฉ ุตุญูุญุฉ (mmol/L)');

      // ููุน ุงูุชูุฑุงุฑ: ุฅุฐุง ููุฌุฏ ูุฑุงุกุฉ ูููุณ slot ูู ููุณ ุงูููู โ ุงุฑูุถู
      const ref=doc(db,'users',uid,'children',childId,'measurements',date);
      const snap=await getDoc(ref);
      const base=snap.data()||{date, readings:{}};
      if(base.readings && base.readings[slot] && base.readings[slot].valueMmol!=null){
        toast('ูุฐุง ุงูุชูููุช ูุณุฌูู ุจุงููุนู ููุฐุง ุงูููู'); return;
      }

      const low=Number(child?.lowThreshold), high=Number(child?.highThreshold);
      const st=stateBy(mmol, low, high);
      const carbs = $("#mCarbs").value? Number($("#mCarbs").value): null;
      const mealDose = $("#doseSuggested").value? Number($("#doseSuggested").value): null;
      const corrSuggested = $("#corrSuggested").value? Number($("#corrSuggested").value): null;
      const corrGiven = $("#corrGiven").value? Number($("#corrGiven").value): null;
      const raised = $("#raisedWith").value || null;
      const note = $("#mNote").value || null;

      if(!base.readings) base.readings={};
      base.readings[slot] = {
        valueMmol: Math.round(mmol*10)/10,
        status: st,
        carbs,
        mealDose,
        correctionSuggested: corrSuggested ?? null,
        correctionGiven: (st==='high' ? (corrGiven ?? null) : null),
        raisedWith: (st==='low' ? (raised ?? null) : null),
        note
      };

      await setDoc(ref, base, {merge:true});
      toast('โ ุชู ุญูุธ ุงูููุงุณ');
      await loadDayTable(date);

      // ุชูุฑูุบ ุฌุฒุฆู
      $("#mSlot").value=''; $("#valMmol").value=''; $("#valMg").value='';
      $("#mCarbs").value=''; $("#doseSuggested").value=''; $("#corrSuggested").value=''; $("#corrGiven").value=''; $("#raisedWith").value=''; $("#mNote").value='';
      recomputeDoseBoxes();
    }

    async function loadDayTable(date){
      if(!date){ $("#mRows").innerHTML='<tr><td colspan="5" class="note center">โ</td></tr>'; return; }
      const ref=doc(db,'users',uid,'children',childId,'measurements',date);
      const snap=await getDoc(ref);
      const data=snap.data()||{};
      const readings=data.readings||{};
      let html=''; let any=false;
      const low=Number(child?.lowThreshold), high=Number(child?.highThreshold);

      mOrder.forEach(k=>{
        const r=readings[k];
        if(!r || (r.valueMmol==null && r.value==null)) return;
        any=true;
        const v=round1(Number(r.valueMmol ?? r.value));
        const st=stateBy(v, low, high);
        const doses=[ r.mealDose!=null?`ูุฌุจุฉ: ${r.mealDose}U`:'' , r.correctionGiven!=null?`ุชุตุญูุญ: ${r.correctionGiven}U`:'' ].filter(Boolean).join(' โข ') || 'โ';
        const notes = r.note || r.raisedWith || 'โ';
        html+=`
          <tr>
            <td><b>${mLabels[k]}</b></td>
            <td>${v.toFixed(1)} mmol/L</td>
            <td><span class="state ${st}">${st==='low'?'ููุฎูุถ':st==='high'?'ูุฑุชูุน':'ุทุจูุนู'}</span></td>
            <td>${doses}</td>
            <td>${escapeHTML(notes)}</td>
          </tr>`;
      });
      $("#mRows").innerHTML = any? html : `<tr><td colspan="5" class="note center">ูุง ุชูุฌุฏ ููุงุณุงุช.</td></tr>`;
    }

    function escapeHTML(s){return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]))}
  </script>
</body>
</html>
