<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ±</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="topbar">
  <div>ğŸ§ª Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ±</div>
  <div class="row">
    <a id="lnkDash" class="btn gray">Ù„ÙˆØ­Ø© Ø§Ù„Ø·ÙÙ„</a>
    <a id="lnkHome" class="btn gray">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
  </div>
</div>

<main class="container">
  <section class="card">
    <div class="row" style="gap:12px;align-items:center">
      <img id="avatar" class="avatar" style="width:64px;height:64px" src="images/avatar-default.png" alt="">
      <div>
        <div id="kidName" style="font-weight:800">â€”</div>
        <div id="kidMeta" class="note">â€”</div>
      </div>
      <span class="badge-soft" id="unitBadge">Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø©: mmol/L</span>
    </div>
  </section>

  <section class="card">
    <h3 style="margin-top:0">Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠØ§Ø³</h3>
    <div class="grid g3">
      <div>
        <label>ØªØ§Ø±ÙŠØ®</label>
        <input id="mDate" type="date">
      </div>
      <div>
        <label>Ø§Ù„ÙˆÙ‚Øª</label>
        <select id="mSlot">
          <option value="">â€” Ø§Ø®ØªØ§Ø±ÙŠ â€”</option>
          <option value="uponWake">Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸</option>
          <option value="preBreakfast">Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±</option>
          <option value="postBreakfast">Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±</option>
          <option value="preLunch">Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡</option>
          <option value="postLunch">Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡</option>
          <option value="preDinner">Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡</option>
          <option value="postDinner">Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡</option>
          <option value="beforeSleep">Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…</option>
          <option value="duringSleep">Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…</option>
          <option value="beforeExercise">Ù‚Ø¨Ù„ Ø§Ù„ØªÙ…Ø±ÙŠÙ†</option>
          <option value="afterExercise">Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠÙ†</option>
          <option value="random">Ù‚ÙŠØ§Ø³ Ø¹Ø´ÙˆØ§Ø¦ÙŠ</option>
        </select>
      </div>

      <div>
        <label>Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„</label>
        <select id="mUnitSel">
          <option value="mmol">mmol/L</option>
          <option value="mgdl">mg/dL</option>
        </select>
      </div>

      <div>
        <label>Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</label>
        <input id="mValue" type="number" step="0.1" min="0" placeholder="Ù…Ø«Ø§Ù„ 7.8 Ø£Ùˆ 140">
      </div>

      <div>
        <label>ÙƒØ§Ø±Ø¨ (Ø¬Ù…)</label>
        <input id="mCarbs" type="number" step="0.1" min="0">
      </div>

      <div>
        <label>Ø¬Ø±Ø¹Ø© ÙˆØ¬Ø¨Ø© (ÙØ¹Ù„ÙŠØ©)</label>
        <input id="mDoseGiven" type="number" step="0.1" min="0">
      </div>

      <div id="boxCorr" style="display:none">
        <label>Ø¬Ø±Ø¹Ø© ØªØµØ­ÙŠØ­ÙŠØ© (Ù…Ù‚ØªØ±Ø­Ø©)</label>
        <input id="mCorrection" type="number" step="0.1" min="0" placeholder="Ù…Ù‚ØªØ±Ø­ â€” Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„">
      </div>

      <div id="boxRaise" style="display:none">
        <label>Ø±ÙØ¹ Ø§Ù„Ø³ÙƒØ± (Ù…Ø«Ø§Ù„ Ø¹ØµÙŠØ±/ØªÙ…Ø±)</label>
        <input id="mRaisedWith" placeholder="Ù…Ø«Ø§Ù„: 100 Ù…Ù„ Ø¹ØµÙŠØ±">
      </div>

      <div style="grid-column:1/-1">
        <label>Ù…Ù„Ø§Ø­Ø¸Ø©</label>
        <input id="mNote" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ">
      </div>
    </div>

    <div class="row" style="justify-content:flex-end">
      <button id="btnSave" class="btn primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³</button>
    </div>
  </section>

  <section class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0">ğŸ“… Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
      <div class="row">
        <input id="dayPicker" type="date">
        <button id="btnLoadDay" class="btn">Ø¹Ø±Ø¶ Ø§Ù„ÙŠÙˆÙ…</button>
      </div>
    </div>
    <table class="table">
      <thead><tr><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¬Ø±Ø¹Ø§Øª</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th>ØªØ¹Ø¯ÙŠÙ„</th></tr></thead>
      <tbody id="rows"><tr><td colspan="6" class="note center">â€”</td></tr></tbody>
    </table>
  </section>
</main>

<script type="module">
import { auth, db, ensureAuth, requireChildIdFromQuery, loadChildProfile, setChildAvatar, round1, mgdlToMmol, todayISO } from './firebase-init.js';
import { doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const $=s=>document.querySelector(s);

let uid=null, childId=null, child=null;

const labels={
  uponWake:'Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸', preBreakfast:'Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±', postBreakfast:'Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±',
  preLunch:'Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡', postLunch:'Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡',
  preDinner:'Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡', postDinner:'Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡',
  beforeSleep:'Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…', duringSleep:'Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…',
  beforeExercise:'Ù‚Ø¨Ù„ Ø§Ù„ØªÙ…Ø±ÙŠÙ†', afterExercise:'Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠÙ†', random:'Ù‚ÙŠØ§Ø³ Ø¹Ø´ÙˆØ§Ø¦ÙŠ'
};
const order=['uponWake','preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep','beforeExercise','afterExercise','random'];

(async function boot(){
  ({uid}=await ensureAuth());
  childId = requireChildIdFromQuery();
  $('#lnkDash').href=`child-dashboard.html?child=${encodeURIComponent(childId)}`;
  $('#lnkHome').href=`dashboard.html`;

  child = await loadChildProfile(uid, childId);
  setChildAvatar($('#avatar'), child.name, child.photoURL);
  $('#kidName').textContent = child.name||'â€”';
  $('#kidMeta').textContent = `${child.gender||'â€”'} â€¢ ${child.weight??'â€”'} ÙƒØ¬Ù… â€¢ ${child.height??'â€”'} Ø³Ù…`;
  $('#unitBadge').textContent = 'Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø©: ' + (child.preferredUnit||'mmol/L');

  const today = todayISO();
  $('#mDate').value = today;
  $('#dayPicker').value = today;

  // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
  $('#mValue').addEventListener('input', refreshDynamicFields);
  $('#mUnitSel').addEventListener('change', refreshDynamicFields);

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…
  $('#btnLoadDay').addEventListener('click', loadDay);
  $('#dayPicker').addEventListener('change', loadDay);
  await loadDay();

  $('#btnSave').addEventListener('click', saveMeasure);
})();

function computeMmolFromInput(){
  const typ = $('#mUnitSel').value; // mmol | mgdl
  const val = Number($('#mValue').value)||0;
  if(typ==='mmol') return round1(val);
  // mg/dL â†’ mmol/L
  return mgdlToMmol(val);
}

function refreshDynamicFields(){
  const mmol = computeMmolFromInput();
  const low  = Number(child.lowThreshold);
  const high = Number(child.highThreshold);
  const boxCorr = $('#boxCorr'); const boxRaise = $('#boxRaise');

  if(!mmol || isNaN(low) || isNaN(high)){ boxCorr.style.display='none'; boxRaise.style.display='none'; return; }
  if(mmol > high){
    // Ø§Ù‚ØªØ±Ø­ Ø¬Ø±Ø¹Ø© ØªØµØ­ÙŠØ­ÙŠØ©: Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ùƒ target Ùˆ correctionFactor (ÙƒÙ… mmol ØªÙ†Ø²Ù„Ù‡Ø§ 1U)
    const target = Number(child.target)||high; // fallback
    const delta  = Math.max(0, mmol - target);
    const cf     = Number(child.correctionFactor)||0; // mmol/L per 1U
    const suggested = (cf>0)? round1(delta / cf) : null;
    $('#mCorrection').value = (suggested!=null && suggested>0)? suggested : '';
    boxCorr.style.display='block'; boxRaise.style.display='none';
  }else if(mmol < low){
    boxCorr.style.display='none'; boxRaise.style.display='block';
  }else{
    boxCorr.style.display='none'; boxRaise.style.display='none';
  }
}

async function loadDay(){
  const date = $('#dayPicker').value || todayISO();
  const ref = doc(db,'users',uid,'children',childId,'measurements',date);
  const snap = await getDoc(ref);
  const data = snap.data()||{};
  const readings = data.readings||{};
  const tbody = $('#rows'); tbody.innerHTML='';

  let html='';
  order.forEach(k=>{
    const r=readings[k];
    if(!r) return;
    const v = round1(r.valueMmol ?? r.value);
    const st = status(v);
    const doses = [
      r.mealDose!=null ? `ÙˆØ¬Ø¨Ø©: ${r.mealDose}U` : '',
      r.correctionGiven!=null ? `ØªØµØ­ÙŠØ­: ${r.correctionGiven}U` : ''
    ].filter(Boolean).join(' â€¢ ') || 'â€”';
    const note = r.note || r.raisedWith || 'â€”';

    html += `<tr>
      <td><b>${labels[k]}</b></td>
      <td>${v.toFixed(1)} mmol/L</td>
      <td><span class="state ${st}">${st==='low'?'Ù…Ù†Ø®ÙØ¶':st==='high'?'Ù…Ø±ØªÙØ¹':'Ø·Ø¨ÙŠØ¹ÙŠ'}</span></td>
      <td>${doses}</td>
      <td>${escapeHTML(note)}</td>
      <td><button class="btn gray" onclick="editSlot('${date}','${k}')">âœï¸</button></td>
    </tr>`;
  });
  tbody.innerHTML = html || `<tr><td colspan="6" class="note center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠØ§Ø³Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….</td></tr>`;
}

// ØªØ¹Ø¯ÙŠÙ„ Ø³Ø±ÙŠØ¹
window.editSlot = async function(date,slot){
  $('#mDate').value = date;
  $('#mSlot').value = slot;
  alert('ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ… Ø£Ø¹Ù„Ø§Ù‡ Ø«Ù… Ø§Ù„Ø¶ØºØ· Ø­ÙØ¸ Ù„ØªØ­Ø¯ÙŠØ« Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø§Ù†Ø©.');
}

function status(v){
  const lo=Number(child.lowThreshold), hi=Number(child.highThreshold);
  if(!isNaN(lo)&&v<lo) return 'low';
  if(!isNaN(hi)&&v>hi) return 'high';
  return 'ok';
}

function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

async function saveMeasure(){
  const date = $('#mDate').value || todayISO();
  const slot = $('#mSlot').value;
  const mmol = computeMmolFromInput();
  if(!date || !slot){ alert('Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª'); return; }
  if(!(mmol>0)){ alert('Ø£Ø¯Ø®Ù„ÙŠ Ù‚Ø±Ø§Ø¡Ø© ØµØ­ÙŠØ­Ø©'); return; }

  const ref = doc(db,'users',uid,'children',childId,'measurements',date);
  const snap= await getDoc(ref);
  const base = snap.data()||{ date, readings:{} };
  if(!base.readings) base.readings={};

  // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª Ù„Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ… (Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ù‹Ø§ ÙˆÙ„Ù… ØªÙƒÙ† ÙÙŠ ÙˆØ¶Ø¹ ØªØ¹Ø¯ÙŠÙ„)
  if(base.readings[slot] && !confirm('ÙŠÙˆØ¬Ø¯ Ù‚ÙŠØ§Ø³ Ù…Ø³Ø¬Ù„ Ù„Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª â€” Ù‡Ù„ ØªØ±ÙŠØ¯ÙŠÙ† Ø§Ù„ÙƒØªØ§Ø¨Ø© ÙÙˆÙ‚Ù‡ØŸ')) return;

  const v = mmol;
  const lo=Number(child.lowThreshold), hi=Number(child.highThreshold);
  const st = status(v);

  base.readings[slot] = {
    valueMmol: v,
    status: st,
    carbs: $('#mCarbs').value? Number($('#mCarbs').value): null,
    mealDose: $('#mDoseGiven').value? Number($('#mDoseGiven').value): null,
    correctionGiven: (st==='high' && $('#mCorrection').value)? Number($('#mCorrection').value): null,
    raisedWith: (st==='low')? ($('#mRaisedWith').value||null) : null,
    note: $('#mNote').value || null
  };

  await setDoc(ref, base, {merge:true});
  alert('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸');
  // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø®ØªØ§Ø±
  $('#dayPicker').value = date;
  await loadDay();
}
</script>
</body>
</html>
