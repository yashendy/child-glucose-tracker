<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù‚ÙŠØ§Ø³ Ø§Ù„Ø³ÙƒØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</title>
  <style>
    body { font-family: 'Cairo', sans-serif; background: #f0f4f8; color: #333; margin: 0; padding: 20px; }
    h1 { text-align: center; color: #0ea5e9; }
    .container { max-width: 800px; margin: auto; }
    .child-info { background: #dff9fb; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 18px; }
    .field-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; }
    select, input, textarea {
      width: 100%; padding: 10px; border: 1px solid #ccc;
      border-radius: 6px; box-sizing: border-box;
    }
    button {
      background: #0ea5e9; color: white; border: none; padding: 12px 25px;
      border-radius: 8px; cursor: pointer; font-size: 16px;
    }
    button:hover { background: #0284c7; }
    .note { font-size: 14px; color: #888; margin-top: 5px; }
  </style>
</head>
<body>

  <div class="container">
    <h1>ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ù‚ÙŠØ§Ø³ Ø§Ù„Ø³ÙƒØ±</h1>
    <div class="child-info" id="childInfo">ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„...</div>

    <div class="field-group">
      <label for="time">ÙˆÙ‚Øª Ø§Ù„Ù‚ÙŠØ§Ø³</label>
      <select id="time">
        <option value="wakeUp">Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸</option>
        <option value="preBreakfast">Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±</option>
        <option value="postBreakfast">Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±</option>
        <option value="preLunch">Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡</option>
        <option value="postLunch">Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡</option>
        <option value="preDinner">Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡</option>
        <option value="postDinner">Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡</option>
        <option value="bedTime">Ø¹Ù†Ø¯ Ø§Ù„Ù†ÙˆÙ…</option>
        <option value="overnight">Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…</option>
      </select>
    </div>

    <div class="field-group">
      <label for="value">Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³ÙƒØ± (mg/dL)</label>
      <input type="number" id="value" placeholder="Ù…Ø«Ù„Ø§Ù‹ 120" />
    </div>

    <div class="field-group" id="mealGroup" style="display: none;">
      <label for="carbs">ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª (Ø¬Ù…)</label>
      <input type="number" id="carbs" placeholder="Ù…Ø«Ù„Ø§Ù‹ 45" />
      
      <label for="dose">Ø¬Ø±Ø¹Ø© Ø§Ù„Ø£Ù†Ø³ÙˆÙ„ÙŠÙ† (ÙˆØ­Ø¯Ø©)</label>
      <input type="number" id="dose" placeholder="Ù…Ø«Ù„Ø§Ù‹ 3" />
    </div>

    <div class="field-group">
      <label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
      <textarea id="notes" rows="3" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©..."></textarea>
    </div>

    <button id="saveBtn">ğŸ’¾ Ø­ÙØ¸</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    import {
      getAuth, signInAnonymously
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

    const firebaseConfig = {
      // ğŸ” Ø£Ø¯Ø®Ù„ÙŠ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø´Ø±ÙˆØ¹ Firebase Ù‡Ù†Ø§
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const params = new URLSearchParams(location.search);
    const childId = params.get("child");

    const timeSelect = document.getElementById("time");
    const valueInput = document.getElementById("value");
    const carbsInput = document.getElementById("carbs");
    const doseInput = document.getElementById("dose");
    const notesInput = document.getElementById("notes");
    const saveBtn = document.getElementById("saveBtn");
    const childInfo = document.getElementById("childInfo");
    const mealGroup = document.getElementById("mealGroup");

    // â³ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„ÙˆØ¬Ø¨Ø§Øª ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª
    timeSelect.addEventListener("change", () => {
      const value = timeSelect.value;
      if (value === "preBreakfast" || value === "preLunch" || value === "preDinner") {
        mealGroup.style.display = "block";
      } else {
        mealGroup.style.display = "none";
        carbsInput.value = "";
        doseInput.value = "";
      }
    });

    // ğŸ§  ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø¬Ù‡ÙˆÙ„ Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    await signInAnonymously(auth);

    // ğŸ“¦ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„
    const userId = "jlvVQpKzwZaDgUTA2HaXPqJXKfT2"; // â† Ø§Ø³ØªØ¨Ø¯Ù„ÙŠÙ‡Ø§ Ø¨Ù€ UID Ø§Ù„Ø«Ø§Ø¨Øª Ø§Ù„Ø®Ø§Øµ Ø¨ÙƒÙ
    const childRef = doc(db, "users", userId, "children", childId);
    const childSnap = await getDoc(childRef);
    const childData = childSnap.data();
    childInfo.textContent = `Ø§Ù„Ø§Ø³Ù…: ${childData.name} | ICR: ${childData.icr} Ø¬Ù…/ÙˆØ­Ø¯Ø©`;

    // âœ… Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³
    saveBtn.onclick = async () => {
      const time = timeSelect.value;
      const value = parseInt(valueInput.value);
      const carbs = parseFloat(carbsInput.value) || 0;
      const dose = parseFloat(doseInput.value) || 0;
      const notes = notesInput.value.trim();

      if (!value) return alert("Ø£Ø¯Ø®Ù„ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³ÙƒØ±!");

      const now = new Date();
      const dateId = now.toISOString().split("T")[0] + "_" + time;
      const data = {
        createdAt: now,
        value,
        time,
        notes,
      };

      if (["preBreakfast", "preLunch", "preDinner"].includes(time)) {
        data.carbs = carbs;
        data.insulinDose = dose;
      }

      await setDoc(doc(db, "users", userId, "children", childId, "measurements", dateId), data);
      alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
      location.reload();
    };
  </script>
</body>
</html>
