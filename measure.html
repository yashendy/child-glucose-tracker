<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª â€” Ù…ØªØ§Ø¨Ø¹Ø© Ø³ÙƒØ± Ø§Ù„Ø£Ø·ÙØ§Ù„</title>
<style>
:root{
  --brand:#0ea5e9; --brand2:#6ee7b7; --card:#fff; --line:#e5e7eb;
  --ink:#0f172a; --muted:#64748b; --ok:#22c55e; --low:#b45309; --high:#dc2626;
  --bg:#f7fbff;
}
*{box-sizing:border-box}
body{margin:0; background:var(--bg); color:var(--ink);
  font:15px/1.6 system-ui,"Tajawal","Noto Sans Arabic",sans-serif;}
header{position:sticky; top:0; background:linear-gradient(90deg,var(--brand),var(--brand2)); color:#fff; padding:14px 18px; display:flex; align-items:center; justify-content:space-between;}
header a.btn{background:#ffffff22;color:#fff;border:1px solid #ffffff55}
main{max-width:1100px;margin:auto;padding:20px}
.card{background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.03); padding:16px; margin-bottom:16px;}
h2{margin:0 0 12px}
.grid{display:grid; gap:12px}
.g3{grid-template-columns:repeat(3,minmax(0,1fr))}
.g2{grid-template-columns:repeat(2,minmax(0,1fr))}
@media (max-width:900px){ .g3,.g2{grid-template-columns:1fr} }
label{display:block; font-size:13px; color:var(--muted); margin:0 0 6px}
select,input{width:100%; padding:12px 12px; border:1px solid var(--line); border-radius:12px; background:#fff}
.row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
.btn{border:none; border-radius:10px; padding:10px 14px; font-weight:800; cursor:pointer}
.btn.primary{background:var(--brand); color:#fff}
.btn.gray{background:#eef2f7}
.note{color:var(--muted); font-size:13px}
.badge{display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px; font-weight:800}
.b-ok{background:#ecfdf5; color:var(--ok)}
.b-low{background:#fff7ed; color:var(--low)}
.b-high{background:#fee2e2; color:var(--high)}
.table{width:100%; border-collapse:collapse}
th,td{border:1px solid var(--line); padding:10px; text-align:right}
th{background:#f8fafc; color:#0f172a}
.small{font-size:12px;color:var(--muted)}
.toast{position:fixed;bottom:16px;left:16px;background:#111;color:#fff;padding:10px 14px;border-radius:12px;opacity:0;transform:translateY(8px);transition:.28s;z-index:3}
.toast.show{opacity:1;transform:none}
.hide{display:none!important}
.suggest{display:inline-block;background:#eef6ff;color:#0369a1;padding:6px 10px;border-radius:999px;font-weight:800}
.unit-inline{display:grid; grid-template-columns:1fr 160px; gap:8px; align-items:end}
@media (max-width:520px){ .unit-inline{grid-template-columns:1fr} }
.suffix{color:#334155;font-weight:700;font-size:12px;margin-top:6px}
</style>
</head>
<body>
<header>
  <div>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª</div>
  <div class="row">
    <button id="btnEnableNoti" class="btn">ğŸ”” ØªÙØ¹ÙŠÙ„ ØªØ°ÙƒÙŠØ± Ù‚Ø¨Ù„ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª</button>
    <a class="btn" href="dashboard.html">â¬… Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
  </div>
</header>

<main>
  <section class="card">
    <h2>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·ÙÙ„ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®</h2>
    <div class="grid g3">
      <div>
        <label>Ø§Ù„Ø·ÙÙ„</label>
        <select id="childSel"><option value="">â€” Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„Ø·ÙÙ„ â€”</option></select>
        <div id="thrInfo" class="note" style="margin-top:6px"></div>
        <div id="cfInfo" class="note" style="margin-top:4px"></div>
        <div id="icrInfo" class="note" style="margin-top:4px"></div>
      </div>
      <div>
        <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
        <input id="dateSel" type="date" />
      </div>
      <div>
        <label>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆÙ‚Øª</label>
        <select id="slotSel">
          <option value="">â€” Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„ÙˆÙ‚Øª â€”</option>
          <option value="preBreakfast">Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±</option>
          <option value="postBreakfast">Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±</option>
          <option value="preLunch">Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡</option>
          <option value="postLunch">Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡</option>
          <option value="preDinner">Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡</option>
          <option value="postDinner">Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡</option>
          <option value="beforeSleep">Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…</option>
          <option value="duringSleep">Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…</option>
          <option value="uponWake">Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸</option>
        </select>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù‚ÙŠØ§Ø³</h2>
    <div class="grid g3">
      <div>
        <label>Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</label>
        <div class="unit-inline">
          <input id="reading" type="number" step="0.1" min="0" placeholder="Ø§ÙƒØªØ¨ÙŠ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©" />
          <div>
            <label>Ø§Ù„ÙˆØ­Ø¯Ø©</label>
            <select id="unitSel">
              <option value="mmol">mmol/L</option>
              <option value="mgdl">mg/dL</option>
            </select>
          </div>
        </div>
        <div id="unitSuffix" class="suffix">Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: mmol/L</div>
        <div id="bOk" class="badge b-ok hide">âœ”ï¸ Ø¶Ù…Ù† Ø§Ù„Ù…Ø¯Ù‰</div>
        <div id="bLow" class="badge b-low hide">â¬‡ï¸ Ù…Ù†Ø®ÙØ¶ â€” ÙŠØ¬Ø¨ Ø§Ù„Ø±ÙØ¹</div>
        <div id="bHigh" class="badge b-high hide">â¬†ï¸ Ù…Ø±ØªÙØ¹ â€” ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØµØ­ÙŠØ­</div>
      </div>

      <div>
        <label>Ø§Ù„ÙˆØ¬Ø¨Ø© â€” ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª (Ø¬Ø±Ø§Ù…) â€” Ø§Ø®ØªÙŠØ§Ø±ÙŠ</label>
        <div class="unit-inline">
          <input id="carbs" type="number" step="1" min="0" placeholder="Ù…Ø«Ù„Ø§Ù‹ 45">
          <div>
            <label>Ø¬Ø±Ø¹Ø© Ø§Ù„ÙˆØ¬Ø¨Ø© (ÙˆØ­Ø¯Ø©)</label>
            <input id="mealDose" type="number" step="0.5" min="0" placeholder="Ù…Ø«Ù„Ø§Ù‹ 3">
          </div>
        </div>
        <div id="mealSuggestWrap" class="hide" style="margin-top:8px">
          <span class="suggest">Ø¬Ø±Ø¹Ø© Ø§Ù„ÙˆØ¬Ø¨Ø© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø© (ICR): <span id="mealSuggestion">â€”</span> ÙˆØ­Ø¯Ø©</span>
        </div>

        <div id="suggestWrap" class="hide" style="margin-top:8px">
          <span class="suggest">Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„ØªØµØ­ÙŠØ­ÙŠØ© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©: <span id="corrSuggestion">â€”</span> ÙˆØ­Ø¯Ø©</span>
        </div>
      </div>

      <div>
        <label>Ù…Ù„Ø§Ø­Ø¸Ø©</label>
        <input id="note" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ â€” ÙˆØµÙ Ù…Ø®ØªØµØ±" />
        <div id="extraLow" class="hide" style="margin-top:8px">
          <label>Ø§ØªØ±ÙØ¹ Ø¨Ø¥ÙŠÙ‡ØŸ</label>
          <input id="raisedWith" placeholder="Ø¹ØµÙŠØ±/Ø£Ù‚Ø±Ø§Øµ Ø¬Ù„ÙˆÙƒÙˆØ²...">
        </div>
        <div id="extraHigh" class="hide" style="margin-top:8px">
          <label>Ø¬Ø±Ø¹Ø© Ø§Ù„ØªØµØ­ÙŠØ­ÙŠ (Ø§Ù„Ù…ÙØ¹Ø·Ø§Ø©)</label>
          <input id="corrGiven" type="number" step="0.5" min="0" placeholder="Ù…Ø«Ù„Ø§Ù‹ 2">
        </div>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="saveBtn" class="btn primary">Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³</button>
      <button id="clearBtn" class="btn gray">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
      <span class="note">ÙŠÙ…Ù†Ø¹ ØªØ³Ø¬ÙŠÙ„ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª Ù…Ø±ØªÙŠÙ† ÙÙŠ Ø§Ù„ÙŠÙˆÙ… Ù†ÙØ³Ù‡.</span>
    </div>
  </section>

  <section class="card">
    <h2>Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø®ØªØ§Ø±</h2>
    <table class="table">
      <thead>
        <tr>
          <th>Ø§Ù„ÙˆÙ‚Øª</th>
          <th>Ø§Ù„Ù‚ÙŠØ§Ø³</th>
          <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
          <th>Ø¬Ø±Ø¹Ø© Ø§Ù„ÙˆØ¬Ø¨Ø©</th>
          <th>Ø§Ù„ØªØµØ­ÙŠØ­ÙŠ (Ø§Ù„Ù…ÙØ¹Ø·Ø§Ø©)</th>
          <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="6" class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø¡Ø§Øª Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø®ØªØ§Ø± Ø¨Ø¹Ø¯.</td></tr>
      </tbody>
    </table>
  </section>
</main>

<div id="toast" class="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig={apiKey:"AIzaSyCOdrwdbw8b7YdWLPZ4TDdG2iS9kvvxQ7M",authDomain:"child-glucose-tracker.firebaseapp.com",projectId:"child-glucose-tracker",storageBucket:"child-glucose-tracker.firebasestorage.app",messagingSenderId:"294563325904",appId:"1:294563325904:web:39562550bf305fc01abbd5"};
const app=initializeApp(firebaseConfig); const auth=getAuth(app); const db=getFirestore(app);

const $=s=>document.querySelector(s);
const toast=(m)=>{const t=document.querySelector('.toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1700);};

const labels={preBreakfast:'Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±',postBreakfast:'Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±',preLunch:'Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡',postLunch:'Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡',preDinner:'Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡',postDinner:'Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡',beforeSleep:'Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…',duringSleep:'Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…',uponWake:'Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸'};
const order=['preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep','uponWake'];

let uid=null, childId=null;
let low=4, high=10, target=6.5, cfMmol=null, icr=null; // Ø¯Ø§Ø®Ù„ÙŠÙ‹Ø§ mmol
let preferredUnit='mmol';
let mealTimes={breakfast:'07:30', lunch:'13:30', dinner:'19:30'};
let notifyBeforeMins=15;

const initChildId=new URL(location.href).searchParams.get('child');

onAuthStateChanged(auth, async (u)=>{
  if(!u){ location.href='index.html'; return; }
  uid=u.uid; await loadChildren(); setToday();
  if(initChildId){ $('#childSel').value=initChildId; $('#childSel').disabled=true; await onChildChanged(true); }
  else { adjustInputForUnit(); }
});

/* ÙˆØ­Ø¯Ø§Øª */
const unitSel = $('#unitSel');
unitSel.addEventListener('change', ()=>{
  adjustInputForUnit();
  onReadingChange();
  refreshDay();
  refreshThresholdInfo();
});
function toMmol(value, unit){ if(!Number.isFinite(value)) return NaN; return unit==='mgdl' ? value/18 : value; }
function fromMmol(mmol, unit){ if(!Number.isFinite(mmol)) return NaN; return unit==='mgdl' ? Math.round(mmol*18) : Number(mmol.toFixed(1)); }
function adjustInputForUnit(){
  const u=unitSel.value;
  $('#unitSuffix').textContent='Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: '+(u==='mgdl'?'mg/dL':'mmol/L');
  const reading=$('#reading'); reading.step=(u==='mgdl'?'1':'0.1'); reading.placeholder=(u==='mgdl'?'Ù…Ø«Ù„Ø§Ù‹ 120':'Ù…Ø«Ù„Ø§Ù‹ 6.5');
}
function refreshThresholdInfo(){
  const u=unitSel.value;
  const loDisp=fromMmol(low,u), hiDisp=fromMmol(high,u), tgtDisp=fromMmol(target,u);
  $('#thrInfo').textContent='Ø§Ù„Ø­Ø¯ÙˆØ¯ (Ø­Ø³Ø¨ Ø§Ù„ÙˆØ­Ø¯Ø©): Ù…Ù†Ø®ÙØ¶ < '+loDisp+' â€¢ Ù…Ø±ØªÙØ¹ > '+hiDisp+' â€¢ Ø§Ù„Ù‡Ø¯Ù: '+tgtDisp+' '+(u==='mgdl'?'mg/dL':'mmol/L');
  $('#cfInfo').textContent= cfMmol?('Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„ØªØµØ­ÙŠØ­: '+(Math.round(cfMmol*100)/100)+' mmol/L Ù„ÙƒÙ„ 1U'):'âš ï¸ Ù„Ù… ÙŠØªÙ… Ø¶Ø¨Ø· Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„ØªØµØ­ÙŠØ­';
  $('#icrInfo').textContent= icr?('ICR: '+icr+' Ø¬Ù… ÙƒØ§Ø±Ø¨ Ù„ÙƒÙ„ 1U'):'';
}

/* ØªØ­Ù…ÙŠÙ„ */
function setToday(){ const u=new URL(location.href); const d=u.searchParams.get('date'); $('#dateSel').value=d||new Date().toISOString().slice(0,10); }
async function loadChildren(){
  const sel=$('#childSel'); sel.innerHTML='<option value="">â€” ØªØ­Ù…ÙŠÙ„ â€”</option>';
  const q=await getDocs(collection(db,'users',uid,'children'));
  sel.innerHTML='<option value="">â€” Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„Ø·ÙÙ„ â€”</option>';
  q.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=s.data().name||'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'; sel.appendChild(o); });
}

/* Ø£Ø­Ø¯Ø§Ø« */
$('#childSel').addEventListener('change', ()=>onChildChanged(true));
$('#dateSel').addEventListener('change', refreshDay);
$('#slotSel').addEventListener('change', ()=>onReadingChange());
$('#reading').addEventListener('input', onReadingChange);
$('#carbs').addEventListener('input', onCarbsChange);
$('#clearBtn').addEventListener('click', clearInputs);
$('#saveBtn').addEventListener('click', onSave);

/* ØªÙØ¹ÙŠÙ„ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù‚Ø¨Ù„ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª */
document.getElementById('btnEnableNoti').addEventListener('click', async ()=>{
  if(!('Notification' in window)) { alert('Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª'); return; }
  const perm=await Notification.requestPermission();
  if(perm!=='granted'){ alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª'); return; }
  scheduleMealReminders();
  toast('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ°ÙƒÙŠØ± Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… ğŸ””');
});

async function onChildChanged(applyUnit){
  childId=$('#childSel').value||null; 
  if(!childId){ $('#thrInfo').textContent=''; $('#cfInfo').textContent=''; $('#icrInfo').textContent=''; $('#rows').innerHTML=emptyRow(); return; }
  const cs=await getDoc(doc(db,'users',uid,'children',childId));
  const c=cs.data()||{};
  low   =(c.lowThreshold??4);
  high  =(c.highThreshold??10);
  target=(c.targetMmol??6.5);
  cfMmol=(c.correctionFactorMmol!=null)?Number(c.correctionFactorMmol):(c.correctionFactorMgDl!=null?Number(c.correctionFactorMgDl)/18:null);
  icr = (c.icr!=null)? Number(c.icr) : null;
  preferredUnit = c.preferredUnit || 'mmol';
  mealTimes = c.mealTimes || {breakfast:'07:30', lunch:'13:30', dinner:'19:30'};
  notifyBeforeMins = (c.notifyBeforeMins!=null)? Number(c.notifyBeforeMins) : 15;

  if(applyUnit){ unitSel.value=preferredUnit; adjustInputForUnit(); }
  refreshThresholdInfo();
  refreshDay();
}

/* ØªÙ‚ÙŠÙŠÙ… */
function emptyRow(){ return `<tr><td colspan="6" class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø¡Ø§Øª Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø®ØªØ§Ø± Ø¨Ø¹Ø¯.</td></tr>`; }
function evaluate(mmol){ if(mmol===''||!Number.isFinite(Number(mmol)))return null; const n=Number(mmol); if(n<low)return'low'; if(n>high)return'high'; return'ok'; }

function onReadingChange(){
  const raw=Number($('#reading').value);
  const unit=unitSel.value;
  const mmol=toMmol(raw, unit);

  [$('#bOk'),$('#bLow'),$('#bHigh')].forEach(e=>e.classList.add('hide'));
  $('#extraLow').classList.add('hide'); 
  $('#extraHigh').classList.add('hide'); 
  $('#suggestWrap').classList.add('hide');

  if(!Number.isFinite(mmol)) return;
  const st=evaluate(mmol);
  if(st==='low'){ 
    $('#bLow').classList.remove('hide'); 
    $('#extraLow').classList.remove('hide'); 
  }else if(st==='high'){
    $('#bHigh').classList.remove('hide'); 
    $('#extraHigh').classList.remove('hide');
    const seg=suggestedCorrection(mmol); 
    if(seg!=null){ $('#corrSuggestion').textContent=seg; $('#suggestWrap').classList.remove('hide'); }
  } else { 
    $('#bOk').classList.remove('hide'); 
  }
}

function onCarbsChange(){
  const grams=Number($('#carbs').value);
  if(!icr || !Number.isFinite(grams) || grams<=0){ $('#mealSuggestWrap').classList.add('hide'); return; }
  // Ø¬Ø±Ø¹Ø© = Ø§Ù„ÙƒØ§Ø±Ø¨ / ICR
  const dose=grams/icr;
  const rounded = Math.round(dose*2)/2; // Ù„Ø£Ù‚Ø±Ø¨ 0.5U
  $('#mealSuggestion').textContent=rounded;
  $('#mealSuggestWrap').classList.remove('hide');
}

/* Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„ØªØµØ­ÙŠØ­ */
function suggestedCorrection(readingMmol){
  if(cfMmol==null||!Number.isFinite(readingMmol)) return null;
  const excess=readingMmol - target; 
  if(excess<=0) return 0;
  let u=excess/cfMmol; 
  u=Math.max(0,Math.min(10,u)); 
  return Math.round(u);
}

function clearInputs(){
  $('#reading').value=''; $('#note').value=''; $('#raisedWith').value=''; $('#mealDose').value=''; $('#corrGiven').value=''; $('#carbs').value='';
  [$('#bOk'),$('#bLow'),$('#bHigh')].forEach(e=>e.classList.add('hide'));
  $('#extraLow').classList.add('hide'); $('#extraHigh').classList.add('hide'); $('#suggestWrap').classList.add('hide'); $('#mealSuggestWrap').classList.add('hide');
}

/* Ø¹Ø±Ø¶ Ø§Ù„ÙŠÙˆÙ… */
let todayDocSnap=null;
async function refreshDay(){
  const dateId=$('#dateSel').value; if(!childId||!dateId) return;
  const ref=doc(db,'users',uid,'children',childId,'measurements',dateId);
  todayDocSnap=await getDoc(ref);
  const readings=(todayDocSnap.data()||{}).readings||{};
  const tbody=$('#rows'); tbody.innerHTML='';
  let any=false;
  const unit=unitSel.value;

  order.forEach(k=>{
    const r=readings[k];
    if(r && r.value!=null){
      any=true;
      const disp = fromMmol(Number(r.value), unit) + ' ' + (unit==='mgdl'?'mg/dL':'mmol/L');
      const state = r.status || evaluate(Number(r.value));
      tbody.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${labels[k]}</td>
          <td>${disp}</td>
          <td>${badge(state)}</td>
          <td>${r.mealDose!=null? r.mealDose : 'â€”'}</td>
          <td>${r.correctionGiven!=null? r.correctionGiven : 'â€”'}</td>
          <td>${r.note || r.raisedWith || ''}</td>
        </tr>`);
    }
  });
  if(!any) tbody.innerHTML=emptyRow();
}
function badge(st){ if(st==='low')return`<span class="badge b-low">Ù…Ù†Ø®ÙØ¶</span>`; if(st==='high')return`<span class="badge b-high">Ù…Ø±ØªÙØ¹</span>`; if(st==='ok')return`<span class="badge b-ok">Ø·Ø¨ÙŠØ¹ÙŠ</span>`; return''; }

/* Ø­ÙØ¸ */
document.querySelector('#saveBtn').addEventListener('click', onSave);
async function onSave(){
  if(!childId) return toast('Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„Ø·ÙÙ„ Ø£ÙˆÙ„Ù‹Ø§');
  const dateId=$('#dateSel').value; if(!dateId) return toast('Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®');
  const slot=$('#slotSel').value; if(!slot) return toast('Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„ÙˆÙ‚Øª');

  const raw=Number($('#reading').value);
  const unit=unitSel.value;
  if(!Number.isFinite(raw)) return toast('Ø£Ø¯Ø®Ù„ÙŠ Ù‚Ø±Ø§Ø¡Ø© ØµØ­ÙŠØ­Ø©');

  const mmolVal = toMmol(raw, unit);
  const ref=doc(db,'users',uid,'children',childId,'measurements',dateId);
  const snap=todayDocSnap && todayDocSnap.id===dateId? todayDocSnap : await getDoc(ref);
  const base=snap.exists()? snap.data() : { date:dateId, readings:{} };

  if(base.readings[slot] && base.readings[slot].value!=null) return toast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª Ù…Ø³Ø¨Ù‚Ù‹Ø§ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… â—');

  const st=evaluate(mmolVal);
  const mealDose = valNum('#mealDose');
  const carbs = valNum('#carbs');

  base.readings[slot]={
    value:mmolVal, status:st,
    note:$('#note').value.trim()||null,
    mealDose:mealDose,
    carbs: carbs,
    mealDoseSuggested: (carbs&&icr)? Math.round((carbs/icr)*2)/2 : null,
    correctionGiven:(st==='high'?valNum('#corrGiven'):null),
    correctionSuggested:(st==='high'?suggestedCorrection(mmolVal):null),
    raisedWith:(st==='low'?($('#raisedWith').value.trim()||null):null),
    label:labels[slot],
    originalUnit: unit, originalValue: Number(raw)
  };
  await setDoc(ref,base);
  toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³ âœ…'); clearInputs(); todayDocSnap=null; refreshDay();
}
function valNum(sel){ const v=$(sel).value; if(v===''||v==null) return null; const n=Number(v); return Number.isFinite(n)?n:null; }

/* ØªÙ†Ø¨ÙŠÙ‡ Ù‚Ø¨Ù„ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª (Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØªØµÙØ­) */
function scheduleMealReminders(){
  const now=new Date();
  const todayISO=now.toISOString().slice(0,10);
  const times=[['Ø§Ù„ÙØ·ÙˆØ±', mealTimes.breakfast], ['Ø§Ù„ØºØ¯Ø§Ø¡', mealTimes.lunch], ['Ø§Ù„Ø¹Ø´Ø§Ø¡', mealTimes.dinner]];
  times.forEach(([name, t])=>{
    if(!t) return;
    const [hh,mm]=t.split(':').map(Number);
    const dt=new Date(todayISO+'T00:00:00');
    dt.setHours(hh); dt.setMinutes(mm - (notifyBeforeMins||15)); dt.setSeconds(0);
    const ms=dt.getTime()-Date.now();
    if(ms>1000){ // Ù…Ø³ØªÙ‚Ø¨Ù„
      setTimeout(()=>{ try{ new Notification('ØªØ°ÙƒÙŠØ± Ø§Ù„Ù‚ÙŠØ§Ø³', { body:`Ù‚ÙŠØ§Ø³ Ù‚Ø¨Ù„ ${name} Ø§Ù„Ø¢Ù†` }); }catch(e){/*ignore*/} }, ms);
    }
  });
}
</script>
</body>
</html>
