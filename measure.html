<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª â€” Ù…ØªØ§Ø¨Ø¹Ø© Ø³ÙƒØ± Ø§Ù„Ø£Ø·ÙØ§Ù„</title>
  <style>
    :root{--brand:#0ea5e9;--brand2:#6ee7b7;--line:#e5e7eb;--ink:#0f172a;--muted:#64748b;--bg:#f7fbff;--card:#fff;--ok:#22c55e;--low:#b45309;--high:#dc2626;}
    *{box-sizing:border-box;margin:0;padding:0;}
    body{font:15px/1.6 system-ui, 'Tajawal','Noto Sans Arabic',sans-serif; background:var(--bg);color:var(--ink);}
    header{position:sticky;top:0;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;padding:14px 18px;display:flex;justify-content:space-between;}
    .btn{border:none;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer;}
    .btn.primary{background:var(--brand);color:white;}
    .btn.gray{background:#eef2f7;}
    main{max-width:1100px;margin:20px auto;padding:0 20px;}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;margin-bottom:20px;}
    .grid{display:grid;gap:12px;}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr));}
    @media(max-width:900px){.g3{grid-template-columns:1fr;}}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px;}
    select,input{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px;}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-size:13px;}
    .b-ok{background:#ecfdf5;color:var(--ok);}
    .b-low{background:#fff7ed;color:var(--low);}
    .b-high{background:#fee2e2;color:var(--high);}
    .small{font-size:12px;color:var(--muted);}
    table{width:100%;border-collapse:collapse;margin-top:20px;}
    th,td{padding:10px;text-align:right;border:1px solid var(--line);}
    th{background:#f8fafc;}
  </style>
</head>
<body>
  <header>
    <div>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª</div>
    <a class="btn gray" href="dashboard.html">â¬… Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>
  </header>

  <main>
    <!--  Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·ÙÙ„ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª -->
    <section class="card">
      <h2>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø·ÙÙ„ ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®</h2>
      <div class="grid g3">
        <div>
          <label>Ø§Ù„Ø·ÙÙ„</label>
          <select id="childSel"><option value="">â€” Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„Ø·ÙÙ„ â€”</option></select>
          <div id="limits" class="small" style="margin-top:6px;"></div>
        </div>
        <div>
          <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
          <input id="dateSel" type="date"/>
        </div>
        <div>
          <label>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆÙ‚Øª</label>
          <select id="slotSel">
            <option value="">â€” Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„ÙˆÙ‚Øª â€”</option>
            <option value="uponWake">Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸</option>
            <option value="preBreakfast">Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±</option>
            <option value="postBreakfast">Ø¨Ø¹Ø¯ Ø§Ù„Ø¥ÙØ·Ø§Ø±</option>
            <option value="preLunch">Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡</option>
            <option value="postLunch">Ø¨Ø¹Ø¯ Ø§Ù„ØºØ¯Ø§Ø¡</option>
            <option value="preDinner">Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡</option>
            <option value="postDinner">Ø¨Ø¹Ø¯ Ø§Ù„Ø¹Ø´Ø§Ø¡</option>
            <option value="beforeSleep">Ù‚Ø¨Ù„ Ø§Ù„Ù†ÙˆÙ…</option>
            <option value="duringSleep">Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†ÙˆÙ…</option>
          </select>
        </div>
      </div>
      <div class="row">
        <button id="openMealBtn" class="btn gray" style="display:none;">ğŸ” Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆØ¬Ø¨Ø©</button>
      </div>
    </section>

    <!--  Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù‚ÙŠØ§Ø³ ÙˆØ§Ù„ÙˆØ¬Ø¨Ø© -->
    <section class="card">
      <h2>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù‚ÙŠØ§Ø³</h2>
      <div class="grid g3">
        <div>
          <label>Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</label>
          <input id="reading" type="number" placeholder="Ù…Ø«Ù„Ø§Ù‹ 6.5"/>
          <div id="statusOk" class="badge b-ok" style="display:none;">Ø¶Ù…Ù† Ø§Ù„Ù…Ø¯Ù‰</div>
          <div id="statusLow" class="badge b-low" style="display:none;">Ù…Ù†Ø®ÙØ¶</div>
          <div id="statusHigh" class="badge b-high" style="display:none;">Ù…Ø±ØªÙØ¹</div>
        </div>
        <div>
          <label>Ø§Ù„ÙˆØ¬Ø¨Ø© â€” ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª (Ø¬Ù…) â€” Ø§Ø®ØªÙŠØ§Ø±ÙŠ</label>
          <input id="carbs" type="number" placeholder="Ù…Ø«Ù„Ø§Ù‹ 45"/>
          <label>Ø¬Ø±Ø¹Ø© Ø§Ù„ÙˆØ¬Ø¨Ø© (ÙˆØ­Ø¯Ø©)</label>
          <input id="mealDose" type="number" placeholder="Ù…Ø«Ù„Ø§Ù‹ 3"/>
        </div>
        <div>
          <label>Ù…Ù„Ø§Ø­Ø¸Ø©</label>
          <input id="note" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"/>
        </div>
      </div>
      <div class="row">
        <button id="saveBtn" class="btn primary">Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³</button>
      </div>
    </section>

    <!--  Ø¬Ø¯ÙˆÙ„ Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„ÙŠÙˆÙ… -->
    <section class="card">
      <h2>Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø®ØªØ§Ø±</h2>
      <table>
        <thead>
          <tr><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¬Ø±Ø¹Ø© Ø§Ù„ÙˆØ¬Ø¨Ø©</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th></tr>
        </thead>
        <tbody id="rows"><tr><td colspan="5" class="small">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø¡Ø§Øª Ø¨Ø¹Ø¯.</td></tr></tbody>
      </table>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
    const firebaseConfig = { apiKey:"...", authDomain:"...", projectId:"child-glucose-tracker" };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const $ = s => document.querySelector(s);

    // Ù‚Ø±Ø§Ø¡Ø© Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
    const params = new URLSearchParams(location.search);
    const childId = params.get("child");
    const prefillCarbs = params.get("carbs");
    const prefillDose = params.get("dose");
    const prefillTime = params.get("time");

    if (!childId) {
      alert("Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø·ÙÙ„!");
    } else {
      const childRef = doc(db, "users", /* Ù‡Ù†Ø§ uid Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… */, "children", childId);
      getDoc(childRef).then(snap => {
        if (!snap.exists()) {
          alert("Ø§Ù„Ø·ÙÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!");
        } else {
          const data = snap.data();
          $('#childSel').innerHTML = `<option value="${childId}" selected>${data.name}</option>`;
          $('#limits').textContent = `ICR: ${data.icr} Â· Ù…Ù†Ø®ÙØ¶ < ${data.lowThreshold} Â· Ù…Ø±ØªÙØ¹ > ${data.highThreshold}`;
          window.icr = data.icr;
        }
      });
    }

    const mealTimes = ["preBreakfast","preLunch","preDinner"];
    $('#slotSel').addEventListener("change", () => {
      $('#openMealBtn').style.display = mealTimes.includes($('#slotSel').value) ? "inline-block" : "none";
    });

    $('#openMealBtn').onclick = () => {
      const slot = $('#slotSel').value;
      if (!window.icr) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„ Ø£ÙˆÙ„Ø§Ù‹");
      } else {
        window.location.href = `meal_selector.html?child=${childId}&time=${slot}&icr=${window.icr}`;
      }
    };

    // Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ‡ÙŠØ¯Ø±Ø§Øª ÙˆØ§Ù„Ø¬Ø±Ø¹Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø©
    if (prefillCarbs) $('#carbs').value = prefillCarbs;
    if (prefillDose) $('#mealDose').value = prefillDose;
    if (prefillTime) $('#slotSel').value = prefillTime;

  </script>
</body>
</html>
