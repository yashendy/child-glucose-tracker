<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>تسجيل القياسات — متابعة سكر الأطفال</title>
<style>
:root{--brand:#0ea5e9;--brand2:#6ee7b7;--line:#e5e7eb;--ink:#0f172a;--muted:#6b7280;--bg:#f6fbff;--card:#fff;--danger:#ef4444;--warn:#facc15}
body{margin:0;font:15px/1.6 system-ui,"Tajawal","Noto Sans Arabic",sans-serif;background:var(--bg);color:var(--ink)}
header{position:sticky;top:0;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;padding:14px;display:flex;justify-content:space-between;align-items:center}
main{max-width:900px;margin:auto;padding:18px}
.card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:14px}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:4px}
input,select{width:100%;padding:8px;border:1px solid var(--line);border-radius:8px}
.row{display:flex;gap:8px;flex-wrap:wrap}
.btn{padding:10px 14px;border:none;border-radius:8px;font-weight:bold;cursor:pointer}
.btn.primary{background:var(--brand);color:#fff}
.note{font-size:13px;color:var(--muted)}
.status-low{color:#92400e;background:#fef3c7;padding:4px 8px;border-radius:6px}
.status-high{color:#b91c1c;background:#fee2e2;padding:4px 8px;border-radius:6px}
.toast{position:fixed;bottom:16px;left:16px;background:#111;color:#fff;padding:10px 14px;border-radius:12px;opacity:0;transform:translateY(8px);transition:.3s}
.toast.show{opacity:1;transform:none}
</style>
</head>
<body>
<header>
  <div>تسجيل القياسات</div>
  <a href="dashboard.html" class="btn">⬅ رجوع</a>
</header>

<main>
  <div class="card">
    <label>اختر الطفل</label>
    <select id="childSel"></select>
  </div>

  <div class="card">
    <label>التاريخ</label>
    <input type="date" id="m_date">

    <label>الوقت</label>
    <select id="m_time">
      <option>قبل الإفطار</option>
      <option>بعد الإفطار</option>
      <option>قبل الغداء</option>
      <option>بعد الغداء</option>
      <option>قبل العشاء</option>
      <option>بعد العشاء</option>
      <option>قبل النوم</option>
      <option>أثناء النوم</option>
      <option>عند الاستيقاظ</option>
    </select>

    <label>القياس (mmol/L)</label>
    <input type="number" step="0.1" id="m_value">

    <div id="status" class="note"></div>

    <div class="row" style="margin-top:10px">
      <button id="saveBtn" class="btn primary">حفظ القياس</button>
    </div>
  </div>
</main>

<div id="toast" class="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, getDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCOdrwdbw8b7YdWLPZ4TDdG2iS9kvvxQ7M",
  authDomain: "child-glucose-tracker.firebaseapp.com",
  projectId: "child-glucose-tracker",
  storageBucket: "child-glucose-tracker.firebasestorage.app",
  messagingSenderId: "294563325904",
  appId: "1:294563325904:web:39562550bf305fc01abbd5"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

const $=s=>document.querySelector(s);
const toast=(m)=>{const t=$('#toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000);};

let uid=null;
let low=null, high=null;
const urlParams = new URLSearchParams(location.search);
const initChildId = urlParams.get('child');

onAuthStateChanged(auth, async (u)=>{
  if(!u) return location.href='index.html';
  uid=u.uid;
  await loadChildren();
});

async function loadChildren(){
  const sel=$('#childSel'); sel.innerHTML='';
  const q=await getDocs(collection(db,'users',uid,'children'));
  q.forEach(s=>{
    const opt=document.createElement('option');
    opt.value=s.id; opt.textContent=s.data().name || 'بدون اسم';
    sel.appendChild(opt);
  });

  // اختيار تلقائي للطفل إذا فيه child باللينك
  if(initChildId){
    sel.value = initChildId;
    sel.dispatchEvent(new Event('change'));
    sel.disabled = true;
  } else {
    sel.dispatchEvent(new Event('change'));
  }
}

$('#childSel').addEventListener('change', async ()=>{
  const cid=$('#childSel').value;
  if(!cid) return;
  const snap=await getDoc(doc(db,'users',uid,'children',cid));
  const data=snap.data();
  low=data.lowThreshold ?? null;
  high=data.highThreshold ?? null;
});

$('#m_value').addEventListener('input', ()=>{
  const val=parseFloat($('#m_value').value);
  if(isNaN(val)) { $('#status').textContent=''; return; }
  if(low!=null && val<low){
    $('#status').innerHTML=`<span class="status-low">⬇ منخفض — يجب الرفع</span>`;
  } else if(high!=null && val>high){
    $('#status').innerHTML=`<span class="status-high">⬆ مرتفع — يرجى التصحيح</span>`;
  } else {
    $('#status').innerHTML=`<span style="color:green">✅ ضمن النطاق</span>`;
  }
});

$('#saveBtn').addEventListener('click', async ()=>{
  const cid=$('#childSel').value;
  const date=$('#m_date').value;
  const time=$('#m_time').value;
  const val=parseFloat($('#m_value').value);
  if(!cid || !date || isNaN(val)) return toast('أكمل البيانات');
  await addDoc(collection(db,'users',uid,'children',cid,'measurements'),{
    date,time,value:val,createdAt:serverTimestamp()
  });
  toast('تم الحفظ ✅');
  $('#m_value').value='';
  $('#status').textContent='';
});
</script>
</body>
</html>
