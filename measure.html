<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>تسجيل القياسات — متابعة سكر الأطفال</title>
<style>
:root{
  --brand:#0ea5e9; --brand2:#6ee7b7; --card:#fff; --line:#e5e7eb;
  --ink:#0f172a; --muted:#64748b; --ok:#22c55e; --low:#b45309; --high:#dc2626;
  --bg:#f7fbff;
}
*{box-sizing:border-box}
body{margin:0; background:var(--bg); color:var(--ink);
  font:15px/1.6 system-ui,"Tajawal","Noto Sans Arabic",sans-serif;}
header{position:sticky; top:0; background:linear-gradient(90deg,var(--brand),var(--brand2)); color:#fff; padding:14px 18px; display:flex; align-items:center; justify-content:space-between;}
header a.btn{background:#ffffff22;color:#fff;border:1px solid #ffffff55}
main{max-width:1100px;margin:auto;padding:20px}
.card{background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.03); padding:16px; margin-bottom:16px;}
h2{margin:0 0 12px}
.grid{display:grid; gap:12px}
.g3{grid-template-columns:repeat(3,minmax(0,1fr))}
.g2{grid-template-columns:repeat(2,minmax(0,1fr))}
@media (max-width:900px){ .g3,.g2{grid-template-columns:1fr} }
label{display:block; font-size:13px; color:var(--muted); margin:0 0 6px}
select,input{width:100%; padding:12px 12px; border:1px solid var(--line); border-radius:12px; background:#fff}
.row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
.btn{border:none; border-radius:10px; padding:10px 14px; font-weight:800; cursor:pointer}
.btn.primary{background:var(--brand); color:#fff}
.btn.gray{background:#eef2f7}
.note{color:var(--muted); font-size:13px}
.badge{display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border-radius:999px; font-weight:800}
.b-ok{background:#ecfdf5; color:var(--ok)}
.b-low{background:#fff7ed; color:var(--low)}
.b-high{background:#fee2e2; color:var(--high)}
.table{width:100%; border-collapse:collapse}
th,td{border:1px solid var(--line); padding:10px; text-align:right}
th{background:#f8fafc; color:#0f172a}
.small{font-size:12px;color:var(--muted)}
.toast{position:fixed;bottom:16px;left:16px;background:#111;color:#fff;padding:10px 14px;border-radius:12px;opacity:0;transform:translateY(8px);transition:.28s;z-index:3}
.toast.show{opacity:1;transform:none}
.hide{display:none!important}
.suggest{display:inline-block;background:#eef6ff;color:#0369a1;padding:6px 10px;border-radius:999px;font-weight:800}
.unit-inline{display:grid; grid-template-columns:1fr 160px; gap:8px; align-items:end}
@media (max-width:520px){ .unit-inline{grid-template-columns:1fr} }
.suffix{color:#334155;font-weight:700;font-size:12px;margin-top:6px}
</style>
</head>
<body>
<header>
  <div>تسجيل القياسات</div>
  <div class="row">
    <button id="btnEnableNoti" class="btn">🔔 تفعيل تذكير قبل الوجبات</button>
    <a class="btn" href="dashboard.html">⬅ لوحة التحكم</a>
  </div>
</header>

<main>
  <section class="card">
    <h2>اختيار الطفل والتاريخ</h2>
    <div class="grid g3">
      <div>
        <label>الطفل</label>
        <select id="childSel"><option value="">— اختاري الطفل —</option></select>
        <div id="thrInfo" class="note" style="margin-top:6px"></div>
        <div id="cfInfo" class="note" style="margin-top:4px"></div>
        <div id="icrInfo" class="note" style="margin-top:4px"></div>
      </div>
      <div>
        <label>التاريخ</label>
        <input id="dateSel" type="date" />
      </div>
      <div>
        <label>اختيار الوقت</label>
        <select id="slotSel">
          <option value="">— اختاري الوقت —</option>
          <option value="preBreakfast">قبل الإفطار</option>
          <option value="postBreakfast">بعد الإفطار</option>
          <option value="preLunch">قبل الغداء</option>
          <option value="postLunch">بعد الغداء</option>
          <option value="preDinner">قبل العشاء</option>
          <option value="postDinner">بعد العشاء</option>
          <option value="beforeSleep">قبل النوم</option>
          <option value="duringSleep">أثناء النوم</option>
          <option value="uponWake">عند الاستيقاظ</option>
        </select>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>إدخال القياس</h2>
    <div class="grid g3">
      <div>
        <label>القراءة</label>
        <div class="unit-inline">
          <input id="reading" type="number" step="0.1" min="0" placeholder="اكتبي القراءة" />
          <div>
            <label>الوحدة</label>
            <select id="unitSel">
              <option value="mmol">mmol/L</option>
              <option value="mgdl">mg/dL</option>
            </select>
          </div>
        </div>
        <div id="unitSuffix" class="suffix">الوحدة الحالية: mmol/L</div>
        <div id="bOk" class="badge b-ok hide">✔️ ضمن المدى</div>
        <div id="bLow" class="badge b-low hide">⬇︎ منخفض — يجب الرفع</div>
        <div id="bHigh" class="badge b-high hide">⬆︎ مرتفع — يرجى التصحيح</div>
      </div>

      <div>
        <label>الوجبة — كربوهيدرات (جرام) — اختياري</label>
        <div class="unit-inline">
          <input id="carbs" type="number" step="1" min="0" placeholder="مثلاً 45">
          <div>
            <label>جرعة الوجبة (وحدة)</label>
            <input id="mealDose" type="number" step="0.5" min="0" placeholder="مثلاً 3">
          </div>
        </div>
        <div id="mealSuggestWrap" class="hide" style="margin-top:8px">
          <span class="suggest">جرعة الوجبة المقترحة (ICR): <span id="mealSuggestion">—</span> وحدة</span>
        </div>

        <div id="suggestWrap" class="hide" style="margin-top:8px">
          <span class="suggest">الجرعة التصحيحية المقترحة: <span id="corrSuggestion">—</span> وحدة</span>
        </div>
      </div>

      <div>
        <label>ملاحظة</label>
        <input id="note" placeholder="اختياري — وصف مختصر" />
        <div id="extraLow" class="hide" style="margin-top:8px">
          <label>اترفع بإيه؟</label>
          <input id="raisedWith" placeholder="عصير/أقراص جلوكوز...">
        </div>
        <div id="extraHigh" class="hide" style="margin-top:8px">
          <label>جرعة التصحيحي (المُعطاة)</label>
          <input id="corrGiven" type="number" step="0.5" min="0" placeholder="مثلاً 2">
        </div>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="saveBtn" class="btn primary">حفظ القياس</button>
      <button id="clearBtn" class="btn gray">مسح الحقول</button>
      <span class="note">يمنع تسجيل نفس الوقت مرتين في اليوم نفسه.</span>
    </div>
  </section>

  <section class="card">
    <h2>قراءات اليوم المختار</h2>
    <table class="table">
      <thead>
        <tr>
          <th>الوقت</th>
          <th>القياس</th>
          <th>الحالة</th>
          <th>جرعة الوجبة</th>
          <th>التصحيحي (المُعطاة)</th>
          <th>ملاحظات</th>
        </tr>
      </thead>
      <tbody id="rows">
        <tr><td colspan="6" class="small">لا توجد قراءات لليوم المختار بعد.</td></tr>
      </tbody>
    </table>
  </section>
</main>

<div id="toast" class="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig={apiKey:"AIzaSyCOdrwdbw8b7YdWLPZ4TDdG2iS9kvvxQ7M",authDomain:"child-glucose-tracker.firebaseapp.com",projectId:"child-glucose-tracker",storageBucket:"child-glucose-tracker.firebasestorage.app",messagingSenderId:"294563325904",appId:"1:294563325904:web:39562550bf305fc01abbd5"};
const app=initializeApp(firebaseConfig); const auth=getAuth(app); const db=getFirestore(app);

const $=s=>document.querySelector(s);
const toast=(m)=>{const t=document.querySelector('.toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),1700);};

const labels={preBreakfast:'قبل الإفطار',postBreakfast:'بعد الإفطار',preLunch:'قبل الغداء',postLunch:'بعد الغداء',preDinner:'قبل العشاء',postDinner:'بعد العشاء',beforeSleep:'قبل النوم',duringSleep:'أثناء النوم',uponWake:'عند الاستيقاظ'};
const order=['preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep','uponWake'];

let uid=null, childId=null;
let low=4, high=10, target=6.5, cfMmol=null, icr=null; // داخليًا mmol
let preferredUnit='mmol';
let mealTimes={breakfast:'07:30', lunch:'13:30', dinner:'19:30'};
let notifyBeforeMins=15;

const initChildId=new URL(location.href).searchParams.get('child');

onAuthStateChanged(auth, async (u)=>{
  if(!u){ location.href='index.html'; return; }
  uid=u.uid; await loadChildren(); setToday();
  if(initChildId){ $('#childSel').value=initChildId; $('#childSel').disabled=true; await onChildChanged(true); }
  else { adjustInputForUnit(); }
});

/* وحدات */
const unitSel = $('#unitSel');
unitSel.addEventListener('change', ()=>{
  adjustInputForUnit();
  onReadingChange();
  refreshDay();
  refreshThresholdInfo();
});
function toMmol(value, unit){ if(!Number.isFinite(value)) return NaN; return unit==='mgdl' ? value/18 : value; }
function fromMmol(mmol, unit){ if(!Number.isFinite(mmol)) return NaN; return unit==='mgdl' ? Math.round(mmol*18) : Number(mmol.toFixed(1)); }
function adjustInputForUnit(){
  const u=unitSel.value;
  $('#unitSuffix').textContent='الوحدة الحالية: '+(u==='mgdl'?'mg/dL':'mmol/L');
  const reading=$('#reading'); reading.step=(u==='mgdl'?'1':'0.1'); reading.placeholder=(u==='mgdl'?'مثلاً 120':'مثلاً 6.5');
}
function refreshThresholdInfo(){
  const u=unitSel.value;
  const loDisp=fromMmol(low,u), hiDisp=fromMmol(high,u), tgtDisp=fromMmol(target,u);
  $('#thrInfo').textContent='الحدود (حسب الوحدة): منخفض < '+loDisp+' • مرتفع > '+hiDisp+' • الهدف: '+tgtDisp+' '+(u==='mgdl'?'mg/dL':'mmol/L');
  $('#cfInfo').textContent= cfMmol?('معامل التصحيح: '+(Math.round(cfMmol*100)/100)+' mmol/L لكل 1U'):'⚠️ لم يتم ضبط معامل التصحيح';
  $('#icrInfo').textContent= icr?('ICR: '+icr+' جم كارب لكل 1U'):'';
}

/* تحميل */
function setToday(){ const u=new URL(location.href); const d=u.searchParams.get('date'); $('#dateSel').value=d||new Date().toISOString().slice(0,10); }
async function loadChildren(){
  const sel=$('#childSel'); sel.innerHTML='<option value="">— تحميل —</option>';
  const q=await getDocs(collection(db,'users',uid,'children'));
  sel.innerHTML='<option value="">— اختاري الطفل —</option>';
  q.forEach(s=>{ const o=document.createElement('option'); o.value=s.id; o.textContent=s.data().name||'بدون اسم'; sel.appendChild(o); });
}

/* أحداث */
$('#childSel').addEventListener('change', ()=>onChildChanged(true));
$('#dateSel').addEventListener('change', refreshDay);
$('#slotSel').addEventListener('change', ()=>onReadingChange());
$('#reading').addEventListener('input', onReadingChange);
$('#carbs').addEventListener('input', onCarbsChange);
$('#clearBtn').addEventListener('click', clearInputs);
$('#saveBtn').addEventListener('click', onSave);

/* تفعيل تنبيهات قبل الوجبات */
document.getElementById('btnEnableNoti').addEventListener('click', async ()=>{
  if(!('Notification' in window)) { alert('متصفحك لا يدعم الإشعارات'); return; }
  const perm=await Notification.requestPermission();
  if(perm!=='granted'){ alert('لم يتم السماح بالإشعارات'); return; }
  scheduleMealReminders();
  toast('تم تفعيل التذكير لهذا اليوم 🔔');
});

async function onChildChanged(applyUnit){
  childId=$('#childSel').value||null; 
  if(!childId){ $('#thrInfo').textContent=''; $('#cfInfo').textContent=''; $('#icrInfo').textContent=''; $('#rows').innerHTML=emptyRow(); return; }
  const cs=await getDoc(doc(db,'users',uid,'children',childId));
  const c=cs.data()||{};
  low   =(c.lowThreshold??4);
  high  =(c.highThreshold??10);
  target=(c.targetMmol??6.5);
  cfMmol=(c.correctionFactorMmol!=null)?Number(c.correctionFactorMmol):(c.correctionFactorMgDl!=null?Number(c.correctionFactorMgDl)/18:null);
  icr = (c.icr!=null)? Number(c.icr) : null;
  preferredUnit = c.preferredUnit || 'mmol';
  mealTimes = c.mealTimes || {breakfast:'07:30', lunch:'13:30', dinner:'19:30'};
  notifyBeforeMins = (c.notifyBeforeMins!=null)? Number(c.notifyBeforeMins) : 15;

  if(applyUnit){ unitSel.value=preferredUnit; adjustInputForUnit(); }
  refreshThresholdInfo();
  refreshDay();
}

/* تقييم */
function emptyRow(){ return `<tr><td colspan="6" class="small">لا توجد قراءات لليوم المختار بعد.</td></tr>`; }
function evaluate(mmol){ if(mmol===''||!Number.isFinite(Number(mmol)))return null; const n=Number(mmol); if(n<low)return'low'; if(n>high)return'high'; return'ok'; }

function onReadingChange(){
  const raw=Number($('#reading').value);
  const unit=unitSel.value;
  const mmol=toMmol(raw, unit);

  [$('#bOk'),$('#bLow'),$('#bHigh')].forEach(e=>e.classList.add('hide'));
  $('#extraLow').classList.add('hide'); 
  $('#extraHigh').classList.add('hide'); 
  $('#suggestWrap').classList.add('hide');

  if(!Number.isFinite(mmol)) return;
  const st=evaluate(mmol);
  if(st==='low'){ 
    $('#bLow').classList.remove('hide'); 
    $('#extraLow').classList.remove('hide'); 
  }else if(st==='high'){
    $('#bHigh').classList.remove('hide'); 
    $('#extraHigh').classList.remove('hide');
    const seg=suggestedCorrection(mmol); 
    if(seg!=null){ $('#corrSuggestion').textContent=seg; $('#suggestWrap').classList.remove('hide'); }
  } else { 
    $('#bOk').classList.remove('hide'); 
  }
}

function onCarbsChange(){
  const grams=Number($('#carbs').value);
  if(!icr || !Number.isFinite(grams) || grams<=0){ $('#mealSuggestWrap').classList.add('hide'); return; }
  // جرعة = الكارب / ICR
  const dose=grams/icr;
  const rounded = Math.round(dose*2)/2; // لأقرب 0.5U
  $('#mealSuggestion').textContent=rounded;
  $('#mealSuggestWrap').classList.remove('hide');
}

/* اقتراح التصحيح */
function suggestedCorrection(readingMmol){
  if(cfMmol==null||!Number.isFinite(readingMmol)) return null;
  const excess=readingMmol - target; 
  if(excess<=0) return 0;
  let u=excess/cfMmol; 
  u=Math.max(0,Math.min(10,u)); 
  return Math.round(u);
}

function clearInputs(){
  $('#reading').value=''; $('#note').value=''; $('#raisedWith').value=''; $('#mealDose').value=''; $('#corrGiven').value=''; $('#carbs').value='';
  [$('#bOk'),$('#bLow'),$('#bHigh')].forEach(e=>e.classList.add('hide'));
  $('#extraLow').classList.add('hide'); $('#extraHigh').classList.add('hide'); $('#suggestWrap').classList.add('hide'); $('#mealSuggestWrap').classList.add('hide');
}

/* عرض اليوم */
let todayDocSnap=null;
async function refreshDay(){
  const dateId=$('#dateSel').value; if(!childId||!dateId) return;
  const ref=doc(db,'users',uid,'children',childId,'measurements',dateId);
  todayDocSnap=await getDoc(ref);
  const readings=(todayDocSnap.data()||{}).readings||{};
  const tbody=$('#rows'); tbody.innerHTML='';
  let any=false;
  const unit=unitSel.value;

  order.forEach(k=>{
    const r=readings[k];
    if(r && r.value!=null){
      any=true;
      const disp = fromMmol(Number(r.value), unit) + ' ' + (unit==='mgdl'?'mg/dL':'mmol/L');
      const state = r.status || evaluate(Number(r.value));
      tbody.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${labels[k]}</td>
          <td>${disp}</td>
          <td>${badge(state)}</td>
          <td>${r.mealDose!=null? r.mealDose : '—'}</td>
          <td>${r.correctionGiven!=null? r.correctionGiven : '—'}</td>
          <td>${r.note || r.raisedWith || ''}</td>
        </tr>`);
    }
  });
  if(!any) tbody.innerHTML=emptyRow();
}
function badge(st){ if(st==='low')return`<span class="badge b-low">منخفض</span>`; if(st==='high')return`<span class="badge b-high">مرتفع</span>`; if(st==='ok')return`<span class="badge b-ok">طبيعي</span>`; return''; }

/* حفظ */
document.querySelector('#saveBtn').addEventListener('click', onSave);
async function onSave(){
  if(!childId) return toast('اختاري الطفل أولًا');
  const dateId=$('#dateSel').value; if(!dateId) return toast('اختاري التاريخ');
  const slot=$('#slotSel').value; if(!slot) return toast('اختاري الوقت');

  const raw=Number($('#reading').value);
  const unit=unitSel.value;
  if(!Number.isFinite(raw)) return toast('أدخلي قراءة صحيحة');

  const mmolVal = toMmol(raw, unit);
  const ref=doc(db,'users',uid,'children',childId,'measurements',dateId);
  const snap=todayDocSnap && todayDocSnap.id===dateId? todayDocSnap : await getDoc(ref);
  const base=snap.exists()? snap.data() : { date:dateId, readings:{} };

  if(base.readings[slot] && base.readings[slot].value!=null) return toast('تم تسجيل هذا الوقت مسبقًا لهذا اليوم ❗');

  const st=evaluate(mmolVal);
  const mealDose = valNum('#mealDose');
  const carbs = valNum('#carbs');

  base.readings[slot]={
    value:mmolVal, status:st,
    note:$('#note').value.trim()||null,
    mealDose:mealDose,
    carbs: carbs,
    mealDoseSuggested: (carbs&&icr)? Math.round((carbs/icr)*2)/2 : null,
    correctionGiven:(st==='high'?valNum('#corrGiven'):null),
    correctionSuggested:(st==='high'?suggestedCorrection(mmolVal):null),
    raisedWith:(st==='low'?($('#raisedWith').value.trim()||null):null),
    label:labels[slot],
    originalUnit: unit, originalValue: Number(raw)
  };
  await setDoc(ref,base);
  toast('تم حفظ القياس ✅'); clearInputs(); todayDocSnap=null; refreshDay();
}
function valNum(sel){ const v=$(sel).value; if(v===''||v==null) return null; const n=Number(v); return Number.isFinite(n)?n:null; }

/* تنبيه قبل الوجبات (داخل المتصفح) */
function scheduleMealReminders(){
  const now=new Date();
  const todayISO=now.toISOString().slice(0,10);
  const times=[['الفطور', mealTimes.breakfast], ['الغداء', mealTimes.lunch], ['العشاء', mealTimes.dinner]];
  times.forEach(([name, t])=>{
    if(!t) return;
    const [hh,mm]=t.split(':').map(Number);
    const dt=new Date(todayISO+'T00:00:00');
    dt.setHours(hh); dt.setMinutes(mm - (notifyBeforeMins||15)); dt.setSeconds(0);
    const ms=dt.getTime()-Date.now();
    if(ms>1000){ // مستقبل
      setTimeout(()=>{ try{ new Notification('تذكير القياس', { body:`قياس قبل ${name} الآن` }); }catch(e){/*ignore*/} }, ms);
    }
  });
}
</script>
</body>
</html>
