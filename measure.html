<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª</title>
  <style>
    :root { --brand:#0ea5e9; --muted:#64748b; --bg:#f7fbff; --card:#fff; --line:#e5e7eb; --ok:#22c55e; --low:#b45309; --high:#dc2626; }
    * { box-sizing: border-box; }
    body { font-family: 'Cairo', sans-serif; margin: 0; background: var(--bg); color: #333; padding: 20px; }
    header { background: linear-gradient(90deg,var(--brand),#6ee7b7); color: #fff; padding: 16px; text-align: center; font-size: 20px; border-radius: 12px; }
    main { max-width: 1000px; margin: 20px auto; }
    .card { background: var(--card); padding: 20px; margin-bottom: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    h2 { margin-top: 0; color: var(--brand); font-size: 22px; }
    label { font-size: 14px; color: var(--muted); display: block; margin-bottom: 6px; }
    select, input, textarea { width: 100%; padding: 10px; border: 1px solid var(--line); border-radius: 8px; margin-bottom: 12px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap: 16px; }
    .btn { background: var(--brand); color: #fff; padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th,td { border: 1px solid var(--line); padding: 8px; text-align: center; }
    th { background: #f0f9ff; }
    .badge { display: inline-block; padding: 6px 10px; border-radius: 999px; font-size: 13px; }
    .b-ok { background: #ecfdf5; color: var(--ok); }
    .b-high { background: #fee2e2; color: var(--high); }
    .b-low { background: #fff7ed; color: var(--low); }
    .note { color: var(--muted); font-size: 13px; }
  </style>
</head>
<body>

  <header>ğŸ“ˆ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª</header>
  <main>
    <section class="card">
      <h2>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„ ÙˆØ§Ù„ÙˆØ¬Ø¨Ø©</h2>
      <div class="grid">
        <div>
          <label>Ø§Ù„Ø·ÙÙ„</label>
          <select id="childSel"><option value="">â€” Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„Ø·ÙÙ„ â€”</option></select>
          <div id="childInfo" class="note"></div>
        </div>
        <div>
          <label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
          <input type="date" id="dateSel" />
        </div>
        <div>
          <label>ÙˆÙ‚Øª Ø§Ù„Ù‚ÙŠØ§Ø³</label>
          <select id="slotSel">
            <option value="">â€” Ø§Ø®ØªØ§Ø±ÙŠ Ø§Ù„ÙˆÙ‚Øª â€”</option>
            <option value="preBreakfast">Ù‚Ø¨Ù„ Ø§Ù„Ø¥ÙØ·Ø§Ø±</option>
            <option value="preLunch">Ù‚Ø¨Ù„ Ø§Ù„ØºØ¯Ø§Ø¡</option>
            <option value="preDinner">Ù‚Ø¨Ù„ Ø§Ù„Ø¹Ø´Ø§Ø¡</option>
            <option value="other">Ø£Ø®Ø±Ù‰...</option>
          </select>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù‚ÙŠØ§Ø³ ÙˆØ§Ù„ÙˆØ¬Ø¨Ø©</h2>
      <div class="grid">
        <div>
          <label>Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</label>
          <input type="number" id="reading" step="0.1" min="0" />
          <div id="statusBadge" class="badge" style="display:none;"></div>
        </div>
        <div>
          <label>ÙƒØ§Ø±Ø¨ (Ø¬Ù…)</label>
          <input type="number" id="carbs" step="0.1" min="0" />
        </div>
        <div>
          <label>Ø¬Ø±Ø¹Ø© Ù…Ù‚ØªØ±Ø­Ø© (ICR)</label>
          <input type="number" id="suggestedDose" readonly />
        </div>
        <div>
          <label>Ø¬Ø±Ø¹Ø© ÙØ¹Ù„ÙŠØ©</label>
          <input type="number" id="mealDose" step="0.1" />
        </div>
        <div id="correctionSection" style="display:none;">
          <label>Ø¬Ø±Ø¹Ø© ØªØµØ­ÙŠØ­ÙŠØ©</label>
          <input type="number" id="correction" step="0.1" />
        </div>
        <div id="raiseSection" style="display:none;">
          <label>Ø±ÙØ¹ Ø§Ù„Ø³ÙƒØ± (Ù…Ø«Ù„Ø§Ù‹ Ø¹ØµÙŠØ±)</label>
          <input type="text" id="raise" />
        </div>
        <div>
          <label>Ù…Ù„Ø§Ø­Ø¸Ø©</label>
          <textarea id="note" rows="2"></textarea>
        </div>
      </div>
      <div style="text-align:center;">
        <button class="btn" id="saveBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³</button>
      </div>
    </section>

    <section class="card">
      <h2>Ù‚Ø±Ø§Ø¡Ø§Øª Ø§Ù„ÙŠÙˆÙ…</h2>
      <table>
        <thead>
          <tr><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ø¬Ø±Ø¹Ø©</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th><th>Ù…Ù„Ø§Ø­Ø¸Ø©</th></tr>
        </thead>
        <tbody id="rows">
          <tr><td colspan="6" class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø±Ø§Ø¡Ø§Øª Ù„Ù„ÙŠÙˆÙ….</td></tr>
        </tbody>
      </table>
    </section>
  </main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
  const firebaseConfig = {
    apiKey: "...", authDomain: "...", projectId: "child-glucose-tracker"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);
  const $ = s => document.querySelector(s);
  let userId, childId, ICR, low, high;

  onAuthStateChanged(auth, async user => {
    if (!user) return alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
    userId = user.uid;
    await loadChildren();
  });

  async function loadChildren() {
    const q = await getDocs(collection(db, "users", userId, "children"));
    $("#childSel").innerHTML = '<option value="">â€” Ø§Ø®ØªØ§Ø±ÙŠ â€”</option>';
    q.forEach(c => {
      const d = c.data();
      const o = document.createElement("option");
      o.value = c.id;
      o.textContent = d.name || "Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…";
      $("#childSel").append(o);
    });
    $("#childSel").onchange = onChildChange;
  }

  async function onChildChange() {
    childId = $("#childSel").value;
    if (!childId) return;
    const snap = await getDoc(doc(db, "users", userId, "children", childId));
    const data = snap.data();
    ICR = Number(data.icr);
    low = data.lowThreshold;
    high = data.highThreshold;
    $("#childInfo").textContent = `ICR: ${ICR} Â· Ù…Ù†Ø®ÙØ¶ < ${low} Â· Ù…Ø±ØªÙØ¹ > ${high}`;
    $("#dateSel").value = new Date().toISOString().split("T")[0];
    $("#dateSel").onchange = loadDay;
    $("#slotSel").onchange = () => loadDay(true);
    $("#carbs").oninput = e => $("#suggestedDose").value = (Number(e.target.value)/ICR).toFixed(1);
    $("#reading").oninput = onReadingChange;
    $("#saveBtn").onclick = onSave;
    await loadDay();
  }

  async function loadDay(prefill=false) {
    const date = $("#dateSel").value;
    if (!date || !childId) return;
    const ref = doc(db, "users", userId, "children", childId, "measurements", date);
    const snap = await getDoc(ref);
    const readings = (snap.data() || {}).readings || {};
    renderRows(readings);
    if (prefill) {
      const carbs = new URLSearchParams(location.search).get("carbs");
      const dose = new URLSearchParams(location.search).get("dose");
      if (carbs) $("#carbs").value = carbs;
      if (dose) $("#mealDose").value = dose;
    }
  }

  function renderRows(readings) {
    let html = "", unit = "";
    for (const [slot, r] of Object.entries(readings)) {
      let status = "", action = "";
      if (r.value > high) status = `<span class="badge b-high">Ù…Ø±ØªÙØ¹</span>`;
      else if (r.value < low) status = `<span class="badge b-low">Ù…Ù†Ø®ÙØ¶</span>`;
      else status = `<span class="badge b-ok">Ø·Ø¨ÙŠØ¹ÙŠ</span>`;
      action = r.mealDose || r.correction || "-";
      html += `<tr><td>${slot}</td><td>${r.value}</td><td>${status}</td><td>${action}</td><td>${r.note||"-"}</td></tr>`;
    }
    $("#rows").innerHTML = html || `<tr><td colspan="6" class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠØ§Ø³Ø§Øª Ù„Ù„ÙŠÙˆÙ….</td></tr>`;
  }

  function onReadingChange() {
    const val = Number($("#reading").value);
    $("#correctionSection, #raiseSection").style.display = "none";
    if (val && low!==undefined && high!==undefined) {
      if (val > high) $("#correctionSection").style.display = "block";
      else if (val < low) $("#raiseSection").style.display = "block";
    }
  }

  async function onSave() {
    const date = $("#dateSel").value, slot = $("#slotSel").value, raw = Number($("#reading").value);
    if (!childId || !date || !slot || !raw) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
    const ref = doc(db, "users", userId, "children", childId, "measurements", date);
    const snap = await getDoc(ref);
    const base = snap.exists() ? snap.data() : { readings: {} };
    if (base.readings[slot]?.value!=null) return alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„ÙˆÙ‚Øª Ù…Ø³Ø¨Ù‚Ø§Ù‹.");
    base.readings[slot] = {
      value: raw,
      note: $("#note").value.trim()||null,
      carbs: Number($("#carbs").value)||null,
      mealDose: Number($("#mealDose").value)||null,
      correction: $("#correction")?.value?Number($("#correction").value):null,
      raise: $("#raise")?.value || null
    };
    await setDoc(ref, base);
    alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ§Ø³");
    await loadDay();
  }
</script>
</body>
</html>
