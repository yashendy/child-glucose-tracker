<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>وجبات الطفل</title>
<link rel="stylesheet" href="styles.css">
<style>
.food img{width:56px;height:56px;object-fit:contain}
.sidebar input{width:100%}
.tag{display:inline-block;background:#eef2ff;color:#3730a3;padding:2px 6px;border-radius:999px;font-size:12px;margin-inline:4px}
</style>
</head>
<body>
<div class="topbar">
  <div>🍽️ الوجبات</div>
  <div class="row">
    <a id="lnkDash" class="btn gray">لوحة الطفل</a>
    <a id="lnkFoodsAdmin" class="btn">🗂️ إدارة الأصناف</a>
  </div>
</div>

<main class="container">
  <section class="card">
    <div class="row" style="gap:12px;align-items:center">
      <img id="avatar" class="avatar" style="width:64px;height:64px" src="images/avatar-default.png" alt="">
      <div>
        <div id="kidName" style="font-weight:800">—</div>
        <div id="kidMeta" class="note">—</div>
      </div>
      <span class="badge-soft">ICR: <b id="icrNow">—</b> g/U</span>
    </div>
  </section>

  <section class="card">
    <h3 style="margin-top:0">إعداد الوجبة</h3>
    <div class="grid g3">
      <div><label>نوع الوجبة</label>
        <select id="mealType">
          <option value="breakfast">فطور</option>
          <option value="lunch">غداء</option>
          <option value="dinner">عشاء</option>
          <option value="snack">سناك</option>
          <option value="other">أخرى</option>
        </select>
      </div>
      <div><label>وقت الأكل</label><input id="mealTime" type="datetime-local"></div>
      <div><label>ملاحظة</label><input id="mealNote" placeholder="اختياري"></div>
    </div>
  </section>

  <section class="card">
    <div class="layout">
      <aside class="sidebar">
        <input id="foodSearch" placeholder="ابحث بالاسم أو #هاشتاج…">
        <div id="catList" class="col" style="margin-top:8px"></div>
      </aside>

      <div class="col">
        <div id="foodsGrid" class="foods-grid"><div class="note">جاري التحميل…</div></div>

        <div class="card" style="margin-top:12px">
          <div class="row" style="justify-content:space-between">
            <h4 style="margin:0">🧺 سلة الوجبة</h4>
            <div class="badge-soft">إجمالي الكارب: <b id="totalCarbs">0.0</b> جم</div>
          </div>
          <div class="basket" style="margin-top:8px; overflow:auto">
            <table>
              <thead><tr><th>الصنف</th><th>الوحدة</th><th>الكمية</th><th>الكارب (جم)</th><th>إجراء</th></tr></thead>
              <tbody id="basketBody"><tr><td colspan="5" class="note">لا توجد عناصر بعد.</td></tr></tbody>
              <tfoot><tr><td colspan="3"><b>الإجمالي</b></td><td id="totalCarbsCell">0.0</td><td></td></tr></tfoot>
            </table>
          </div>

          <div class="grid g3" style="margin-top:10px">
            <div><label>جرعة مقترحة</label><input id="doseSuggestedMeal" readonly></div>
            <div><label>جرعة فعلية (اختياري)</label><input id="doseGivenMeal" type="number" step="0.1"></div>
            <div class="row" style="align-items:flex-end; justify-content:flex-end">
              <button id="saveMealBtn" class="btn primary">💾 حفظ الوجبة</button>
            </div>
          </div>
          <div class="note">الحساب: (جرام الوحدة × الكمية × كارب/100g) ÷ 100 — الجرعة = إجمالي الكارب ÷ ICR (تقريب 0.1U).</div>
        </div>
      </div>
    </div>
  </section>
</main>

<script type="module">
import { auth, db, ensureAuth, requireChildIdFromQuery, loadChildProfile, setChildAvatar, toLocalDatetimeValue } from './firebase-init.js';
import { collection, getDocs, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const $=s=>document.querySelector(s);

let uid=null, childId=null, child=null, foodsAll=[], basket=[], currentCategory='*';

(async function boot(){
  ({uid}=await ensureAuth());
  childId=requireChildIdFromQuery();

  $('#lnkDash').href=`child-dashboard.html?child=${encodeURIComponent(childId)}`;
  $('#lnkFoodsAdmin').href=`foods-admin.html?child=${encodeURIComponent(childId)}`;

  child = await loadChildProfile(uid, childId);
  setChildAvatar($('#avatar'), child.name, child.photoURL);
  $('#kidName').textContent=child.name||'—';
  $('#kidMeta').textContent=`${child.gender||'—'} • ${child.weight??'—'} كجم • ${child.height??'—'} سم`;
  $('#icrNow').textContent= child.icr??'—';
  $('#mealTime').value = toLocalDatetimeValue(new Date());

  await loadFoods();
  buildCategories(); renderFoods();

  $('#foodSearch').addEventListener('input', renderFoods);
})();

async function loadFoods(){
  foodsAll=[];
  const qs=await getDocs(collection(db,'foods'));
  qs.forEach(s=>{
    const d=s.data(); if(d.isActive===false) return;
    foodsAll.push({
      id:s.id,
      name:d.name||'—',
      category:d.category||'أخرى',
      carbsPer100g:Number(d.carbsPer100g)||0,
      imageUrl:d.imageUrl||'https://cdn-icons-png.flaticon.com/512/1046/1046784.png',
      servingUnits: Array.isArray(d.servingUnits)&&d.servingUnits.length? d.servingUnits : [{unit:'جرام', grams:100}],
      tags: Array.isArray(d.tags)? d.tags.map(x=>String(x).toLowerCase()) : []
    });
  });
}

function buildCategories(){
  const set=new Set(['*']); foodsAll.forEach(f=>set.add(f.category||'أخرى'));
  const box=$('#catList'); box.innerHTML='';
  [...set].forEach(cat=>{
    const a=document.createElement('a'); a.className='side-link'+(cat===currentCategory?' active':'');
    a.textContent = (cat==='*'?'كل الأصناف':cat); a.href='javascript:void(0)';
    a.addEventListener('click',()=>{ currentCategory=cat; buildCategories(); renderFoods(); });
    box.appendChild(a);
  });
}

function renderFoods(){
  const grid=$('#foodsGrid'); grid.innerHTML='';
  const q = ($('#foodSearch').value||'').trim().toLowerCase();
  const list=foodsAll.filter(f=>{
    const catOK = (currentCategory==='*'|| f.category===currentCategory);
    if(!q) return catOK;
    // بحث بالاسم أو #هاشتاج
    const byName = f.name.toLowerCase().includes(q.replace('#',''));
    const byTag  = q.startsWith('#')? f.tags.includes(q.slice(1)) : f.tags.some(t=>t.includes(q));
    return catOK && (byName || byTag);
  });

  if(!list.length){ grid.innerHTML='<div class="note">لا توجد أصناف.</div>'; return; }

  list.forEach(f=>{
    const card=document.createElement('div'); card.className='food';
    const unitOptions = f.servingUnits.map(u=>`<option value="${u.grams}">${u.unit} (${u.grams}جم)</option>`).join('');
    card.innerHTML=`
      <div class="row" style="justify-content:space-between;align-items:center">
        <img src="${f.imageUrl}" alt="${escapeHTML(f.name)}">
        <div class="badge-soft">${escapeHTML(f.category)}</div>
      </div>
      <div class="name" style="margin-top:4px">${escapeHTML(f.name)}</div>
      <div class="note">الكارب/100جم: <b>${f.carbsPer100g}</b></div>
      <div class="row" style="justify-content:center;margin-top:6px">
        <select class="uSel">${unitOptions}</select>
        <input class="qty" type="number" min="0.1" step="0.1" value="1" style="width:88px">
      </div>
      <div class="row" style="justify-content:space-between;margin-top:6px">
        <button class="btn gray addBtn">➕ أضف</button>
        <div>${(f.tags||[]).slice(0,3).map(t=>`<span class="tag">#${escapeHTML(t)}</span>`).join('')}</div>
      </div>
    `;
    const uSel=card.querySelector('.uSel'), qty=card.querySelector('.qty');
    card.querySelector('.addBtn').addEventListener('click', ()=>{
      const gramsPerUnit=Number(uSel.value)||100;
      const qv=Number(qty.value)||0; if(qv<=0) return alert('أدخلي كمية صحيحة');
      const totalCarbs = +((gramsPerUnit*qv*f.carbsPer100g)/100).toFixed(1);
      basket.push({
        foodId:f.id, name:f.name,
        unit: unitName(f.servingUnits, gramsPerUnit),
        gramsPerUnit, qty:qv, carbsPer100g:f.carbsPer100g,
        totalCarbs
      });
      renderBasket();
    });
    grid.appendChild(card);
  });
}

function unitName(units, grams){
  const u=(units||[]).find(x=>Number(x.grams)===Number(grams));
  return u? `${u.unit} (${u.grams}جم)` : `جرام (${grams})`;
}
function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

function renderBasket(){
  const tb=$('#basketBody');
  if(!basket.length){ tb.innerHTML='<tr><td colspan="5" class="note">لا توجد عناصر بعد.</td></tr>'; $('#totalCarbs').textContent='0.0'; $('#totalCarbsCell').textContent='0.0'; $('#doseSuggestedMeal').value=''; return; }
  tb.innerHTML=''; let sum=0;
  basket.forEach((it,idx)=>{
    sum+=it.totalCarbs;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${escapeHTML(it.name)}</td>
      <td>${escapeHTML(it.unit)}</td>
      <td><input class="qtyRow" type="number" min="0.1" step="0.1" value="${it.qty}" style="width:88px"></td>
      <td class="carbCell">${it.totalCarbs.toFixed(1)}</td>
      <td><button class="btn gray rm">🗑️ حذف</button></td>
    `;
    tr.querySelector('.qtyRow').addEventListener('input', e=>{
      it.qty = Number(e.target.value)||0;
      it.totalCarbs = +((it.gramsPerUnit*it.qty*it.carbsPer100g)/100).toFixed(1);
      tr.querySelector('.carbCell').textContent = it.totalCarbs.toFixed(1);
      recomputeTotals();
    });
    tr.querySelector('.rm').addEventListener('click', ()=>{ basket.splice(idx,1); renderBasket(); });
    tb.appendChild(tr);
  });
  $('#totalCarbs').textContent=sum.toFixed(1); $('#totalCarbsCell').textContent=sum.toFixed(1);
  const icr=Number(child?.icr)||0; $('#doseSuggestedMeal').value=(icr>0&&sum>0)?(Math.round((sum/icr)*10)/10).toFixed(1):'';
}
function recomputeTotals(){
  let sum=0; basket.forEach(it=>sum+=it.totalCarbs);
  $('#totalCarbs').textContent=sum.toFixed(1); $('#totalCarbsCell').textContent=sum.toFixed(1);
  const icr=Number(child?.icr)||0; $('#doseSuggestedMeal').value=(icr>0&&sum>0)?(Math.round((sum/icr)*10)/10).toFixed(1):'';
}

$('#saveMealBtn')?.addEventListener('click', saveMeal);
async function saveMeal(){
  if(!basket.length) return alert('السلة فارغة');
  const when=$('#mealTime').value; if(!when) return alert('حددي وقت الأكل');
  const payload={
    type: $('#mealType').value,
    time: when,
    note: $('#mealNote').value||null,
    icrUsed: child?.icr||null,
    totalCarbs: Number($('#totalCarbs').textContent)||0,
    doseSuggested: $('#doseSuggestedMeal').value? Number($('#doseSuggestedMeal').value):null,
    doseGiven: $('#doseGivenMeal').value? Number($('#doseGivenMeal').value):null,
    items: basket,
    createdAt: serverTimestamp()
  };
  const id = String(Date.now());
  await setDoc(doc(db,'users',uid,'children',childId,'meals',id), payload);
  alert('✅ تم حفظ الوجبة');
  basket=[]; renderBasket();
}
</script>
</body>
</html>
