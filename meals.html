<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ÙˆØ¬Ø¨Ø§Øª Ø§Ù„Ø·ÙÙ„ â€” Ø°ÙƒÙŠ</title>
<style>
:root{--brand:#0ea5e9;--brand2:#6ee7b7;--line:#e5e7eb;--ink:#0f172a;--muted:#64748b;--bg:#f6fbff;--card:#fff}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.6 system-ui,"Tajawal","Noto Sans Arabic",sans-serif}
a{text-decoration:none;color:inherit} .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.container{max-width:1100px;margin:auto;padding:14px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:0 6px 24px rgba(0,0,0,.04);margin-bottom:12px}
.btn{border:none;border-radius:10px;padding:9px 12px;font-weight:800;cursor:pointer}
.btn.primary{background:var(--brand);color:#fff} .btn.gray{background:#eef2f7}
.topbar{position:sticky;top:0;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;z-index:5}
.note{color:var(--muted);font-size:12px}
.avatar{width:64px;height:64px;border-radius:50%;object-fit:cover;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.12)}
.badge-soft{display:inline-block;background:#eef6ff;color:#0369a1;border-radius:999px;padding:4px 8px;font-weight:800;font-size:12px}
.grid{display:grid;gap:10px} .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
@media(max-width:900px){.g3{grid-template-columns:1fr}}
.layout{display:grid;grid-template-columns:240px 1fr;gap:12px}
@media(max-width:900px){.layout{grid-template-columns:1fr}}
.sidebar input{width:100%;padding:9px 10px;border:1px solid var(--line);border-radius:10px;margin-bottom:8px;background:#fff}
.side-link{display:block;padding:8px 10px;margin-bottom:6px;border:1px solid var(--line);border-radius:10px;background:#fff;font-weight:700}
.side-link.active,.side-link:hover{background:#e6f7ff;border-color:#bde5ff}
.foods-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
.food{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.04)}
.food img{width:72px;height:72px;object-fit:contain}
.food .name{font-weight:800;margin-top:6px}
.basket table{width:100%;border-collapse:separate;border-spacing:0}
.basket thead th{background:#f1f5f9;font-weight:800}
.basket th,.basket td{border:1px solid var(--line);padding:8px;text-align:center}
.kpi{display:flex;gap:8px;flex-wrap:wrap}
.kpi .chip{background:#f0f9ff;border:1px solid #cfeffd;border-radius:999px;padding:6px 10px;font-weight:800;font-size:12px}
.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>

<!-- Topbar -->
<div class="topbar">
  <div>ğŸ½ï¸ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª (Ø°ÙƒÙŠ)</div>
  <div class="row">
    <a id="lnkDashboard" class="btn gray">Ù„ÙˆØ­Ø© Ø§Ù„Ø·ÙÙ„</a>
    <button id="btnLogout" class="btn gray">Ø®Ø±ÙˆØ¬</button>
  </div>
</div>

<main class="container">
  <!-- Ø¨Ø§Ù†Ø± Ø§Ù„Ø·ÙÙ„ -->
  <section class="card" id="kidCard" style="display:none">
    <div class="row" style="align-items:center;justify-content:space-between">
      <div class="row" style="align-items:center">
        <img id="kidAvatar" class="avatar" src="images/avatar-default.png" alt="">
        <div>
          <div id="kidName" style="font-weight:800">â€”</div>
          <div id="kidMeta" class="note">â€”</div>
        </div>
      </div>
      <div class="row">
        <span class="badge-soft">ICR: <b id="icrNow">â€”</b> g/U</span>
        <a id="btnFoodsAdmin" class="btn gray">ğŸ—‚ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</a>
      </div>
    </div>
  </section>

  <!-- ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆØ¬Ø¨Ø© -->
  <section class="card">
    <div class="grid g3" style="margin-bottom:8px">
      <div><label class="small">Ù†ÙˆØ¹ Ø§Ù„ÙˆØ¬Ø¨Ø©</label>
        <select id="mealType">
          <option value="breakfast">ÙØ·ÙˆØ±</option><option value="lunch">ØºØ¯Ø§Ø¡</option>
          <option value="dinner">Ø¹Ø´Ø§Ø¡</option><option value="snack">Ø³Ù†Ø§Ùƒ</option><option value="other">Ø£Ø®Ø±Ù‰</option>
        </select>
      </div>
      <div><label class="small">ÙˆÙ‚Øª Ø§Ù„Ø£ÙƒÙ„</label><input id="mealTime" type="datetime-local"></div>
      <div><label class="small">Ù…Ù„Ø§Ø­Ø¸Ø©</label><input id="mealNote" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></div>
    </div>

    <div class="layout">
      <!-- Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª -->
      <aside class="sidebar">
        <input id="foodSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù…/ÙˆØ³Ù…...">
        <div id="catList"></div>
      </aside>

      <!-- Ø§Ù„Ø´Ø¨ÙƒØ© + Ø§Ù„Ø³Ù„Ø© -->
      <div>
        <div id="foodsGrid" class="foods-grid"><div class="note">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>

        <div class="card" style="margin-top:12px">
          <div class="row" style="justify-content:space-between;align-items:center">
            <h4 style="margin:0">ğŸ§º Ø³Ù„Ø© Ø§Ù„ÙˆØ¬Ø¨Ø©</h4>
            <div class="kpi">
              <span class="chip">ğŸ¥” ÙƒØ§Ø±Ø¨: <b id="sumCarb">0.0</b> Ø¬Ù…</span>
              <span class="chip">ğŸ¥š Ø¨Ø±ÙˆØªÙŠÙ†: <b id="sumProt">0.0</b> Ø¬Ù…</span>
              <span class="chip">ğŸ§ˆ Ø¯Ù‡ÙˆÙ†: <b id="sumFat">0.0</b> Ø¬Ù…</span>
              <span class="chip">ğŸ”¥ Ø³Ø¹Ø±Ø§Øª: <b id="sumKcal">0</b> Ùƒ</span>
            </div>
          </div>

          <div class="basket" style="margin-top:8px; overflow:auto">
            <table>
              <thead><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„ÙƒØ§Ø±Ø¨</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
              <tbody id="basketBody"><tr><td colspan="5" class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ø¨Ø¹Ø¯.</td></tr></tbody>
              <tfoot><tr><td colspan="3"><b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</b></td><td id="totalCarbsCell">0.0</td><td></td></tr></tfoot>
            </table>
          </div>

          <!-- Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„Ø¬Ø±Ø¹Ø© -->
          <div class="grid g3" style="margin-top:10px">
            <div>
              <label class="small">Ø¬Ø±Ø¹Ø© Ù…Ù‚ØªØ±Ø­Ø© (Ø£Ø³Ø§Ø³ Ø§Ù„ÙƒØ§Ø±Ø¨)</label>
              <input id="doseBase" readonly>
              <div class="small">= Ø§Ù„ÙƒØ§Ø±Ø¨ Ã· ICR (ØªÙ‚Ø±ÙŠØ¨ 0.1U)</div>
            </div>
            <div>
              <label class="small">Ø²ÙŠØ§Ø¯Ø© Ø¯Ù‡ÙˆÙ†/Ø¨Ø±ÙˆØªÙŠÙ† (FPU)</label>
              <input id="doseFpu" readonly>
              <div class="small">Ø§Ø®ØªÙŠØ§Ø±ÙŠ: ØªØ­ÙˆÙŠÙ„ Ø¯Ù‡ÙˆÙ†+Ø¨Ø±ÙˆØªÙŠÙ† Ù„ÙƒØ§Ø±Ø¨ Ù…ÙƒØ§ÙØ¦</div>
            </div>
            <div>
              <label class="small">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø°ÙƒØ§Ø¡ (Ø³Ù„ÙˆÙƒÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚)</label>
              <input id="doseAi" readonly>
              <div class="small">ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ ØªØ¹Ø¯ÙŠÙ„Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù„Ù†ÙØ³ Ù†ÙˆØ¹ Ø§Ù„ÙˆØ¬Ø¨Ø©</div>
            </div>
          </div>

          <div class="grid g3" style="margin-top:8px">
            <div>
              <label class="small">Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©</label>
              <input id="doseSuggestedMeal" readonly>
            </div>
            <div>
              <label class="small">Ø¬Ø±Ø¹Ø© ÙØ¹Ù„ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <input id="doseGivenMeal" type="number" step="0.1">
            </div>
            <div class="row" style="align-items:flex-end; justify-content:flex-end">
              <button id="saveMealBtn" class="btn primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙˆØ¬Ø¨Ø©</button>
            </div>
          </div>

          <div id="splitHint" class="note" style="margin-top:6px;display:none"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- ØªÙ†Ù‚Ù‘Ù„ Ø³Ø±ÙŠØ¹ -->
  <section class="card">
    <div class="row" id="quickNav"></div>
  </section>
</main>

<script type="module">
import { db, auth } from './firebase-init.js';
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { collection, getDocs, doc, getDoc, setDoc, updateDoc, serverTimestamp, deleteDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

/* -------------- Helpers -------------- */
const $=s=>document.querySelector(s);
const z2=n=>String(n).padStart(2,'0');
const toLocalDT=(d)=>{ const x=new Date(d); x.setMinutes(x.getMinutes()-x.getTimezoneOffset()); return x.toISOString().slice(0,16); };
const round1=n=>Math.round(Number(n||0)*10)/10;
const fixed1=n=> (Number.isFinite(+n) ? round1(n).toFixed(1) : '');
const escapeHTML=s=>String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
function todayIso(){ const d=new Date(); return `${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())}`; }

/* -------------- State -------------- */
let uid=null, childId=new URL(location.href).searchParams.get('child');
let child=null, foodsAll=[], basket=[];
let aiBuckets={}; // {bucket:{sumPct:..., count:...}}

/* -------------- Auth & Load -------------- */
onAuthStateChanged(auth, async (u)=>{
  if(!u){ location.href='index.html'; return; }
  uid=u.uid;
  if(!childId){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¹Ø±Ù Ø·ÙÙ„ Ø¨Ø§Ù„Ø±Ø§Ø¨Ø·'); return; }
  await loadChild();
  await loadFoods();
  buildCats(); renderFoods();
  buildNav();
  // defaults
  $('#mealTime').value = toLocalDT(new Date());
  $('#btnLogout').onclick = ()=>signOut(auth).then(()=>location.href='index.html');
  $('#lnkDashboard').href = `child-dashboard.html?child=${encodeURIComponent(childId)}`;
  $('#btnFoodsAdmin').href= `foods-admin.html?child=${encodeURIComponent(childId)}`;
  $('#foodSearch').addEventListener('input', renderFoods);
});

/* -------------- Child -------------- */
async function loadChild(){
  const s=await getDoc(doc(db,'users',uid,'children',childId));
  child=s.data()||{};
  $('#kidCard').style.display='block';
  $('#kidName').textContent = child.name||'â€”';
  $('#kidMeta').textContent = `${child.gender||'â€”'} â€¢ ${child.weight??'â€”'} ÙƒØ¬Ù… â€¢ ${child.height??'â€”'} Ø³Ù…`;
  if(child.photoURL) $('#kidAvatar').src = child.photoURL;
  $('#icrNow').textContent = child.icr ?? 'â€”';
  aiBuckets = child.aiBuckets || {};
}

/* -------------- Foods -------------- */
async function loadFoods(){
  foodsAll=[];
  const qs=await getDocs(collection(db,'foods'));
  qs.forEach(s=>{
    const d=s.data();
    if(d.isActive===false) return;
    foodsAll.push({
      id:s.id,
      name:d.name||'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…',
      category:d.category||'Ø£Ø®Ø±Ù‰',
      imageUrl:d.imageUrl||'https://cdn-icons-png.flaticon.com/512/1046/1046784.png',
      carbsPer100g:+(d.carbsPer100g||0),
      proteinPer100g:+(d.proteinPer100g||0),
      fatPer100g:+(d.fatPer100g||0),
      kcalPer100g:+(d.kcalPer100g|| ((+(d.carbsPer100g||0)*4)+(+(d.proteinPer100g||0)*4)+(+(d.fatPer100g||0)*9)) ),
      tags:Array.isArray(d.tags)?d.tags:[],
      servingUnits: Array.isArray(d.servingUnits)&&d.servingUnits.length? d.servingUnits : [{unit:'Ø¬Ø±Ø§Ù…', grams:1}],
    });
  });
}
let currentCat='*';
function buildCats(){
  const set=new Set(['*']); foodsAll.forEach(f=>set.add(f.category||'Ø£Ø®Ø±Ù‰'));
  const box=$('#catList'); box.innerHTML='';
  [...set].forEach(cat=>{
    const a=document.createElement('a');
    a.className='side-link'+(cat===currentCat?' active':'');
    a.textContent= (cat==='*'?'ÙƒÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù':cat);
    a.href='javascript:void(0)';
    a.onclick=()=>{ currentCat=cat; buildCats(); renderFoods(); };
    box.appendChild(a);
  });
}
function renderFoods(){
  const grid=$('#foodsGrid'); grid.innerHTML='';
  const q=($('#foodSearch').value||'').trim().toLowerCase();
  const list=foodsAll.filter(f=>{
    const byCat = (currentCat==='*'||f.category===currentCat);
    const byText= !q || f.name.toLowerCase().includes(q) || (f.tags||[]).some(t=>String(t).toLowerCase().includes(q));
    return byCat && byText;
  });
  if(!list.length){ grid.innerHTML='<div class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù.</div>'; return; }
  list.forEach(f=>{
    const card=document.createElement('div'); card.className='food';
    // Ø£Ø¶ÙŠÙ Ø®ÙŠØ§Ø± "Ø¬Ø±Ø§Ù… (1Ø¬Ù…)" Ø¯Ø§Ø¦Ù…Ù‹Ø§:
    const units=[{unit:'Ø¬Ø±Ø§Ù…',grams:1}].concat(f.servingUnits.filter(u=>+u.grams!==1));
    const unitOptions = units.map(u=>`<option value="${u.grams}">${escapeHTML(u.unit)} (${u.grams}Ø¬Ù…)</option>`).join('');
    card.innerHTML=`
      <img src="${f.imageUrl}" alt="${escapeHTML(f.name)}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1046/1046784.png'">
      <div class="name">${escapeHTML(f.name)}</div>
      <div class="small">ÙƒØ§Ø±Ø¨/100Ø¬Ù…: <b>${f.carbsPer100g}</b> â€¢ Ø¨Ø±ÙˆØªÙŠÙ†: <b>${f.proteinPer100g}</b> â€¢ Ø¯Ù‡ÙˆÙ†: <b>${f.fatPer100g}</b></div>
      <div class="row" style="justify-content:center;margin-top:6px">
        <select class="uSel">${unitOptions}</select>
        <input class="qty" type="number" min="0.1" step="0.1" value="1" style="width:88px">
      </div>
      <div class="row" style="justify-content:space-between;margin-top:6px">
        <button class="btn gray addBtn">â• Ø£Ø¶Ù</button>
        <span class="badge-soft">${escapeHTML(f.category)}</span>
      </div>
    `;
    const uSel=card.querySelector('.uSel'), qty=card.querySelector('.qty');
    card.querySelector('.addBtn').onclick=()=>{
      const gramsPerUnit= +uSel.value || 1;
      const amount     = +qty.value || 0;
      if(amount<=0) return alert('Ø£Ø¯Ø®Ù„ÙŠ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©');
      // Ù„Ùˆ Ø§Ù„ÙˆØ­Ø¯Ø© Ø¬Ø±Ø§Ù…(1Ø¬Ù…): Ø§Ù„ÙƒÙ…ÙŠØ© = Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ø±Ø§Ù…Ø§Øª
      const gramsTotal = gramsPerUnit * amount;
      const carbs = +( (gramsTotal * f.carbsPer100g) / 100 ).toFixed(1);
      const prot  = +( (gramsTotal * f.proteinPer100g) / 100 ).toFixed(1);
      const fat   = +( (gramsTotal * f.fatPer100g) / 100 ).toFixed(1);
      const kcal  = Math.round((gramsTotal * f.kcalPer100g) / 100);
      basket.push({
        foodId:f.id, name:f.name, unit:unitLabel(units, gramsPerUnit),
        gramsPerUnit, qty:amount, gramsTotal,
        carbs, prot, fat, kcal
      });
      renderBasket();
    };
    grid.appendChild(card);
  });
}
function unitLabel(units, grams){ const u=(units||[]).find(x=>+x.grams===+grams); return u? `${u.unit} (${u.grams}Ø¬Ù…)`:`Ø¬Ø±Ø§Ù… (${grams})`; }

/* -------------- Basket & Dosing -------------- */
function renderBasket(){
  const tb=$('#basketBody');
  if(!basket.length){
    tb.innerHTML='<tr><td colspan="5" class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ø¨Ø¹Ø¯.</td></tr>';
    $('#totalCarbsCell').textContent='0.0';
    refreshDose(); return;
  }
  tb.innerHTML='';
  let totalCarb=0,totalProt=0,totalFat=0,totalKcal=0;
  basket.forEach((it,idx)=>{
    totalCarb+=it.carbs; totalProt+=it.prot; totalFat+=it.fat; totalKcal+=it.kcal;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${escapeHTML(it.name)}</td>
      <td>${escapeHTML(it.unit)}</td>
      <td><input class="q" type="number" min="0.1" step="0.1" value="${it.qty}" style="width:88px"></td>
      <td class="c">${it.carbs.toFixed(1)}</td>
      <td><button class="btn gray rm">ğŸ—‘ï¸ Ø­Ø°Ù</button></td>
    `;
    tr.querySelector('.q').oninput=(e)=>{
      const q=+e.target.value||0;
      it.qty=q;
      it.gramsTotal=it.gramsPerUnit*q;
      it.carbs=+((it.gramsTotal*it.carbs/it.gramsTotal)).toFixed(1); // ÙŠØ¹Ø§Ø¯ Ø§Ø­ØªØ³Ø§Ø¨ Ø³Ø±ÙŠØ¹
      // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø­ØªØ³Ø§Ø¨ Ø¯Ù‚ÙŠÙ‚Ø© Ù…Ù† Ù†Ø³Ø¨/100Ø¬Ù…:
      const factor=it.gramsTotal/100;
      it.carbs=+(factor * (it.carbs/ (it.gramsTotal/100))).toFixed(1);
      // Ø£Ø¨Ø³Ø· ÙˆØ£Ø¯Ù‚: Ø§Ø­ÙØ¸ Ø§Ù„Ù†Ù‘ÙØ³ÙØ¨ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¹Ù†ØµØ± (Ù„Ù†Ø®ØªØµØ± Ø§Ù„Ø¢Ù†)
      renderBasket(); // Ø£Ø¹ÙØ¯ Ø§Ù„Ø±Ø³Ù… Ù„ØªØ¨Ø³ÙŠØ· Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚
    };
    tr.querySelector('.rm').onclick=()=>{ basket.splice(idx,1); renderBasket(); };
    tb.appendChild(tr);
  });
  // ØªÙ„Ø®ÙŠØµ
  $('#sumCarb').textContent= round1(totalCarb).toFixed(1);
  $('#sumProt').textContent= round1(totalProt).toFixed(1);
  $('#sumFat').textContent = round1(totalFat).toFixed(1);
  $('#sumKcal').textContent= Math.round(totalKcal);
  $('#totalCarbsCell').textContent = round1(totalCarb).toFixed(1);
  refreshDose();
}

function refreshDose(){
  const icr= +child?.icr || 0;
  const c = +($('#sumCarb').textContent)||0;
  const p = +($('#sumProt').textContent)||0;
  const f = +($('#sumFat').textContent)||0;

  // 1) Ø£Ø³Ø§Ø³ Ø§Ù„ÙƒØ§Ø±Ø¨
  const base = icr>0? round1(c/icr): 0;

  // 2) FPU Ø§Ø®ØªÙŠØ§Ø±ÙŠ (Ø¯Ù‡ÙˆÙ†+Ø¨Ø±ÙˆØªÙŠÙ†)
  // FPU â‰ˆ (Ø¯Ù‡ÙˆÙ†*9 + Ø¨Ø±ÙˆØªÙŠÙ†*4) / 100 ØŒ ÙˆÙƒÙ„ FPU â‰ˆ 10 Ø¬Ù… ÙƒØ§Ø±Ø¨ Ù…ÙƒØ§ÙØ¦
  const fpu   = (f*9 + p*4) / 100;
  const carbEq= fpu * 10;
  const addU  = icr>0? round1(carbEq/icr): 0;

  // 3) Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„ØµØºÙŠØ± â€” ØªØ¹Ù„Ù… Ø§Ù„Ù†Ø³Ø¨Ø© Ù…Ù† ØªØ¹Ø¯ÙŠÙ„Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø¨Ø§ÙƒØª
  const bucket = bucketKey(f,p);
  const b = aiBuckets[bucket]||{sumPct:0,count:0};
  const adjPct = b.count? (b.sumPct/b.count) : 0; // Ù†Ø³Ø¨Ø© ÙˆØ³Ø·ÙŠØ©
  const aiU = round1(base * adjPct);

  // Ø§Ù„Ø¬Ø±Ø¹Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
  const final = round1(base + addU + aiU);

  $('#doseBase').value       = base? base.toFixed(1):'';
  $('#doseFpu').value        = addU? addU.toFixed(1):'';
  $('#doseAi').value         = aiU? aiU.toFixed(1):'';
  $('#doseSuggestedMeal').value = final? final.toFixed(1):'';

  // Ø§Ù‚ØªØ±Ø§Ø­ split bolus Ø¹Ù†Ø¯ Ø¯Ù‡ÙˆÙ†>=20 Ø£Ùˆ Ø¨Ø±ÙˆØªÙŠÙ†>=40
  const showSplit = (f>=20 || p>=40) && final>0;
  $('#splitHint').style.display = showSplit? 'block':'none';
  if(showSplit){
    const nowU = round1(final*0.6), laterU=round1(final*0.4);
    $('#splitHint').innerHTML = `ğŸ½ï¸ ÙˆØ¬Ø¨Ø© ØºÙ†ÙŠØ© Ø¨Ø§Ù„Ø¯Ù‡ÙˆÙ†/Ø§Ù„Ø¨Ø±ÙˆØªÙŠÙ† â€” Ø§Ù‚ØªØ±Ø§Ø­ ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø¬Ø±Ø¹Ø©: <b>${nowU}</b>U Ø§Ù„Ø¢Ù† + <b>${laterU}</b>U Ø¨Ø¹Ø¯ 2 Ø³Ø§Ø¹Ø© (Ø§Ø³ØªØ´ÙŠØ±ÙŠ Ø§Ù„Ø·Ø¨ÙŠØ¨).`;
  }else{
    $('#splitHint').textContent='';
  }
}

function bucketKey(fat,prot){
  if(fat>=20 && prot>=40) return 'fatProtHigh';
  if(fat>=20) return 'fatHigh';
  if(prot>=40) return 'protHigh';
  return 'lowFatLowProt';
}

/* -------------- Ø­ÙØ¸ Ø§Ù„ÙˆØ¬Ø¨Ø© + Ø§Ù„ØªØ¹Ù„Ù… -------------- */
$('#saveMealBtn').onclick = async ()=>{
  if(!basket.length) return alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©');
  const when=$('#mealTime').value; if(!when) return alert('Ø­Ø¯Ø¯ÙŠ ÙˆÙ‚Øª Ø§Ù„Ø£ÙƒÙ„');
  const icr= +child?.icr || 0;
  const c=+($('#sumCarb').textContent)||0, p=+($('#sumProt').textContent)||0, f=+($('#sumFat').textContent)||0;
  const base= icr>0? round1(c/icr):0;
  const fpu = (f*9 + p*4)/100, carbEq=fpu*10, addU = icr>0? round1(carbEq/icr):0;
  const finalSuggested = +($('#doseSuggestedMeal').value||0);

  const payload={
    type: $('#mealType').value, time: when, note: ($('#mealNote').value||null),
    icrUsed: icr||null,
    totals:{carb:c, prot:p, fat:f, kcal:+($('#sumKcal').textContent)||0},
    doseBase: base||null, doseFpu: addU||null, doseAi: +($('#doseAi').value||0)||null,
    doseSuggested: finalSuggested||null,
    doseGiven: $('#doseGivenMeal').value ? +$('#doseGivenMeal').value : null,
    items: basket,
    createdAt: serverTimestamp()
  };
  const id=String(Date.now());
  await setDoc(doc(db,'users',uid,'children',childId,'meals',id), payload);

  // Ø§Ù„ØªØ¹Ù„Ù…: Ù„Ùˆ Ø£Ø¯Ø®Ù„ØªÙŠ Ø¬Ø±Ø¹Ø© ÙØ¹Ù„ÙŠØ©ØŒ Ø§Ø­Ø³Ø¨ÙŠ Ø§Ù„ÙØ±Ù‚ ÙƒÙ†Ø³Ø¨Ø© Ø¹Ù„Ù‰ Ø£Ø³Ø§Ø³ "base"
  const given=payload.doseGiven;
  if(given && base>0){
    const deltaPct = (given - base) / base; // Ù…Ø«Ø§Ù„: 0.2 = +20%
    const key = bucketKey(f,p);
    const cur = aiBuckets[key] || {sumPct:0,count:0};
    cur.sumPct += deltaPct; cur.count += 1;
    aiBuckets[key]=cur;
    // Ø®Ø²Ù‘Ù†ÙŠ Ø§Ù„ØªØ¹Ù„Ù… Ø¯Ø§Ø®Ù„ Ù…Ø³ØªÙ†Ø¯ Ø§Ù„Ø·ÙÙ„
    await updateDoc(doc(db,'users',uid,'children',childId), { aiBuckets });
  }

  alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙˆØ¬Ø¨Ø©');
  basket=[]; renderBasket();
};

/* -------------- Quick child nav -------------- */
function buildNav(){
  const n=$('#quickNav'); n.innerHTML='';
  [
    ['child-dashboard.html','Ù„ÙˆØ­Ø© Ø§Ù„Ø·ÙÙ„'],
    ['measures.html','Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ±'],
    ['meals.html','Ø§Ù„ÙˆØ¬Ø¨Ø§Øª'],
    ['doctor-report.html','ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø¨ÙŠØ¨'],
    ['visits.html','Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©']
  ].forEach(([h,t])=>{
    const a=document.createElement('a'); a.className='btn gray';
    a.href=`${h}?child=${encodeURIComponent(childId)}`; a.textContent=t; n.appendChild(a);
  });
}
</script>
</body>
</html>
