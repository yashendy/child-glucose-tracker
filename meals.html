<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>ÙˆØ¬Ø¨Ø§Øª Ø§Ù„Ø·ÙÙ„</title>
<link rel="stylesheet" href="styles.css">
<style>
.food img{width:56px;height:56px;object-fit:contain}
.sidebar input{width:100%}
.tag{display:inline-block;background:#eef2ff;color:#3730a3;padding:2px 6px;border-radius:999px;font-size:12px;margin-inline:4px}
</style>
</head>
<body>
<div class="topbar">
  <div>ğŸ½ï¸ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª</div>
  <div class="row">
    <a id="lnkDash" class="btn gray">Ù„ÙˆØ­Ø© Ø§Ù„Ø·ÙÙ„</a>
    <a id="lnkFoodsAdmin" class="btn">ğŸ—‚ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù</a>
  </div>
</div>

<main class="container">
  <section class="card">
    <div class="row" style="gap:12px;align-items:center">
      <img id="avatar" class="avatar" style="width:64px;height:64px" src="images/avatar-default.png" alt="">
      <div>
        <div id="kidName" style="font-weight:800">â€”</div>
        <div id="kidMeta" class="note">â€”</div>
      </div>
      <span class="badge-soft">ICR: <b id="icrNow">â€”</b> g/U</span>
    </div>
  </section>

  <section class="card">
    <h3 style="margin-top:0">Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙˆØ¬Ø¨Ø©</h3>
    <div class="grid g3">
      <div><label>Ù†ÙˆØ¹ Ø§Ù„ÙˆØ¬Ø¨Ø©</label>
        <select id="mealType">
          <option value="breakfast">ÙØ·ÙˆØ±</option>
          <option value="lunch">ØºØ¯Ø§Ø¡</option>
          <option value="dinner">Ø¹Ø´Ø§Ø¡</option>
          <option value="snack">Ø³Ù†Ø§Ùƒ</option>
          <option value="other">Ø£Ø®Ø±Ù‰</option>
        </select>
      </div>
      <div><label>ÙˆÙ‚Øª Ø§Ù„Ø£ÙƒÙ„</label><input id="mealTime" type="datetime-local"></div>
      <div><label>Ù…Ù„Ø§Ø­Ø¸Ø©</label><input id="mealNote" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></div>
    </div>
  </section>

  <section class="card">
    <div class="layout">
      <aside class="sidebar">
        <input id="foodSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ #Ù‡Ø§Ø´ØªØ§Ø¬â€¦">
        <div id="catList" class="col" style="margin-top:8px"></div>
      </aside>

      <div class="col">
        <div id="foodsGrid" class="foods-grid"><div class="note">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</div></div>

        <div class="card" style="margin-top:12px">
          <div class="row" style="justify-content:space-between">
            <h4 style="margin:0">ğŸ§º Ø³Ù„Ø© Ø§Ù„ÙˆØ¬Ø¨Ø©</h4>
            <div class="badge-soft">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ§Ø±Ø¨: <b id="totalCarbs">0.0</b> Ø¬Ù…</div>
          </div>
          <div class="basket" style="margin-top:8px; overflow:auto">
            <table>
              <thead><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„ÙƒØ§Ø±Ø¨ (Ø¬Ù…)</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
              <tbody id="basketBody"><tr><td colspan="5" class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ø¨Ø¹Ø¯.</td></tr></tbody>
              <tfoot><tr><td colspan="3"><b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</b></td><td id="totalCarbsCell">0.0</td><td></td></tr></tfoot>
            </table>
          </div>

          <div class="grid g3" style="margin-top:10px">
            <div><label>Ø¬Ø±Ø¹Ø© Ù…Ù‚ØªØ±Ø­Ø©</label><input id="doseSuggestedMeal" readonly></div>
            <div><label>Ø¬Ø±Ø¹Ø© ÙØ¹Ù„ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input id="doseGivenMeal" type="number" step="0.1"></div>
            <div class="row" style="align-items:flex-end; justify-content:flex-end">
              <button id="saveMealBtn" class="btn primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙˆØ¬Ø¨Ø©</button>
            </div>
          </div>
          <div class="note">Ø§Ù„Ø­Ø³Ø§Ø¨: (Ø¬Ø±Ø§Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ã— Ø§Ù„ÙƒÙ…ÙŠØ© Ã— ÙƒØ§Ø±Ø¨/100g) Ã· 100 â€” Ø§Ù„Ø¬Ø±Ø¹Ø© = Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ§Ø±Ø¨ Ã· ICR (ØªÙ‚Ø±ÙŠØ¨ 0.1U).</div>
        </div>
      </div>
    </div>
  </section>
</main>

<script type="module">
import { auth, db, ensureAuth, requireChildIdFromQuery, loadChildProfile, setChildAvatar, toLocalDatetimeValue } from './firebase-init.js';
import { collection, getDocs, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const $=s=>document.querySelector(s);

let uid=null, childId=null, child=null, foodsAll=[], basket=[], currentCategory='*';

(async function boot(){
  ({uid}=await ensureAuth());
  childId=requireChildIdFromQuery();

  $('#lnkDash').href=`child-dashboard.html?child=${encodeURIComponent(childId)}`;
  $('#lnkFoodsAdmin').href=`foods-admin.html?child=${encodeURIComponent(childId)}`;

  child = await loadChildProfile(uid, childId);
  setChildAvatar($('#avatar'), child.name, child.photoURL);
  $('#kidName').textContent=child.name||'â€”';
  $('#kidMeta').textContent=`${child.gender||'â€”'} â€¢ ${child.weight??'â€”'} ÙƒØ¬Ù… â€¢ ${child.height??'â€”'} Ø³Ù…`;
  $('#icrNow').textContent= child.icr??'â€”';
  $('#mealTime').value = toLocalDatetimeValue(new Date());

  await loadFoods();
  buildCategories(); renderFoods();

  $('#foodSearch').addEventListener('input', renderFoods);
})();

async function loadFoods(){
  foodsAll=[];
  const qs=await getDocs(collection(db,'foods'));
  qs.forEach(s=>{
    const d=s.data(); if(d.isActive===false) return;
    foodsAll.push({
      id:s.id,
      name:d.name||'â€”',
      category:d.category||'Ø£Ø®Ø±Ù‰',
      carbsPer100g:Number(d.carbsPer100g)||0,
      imageUrl:d.imageUrl||'https://cdn-icons-png.flaticon.com/512/1046/1046784.png',
      servingUnits: Array.isArray(d.servingUnits)&&d.servingUnits.length? d.servingUnits : [{unit:'Ø¬Ø±Ø§Ù…', grams:100}],
      tags: Array.isArray(d.tags)? d.tags.map(x=>String(x).toLowerCase()) : []
    });
  });
}

function buildCategories(){
  const set=new Set(['*']); foodsAll.forEach(f=>set.add(f.category||'Ø£Ø®Ø±Ù‰'));
  const box=$('#catList'); box.innerHTML='';
  [...set].forEach(cat=>{
    const a=document.createElement('a'); a.className='side-link'+(cat===currentCategory?' active':'');
    a.textContent = (cat==='*'?'ÙƒÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù':cat); a.href='javascript:void(0)';
    a.addEventListener('click',()=>{ currentCategory=cat; buildCategories(); renderFoods(); });
    box.appendChild(a);
  });
}

function renderFoods(){
  const grid=$('#foodsGrid'); grid.innerHTML='';
  const q = ($('#foodSearch').value||'').trim().toLowerCase();
  const list=foodsAll.filter(f=>{
    const catOK = (currentCategory==='*'|| f.category===currentCategory);
    if(!q) return catOK;
    // Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ #Ù‡Ø§Ø´ØªØ§Ø¬
    const byName = f.name.toLowerCase().includes(q.replace('#',''));
    const byTag  = q.startsWith('#')? f.tags.includes(q.slice(1)) : f.tags.some(t=>t.includes(q));
    return catOK && (byName || byTag);
  });

  if(!list.length){ grid.innerHTML='<div class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù.</div>'; return; }

  list.forEach(f=>{
    const card=document.createElement('div'); card.className='food';
    const unitOptions = f.servingUnits.map(u=>`<option value="${u.grams}">${u.unit} (${u.grams}Ø¬Ù…)</option>`).join('');
    card.innerHTML=`
      <div class="row" style="justify-content:space-between;align-items:center">
        <img src="${f.imageUrl}" alt="${escapeHTML(f.name)}">
        <div class="badge-soft">${escapeHTML(f.category)}</div>
      </div>
      <div class="name" style="margin-top:4px">${escapeHTML(f.name)}</div>
      <div class="note">Ø§Ù„ÙƒØ§Ø±Ø¨/100Ø¬Ù…: <b>${f.carbsPer100g}</b></div>
      <div class="row" style="justify-content:center;margin-top:6px">
        <select class="uSel">${unitOptions}</select>
        <input class="qty" type="number" min="0.1" step="0.1" value="1" style="width:88px">
      </div>
      <div class="row" style="justify-content:space-between;margin-top:6px">
        <button class="btn gray addBtn">â• Ø£Ø¶Ù</button>
        <div>${(f.tags||[]).slice(0,3).map(t=>`<span class="tag">#${escapeHTML(t)}</span>`).join('')}</div>
      </div>
    `;
    const uSel=card.querySelector('.uSel'), qty=card.querySelector('.qty');
    card.querySelector('.addBtn').addEventListener('click', ()=>{
      const gramsPerUnit=Number(uSel.value)||100;
      const qv=Number(qty.value)||0; if(qv<=0) return alert('Ø£Ø¯Ø®Ù„ÙŠ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©');
      const totalCarbs = +((gramsPerUnit*qv*f.carbsPer100g)/100).toFixed(1);
      basket.push({
        foodId:f.id, name:f.name,
        unit: unitName(f.servingUnits, gramsPerUnit),
        gramsPerUnit, qty:qv, carbsPer100g:f.carbsPer100g,
        totalCarbs
      });
      renderBasket();
    });
    grid.appendChild(card);
  });
}

function unitName(units, grams){
  const u=(units||[]).find(x=>Number(x.grams)===Number(grams));
  return u? `${u.unit} (${u.grams}Ø¬Ù…)` : `Ø¬Ø±Ø§Ù… (${grams})`;
}
function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

function renderBasket(){
  const tb=$('#basketBody');
  if(!basket.length){ tb.innerHTML='<tr><td colspan="5" class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ø¨Ø¹Ø¯.</td></tr>'; $('#totalCarbs').textContent='0.0'; $('#totalCarbsCell').textContent='0.0'; $('#doseSuggestedMeal').value=''; return; }
  tb.innerHTML=''; let sum=0;
  basket.forEach((it,idx)=>{
    sum+=it.totalCarbs;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${escapeHTML(it.name)}</td>
      <td>${escapeHTML(it.unit)}</td>
      <td><input class="qtyRow" type="number" min="0.1" step="0.1" value="${it.qty}" style="width:88px"></td>
      <td class="carbCell">${it.totalCarbs.toFixed(1)}</td>
      <td><button class="btn gray rm">ğŸ—‘ï¸ Ø­Ø°Ù</button></td>
    `;
    tr.querySelector('.qtyRow').addEventListener('input', e=>{
      it.qty = Number(e.target.value)||0;
      it.totalCarbs = +((it.gramsPerUnit*it.qty*it.carbsPer100g)/100).toFixed(1);
      tr.querySelector('.carbCell').textContent = it.totalCarbs.toFixed(1);
      recomputeTotals();
    });
    tr.querySelector('.rm').addEventListener('click', ()=>{ basket.splice(idx,1); renderBasket(); });
    tb.appendChild(tr);
  });
  $('#totalCarbs').textContent=sum.toFixed(1); $('#totalCarbsCell').textContent=sum.toFixed(1);
  const icr=Number(child?.icr)||0; $('#doseSuggestedMeal').value=(icr>0&&sum>0)?(Math.round((sum/icr)*10)/10).toFixed(1):'';
}
function recomputeTotals(){
  let sum=0; basket.forEach(it=>sum+=it.totalCarbs);
  $('#totalCarbs').textContent=sum.toFixed(1); $('#totalCarbsCell').textContent=sum.toFixed(1);
  const icr=Number(child?.icr)||0; $('#doseSuggestedMeal').value=(icr>0&&sum>0)?(Math.round((sum/icr)*10)/10).toFixed(1):'';
}

$('#saveMealBtn')?.addEventListener('click', saveMeal);
async function saveMeal(){
  if(!basket.length) return alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©');
  const when=$('#mealTime').value; if(!when) return alert('Ø­Ø¯Ø¯ÙŠ ÙˆÙ‚Øª Ø§Ù„Ø£ÙƒÙ„');
  const payload={
    type: $('#mealType').value,
    time: when,
    note: $('#mealNote').value||null,
    icrUsed: child?.icr||null,
    totalCarbs: Number($('#totalCarbs').textContent)||0,
    doseSuggested: $('#doseSuggestedMeal').value? Number($('#doseSuggestedMeal').value):null,
    doseGiven: $('#doseGivenMeal').value? Number($('#doseGivenMeal').value):null,
    items: basket,
    createdAt: serverTimestamp()
  };
  const id = String(Date.now());
  await setDoc(doc(db,'users',uid,'children',childId,'meals',id), payload);
  alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙˆØ¬Ø¨Ø©');
  basket=[]; renderBasket();
}
</script>
</body>
</html>
