<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ูุฌุจุงุช ุงูุทูู</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <!-- โ ุจูุฑ ุงูุทูู -->
  <div id="childBanner" style="text-align:center; padding:12px 8px; display:none">
    <img id="bannerAvatar" class="avatar" style="width:84px;height:84px" src="images/avatar-default.png" alt="ุตูุฑุฉ ุงูุทูู">
    <div style="margin-top:6px;font-weight:800" id="bannerName">โ</div>
    <div class="note" id="bannerMeta">โ</div>
  </div>

  <!-- โ Topbar -->
  <div class="topbar">
    <div>๐ฝ๏ธ ุงููุฌุจุงุช</div>
    <div class="row">
      <a id="lnkHome" class="btn gray">ุงูุฑุฆูุณูุฉ</a>
      <button id="btnLogout" class="btn">ุฎุฑูุฌ</button>
    </div>
  </div>

  <main class="container">
    <!-- โ Nav -->
    <div class="card"><div class="row" id="childNav"></div></div>

    <section class="card">
      <div class="row" style="justify-content:space-between; align-items:center">
        <h3 class="section-title">ุงุฎุชูุงุฑ ุงูุฃุตูุงู</h3>
        <div class="row"><span class="badge-soft">ICR ุงูุญุงูู: <b id="icrNow">โ</b> g/U</span></div>
      </div>

      <div class="grid g3" style="margin-bottom:10px">
        <div><label>ููุน ุงููุฌุจุฉ</label>
          <select id="mealType">
            <option value="breakfast">ูุทูุฑ</option>
            <option value="lunch">ุบุฏุงุก</option>
            <option value="dinner">ุนุดุงุก</option>
            <option value="snack">ุณูุงู</option>
            <option value="other">ุฃุฎุฑู</option>
          </select>
        </div>
        <div><label>ููุช ุงูุฃูู</label><input id="mealTime" type="datetime-local"></div>
        <div><label>ููุงุญุธุฉ</label><input id="mealNote" placeholder="ุงุฎุชูุงุฑู"></div>
      </div>

      <div class="layout">
        <!-- ุงูุชุตูููุงุช -->
        <aside class="sidebar">
          <input id="foodSearch" placeholder="ุงุจุญุซ ุนู ุตูู..." />
          <div id="catList" class="col"></div>
        </aside>

        <!-- ุดุจูุฉ + ุณูุฉ -->
        <div class="col">
          <div id="foodsGrid" class="foods-grid"><div class="note">ุฌุงุฑู ุงูุชุญููู...</div></div>

          <div class="card">
            <div class="row" style="justify-content:space-between">
              <h4 style="margin:0">๐งบ ุณูุฉ ุงููุฌุจุฉ</h4>
              <div class="badge-soft">ุฅุฌูุงูู ุงููุงุฑุจ: <b id="totalCarbs">0.0</b> ุฌู</div>
            </div>

            <div class="basket" style="margin-top:8px; overflow:auto">
              <table>
                <thead><tr><th>ุงูุตูู</th><th>ุงููุญุฏุฉ</th><th>ุงููููุฉ</th><th>ุงููุงุฑุจ (ุฌู)</th><th>ุฅุฌุฑุงุก</th></tr></thead>
                <tbody id="basketBody"><tr><td colspan="5" class="note">ูุง ุชูุฌุฏ ุนูุงุตุฑ ุจุนุฏ.</td></tr></tbody>
                <tfoot><tr><td colspan="3"><b>ุงูุฅุฌูุงูู</b></td><td id="totalCarbsCell">0.0</td><td></td></tr></tfoot>
              </table>
            </div>

            <div class="grid g3" style="margin-top:10px">
              <div><label>ุฌุฑุนุฉ ููุชุฑุญุฉ</label><input id="doseSuggestedMeal" readonly></div>
              <div><label>ุฌุฑุนุฉ ูุนููุฉ (ุงุฎุชูุงุฑู)</label><input id="doseGivenMeal" type="number" step="0.1"></div>
              <div class="row" style="align-items:flex-end; justify-content:flex-end">
                <button id="saveMealBtn" class="btn primary">๐พ ุญูุธ ุงููุฌุจุฉ</button>
              </div>
            </div>
            <div class="note">ุงูุญุณุงุจ: (ุฌุฑุงู ุงููุญุฏุฉ ร ุงููููุฉ ร ูุงุฑุจ/100g) รท 100 โ ุงูุฌุฑุนุฉ = ุฅุฌูุงูู ุงููุงุฑุจ รท ICR (ุชูุฑูุจ 0.1U).</div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>
  <div id="loader" class="loader"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>

  <script type="module">
    import { auth, db, ensureAuth, requireChildIdFromQuery, setChildAvatar, toLocalDatetimeValue } from './firebase-init.js';
    import { signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { collection, getDocs, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const toast=(m)=>{const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000)}
    const showLoader=(on)=>{document.getElementById('loader').style.display=on?'flex':'none'}

    let uid=null, childId=null, child=null, foodsAll=[], basket=[], currentCategory='*';

    function buildNav(){
      const row=document.getElementById('childNav'); row.innerHTML='';
      [['child-dashboard.html','ุงูุฑุฆูุณูุฉ'],['measures.html','ููุงุณุงุช ุงูุณูุฑ'],['meals.html','ุงููุฌุจุงุช'],['reports.html','ุงูุชูุงุฑูุฑ'],['visits.html','ุงูุฒูุงุฑุงุช ุงูุทุจูุฉ']]
      .forEach(([h,t])=>{ const a=document.createElement('a'); a.className='btn gray'; a.href=`${h}?child=${encodeURIComponent(childId)}`; a.textContent=t; row.appendChild(a);});
      document.getElementById('lnkHome').href=`child-dashboard.html?child=${encodeURIComponent(childId)}`;
    }

    async function loadChild(){
      const s=await getDoc(doc(db,'users',uid,'children',childId));
      child=s.data()||{};
      setChildAvatar(document.getElementById('bannerAvatar'), child.name, child.photoURL);
      bannerName.textContent=child.name||'โ';
      bannerMeta.textContent=`${child.gender||'โ'} โข ${child.weight||'โ'} ูุฌู โข ${child.height||'โ'} ุณู`;
      childBanner.style.display='block';
      document.getElementById('icrNow').textContent = child.icr||'โ';
      mealTime.value = toLocalDatetimeValue(new Date());
    }

    async function loadFoods(){
      foodsAll=[];
      const qs=await getDocs(collection(db,'foods'));
      qs.forEach(s=>{
        const d=s.data(); if(d.isActive===false) return;
        foodsAll.push({
          id:s.id, name:d.name||'ุจุฏูู ุงุณู', category:d.category||'ุฃุฎุฑู',
          carbsPer100g: Number(d.carbsPer100g)||0,
          imageUrl: d.imageUrl||'https://cdn-icons-png.flaticon.com/512/1046/1046784.png',
          servingUnits: Array.isArray(d.servingUnits)&&d.servingUnits.length? d.servingUnits : [{unit:'ุฌุฑุงู', grams:100}]
        });
      });
      buildCategories(); renderFoods();
    }

    function buildCategories(){
      const set=new Set(['*']); foodsAll.forEach(f=>set.add(f.category||'ุฃุฎุฑู'));
      const box=document.getElementById('catList'); box.innerHTML='';
      [...set].forEach(cat=>{
        const b=document.createElement('a'); b.className='side-link'+(cat===currentCategory?' active':''); b.textContent=cat==='*'?'ูู ุงูุฃุตูุงู':cat; b.href='javascript:void(0)';
        b.addEventListener('click',()=>{ currentCategory=cat; buildCategories(); renderFoods(); });
        box.appendChild(b);
      });
    }

    function renderFoods(){
      const grid=document.getElementById('foodsGrid'); grid.innerHTML='';
      const q=(foodSearch.value||'').trim().toLowerCase();
      const list=foodsAll.filter(f=> (currentCategory==='*'||f.category===currentCategory) && (!q || f.name.toLowerCase().includes(q)));
      if(!list.length){ grid.innerHTML='<div class="note">ูุง ุชูุฌุฏ ุฃุตูุงู.</div>'; return; }
      list.forEach(f=>{
        const card=document.createElement('div'); card.className='food';
        const options=f.servingUnits.map(u=>`<option value="${u.grams}">${u.unit} (${u.grams}ุฌู)</option>`).join('');
        card.innerHTML=`
          <img src="${f.imageUrl}" alt="${escapeHTML(f.name)}">
          <div class="name">${escapeHTML(f.name)}</div>
          <div class="note">ุงููุงุฑุจ/100ุฌู: <b>${f.carbsPer100g}</b></div>
          <div class="row" style="justify-content:center;margin-top:6px">
            <select class="uSel">${options}</select>
            <input class="qty" type="number" min="0.1" step="0.1" value="1" style="width:88px">
          </div>
          <div class="row" style="justify-content:space-between;margin-top:6px">
            <button class="btn gray addBtn">โ ุฃุถู</button>
            <span class="badge-soft">${escapeHTML(f.category)}</span>
          </div>
        `;
        const uSel=card.querySelector('.uSel'), qty=card.querySelector('.qty');
        card.querySelector('.addBtn').addEventListener('click', ()=>{
          const gramsPerUnit = Number(uSel.value)||100;
          const qv = Number(qty.value)||0; if(qv<=0) return toast('ุงุฏุฎูู ูููุฉ ุตุญูุญุฉ');
          const totalCarbs = +( (gramsPerUnit*qv*f.carbsPer100g)/100 ).toFixed(1);
          basket.push({ foodId:f.id, name:f.name, unit: unitName(f.servingUnits, gramsPerUnit), gramsPerUnit, qty:qv, carbsPer100g:f.carbsPer100g, totalCarbs });
          renderBasket();
        });
        grid.appendChild(card);
      });
    }

    function unitName(units, grams){ const u=(units||[]).find(x=>Number(x.grams)===Number(grams)); return u? `${u.unit} (${u.grams}ุฌู)`:`ุฌุฑุงู (${grams})`}
    function escapeHTML(s){return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]))}

    function renderBasket(){
      const tb=document.getElementById('basketBody'); if(!basket.length){tb.innerHTML='<tr><td colspan="5" class="note">ูุง ุชูุฌุฏ ุนูุงุตุฑ ุจุนุฏ.</td></tr>'; totalCarbs.textContent='0.0'; totalCarbsCell.textContent='0.0'; doseSuggestedMeal.value=''; return;}
      tb.innerHTML=''; let sum=0;
      basket.forEach((it,idx)=>{
        sum+=it.totalCarbs;
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${escapeHTML(it.name)}</td>
          <td>${escapeHTML(it.unit)}</td>
          <td><input class="qtyRow" type="number" min="0.1" step="0.1" value="${it.qty}" style="width:88px"></td>
          <td class="carbCell">${it.totalCarbs.toFixed(1)}</td>
          <td><button class="btn gray rm">๐๏ธ ุญุฐู</button></td>
        `;
        tr.querySelector('.qtyRow').addEventListener('input', e=>{
          it.qty = Number(e.target.value)||0;
          it.totalCarbs = +((it.gramsPerUnit*it.qty*it.carbsPer100g)/100).toFixed(1);
          tr.querySelector('.carbCell').textContent = it.totalCarbs.toFixed(1);
          recomputeTotals();
        });
        tr.querySelector('.rm').addEventListener('click', ()=>{ basket.splice(idx,1); renderBasket(); });
        tb.appendChild(tr);
      });
      totalCarbs.textContent=sum.toFixed(1); totalCarbsCell.textContent=sum.toFixed(1);
      const icr=Number(child?.icr)||0; doseSuggestedMeal.value = (icr>0&&sum>0)? (Math.round((sum/icr)*10)/10).toFixed(1):'';
    }
    function recomputeTotals(){
      let sum=0; basket.forEach(it=>sum+=it.totalCarbs);
      totalCarbs.textContent=sum.toFixed(1); totalCarbsCell.textContent=sum.toFixed(1);
      const icr=Number(child?.icr)||0; doseSuggestedMeal.value=(icr>0&&sum>0)?(Math.round((sum/icr)*10)/10).toFixed(1):'';
    }

    saveMealBtn.addEventListener('click', async ()=>{
      if(!basket.length) return toast('ุงูุณูุฉ ูุงุฑุบุฉ');
      const when = mealTime.value; if(!when) return toast('ุญุฏุฏู ููุช ุงูุฃูู');
      const payload={
        type: mealType.value,
        time: when,
        note: mealNote.value||null,
        icrUsed: child?.icr||null,
        totalCarbs: Number(totalCarbs.textContent)||0,
        doseSuggested: doseSuggestedMeal.value? Number(doseSuggestedMeal.value):null,
        doseGiven: doseGivenMeal.value? Number(doseGivenMeal.value):null,
        items: basket,
        createdAt: serverTimestamp()
      };
      const id = String(Date.now());
      await setDoc(doc(db,'users',uid,'children',childId,'meals',id), payload);
      toast('โ ุชู ุญูุธ ุงููุฌุจุฉ');
      basket=[]; renderBasket();
    });

    // Boot
    (async function(){
      const {uid:U}=await ensureAuth(); uid=U;
      childId=requireChildIdFromQuery();
      // nav
      const nav=document.getElementById('childNav'); nav.innerHTML='';
      [['child-dashboard.html','ุงูุฑุฆูุณูุฉ'],['measures.html','ููุงุณุงุช ุงูุณูุฑ'],['meals.html','ุงููุฌุจุงุช'],['reports.html','ุงูุชูุงุฑูุฑ'],['visits.html','ุงูุฒูุงุฑุงุช ุงูุทุจูุฉ']]
      .forEach(([h,t])=>{ const a=document.createElement('a'); a.className='btn gray'; a.href=`${h}?child=${encodeURIComponent(childId)}`; a.textContent=t; nav.appendChild(a);});
      document.getElementById('lnkHome').href=`child-dashboard.html?child=${encodeURIComponent(childId)}`;

      await loadChild();
      await loadFoods();

      btnLogout.addEventListener('click', ()=>signOut(auth).then(()=>location.href='index.html'));
      foodSearch.addEventListener('input', renderFoods);
    })();
  </script>
</body>
</html>
