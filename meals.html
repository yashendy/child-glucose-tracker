<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ÙˆØ¬Ø¨Ø§Øª Ø§Ù„Ø·ÙÙ„</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <!-- âœ… Ø¨Ù†Ø± Ø§Ù„Ø·ÙÙ„ -->
  <div id="childBanner" style="text-align:center; padding:12px 8px; display:none">
    <img id="bannerAvatar" class="avatar" style="width:84px;height:84px" src="images/avatar-default.png" alt="ØµÙˆØ±Ø© Ø§Ù„Ø·ÙÙ„">
    <div style="margin-top:6px;font-weight:800" id="bannerName">â€”</div>
    <div class="note" id="bannerMeta">â€”</div>
  </div>

  <!-- âœ… Topbar -->
  <div class="topbar">
    <div>ğŸ½ï¸ Ø§Ù„ÙˆØ¬Ø¨Ø§Øª</div>
    <div class="row">
      <a id="lnkHome" class="btn gray">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
      <button id="btnLogout" class="btn">Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <main class="container">
    <!-- âœ… Nav -->
    <div class="card"><div class="row" id="childNav"></div></div>

    <section class="card">
      <div class="row" style="justify-content:space-between; align-items:center">
        <h3 class="section-title">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£ØµÙ†Ø§Ù</h3>
        <div class="row"><span class="badge-soft">ICR Ø§Ù„Ø­Ø§Ù„ÙŠ: <b id="icrNow">â€”</b> g/U</span></div>
      </div>

      <div class="grid g3" style="margin-bottom:10px">
        <div><label>Ù†ÙˆØ¹ Ø§Ù„ÙˆØ¬Ø¨Ø©</label>
          <select id="mealType">
            <option value="breakfast">ÙØ·ÙˆØ±</option>
            <option value="lunch">ØºØ¯Ø§Ø¡</option>
            <option value="dinner">Ø¹Ø´Ø§Ø¡</option>
            <option value="snack">Ø³Ù†Ø§Ùƒ</option>
            <option value="other">Ø£Ø®Ø±Ù‰</option>
          </select>
        </div>
        <div><label>ÙˆÙ‚Øª Ø§Ù„Ø£ÙƒÙ„</label><input id="mealTime" type="datetime-local"></div>
        <div><label>Ù…Ù„Ø§Ø­Ø¸Ø©</label><input id="mealNote" placeholder="Ø§Ø®ØªÙŠØ§Ø±ÙŠ"></div>
      </div>

      <div class="layout">
        <!-- Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª -->
        <aside class="sidebar">
          <input id="foodSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ØµÙ†Ù..." />
          <div id="catList" class="col"></div>
        </aside>

        <!-- Ø´Ø¨ÙƒØ© + Ø³Ù„Ø© -->
        <div class="col">
          <div id="foodsGrid" class="foods-grid"><div class="note">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>

          <div class="card">
            <div class="row" style="justify-content:space-between">
              <h4 style="margin:0">ğŸ§º Ø³Ù„Ø© Ø§Ù„ÙˆØ¬Ø¨Ø©</h4>
              <div class="badge-soft">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ§Ø±Ø¨: <b id="totalCarbs">0.0</b> Ø¬Ù…</div>
            </div>

            <div class="basket" style="margin-top:8px; overflow:auto">
              <table>
                <thead><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„ÙƒØ§Ø±Ø¨ (Ø¬Ù…)</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                <tbody id="basketBody"><tr><td colspan="5" class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ø¨Ø¹Ø¯.</td></tr></tbody>
                <tfoot><tr><td colspan="3"><b>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</b></td><td id="totalCarbsCell">0.0</td><td></td></tr></tfoot>
              </table>
            </div>

            <div class="grid g3" style="margin-top:10px">
              <div><label>Ø¬Ø±Ø¹Ø© Ù…Ù‚ØªØ±Ø­Ø©</label><input id="doseSuggestedMeal" readonly></div>
              <div><label>Ø¬Ø±Ø¹Ø© ÙØ¹Ù„ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label><input id="doseGivenMeal" type="number" step="0.1"></div>
              <div class="row" style="align-items:flex-end; justify-content:flex-end">
                <button id="saveMealBtn" class="btn primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ÙˆØ¬Ø¨Ø©</button>
              </div>
            </div>
            <div class="note">Ø§Ù„Ø­Ø³Ø§Ø¨: (Ø¬Ø±Ø§Ù… Ø§Ù„ÙˆØ­Ø¯Ø© Ã— Ø§Ù„ÙƒÙ…ÙŠØ© Ã— ÙƒØ§Ø±Ø¨/100g) Ã· 100 â€” Ø§Ù„Ø¬Ø±Ø¹Ø© = Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ§Ø±Ø¨ Ã· ICR (ØªÙ‚Ø±ÙŠØ¨ 0.1U).</div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>
  <div id="loader" class="loader"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>

  <script type="module">
    import { auth, db, ensureAuth, requireChildIdFromQuery, setChildAvatar, toLocalDatetimeValue } from './firebase-init.js';
    import { signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { collection, getDocs, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const toast=(m)=>{const t=document.getElementById('toast');t.textContent=m;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2000)}
    const showLoader=(on)=>{document.getElementById('loader').style.display=on?'flex':'none'}

    let uid=null, childId=null, child=null, foodsAll=[], basket=[], currentCategory='*';

    function buildNav(){
      const row=document.getElementById('childNav'); row.innerHTML='';
      [['child-dashboard.html','Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'],['measures.html','Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ±'],['meals.html','Ø§Ù„ÙˆØ¬Ø¨Ø§Øª'],['reports.html','Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±'],['visits.html','Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©']]
      .forEach(([h,t])=>{ const a=document.createElement('a'); a.className='btn gray'; a.href=`${h}?child=${encodeURIComponent(childId)}`; a.textContent=t; row.appendChild(a);});
      document.getElementById('lnkHome').href=`child-dashboard.html?child=${encodeURIComponent(childId)}`;
    }

    async function loadChild(){
      const s=await getDoc(doc(db,'users',uid,'children',childId));
      child=s.data()||{};
      setChildAvatar(document.getElementById('bannerAvatar'), child.name, child.photoURL);
      bannerName.textContent=child.name||'â€”';
      bannerMeta.textContent=`${child.gender||'â€”'} â€¢ ${child.weight||'â€”'} ÙƒØ¬Ù… â€¢ ${child.height||'â€”'} Ø³Ù…`;
      childBanner.style.display='block';
      document.getElementById('icrNow').textContent = child.icr||'â€”';
      mealTime.value = toLocalDatetimeValue(new Date());
    }

    async function loadFoods(){
      foodsAll=[];
      const qs=await getDocs(collection(db,'foods'));
      qs.forEach(s=>{
        const d=s.data(); if(d.isActive===false) return;
        foodsAll.push({
          id:s.id, name:d.name||'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…', category:d.category||'Ø£Ø®Ø±Ù‰',
          carbsPer100g: Number(d.carbsPer100g)||0,
          imageUrl: d.imageUrl||'https://cdn-icons-png.flaticon.com/512/1046/1046784.png',
          servingUnits: Array.isArray(d.servingUnits)&&d.servingUnits.length? d.servingUnits : [{unit:'Ø¬Ø±Ø§Ù…', grams:100}]
        });
      });
      buildCategories(); renderFoods();
    }

    function buildCategories(){
      const set=new Set(['*']); foodsAll.forEach(f=>set.add(f.category||'Ø£Ø®Ø±Ù‰'));
      const box=document.getElementById('catList'); box.innerHTML='';
      [...set].forEach(cat=>{
        const b=document.createElement('a'); b.className='side-link'+(cat===currentCategory?' active':''); b.textContent=cat==='*'?'ÙƒÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù':cat; b.href='javascript:void(0)';
        b.addEventListener('click',()=>{ currentCategory=cat; buildCategories(); renderFoods(); });
        box.appendChild(b);
      });
    }

    function renderFoods(){
      const grid=document.getElementById('foodsGrid'); grid.innerHTML='';
      const q=(foodSearch.value||'').trim().toLowerCase();
      const list=foodsAll.filter(f=> (currentCategory==='*'||f.category===currentCategory) && (!q || f.name.toLowerCase().includes(q)));
      if(!list.length){ grid.innerHTML='<div class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù.</div>'; return; }
      list.forEach(f=>{
        const card=document.createElement('div'); card.className='food';
        const options=f.servingUnits.map(u=>`<option value="${u.grams}">${u.unit} (${u.grams}Ø¬Ù…)</option>`).join('');
        card.innerHTML=`
          <img src="${f.imageUrl}" alt="${escapeHTML(f.name)}">
          <div class="name">${escapeHTML(f.name)}</div>
          <div class="note">Ø§Ù„ÙƒØ§Ø±Ø¨/100Ø¬Ù…: <b>${f.carbsPer100g}</b></div>
          <div class="row" style="justify-content:center;margin-top:6px">
            <select class="uSel">${options}</select>
            <input class="qty" type="number" min="0.1" step="0.1" value="1" style="width:88px">
          </div>
          <div class="row" style="justify-content:space-between;margin-top:6px">
            <button class="btn gray addBtn">â• Ø£Ø¶Ù</button>
            <span class="badge-soft">${escapeHTML(f.category)}</span>
          </div>
        `;
        const uSel=card.querySelector('.uSel'), qty=card.querySelector('.qty');
        card.querySelector('.addBtn').addEventListener('click', ()=>{
          const gramsPerUnit = Number(uSel.value)||100;
          const qv = Number(qty.value)||0; if(qv<=0) return toast('Ø§Ø¯Ø®Ù„ÙŠ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø©');
          const totalCarbs = +( (gramsPerUnit*qv*f.carbsPer100g)/100 ).toFixed(1);
          basket.push({ foodId:f.id, name:f.name, unit: unitName(f.servingUnits, gramsPerUnit), gramsPerUnit, qty:qv, carbsPer100g:f.carbsPer100g, totalCarbs });
          renderBasket();
        });
        grid.appendChild(card);
      });
    }

    function unitName(units, grams){ const u=(units||[]).find(x=>Number(x.grams)===Number(grams)); return u? `${u.unit} (${u.grams}Ø¬Ù…)`:`Ø¬Ø±Ø§Ù… (${grams})`}
    function escapeHTML(s){return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]))}

    function renderBasket(){
      const tb=document.getElementById('basketBody'); if(!basket.length){tb.innerHTML='<tr><td colspan="5" class="note">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ø¨Ø¹Ø¯.</td></tr>'; totalCarbs.textContent='0.0'; totalCarbsCell.textContent='0.0'; doseSuggestedMeal.value=''; return;}
      tb.innerHTML=''; let sum=0;
      basket.forEach((it,idx)=>{
        sum+=it.totalCarbs;
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${escapeHTML(it.name)}</td>
          <td>${escapeHTML(it.unit)}</td>
          <td><input class="qtyRow" type="number" min="0.1" step="0.1" value="${it.qty}" style="width:88px"></td>
          <td class="carbCell">${it.totalCarbs.toFixed(1)}</td>
          <td><button class="btn gray rm">ğŸ—‘ï¸ Ø­Ø°Ù</button></td>
        `;
        tr.querySelector('.qtyRow').addEventListener('input', e=>{
          it.qty = Number(e.target.value)||0;
          it.totalCarbs = +((it.gramsPerUnit*it.qty*it.carbsPer100g)/100).toFixed(1);
          tr.querySelector('.carbCell').textContent = it.totalCarbs.toFixed(1);
          recomputeTotals();
        });
        tr.querySelector('.rm').addEventListener('click', ()=>{ basket.splice(idx,1); renderBasket(); });
        tb.appendChild(tr);
      });
      totalCarbs.textContent=sum.toFixed(1); totalCarbsCell.textContent=sum.toFixed(1);
      const icr=Number(child?.icr)||0; doseSuggestedMeal.value = (icr>0&&sum>0)? (Math.round((sum/icr)*10)/10).toFixed(1):'';
    }
    function recomputeTotals(){
      let sum=0; basket.forEach(it=>sum+=it.totalCarbs);
      totalCarbs.textContent=sum.toFixed(1); totalCarbsCell.textContent=sum.toFixed(1);
      const icr=Number(child?.icr)||0; doseSuggestedMeal.value=(icr>0&&sum>0)?(Math.round((sum/icr)*10)/10).toFixed(1):'';
    }

    saveMealBtn.addEventListener('click', async ()=>{
      if(!basket.length) return toast('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©');
      const when = mealTime.value; if(!when) return toast('Ø­Ø¯Ø¯ÙŠ ÙˆÙ‚Øª Ø§Ù„Ø£ÙƒÙ„');
      const payload={
        type: mealType.value,
        time: when,
        note: mealNote.value||null,
        icrUsed: child?.icr||null,
        totalCarbs: Number(totalCarbs.textContent)||0,
        doseSuggested: doseSuggestedMeal.value? Number(doseSuggestedMeal.value):null,
        doseGiven: doseGivenMeal.value? Number(doseGivenMeal.value):null,
        items: basket,
        createdAt: serverTimestamp()
      };
      const id = String(Date.now());
      await setDoc(doc(db,'users',uid,'children',childId,'meals',id), payload);
      toast('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙˆØ¬Ø¨Ø©');
      basket=[]; renderBasket();
    });

    // Boot
    (async function(){
      const {uid:U}=await ensureAuth(); uid=U;
      childId=requireChildIdFromQuery();
      // nav
      const nav=document.getElementById('childNav'); nav.innerHTML='';
      [['child-dashboard.html','Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©'],['measures.html','Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø³ÙƒØ±'],['meals.html','Ø§Ù„ÙˆØ¬Ø¨Ø§Øª'],['reports.html','Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±'],['visits.html','Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©']]
      .forEach(([h,t])=>{ const a=document.createElement('a'); a.className='btn gray'; a.href=`${h}?child=${encodeURIComponent(childId)}`; a.textContent=t; nav.appendChild(a);});
      document.getElementById('lnkHome').href=`child-dashboard.html?child=${encodeURIComponent(childId)}`;

      await loadChild();
      await loadFoods();

      btnLogout.addEventListener('click', ()=>signOut(auth).then(()=>location.href='index.html'));
      foodSearch.addEventListener('input', renderFoods);
    })();
  </script>
</body>
</html>
