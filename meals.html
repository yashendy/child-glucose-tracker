<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>وجبات الطفل — ذكي</title>
<style>
:root{--brand:#0ea5e9;--brand2:#6ee7b7;--line:#e5e7eb;--ink:#0f172a;--muted:#64748b;--bg:#f6fbff;--card:#fff}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.6 system-ui,"Tajawal","Noto Sans Arabic",sans-serif}
a{text-decoration:none;color:inherit} .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.container{max-width:1100px;margin:auto;padding:14px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:0 6px 24px rgba(0,0,0,.04);margin-bottom:12px}
.btn{border:none;border-radius:10px;padding:9px 12px;font-weight:800;cursor:pointer}
.btn.primary{background:var(--brand);color:#fff} .btn.gray{background:#eef2f7}
.topbar{position:sticky;top:0;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;padding:10px 14px;display:flex;justify-content:space-between;align-items:center;z-index:5}
.note{color:var(--muted);font-size:12px}
.avatar{width:64px;height:64px;border-radius:50%;object-fit:cover;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.12)}
.badge-soft{display:inline-block;background:#eef6ff;color:#0369a1;border-radius:999px;padding:4px 8px;font-weight:800;font-size:12px}
.grid{display:grid;gap:10px} .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
@media(max-width:900px){.g3{grid-template-columns:1fr}}
.layout{display:grid;grid-template-columns:240px 1fr;gap:12px}
@media(max-width:900px){.layout{grid-template-columns:1fr}}
.sidebar input{width:100%;padding:9px 10px;border:1px solid var(--line);border-radius:10px;margin-bottom:8px;background:#fff}
.side-link{display:block;padding:8px 10px;margin-bottom:6px;border:1px solid var(--line);border-radius:10px;background:#fff;font-weight:700}
.side-link.active,.side-link:hover{background:#e6f7ff;border-color:#bde5ff}
.foods-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px}
.food{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,.04)}
.food img{width:72px;height:72px;object-fit:contain}
.food .name{font-weight:800;margin-top:6px}
.basket table{width:100%;border-collapse:separate;border-spacing:0}
.basket thead th{background:#f1f5f9;font-weight:800}
.basket th,.basket td{border:1px solid var(--line);padding:8px;text-align:center}
.kpi{display:flex;gap:8px;flex-wrap:wrap}
.kpi .chip{background:#f0f9ff;border:1px solid #cfeffd;border-radius:999px;padding:6px 10px;font-weight:800;font-size:12px}
.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>

<!-- Topbar -->
<div class="topbar">
  <div>🍽️ الوجبات (ذكي)</div>
  <div class="row">
    <a id="lnkDashboard" class="btn gray">لوحة الطفل</a>
    <button id="btnLogout" class="btn gray">خروج</button>
  </div>
</div>

<main class="container">
  <!-- بانر الطفل -->
  <section class="card" id="kidCard" style="display:none">
    <div class="row" style="align-items:center;justify-content:space-between">
      <div class="row" style="align-items:center">
        <img id="kidAvatar" class="avatar" src="images/avatar-default.png" alt="">
        <div>
          <div id="kidName" style="font-weight:800">—</div>
          <div id="kidMeta" class="note">—</div>
        </div>
      </div>
      <div class="row">
        <span class="badge-soft">ICR: <b id="icrNow">—</b> g/U</span>
        <a id="btnFoodsAdmin" class="btn gray">🗂️ إدارة الأصناف</a>
      </div>
    </div>
  </section>

  <!-- تنسيق الوجبة -->
  <section class="card">
    <div class="grid g3" style="margin-bottom:8px">
      <div><label class="small">نوع الوجبة</label>
        <select id="mealType">
          <option value="breakfast">فطور</option><option value="lunch">غداء</option>
          <option value="dinner">عشاء</option><option value="snack">سناك</option><option value="other">أخرى</option>
        </select>
      </div>
      <div><label class="small">وقت الأكل</label><input id="mealTime" type="datetime-local"></div>
      <div><label class="small">ملاحظة</label><input id="mealNote" placeholder="اختياري"></div>
    </div>

    <div class="layout">
      <!-- التصنيفات -->
      <aside class="sidebar">
        <input id="foodSearch" placeholder="ابحث باسم/وسم...">
        <div id="catList"></div>
      </aside>

      <!-- الشبكة + السلة -->
      <div>
        <div id="foodsGrid" class="foods-grid"><div class="note">جاري التحميل...</div></div>

        <div class="card" style="margin-top:12px">
          <div class="row" style="justify-content:space-between;align-items:center">
            <h4 style="margin:0">🧺 سلة الوجبة</h4>
            <div class="kpi">
              <span class="chip">🥔 كارب: <b id="sumCarb">0.0</b> جم</span>
              <span class="chip">🥚 بروتين: <b id="sumProt">0.0</b> جم</span>
              <span class="chip">🧈 دهون: <b id="sumFat">0.0</b> جم</span>
              <span class="chip">🔥 سعرات: <b id="sumKcal">0</b> ك</span>
            </div>
          </div>

          <div class="basket" style="margin-top:8px; overflow:auto">
            <table>
              <thead><tr><th>الصنف</th><th>الوحدة</th><th>الكمية</th><th>الكارب</th><th>إجراء</th></tr></thead>
              <tbody id="basketBody"><tr><td colspan="5" class="note">لا توجد عناصر بعد.</td></tr></tbody>
              <tfoot><tr><td colspan="3"><b>الإجمالي</b></td><td id="totalCarbsCell">0.0</td><td></td></tr></tfoot>
            </table>
          </div>

          <!-- اقتراح الجرعة -->
          <div class="grid g3" style="margin-top:10px">
            <div>
              <label class="small">جرعة مقترحة (أساس الكارب)</label>
              <input id="doseBase" readonly>
              <div class="small">= الكارب ÷ ICR (تقريب 0.1U)</div>
            </div>
            <div>
              <label class="small">زيادة دهون/بروتين (FPU)</label>
              <input id="doseFpu" readonly>
              <div class="small">اختياري: تحويل دهون+بروتين لكارب مكافئ</div>
            </div>
            <div>
              <label class="small">تعديل الذكاء (سلوكك السابق)</label>
              <input id="doseAi" readonly>
              <div class="small">يعتمد على تعديلك السابق لنفس نوع الوجبة</div>
            </div>
          </div>

          <div class="grid g3" style="margin-top:8px">
            <div>
              <label class="small">الجرعة النهائية المقترحة</label>
              <input id="doseSuggestedMeal" readonly>
            </div>
            <div>
              <label class="small">جرعة فعلية (اختياري)</label>
              <input id="doseGivenMeal" type="number" step="0.1">
            </div>
            <div class="row" style="align-items:flex-end; justify-content:flex-end">
              <button id="saveMealBtn" class="btn primary">💾 حفظ الوجبة</button>
            </div>
          </div>

          <div id="splitHint" class="note" style="margin-top:6px;display:none"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- تنقّل سريع -->
  <section class="card">
    <div class="row" id="quickNav"></div>
  </section>
</main>

<script type="module">
import { db, auth } from './firebase-init.js';
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { collection, getDocs, doc, getDoc, setDoc, updateDoc, serverTimestamp, deleteDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

/* -------------- Helpers -------------- */
const $=s=>document.querySelector(s);
const z2=n=>String(n).padStart(2,'0');
const toLocalDT=(d)=>{ const x=new Date(d); x.setMinutes(x.getMinutes()-x.getTimezoneOffset()); return x.toISOString().slice(0,16); };
const round1=n=>Math.round(Number(n||0)*10)/10;
const fixed1=n=> (Number.isFinite(+n) ? round1(n).toFixed(1) : '');
const escapeHTML=s=>String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
function todayIso(){ const d=new Date(); return `${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())}`; }

/* -------------- State -------------- */
let uid=null, childId=new URL(location.href).searchParams.get('child');
let child=null, foodsAll=[], basket=[];
let aiBuckets={}; // {bucket:{sumPct:..., count:...}}

/* -------------- Auth & Load -------------- */
onAuthStateChanged(auth, async (u)=>{
  if(!u){ location.href='index.html'; return; }
  uid=u.uid;
  if(!childId){ alert('لا يوجد معرف طفل بالرابط'); return; }
  await loadChild();
  await loadFoods();
  buildCats(); renderFoods();
  buildNav();
  // defaults
  $('#mealTime').value = toLocalDT(new Date());
  $('#btnLogout').onclick = ()=>signOut(auth).then(()=>location.href='index.html');
  $('#lnkDashboard').href = `child-dashboard.html?child=${encodeURIComponent(childId)}`;
  $('#btnFoodsAdmin').href= `foods-admin.html?child=${encodeURIComponent(childId)}`;
  $('#foodSearch').addEventListener('input', renderFoods);
});

/* -------------- Child -------------- */
async function loadChild(){
  const s=await getDoc(doc(db,'users',uid,'children',childId));
  child=s.data()||{};
  $('#kidCard').style.display='block';
  $('#kidName').textContent = child.name||'—';
  $('#kidMeta').textContent = `${child.gender||'—'} • ${child.weight??'—'} كجم • ${child.height??'—'} سم`;
  if(child.photoURL) $('#kidAvatar').src = child.photoURL;
  $('#icrNow').textContent = child.icr ?? '—';
  aiBuckets = child.aiBuckets || {};
}

/* -------------- Foods -------------- */
async function loadFoods(){
  foodsAll=[];
  const qs=await getDocs(collection(db,'foods'));
  qs.forEach(s=>{
    const d=s.data();
    if(d.isActive===false) return;
    foodsAll.push({
      id:s.id,
      name:d.name||'بدون اسم',
      category:d.category||'أخرى',
      imageUrl:d.imageUrl||'https://cdn-icons-png.flaticon.com/512/1046/1046784.png',
      carbsPer100g:+(d.carbsPer100g||0),
      proteinPer100g:+(d.proteinPer100g||0),
      fatPer100g:+(d.fatPer100g||0),
      kcalPer100g:+(d.kcalPer100g|| ((+(d.carbsPer100g||0)*4)+(+(d.proteinPer100g||0)*4)+(+(d.fatPer100g||0)*9)) ),
      tags:Array.isArray(d.tags)?d.tags:[],
      servingUnits: Array.isArray(d.servingUnits)&&d.servingUnits.length? d.servingUnits : [{unit:'جرام', grams:1}],
    });
  });
}
let currentCat='*';
function buildCats(){
  const set=new Set(['*']); foodsAll.forEach(f=>set.add(f.category||'أخرى'));
  const box=$('#catList'); box.innerHTML='';
  [...set].forEach(cat=>{
    const a=document.createElement('a');
    a.className='side-link'+(cat===currentCat?' active':'');
    a.textContent= (cat==='*'?'كل الأصناف':cat);
    a.href='javascript:void(0)';
    a.onclick=()=>{ currentCat=cat; buildCats(); renderFoods(); };
    box.appendChild(a);
  });
}
function renderFoods(){
  const grid=$('#foodsGrid'); grid.innerHTML='';
  const q=($('#foodSearch').value||'').trim().toLowerCase();
  const list=foodsAll.filter(f=>{
    const byCat = (currentCat==='*'||f.category===currentCat);
    const byText= !q || f.name.toLowerCase().includes(q) || (f.tags||[]).some(t=>String(t).toLowerCase().includes(q));
    return byCat && byText;
  });
  if(!list.length){ grid.innerHTML='<div class="note">لا توجد أصناف.</div>'; return; }
  list.forEach(f=>{
    const card=document.createElement('div'); card.className='food';
    // أضيف خيار "جرام (1جم)" دائمًا:
    const units=[{unit:'جرام',grams:1}].concat(f.servingUnits.filter(u=>+u.grams!==1));
    const unitOptions = units.map(u=>`<option value="${u.grams}">${escapeHTML(u.unit)} (${u.grams}جم)</option>`).join('');
    card.innerHTML=`
      <img src="${f.imageUrl}" alt="${escapeHTML(f.name)}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/1046/1046784.png'">
      <div class="name">${escapeHTML(f.name)}</div>
      <div class="small">كارب/100جم: <b>${f.carbsPer100g}</b> • بروتين: <b>${f.proteinPer100g}</b> • دهون: <b>${f.fatPer100g}</b></div>
      <div class="row" style="justify-content:center;margin-top:6px">
        <select class="uSel">${unitOptions}</select>
        <input class="qty" type="number" min="0.1" step="0.1" value="1" style="width:88px">
      </div>
      <div class="row" style="justify-content:space-between;margin-top:6px">
        <button class="btn gray addBtn">➕ أضف</button>
        <span class="badge-soft">${escapeHTML(f.category)}</span>
      </div>
    `;
    const uSel=card.querySelector('.uSel'), qty=card.querySelector('.qty');
    card.querySelector('.addBtn').onclick=()=>{
      const gramsPerUnit= +uSel.value || 1;
      const amount     = +qty.value || 0;
      if(amount<=0) return alert('أدخلي كمية صحيحة');
      // لو الوحدة جرام(1جم): الكمية = عدد الجرامات
      const gramsTotal = gramsPerUnit * amount;
      const carbs = +( (gramsTotal * f.carbsPer100g) / 100 ).toFixed(1);
      const prot  = +( (gramsTotal * f.proteinPer100g) / 100 ).toFixed(1);
      const fat   = +( (gramsTotal * f.fatPer100g) / 100 ).toFixed(1);
      const kcal  = Math.round((gramsTotal * f.kcalPer100g) / 100);
      basket.push({
        foodId:f.id, name:f.name, unit:unitLabel(units, gramsPerUnit),
        gramsPerUnit, qty:amount, gramsTotal,
        carbs, prot, fat, kcal
      });
      renderBasket();
    };
    grid.appendChild(card);
  });
}
function unitLabel(units, grams){ const u=(units||[]).find(x=>+x.grams===+grams); return u? `${u.unit} (${u.grams}جم)`:`جرام (${grams})`; }

/* -------------- Basket & Dosing -------------- */
function renderBasket(){
  const tb=$('#basketBody');
  if(!basket.length){
    tb.innerHTML='<tr><td colspan="5" class="note">لا توجد عناصر بعد.</td></tr>';
    $('#totalCarbsCell').textContent='0.0';
    refreshDose(); return;
  }
  tb.innerHTML='';
  let totalCarb=0,totalProt=0,totalFat=0,totalKcal=0;
  basket.forEach((it,idx)=>{
    totalCarb+=it.carbs; totalProt+=it.prot; totalFat+=it.fat; totalKcal+=it.kcal;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${escapeHTML(it.name)}</td>
      <td>${escapeHTML(it.unit)}</td>
      <td><input class="q" type="number" min="0.1" step="0.1" value="${it.qty}" style="width:88px"></td>
      <td class="c">${it.carbs.toFixed(1)}</td>
      <td><button class="btn gray rm">🗑️ حذف</button></td>
    `;
    tr.querySelector('.q').oninput=(e)=>{
      const q=+e.target.value||0;
      it.qty=q;
      it.gramsTotal=it.gramsPerUnit*q;
      it.carbs=+((it.gramsTotal*it.carbs/it.gramsTotal)).toFixed(1); // يعاد احتساب سريع
      // إعادة احتساب دقيقة من نسب/100جم:
      const factor=it.gramsTotal/100;
      it.carbs=+(factor * (it.carbs/ (it.gramsTotal/100))).toFixed(1);
      // أبسط وأدق: احفظ النِّسَب داخل العنصر (لنختصر الآن)
      renderBasket(); // أعِد الرسم لتبسيط التدقيق
    };
    tr.querySelector('.rm').onclick=()=>{ basket.splice(idx,1); renderBasket(); };
    tb.appendChild(tr);
  });
  // تلخيص
  $('#sumCarb').textContent= round1(totalCarb).toFixed(1);
  $('#sumProt').textContent= round1(totalProt).toFixed(1);
  $('#sumFat').textContent = round1(totalFat).toFixed(1);
  $('#sumKcal').textContent= Math.round(totalKcal);
  $('#totalCarbsCell').textContent = round1(totalCarb).toFixed(1);
  refreshDose();
}

function refreshDose(){
  const icr= +child?.icr || 0;
  const c = +($('#sumCarb').textContent)||0;
  const p = +($('#sumProt').textContent)||0;
  const f = +($('#sumFat').textContent)||0;

  // 1) أساس الكارب
  const base = icr>0? round1(c/icr): 0;

  // 2) FPU اختياري (دهون+بروتين)
  // FPU ≈ (دهون*9 + بروتين*4) / 100 ، وكل FPU ≈ 10 جم كارب مكافئ
  const fpu   = (f*9 + p*4) / 100;
  const carbEq= fpu * 10;
  const addU  = icr>0? round1(carbEq/icr): 0;

  // 3) الذكاء الصغير — تعلم النسبة من تعديلك السابق في نفس الباكت
  const bucket = bucketKey(f,p);
  const b = aiBuckets[bucket]||{sumPct:0,count:0};
  const adjPct = b.count? (b.sumPct/b.count) : 0; // نسبة وسطية
  const aiU = round1(base * adjPct);

  // الجرعة النهائية
  const final = round1(base + addU + aiU);

  $('#doseBase').value       = base? base.toFixed(1):'';
  $('#doseFpu').value        = addU? addU.toFixed(1):'';
  $('#doseAi').value         = aiU? aiU.toFixed(1):'';
  $('#doseSuggestedMeal').value = final? final.toFixed(1):'';

  // اقتراح split bolus عند دهون>=20 أو بروتين>=40
  const showSplit = (f>=20 || p>=40) && final>0;
  $('#splitHint').style.display = showSplit? 'block':'none';
  if(showSplit){
    const nowU = round1(final*0.6), laterU=round1(final*0.4);
    $('#splitHint').innerHTML = `🍽️ وجبة غنية بالدهون/البروتين — اقتراح تقسيم الجرعة: <b>${nowU}</b>U الآن + <b>${laterU}</b>U بعد 2 ساعة (استشيري الطبيب).`;
  }else{
    $('#splitHint').textContent='';
  }
}

function bucketKey(fat,prot){
  if(fat>=20 && prot>=40) return 'fatProtHigh';
  if(fat>=20) return 'fatHigh';
  if(prot>=40) return 'protHigh';
  return 'lowFatLowProt';
}

/* -------------- حفظ الوجبة + التعلم -------------- */
$('#saveMealBtn').onclick = async ()=>{
  if(!basket.length) return alert('السلة فارغة');
  const when=$('#mealTime').value; if(!when) return alert('حددي وقت الأكل');
  const icr= +child?.icr || 0;
  const c=+($('#sumCarb').textContent)||0, p=+($('#sumProt').textContent)||0, f=+($('#sumFat').textContent)||0;
  const base= icr>0? round1(c/icr):0;
  const fpu = (f*9 + p*4)/100, carbEq=fpu*10, addU = icr>0? round1(carbEq/icr):0;
  const finalSuggested = +($('#doseSuggestedMeal').value||0);

  const payload={
    type: $('#mealType').value, time: when, note: ($('#mealNote').value||null),
    icrUsed: icr||null,
    totals:{carb:c, prot:p, fat:f, kcal:+($('#sumKcal').textContent)||0},
    doseBase: base||null, doseFpu: addU||null, doseAi: +($('#doseAi').value||0)||null,
    doseSuggested: finalSuggested||null,
    doseGiven: $('#doseGivenMeal').value ? +$('#doseGivenMeal').value : null,
    items: basket,
    createdAt: serverTimestamp()
  };
  const id=String(Date.now());
  await setDoc(doc(db,'users',uid,'children',childId,'meals',id), payload);

  // التعلم: لو أدخلتي جرعة فعلية، احسبي الفرق كنسبة على أساس "base"
  const given=payload.doseGiven;
  if(given && base>0){
    const deltaPct = (given - base) / base; // مثال: 0.2 = +20%
    const key = bucketKey(f,p);
    const cur = aiBuckets[key] || {sumPct:0,count:0};
    cur.sumPct += deltaPct; cur.count += 1;
    aiBuckets[key]=cur;
    // خزّني التعلم داخل مستند الطفل
    await updateDoc(doc(db,'users',uid,'children',childId), { aiBuckets });
  }

  alert('✅ تم حفظ الوجبة');
  basket=[]; renderBasket();
};

/* -------------- Quick child nav -------------- */
function buildNav(){
  const n=$('#quickNav'); n.innerHTML='';
  [
    ['child-dashboard.html','لوحة الطفل'],
    ['measures.html','قياسات السكر'],
    ['meals.html','الوجبات'],
    ['doctor-report.html','تقرير الطبيب'],
    ['visits.html','الزيارات الطبية']
  ].forEach(([h,t])=>{
    const a=document.createElement('a'); a.className='btn gray';
    a.href=`${h}?child=${encodeURIComponent(childId)}`; a.textContent=t; n.appendChild(a);
  });
}
</script>
</body>
</html>
