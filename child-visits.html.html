<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ø³Ø¬Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©</title>
  <style>
    :root{
      --brand:#0ea5e9; --brand2:#6ee7b7; --line:#e5e7eb; --ink:#0f172a; --muted:#6b7280;
      --bg:#f6fbff; --card:#fff; --ok:#16a34a; --warn:#b45309; --danger:#dc2626;
      --chip:#eef6ff; --chip-ink:#0369a1;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.6 system-ui,"Tajawal","Noto Sans Arabic",sans-serif}
    a{text-decoration:none;color:inherit}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{border:none;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
    .btn.primary{background:var(--brand);color:#fff}
    .btn.gray{background:#eef2f7}
    .btn.red{background:#fee2e2;color:#b91c1c}
    .container{max-width:1200px;margin:auto;padding:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 6px 24px rgba(0,0,0,.04);margin-bottom:12px}

    /* Topbar */
    header.topbar{position:sticky;top:0;z-index:20;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;
      padding:10px 14px;display:flex;justify-content:space-between;align-items:center}
    header .btn{background:#ffffff22;border:1px solid #ffffff66;color:#fff}

    /* Child strip */
    .child-strip{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .kid{display:flex;align-items:center;gap:12px}
    .avatar{width:56px;height:56px;border-radius:50%;object-fit:cover;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.12)}
    .kid .name{font-weight:800}
    .muted{color:var(--muted)}
    .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);color:var(--chip-ink);
      border-radius:999px;padding:6px 10px;font-weight:800}
    .chips{display:flex;gap:6px;flex-wrap:wrap}

    /* Filters */
    .grid{display:grid;gap:10px}
    .g4{grid-template-columns:repeat(4,minmax(0,1fr))}
    .g3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media(max-width:900px){.g4{grid-template-columns:1fr 1fr}.g3{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
    input,select{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff}

    /* Stats */
    .kpi{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:10px}
    @media(max-width:1000px){.kpi{grid-template-columns:repeat(3,minmax(0,1fr))}}
    .kpi .box{background:#f8fafc;border:1px solid var(--line);border-radius:12px;padding:10px}
    .kpi .label{font-size:12px;color:var(--muted)}
    .kpi .val{font-weight:800}

    /* Charts */
    .charts{display:grid;grid-template-columns:2fr 1.2fr;gap:12px;align-items:start}
    @media(max-width:1000px){.charts{grid-template-columns:1fr}}

    /* Table */
    .table-wrap{overflow:auto;max-height:60vh}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{border:1px solid var(--line);padding:8px;text-align:right;vertical-align:top}
    thead th{background:#f1f5f9;font-weight:800;position:sticky;top:0;z-index:1}
    td.center{text-align:center}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .badge.routine{background:#ecfeff;color:#075985;border:1px solid #bae6fd}
    .badge.emergency{background:#fee2e2;color:#991b1b}
    .badge.dosing{background:#f0fdf4;color:#166534}
    .badge.nutrition{background:#fff7ed;color:#9a3412}
    .badge.labs{background:#eef2ff;color:#3730a3}
    .badge.other{background:#f1f5f9;color:#334155}
    .actions .btn{padding:6px 10px}

    /* Drawer (form) */
    .drawer{position:fixed;inset:0;display:none}
    .drawer.show{display:block}
    .drawer .overlay{position:absolute;inset:0;background:rgba(0,0,0,.2)}
    .drawer .panel{position:absolute;inset:0 auto 0 0;width:min(520px,100%);background:#fff;border-left:1px solid var(--line);
      padding:14px;overflow:auto}
    .drawer h3{margin:0 0 8px}
    .hr{height:1px;background:var(--line);margin:10px 0}

    /* Quick view modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center}
    .modal.show{display:flex}
    .modal .sheet{background:#fff;border:1px solid var(--line);border-radius:12px;max-width:720px;width:calc(100% - 24px);
      max-height:80vh;overflow:auto;padding:14px;box-shadow:0 12px 40px rgba(0,0,0,.12)}
    .modal h4{margin:0 0 8px}

    /* Loader & Toast */
    .loader{display:none;position:fixed;inset:0;background:rgba(255,255,255,.5);z-index:9999;align-items:center;justify-content:center}
    .loader .dot{width:10px;height:10px;border-radius:50%;margin:0 4px;background:#0ea5e9;animation:b .9s infinite alternate}
    .loader .dot:nth-child(2){animation-delay:.12s}.loader .dot:nth-child(3){animation-delay:.24s}
    @keyframes b{to{transform:translateY(-6px);background:#06b6d4}}
    .toast{position:fixed;bottom:16px;left:16px;background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transform:translateY(8px);transition:.3s;z-index:99999}
    .toast.show{opacity:1;transform:none}

    /* Print */
    @media print{
      header,.no-print,.drawer,.modal{display:none!important}
      body{background:#fff}
      .card{border:0;box-shadow:none}
      .table-wrap{max-height:none;overflow:visible}
    }
  </style>
</head>
<body>

  <!-- Topbar -->
  <header class="topbar">
    <div class="row">
      <a id="backLink" class="btn" href="#">Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø·ÙÙ„</a>
    </div>
    <div class="row">
      <button id="btnAdd" class="btn">â• Ø¥Ø¶Ø§ÙØ© Ø²ÙŠØ§Ø±Ø©</button>
      <div class="row no-print">
        <button id="btnPrint" class="btn">ğŸ“„ Ø·Ø¨Ø§Ø¹Ø©</button>
        <button id="btnExport" class="btn">ğŸ“¥ ØªØµØ¯ÙŠØ±</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Child strip -->
    <section class="card child-strip">
      <div class="kid">
        <img id="kidAvatar" class="avatar" alt="Ø·ÙÙ„" src="" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2256%22 height=%2256%22><rect width=%2256%22 height=%2256%22 rx=%2228%22 fill=%22%23e2e8f0%22/><text x=%2750%25%27 y=%2755%25%27 dominant-baseline=%27middle%27 text-anchor=%27middle%27 font-size=%2720%27 fill=%27%236b7280%27>ğŸ‘¶</text></svg>';">
        <div>
          <div class="name" id="kidName">â€”</div>
          <div class="muted" id="kidMeta">â€”</div>
        </div>
      </div>
      <div class="chips">
        <span class="chip">Ø¢Ø®Ø± Ø²ÙŠØ§Ø±Ø©: <b id="kidLastVisit">â€”</b></span>
        <span class="chip">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª: <b id="kidVisitsCount">â€”</b></span>
      </div>
    </section>

    <!-- Filters -->
    <section class="card">
      <div class="grid g4">
        <div>
          <label>Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</label>
          <div class="row">
            <button class="btn gray" data-range="7">7 Ø£ÙŠØ§Ù…</button>
            <button class="btn gray" data-range="30">30 ÙŠÙˆÙ…</button>
            <button class="btn gray" data-range="365">Ø³Ù†Ø©</button>
          </div>
        </div>
        <div>
          <label>Ù…Ù†</label>
          <input id="fromDate" type="date">
        </div>
        <div>
          <label>Ø¥Ù„Ù‰</label>
          <input id="toDate" type="date">
        </div>
        <div>
          <label>Ù†ÙˆØ¹ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</label>
          <select id="typeFilter">
            <option value="">Ø§Ù„ÙƒÙ„</option>
            <option value="routine">Ø±ÙˆØªÙŠÙ†ÙŠØ©</option>
            <option value="emergency">Ø·Ø§Ø±Ø¦Ø©</option>
            <option value="dosing">Ù…ØªØ§Ø¨Ø¹Ø© Ø¬Ø±Ø¹Ø§Øª</option>
            <option value="nutrition">ØªØºØ°ÙŠØ©</option>
            <option value="labs">ÙØ­ÙˆØµ</option>
            <option value="other">Ø£Ø®Ø±Ù‰</option>
          </select>
        </div>
      </div>
      <div class="grid g3" style="margin-top:8px">
        <div>
          <label>Ø¨Ø­Ø«</label>
          <input id="searchBox" placeholder="Ø§Ø¨Ø­Ø«ÙŠ Ø¨Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø£Ùˆ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø£Ùˆ Ø§Ù„Ø³Ø¨Ø¨">
        </div>
        <div class="row" style="align-items:flex-end">
          <button id="btnApply" class="btn primary">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
          <button id="btnReset" class="btn gray">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
        </div>
      </div>
    </section>

    <!-- Stats -->
    <section class="card">
      <div class="kpi">
        <div class="box"><div class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª</div><div id="k_total" class="val">â€”</div></div>
        <div class="box"><div class="label">Ø±ÙˆØªÙŠÙ†ÙŠØ©</div><div id="k_routine" class="val">â€”</div></div>
        <div class="box"><div class="label">Ø·Ø§Ø±Ø¦Ø©</div><div id="k_emergency" class="val">â€”</div></div>
        <div class="box"><div class="label">Ù…ØªØ§Ø¨Ø¹Ø© Ø¬Ø±Ø¹Ø§Øª</div><div id="k_dosing" class="val">â€”</div></div>
        <div class="box"><div class="label">ØªØºØ°ÙŠØ©</div><div id="k_nutrition" class="val">â€”</div></div>
        <div class="box"><div class="label">Ù…ØªÙˆØ³Ø· Ø§Ù„ÙØ§ØµÙ„ (ÙŠÙˆÙ…)</div><div id="k_gap" class="val">â€”</div></div>
      </div>
      <div class="charts" style="margin-top:12px">
        <div><canvas id="chartMonthly" height="160"></canvas></div>
        <div><canvas id="chartDonut" height="160"></canvas></div>
      </div>
    </section>

    <!-- Table -->
    <section class="card">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="min-width:120px">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ù„Ù†ÙˆØ¹</th>
              <th>Ø§Ù„Ø·Ø¨ÙŠØ¨</th>
              <th>Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</th>
              <th>Ø§Ù„Ø³Ø¨Ø¨</th>
              <th>Ø§Ù„ØªÙˆØµÙŠØ§Øª</th>
              <th>Ù…Ø±ÙÙ‚Ø§Øª</th>
              <th class="no-print" style="min-width:180px">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="8" class="center muted">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- Drawer: Add/Edit -->
  <div id="drawer" class="drawer">
    <div class="overlay"></div>
    <div class="panel">
      <div class="row" style="justify-content:space-between">
        <h3 id="drawerTitle" style="margin:0">Ø¥Ø¶Ø§ÙØ© Ø²ÙŠØ§Ø±Ø©</h3>
        <button id="btnCloseDrawer" class="btn gray">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="hr"></div>
      <div class="grid g3">
        <div>
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø©</label>
          <input id="f_date" type="date">
        </div>
        <div>
          <label>Ù†ÙˆØ¹ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</label>
          <select id="f_type">
            <option value="routine">Ø±ÙˆØªÙŠÙ†ÙŠØ©</option>
            <option value="emergency">Ø·Ø§Ø±Ø¦Ø©</option>
            <option value="dosing">Ù…ØªØ§Ø¨Ø¹Ø© Ø¬Ø±Ø¹Ø§Øª</option>
            <option value="nutrition">ØªØºØ°ÙŠØ©</option>
            <option value="labs">ÙØ­ÙˆØµ</option>
            <option value="other">Ø£Ø®Ø±Ù‰</option>
          </select>
        </div>
        <div>
          <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨</label>
          <input id="f_doctor" placeholder="Ù…Ø«Ø§Ù„: Ø¯. Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ">
        </div>
        <div>
          <label>Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© / Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰</label>
          <input id="f_clinic" placeholder="Ù…Ø«Ø§Ù„: Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ø£Ø·ÙØ§Ù„">
        </div>
        <div style="grid-column:1/-1">
          <label>Ø§Ù„Ø³Ø¨Ø¨ / Ø§Ù„Ø´ÙƒÙˆÙ‰</label>
          <input id="f_reason" placeholder="Ù…ØªØ§Ø¨Ø¹Ø© Ø¯ÙˆØ±ÙŠØ© / Ø¶Ø¨Ø· Ø¬Ø±Ø¹Ø§Øª / â€¦">
        </div>
        <div style="grid-column:1/-1">
          <label>Ù…Ù„Ø®Øµ Ø§Ù„ØªØ´Ø®ÙŠØµ</label>
          <textarea id="f_diag" rows="2" style="width:100%;padding:10px;border:1px solid var(--line);border-radius:10px"></textarea>
        </div>
        <div style="grid-column:1/-1">
          <label>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª / Ø§Ù„ÙØ­ÙˆØµ</label>
          <textarea id="f_proc" rows="2" style="width:100%;padding:10px;border:1px solid var(--line);border-radius:10px"></textarea>
        </div>
        <div style="grid-column:1/-1">
          <label>Ø§Ù„ØªÙˆØµÙŠØ§Øª</label>
          <textarea id="f_reco" rows="2" style="width:100%;padding:10px;border:1px solid var(--line);border-radius:10px"></textarea>
        </div>
        <div style="grid-column:1/-1">
          <label>Ù…Ø±ÙÙ‚Ø§Øª (ØµÙˆØ± Ø£Ùˆ PDF) â€” Ø§Ø®ØªÙŠØ§Ø±ÙŠ</label>
          <input id="f_files" type="file" accept="image/*,application/pdf" multiple>
          <div id="f_files_list" class="muted" style="margin-top:6px">Ù„Ø§ Ù…Ù„ÙØ§Øª Ù…Ø­Ø¯Ø¯Ø©.</div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="row" style="justify-content:flex-end">
        <button id="btnSaveVisit" class="btn primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</button>
      </div>
    </div>
  </div>

  <!-- Modal: Quick view -->
  <div id="modal" class="modal">
    <div class="sheet">
      <div class="row" style="justify-content:space-between">
        <h4 style="margin:0">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</h4>
        <button id="btnCloseModal" class="btn gray">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div class="hr"></div>
      <div id="qvBody">â€”</div>
    </div>
  </div>

  <!-- Loader & Toast -->
  <div id="loader" class="loader" aria-hidden="true"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
  <div id="toast" class="toast"></div>

  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Firebase + Logic -->
  <script type="module">
    /* ================= Firebase Init ================= */
   // âœ… Ø±Ø£Ø³ Ù…ÙˆØ­Ø¯ Ù„ÙƒÙ„ ØµÙØ­Ø§Øª Ø§Ù„Ø·ÙÙ„

// Ø§Ø³ØªÙŠØ±Ø§Ø¯ Firebase Ù…Ù† Ù…Ù„Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙˆØ­Ø¯
import { auth, db, storage, refs } from './firebase-init.js';
import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";

// Ø¬Ù„Ø¨ Ù‡ÙˆÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø·ÙÙ„ Ù…Ù† Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯
let uid  = localStorage.getItem('currentUserId');
let childId = localStorage.getItem('currentChildId');
let childName = localStorage.getItem('currentChildName') || '';
let childPhotoURL = localStorage.getItem('currentChildPhotoURL') || '';

// Fallback: Ù„Ùˆ Ø§Ù„ØµÙØ­Ø© Ø§ØªÙØªØ­Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø±Ø§Ø¨Ø· ÙÙŠÙ‡ child=
if (!childId) {
  const fromUrl = new URL(location.href).searchParams.get('child');
  if (fromUrl) {
    childId = fromUrl;
    localStorage.setItem('currentChildId', childId);
  }
}

// Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
onAuthStateChanged(auth, (u)=>{
  if(!u){ location.href='index.html'; return; }
  if(!uid) uid = u.uid;
  if(!uid || !childId){ location.href='child-dashboard.html'; return; }

  // Ù‡Ù†Ø§ Ù…Ù…ÙƒÙ† Ù†Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·ÙÙ„ ÙÙŠ Ø±Ø£Ø³ Ø§Ù„ØµÙØ­Ø©
  const headerEl = document.querySelector('#childHeader');
  if (headerEl) {
    headerEl.innerHTML = `
      <div class="child-info">
        <img src="${childPhotoURL || 'images/avatar-default.png'}" 
             alt="ØµÙˆØ±Ø© Ø§Ù„Ø·ÙÙ„" class="child-avatar">
        <div>
          <h2>${childName}</h2>
          <small>ÙƒÙˆØ¯ Ø§Ù„Ø·ÙÙ„: ${childId}</small>
        </div>
      </div>
    `;
  }

  // â€¦ Ø¨Ù‚ÙŠØ© Ù…Ù†Ø·Ù‚ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø®Ø§ØµØ©

    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    /* ================= Globals ================= */
    const $ = s => document.querySelector(s);
    const childId = new URL(location.href).searchParams.get('child');
    let uid=null, child=null, visitsRaw=[], visitsFiltered=[];
    let chartMonthly=null, chartDonut=null;
    let editId=null; // current editing visit id

    const typeLabels = {
      routine:'Ø±ÙˆØªÙŠÙ†ÙŠØ©', emergency:'Ø·Ø§Ø±Ø¦Ø©', dosing:'Ù…ØªØ§Ø¨Ø¹Ø© Ø¬Ø±Ø¹Ø§Øª',
      nutrition:'ØªØºØ°ÙŠØ©', labs:'ÙØ­ÙˆØµ', other:'Ø£Ø®Ø±Ù‰'
    };
    const typeIcon = {
      routine:'ğŸ©º', emergency:'ğŸš‘', dosing:'ğŸ’Š', nutrition:'ğŸ½ï¸', labs:'ğŸ§ª', other:'ğŸ“‹'
    };

    /* ================= Utils ================= */
    function showLoader(v=true){ const x=$("#loader"); if(!x) return; x.style.display = v?'flex':'none'; }
    function toast(msg,ms=2200){ const t=$("#toast"); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),ms); }
    const pad=(n)=>String(n).padStart(2,'0');
    const todayISO=()=>{ const d=new Date(); return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate()); };
    function addDays(iso,delta){ const d=new Date(iso); d.setDate(d.getDate()+delta); return d.toISOString().slice(0,10); }
    function humanAge(dob){
      if(!dob) return 'â€”';
      const d=new Date(dob); if(isNaN(d)) return 'â€”';
      const now=new Date(); let y=now.getFullYear()-d.getFullYear(); let m=now.getMonth()-d.getMonth();
      if(m<0 || (m===0 && now.getDate()<d.getDate())) y--;
      return y+' Ø³Ù†Ø©';
    }
    function sanitizeName(n){ return (n||'file').replace(/[^\w.\-]+/g,'_'); }
    function esc(s){ return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }

    /* ================= Auth + Boot ================= */
    onAuthStateChanged(auth, async (u)=>{
      if(!u){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„'); location.href='index.html'; return; }
      uid=u.uid;
      if(!childId){ alert('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø·ÙÙ„'); return; }
      try{
        showLoader(true);
        await loadChild();
        setDefaultDates(30);
        await loadVisits(); // initial
      }catch(e){
        console.error(e);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„: '+(e.message||e));
      }finally{
        showLoader(false);
      }
    });

    /* ================= Child meta ================= */
    async function loadChild(){
      const snap = await getDoc(doc(db,'users',uid,'children',childId));
      if(!snap.exists()){ throw new Error('Ø§Ù„Ø·ÙÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); }
      child = snap.data();
      $("#kidName").textContent = child.name || 'â€”';
      $("#kidMeta").textContent = `${child.gender||'â€”'} â€¢ Ø¹Ù…Ø±: ${humanAge(child.birthDate)} â€¢ Ù…Ø¯Ù†ÙŠ: ${child.childCivilId||'â€”'}`;
      $("#kidAvatar").src = child.photoURL || '';
      $("#backLink").href = 'child-dashboard.html?child='+encodeURIComponent(childId);
    }

    /* ================= Filters ================= */
    function setDefaultDates(days){
      const to = todayISO();
      const from = addDays(to, -days+1);
      $("#fromDate").value = from;
      $("#toDate").value = to;
    }
    document.querySelectorAll('[data-range]').forEach(b=>{
      b.addEventListener('click',()=>{ setDefaultDates(Number(b.dataset.range)||7); applyFilters(); });
    });
    $("#btnApply").addEventListener('click', applyFilters);
    $("#btnReset").addEventListener('click', ()=>{ setDefaultDates(30); $("#typeFilter").value=''; $("#searchBox").value=''; applyFilters(); });

    /* ================= Load visits ================= */
    async function loadVisits(){
      const from = $("#fromDate").value, to = $("#toDate").value;
      if(!from || !to){ return; }
      const col = collection(db,'users',uid,'children',childId,'visits');
      // ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙ‚Ø· Ù…Ù† Firestore (Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ÙÙ‡Ø§Ø±Ø³)
      const qy = query(col, where('date','>=',from), where('date','<=',to), orderBy('date','desc'));
      const qs = await getDocs(qy);
      visitsRaw = [];
      let last = 'â€”';
      qs.forEach(s=>{
        const v = s.data(); v._id = s.id;
        visitsRaw.push(v);
        if(last==='â€”') last = v.date || 'â€”';
      });
      $("#kidVisitsCount").textContent = visitsRaw.length;
      $("#kidLastVisit").textContent = last;
      applyFilters(false);
    }

    function applyFilters(refetch=true){
      if(refetch){ loadVisits(); return; }
      const typeVal = $("#typeFilter").value || '';
      const q = ($("#searchBox").value||'').trim().toLowerCase();
      visitsFiltered = visitsRaw.filter(v=>{
        const okType = !typeVal || v.type===typeVal;
        const hay = (v.doctor||'')+' '+(v.clinic||'')+' '+(v.reason||'');
        const okText = !q || hay.toLowerCase().includes(q);
        return okType && okText;
      });
      renderStats();
      renderCharts();
      renderTable();
    }

    /* ================= Stats & Charts ================= */
    function renderStats(){
      const total = visitsFiltered.length;
      const countBy = { routine:0, emergency:0, dosing:0, nutrition:0, labs:0, other:0 };
      visitsFiltered.forEach(v=>{ if(countBy[v.type]!=null) countBy[v.type]++; else countBy.other++; });
      $("#k_total").textContent = total;
      $("#k_routine").textContent = countBy.routine;
      $("#k_emergency").textContent = countBy.emergency;
      $("#k_dosing").textContent = countBy.dosing;
      $("#k_nutrition").textContent = countBy.nutrition;
      $("#k_gap").textContent = avgGapDays(visitsFiltered);

      function avgGapDays(arr){
        if(arr.length<2) return 'â€”';
        const dates = Array.from(new Set(arr.map(v=>v.date))).sort(); // asc
        if(dates.length<2) return 'â€”';
        let gaps=0;
        for(let i=1;i<dates.length;i++){
          const a=new Date(dates[i-1]), b=new Date(dates[i]);
          gaps += Math.round((b-a)/(1000*3600*24));
        }
        return Math.round(gaps/(dates.length-1));
      }
    }

    function renderCharts(){
      // Monthly bar (YYYY-MM count)
      const map = new Map();
      visitsFiltered.forEach(v=>{
        const k = (v.date||'').slice(0,7);
        if(!k) return;
        map.set(k, (map.get(k)||0)+1);
      });
      const labels = Array.from(map.keys()).sort();
      const data = labels.map(k=>map.get(k));

      const ctx1 = $("#chartMonthly");
      if(chartMonthly) chartMonthly.destroy();
      chartMonthly = new Chart(ctx1, {
        type:'bar',
        data:{ labels, datasets:[{label:'Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª / Ø´Ù‡Ø±', data, backgroundColor:'#6ee7b7', borderColor:'#059669'}] },
        options:{ plugins:{legend:{display:false}}, scales:{x:{ticks:{maxRotation:0}}} }
      });

      // Donut by type
      const cats = ['routine','emergency','dosing','nutrition','labs','other'];
      const data2 = cats.map(c=>visitsFiltered.filter(v=>v.type===c).length);
      const ctx2 = $("#chartDonut");
      if(chartDonut) chartDonut.destroy();
      chartDonut = new Chart(ctx2, {
        type:'doughnut',
        data:{ labels: cats.map(c=>typeLabels[c]), datasets:[{ data:data2, backgroundColor:['#e0f2fe','#fee2e2','#dcfce7','#ffedd5','#e0e7ff','#e2e8f0'] }] },
        options:{ plugins:{legend:{position:'bottom'}} }
      });
    }

    /* ================= Table ================= */
    function renderTable(){
      const tb = $("#rows");
      if(!visitsFiltered.length){
        tb.innerHTML = `<tr><td colspan="8" class="center muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.</td></tr>`;
        return;
      }
      tb.innerHTML = visitsFiltered.map(v=>{
        const files = Array.isArray(v.files)? v.files : [];
        const badge = `<span class="badge ${esc(v.type)}">${typeIcon[v.type]||'ğŸ“‹'} ${typeLabels[v.type]||'â€”'}</span>`;
        return `
          <tr data-id="${esc(v._id)}">
            <td><b>${esc(v.date||'â€”')}</b></td>
            <td>${badge}</td>
            <td>${esc(v.doctor||'â€”')}</td>
            <td>${esc(v.clinic||'â€”')}</td>
            <td>${esc(v.reason||'â€”')}</td>
            <td>${esc((v.recommendations||'').slice(0,60))}${(v.recommendations&&v.recommendations.length>60)?'â€¦':''}</td>
            <td>${files.length? (files.map(f=>f.type?.startsWith('image/')?'ğŸ–¼ï¸':'ğŸ“„').slice(0,3).join(' ') + (files.length>3?' +'+(files.length-3):'')) : 'â€”'}</td>
            <td class="actions no-print">
              <button class="btn gray" data-act="view">ğŸ‘ï¸ Ø¹Ø±Ø¶</button>
              <button class="btn gray" data-act="edit">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="btn red"  data-act="del">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            </td>
          </tr>`;
      }).join('');

      // bind actions
      tb.querySelectorAll('button[data-act]').forEach(btn=>{
        const tr = btn.closest('tr'); const id = tr?.dataset.id; const act = btn.dataset.act;
        btn.addEventListener('click', ()=>{ if(act==='view') quickView(id); else if(act==='edit') openDrawer(id); else if(act==='del') delVisit(id); });
      });
    }

    /* ================= Quick View ================= */
    function quickView(id){
      const v = visitsFiltered.find(x=>x._id===id); if(!v) return;
      const files = Array.isArray(v.files)? v.files : [];
      const html = `
        <div class="chips" style="margin-bottom:6px">
          <span class="chip">${typeIcon[v.type]||'ğŸ“‹'} ${typeLabels[v.type]||'â€”'}</span>
          <span class="chip">Ø§Ù„ØªØ§Ø±ÙŠØ®: <b>${esc(v.date||'â€”')}</b></span>
          ${v.doctor?`<span class="chip">Ø§Ù„Ø·Ø¨ÙŠØ¨: ${esc(v.doctor)}</span>`:''}
          ${v.clinic?`<span class="chip">Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©: ${esc(v.clinic)}</span>`:''}
        </div>
        ${v.reason?`<div><b>Ø§Ù„Ø³Ø¨Ø¨:</b> ${esc(v.reason)}</div>`:''}
        ${v.diagnosis?`<div><b>Ø§Ù„ØªØ´Ø®ÙŠØµ:</b><br>${esc(v.diagnosis).replace(/\n/g,'<br>')}</div>`:''}
        ${v.procedures?`<div><b>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª/Ø§Ù„ÙØ­ÙˆØµ:</b><br>${esc(v.procedures).replace(/\n/g,'<br>')}</div>`:''}
        ${v.recommendations?`<div><b>Ø§Ù„ØªÙˆØµÙŠØ§Øª:</b><br>${esc(v.recommendations).replace(/\n/g,'<br>')}</div>`:''}
        <div style="margin-top:8px"><b>Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª:</b><br>
          ${files.length? files.map(f=>`<div>â€¢ ${f.type?.startsWith('image/')?'ğŸ–¼ï¸':'ğŸ“„'} <a href="${f.url}" target="_blank">${esc(f.name||'Ù…Ù„Ù')}</a></div>`).join('') : 'â€”'}
        </div>
      `;
      $("#qvBody").innerHTML = html;
      $("#modal").classList.add('show');
    }
    $("#btnCloseModal").addEventListener('click', ()=>$("#modal").classList.remove('show'));
    $("#modal .sheet").addEventListener('click', e=>e.stopPropagation());
    $("#modal").addEventListener('click', ()=>$("#modal").classList.remove('show'));

    /* ================= Drawer (Add/Edit) ================= */
    $("#btnAdd").addEventListener('click', ()=>openDrawer(null));
    $("#btnCloseDrawer").addEventListener('click', closeDrawer);
    $("#f_files").addEventListener('change', ()=> {
      const files = Array.from($("#f_files").files||[]);
      $("#f_files_list").textContent = files.length? files.map(f=>f.name).join(' â€¢ ') : 'Ù„Ø§ Ù…Ù„ÙØ§Øª Ù…Ø­Ø¯Ø¯Ø©.';
    });

    function openDrawer(id){
      editId = id;
      $("#drawerTitle").textContent = id? 'ØªØ¹Ø¯ÙŠÙ„ Ø²ÙŠØ§Ø±Ø©' : 'Ø¥Ø¶Ø§ÙØ© Ø²ÙŠØ§Ø±Ø©';
      if(id){
        const v = visitsFiltered.find(x=>x._id===id);
        $("#f_date").value = v?.date || todayISO();
        $("#f_type").value = v?.type || 'routine';
        $("#f_doctor").value = v?.doctor || '';
        $("#f_clinic").value = v?.clinic || '';
        $("#f_reason").value = v?.reason || '';
        $("#f_diag").value = v?.diagnosis || '';
        $("#f_proc").value = v?.procedures || '';
        $("#f_reco").value = v?.recommendations || '';
        $("#f_files").value = '';
        $("#f_files_list").textContent = 'ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙÙ‚Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© (Ù„Ù† ØªÙÙ…Ø­Ù‰ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)';
      }else{
        $("#f_date").value = todayISO();
        $("#f_type").value = 'routine';
        $("#f_doctor").value = '';
        $("#f_clinic").value = '';
        $("#f_reason").value = '';
        $("#f_diag").value = '';
        $("#f_proc").value = '';
        $("#f_reco").value = '';
        $("#f_files").value = '';
        $("#f_files_list").textContent = 'Ù„Ø§ Ù…Ù„ÙØ§Øª Ù…Ø­Ø¯Ø¯Ø©.';
      }
      $("#drawer").classList.add('show');
    }
    function closeDrawer(){ $("#drawer").classList.remove('show'); }

    $("#btnSaveVisit").addEventListener('click', saveVisit);

    async function saveVisit(){
      const v = {
        date: $("#f_date").value,
        type: $("#f_type").value,
        doctor: $("#f_doctor").value.trim() || null,
        clinic: $("#f_clinic").value.trim() || null,
        reason: $("#f_reason").value.trim() || null,
        diagnosis: $("#f_diag").value.trim() || null,
        procedures: $("#f_proc").value.trim() || null,
        recommendations: $("#f_reco").value.trim() || null,
        updatedAt: serverTimestamp()
      };
      if(!v.date){ alert('Ø£Ø¯Ø®Ù„ÙŠ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø²ÙŠØ§Ø±Ø©'); return; }
      showLoader(true);
      try{
        let id = editId;
        if(!id){
          const ref = await addDoc(collection(db,'users',uid,'children',childId,'visits'), {
            ...v, createdAt: serverTimestamp(), files:[]
          });
          id = ref.id;
        }else{
          await updateDoc(doc(db,'users',uid,'children',childId,'visits',id), v);
        }

        // Upload attachments if any
        const files = Array.from($("#f_files").files||[]);
        if(files.length){
          const uploaded = [];
          for(const f of files){
            const path = `users/${uid}/children/${childId}/visits/${id}/files/${Date.now()}_${sanitizeName(f.name)}`;
            const ref = sRef(storage, path);
            await new Promise((res,rej)=>{
              const task = uploadBytesResumable(ref, f, {contentType:f.type});
              task.on('state_changed', ()=>{}, rej, ()=>res());
            });
            const url = await getDownloadURL(ref);
            uploaded.push({ name:f.name, url, type:f.type, size:f.size });
          }
          // merge with existing
          const refV = doc(db,'users',uid,'children',childId,'visits',id);
          const snap = await getDoc(refV);
          const cur = snap.data()||{};
          const curFiles = Array.isArray(cur.files)? cur.files : [];
          await updateDoc(refV, { files: curFiles.concat(uploaded) });
        }

        toast('âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸');
        closeDrawer();
        await loadVisits();
      }catch(e){
        console.error(e);
        alert('ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸: '+(e.message||e));
      }finally{
        showLoader(false);
      }
    }

    async function delVisit(id){
      if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ÙŠÙ† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø²ÙŠØ§Ø±Ø©ØŸ')) return;
      showLoader(true);
      try{
        await deleteDoc(doc(db,'users',uid,'children',childId,'visits',id));
        toast('ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù');
        await loadVisits();
      }catch(e){
        console.error(e);
        alert('ØªØ¹Ø°Ø± Ø§Ù„Ø­Ø°Ù: '+(e.message||e));
      }finally{
        showLoader(false);
      }
    }

    /* ================= Print & Export ================= */
    $("#btnPrint").addEventListener('click', ()=>window.print());

    $("#btnExport").addEventListener('click', ()=>{
      if(!window.XLSX){ exportCSV(); return; }
      exportXLSX();
    });

    function exportCSV(){
      if(!visitsFiltered.length){ alert('Ù„Ø§ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
      const head = ['date','type','doctor','clinic','reason','diagnosis','procedures','recommendations','filesCount'];
      const rows = visitsFiltered.map(v=>[
        v.date||'',
        typeLabels[v.type]||v.type||'',
        v.doctor||'',
        v.clinic||'',
        v.reason||'',
        (v.diagnosis||'').replace(/\n/g,' '),
        (v.procedures||'').replace(/\n/g,' '),
        (v.recommendations||'').replace(/\n/g,' '),
        (Array.isArray(v.files)? v.files.length : 0)
      ]);
      const csv = [head].concat(rows).map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
      const a=document.createElement('a'); a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
      a.download='visits.csv'; a.click();
    }

    function exportXLSX(){
      const XLSX = window.XLSX;
      if(!visitsFiltered.length){ alert('Ù„Ø§ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±'); return; }
      const head = ['Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø§Ù„Ù†ÙˆØ¹','Ø§Ù„Ø·Ø¨ÙŠØ¨','Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©','Ø§Ù„Ø³Ø¨Ø¨','Ø§Ù„ØªØ´Ø®ÙŠØµ','Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª','Ø§Ù„ØªÙˆØµÙŠØ§Øª','Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª'];
      const rows = visitsFiltered.map(v=>[
        v.date||'',
        typeLabels[v.type]||v.type||'',
        v.doctor||'',
        v.clinic||'',
        v.reason||'',
        v.diagnosis||'',
        v.procedures||'',
        v.recommendations||'',
        (Array.isArray(v.files)? v.files.length : 0)
      ]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([head].concat(rows)), 'Visits');
      XLSX.writeFile(wb, `visits_${child?.name||'child'}.xlsx`);
    }

    /* ================= Buttons wiring ================= */
    $("#fromDate").addEventListener('change', ()=>applyFilters());
    $("#toDate").addEventListener('change', ()=>applyFilters());
    $("#typeFilter").addEventListener('change', ()=>applyFilters());
    $("#searchBox").addEventListener('input', ()=>applyFilters(false));
    $("#drawer").addEventListener('click', e=>{ if(e.target.classList.contains('overlay')) closeDrawer(); });

  </script>
</body>
</html>
