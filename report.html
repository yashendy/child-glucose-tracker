<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>تقرير القياسات — عرض أفقي حسب التاريخ</title>
<style>
:root{
  --brand:#0ea5e9;--brand2:#6ee7b7;--line:#e5e7eb;--ink:#0f172a;--muted:#6b7280;
  --bg:#f6fbff;--card:#fff;--ok:#16a34a;--low:#b45309;--high:#dc2626;
  --okbg:#ecfdf5;--lowbg:#fff7ed;--highbg:#fee2e2;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.6 system-ui,"Tajawal","Noto Sans Arabic",sans-serif}
header{position:sticky;top:0;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;padding:14px;display:flex;justify-content:space-between;align-items:center;z-index:5}
main{max-width:1200px;margin:auto;padding:18px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 6px 24px rgba(0,0,0,.04);margin-bottom:14px}

label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
input,select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
.grid{display:grid;gap:12px}
.g4{grid-template-columns:repeat(4,minmax(0,1fr))}
@media(max-width:900px){.g4{grid-template-columns:1fr 1fr}}

.table{width:100%;border-collapse:separate;border-spacing:0}
.table th,.table td{border:1px solid var(--line);padding:10px;vertical-align:top;text-align:center}
.table thead th{background:#f8fafc;font-weight:800}
.table td.date{background:#fbfdff;white-space:nowrap;font-weight:800}

.cell{display:flex;flex-direction:column;gap:4px}
.line{font-size:13px}
.state{padding:2px 8px;border-radius:999px;width:max-content;margin:auto}
.state.ok{color:var(--ok);background:var(--okbg)}
.state.low{color:var(--low);background:var(--lowbg)}
.state.high{color:var(--high);background:var(--highbg)}
.note{color:var(--muted)}

@media print{
  header,.controls{display:none!important}
  body{background:#fff}
  .card{border:0;box-shadow:none;padding:0;margin:0}
  .table th,.table td{padding:6px}
}
</style>
</head>
<body>
<header>
  <div>تقرير القياسات (بالعرض حسب التاريخ)</div>
  <div>
    <a href="dashboard.html" style="color:#fff;text-decoration:none;border:1px solid #ffffff66;padding:8px 12px;border-radius:10px">رجوع</a>
    <button id="btnPrint" style="margin-inline-start:8px;border:none;background:#ffffff22;color:#fff;border:1px solid #ffffff66;padding:8px 12px;border-radius:10px;cursor:pointer">طباعة</button>
  </div>
</header>

<main>
  <section class="card controls">
    <div class="grid g4">
      <div>
        <label>الطفل</label>
        <select id="childSel"><option value="">— اختاري الطفل —</option></select>
      </div>
      <div>
        <label>من تاريخ</label>
        <input id="from" type="date">
      </div>
      <div>
        <label>إلى تاريخ</label>
        <input id="to" type="date">
      </div>
      <div style="display:flex;align-items:end">
        <button id="run" style="width:100%;padding:10px 12px;border:none;border-radius:10px;background:var(--brand);color:#fff;font-weight:800;cursor:pointer">عرض التقرير</button>
      </div>
    </div>
    <div id="childMeta" style="margin-top:8px;color:#0f172ab3"></div>
  </section>

  <section id="reportBox" class="card" style="display:none">
    <table id="rep" class="table"></table>
  </section>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCOdrwdbw8b7YdWLPZ4TDdG2iS9kvvxQ7M",
  authDomain: "child-glucose-tracker.firebaseapp.com",
  projectId: "child-glucose-tracker",
  storageBucket: "child-glucose-tracker.firebasestorage.app",
  messagingSenderId: "294563325904",
  appId: "1:294563325904:web:39562550bf305fc01abbd5"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

const $=s=>document.querySelector(s);
const labels={
  preBreakfast:'قبل الإفطار', postBreakfast:'بعد الإفطار',
  preLunch:'قبل الغداء',     postLunch:'بعد الغداء',
  preDinner:'قبل العشاء',    postDinner:'بعد العشاء',
  beforeSleep:'قبل النوم',   duringSleep:'أثناء النوم', uponWake:'عند الاستيقاظ'
};
const order = ['preBreakfast','postBreakfast','preLunch','postLunch','preDinner','postDinner','beforeSleep','duringSleep','uponWake'];

let uid=null, initChildId=new URL(location.href).searchParams.get('child');

onAuthStateChanged(auth, async (u)=>{
  if(!u){ location.href='index.html'; return; }
  uid=u.uid;
  await loadChildren();
  setDefaults();
  if(initChildId){
    const opt=[...$('#childSel').options].find(o=>o.value===initChildId);
    if(opt){ $('#childSel').value=initChildId; $('#childSel').disabled=true; }
  }
});

function setDefaults(){
  const d=new Date(), iso=d.toISOString().slice(0,10);
  $('#from').value=iso; $('#to').value=iso;
}

async function loadChildren(){
  const sel=$('#childSel'); sel.innerHTML='<option value="">— تحميل —</option>';
  const q=await getDocs(collection(db,'users',uid,'children'));
  sel.innerHTML='<option value="">— اختاري الطفل —</option>';
  q.forEach(s=>{
    const o=document.createElement('option'); o.value=s.id; o.textContent=s.data().name||'بدون اسم'; sel.appendChild(o);
  });
}

$('#btnPrint').addEventListener('click', ()=>window.print());
$('#run').addEventListener('click', buildReport);

/* بناء جدول أفقي: كل صف = تاريخ، الأعمدة = الأوقات */
async function buildReport(){
  const childId=$('#childSel').value, from=$('#from').value, to=$('#to').value;
  if(!childId || !from || !to) return alert('اختاري الطفل وحددي الفترة');

  // بيانات الطفل لعرضها كتعريف
  const cs=await getDoc(doc(db,'users',uid,'children',childId));
  const c=cs.data()||{};
  $('#childMeta').innerHTML = `
    الاسم: ${c.name||'—'} • الوزن: ${c.weight??'—'} كجم • الطول: ${c.height??'—'} سم
    • حدود: منخفض &lt; ${c.lowThreshold??'—'} — مرتفع &gt; ${c.highThreshold??'—'}
  `;

  const dates = enumerateDates(from,to);
  const snaps = await Promise.all(dates.map(d=>getDoc(doc(db,'users',uid,'children',childId,'measurements',d))));
  const byDate = {}; dates.forEach((d,i)=> byDate[d] = snaps[i].data() || { date:d, readings:{} });

  const tbl=$('#rep'); tbl.innerHTML='';
  // رأس الأعمدة: التاريخ + الأوقات
  const thead=document.createElement('thead');
  const htr=document.createElement('tr');
  const thDate=document.createElement('th'); thDate.textContent='التاريخ'; htr.appendChild(thDate);
  order.forEach(slot=>{
    const th=document.createElement('th'); th.textContent=labels[slot]; htr.appendChild(th);
  });
  thead.appendChild(htr); tbl.appendChild(thead);

  // الجسم: صف لكل تاريخ
  const tbody=document.createElement('tbody');
  dates.forEach(d=>{
    const tr=document.createElement('tr');
    const tdDate=document.createElement('td'); tdDate.className='date'; tdDate.textContent=d; tr.appendChild(tdDate);
    order.forEach(slot=>{
      const r=(byDate[d].readings||{})[slot];
      const td=document.createElement('td');
      if(!r || r.value==null){
        td.innerHTML = '—'; // القياس غير موجود
      }else{
        const state = r.status==='low'?'low':(r.status==='high'?'high':'ok');
        const corr  = r.correctionDoses!=null ? `جرعة تصحيحي: ${r.correctionDoses}` : '';
        const note  = r.note || r.raisedWith || '';
        td.innerHTML = `
          <div class="cell">
            <div class="line"><b>القياس:</b> ${r.value}</div>
            ${corr?`<div class="line">${corr}</div>`:''}
            ${note?`<div class="line note">ملاحظة: ${escapeHTML(note)}</div>`:''}
            <div class="line state ${state}">${stateLabel(state)}</div>
          </div>`;
      }
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  tbl.appendChild(tbody);

  $('#reportBox').style.display='block';
}

function enumerateDates(from,to){
  const res=[]; let d=new Date(from); const end=new Date(to);
  while(d<=end){ res.push(d.toISOString().slice(0,10)); d.setDate(d.getDate()+1); }
  return res;
}
function stateLabel(s){ return s==='low'?'⬇︎ منخفض':(s==='high'?'⬆︎ مرتفع':'✔️ طبيعي'); }
function escapeHTML(str){ return str.replace(/[&<>"']/g,(c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
</script>
</body>
</html>
