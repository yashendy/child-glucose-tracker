<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>تقرير القياسات — متابعة سكر الأطفال</title>
<style>
:root{--brand:#0ea5e9;--brand2:#6ee7b7;--line:#e5e7eb;--ink:#0f172a;--muted:#6b7280;--bg:#f6fbff;--card:#fff}
body{margin:0;font:15px/1.6 system-ui,"Tajawal","Noto Sans Arabic",sans-serif;background:var(--bg);color:var(--ink)}
header{position:sticky;top:0;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;padding:14px;display:flex;justify-content:space-between;align-items:center}
main{max-width:900px;margin:auto;padding:18px}
.card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:14px}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:4px}
input,select{width:100%;padding:8px;border:1px solid var(--line);border-radius:8px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid var(--line);padding:8px;text-align:center}
</style>
</head>
<body>
<header>
  <div>تقرير القياسات</div>
  <a href="dashboard.html" class="btn">⬅ رجوع</a>
</header>

<main>
  <div class="card">
    <label>اختر الطفل</label>
    <select id="childSel"></select>

    <label>من تاريخ</label>
    <input type="date" id="fromDate">
    <label>إلى تاريخ</label>
    <input type="date" id="toDate">

    <button id="loadBtn" style="margin-top:10px">عرض التقرير</button>
  </div>

  <div class="card">
    <table id="reportTable">
      <thead>
        <tr><th>التاريخ</th><th>الوقت</th><th>القياس</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, collection, getDocs, doc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCOdrwdbw8b7YdWLPZ4TDdG2iS9kvvxQ7M",
  authDomain: "child-glucose-tracker.firebaseapp.com",
  projectId: "child-glucose-tracker",
  storageBucket: "child-glucose-tracker.firebasestorage.app",
  messagingSenderId: "294563325904",
  appId: "1:294563325904:web:39562550bf305fc01abbd5"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

let uid=null;
const urlParams = new URLSearchParams(location.search);
const initChildId = urlParams.get('child');

onAuthStateChanged(auth, async (u)=>{
  if(!u) return location.href='index.html';
  uid=u.uid;
  await loadChildren();
});

async function loadChildren(){
  const sel=document.querySelector('#childSel'); sel.innerHTML='';
  const q=await getDocs(collection(db,'users',uid,'children'));
  q.forEach(s=>{
    const opt=document.createElement('option');
    opt.value=s.id; opt.textContent=s.data().name || 'بدون اسم';
    sel.appendChild(opt);
  });

  if(initChildId){
    sel.value = initChildId;
    sel.dispatchEvent(new Event('change'));
    sel.disabled = true;
  }
}

document.querySelector('#loadBtn').addEventListener('click', async ()=>{
  const cid=document.querySelector('#childSel').value;
  const from=document.querySelector('#fromDate').value;
  const to=document.querySelector('#toDate').value;
  if(!cid || !from || !to) return alert('أكمل البيانات');
  const tbody=document.querySelector('#reportTable tbody');
  tbody.innerHTML='';
  const q=await getDocs(collection(db,'users',uid,'children',cid,'measurements'));
  q.forEach(s=>{
    const m=s.data();
    if(m.date>=from && m.date<=to){
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${m.date}</td><td>${m.time}</td><td>${m.value}</td>`;
      tbody.appendChild(tr);
    }
  });
});
</script>
</body>
</html>
