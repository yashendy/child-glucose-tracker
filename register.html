<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>تسجيل حساب وليّ الأمر</title>
<style>
:root{--bg:#0ea5e9;--bg2:#6ee7b7;--card:#fff;--ink:#0f172a;--muted:#6b7280;--line:#e5e7eb;--brand:#0ea5e9}
*{box-sizing:border-box}body{margin:0;background:linear-gradient(135deg,var(--bg),var(--bg2));min-height:100vh;display:grid;place-items:center;font:15px/1.6 system-ui,"Tajawal","Noto Sans Arabic",sans-serif;color:var(--ink)}
.card{width:min(880px,94vw);background:var(--card);border:1px solid #e6eef6;border-radius:18px;box-shadow:0 20px 60px rgba(0,0,0,.08);padding:22px}
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
h1{margin:0;font-size:20px}
a.link{color:var(--brand);text-decoration:none;font-weight:700}
.grid{display:grid;gap:12px;grid-template-columns:repeat(2,minmax(0,1fr))}
@media(max-width:700px){.grid{grid-template-columns:1fr}}
label{display:block;margin:0 0 6px;color:var(--muted);font-size:13px}
input{width:100%;padding:12px;border:1px solid var(--line);border-radius:12px;background:#fff}
.btn{border:none;border-radius:12px;padding:12px 16px;cursor:pointer;font-weight:700}
.btn.primary{background:var(--brand);color:#fff}
.note{color:var(--muted);font-size:13px}
.alert{display:none;margin-bottom:10px;padding:10px;border-radius:10px}
.alert.err{background:#fff1f2;color:#991b1b}
.alert.ok{background:#ecfdf5;color:#065f46}
</style>
</head>
<body>
<div class="card">
  <header>
    <h1>تسجيل حساب وليّ الأمر</h1>
    <a class="link" href="login.html">عندي حساب بالفعل</a>
  </header>

  <div id="msgErr" class="alert err"></div>
  <div id="msgOk"  class="alert ok"></div>

  <form id="form" novalidate>
    <div class="grid">
      <div><label>اسم وليّ الأمر</label><input id="guardianName" required placeholder="مثال: أحمد محمد"></div>
      <div><label>الاسم (اختياري)</label><input id="fullName" placeholder="الاسم الكامل (اختياري)"></div>
      <div><label>الرقم المدني</label><input id="civilId" required placeholder="123456789012"></div>
      <div><label>رقم الهاتف</label><input id="phone" required placeholder="5xxxxxxxx"></div>
      <div><label>البريد الإلكتروني</label><input id="email" type="email" required placeholder="you@example.com"></div>
      <div><label>كلمة السر</label><input id="password" type="password" required placeholder="••••••••"></div>
      <div><label>تأكيد كلمة السر</label><input id="confirm" type="password" required placeholder="أعد الإدخال"></div>
    </div>
    <div style="margin-top:12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <button class="btn primary" type="submit">إنشاء الحساب</button>
      <span class="note">سيتم إنشاء ملفك في قاعدة البيانات وربط الحساب.</span>
    </div>
  </form>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCOdrwdbw8b7YdWLPZ4TDdG2iS9kvvxQ7M",
  authDomain: "child-glucose-tracker.firebaseapp.com",
  projectId: "child-glucose-tracker",
  storageBucket: "child-glucose-tracker.firebasestorage.app",
  messagingSenderId: "294563325904",
  appId: "1:294563325904:web:39562550bf305fc01abbd5",
  measurementId: "G-TWC063TD6X"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

const $ = s=>document.querySelector(s);
const show = (el,msg)=>{ el.textContent=msg; el.style.display='block'; };
const hide = (...els)=>els.forEach(e=>e.style.display='none');

$('#form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const msgErr = $('#msgErr'), msgOk = $('#msgOk'); hide(msgErr,msgOk);

  const guardianName = $('#guardianName').value.trim();
  const fullName     = $('#fullName').value.trim();
  const civilId      = $('#civilId').value.trim();
  const phone        = $('#phone').value.trim();
  const email        = $('#email').value.trim();
  const password     = $('#password').value;
  const confirm      = $('#confirm').value;

  if(!guardianName || !civilId || !phone || !email || !password){ return show(msgErr,'من فضلك املئي كل الحقول المطلوبة'); }
  if(password.length < 6) return show(msgErr,'كلمة السر يجب أن تكون 6 أحرف على الأقل');
  if(password !== confirm) return show(msgErr,'تأكيد كلمة السر غير مطابق');

  try{
    const cred = await createUserWithEmailAndPassword(auth,email,password);
    await updateProfile(cred.user,{ displayName: guardianName });
    // إنشاء مستند المستخدم
    await setDoc(doc(db,'users',cred.user.uid),{
      parentInfo:{ guardianName, name: fullName || guardianName, civilId, email, phone },
      createdAt: serverTimestamp()
    });
    show(msgOk,'تم إنشاء الحساب بنجاح! سيتم تحويلك للصفحة الرئيسية…');
    setTimeout(()=>location.href='index.html', 800);
  }catch(e){
    const map={'auth/email-already-in-use':'هذا البريد مستخدم بالفعل','auth/invalid-email':'بريد إلكتروني غير صالح','auth/weak-password':'كلمة السر ضعيفة'};
    show(msgErr, map[e.code] || ('حدث خطأ: '+e.message));
  }
});
</script>
</body>
</html>
